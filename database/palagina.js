// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸªŸ APP OPENPORTE - Logica Applicazione
// ğŸ”§ v5.97: AMBIENTI da OPZIONI + BRM tapparelle/zanzariereâ†’renderBRMPosizione (06 FEB 2026)
// ğŸ”§ v5.96: Step 5+6+7+Posizioni usano CAMPI_PRODOTTI + renderBRMPosizione (06 FEB 2026)
// ğŸ”§ v5.95: Alias OPZIONI.* â†’ OPZIONI_PRODOTTI (unica fonte) (05 FEB 2026)
// ğŸ”§ v5.93: Picker visuale modelli portoncino con griglia immagini (05 FEB 2026)
// ğŸ”§ v5.92: Catalogo immagini portoncini FIN-Door inline (05 FEB 2026)
// ğŸ”§ v5.92: Fix manualDownloadFromGitHub path (progetti/) (05 FEB 2026)
// ğŸ”§ v5.91: Fix centralizzato salvataggio/lettura stato progetto (05 FEB 2026)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// APP_VERSION definita in config.js

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ–¼ï¸ PORTONCINO MODEL PICKER - Griglia visuale modelli FIN-Door
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getPortoncinoImgHTML(codiceModello, size = 100) {
    if (!codiceModello || typeof FINDOOR_CATALOGO === 'undefined') return '';
    const src = FINDOOR_CATALOGO.getModello(codiceModello);
    if (!src) return `<div style="width:${size}px;height:${Math.round(size*1.9)}px;background:#f3f4f6;border:1px dashed #d1d5db;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px;text-align:center">N/D</div>`;
    return `<img src="${src}" style="width:${size}px;height:auto;border-radius:6px;border:1px solid #e5e7eb;box-shadow:0 1px 3px rgba(0,0,0,.1)" alt="Mod.${codiceModello}">`;
}
function updatePortoncinoImgPreview(imgContainerId, codiceModello) {
    const el = document.getElementById(imgContainerId);
    if (el) el.innerHTML = getPortoncinoImgHTML(codiceModello, 90);
}

/** Bottone preview che apre il picker modale */
function renderPortoncinoModelButton(currentModel, comb, onSelectCallback) {
    const hasCatalog = typeof FINDOOR_CATALOGO !== 'undefined';
    const hasDB = typeof FINDOOR_MODELLI_ANTA !== 'undefined';
    const modello = hasDB && currentModel ? FINDOOR_MODELLI_ANTA[currentModel] : null;
    const imgSrc = hasCatalog && currentModel ? FINDOOR_CATALOGO.getModello(currentModel) : null;
    return `
        <div onclick="${onSelectCallback}" 
             style="display:flex;align-items:center;gap:10px;padding:8px 12px;border:2px solid ${currentModel ? '#c084fc' : '#d1d5db'};border-radius:10px;cursor:pointer;background:${currentModel ? '#faf5ff' : '#fff'};min-height:60px;transition:all .15s">
            ${imgSrc 
                ? `<img src="${imgSrc}" style="width:45px;height:auto;border-radius:4px;flex-shrink:0">` 
                : `<div style="width:45px;height:65px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px">ğŸšª</div>`}
            <div style="flex:1;min-width:0">
                <div style="font-size:10px;color:#6b7280">Modello Anta</div>
                <div style="font-weight:700;color:#7c3aed;font-size:14px">${currentModel || 'Tocca per scegliere...'}</div>
                ${modello ? `<div style="font-size:9px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${modello.desc} | â‚¬${modello.prezzi[0].toLocaleString('it-IT')}</div>` : ''}
            </div>
            <div style="color:#9ca3af;font-size:18px;flex-shrink:0">â–¾</div>
        </div>`;
}

/** Apri picker modale griglia modelli portoncino */
function openPortoncinoModelPicker(projectId, posId, context, currentModel, comb) {
    const hasCatalog = typeof FINDOOR_CATALOGO !== 'undefined';
    const modelli = typeof getModelliPerCombinazione === 'function' 
        ? getModelliPerCombinazione(comb || 'PVC-PVC') 
        : (window.FINDOOR_MODELLI_ANTA || {});
    
    const cats = { STD: [], T935: [], INLAY: [] };
    for (const [cod, mod] of Object.entries(modelli)) {
        cats[mod.cat]?.push({ cod, ...mod });
    }
    const catLabels = { STD: 'ğŸ  Standard', T935: 'ğŸ”§ T935/T947', INLAY: 'ğŸ¨ Inlay (cornice)' };
    
    let gridHTML = '';
    for (const [cat, items] of Object.entries(cats)) {
        if (items.length === 0) continue;
        gridHTML += `<div style="padding:8px 16px;font-weight:700;font-size:14px;color:#374151;background:#f9fafb;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:1">${catLabels[cat]} (${items.length})</div>`;
        gridHTML += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;padding:8px 12px">`;
        for (const m of items) {
            const imgSrc = hasCatalog ? FINDOOR_CATALOGO.getModello(m.cod) : null;
            const isSel = m.cod === currentModel;
            gridHTML += `
                <div onclick="selectPortoncinoModel('${projectId}','${posId}','${context}','${m.cod}')"
                     style="border:2px solid ${isSel ? '#8b5cf6' : '#e5e7eb'};border-radius:10px;padding:6px;text-align:center;cursor:pointer;background:${isSel ? '#ede9fe' : '#fff'};transition:border .1s">
                    ${imgSrc 
                        ? `<img src="${imgSrc}" style="width:70px;height:auto;margin:0 auto 4px;display:block;border-radius:4px">` 
                        : `<div style="width:70px;height:100px;margin:0 auto 4px;background:#f3f4f6;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:24px">ğŸšª</div>`}
                    <div style="font-weight:700;font-size:13px;color:${isSel ? '#7c3aed' : '#1f2937'}">${m.cod}</div>
                    <div style="font-size:9px;color:#6b7280;line-height:1.2;overflow:hidden;max-height:2.4em">${m.desc}</div>
                    <div style="font-size:9px;color:#059669;margin-top:2px">â‚¬${m.prezzi[0].toLocaleString('it-IT')}</div>
                </div>`;
        }
        gridHTML += '</div>';
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'ptcModelPickerOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99999;display:flex;flex-direction:column';
    overlay.innerHTML = `
        <div style="background:#fff;flex:1;display:flex;flex-direction:column;margin:8px;border-radius:16px;overflow:hidden;max-height:100%">
            <div style="padding:12px 16px;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;display:flex;align-items:center;gap:12px;flex-shrink:0">
                <span style="font-size:22px">ğŸšª</span>
                <div style="flex:1">
                    <div style="font-weight:700;font-size:16px">Modello Anta Portoncino</div>
                    <div style="font-size:11px;opacity:.8">Materiale: ${comb || 'PVC-PVC'} | ${Object.keys(modelli).length} modelli</div>
                </div>
                <div onclick="closePortoncinoModelPicker()" style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px">âœ•</div>
            </div>
            <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch">${gridHTML}</div>
        </div>`;
    document.body.appendChild(overlay);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) closePortoncinoModelPicker(); });
}

function closePortoncinoModelPicker() {
    const el = document.getElementById('ptcModelPickerOverlay');
    if (el) el.remove();
}

window.selectPortoncinoModel = function(projectId, posId, context, codice) {
    closePortoncinoModelPicker();
    if (context === 'global') {
        if (typeof updateConfigPortoncini === 'function') updateConfigPortoncini(projectId, 'modelloAnta', codice);
    } else if (context === 'pos') {
        if (typeof updateIngressoData === 'function') updateIngressoData(projectId, posId, 'portoncino', 'modelloAnta', codice);
    } else if (context === 'legacy') {
        if (typeof updatePortoncino === 'function') updatePortoncino(projectId, posId, 'modelloAnta', codice);
    }
};
window.openPortoncinoModelPicker = openPortoncinoModelPicker;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ v5.88: EXPORT CENTRALIZZATO posizioni + FIX flush dati cliente prima di Avanti + Finstral full shared (02 FEB 2026)
// ğŸ”§ v5.86: FIX colore grate config + rimosso rilievo preesistente (02 FEB 2026)
// ğŸ”’ v5.85: INTEGRAZIONE GRATE SICUREZZA ERRECI - 14 punti patch (02 FEB 2026)
// ğŸ†• v5.84: CENTRALIZZAZIONE OPZIONI PRODOTTI - opzioni-prodotti.js (02 FEB 2026)
// ğŸ”§ v5.83: FIX Dropdown Vetro posizione - allineato a Config Globale FINSTRAL_OPZIONI (02 FEB 2026)
// ğŸ†• v5.82: RIMOSSO pos.quantita - USA SOLO prodotto.qta (29 GEN 2026)
// - Eliminato input "QuantitÃ " a livello posizione
// - Conteggi usano solo infisso.qta, persiana.qta, etc.
// - Allineato con PRODUCT_COUNTER centralizzato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.81: INTEGRAZIONE UI_FORMS CENTRALIZZATO (29 GEN 2026)
// - Form cliente usa UI_FORMS.renderFormCliente()
// - Nuovi campi: Nome, Cognome, CF, Tel, Email, Indirizzo, Comune, Prov, CAP
// - Zona climatica e Tipo detrazione per ENEA
// - Callback updateClienteField() per cliente/immobile
// - renderSelettoreMuro() usa JSON_MANAGER.CONFIG.OPZIONI
// - Fallback legacy se UI_FORMS non caricato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.80: OPZIONI MURO CENTRALIZZATE (28 GEN 2026)
// - Nuovo file opzioni-muro.js con OPZIONI_MURO centralizzato
// - Tipo Apertura e Posizione Telaio letti da OPZIONI_MURO
// - Funzione renderSelettoreMuro() genera UI dinamicamente
// - Validazione usa isValidOpzioneMuro() con fallback
// - Riutilizzabile in: App Rilievo, Dashboard, App Posa
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.79: POSIZIONE TELAIO OBBLIGATORIA (28 GEN 2026)
// - ğŸ†• Selettore "Filo Muro Int" / "Mazzetta" in Misure Principali
// - Campo posizioneTelaio OBBLIGATORIO come tipoApertura
// - Funzione updatePosizioneTelaio() per aggiornare
// - Validazione in validateMisure() - errore se mancante
// - Aggiunto al calcolo completamento (9 punti)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.78: TIPO APERTURA F/PF OBBLIGATORIO + JSON_MANAGER (28 GEN 2026)
// - Tipo Apertura F/PF non ha piÃ¹ default - OBBLIGATORIO selezionare
// - UI con bordo arancione e âš ï¸ se non selezionato
// - Validazione in validateMisure() - errore se mancante
// - Aggiunto al calcolo completamento posizione (11 punti)
// - Dropdown Vetri da FINSTRAL_OPZIONI.vetri (database centralizzato)
// - ğŸ†• Export usa JSON_MANAGER.downloadJSON() quando disponibile
// - ğŸ†• Import usa JSON_MANAGER.uploadJSON() quando disponibile
// - Fallback legacy se JSON_MANAGER non caricato
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.77: INTEGRAZIONE DATA_ACCESSOR (28 GEN 2026)
// - Normalizzazione dati all'avvio per uniformare qta/quantita
// - Funzione normalizzaProdottoRilievo() per singoli prodotti
// - Funzione normalizzaProgettoRilievo() per intero progetto
// - Preparazione per stampa preventivo da App Rilievo
// - ğŸ†• Tipo Apertura F/PF in Misure Principali
// - ğŸ†• Funzione updateTipoApertura() per propagare ai prodotti
// - ğŸ†• Dropdown Vetri da FINSTRAL_OPZIONI.vetri (database centralizzato)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// âš¡ FASE 024B: Sistema aggiornamenti parziali DOM (approccio cloud)
// Invece di render() completo, aggiorniamo solo gli elementi necessari

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”— ALIAS COSTANTI DA OPZIONI_PRODOTTI v3.1.0 (unica fonte)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (typeof P === 'undefined') { var P = window.OPZIONI_PRODOTTI; }
const COLORI_TAPPARELLE_PLASTICINO = P.tapparelle.colori;
const GUIDE_PLASTICINO = P.tapparelle.guide;
const COLORI_GUIDE_PLASTICINO = P.tapparelle.coloriGuide;
const MODELLI_TAPPARELLE = P.tapparelle.modelli;
const MOTORI_SOMFY = P.motori.modelli;
const ACCESSORI_MOTORE_SOMFY = P.motori.accessori;
const COMANDI_SOMFY = P.motori.comandi;
const ACCESSORI_TAPPARELLA = P.tapparelle.accessoriManuali;

// Funzioni helper da OPZIONI_PRODOTTI
const getColoriGuide = P.getColoriGuide.bind(P);
const getModelliTapparella = P.getModelliTapparella.bind(P);
const getModelliTapparellaOptions = P.getModelliTapparellaOptions.bind(P);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.77: NORMALIZZAZIONE DATI CON DATA_ACCESSOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Normalizza un singolo prodotto per avere sempre sia 'qta' che 'quantita'
 * @param {Object} prodotto - Oggetto prodotto (infisso, persiana, etc.)
 * @returns {Object} Prodotto normalizzato
 */
function normalizzaProdottoRilievo(prodotto) {
    if (!prodotto) return null;
    
    // Usa DATA_ACCESSOR se disponibile
    if (typeof DATA_ACCESSOR !== 'undefined') {
        const q = DATA_ACCESSOR.getQuantita(prodotto);
        prodotto.quantita = q;
        prodotto.qta = String(q); // App Rilievo usa qta come stringa
    } else {
        // Fallback manuale
        const q = parseInt(prodotto.quantita) || parseInt(prodotto.qta) || 0;
        prodotto.quantita = q;
        prodotto.qta = String(q);
    }
    
    return prodotto;
}

/**
 * Normalizza tutte le posizioni di un progetto App Rilievo
 * @param {Object} project - Oggetto progetto
 * @returns {Object} Progetto normalizzato
 */
function normalizzaProgettoRilievo(project) {
    if (!project) return project;
    
    // Normalizza posizioni in positions (formato GitHub)
    if (project.positions && Array.isArray(project.positions)) {
        project.positions.forEach(pos => {
            if (pos.infisso) pos.infisso = normalizzaProdottoRilievo(pos.infisso);
            if (pos.persiana) pos.persiana = normalizzaProdottoRilievo(pos.persiana);
            if (pos.tapparella) pos.tapparella = normalizzaProdottoRilievo(pos.tapparella);
            if (pos.zanzariera) pos.zanzariera = normalizzaProdottoRilievo(pos.zanzariera);
            if (pos.cassonetto) pos.cassonetto = normalizzaProdottoRilievo(pos.cassonetto);
            if (pos.blindata) pos.blindata = normalizzaProdottoRilievo(pos.blindata);
            if (pos.portoncino) pos.portoncino = normalizzaProdottoRilievo(pos.portoncino);
            if (pos.portaInterna) pos.portaInterna = normalizzaProdottoRilievo(pos.portaInterna);
            if (pos.clickZip) pos.clickZip = normalizzaProdottoRilievo(pos.clickZip);
            if (pos.grata) pos.grata = normalizzaProdottoRilievo(pos.grata);  // ğŸ”’ v5.85
        });
    }
    
    // Normalizza anche rilievoInfissi (formato legacy)
    if (project.rilievoInfissi && Array.isArray(project.rilievoInfissi)) {
        project.rilievoInfissi.forEach(pos => {
            if (pos.infisso) pos.infisso = normalizzaProdottoRilievo(pos.infisso);
            if (pos.persiana) pos.persiana = normalizzaProdottoRilievo(pos.persiana);
            if (pos.tapparella) pos.tapparella = normalizzaProdottoRilievo(pos.tapparella);
            if (pos.zanzariera) pos.zanzariera = normalizzaProdottoRilievo(pos.zanzariera);
            if (pos.cassonetto) pos.cassonetto = normalizzaProdottoRilievo(pos.cassonetto);
        });
    }
    
    return project;
}

/**
 * Normalizza tutti i progetti nello state
 */
function normalizzaTuttiProgetti() {
    if (!state || !state.projects) return;
    
    console.log('ğŸ”„ v5.77: Normalizzazione dati progetti...');
    state.projects.forEach(project => {
        normalizzaProgettoRilievo(project);
    });
    console.log(`âœ… Normalizzati ${state.projects.length} progetti`);
}



/**
 * âš¡ FASE 024B: Tracking digitazione utente (per sync silenzioso)
 */
let lastTypingTime = 0;
const TYPING_TIMEOUT = 3000; // 3 secondi dopo ultima digitazione

function markUserTyping() {
    lastTypingTime = Date.now();
}

function isUserTyping() {
    return (Date.now() - lastTypingTime) < TYPING_TIMEOUT;
}

/**
 * Aggiorna status sync visualizzato senza render completo
 */
function updateSyncStatusDisplay(status) {
    // Aggiorna badge sync nel menu principale
    const syncBadges = document.querySelectorAll('[data-sync-status]');
    syncBadges.forEach(badge => {
        const statusMap = {
            'syncing': { text: 'â†»', class: 'text-blue-500 animate-spin' },
            'synced': { text: 'â˜', class: 'text-green-500' },
            'error': { text: 'âš ', class: 'text-red-500' },
            'disconnected': { text: 'â—‹', class: 'text-gray-400' }
        };
        const config = statusMap[status] || statusMap['disconnected'];
        badge.textContent = config.text;
        badge.className = config.class;
    });
}

/**
 * Aggiorna un singolo campo DOM senza render completo
 */
function updateDOMField(elementId, value) {
    const el = document.getElementById(elementId);
    if (el) {
        if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
            el.value = value;
        } else {
            el.textContent = value;
        }
    }
}

/**
 * Aggiorna i BRM visualizzati per un prodotto specifico
 */
function updateBRMDisplay(projectId, posId, productType) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.positions) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) return;
    
    const product = pos[productType];
    if (!product) return;
    
    // Aggiorna i campi BRM visualizzati
    updateDOMField(`brm-l-${posId}-${productType}`, product.BRM_L || '');
    updateDOMField(`brm-h-${posId}-${productType}`, product.BRM_H || '');
}

/**
 * Aggiorna indicatori completamento senza render
 */
function updateCompletenessIndicators(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.positions) return;
    
    project.positions.forEach(pos => {
        const comp = calculatePositionCompleteness(pos);
        const indicator = document.getElementById(`completeness-${pos.id}`);
        if (indicator) {
            indicator.textContent = `${comp.percentage}%`;
            indicator.className = comp.percentage === 100 
                ? 'text-green-600 font-bold' 
                : 'text-orange-600 font-bold';
        }
    });
}

// Load/Save Functions
function loadState() {
    const saved = localStorage.getItem('openPorteData');
    if (saved) {
        try {
            state = JSON.parse(saved);
            console.log('ğŸ“‚ CARICATO DA LOCALSTORAGE');
            console.log(`   Progetti trovati: ${state.projects ? state.projects.length : 0}`);
            
            if (state.currentProject) {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (project) {
                    console.log('   Progetto corrente:', project.name);
                    console.log('   rilievoInfissi:', project.rilievoInfissi);
                    console.log('   rilievoPersiane:', project.rilievoPersiane);
                    console.log('   rilievoTapparelle:', project.rilievoTapparelle);
                }
            }
            
            console.log('ğŸ”„ ESEGUENDO migrateOldData...');
            migrateOldData(); // Migra dati vecchi formato array -> singolo oggetto
            
            console.log('ğŸ”„ ESEGUENDO migrateProjectRilievi per tutti i progetti...');
            if (state.projects && Array.isArray(state.projects)) {
                state.projects.forEach(project => {
                    migrateProjectRilievi(project);
                });
            }
            
            console.log('ğŸ”„ ESEGUENDO cleanNegativeValues...');
            cleanNegativeValues(); // âœ… NUOVO: Pulisce valori negativi nei BRM
            
            console.log('ğŸ”„ ESEGUENDO migrateOldProjectsMetadata...');
            migrateOldProjectsMetadata(); // âœ… SOLUZIONE C: Migra progetti senza metadata
            
            console.log('ğŸ”„ ESEGUENDO migrateGitHubStructure...');
            migrateGitHubStructure(); // ğŸ“¦ FASE 027K: Migra struttura GitHub se mancante
            
            console.log('ğŸ”„ ESEGUENDO migrateProjectDrawings per tutti i progetti...');
            // ğŸ¨ FASE DISEGNI: Migra struttura drawings
            if (state.projects && Array.isArray(state.projects)) {
                state.projects.forEach(project => {
                    migrateProjectDrawings(project);
                });
                console.log('âœ… Struttura drawings migrata per tutti i progetti');
            }
            
            console.log('ğŸ§¹ ESEGUENDO cleanCorruptedProjects...');
            cleanCorruptedProjects(); // ğŸ”§ v4.57: Rimuove progetti corrotti (ID mancante/undefined)
            
            console.log('ğŸ”„ ESEGUENDO migrateSostituzioneComponenti...');
            migrateSostituzioneComponenti(); // ğŸ”§ v4.92: Migra sostEsistente â†’ sostTipo
            
            console.log('ğŸ”„ ESEGUENDO normalizzaTuttiProgetti...');
            normalizzaTuttiProgetti(); // ğŸ†• v5.77: Normalizza qta/quantita
            
        } catch (e) {
            console.error('âŒ Errore caricando stato da localStorage:', e);
            console.log('ğŸ”„ Resetto allo stato iniziale...');
            // Reset to initial state if localStorage is corrupted
            state = {
                screen: 'list',
                projects: [],
                currentProject: null,
                currentPosition: null,
                setupStep: 1,
                projectMenuOpen: false,
                mainMenuOpen: false,
                github: {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                }
            };
        }
    } else {
        console.log('ğŸ“­ localStorage vuoto - Prima apertura app');
        console.log('ğŸ’¡ Usa il menu per creare un nuovo progetto o scarica da GitHub');
    }
    
    // ğŸ†• v4.22: FORZA SEMPRE apertura lista progetti all'avvio
    // Ignora screen salvato in localStorage
    state.screen = 'list';
    console.log('ğŸ“‹ Apertura app â†’ Lista progetti (forzato)');
    
    // ğŸ”§ FIX CRITICO: Assicura che state.github esista SEMPRE
    if (!state.github) {
        console.warn('âš ï¸ state.github non esisteva, lo creo ora');
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
    }
    
    // ğŸ”§ FIX CRITICO: Assicura che state.projects sia sempre un array
    if (!state.projects || !Array.isArray(state.projects)) {
        console.warn('âš ï¸ state.projects non era un array, lo reimposto');
        state.projects = [];
    }
    window._appState = state;
    // âŒ DISABILITATO: Non creare progetto demo automaticamente
    // Se non ci sono progetti, mostra schermata vuota con istruzioni
    if (state.projects.length === 0) {
        console.log('ğŸ“­ Nessun progetto presente');
        console.log('ğŸ’¡ Usa il pulsante "+ Nuovo Progetto" per iniziare');
    }
    /* PROGETTO DEMO DISABILITATO
    if (state.projects.length === 0 && window.location.hostname === 'localhost') {
        console.log('ğŸ¯ Creazione progetto di esempio per test locale...');
        const demoProject = createProject('demo_' + Date.now(), 'Progetto Demo');
        demoProject.client = 'Cliente Esempio';
        demoProject.clientData = {
            nome: 'Mario Rossi',
            indirizzo: 'Via Roma 1',
            telefono: '333 1234567',
            email: 'mario.rossi@example.com'
        };
        state.projects.push(demoProject);
        console.log('âœ… Progetto demo creato:', demoProject.name);
        saveState();
    }
    */
}

// ğŸ“¦ FASE 027K: Migrazione struttura GitHub per backward compatibility
function migrateGitHubStructure() {
    // Se state.github non esiste, crealo con valori default
    if (!state.github) {
        console.log('ğŸ”„ Migrazione: Aggiunta struttura GitHub');
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
        
        // Carica token se presente in localStorage
        const savedToken = localStorage.getItem('github_token');
        if (savedToken) {
            state.github.token = savedToken;
            state.github.connected = true;
            GITHUB_CONFIG.token = savedToken;
            console.log('âœ… Token GitHub caricato');
        }
        
        // Salva lo state migrato
        saveState();
    } else {
        // ğŸ“¦ FASE 027K FIX: Sincronizza token tra state e GITHUB_CONFIG
        if (state.github.token) {
            GITHUB_CONFIG.token = state.github.token;
            console.log('âœ… Token GitHub sincronizzato');
        } else {
            // Prova a caricare da localStorage se manca in state
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                state.github.token = savedToken;
                state.github.connected = true;
                GITHUB_CONFIG.token = savedToken;
                console.log('âœ… Token GitHub recuperato da localStorage');
            }
        }
    }
}

// âœ… NUOVO: Funzione per pulire valori negativi nei BRM
function cleanNegativeValues() {
    if (!state.projects) return;
    
    state.projects.forEach(project => {
        // Pulisci config globali
        const configs = ['brmConfigInfissi', 'brmConfigPersiane', 'brmConfigTapparelle', 
                         'brmConfigZanzariere', 'brmConfigCassonetti', 'brmConfigGrate'];
        
        configs.forEach(configKey => {
            if (project[configKey]) {
                ['valoreL', 'valoreH', 'valoreC', 'valoreB', 
                 'valoreL_PF', 'valoreH_PF'].forEach(field => {
                    if (project[configKey][field]) {
                        const val = parseFloat(project[configKey][field]);
                        if (!isNaN(val) && val < 0) {
                            project[configKey][field] = Math.abs(val).toString();
                        }
                    }
                });
            }
        });
        
        // Pulisci BRM personalizzati nelle posizioni
        if (project.positions) {
            project.positions.forEach(pos => {
                ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
                    const product = pos[productType];
                    if (product && product.brmPersonalizzato) {
                        ['valoreL', 'valoreH', 'valoreC', 'valoreB'].forEach(field => {
                            if (product.brmPersonalizzato[field]) {
                                const val = parseFloat(product.brmPersonalizzato[field]);
                                if (!isNaN(val) && val < 0) {
                                    product.brmPersonalizzato[field] = Math.abs(val).toString();
                                }
                            }
                        });
                    }
                });
                
                // ğŸ”§ Inizializza BSuperiore nei cassonetti esistenti
                if (pos.cassonetto) {
                    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                        ? pos.caratteristicheMuroOverride 
                        : project.caratteristicheMuro || {};
                    
                    const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                    
                    // âœ… FASE 015: Se BSuperiore non esiste (undefined/null/''), inizializzalo
                    // NON sovrascrivere '0' esplicito dell'utente!
                    if (pos.cassonetto.BSuperiore === undefined || 
                        pos.cassonetto.BSuperiore === null || 
                        pos.cassonetto.BSuperiore === '') {
                        pos.cassonetto.BSuperiore = bSuperioreDefault;
                    }
                }
            });
        }
    });
}

// ğŸ”§ v4.92: Migrazione sostEsistente â†’ sostTipo + accessoriDaSostituire
function migrateSostituzioneComponenti() {
    if (!state.projects || !Array.isArray(state.projects)) return;
    
    let migratedCount = 0;
    
    state.projects.forEach(project => {
        migratedCount += migrateSingleProjectSostituzione(project);
    });
    
    if (migratedCount > 0) {
        console.log(`âœ… Migrazione sostEsistente â†’ sostTipo: ${migratedCount} elementi aggiornati`);
        saveState();
    }
}

// Helper per migrare singolo progetto
function migrateSingleProjectSostituzione(project) {
    let count = 0;
    
    // Migra configTapparelle
    if (project.configTapparelle) {
        if (project.configTapparelle.sostEsistente && !project.configTapparelle.sostTipo) {
            // Converti vecchio valore in nuovo formato
            const oldValue = project.configTapparelle.sostEsistente;
            if (oldValue === 'Sost. tutto' || oldValue === 'Sost. Rullo SÃ¬') {
                project.configTapparelle.sostTipo = 'tutto';
            } else if (oldValue === 'Non Sost. Niente' || oldValue === 'Sost. Rullo No') {
                project.configTapparelle.sostTipo = 'niente';
            } else {
                project.configTapparelle.sostTipo = 'tutto'; // default
            }
            count++;
        }
        // Rimuovi vecchio campo
        delete project.configTapparelle.sostEsistente;
    }
    
    // Migra posizioni con tapparella
    if (project.positions && Array.isArray(project.positions)) {
        project.positions.forEach(pos => {
            if (pos.tapparella) {
                if (pos.tapparella.sostEsistente && !pos.tapparella.sostTipo) {
                    // Converti vecchio valore in nuovo formato
                    const oldValue = pos.tapparella.sostEsistente;
                    if (oldValue === 'Sost. tutto' || oldValue === 'Sost. Rullo SÃ¬') {
                        pos.tapparella.sostTipo = 'tutto';
                        // Imposta tutti gli accessori a true
                        pos.tapparella.accessoriDaSostituire = {
                            rullo: true, supporti: true, calotta: true,
                            puleggia: true, avvolgitore: true, cintino: true,
                            passacinghia: true, ganci: true, guide: true
                        };
                    } else if (oldValue === 'Non Sost. Niente' || oldValue === 'Sost. Rullo No') {
                        pos.tapparella.sostTipo = 'niente';
                        pos.tapparella.accessoriDaSostituire = {
                            rullo: false, supporti: false, calotta: false,
                            puleggia: false, avvolgitore: false, cintino: false,
                            passacinghia: false, ganci: false, guide: false
                        };
                    } else {
                        pos.tapparella.sostTipo = 'tutto';
                        pos.tapparella.accessoriDaSostituire = {
                            rullo: true, supporti: true, calotta: true,
                            puleggia: true, avvolgitore: true, cintino: true,
                            passacinghia: true, ganci: true, guide: true
                        };
                    }
                    count++;
                }
                // Rimuovi vecchio campo
                delete pos.tapparella.sostEsistente;
            }
        });
    }
    
    return count;
}

// ğŸ”§ v4.57: Pulizia progetti corrotti (ID mancante o undefined)
function cleanCorruptedProjects() {
    if (!state.projects || !Array.isArray(state.projects)) return;
    
    const originalLength = state.projects.length;
    
    // Rimuovi progetti con ID corrotto
    state.projects = state.projects.filter(project => {
        // Controlla ID valido
        const hasValidId = project.id && 
                          project.id !== '#UNKNOWN' && 
                          project.id !== 'undefined' && 
                          typeof project.id === 'string' &&
                          project.id.trim() !== '';
        
        // Controlla nome valido (almeno uno dei tre)
        const hasValidName = (project.name && project.name !== 'undefined' && project.name.trim()) ||
                            (project.client && project.client !== 'undefined' && project.client.trim()) ||
                            (project.clientData?.nome && project.clientData.nome !== 'undefined' && project.clientData.nome.trim());
        
        // Se progetto corrotto, logga e rimuovi
        if (!hasValidId || !hasValidName) {
            console.warn('ğŸ—‘ï¸ PROGETTO CORROTTO RIMOSSO:', {
                id: project.id,
                name: project.name,
                client: project.client,
                hasValidId: hasValidId,
                hasValidName: hasValidName
            });
            return false; // Rimuovi
        }
        
        return true; // Mantieni
    });
    
    const removedCount = originalLength - state.projects.length;
    
    if (removedCount > 0) {
        console.log(`âœ… Rimossi ${removedCount} progetti corrotti`);
        saveState(); // Salva stato pulito
        showNotification(`ğŸ§¹ Rimossi ${removedCount} progetti corrotti dal database`, 'success', 4000);
    } else {
        console.log('âœ… Nessun progetto corrotto trovato');
    }
}

// Migrazione dati da vecchio formato (array) a nuovo formato (oggetto singolo)
// ============================================================================
// MIGRAZIONE RILIEVI: Aggiunge rilievi mancanti alle posizioni
// ============================================================================
function migrateProjectRilievi(project) {
    if (!project || !project.positions) return project;
    
    console.log(`ğŸ”„ Migrazione rilievi per progetto: ${project.name || project.id}`);
    
    let migratedCount = 0;
    
    project.positions.forEach((pos, index) => {
        let positionMigrated = false;
        
        // PERSIANE
        if (!pos.rilievoPersiane && project.rilievoPersiane) {
            pos.rilievoPersiane = {
                togliere: project.rilievoPersiane.togliere || false,
                smaltimento: project.rilievoPersiane.smaltimento || false,
                materiale: project.rilievoPersiane.materiale || '',
                note: project.rilievoPersiane.note || ''
            };
            positionMigrated = true;
        }
        
        // TAPPARELLE
        if (!pos.rilievoTapparelle && project.rilievoTapparelle) {
            pos.rilievoTapparelle = {
                togliere: project.rilievoTapparelle.togliere || false,
                smaltimento: project.rilievoTapparelle.smaltimento || false,
                materiale: project.rilievoTapparelle.materiale || '',
                note: project.rilievoTapparelle.note || ''
            };
            positionMigrated = true;
        }
        
        // ZANZARIERE
        if (!pos.rilievoZanzariere && project.rilievoZanzariere) {
            pos.rilievoZanzariere = {
                togliere: project.rilievoZanzariere.togliere || false,
                smaltimento: project.rilievoZanzariere.smaltimento || false,
                materiale: project.rilievoZanzariere.materiale || '',
                note: project.rilievoZanzariere.note || ''
            };
            positionMigrated = true;
        }
        
        // CASSONETTI
        if (!pos.rilievoCassonetti && project.rilievoCassonetti) {
            pos.rilievoCassonetti = {
                togliere: project.rilievoCassonetti.togliere || false,
                smaltimento: project.rilievoCassonetti.smaltimento || false,
                materiale: project.rilievoCassonetti.materiale || '',
                note: project.rilievoCassonetti.note || ''
            };
            positionMigrated = true;
        }
        
        if (positionMigrated) {
            migratedCount++;
            console.log(`  âœ… Posizione ${index + 1} (${pos.name}): rilievi aggiunti`);
        }
    });
    
    if (migratedCount > 0) {
        console.log(`âœ… Migrazione completata: ${migratedCount} posizioni aggiornate`);
        // Aggiorna metadata versione
        if (!project.metadata) project.metadata = {};
        project.metadata.migratedToV45 = true;
        project.metadata.migrationDate = new Date().toISOString();
    } else {
        console.log(`âœ“ Nessuna migrazione necessaria`);
    }
    
    return project;
}

// ============================================================================
// MIGRAZIONE RILIEVI: Aggiunge rilievi mancanti alle posizioni
// ============================================================================
function migrateProjectRilievi(project) {
    if (!project || !project.positions) return project;
    
    console.log(`ğŸ”„ Migrazione rilievi per progetto: ${project.name || project.id}`);
    
    let migratedCount = 0;
    
    project.positions.forEach((pos, index) => {
        let positionMigrated = false;
        
        // PERSIANE
        if (!pos.rilievoPersiane && project.rilievoPersiane) {
            pos.rilievoPersiane = {
                togliere: project.rilievoPersiane.togliere || false,
                smaltimento: project.rilievoPersiane.smaltimento || false,
                materiale: project.rilievoPersiane.materiale || '',
                note: project.rilievoPersiane.note || ''
            };
            positionMigrated = true;
        }
        
        // TAPPARELLE
        if (!pos.rilievoTapparelle && project.rilievoTapparelle) {
            pos.rilievoTapparelle = {
                togliere: project.rilievoTapparelle.togliere || false,
                smaltimento: project.rilievoTapparelle.smaltimento || false,
                materiale: project.rilievoTapparelle.materiale || '',
                note: project.rilievoTapparelle.note || ''
            };
            positionMigrated = true;
        }
        
        // ZANZARIERE
        if (!pos.rilievoZanzariere && project.rilievoZanzariere) {
            pos.rilievoZanzariere = {
                togliere: project.rilievoZanzariere.togliere || false,
                smaltimento: project.rilievoZanzariere.smaltimento || false,
                materiale: project.rilievoZanzariere.materiale || '',
                note: project.rilievoZanzariere.note || ''
            };
            positionMigrated = true;
        }
        
        // CASSONETTI
        if (!pos.rilievoCassonetti && project.rilievoCassonetti) {
            pos.rilievoCassonetti = {
                togliere: project.rilievoCassonetti.togliere || false,
                smaltimento: project.rilievoCassonetti.smaltimento || false,
                materiale: project.rilievoCassonetti.materiale || '',
                note: project.rilievoCassonetti.note || ''
            };
            positionMigrated = true;
        }
        
        if (positionMigrated) {
            migratedCount++;
            console.log(`  âœ… Posizione ${index + 1} (${pos.name}): rilievi aggiunti`);
        }
    });
    
    if (migratedCount > 0) {
        console.log(`âœ… Migrazione completata: ${migratedCount} posizioni aggiornate`);
        if (!project.metadata) project.metadata = {};
        project.metadata.migratedToV45 = true;
        project.metadata.migrationDate = new Date().toISOString();
    } else {
        console.log(`âœ“ Nessuna migrazione necessaria`);
    }
    
    return project;
}

function migrateOldData() {
    if (!state.projects) return;
    
    state.projects.forEach(project => {
        // ğŸ”§ FIX CRITICO: Migra rilievi globali da ARRAY a OGGETTO se necessario
        ['rilievoInfissi', 'rilievoPersiane', 'rilievoTapparelle', 'rilievoZanzariere', 'rilievoCassonetti'].forEach(rilievoKey => {
            if (Array.isArray(project[rilievoKey])) {
                console.warn(`âš ï¸ MIGRAZIONE: ${rilievoKey} era ARRAY, convertito in OGGETTO`);
                // Se Ã¨ un array vuoto o con elementi, convertilo in oggetto vuoto
                project[rilievoKey] = {
                    materiale: '',
                    note: '',
                    togliere: false,
                    smaltimento: false
                };
                
                // Aggiungi coprifili solo per infissi
                if (rilievoKey === 'rilievoInfissi') {
                    project[rilievoKey].coprifiliInt = false;
                    project[rilievoKey].coprifiliEst = false;
                }
            }
        });
        
        if (!project.positions) return;
        
        project.positions.forEach(pos => {
            // Migra infissi
            if (pos.infissi && Array.isArray(pos.infissi) && pos.infissi.length > 0) {
                pos.infisso = pos.infissi[0]; // Prendi il primo
                delete pos.infissi;
            }
            
            // Migra persiane
            if (pos.persiane && Array.isArray(pos.persiane) && pos.persiane.length > 0) {
                pos.persiana = pos.persiane[0];
                delete pos.persiane;
            }
            
            // Migra tapparelle
            if (pos.tapparelle && Array.isArray(pos.tapparelle) && pos.tapparelle.length > 0) {
                pos.tapparella = pos.tapparelle[0];
                delete pos.tapparelle;
            }
            
            // Migra zanzariere
            if (pos.zanzariere && Array.isArray(pos.zanzariere) && pos.zanzariere.length > 0) {
                pos.zanzariera = pos.zanzariere[0];
                delete pos.zanzariere;
            }
            
            // Migra cassonetti
            if (pos.cassonetti && Array.isArray(pos.cassonetti) && pos.cassonetti.length > 0) {
                pos.cassonetto = pos.cassonetti[0];
                delete pos.cassonetti;
            }
        });
    });
    
    // ğŸ” DEBUG: Verifica stato prima di salvare
    if (state.currentProject) {
        const project = state.projects.find(p => p.id === state.currentProject);
        if (project) {
            console.log('ğŸ” DENTRO migrateOldData PRIMA di saveState:');
            console.log('   rilievoPersiane:', project.rilievoPersiane);
            console.log('   Tipo:', Array.isArray(project.rilievoPersiane) ? 'ARRAY' : 'OGGETTO');
        }
    }
    
    saveState(); // Salva i dati migrati
}

function saveState() {
    // ğŸ“¦ FASE 027K: Aggiorna metadata modifiche
    if (!state.metadata) {
        state.metadata = {};
    }
    state.metadata.lastModified = Date.now();
    state.metadata.appVersion = '4.20';
    
    // ğŸ“¦ FASE 027K: Assicurati che github structure esista
    if (!state.github) {
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
    }
    
    // ğŸ” DEBUG: Log rilievo globale prima di salvare
    if (state.currentProject) {
        const project = state.projects.find(p => p.id === state.currentProject);
        if (project) {
            console.log('ğŸ’¾ SALVANDO IN LOCALSTORAGE:');
            console.log('   rilievoInfissi:', project.rilievoInfissi);
            console.log('   rilievoPersiane:', project.rilievoPersiane);
            console.log('   rilievoTapparelle:', project.rilievoTapparelle);
        }
    }
    
    try {
        localStorage.setItem('openPorteData', JSON.stringify(state));
        console.log('âœ… localStorage AGGIORNATO');
    } catch (error) {
        console.error('âŒ Errore salvataggio localStorage:', error);
        showNotification('âš ï¸ Errore salvataggio locale: ' + error.message, 'error', 5000);
        return; // Esci se non riesce a salvare localmente
    }
    
    // ğŸ“¦ FASE 027K: Auto-backup su GitHub (debounced)
    // Solo se connesso, auto-backup abilitato e non giÃ  in sync
    if (state.github && state.github.connected && 
        state.github.autoBackupEnabled && 
        state.github.syncStatus !== 'syncing' &&
        !window._isUploading) {
        
        try {
            // Debounce: aspetta 2 secondi di inattivitÃ  prima di sync
            clearTimeout(window.githubSyncDebounce);
            window.githubSyncDebounce = setTimeout(() => {
                uploadToGitHub().catch(err => {
                    console.error('âŒ Errore auto-sync GitHub:', err);
                });
            }, 2000);
        } catch (error) {
            console.error('âŒ Errore setup auto-sync:', error);
        }
    }
}

// ============================================================================
// ğŸ†• GENERA ID PROGETTO - Formato: ANNO_MESE_XXXX (es: 2025_11_0001)
// ============================================================================

/**
 * Valida Step 1 - Nome Cliente obbligatorio
 */
function validateStep1(project) {
    if (!project.client || project.client.trim() === '') {
        alert('âš ï¸ ATTENZIONE\n\nIl campo "Cliente" Ã¨ obbligatorio.\n\nCompila il nome del cliente prima di procedere.');
        return false;
    }
    return true;
}

/**
 * Cambia step con validazione
 */
function changeSetupStep(newStep) {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) return;
    
    // Se sto passando da Step 1 a qualsiasi altro step, valida
    if (state.setupStep === 1 && newStep > 1) {
        if (!validateStep1(project)) {
            return; // Blocca cambio step
        }
    }
    
    // Cambio step OK
    state.setupStep = newStep;
    render();
}

function generateProjectId() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0'); // 01-12
    
    // Chiave localStorage per contatore mensile
    const counterKey = `project_counter_${year}_${month}`;
    
    // Leggi contatore attuale (default 0)
    let counter = parseInt(localStorage.getItem(counterKey) || '0');
    
    // Incrementa contatore
    counter++;
    
    // Salva nuovo contatore
    localStorage.setItem(counterKey, counter.toString());
    
    // Genera ID: 2025_11_0001
    const projectId = `${year}_${month}_${String(counter).padStart(4, '0')}`;
    
    console.log(`âœ… Generated Project ID: ${projectId}`);
    return projectId;
}

// ============================================================================
// GENERA ID GENERICO (per elementi interni come prodotti)
// ============================================================================
// ğŸ†• v4.20: Genera ID progetto sequenziale formato ANNOP001
// Esempi: 2025P001, 2025P002, 2025P003, ..., 2025P999
function generateId() {
    const currentYear = new Date().getFullYear();
    
    // Trova tutti i progetti dell'anno corrente
    const existingIds = (state.projects || [])
        .map(p => p.id)
        .filter(id => id && id.startsWith(currentYear + 'P'));
    
    // Estrai i numeri esistenti
    const existingNumbers = existingIds
        .map(id => {
            const match = id.match(/^(\d{4})P(\d{3})$/);
            return match ? parseInt(match[2]) : 0;
        })
        .filter(n => n > 0);
    
    // Trova il prossimo numero disponibile
    const nextNumber = existingNumbers.length > 0 
        ? Math.max(...existingNumbers) + 1 
        : 1;
    
    // Formatta con padding (001, 002, 003, etc.)
    const paddedNumber = String(nextNumber).padStart(3, '0');
    
    // Ritorna formato: 2025P001
    return `${currentYear}P${paddedNumber}`;
}

// ğŸ†• v4.20: Formatta ID progetto per visualizzazione
// Il formato ANNOP001 si mostra direttamente con il prefisso #
// Esempio: "2025P001" â†’ "#2025P001"
function formatProjectId(id) {
    if (!id) return '#UNKNOWN';
    // Se giÃ  in formato ANNOP001, mostra direttamente
    if (/^\d{4}P\d{3}$/.test(id)) {
        return '#' + id;
    }
    // Fallback per vecchi ID casuali (primi 6 caratteri)
    return '#' + id.substring(0, 6).toUpperCase();
}

// ğŸ†• Genera ID sequenziale per posizione: 2025_11_0001_01, 2025_11_0001_02, ecc
function generateSequentialPositionId(projectId, positions) {
    const existingNumbers = positions
        .map(p => {
            // Match formato: 2025_11_0001_01, 2025_11_0001_02, ecc.
            const match = p.id.match(new RegExp(`^${projectId.replace(/_/g, '\\_')}_(\\d+)$`));
            return match ? parseInt(match[1]) : 0;
        })
        .filter(n => n > 0);
    
    const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
    return `${projectId}_${String(nextNumber).padStart(2, '0')}`;
}

/**
 * Genera un ID leggibile per una posizione basato su ambiente
 * Es: "cucina-1", "soggiorno-2", ecc.
 */
function generatePositionId(ambiente, projectPositions) {
    // Normalizza ambiente per usarlo come ID
    let baseId = (ambiente || 'posizione')
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '-')  // Sostituisci caratteri speciali con -
        .replace(/-+/g, '-')         // Rimuovi - multipli
        .replace(/^-|-$/g, '');      // Rimuovi - iniziali/finali
    
    // Se vuoto, usa "posizione"
    if (!baseId) baseId = 'posizione';
    
    // Conta quante posizioni con questo base ID esistono giÃ 
    const existingWithSameBase = projectPositions.filter(p => 
        p.id.startsWith(baseId + '-') || p.id === baseId
    ).length;
    
    // Aggiungi numero progressivo
    const counter = existingWithSameBase + 1;
    
    return `${baseId}-${counter}`;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš¡ FASE 024C: SISTEMA UNIVERSALE TOGGLE SELECT/INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Toggle universale tra select e input per qualsiasi campo
 * @param {string} fieldId - ID base del campo (es. 'azienda', 'coloreInt')
 * @param {string} context - Contesto univoco (es. 'infisso-proj123', 'pos456')
 */
window.toggleFieldMode = (fieldId, context) => {
    const selectEl = document.getElementById(`${fieldId}-select-${context}`);
    const inputEl = document.getElementById(`${fieldId}-input-${context}`);
    const btnEl = document.getElementById(`${fieldId}-toggle-${context}`);
    
    if (!selectEl || !inputEl) return;
    
    if (selectEl.style.display === 'none') {
        // Torna a SELECT
        selectEl.style.display = 'block';
        inputEl.style.display = 'none';
        if (btnEl) btnEl.innerHTML = 'âœï¸ Scrivi manualmente';
        
        // Trasferisci valore da input a select se presente
        if (inputEl.value && inputEl.value.trim() !== '') {
            // Se il valore non Ã¨ nelle opzioni, aggiungilo temporaneamente
            const existingOption = Array.from(selectEl.options).find(opt => opt.value === inputEl.value);
            if (!existingOption) {
                const newOption = document.createElement('option');
                newOption.value = inputEl.value;
                newOption.text = inputEl.value;
                newOption.selected = true;
                selectEl.appendChild(newOption);
            } else {
                selectEl.value = inputEl.value;
            }
        }
    } else {
        // Passa a INPUT
        selectEl.style.display = 'none';
        inputEl.style.display = 'block';
        if (btnEl) btnEl.innerHTML = 'ğŸ“‹ Torna a selezione';
        
        // Trasferisci valore da select a input
        if (selectEl.value && selectEl.value !== '') {
            inputEl.value = selectEl.value;
        }
        inputEl.focus();
    }
};

/**
 * Genera HTML per campo con toggle select/input
 * @param {Object} config - Configurazione campo
 * @returns {string} HTML completo del campo
 */
function renderFieldWithToggle(config) {
    const {
        fieldId,           // 'azienda', 'coloreInt', ecc.
        context,           // 'infisso-proj123' o 'pos456'
        label,             // 'Azienda'
        currentValue,      // Valore corrente
        options,           // Array opzioni ['Oknoplast', 'Finstral', ...]
        updateFunction,    // Nome funzione da chiamare (es. 'updateConfigInfissi')
        updateParams,      // Parametri per la funzione update
        required = false   // Se il campo Ã¨ obbligatorio
    } = config;
    
    // ğŸ†• v4.22: Feedback visivo - arancione se vuoto, bianco se compilato
    const isEmpty = !currentValue || currentValue === '';
    const borderClass = isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white';
    const statusIcon = required ? (isEmpty ? '<span class="text-orange-600">â—</span>' : '<span class="text-green-600">âœ“</span>') : '';
    
    // Costruisci parametri per update function
    const updateCall = `${updateFunction}(${updateParams.map(p => `'${p}'`).join(', ')}, this.value)`;
    
    return `
        <div class="mb-3">
            <div class="flex items-center justify-between mb-1">
                <label class="text-sm font-semibold flex items-center gap-2">
                    ${label}
                    ${statusIcon}
                </label>
                <button onclick="toggleFieldMode('${fieldId}', '${context}')" 
                        id="${fieldId}-toggle-${context}"
                        class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                    âœï¸ Scrivi manualmente
                </button>
            </div>
            
            <!-- SELECT MODE (default) -->
            <select id="${fieldId}-select-${context}"
                    onchange="${updateCall}"
                    class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    style="display: block;">
                <option value="">Seleziona...</option>
                ${options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
            
            <!-- INPUT MODE (hidden) -->
            <input type="text" 
                   id="${fieldId}-input-${context}"
                   value="${currentValue || ''}"
                   oninput="${updateCall}"
                   placeholder="Scrivi ${label.toLowerCase()}..."
                   class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                   style="display: none;">
        </div>
    `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ SELECT CON CUSTOM INPUT - FASE 020
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Handler globale per gestire il cambio tra select e custom input
window.handleSelectCustomChange = (fieldName, selectElement, projectId, posId, productType) => {
    const value = selectElement.value;
    console.log('ğŸŸ  handleSelectCustomChange CHIAMATA:', {fieldName, value, projectId, posId, productType});
    const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
    const customInput = document.getElementById(customInputId);
    
    // ğŸ†• v4.22: Feedback visivo immediato - cambia colore bordo
    if (value === '' || value === '__custom__') {
        // Vuoto o custom â†’ arancione
        selectElement.classList.remove('border-gray-300', 'bg-white');
        selectElement.classList.add('border-orange-400', 'bg-orange-50');
    } else {
        // Compilato â†’ bianco
        selectElement.classList.remove('border-orange-400', 'bg-orange-50');
        selectElement.classList.add('border-gray-300', 'bg-white');
    }
    
    if (value === '__custom__') {
        // Mostra input custom
        if (customInput) {
            customInput.style.display = 'block';
            customInput.focus();
        }
    } else if (value !== '') {
        // Nascondi input custom
        if (customInput) {
            customInput.style.display = 'none';
            customInput.value = '';
        }
        
        // Determina se Ã¨ rilievo globale (productType plurale)
        const isRilievoGlobale = (productType === 'infissi' || productType === 'persiane' || 
                                 productType === 'tapparelle' || productType === 'zanzariere' || 
                                 productType === 'cassonetti' || productType === 'grate');
        
        // âš¡ Per rilievo globale SALVA IMMEDIATAMENTE senza delay
        if (isRilievoGlobale) {
            console.log('ğŸŸ¢ Chiamando updateRilievoGlobale IMMEDIATAMENTE');
            updateRilievoGlobale(projectId, productType, fieldName, value);
        } else {
            // ğŸ› FIX v5.710: Rimosso setTimeout(50ms) che causava mancato salvataggio
            // Il delay impediva il salvataggio se utente esportava/sincronizzava rapidamente
            if (posId && productType) {
                // Ãˆ una posizione
                updateProduct(projectId, posId, productType, fieldName, value);
                
                // ğŸ”§ v5.710: Re-render per campi che modificano la UI condizionalmente
                if (fieldName === 'tipoAnta' || fieldName === 'finituraInt' || fieldName === 'finituraEst') {
                    render();
                }
            } else {
                // Ãˆ config globale
                if (productType === 'infisso') {
                    updateConfigInfissi(projectId, fieldName, value);
                    // ğŸ”§ v5.710: Re-render per tipoAnta in config globale (sezione Anta Twin)
                    if (fieldName === 'tipoAnta') {
                        render();
                    }
                } else if (productType === 'persiana') {
                    updateConfigPersiane(projectId, fieldName, value);
                } else if (productType === 'tapparella') {
                    updateConfigTapparelle(projectId, fieldName, value);
                } else if (productType === 'zanzariera') {
                    updateConfigZanzariere(projectId, fieldName, value);
                } else if (productType === 'cassonetto') {
                    updateConfigCassonetti(projectId, fieldName, value);
                } else if (productType === 'grata') {
                    console.log('ğŸ”’ handleSelectCustomChange â†’ updateConfigGrate:', fieldName, value);
                    updateConfigGrate(projectId, fieldName, value);
                }
            }
            
            // ğŸ¨ v4.40: Se campo finitura, aggiorna colori IMMEDIATAMENTE
            if (fieldName === 'finituraInt' || fieldName === 'finituraEst') {
                // ğŸ› FIX v5.710: Ridotto delay da 150ms a 50ms dopo rimozione primo delay
                setTimeout(() => {
                    console.log(`ğŸ¨ TRIGGER DIRETTO: Aggiorno colori per ${fieldName}`);
                    aggiornaColoriPerFinitura(fieldName, projectId, posId, productType);
                }, 50);
            }
        }
    }
};

// Funzione per renderizzare select con opzione custom
function renderSelectWithCustom(fieldName, currentValue, options, projectId, posId, productType, label) {
    // Determina se il valore corrente Ã¨ custom (non nella lista)
    const isCustom = currentValue && currentValue !== '' && !options.includes(currentValue);
    const selectedValue = isCustom ? '__custom__' : (currentValue || '');
    const isEmpty = !currentValue || currentValue === '';
    
    // ID univoco per l'input custom
    const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
    
    return `
        <div class="mb-2">
            ${label ? `<label class="block text-base font-bold mb-1 text-gray-800">${label}</label>` : ''}
            
            <!-- Select principale -->
            <select 
                class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                onchange="handleSelectCustomChange('${fieldName}', this, '${projectId}', '${posId || ''}', '${productType}')"
            >
                <option value="" class="text-gray-400">â–¼ Seleziona...</option>
                ${options.map(opt => `
                    <option value="${opt}" ${selectedValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                        ${opt}
                    </option>
                `).join('')}
                <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">
                    ğŸ–Šï¸ Scrivi manualmente
                </option>
            </select>
            
            <!-- Input custom (nascosto se non serve) -->
            <input 
                type="text" 
                class="w-full px-3 py-2.5 border-2 border-blue-400 rounded-lg mt-2 text-base font-medium bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                id="${customInputId}"
                placeholder="âœï¸ Scrivi valore personalizzato..."
                value="${isCustom ? currentValue : ''}"
                style="display: ${isCustom ? 'block' : 'none'};"
                onchange="${posId ? `updateProduct('${projectId}', '${posId}', '${productType}', '${fieldName}', this.value)` : 
                          productType === 'infisso' ? `updateConfigInfissi('${projectId}', '${fieldName}', this.value)` :
                          productType === 'persiana' ? `updateConfigPersiane('${projectId}', '${fieldName}', this.value)` :
                          productType === 'tapparella' ? `updateConfigTapparelle('${projectId}', '${fieldName}', this.value)` :
                          productType === 'zanzariera' ? `updateConfigZanzariere('${projectId}', '${fieldName}', this.value)` :
                          productType === 'grata' ? `updateConfigGrate('${projectId}', '${fieldName}', this.value)` :
                          `updateConfigCassonetti('${projectId}', '${fieldName}', this.value)`}"
            />
        </div>
    `;
}

// ğŸ¨ FASE 30024: Funzione per select colori dinamici (PVC vs Alluminio)
function renderSelectColore(fieldName, currentValue, finituraValue, projectId, posId, productType, label) {
    // ğŸ†• v5.68: Colori PVC aggiornati
    const coloriPVC = [
        '01 - Bianco',
        '45 - Bianco satinato',
        '27 - Bianco crema satinato',
        '42 - Bianco goffrato',
        '07 - Bianco crema goffrato',
        '36 - Grigio topo',
        '46 - Grigio seta',
        '06 - Grigio (âš ï¸ scade 32/2026)',
        '13 - Castagno decoro legno',
        '19 - Rovere decoro legno',
        '55 - Noce chiaro decoro legno'
    ];
    
    // Colori Alluminio (SOLO effetti legno)
    const coloriAlluminioLegno = [
        'L13 - Castagno verniciato',
        'L14 - Mogano verniciato',
        'L16 - Douglas verniciato',
        'L18 - Noce verniciato',
        'L19 - Rovere verniciato',
        'L55 - Noce chiaro verniciato',
        'LX01 - Rovere naturale',
        'LX02 - Ciliegio scuro',
        'LX03 - Pino verniciato',
        'LX04 - Rovere venato'
    ];
    
    // ğŸ†• v5.68: Colori LEGNO
    const coloriLegno = [
        'G0 - Rovere naturale',
        'G0 - Faggio naturale',
        'G0 - Acero naturale',
        'G1 - Rovere tinto',
        'G1 - Noce',
        'G1 - Ciliegio',
        'G2 - WengÃ©',
        'G2 - Mogano',
        'G2 - Teak',
        'G3 - Essenze speciali',
        'G3 - RAL su legno'
    ];
    
    // Scelta opzioni in base a finitura
    let opzioni = [];
    const finituraLower = (finituraValue || '').toLowerCase();
    
    if (finituraLower.includes('legno') || finituraLower === 'legno') {
        opzioni = coloriLegno;
    } else if (finituraLower.includes('alluminio') || finituraLower === 'alu') {
        opzioni = coloriAlluminioLegno;
    } else {
        // Se finitura non impostata o altro materiale, usa PVC come default
        opzioni = coloriPVC;
    }
    
    // Usa renderSelectWithCustom con opzioni dinamiche
    return renderSelectWithCustom(fieldName, currentValue, opzioni, projectId, posId, productType, label);
}

// ğŸ¨ FASE 30024b: Select COLORI STANDARD (NO custom input) - v4.29
function renderSelectColoreStandard(fieldName, currentValue, finituraValue, projectId, posId, productType, label) {
    // âœ… COLORI PVC CORRETTI (dal PDF Finstral pagina 1)
    const coloriPVC = [
        '01 - Bianco',              // extraliscio
        '45 - Bianco',              // satinata
        '27 - Bianco crema',        // satinata (ğŸ†• v5.68: rinominato da "perla")
        '42 - Bianco',              // goffrata
        '07 - Bianco crema',        // goffrata (ğŸ†• v5.68: rinominato)
        '36 - Grigio topo',         // ğŸ†• v5.68: solo ALU-ALU/ALU-LEGNO
        '46 - Grigio seta',         // satinata
        '06 - Grigio (âš ï¸ scade 32/2026)',  // ğŸ†• v5.68: warning scadenza
        '13 - Castagno decoro legno',   // goffrata
        '19 - Rovere decoro legno',     // goffrata
        '55 - Noce chiaro decoro legno' // goffrata
    ];
    
    // âœ… COLORI ALLUMINIO - Solo decoro legno (dal PDF pagina 2, gruppo 1H)
    const coloriAlluminioLegno = [
        'L13 - Castagno verniciato',
        'L14 - Mogano verniciato',
        'L16 - Douglas verniciato',
        'L18 - Noce verniciato',
        'L19 - Rovere verniciato',
        'L55 - Noce chiaro verniciato',
        'LX01 - Rovere naturale',
        'LX02 - Ciliegio scuro',
        'LX03 - Pino verniciato',
        'LX04 - Rovere venato'
    ];
    
    // ğŸ†• v5.68: COLORI LEGNO (da FINDOOR_COLORI_LEGNO)
    const coloriLegno = [
        // Gruppo 0 - Base
        'G0 - Rovere naturale',
        'G0 - Faggio naturale',
        'G0 - Acero naturale',
        // Gruppo 1
        'G1 - Rovere tinto',
        'G1 - Noce',
        'G1 - Ciliegio',
        // Gruppo 2
        'G2 - WengÃ©',
        'G2 - Mogano',
        'G2 - Teak',
        // Gruppo 3
        'G3 - Essenze speciali',
        'G3 - RAL su legno'
    ];
    
    // Scelta opzioni in base a finitura - FIX v4.37: Logica piÃ¹ robusta
    let opzioni = [];
    
    // Normalizza il valore di finitura (trim + lowercase)
    const finituraNormalized = (finituraValue || '').toString().trim().toLowerCase();
    
    console.log(`ğŸ¨ DEBUG renderSelectColoreStandard: fieldName=${fieldName}, finitura="${finituraValue}" â†’ normalized="${finituraNormalized}"`);
    
    // PrioritÃ : Se contiene "legno" â†’ usa colori legno
    if (finituraNormalized.includes('legno') || finituraNormalized === 'legno') {
        opzioni = coloriLegno;
        console.log(`   âœ… Finitura LEGNO â†’ ${coloriLegno.length} colori legno`);
    }
    // Se contiene "alluminio" â†’ usa colori alluminio
    else if (finituraNormalized.includes('alluminio') || finituraNormalized.includes('aluminio') || finituraNormalized === 'alu') {
        opzioni = coloriAlluminioLegno;
        console.log(`   âœ… Finitura contiene "alluminio" â†’ ${coloriAlluminioLegno.length} colori alluminio`);
    } 
    // Altrimenti: usa colori PVC (default sicuro)
    else {
        opzioni = coloriPVC;
        console.log(`   âœ… Finitura PVC o vuota â†’ ${coloriPVC.length} colori PVC`);
    }
    
    // Determina se il valore corrente Ã¨ custom (non nella lista)
    const isCustom = currentValue && currentValue !== '' && !opzioni.includes(currentValue);
    const selectedValue = isCustom ? '__custom__' : (currentValue || '');
    const isEmpty = !currentValue || currentValue === '';
    
    // ID univoco per l'input custom
    const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
    
    // ID univoco per il select (per update dinamico)
    const selectId = `${fieldName}_select_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
    
    return `
        <div class="mb-2">
            ${label ? `<label class="block text-base font-bold mb-1 text-gray-800">${label}</label>` : ''}
            
            <!-- Select con colori validi + opzione custom -->
            <select 
                id="${selectId}"
                class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                onchange="handleSelectCustomChange('${fieldName}', this, '${projectId}', '${posId || ''}', '${productType}')"
            >
                <option value="" class="text-gray-400">â–¼ Seleziona...</option>
                ${opzioni.map(opt => `
                    <option value="${opt}" ${selectedValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                        ${opt}
                    </option>
                `).join('')}
                <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">
                    ğŸ–Šï¸ Scrivi manualmente
                </option>
            </select>
            
            <!-- Input custom (nascosto se non serve) -->
            <input 
                type="text" 
                class="w-full px-3 py-2.5 border-2 border-blue-400 rounded-lg mt-2 text-base font-medium bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                id="${customInputId}"
                placeholder="âœï¸ Scrivi colore personalizzato..."
                value="${isCustom ? currentValue : ''}"
                style="display: ${isCustom ? 'block' : 'none'};"
                onchange="${posId ? `updateProduct('${projectId}', '${posId}', '${productType}', '${fieldName}', this.value)` : 
                          productType === 'infisso' ? `updateConfigInfissi('${projectId}', '${fieldName}', this.value)` :
                          productType === 'persiana' ? `updateConfigPersiane('${projectId}', '${fieldName}', this.value)` :
                          productType === 'tapparella' ? `updateConfigTapparelle('${projectId}', '${fieldName}', this.value)` :
                          productType === 'zanzariera' ? `updateConfigZanzariere('${projectId}', '${fieldName}', this.value)` :
                          productType === 'grata' ? `updateConfigGrate('${projectId}', '${fieldName}', this.value)` :
                          `updateConfigCassonetti('${projectId}', '${fieldName}', this.value)`}"
            />
        </div>
    `;
}

// ğŸ†• v5.35: Funzioni helper per Config Cassonetti Finstral
function renderSelectCodiceCassonetto(project) {
    const mat = project.configCassonetti?.materialeCass || '';
    const current = project.configCassonetti?.codiceCass || '';
    
    if (mat === 'PVC') {
        return `
            <select onchange="updateConfigCassonetti('${project.id}', 'codiceCass', this.value)"
                    class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona codice...</option>
                <option value="148" ${current === '148' ? 'selected' : ''}>148 - Bâ‰¤148mm (standard)</option>
                <option value="148B" ${current === '148B' ? 'selected' : ''}>148B - B 335-600mm</option>
                <option value="300" ${current === '300' ? 'selected' : ''}>300 - Bâ‰¤300mm</option>
                <option value="300B" ${current === '300B' ? 'selected' : ''}>300B - B 335-600mm</option>
            </select>
        `;
    } else if (mat === 'Legno') {
        return `
            <select onchange="updateConfigCassonetti('${project.id}', 'codiceCass', this.value)"
                    class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona codice...</option>
                <option value="9-48" ${current === '9-48' ? 'selected' : ''}>9-48 - Bâ‰¤150mm (L max 2240)</option>
                <option value="9-48B" ${current === '9-48B' ? 'selected' : ''}>9-48B - Bâ‰¤600mm (L max 2240)</option>
            </select>
        `;
    }
    return '<p class="text-gray-400 text-sm py-2">â† Seleziona prima materiale</p>';
}

function renderSelectGruppoColoreCass(project) {
    const mat = project.configCassonetti?.materialeCass || '';
    const current = project.configCassonetti?.gruppoColoreCass || '';
    
    if (mat === 'PVC') {
        return `
            <select onchange="updateConfigCassonetti('${project.id}', 'gruppoColoreCass', this.value); render();"
                    class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona gruppo...</option>
                <option value="bianco" ${current === 'bianco' ? 'selected' : ''}>â—‹ TonalitÃ  Bianco (01,42,45,07,27)</option>
                <option value="scuri" ${current === 'scuri' ? 'selected' : ''}>â— Colori Scuri (06,46,13,19,55)</option>
            </select>
        `;
    } else if (mat === 'Legno') {
        return `
            <select onchange="updateConfigCassonetti('${project.id}', 'gruppoColoreCass', this.value); render();"
                    class="w-full px-3 py-2 border rounded-lg">
                <option value="">Seleziona gruppo...</option>
                <option value="legno1" ${current === 'legno1' ? 'selected' : ''}>Gruppo 1 - Abete</option>
                <option value="legno2+3" ${current === 'legno2+3' ? 'selected' : ''}>Gruppo 2+3 - Rovere (prezzo maggiore)</option>
            </select>
        `;
    }
    return '<p class="text-gray-400 text-sm py-2">â† Seleziona prima materiale</p>';
}

// ğŸ†• v5.54: Funzione per COLORE SPECIFICO cassonetto in CONFIG GLOBALE
function renderSelectColoreCassGlobal(project) {
    const gruppo = project.configCassonetti?.gruppoColoreCass || '';
    const mat = project.configCassonetti?.materialeCass || '';
    
    // LOGICA SEMPLICE: se sync ON â†’ legge da infisso, se OFF â†’ legge da coloreCass
    const syncAttivo = project.configCassonetti?.coloreDaInfisso !== false;
    const coloreInfisso = project.configInfissi?.coloreInt || '';
    const coloreCass = project.configCassonetti?.coloreCass || '';
    const displayValue = syncAttivo ? coloreInfisso : coloreCass;
    
    // Colori PVC da listino Finstral
    const coloriBianco = [
        { code: '01', name: '01 - Bianco extraliscio' },
        { code: '42', name: '42 - Bianco goffrato' },
        { code: '45', name: '45 - Bianco satinato' },
        { code: '07', name: '07 - Bianco perla goffrato' },
        { code: '27', name: '27 - Bianco perla satinato' }
    ];
    
    const coloriScuri = [
        { code: '06', name: '06 - Grigio' },
        { code: '46', name: '46 - Grigio seta' },
        { code: '13', name: '13 - Decoro legno castagno' },
        { code: '19', name: '19 - Decoro legno rovere' },
        { code: '55', name: '55 - Decoro legno noce chiaro' }
    ];
    
    // Colori Legno da listino
    const coloriLegno1 = [
        { code: '1X01', name: '1X01 - Abete naturale' },
        { code: '1X03', name: '1X03 - Abete sbiancato bianco' },
        { code: '1X05', name: '1X05 - Abete sbiancato' },
        { code: '1X06', name: '1X06 - Abete grigio beige' },
        { code: '1X07', name: '1X07 - Abete marrone' },
        { code: '1X08', name: '1X08 - Abete bianco perla' }
    ];
    
    const coloriLegno23 = [
        { code: '2X01', name: '2X01 - Rovere naturale' },
        { code: '2X02', name: '2X02 - Rovere oleato naturale' },
        { code: '3X02', name: '3X02 - Rovere grigio luce' },
        { code: '3X03', name: '3X03 - Rovere grigio sabbia' },
        { code: '3X04', name: '3X04 - Rovere grigio quarzo' },
        { code: '3X05', name: '3X05 - Rovere grigio carbone' },
        { code: '3X06', name: '3X06 - Rovere marrone scuro' },
        { code: '3X07', name: '3X07 - Rovere bianco a poro aperto' },
        { code: '3X08', name: '3X08 - Rovere bianco perla a poro aperto' }
    ];
    
    let colori = [];
    if (mat === 'PVC') {
        if (gruppo === 'bianco') colori = coloriBianco;
        else if (gruppo === 'scuri') colori = coloriScuri;
    } else if (mat === 'Legno') {
        if (gruppo === 'legno1') colori = coloriLegno1;
        else if (gruppo === 'legno2+3') colori = coloriLegno23;
    }
    
    if (colori.length === 0) {
        return '<p class="text-gray-400 text-sm py-2">â† Seleziona prima gruppo colore</p>';
    }
    
    // Se sync attivo, mostra valore ma disabilitato
    if (syncAttivo) {
        const coloreObj = colori.find(c => c.code === displayValue);
        const nomeColore = coloreObj ? coloreObj.name : (displayValue || 'Da serramento');
        return `
            <input type="text" 
                   value="${nomeColore}"
                   disabled
                   class="w-full px-3 py-2 border rounded-lg bg-blue-100 text-gray-600">
        `;
    }
    
    // Se sync disattivo, select editabile
    let options = '<option value="">Seleziona colore...</option>';
    colori.forEach(c => {
        const sel = displayValue === c.code ? 'selected' : '';
        options += `<option value="${c.code}" ${sel}>${c.name}</option>`;
    });
    
    return `
        <select onchange="updateConfigCassonetti('${project.id}', 'coloreCass', this.value)"
                class="w-full px-3 py-2 border rounded-lg">
            ${options}
        </select>
    `;
}

function renderSelectIsolamentoCass(project) {
    if (!project.configCassonetti?.isolamentoPosaclima) return '';
    const current = project.configCassonetti?.codiceIsolamento || '';
    
    return `
        <div>
            <label class="block text-sm font-medium mb-1">10. Codice Isolamento</label>
            <select onchange="updateConfigCassonetti('${project.id}', 'codiceIsolamento', this.value)"
                    class="w-full px-3 py-2 border rounded-lg bg-yellow-50">
                <option value="">Seleziona...</option>
                <option value="40830" ${current === '40830' ? 'selected' : ''}>40830 - 25mm (+63,1â‚¬/pz)</option>
                <option value="40831" ${current === '40831' ? 'selected' : ''}>40831 - 13mm (+47,4â‚¬/pz)</option>
            </select>
            <p class="text-xs text-yellow-600 mt-1">Usb: 0,87 W/mÂ²K con isolamento</p>
        </div>
    `;
}

// ğŸ†• v5.35: Funzioni helper per Cassonetto in POSIZIONE SINGOLA
function renderSelectCodiceCassPos(cas, projectId, posId) {
    const mat = cas.materialeCass || '';
    const current = cas.codiceCass || '';
    
    if (mat === 'PVC') {
        return `
            <select onchange="updateProduct('${projectId}', '${posId}', 'cassonetto', 'codiceCass', this.value)"
                    class="w-full compact-input border rounded mt-1">
                <option value="">--</option>
                <option value="148" ${current === '148' ? 'selected' : ''}>148</option>
                <option value="148B" ${current === '148B' ? 'selected' : ''}>148B</option>
                <option value="300" ${current === '300' ? 'selected' : ''}>300</option>
                <option value="300B" ${current === '300B' ? 'selected' : ''}>300B</option>
            </select>
        `;
    } else if (mat === 'Legno') {
        return `
            <select onchange="updateProduct('${projectId}', '${posId}', 'cassonetto', 'codiceCass', this.value)"
                    class="w-full compact-input border rounded mt-1">
                <option value="">--</option>
                <option value="9-48" ${current === '9-48' ? 'selected' : ''}>9-48</option>
                <option value="9-48B" ${current === '9-48B' ? 'selected' : ''}>9-48B</option>
            </select>
        `;
    }
    return '<span class="text-xs text-gray-400 mt-1 block">â† Materiale</span>';
}

function renderSelectGruppoColoreCassPos(cas, projectId, posId) {
    const mat = cas.materialeCass || '';
    const current = cas.gruppoColoreCass || '';
    
    if (mat === 'PVC') {
        return `
            <select onchange="updateProduct('${projectId}', '${posId}', 'cassonetto', 'gruppoColoreCass', this.value); render();"
                    class="w-full compact-input border rounded mt-1">
                <option value="">--</option>
                <option value="bianco" ${current === 'bianco' ? 'selected' : ''}>â—‹ Bianco</option>
                <option value="scuri" ${current === 'scuri' ? 'selected' : ''}>â— Scuri</option>
            </select>
        `;
    } else if (mat === 'Legno') {
        return `
            <select onchange="updateProduct('${projectId}', '${posId}', 'cassonetto', 'gruppoColoreCass', this.value); render();"
                    class="w-full compact-input border rounded mt-1">
                <option value="">--</option>
                <option value="legno1" ${current === 'legno1' ? 'selected' : ''}>Gr.1 Abete</option>
                <option value="legno2+3" ${current === 'legno2+3' ? 'selected' : ''}>Gr.2+3 Rovere</option>
            </select>
        `;
    }
    return '<span class="text-xs text-gray-400 mt-1 block">â† Materiale</span>';
}

// ğŸ†• v5.54: Funzione per selezionare COLORE SPECIFICO cassonetto (codice da listino)
function renderSelectColoreCassPos(cas, pos, projectId, posId) {
    const gruppo = cas.gruppoColoreCass || '';
    const mat = cas.materialeCass || '';
    
    // LOGICA SEMPLICE: se sync ON â†’ legge da infisso, se OFF â†’ legge da coloreCass
    const syncAttivo = cas.coloreDaInfisso !== false;
    const coloreInfisso = pos.infisso?.coloreInt || '';
    const coloreCass = cas.coloreCass || '';
    const displayValue = syncAttivo ? coloreInfisso : coloreCass;
    
    // Colori PVC da listino Finstral
    const coloriBianco = [
        { code: '01', name: '01 - Bianco extraliscio' },
        { code: '42', name: '42 - Bianco goffrato' },
        { code: '45', name: '45 - Bianco satinato' },
        { code: '07', name: '07 - Bianco perla goffrato' },
        { code: '27', name: '27 - Bianco perla satinato' }
    ];
    
    const coloriScuri = [
        { code: '06', name: '06 - Grigio' },
        { code: '46', name: '46 - Grigio seta' },
        { code: '13', name: '13 - Decoro legno castagno' },
        { code: '19', name: '19 - Decoro legno rovere' },
        { code: '55', name: '55 - Decoro legno noce chiaro' }
    ];
    
    // Colori Legno da listino
    const coloriLegno1 = [
        { code: '1X01', name: '1X01 - Abete naturale' },
        { code: '1X03', name: '1X03 - Abete sbiancato bianco' },
        { code: '1X05', name: '1X05 - Abete sbiancato' },
        { code: '1X06', name: '1X06 - Abete grigio beige' },
        { code: '1X07', name: '1X07 - Abete marrone' },
        { code: '1X08', name: '1X08 - Abete bianco perla' }
    ];
    
    const coloriLegno23 = [
        { code: '2X01', name: '2X01 - Rovere naturale' },
        { code: '2X02', name: '2X02 - Rovere oleato naturale' },
        { code: '3X02', name: '3X02 - Rovere grigio luce' },
        { code: '3X03', name: '3X03 - Rovere grigio sabbia' },
        { code: '3X04', name: '3X04 - Rovere grigio quarzo' },
        { code: '3X05', name: '3X05 - Rovere grigio carbone' },
        { code: '3X06', name: '3X06 - Rovere marrone scuro' },
        { code: '3X07', name: '3X07 - Rovere bianco a poro aperto' },
        { code: '3X08', name: '3X08 - Rovere bianco perla a poro aperto' }
    ];
    
    let colori = [];
    if (mat === 'PVC') {
        if (gruppo === 'bianco') colori = coloriBianco;
        else if (gruppo === 'scuri') colori = coloriScuri;
    } else if (mat === 'Legno') {
        if (gruppo === 'legno1') colori = coloriLegno1;
        else if (gruppo === 'legno2+3') colori = coloriLegno23;
    }
    
    if (colori.length === 0) {
        return '<span class="text-xs text-gray-400 mt-1 block">â† Gruppo Colore</span>';
    }
    
    // Se sync attivo, mostra valore ma disabilitato
    if (syncAttivo) {
        const coloreObj = colori.find(c => c.code === displayValue);
        const nomeColore = coloreObj ? coloreObj.name : (displayValue || 'Da serramento');
        return `
            <input type="text" 
                   value="${nomeColore}"
                   disabled
                   class="w-full compact-input border rounded mt-1 bg-blue-100 text-gray-600 text-xs">
        `;
    }
    
    // Se sync disattivo, select editabile
    let options = '<option value="">--</option>';
    colori.forEach(c => {
        const sel = displayValue === c.code ? 'selected' : '';
        options += `<option value="${c.code}" ${sel}>${c.name}</option>`;
    });
    
    return `
        <select onchange="updateProduct('${projectId}', '${posId}', 'cassonetto', 'coloreCass', this.value)"
                class="w-full compact-input border rounded mt-1">
            ${options}
        </select>
    `;
}

// ğŸ”„ FUNZIONE DINAMICA: Aggiorna dropdown colori quando cambia finitura - v4.39 (base v4.33)
window.aggiornaColoriPerFinitura = (finituraField, projectId, posId, productType) => {
    console.log(`ğŸ¨ Aggiorno colori per finitura: ${finituraField}`);
    
    // Trova valore finitura attuale
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    let finituraValue = '';
    let coloreField = '';
    
    // Determina quale finitura Ã¨ cambiata e quale colore aggiornare
    if (finituraField === 'finituraInt') {
        finituraValue = posId ? 
            project.positions.find(p => p.id === posId)?.infisso?.finituraInt :
            project.configInfissi?.finituraInt || 'pvc';
        coloreField = 'coloreInt';
    } else if (finituraField === 'finituraEst') {
        finituraValue = posId ? 
            project.positions.find(p => p.id === posId)?.infisso?.finituraEst :
            project.configInfissi?.finituraEst || 'pvc';
        coloreField = 'coloreEst';
    }
    
    console.log(`   Finitura: ${finituraValue}, Campo colore: ${coloreField}`);
    
    // ğŸ†• v5.68: Array colori aggiornati
    const coloriPVC = [
        '01 - Bianco', '45 - Bianco', '27 - Bianco crema', '42 - Bianco', 
        '07 - Bianco crema', '36 - Grigio topo', '46 - Grigio seta', '06 - Grigio (âš ï¸ scade 32/2026)',
        '13 - Castagno decoro legno', '19 - Rovere decoro legno', '55 - Noce chiaro decoro legno'
    ];
    
    const coloriAlluminio = [
        'L13 - Castagno verniciato', 'L14 - Mogano verniciato', 'L16 - Douglas verniciato',
        'L18 - Noce verniciato', 'L19 - Rovere verniciato', 'L55 - Noce chiaro verniciato',
        'LX01 - Rovere naturale', 'LX02 - Ciliegio scuro', 'LX03 - Pino verniciato', 'LX04 - Rovere venato'
    ];
    
    // ğŸ†• v5.68: Colori LEGNO
    const coloriLegno = [
        'G0 - Rovere naturale', 'G0 - Faggio naturale', 'G0 - Acero naturale',
        'G1 - Rovere tinto', 'G1 - Noce', 'G1 - Ciliegio',
        'G2 - WengÃ©', 'G2 - Mogano', 'G2 - Teak',
        'G3 - Essenze speciali', 'G3 - RAL su legno'
    ];
    
    // Scelta opzioni - FIX v4.39: Logica uniformata a renderSelectColoreStandard
    // Normalizza valore finitura
    const finituraNormalized = (finituraValue || '').toString().trim().toLowerCase();
    
    let opzioni = [];
    // ğŸ†• v5.68: PrioritÃ  LEGNO prima
    if (finituraNormalized.includes('legno') || finituraNormalized === 'legno') {
        opzioni = coloriLegno;
        console.log(`   âœ… Finitura LEGNO â†’ ${coloriLegno.length} colori legno`);
    }
    // Se contiene "alluminio" â†’ usa colori alluminio
    else if (finituraNormalized.includes('alluminio') || finituraNormalized.includes('aluminio') || finituraNormalized === 'alu') {
        opzioni = coloriAlluminio;
        console.log(`   âœ… Finitura contiene "alluminio" â†’ ${coloriAlluminio.length} colori alluminio`);
    } 
    // Altrimenti: usa colori PVC (default sicuro)
    else {
        opzioni = coloriPVC;
        console.log(`   âœ… Finitura PVC o vuota â†’ ${coloriPVC.length} colori PVC`);
    }
    
    // Trova select colore da aggiornare
    const selectId = `${coloreField}_select_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
    const selectElement = document.getElementById(selectId);
    
    if (!selectElement) {
        console.warn(`âš ï¸ Select non trovato: ${selectId}`);
        return;
    }
    
    // Salva valore corrente (se compatibile con nuove opzioni)
    const currentValue = selectElement.value;
    const keepValue = opzioni.includes(currentValue);
    
    // Rigenera opzioni
    selectElement.innerHTML = `
        <option value="" class="text-gray-400">â–¼ Seleziona...</option>
        ${opzioni.map(opt => `
            <option value="${opt}" ${keepValue && currentValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                ${opt}
            </option>
        `).join('')}
        <option value="__custom__" class="text-blue-600 font-semibold">ğŸ–Šï¸ Scrivi manualmente</option>
    `;
    
    // Se valore non compatibile, resetta
    if (!keepValue && currentValue) {
        console.log(`   âš ï¸ Colore "${currentValue}" non valido per ${finituraValue}, resettato`);
        selectElement.value = '';
        // Salva anche il reset
        if (posId) {
            updateProduct(projectId, posId, productType, coloreField, '');
        } else {
            if (productType === 'infisso') updateConfigInfissi(projectId, coloreField, '');
        }
    }
    
    console.log(`   âœ… Colori aggiornati: ${opzioni.length} opzioni (${finituraValue})`);
};

// ğŸ”„ EVENT LISTENER GLOBALE: Intercetta cambiamenti finitura e aggiorna colori - v4.39 (base v4.33)
document.addEventListener('change', (event) => {
    const target = event.target;
    
    // Intercetta SOLO select (non input custom)
    if (target.tagName !== 'SELECT') return;
    
    // Ottieni onChange value per identificare campo
    const onchangeAttr = target.getAttribute('onchange');
    if (!onchangeAttr) return;
    
    // Verifica se Ã¨ un campo finitura (finituraInt o finituraEst)
    if (!onchangeAttr.includes('finituraInt') && !onchangeAttr.includes('finituraEst')) return;
    
    console.log('ğŸ”„ Rilevato cambio finitura, aggiorno colori...');
    
    // Estrai parametri dall'attributo onchange
    // Formato: updateConfigInfissi('proj-xxx', 'finituraInt', this.value) o updateProduct(...)
    const isConfig = onchangeAttr.includes('updateConfigInfissi');
    const isPosition = onchangeAttr.includes('updateProduct');
    
    // Estrai projectId
    const projectIdMatch = onchangeAttr.match(/'([^']+)'/);
    const projectId = projectIdMatch ? projectIdMatch[1] : null;
    
    // Estrai field name
    const fieldMatch = isConfig ? 
        onchangeAttr.match(/updateConfigInfissi\('[^']*',\s*'([^']*)'/) :
        onchangeAttr.match(/updateProduct\('[^']*',\s*'[^']*',\s*'[^']*',\s*'([^']*)'/);
    const fieldName = fieldMatch ? fieldMatch[1] : null;
    
    // Estrai posId (solo per posizioni)
    const posIdMatch = isPosition ? onchangeAttr.match(/updateProduct\('[^']*',\s*'([^']*)'/): null;
    const posId = posIdMatch ? posIdMatch[1] : null;
    
    // Estrai productType
    const productTypeMatch = onchangeAttr.match(/'(infisso|persiana|tapparella|zanzariera|cassonetto)'/);
    const productType = productTypeMatch ? productTypeMatch[1] : 'infisso';
    
    if (projectId && fieldName) {
        // Attendi 100ms per permettere al valore di aggiornarsi
        setTimeout(() => {
            aggiornaColoriPerFinitura(fieldName, projectId, posId, productType);
        }, 100);
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ SOLUZIONE C: SISTEMA ANTI-DUPLICATI ENTERPRISE (Chat 010)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 1: DEVICE IDENTIFICATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getDeviceId() {
    // Ottiene o crea ID univoco dispositivo
    let deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
        deviceId = 'device_' + generateId();
        localStorage.setItem('deviceId', deviceId);
    }
    return deviceId;
}

function getDeviceName() {
    // Ottiene o rileva nome dispositivo
    let deviceName = localStorage.getItem('deviceName');
    if (!deviceName) {
        deviceName = detectDeviceName();
        // Permetti modifica nome
        const customName = localStorage.getItem('customDeviceName');
        if (customName) deviceName = customName;
        localStorage.setItem('deviceName', deviceName);
    }
    return deviceName;
}

function detectDeviceName() {
    // Rileva tipo dispositivo automaticamente
    const ua = navigator.userAgent;
    
    if (/iPad/i.test(ua)) return 'Tablet iPad';
    if (/iPhone/i.test(ua)) return 'Smartphone iPhone';
    if (/Android/i.test(ua)) {
        if (/Mobile/i.test(ua)) return 'Smartphone Android';
        return 'Tablet Android';
    }
    if (/Windows/i.test(ua)) return 'PC Windows';
    if (/Mac/i.test(ua)) return 'PC Mac';
    if (/Linux/i.test(ua)) return 'PC Linux';
    
    return 'Dispositivo Sconosciuto';
}

function setCustomDeviceName(name) {
    // Permette utente di personalizzare nome dispositivo
    localStorage.setItem('customDeviceName', name);
    localStorage.setItem('deviceName', name);
    showNotification(`âœ… Nome dispositivo impostato: ${name}`, 'success');
}


// ğŸ†• v5.44: Funzione per renderizzare componenti da fornire (semplificata)
function renderComponentiDaFornire(projectId, posId, tap) {
    const accessori = tap.accessoriDaSostituire || {};
    
    // Verifica se tutti sono selezionati
    const tuttiSelezionati = ACCESSORI_TAPPARELLA.every(acc => accessori[acc.id] === true);
    
    return `
        <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
            <label class="block text-sm font-bold mb-3 text-green-800">ğŸ”§ Componenti da fornire</label>
            
            <!-- Toggle TUTTI -->
            <div class="mb-3">
                <label class="flex items-center gap-3 px-4 py-2 rounded-lg cursor-pointer ${tuttiSelezionati ? 'bg-green-200 border-2 border-green-500' : 'bg-white border-2 border-gray-300'} hover:border-green-400 transition-all">
                    <input type="checkbox" 
                           ${tuttiSelezionati ? 'checked' : ''}
                           onchange="toggleTuttiComponenti('${projectId}', '${posId}', this.checked)"
                           class="w-5 h-5 accent-green-600">
                    <span class="font-semibold text-green-800">âœ… Tutti i componenti</span>
                </label>
            </div>
            
            <!-- Checkbox singoli -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                ${ACCESSORI_TAPPARELLA.map(acc => {
                    const isChecked = accessori[acc.id] === true;
                    return `
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded ${isChecked ? 'bg-green-100 border-green-400' : 'bg-white border-gray-300'} border cursor-pointer hover:bg-green-50 transition-colors">
                            <input type="checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="updateComponente('${projectId}', '${posId}', '${acc.id}', this.checked)"
                                   class="w-4 h-4 accent-green-600">
                            <span class="text-xs">${acc.icon} ${acc.label}</span>
                        </label>
                    `;
                }).join('')}
            </div>
            
            <!-- Campi Guide (visibili solo se guide selezionate) -->
            ${accessori.guide ? `
                <div class="grid grid-cols-2 gap-2 p-3 bg-blue-50 rounded-lg border border-blue-200 mt-3">
                    <div>
                        <label class="text-xs font-medium text-blue-700 block mb-1">ğŸ›¤ï¸ Modello Guida</label>
                        <input type="text" value="${tap.guida || ''}"
                               placeholder="Seleziona guida"
                               list="guida-tap-list-${posId}"
                               onchange="updateProduct('${projectId}', '${posId}', 'tapparella', 'guida', this.value)"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                        <datalist id="guida-tap-list-${posId}">
                            ${GUIDE_PLASTICINO.map(g => `<option value="${g}">`).join('\\n')}
                        </datalist>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-blue-700 block mb-1">ğŸ¨ Colore Guida</label>
                        <input type="text" value="${tap.coloreGuida || ''}"
                               placeholder="Seleziona colore"
                               list="colore-guida-list-${posId}"
                               onchange="updateProduct('${projectId}', '${posId}', 'tapparella', 'coloreGuida', this.value)"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                        <datalist id="colore-guida-list-${posId}">
                            ${getColoriGuide().map(c => `<option value="${c}">`).join('\\n')}
                        </datalist>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// ğŸ†• v5.44: Toggle tutti i componenti
window.toggleTuttiComponenti = (projectId, posId, checked) => {
    const allAccessori = {};
    ACCESSORI_TAPPARELLA.forEach(a => allAccessori[a.id] = checked);
    updateProduct(projectId, posId, 'tapparella', 'accessoriDaSostituire', allAccessori);
    render();
};

// ğŸ†• v5.44: Aggiorna singolo componente
window.updateComponente = (projectId, posId, accessorioId, checked) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.tapparella) return;
    
    const accessori = {...(pos.tapparella.accessoriDaSostituire || {})};
    accessori[accessorioId] = checked;
    updateProduct(projectId, posId, 'tapparella', 'accessoriDaSostituire', accessori);
    render();
};

// LEGACY: Manteniamo le vecchie funzioni per compatibilitÃ 
function renderSostituzioneComponenti(projectId, posId, tap) {
    return renderComponentiDaFornire(projectId, posId, tap);
}

// Funzioni di aggiornamento LEGACY
function updateSostTipo(projectId, posId, tipo) {
    // Legacy - non piÃ¹ usata ma mantenuta per compatibilitÃ 
    render();
}

function updateAccessorio(projectId, posId, accessorioId, checked) {
    updateComponente(projectId, posId, accessorioId, checked);
    render();
}

// ğŸ”© Funzione per Accessori Persiana (Cardini + Fermapersiane)
function renderAccessoriPersiana(projectId, posId, per) {
    const tipologia = per.tipo || 'F2';
    const aperturaLibro = (per.apertura || '').includes('LIB') || (per.apertura || '').includes('/A');
    
    // Calcola quantitÃ  suggerite
    const cardiniSuggeriti = calcolaCardiniPersiana(tipologia, aperturaLibro);
    const fermaperSuggeriti = calcolaFermapersiane(tipologia);
    
    // ğŸ†• AUTO-INIZIALIZZA se non esiste
    if (!per.accessoriPersiana) {
        per.accessoriPersiana = {
            cardini: { qta: cardiniSuggeriti, modello: 'C.SAF90' },
            fermapersiane: { qta: fermaperSuggeriti, modello: 'K.EASY' }
        };
        // Salva subito nel JSON
        saveState();
        console.log(`ğŸ”© Auto-init accessoriPersiana per ${tipologia}: cardini=${cardiniSuggeriti}, ferma=${fermaperSuggeriti}`);
    }
    
    // Valori attuali
    const accessori = per.accessoriPersiana;
    const cardini = accessori.cardini || { qta: cardiniSuggeriti, modello: 'C.SAF90' };
    const ferma = accessori.fermapersiane || { qta: fermaperSuggeriti, modello: 'K.EASY' };
    
    return `
        <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-3">
            <h5 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                ğŸ”© Accessori Persiana
                <span class="text-xs font-normal text-gray-500">(ESCLUSI dal prezzo base)</span>
            </h5>
            
            <!-- CARDINI -->
            <div class="bg-white p-3 rounded-lg border mb-3">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm font-bold text-gray-700">ğŸ“ Cardini</span>
                    <span class="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded">
                        ${tipologia} ${aperturaLibro ? '(Libro)' : ''} â†’ suggeriti: ${cardiniSuggeriti}
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-xs text-gray-600">QuantitÃ </label>
                        <input type="number" min="0" max="20" value="${cardini.qta}"
                               onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'cardini', 'qta', parseInt(this.value))"
                               class="w-full compact-input border rounded text-center">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-gray-600">Modello</label>
                        <select onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'cardini', 'modello', this.value)"
                                class="w-full compact-input border rounded">
                            ${CARDINI_PUNTO_PERSIANE.map(c => 
                                `<option value="${c.codice}" ${cardini.modello === c.codice ? 'selected' : ''}>
                                    ${c.codice} - ${c.nome} ${c.prezzo > 0 ? 'â‚¬' + c.prezzo : ''}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- FERMAPERSIANE -->
            <div class="bg-white p-3 rounded-lg border">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-sm font-bold text-gray-700">ğŸ”’ Fermapersiane</span>
                    <span class="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded">
                        ${tipologia.replace('PF','').replace('F','')} ante â†’ suggeriti: ${fermaperSuggeriti}
                    </span>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="text-xs text-gray-600">QuantitÃ </label>
                        <input type="number" min="0" max="10" value="${ferma.qta}"
                               onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'fermapersiane', 'qta', parseInt(this.value))"
                               class="w-full compact-input border rounded text-center">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-gray-600">Modello</label>
                        <select onchange="updateAccessoriPersiana('${projectId}', '${posId}', 'fermapersiane', 'modello', this.value)"
                                class="w-full compact-input border rounded">
                            ${FERMAPERSIANE_PUNTO_PERSIANE.map(f => 
                                `<option value="${f.codice}" ${ferma.modello === f.codice ? 'selected' : ''}>
                                    ${f.codice} - ${f.nome} ${f.prezzo > 0 ? 'â‚¬' + f.prezzo : ''}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Funzione aggiornamento accessori persiana
function updateAccessoriPersiana(projectId, posId, tipo, campo, valore) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.persiana) return;
    
    // Inizializza se non esiste
    if (!pos.persiana.accessoriPersiana) {
        pos.persiana.accessoriPersiana = {
            cardini: { qta: 0, modello: 'C.SAF90' },
            fermapersiane: { qta: 0, modello: 'K.EASY' }
        };
    }
    
    // Aggiorna il campo specifico
    if (!pos.persiana.accessoriPersiana[tipo]) {
        pos.persiana.accessoriPersiana[tipo] = {};
    }
    pos.persiana.accessoriPersiana[tipo][campo] = valore;
    
    saveState();
    render();
}

// ğŸ†• Funzione per aggiornare tipo persiana e ricalcolare accessori
function updateTipoPersiana(projectId, posId, nuovoTipo) {
    console.log(`ğŸ”§ updateTipoPersiana CHIAMATA: projectId=${projectId}, posId=${posId}, nuovoTipo=${nuovoTipo}`);
    
    const project = state.projects.find(p => p.id === projectId);
    if (!project) {
        console.error('âŒ Progetto non trovato:', projectId);
        return;
    }
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) {
        console.error('âŒ Posizione non trovata:', posId);
        return;
    }
    
    // ğŸ†• v4.95 FIX: Inizializza persiana se non esiste
    if (!pos.persiana) {
        console.log('ğŸ†• Inizializzo pos.persiana');
        pos.persiana = { qta: 1 };
    }
    
    // Aggiorna tipo
    pos.persiana.tipo = nuovoTipo;
    console.log(`âœ… pos.persiana.tipo SALVATO: ${pos.persiana.tipo}`);
    
    // Ricalcola accessori suggeriti
    const aperturaLibro = (pos.persiana.apertura || '').includes('LIB') || (pos.persiana.apertura || '').includes('/A');
    const cardiniSuggeriti = calcolaCardiniPersiana(nuovoTipo, aperturaLibro);
    const fermaperSuggeriti = calcolaFermapersiane(nuovoTipo);
    
    // Aggiorna quantitÃ  (mantiene modello)
    if (!pos.persiana.accessoriPersiana) {
        pos.persiana.accessoriPersiana = {
            cardini: { qta: cardiniSuggeriti, modello: 'C.SAF90' },
            fermapersiane: { qta: fermaperSuggeriti, modello: 'K.EASY' }
        };
    } else {
        pos.persiana.accessoriPersiana.cardini.qta = cardiniSuggeriti;
        pos.persiana.accessoriPersiana.fermapersiane.qta = fermaperSuggeriti;
    }
    
    console.log(`ğŸ”„ Tipo ${nuovoTipo}: cardini=${cardiniSuggeriti}, ferma=${fermaperSuggeriti}`);
    saveState();
    
    // Verifica dopo saveState
    const verifica = state.projects.find(p => p.id === projectId)?.posizioni.find(p => p.id === posId);
    console.log(`ğŸ” VERIFICA dopo save: pos.persiana.tipo = ${verifica?.persiana?.tipo}`);
    
    render();
}

// Funzione per Config Globale Sostituzione Componenti
// ğŸ†• v5.44: Funzione per renderizzare componenti da fornire nel GENERALE
function renderComponentiDaFornireConfig(projectId, configTapparelle) {
    const accessori = configTapparelle?.accessoriDaSostituire || {};
    
    // Verifica se tutti sono selezionati
    const tuttiSelezionati = ACCESSORI_TAPPARELLA.every(acc => accessori[acc.id] === true);
    
    return `
        <div class="col-span-2 mt-2 p-3 bg-green-50 rounded-lg border border-green-200">
            <label class="block text-sm font-bold mb-3 text-green-800">ğŸ”§ Componenti da fornire (Default)</label>
            
            <!-- Toggle TUTTI -->
            <div class="mb-3">
                <label class="flex items-center gap-3 px-4 py-2 rounded-lg cursor-pointer ${tuttiSelezionati ? 'bg-green-200 border-2 border-green-500' : 'bg-white border-2 border-gray-300'} hover:border-green-400 transition-all">
                    <input type="checkbox" 
                           ${tuttiSelezionati ? 'checked' : ''}
                           onchange="toggleTuttiComponentiConfig('${projectId}', this.checked)"
                           class="w-5 h-5 accent-green-600">
                    <span class="font-semibold text-green-800">âœ… Tutti i componenti</span>
                </label>
            </div>
            
            <!-- Checkbox singoli -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-3">
                ${ACCESSORI_TAPPARELLA.map(acc => {
                    const isChecked = accessori[acc.id] === true;
                    return `
                        <label class="flex items-center gap-2 px-2 py-1.5 rounded ${isChecked ? 'bg-green-100 border-green-400' : 'bg-white border-gray-300'} border cursor-pointer hover:bg-green-50 transition-colors">
                            <input type="checkbox" 
                                   ${isChecked ? 'checked' : ''} 
                                   onchange="updateComponenteConfig('${projectId}', '${acc.id}', this.checked)"
                                   class="w-4 h-4 accent-green-600">
                            <span class="text-xs">${acc.icon} ${acc.label}</span>
                        </label>
                    `;
                }).join('')}
            </div>
            
            <!-- Campi Guide (visibili solo se guide selezionate) -->
            ${accessori.guide ? `
                <div class="grid grid-cols-2 gap-2 p-3 bg-blue-50 rounded-lg border border-blue-200 mt-3">
                    <div>
                        <label class="text-xs font-medium text-blue-700 block mb-1">ğŸ›¤ï¸ Modello Guida</label>
                        <input type="text" 
                               value="${configTapparelle?.guida || ''}"
                               placeholder="Seleziona guida"
                               list="config-guida-tap-list-${projectId}"
                               onchange="updateConfigTapparelle('${projectId}', 'guida', this.value)"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                        <datalist id="config-guida-tap-list-${projectId}">
                            ${GUIDE_PLASTICINO.map(g => `<option value="${g}">`).join('\\n')}
                        </datalist>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-blue-700 block mb-1">ğŸ¨ Colore Guida</label>
                        <input type="text" 
                               value="${configTapparelle?.coloreGuida || ''}"
                               placeholder="Seleziona colore"
                               list="config-colore-guida-list-${projectId}"
                               onchange="updateConfigTapparelle('${projectId}', 'coloreGuida', this.value)"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                        <datalist id="config-colore-guida-list-${projectId}">
                            ${getColoriGuide().map(c => `<option value="${c}">`).join('\\n')}
                        </datalist>
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}

// ğŸ†• v5.44: Toggle tutti i componenti nel GENERALE
window.toggleTuttiComponentiConfig = (projectId, checked) => {
    const allAccessori = {};
    ACCESSORI_TAPPARELLA.forEach(a => allAccessori[a.id] = checked);
    updateConfigTapparelle(projectId, 'accessoriDaSostituire', allAccessori);
    render();
};

// ğŸ†• v5.44: Aggiorna singolo componente nel GENERALE
window.updateComponenteConfig = (projectId, accessorioId, checked) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const accessori = {...(project.configTapparelle?.accessoriDaSostituire || {})};
    accessori[accessorioId] = checked;
    updateConfigTapparelle(projectId, 'accessoriDaSostituire', accessori);
    render();
};

// LEGACY: Manteniamo le vecchie funzioni per compatibilitÃ 
function renderSostituzioneComponentiConfig(projectId, configTapparelle) {
    return renderComponentiDaFornireConfig(projectId, configTapparelle);
}

// Funzioni di aggiornamento Config LEGACY
function updateSostTipoConfig(projectId, tipo) {
    // Legacy - non piÃ¹ usata
    render();
}

function updateAccessorioConfig(projectId, accessorioId, checked) {
    updateComponenteConfig(projectId, accessorioId, checked);
}

// Mappa modello â†’ categoria colori
const MODELLO_TO_COLORI_MAP = {
    // Alluminio Coibentato Media DensitÃ 
    'TA01': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    'TA05': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    'TA42': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    'TA07': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    // Alluminio Coibentato Alta DensitÃ 
    'TA25': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    'TA30': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    // Acciaio Coibentato
    'TA15': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    'TA20': ['ALLUMINIO_UNITA', 'ALLUMINIO_LEGNO', 'ALLUMINIO_RAFFAELLO'],
    // PVC
    'A01': ['PVC'],
    'A10': ['PVC'],
    'A16': ['PVC'],
    'A15': ['PVC'],
    // Alluminio Estruso
    'TA10': ['ALLUMINIO_UNITA'],
    'TA13': ['ALLUMINIO_UNITA'],
    // Combi (Alluminio/PVC)
    'A18': ['ALLUMINIO_UNITA', 'PVC'],
    'A20': ['ALLUMINIO_UNITA', 'PVC'],
    // Orientabili / Estella
    'A40': ['ALLUMINIO_UNITA'],
    'A50': ['ALLUMINIO_UNITA']
};

// Funzione per ottenere colori disponibili per un modello
function getColoriTapparella(modello) {
    if (!modello) return COLORI_TAPPARELLE_PLASTICINO['PVC']; // Default PVC
    
    // Estrai codice modello (es. "TA01" da "TA01 - Tipo ALUPROFIL MD 13x55")
    const codiceMatch = modello.match(/^([A-Z0-9]+)/);
    const codice = codiceMatch ? codiceMatch[1] : '';
    
    // Trova categorie per questo modello
    const categorie = MODELLO_TO_COLORI_MAP[codice] || ['PVC'];
    
    // Unisci tutti i colori delle categorie
    let colori = [];
    categorie.forEach(cat => {
        if (COLORI_TAPPARELLE_PLASTICINO[cat]) {
            colori = colori.concat(COLORI_TAPPARELLE_PLASTICINO[cat]);
        }
    });
    
    // Rimuovi duplicati
    return [...new Set(colori)];
}

// Funzione per aggiornare datalist colori tapparella (POSIZIONI)
function updateColoriTapparellaDatalist(posId, modello) {
    const datalistId = `colore-tap-list-${posId}`;
    const datalist = document.getElementById(datalistId);
    
    if (!datalist) {
        console.warn(`âš ï¸ Datalist non trovato: ${datalistId}`);
        return;
    }
    
    const colori = getColoriTapparella(modello);
    
    // Aggiorna opzioni
    datalist.innerHTML = colori.map(c => `<option value="${c}">`).join('\n');
    console.log(`ğŸ¨ Colori tapparella aggiornati per ${modello}: ${colori.length} opzioni`);
}

// Funzione per aggiornare datalist colori tapparella (CONFIG GLOBALE)
function updateColoriTapparellaDatalistConfig(projectId, modello) {
    const datalistId = `config-colore-tap-list-${projectId}`;
    const datalist = document.getElementById(datalistId);
    
    if (!datalist) {
        console.warn(`âš ï¸ Datalist config non trovato: ${datalistId}`);
        return;
    }
    
    const colori = getColoriTapparella(modello);
    
    // Aggiorna opzioni
    datalist.innerHTML = colori.map(c => `<option value="${c}">`).join('\n');
    console.log(`ğŸ¨ Colori tapparella CONFIG aggiornati per ${modello}: ${colori.length} opzioni`);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 2: METADATA & VERSIONING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initMetadata() {
    // ğŸ†• v4.61: Metadata versioning COMPLETO con log dettagliato
    const now = new Date().toISOString();
    return {
        version: 1,  // ğŸ”¢ Numero versione incrementale (1, 2, 3, 4...)
        created: now,
        updated: now,
        device: {
            id: getDeviceId(),
            name: getDeviceName()
        },
        syncStatus: "local",  // local | synced | conflict
        changes: [{
            version: 1,
            timestamp: now,
            action: "created",
            details: "Progetto creato",
            device: {
                id: getDeviceId(),
                name: getDeviceName()
            }
        }]
    };
}

function updateProjectTimestamp(projectId, action, details, changedFields = {}) {
    // ğŸ†• v4.61: Auto-aggiorna versione e logga modifiche DETTAGLIATE
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    // Inizializza metadata se non esiste (backward compatibility)
    if (!project.metadata) {
        project.metadata = initMetadata();
        project.metadata.created = project.createdDate || project.created || new Date().toISOString();
    }
    
    // ğŸ”§ Migra da formato vecchio a nuovo se necessario
    if (typeof project.metadata.version === 'string') {
        // Converti "1.0" â†’ 1, "2.5" â†’ 3, etc
        project.metadata.version = parseInt(project.metadata.version.split('.')[0]) || 1;
    }
    if (project.metadata.history && !project.metadata.changes) {
        // Migra history â†’ changes
        project.metadata.changes = project.metadata.history || [];
        delete project.metadata.history;
    }
    if (project.metadata.createdAt && !project.metadata.created) {
        project.metadata.created = project.metadata.createdAt;
        delete project.metadata.createdAt;
    }
    if (project.metadata.lastModified && !project.metadata.updated) {
        project.metadata.updated = project.metadata.lastModified;
        delete project.metadata.lastModified;
    }
    
    // Incrementa versione
    project.metadata.version = (project.metadata.version || 0) + 1;
    
    // Aggiorna timestamp
    const now = new Date().toISOString();
    project.metadata.updated = now;
    
    // Aggiorna status
    project.metadata.syncStatus = "local";
    
    // Aggiorna device info
    project.metadata.device = {
        id: getDeviceId(),
        name: getDeviceName()
    };
    
    // Prepara entry log modifiche
    const changeEntry = {
        version: project.metadata.version,
        timestamp: now,
        action: action,
        details: details,
        device: {
            id: getDeviceId(),
            name: getDeviceName()
        }
    };
    
    // Aggiungi campi modificati se forniti
    if (Object.keys(changedFields).length > 0) {
        changeEntry.fields = changedFields;
    }
    
    // Aggiungi a changes array
    if (!project.metadata.changes) {
        project.metadata.changes = [];
    }
    project.metadata.changes.push(changeEntry);
    
    // Limita changes a ultimi 100 entries
    if (project.metadata.changes.length > 100) {
        project.metadata.changes = project.metadata.changes.slice(-100);
    }
    
    console.log(`ğŸ“ Progetto ${projectId} aggiornato: v${project.metadata.version} - ${action}`);
    
    saveState();
}

function migrateOldProjectsMetadata() {
    // Migra progetti vecchi senza metadata
    let migrated = 0;
    
    state.projects.forEach(project => {
        if (!project.metadata) {
            project.metadata = initMetadata();
            // Usa date esistenti se disponibili
            if (project.createdDate) {
                project.metadata.createdAt = project.createdDate;
            }
            migrated++;
        }
    });
    
    if (migrated > 0) {
        saveState();
        console.log(`âœ… Migrati ${migrated} progetti con metadata`);
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 3: IMPORT JSON
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function importProjectsJSON() {
    // Crea input file nascosto
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showNotification('ğŸ“¥ Lettura file in corso...', 'info');
        
        try {
            // ğŸ†• v5.78: Usa JSON_MANAGER se disponibile
            if (typeof JSON_MANAGER !== 'undefined') {
                const project = await JSON_MANAGER.uploadJSON(file, { source: 'app-rilievo-import' });
                
                // Valida con JSON_MANAGER
                const validation = JSON_MANAGER.validateJSON(project);
                if (validation.warnings.length > 0) {
                    console.warn('âš ï¸ Import warnings:', validation.warnings);
                }
                
                // Processa import
                await processImport(project);
            } else {
                // Fallback legacy
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!validateImportJSON(data)) {
                    showNotification('âŒ File JSON non valido', 'error');
                    return;
                }
                
                await processImport(data);
            }
            
        } catch (error) {
            console.error('Errore import:', error);
            showNotification('âŒ Errore durante import: ' + error.message, 'error');
        }
    };
    
    input.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ†• v5.70: IMPORTA POSIZIONI JSON nel progetto corrente
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importPosizioniJSON() {
    // Verifica progetto corrente
    if (!state.currentProject) {
        showNotification('âŒ Nessun progetto aperto!', 'error');
        return;
    }
    
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) {
        showNotification('âŒ Progetto non trovato!', 'error');
        return;
    }
    
    // Crea input file
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        showNotification('ğŸ“¥ Lettura posizioni...', 'info');
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Estrai posizioni dal JSON (supporta vari formati)
            let posizioni = [];
            
            if (Array.isArray(data)) {
                // Formato: array diretto di posizioni
                posizioni = data;
            } else if (Array.isArray(data.positions)) {
                // Formato: { positions: [...] }
                posizioni = data.positions;
            } else if (Array.isArray(data.posizioni)) {
                // Formato: { posizioni: [...] }
                posizioni = data.posizioni;
            } else if (data.project && Array.isArray(data.project.rilievoInfissi)) {
                // Formato GitHub: { project: { rilievoInfissi: [...] } }
                posizioni = data.project.rilievoInfissi;
            } else {
                showNotification('âŒ Formato JSON non riconosciuto. Usa array di posizioni o {positions: [...]}', 'error');
                return;
            }
            
            if (posizioni.length === 0) {
                showNotification('âš ï¸ Nessuna posizione trovata nel file', 'warning');
                return;
            }
            
            // Inizializza positions se non esiste
            if (!project.positions) project.positions = [];
            
            // Genera nuovi ID per evitare conflitti
            const numPrima = project.positions.length;
            const timestamp = Date.now();
            
            posizioni.forEach((pos, idx) => {
                // Genera nuovo ID univoco
                const newId = `imp-${timestamp}-${idx}`;
                
                // Crea posizione con struttura corretta
                const newPosition = {
                    id: newId,
                    name: pos.name || pos.nome || `Pos. ${numPrima + idx + 1}`,
                    piano: pos.piano || 'Piano Terra',
                    ambiente: pos.ambiente || pos.stanza || '',
                    // ğŸ†• v5.82: RIMOSSO quantita - usa solo prodotto.qta
                    misure: pos.misure || {},
                    
                    // Copia prodotti se presenti
                    infisso: pos.infisso ? normalizzaInfisso(pos.infisso, project) : null,
                    persiana: pos.persiana ? normalizzaPersiana(pos.persiana, project) : null,
                    tapparella: pos.tapparella ? normalizzaTapparella(pos.tapparella, project) : null,
                    zanzariera: pos.zanzariera ? normalizzaZanzariera(pos.zanzariera, project) : null,
                    cassonetto: pos.cassonetto ? normalizzaCassonetto(pos.cassonetto, project) : null,
                    blindata: pos.blindata || null,
                    portoncino: pos.portoncino || null,
                    portaInterna: pos.portaInterna || null,
                    clickZip: pos.clickZip || null,
                    tendaBracci: pos.tendaBracci || null,
                    grata: pos.grata ? (typeof GRATE_MODULE !== 'undefined' ? GRATE_MODULE.normalizza(pos.grata, project) : pos.grata) : null  // ğŸ”’ v5.85
                };
                
                project.positions.push(newPosition);
                
                // ğŸ†• v5.707: Attiva automaticamente i flag prodotti
                if (!project.prodotti) project.prodotti = {};
                if (newPosition.infisso) project.prodotti.infissi = true;
                if (newPosition.persiana) project.prodotti.persiane = true;
                if (newPosition.tapparella) project.prodotti.tapparelle = true;
                if (newPosition.zanzariera) project.prodotti.zanzariere = true;
                if (newPosition.cassonetto) project.prodotti.cassonetti = true;
                if (newPosition.blindata) project.prodotti.blindate = true;
                if (newPosition.portoncino) project.prodotti.portoncini = true;
                if (newPosition.portaInterna) project.prodotti.porteInterne = true;
                if (newPosition.clickZip) project.prodotti.clickZip = true;
                if (newPosition.tendaBracci) project.prodotti.tendeBracci = true;
                if (newPosition.grata) project.prodotti.grate = true;  // ğŸ”’ v5.85
            });
            
            // Salva e aggiorna
            saveState();
            render();
            
            const numDopo = project.positions.length;
            showNotification(`âœ… Importate ${posizioni.length} posizioni! (${numPrima} â†’ ${numDopo})`, 'success', 5000);
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log(`ğŸ“¥ IMPORTATE ${posizioni.length} POSIZIONI`);
            console.log(`   Progetto: ${project.name || project.client}`);
            console.log(`   Prima: ${numPrima} | Dopo: ${numDopo}`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
        } catch (error) {
            console.error('Errore import posizioni:', error);
            showNotification('âŒ Errore: ' + error.message, 'error');
        }
    };
    
    input.click();
}
window.importPosizioniJSON = importPosizioniJSON; // ğŸ†• v5.70: Esponi a window

// ğŸ†• v5.704: Handler per input file globale (FAB)
async function handleGlobalImportPosizioni(inputElement) {
    console.log('ğŸ“¥ v5.704 handleGlobalImportPosizioni');
    
    const file = inputElement.files[0];
    if (!file) return;
    
    // Reset per permettere ri-selezione stesso file
    inputElement.value = '';
    
    // Processa
    await processImportFile(file);
}
window.handleGlobalImportPosizioni = handleGlobalImportPosizioni;

// Mostra/nascondi FAB in base allo stato
function updateFabVisibility() {
    const fab = document.getElementById('fabImportPosizioni');
    if (fab) {
        // Mostra solo quando c'Ã¨ un progetto aperto
        fab.style.display = state.currentProject ? 'block' : 'none';
    }
}
window.updateFabVisibility = updateFabVisibility;

// Funzione separata per processare il file
async function processImportFile(file) {
    console.log('ğŸ“¥ Processando file:', file.name);
    showNotification('ğŸ“¥ Lettura posizioni...', 'info');
    
    try {
        const project = state.projects.find(p => p.id === state.currentProject);
        if (!project) {
            showNotification('âŒ Nessun progetto aperto!', 'error');
            return;
        }
        
        const text = await file.text();
        const data = JSON.parse(text);
        
        // Estrai posizioni
        let posizioni = [];
        if (Array.isArray(data)) {
            posizioni = data;
        } else if (Array.isArray(data.positions)) {
            posizioni = data.positions;
        } else if (Array.isArray(data.posizioni)) {
            posizioni = data.posizioni;
        } else if (data.project && Array.isArray(data.project.rilievoInfissi)) {
            posizioni = data.project.rilievoInfissi;
        } else {
            showNotification('âŒ Formato JSON non riconosciuto', 'error');
            return;
        }
        
        if (posizioni.length === 0) {
            showNotification('âš ï¸ Nessuna posizione nel file', 'warning');
            return;
        }
        
        if (!project.positions) project.positions = [];
        
        const numPrima = project.positions.length;
        const timestamp = Date.now();
        
        posizioni.forEach((pos, idx) => {
            const newPosition = {
                id: `imp-${timestamp}-${idx}`,
                name: pos.name || pos.nome || `Pos. ${numPrima + idx + 1}`,
                piano: pos.piano || 'Piano Terra',
                ambiente: pos.ambiente || pos.stanza || '',
                // ğŸ†• v5.82: RIMOSSO quantita - usa solo prodotto.qta
                misure: pos.misure || {},
                infisso: pos.infisso ? normalizzaInfisso(pos.infisso, project) : null,
                persiana: pos.persiana ? normalizzaPersiana(pos.persiana, project) : null,
                tapparella: pos.tapparella ? normalizzaTapparella(pos.tapparella, project) : null,
                zanzariera: pos.zanzariera ? normalizzaZanzariera(pos.zanzariera, project) : null,
                cassonetto: pos.cassonetto ? normalizzaCassonetto(pos.cassonetto, project) : null,
                blindata: pos.blindata || null,
                portoncino: pos.portoncino || null,
                portaInterna: pos.portaInterna || null,
                clickZip: pos.clickZip || null,
                tendaBracci: pos.tendaBracci || null,
                grata: pos.grata ? (typeof GRATE_MODULE !== 'undefined' ? GRATE_MODULE.normalizza(pos.grata, project) : pos.grata) : null  // ğŸ”’ v5.85
            };
            project.positions.push(newPosition);
            
            // ğŸ†• v5.706: Attiva automaticamente i flag prodotti
            if (!project.prodotti) project.prodotti = {};
            if (newPosition.infisso) project.prodotti.infissi = true;
            if (newPosition.persiana) project.prodotti.persiane = true;
            if (newPosition.tapparella) project.prodotti.tapparelle = true;
            if (newPosition.zanzariera) project.prodotti.zanzariere = true;
            if (newPosition.cassonetto) project.prodotti.cassonetti = true;
            if (newPosition.blindata) project.prodotti.blindate = true;
            if (newPosition.portoncino) project.prodotti.portoncini = true;
            if (newPosition.portaInterna) project.prodotti.porteInterne = true;
            if (newPosition.clickZip) project.prodotti.clickZip = true;
            if (newPosition.tendaBracci) project.prodotti.tendeBracci = true;
            if (newPosition.grata) project.prodotti.grate = true;  // ğŸ”’ v5.85
        });
        
        // Log prodotti attivati
        console.log('ğŸ­ Prodotti attivati:', project.prodotti);
        
        // ğŸ”§ v5.712: Reset UI per evitare blocchi
        if (document.activeElement) {
            document.activeElement.blur();
        }
        
        saveState();
        render();  // ğŸ†• v5.707: Aggiorna UI
        
        // ğŸ”§ v5.712: Forza sblocco input dopo delay
        setTimeout(() => {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(el => el.disabled = false);
        }, 100);
        
        showNotification(`âœ… Importate ${posizioni.length} posizioni!`, 'success', 5000);
        console.log(`ğŸ“¥ IMPORTATE ${posizioni.length} POSIZIONI (${numPrima} â†’ ${project.positions.length})`);
        
    } catch (error) {
        console.error('Errore import:', error);
        showNotification('âŒ Errore: ' + error.message, 'error');
    }
}

// Normalizza struttura infisso importato
function normalizzaInfisso(inf, project) {
    return {
        id: generateId(),
        qta: inf.qta || inf.quantita || '1',
        tipo: inf.tipo || 'F1',
        tipoInfissoAssociato: inf.tipoInfissoAssociato || (inf.tipo?.startsWith('PF') ? 'PF' : 'F'),
        codiceModello: inf.codiceModello || '',  // ğŸ”§ v5.712: Campo Finstral
        azienda: inf.azienda || project.configInfissi?.azienda || 'Finstral',
        telaio: inf.telaio || project.configInfissi?.telaio || '961',
        finituraInt: inf.finituraInt || inf.finitura_int || project.configInfissi?.finituraInt || 'pvc',
        finituraEst: inf.finituraEst || inf.finitura_est || project.configInfissi?.finituraEst || 'pvc',
        coloreInt: inf.coloreInt || inf.colore_int || project.configInfissi?.coloreInt || '',
        coloreEst: inf.coloreEst || inf.colore_est || project.configInfissi?.coloreEst || '',
        tipoAnta: inf.tipoAnta || project.configInfissi?.tipoAnta || '',
        vetro: inf.vetro || project.configInfissi?.vetro || 'standard',
        allarme: inf.allarme || project.configInfissi?.allarme || '',
        cerniere: inf.cerniere || project.configInfissi?.cerniere || '',
        maniglia: inf.maniglia || project.configInfissi?.maniglia || '',
        coloreManiglia: inf.coloreManiglia || project.configInfissi?.coloreManiglia || '',
        tagliTelaio: inf.tagliTelaio || project.configInfissi?.tagliTelaio || '',
        codTagliValues: inf.codTagliValues || project.configInfissi?.codTagliValues || [],
        // Ferramenta campo 1
        ferramenta1: inf.ferramenta1 || '411',
        lato1: inf.lato1 || '-1',
        esecuzione1: inf.esecuzione1 || '0',
        // Ferramenta campo 2 (per 2+ ante)
        ferramenta2: inf.ferramenta2 || '',
        lato2: inf.lato2 || '',
        esecuzione2: inf.esecuzione2 || '',
        // Ferramenta campo 3 (per 3 ante)
        ferramenta3: inf.ferramenta3 || '',
        lato3: inf.lato3 || '',
        esecuzione3: inf.esecuzione3 || '',
        // Bancale
        bancaleTipo: inf.bancaleTipo || '',
        bancaleBordo: inf.bancaleBordo || '0',
        bancaleProfondita: inf.bancaleProfondita || '',
        // Anta Twin
        antaTwinTipo: inf.antaTwinTipo || '',
        antaTwinModello: inf.antaTwinModello || '',
        antaTwinColore: inf.antaTwinColore || '',
        antaTwinComando: inf.antaTwinComando || '27',
        // BRM
        BRM_L: parseInt(inf.BRM_L) || parseInt(inf.brm?.L) || 0,
        BRM_H: parseInt(inf.BRM_H) || parseInt(inf.brm?.H) || 0,
        note: inf.note || '',
        foto: inf.foto || []
    };
}

// ğŸ†• v5.703: Normalizza persiana con azienda obbligatoria
function normalizzaPersiana(pers, project) {
    return {
        id: generateId(),
        qta: pers.qta || pers.quantita || '1',
        azienda: pers.azienda || project.configPersiane?.azienda || 'P. Persiane',
        modello: pers.modello || project.configPersiane?.modello || '',
        fissaggio: pers.fissaggio || project.configPersiane?.fissaggio || '',
        colorePersiana: pers.colorePersiana || pers.colore || project.configPersiane?.colorePersiana || '',
        coloreTelaio: pers.coloreTelaio || project.configPersiane?.coloreTelaio || '',
        BRM_L: parseInt(pers.BRM_L) || parseInt(pers.brm?.L) || 0,
        BRM_H: parseInt(pers.BRM_H) || parseInt(pers.brm?.H) || 0,
        note: pers.note || ''
    };
}

// ğŸ†• v5.703: Normalizza tapparella con azienda obbligatoria
function normalizzaTapparella(tapp, project) {
    return {
        id: generateId(),
        qta: tapp.qta || tapp.quantita || '1',
        azienda: tapp.azienda || project.configTapparelle?.azienda || 'Plasticino',
        modello: tapp.modello || project.configTapparelle?.modello || '',
        tipologia: tapp.tipologia || project.configTapparelle?.tipologia || '',
        colore: tapp.colore || project.configTapparelle?.colore || '',
        guida: tapp.guida || project.configTapparelle?.guida || '',
        coloreGuida: tapp.coloreGuida || project.configTapparelle?.coloreGuida || '',
        manualeMot: tapp.manualeMot || 'Manuale',
        motoreAzienda: tapp.motoreAzienda || 'Somfy',
        motoreModello: tapp.motoreModello || '',
        BRM_L: parseInt(tapp.BRM_L) || parseInt(tapp.brm?.L) || 0,
        BRM_H: parseInt(tapp.BRM_H) || parseInt(tapp.brm?.H) || 0,
        note: tapp.note || ''
    };
}

// ğŸ†• v5.703: Normalizza zanzariera con azienda obbligatoria
function normalizzaZanzariera(zanz, project) {
    // ğŸ†• v5.719: Determina tipoInfissoAssociato da vari campi possibili
    const tipoInfissoAssociato = zanz.tipoInfissoAssociato || zanz.tipo_infisso_associato || 'F';
    const isPF = tipoInfissoAssociato === 'PF';
    
    // ğŸ†• v5.719: Prendi default Linea/Modello basati su F o PF dalla config
    const cfg = project.configZanzariere || {};
    const defaultLinea = isPF ? cfg.lineaPF : cfg.lineaF;
    const defaultModello = isPF ? cfg.modelloPF : cfg.modelloF;
    
    return {
        id: generateId(),
        qta: zanz.qta || zanz.quantita || '1',
        tipoInfissoAssociato: tipoInfissoAssociato,
        azienda: zanz.azienda || cfg.azienda || 'Palagina',
        // ğŸ†• v5.719: Campi Palagina con mapping snake_case â†’ camelCase
        linea: zanz.linea || defaultLinea || '',
        modello: zanz.modello || defaultModello || '',
        fasciaColore: zanz.fasciaColore || zanz.fascia_colore || cfg.fasciaColore || '',
        coloreTelaio: zanz.coloreTelaio || zanz.colore_telaio || cfg.coloreTelaio || '',
        tipoRete: zanz.tipoRete || zanz.tipo_rete || cfg.tipoRete || '',
        colorePlastica: zanz.colorePlastica || zanz.colore_plastica || cfg.colorePlastica || '',
        // Campi generici
        tipo: zanz.tipo || '',
        coloreRete: zanz.coloreRete || zanz.colore_rete || '',
        BRM_L: parseInt(zanz.BRM_L) || parseInt(zanz.brm?.L) || 0,
        BRM_H: parseInt(zanz.BRM_H) || parseInt(zanz.brm?.H) || 0,
        note: zanz.note || ''
    };
}

// ğŸ†• v5.703: Normalizza cassonetto con azienda obbligatoria
function normalizzaCassonetto(cass, project) {
    return {
        id: generateId(),
        qta: cass.qta || cass.quantita || '1',
        azienda: cass.azienda || project.configCassonetti?.azienda || 'Finstral',
        tipo: cass.tipo || '',
        materialeCass: cass.materialeCass || '',
        codiceCass: cass.codiceCass || '',
        coloreCass: cass.coloreCass || '',
        BRM_L: parseInt(cass.BRM_L) || parseInt(cass.brm?.L) || 0,
        BRM_H: parseInt(cass.BRM_H) || parseInt(cass.HCASS) || parseInt(cass.brm?.H) || 0,
        note: cass.note || ''
    };
}

function validateImportJSON(data) {
    // Valida struttura JSON importato
    if (!data || typeof data !== 'object') return false;
    
    // Accetta sia formato singolo progetto che array progetti
    if (Array.isArray(data.projects)) {
        // Formato export multiplo
        return data.projects.every(p => p.id && p.name);
    } else if (data.id && data.name) {
        // Formato singolo progetto
        return true;
    }
    
    return false;
}

async function processImport(data) {
    // ğŸ”§ v5.712: FIX blocco scrittura dopo import
    try {
        // Converti in array se singolo progetto
        let importedProjects = Array.isArray(data.projects) ? data.projects : [data];
        
        console.log(`ğŸ“Š Import: ${importedProjects.length} progetti...`);
        
        // Crea backup pre-import
        createBackup(`Pre-import: ${importedProjects.length} progetti`);
        
        let nuovi = 0;
        let aggiornati = 0;
        let ignorati = 0;
        let lastImportedId = null;
        
        importedProjects.forEach(imported => {
            // âœ… Normalizza positions
            if (!imported.positions || !Array.isArray(imported.positions)) {
                imported.positions = [];
            }
            
            const existing = state.projects.find(p => p.id === imported.id);
            
            if (!existing) {
                // Progetto nuovo â†’ aggiungi
                state.projects.push(imported);
                nuovi++;
                lastImportedId = imported.id;
                console.log(`âœ… Nuovo progetto: ${imported.nome || imported.id}`);
            } else {
                // Progetto esistente â†’ confronta timestamp
                const tsExisting = new Date(existing.metadata?.lastModified || 0).getTime();
                const tsImported = new Date(imported.metadata?.lastModified || 0).getTime();
                
                if (tsImported > tsExisting) {
                    // Importato Ã¨ piÃ¹ recente â†’ sostituisci
                    const idx = state.projects.findIndex(p => p.id === imported.id);
                    if (idx >= 0) {
                        state.projects[idx] = imported;
                        aggiornati++;
                        lastImportedId = imported.id;
                        console.log(`ğŸ”„ Aggiornato: ${imported.nome || imported.id}`);
                    }
                } else {
                    // Locale Ã¨ piÃ¹ recente o uguale â†’ ignora
                    ignorati++;
                    console.log(`â­ï¸ Ignorato (locale piÃ¹ recente): ${imported.nome || imported.id}`);
                }
            }
        });
        
        // ğŸ”§ v5.712: Reset UI state per evitare blocchi
        // Rimuovi focus da qualsiasi elemento
        if (document.activeElement) {
            document.activeElement.blur();
        }
        
        // Chiudi eventuali menu aperti
        state.projectMenuOpen = false;
        state.mainMenuOpen = false;
        state.configMenuExpanded = false;
        
        // Se era in una schermata progetto ma non c'Ã¨ progetto corrente, torna a lista
        if (!state.currentProject && state.screen !== 'list') {
            state.screen = 'list';
        }
        
        // Salva e aggiorna
        saveState();
        render();
        
        // ğŸ”§ v5.712: Forza refresh UI dopo breve delay per sbloccare input
        setTimeout(() => {
            // Ri-render per assicurare che gli input siano attivi
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(el => {
                el.disabled = false;
            });
            console.log('ğŸ”“ UI sbloccata dopo import');
        }, 100);
        
        // Notifica risultato
        showNotification(
            `âœ… Import completato! Nuovi: ${nuovi} | Aggiornati: ${aggiornati} | Ignorati: ${ignorati}`,
            'success'
        );
        
    } catch (error) {
        console.error('âŒ Errore processImport:', error);
        showNotification('âŒ Errore durante import: ' + error.message, 'error');
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 4: RILEVAMENTO DUPLICATI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function detectDuplicates(importedProjects) {
    // Analizza e classifica progetti importati
    const results = {
        newProjects: [],      // Mai visti prima
        existingProjects: [], // Identici, nessun conflitto
        conflicts: []         // Stessi ma diversi
    };
    
    importedProjects.forEach(imported => {
        const existing = state.projects.find(p => p.id === imported.id);
        
        if (!existing) {
            // Progetto nuovo
            results.newProjects.push(imported);
        } else {
            // Progetto esistente - confronta versioni
            const comparison = compareProjects(existing, imported);
            
            if (comparison.identical) {
                // Identici, nessun conflitto
                results.existingProjects.push({
                    imported: imported,
                    existing: existing
                });
            } else {
                // Diversi, conflitto!
                results.conflicts.push({
                    imported: imported,
                    existing: existing,
                    comparison: comparison
                });
            }
        }
    });
    
    return results;
}

function compareProjects(project1, project2) {
    // Confronta due progetti in dettaglio
    const result = {
        identical: false,
        newerProject: null,  // 'project1' | 'project2' | null
        differences: {
            positions: false,
            products: false,
            caratteristiche: false,
            clientData: false
        },
        timestamps: {
            project1: project1.metadata?.lastModified || null,
            project2: project2.metadata?.lastModified || null
        }
    };
    
    // Confronta timestamp
    const ts1 = new Date(project1.metadata?.lastModified || 0);
    const ts2 = new Date(project2.metadata?.lastModified || 0);
    
    if (ts1 > ts2) {
        result.newerProject = 'project1';
    } else if (ts2 > ts1) {
        result.newerProject = 'project2';
    }
    
    // Confronta contenuti
    if (project1.positions?.length !== project2.positions?.length) {
        result.differences.positions = true;
    }
    
    if (JSON.stringify(project1.prodotti) !== JSON.stringify(project2.prodotti)) {
        result.differences.products = true;
    }
    
    if (JSON.stringify(project1.caratteristicheMuro) !== JSON.stringify(project2.caratteristicheMuro)) {
        result.differences.caratteristiche = true;
    }
    
    if (project1.name !== project2.name || project1.client !== project2.client) {
        result.differences.clientData = true;
    }
    
    // Determina se identici
    result.identical = !Object.values(result.differences).some(d => d);
    
    return result;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 
// ğŸ“‹ SEZIONE 5: GESTIONE CONFLITTI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function resolveConflict(conflict) {
    // Mostra dialog e ottiene scelta utente
    return new Promise((resolve) => {
        showConflictDialog(conflict, resolve);
    });
}

function showConflictDialog(conflict, callback) {
    // Crea e mostra dialog modale conflitto
    const { imported, existing, comparison } = conflict;
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.right = '0';
    modal.style.bottom = '0';
    
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4 text-red-600">
                    âš ï¸ Conflitto Rilevato
                </h2>
                
                <div class="mb-4">
                    <p class="font-semibold text-lg">${existing.name}</p>
                    <p class="text-gray-600">${existing.client || 'Nessun cliente'}</p>
                    <p class="text-sm text-gray-500">ID: ${existing.id}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6 border rounded-lg p-4">
                    <div class="border-r pr-4">
                        <h3 class="font-bold mb-2 text-blue-600">ğŸ“± LOCALE</h3>
                        <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project1)}</p>
                        <p class="text-sm"><strong>Dispositivo:</strong> ${existing.metadata?.deviceName || 'Sconosciuto'}</p>
                        <p class="text-sm"><strong>Posizioni:</strong> ${existing.positions?.length || 0}</p>
                        <p class="text-sm"><strong>Versione:</strong> ${existing.metadata?.version || '1.0'}</p>
                        ${comparison.newerProject === 'project1' ? '<p class="text-green-600 font-bold mt-2">â­ PiÃ¹ recente</p>' : ''}
                    </div>
                    
                    <div class="pl-4">
                        <h3 class="font-bold mb-2 text-purple-600">ğŸ“¥ IMPORTATO</h3>
                        <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project2)}</p>
                        <p class="text-sm"><strong>Dispositivo:</strong> ${imported.metadata?.deviceName || 'Sconosciuto'}</p>
                        <p class="text-sm"><strong>Posizioni:</strong> ${imported.positions?.length || 0}</p>
                        <p class="text-sm"><strong>Versione:</strong> ${imported.metadata?.version || '1.0'}</p>
                        ${comparison.newerProject === 'project2' ? '<p class="text-green-600 font-bold mt-2">â­ PiÃ¹ recente</p>' : ''}
                    </div>
                </div>
                
                ${renderDifferences(comparison.differences)}
                
                <div class="space-y-3 mb-6">
                    <p class="font-semibold">Cosa vuoi fare?</p>
                    
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50">
                        <input type="radio" name="resolution" value="replace" class="mr-3" ${comparison.newerProject === 'project2' ? 'checked' : ''}>
                        <div>
                            <p class="font-semibold">Sostituisci con versione importata</p>
                            <p class="text-sm text-gray-600">La versione locale sarÃ  sovrascritta</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-green-50">
                        <input type="radio" name="resolution" value="keep" class="mr-3" ${comparison.newerProject === 'project1' ? 'checked' : ''}>
                        <div>
                            <p class="font-semibold">Mantieni versione locale</p>
                            <p class="text-sm text-gray-600">La versione importata sarÃ  ignorata</p>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
                        <input type="radio" name="resolution" value="duplicate" class="mr-3">
                        <div>
                            <p class="font-semibold">Crea nuovo progetto (duplica)</p>
                            <p class="text-sm text-gray-600">Mantieni entrambe le versioni come progetti separati</p>
                        </div>
                    </label>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="window.closeConflictDialog('cancel')" 
                            class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Annulla
                    </button>
                    <button onclick="window.closeConflictDialog('apply')" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Applica
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Funzione per chiudere dialog
    window.closeConflictDialog = (action) => {
        if (action === 'apply') {
            const selected = document.querySelector('input[name="resolution"]:checked');
            const resolution = selected ? selected.value : 'keep';
            conflict.resolution = resolution; // Salva per stats
            callback(resolution);
        } else {
            callback('cancel');
        }
        document.body.removeChild(modal);
        delete window.closeConflictDialog;
    };
}

function renderDifferences(differences) {
    // Renderizza elenco differenze trovate
    const diffs = [];
    if (differences.positions) diffs.push('Numero posizioni diverso');
    if (differences.products) diffs.push('Prodotti selezionati diversi');
    if (differences.caratteristiche) diffs.push('Caratteristiche muro diverse');
    if (differences.clientData) diffs.push('Dati cliente diversi');
    
    if (diffs.length === 0) {
        return '<p class="text-sm text-gray-600 mb-4">âš ï¸ Stesso ID ma versioni diverse</p>';
    }
    
    return `
        <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="font-semibold text-sm mb-2">Differenze rilevate:</p>
            <ul class="text-sm space-y-1">
                ${diffs.map(d => `<li>â€¢ ${d}</li>`).join('')}
            </ul>
        </div>
    `;
}

function applyConflictResolution(conflict, resolution) {
    // Applica la risoluzione scelta dall'utente
    const { imported, existing } = conflict;
    const existingIndex = state.projects.findIndex(p => p.id === existing.id);
    
    switch (resolution) {
        case 'replace':
            // Sostituisci locale con importato
            if (imported.metadata) {
                imported.metadata.syncStatus = 'synced';
            }
            // âœ… NORMALIZZA positions
            if (!imported.positions || !Array.isArray(imported.positions)) {
                imported.positions = [];
            }
            state.projects[existingIndex] = imported;
            break;
            
        case 'keep':
            // Mantieni locale, ignora importato
            if (existing.metadata) {
                existing.metadata.syncStatus = 'synced';
            }
            // Non fare nulla
            break;
            
        case 'duplicate':
            // Crea nuovo ID per importato e aggiungi
            imported.id = generateId();
            imported.name = imported.name + ' (importato)';
            if (imported.metadata) {
                imported.metadata.syncStatus = 'local';
            }
            // âœ… NORMALIZZA positions
            if (!imported.positions || !Array.isArray(imported.positions)) {
                imported.positions = [];
            }
            state.projects.push(imported);
            break;
            
        case 'cancel':
            // Non fare nulla
            break;
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 6: BACKUP SYSTEM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function createBackup(reason) {
    // Crea backup completo stato corrente
    const backup = {
        id: `backup_${Date.now()}`,
        timestamp: new Date().toISOString(),
        reason: reason || 'Backup manuale',
        projects: JSON.parse(JSON.stringify(state.projects)),
        count: state.projects.length,
        deviceName: getDeviceName()
    };
    
    const backups = getBackups();
    backups.push(backup);
    
    // Mantieni solo ultimi 10 backup
    if (backups.length > 10) {
        backups.shift();
    }
    
    localStorage.setItem('openPorteBackups', JSON.stringify(backups));
    
    console.log(`ğŸ’¾ Backup creato: ${backup.id}`);
    return backup.id;
}

function getBackups() {
    // Ottiene lista backup
    const stored = localStorage.getItem('openPorteBackups');
    return stored ? JSON.parse(stored) : [];
}

function restoreBackup(backupId) {
    // Ripristina backup specifico
    const backups = getBackups();
    const backup = backups.find(b => b.id === backupId);
    
    if (!backup) {
        showNotification('âŒ Backup non trovato', 'error');
        return false;
    }
    
    if (!confirm(`Ripristinare backup del ${formatDate(backup.timestamp)}?\nQuesta azione sovrascriverÃ  i dati correnti.`)) {
        return false;
    }
    
    // Crea backup corrente prima di restore (safety)
    createBackup('Pre-restore safety backup');
    
    // Restore
    state.projects = JSON.parse(JSON.stringify(backup.projects));
    saveState();
    render();
    
    showNotification(`âœ… Backup ripristinato: ${backup.reason}`, 'success');
    return true;
}

function deleteBackup(backupId) {
    // Elimina backup specifico
    let backups = getBackups();
    backups = backups.filter(b => b.id !== backupId);
    localStorage.setItem('openPorteBackups', JSON.stringify(backups));
    
    showNotification('ğŸ—‘ï¸ Backup eliminato', 'info');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“‹ SEZIONE 7: UI HELPER FUNCTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function showImportPreview(analysis) {
    // Mostra preview progetti da importare
    return new Promise((resolve) => {
        const { newProjects, existingProjects, conflicts } = analysis;
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.right = '0';
        modal.style.bottom = '0';
        
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full">
                <div class="p-6">
                    <h2 class="text-2xl font-bold mb-4 text-blue-600">
                        ğŸ“¥ Anteprima Import
                    </h2>
                    
                    <div class="space-y-4 mb-6">
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <p class="font-bold text-green-700">âœ… Nuovi Progetti: ${newProjects.length}</p>
                            <p class="text-sm text-gray-600">Saranno aggiunti senza conflitti</p>
                        </div>
                        
                        ${conflicts.length > 0 ? `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="font-bold text-yellow-700">âš ï¸ Conflitti Rilevati: ${conflicts.length}</p>
                            <p class="text-sm text-gray-600">Ti verrÃ  chiesto come gestirli</p>
                        </div>
                        ` : ''}
                        
                        ${existingProjects.length > 0 ? `
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="font-bold text-blue-700">ğŸ“‹ Progetti Identici: ${existingProjects.length}</p>
                            <p class="text-sm text-gray-600">Saranno ignorati (giÃ  presenti)</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="window.closeImportPreview(false)" 
                                class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Annulla
                        </button>
                        <button onclick="window.closeImportPreview(true)" 
                                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Continua Import
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.closeImportPreview = (proceed) => {
            document.body.removeChild(modal);
            delete window.closeImportPreview;
            resolve(proceed);
        };
    });
}

function formatDate(isoString) {
    // Formatta data ISO in formato leggibile
    if (!isoString) return 'Mai';
    const date = new Date(isoString);
    return date.toLocaleString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜ï¸ FASE 022a: ONEDRIVE SYNC MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ UTILITY FUNCTIONS â”€â”€â”€

function renderGitHubBadge() {
    // ğŸ“¦ Controllo sicurezza: se github non esiste, ritorna disconnesso
    if (!state.github || !state.github.connected) {
        return '<span style="font-size: 14px; color: #94a3b8;">âšª</span>'; // Disconnesso
    }
    
    switch(state.github.syncStatus) {
        case 'synced':
            return '<span style="font-size: 14px; color: #22c55e;">ğŸŸ¢</span>'; // Verde
        case 'syncing':
            return '<span style="font-size: 14px; color: #eab308;">ğŸŸ¡</span>'; // Giallo
        case 'error':
            return '<span style="font-size: 14px; color: #ef4444;">ğŸ”´</span>'; // Rosso
        default:
            return '<span style="font-size: 14px; color: #3b82f6;">ğŸ”µ</span>'; // Blu
    }
}

function getTimeSince(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Ora';
    if (minutes < 60) return `${minutes} min fa`;
    if (hours < 24) return `${hours} ore fa`;
    return `${days} giorni fa`;
}

// â”€â”€â”€ AUTHENTICATION â”€â”€â”€

async function connectOneDrive() {
    try {
        // Verifica configurazione CLIENT_ID
        if (ONEDRIVE_CONFIG.clientId === 'YOUR_CLIENT_ID_HERE') {
            showNotification('âš ï¸ Configurare CLIENT_ID in Azure Portal prima!', 'error', 8000);
            showOneDriveSetupInstructions();
            return;
        }
        
        showNotification('ğŸ”— Connessione a OneDrive...', 'info');
        
        // Genera PKCE challenge
        const codeVerifier = generateRandomString(128);
        const codeChallenge = await generateCodeChallenge(codeVerifier);
        
        // Salva verifier per dopo
        sessionStorage.setItem('onedrive_code_verifier', codeVerifier);
        
        // Costruisci URL autorizzazione
        const authUrl = `${ONEDRIVE_CONFIG.authority}/authorize?` +
            `client_id=${ONEDRIVE_CONFIG.clientId}` +
            `&response_type=code` +
            `&redirect_uri=${encodeURIComponent(ONEDRIVE_CONFIG.redirectUri)}` +
            `&scope=${encodeURIComponent(ONEDRIVE_CONFIG.scopes.join(' '))}` +
            `&code_challenge=${codeChallenge}` +
            `&code_challenge_method=S256` +
            `&prompt=select_account`;
        
        // Reindirizza a pagina auth Microsoft
        window.location.href = authUrl;
        
    } catch (error) {
        console.error('Error connecting to OneDrive:', error);
        showNotification('âŒ Errore connessione OneDrive', 'error');
    }
}

async function handleAuthCallback() {
    // ğŸ”§ FIX: OneDrive rimosso, ignora callback
    if (!state.onedrive) {
        return;
    }
    
    // Gestisce il callback dopo l'autenticazione
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const error = urlParams.get('error');
    
    if (error) {
        showNotification('âŒ Autenticazione annullata', 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
        return;
    }
    
    if (code) {
        try {
            showNotification('ğŸ” Ottenimento token...', 'info');
            
            const codeVerifier = sessionStorage.getItem('onedrive_code_verifier');
            sessionStorage.removeItem('onedrive_code_verifier');
            
            // Scambia code con access token
            const tokenResponse = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    client_id: ONEDRIVE_CONFIG.clientId,
                    scope: ONEDRIVE_CONFIG.scopes.join(' '),
                    code: code,
                    redirect_uri: ONEDRIVE_CONFIG.redirectUri,
                    grant_type: 'authorization_code',
                    code_verifier: codeVerifier
                })
            });
            
            if (!tokenResponse.ok) {
                throw new Error('Token exchange failed');
            }
            
            const tokens = await tokenResponse.json();
            
            // Salva token
            state.onedrive.connected = true;
            state.onedrive.accessToken = tokens.access_token;
            state.onedrive.refreshToken = tokens.refresh_token;
            state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
            
            // Ottieni info utente
            const userInfo = await fetch(`${ONEDRIVE_CONFIG.apiEndpoint}/me`, {
                headers: { 'Authorization': `Bearer ${tokens.access_token}` }
            });
            
            if (userInfo.ok) {
                const user = await userInfo.json();
                state.onedrive.userEmail = user.userPrincipalName || user.mail;
            }
            
            state.onedrive.syncStatus = 'synced';
            saveState();
            
            // Pulisci URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            showNotification('âœ… Connesso a OneDrive!', 'success');
            
            // Avvia sync automatica
            if (state.onedrive.autoSyncEnabled) {
                startAutoSync();
            }
            
            // ğŸ†• SCARICA AUTOMATICAMENTE I DATI DAL CLOUD
            // Se l'utente connette OneDrive su nuovo dispositivo, scarica i progetti esistenti
            setTimeout(async () => {
                if (state.projects.length === 0) {
                    // Prova a scaricare dati dal cloud
                    showNotification('ğŸ“¥ Controllo dati su OneDrive...', 'info');
                    const downloaded = await downloadFromOneDrive();
                    if (downloaded) {
                        showNotification('âœ… Progetti sincronizzati da OneDrive!', 'success', 3000);
                    }
                }
            }, 1500);
            
            render();
            
        } catch (error) {
            console.error('Token exchange error:', error);
            showNotification('âŒ Errore ottenimento token', 'error');
            state.onedrive.connected = false;
            saveState();
        }
    }
}

async function disconnectOneDrive() {
    if (confirm('Disconnettere OneDrive? I dati locali NON verranno eliminati.')) {
        stopAutoSync();
        
        state.onedrive = {
            connected: false,
            userEmail: null,
            accessToken: null,
            refreshToken: null,
            tokenExpiry: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
        
        saveState();
        render();
        showNotification('ğŸ‘‹ OneDrive disconnesso', 'info');
    }
}

// ğŸ“¦ FASE 027K: Funzioni Helper GitHub
function showGitHubTokenInput() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.7); display: flex;
        align-items: center; justify-content: center; z-index: 10000;
    `;
    
    modal.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 1rem 0; color: #2d3748;">ğŸ”‘ Token GitHub</h2>
            <p style="color: #718096; margin-bottom: 1.5rem; font-size: 0.95rem;">
                Inserisci il token GitHub per sincronizzare progetti.
            </p>
            <input type="password" id="github-token-input" 
                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                   style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="this.closest('div[style*=fixed]').remove()" 
                        style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; background: white; color: #4a5568; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Annulla
                </button>
                <button onclick="saveGitHubTokenFromInput()" 
                        style="padding: 0.75rem 1.5rem; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ğŸ’¾ Salva
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.getElementById('github-token-input').focus();
}

function saveGitHubTokenFromInput() {
    const token = document.getElementById('github-token-input')?.value.trim();
    
    if (!token) {
        alert('âŒ Inserisci un token valido');
        return;
    }
    
    // ğŸ”§ FIX: Assicura che state.github esista
    if (!state.github) {
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
    }
    
    // Salva token
    GITHUB_CONFIG.token = token;
    state.github.token = token;
    state.github.connected = true;
    localStorage.setItem('github_token', token);
    
    saveState();
    render();
    
    // Chiudi modale
    document.querySelector('div[style*="position: fixed"]')?.remove();
    
    showNotification('âœ… GitHub configurato!', 'success');
}

function disconnectGitHub() {
    if (confirm('Disconnettere GitHub? I dati locali NON verranno eliminati.')) {
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
        
        GITHUB_CONFIG.token = '';
        localStorage.removeItem('github_token');
        
        saveState();
        render();
        showNotification('ğŸ‘‹ GitHub disconnesso', 'info');
    }
}

async function refreshAccessToken() {
    try {
        if (!state.onedrive.refreshToken) {
            throw new Error('No refresh token');
        }
        
        const response = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                client_id: ONEDRIVE_CONFIG.clientId,
                scope: ONEDRIVE_CONFIG.scopes.join(' '),
                refresh_token: state.onedrive.refreshToken,
                grant_type: 'refresh_token'
            })
        });
        
        if (!response.ok) {
            throw new Error('Token refresh failed');
        }
        
        const tokens = await response.json();
        
        state.onedrive.accessToken = tokens.access_token;
        if (tokens.refresh_token) {
            state.onedrive.refreshToken = tokens.refresh_token;
        }
        state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
        
        saveState();
        return true;
        
    } catch (error) {
        console.error('Token refresh error:', error);
        showNotification('âš ï¸ Riconnetti OneDrive', 'error');
        state.onedrive.connected = false;
        stopAutoSync();
        saveState();
        return false;
    }
}

async function ensureValidToken() {
    // Verifica e rinnova token se necessario
    if (!state.onedrive.connected) {
        return false;
    }
    
    // Se token scade tra meno di 5 minuti, rinnova
    if (state.onedrive.tokenExpiry && (Date.now() + 300000) >= state.onedrive.tokenExpiry) {
        return await refreshAccessToken();
    }
    
    return true;
}

// â”€â”€â”€ PKCE HELPERS â”€â”€â”€

function generateRandomString(length) {
    const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
    let result = '';
    const values = crypto.getRandomValues(new Uint8Array(length));
    for (let i = 0; i < length; i++) {
        result += charset[values[i] % charset.length];
    }
    return result;
}

async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const base64 = btoa(String.fromCharCode(...new Uint8Array(hash)));
    return base64.replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
}

// â”€â”€â”€ SYNC OPERATIONS â”€â”€â”€

// ğŸ“¦ FASE 027K: Upload progetti su GitHub
// ğŸ“¥ Download Manuale da GitHub
async function manualDownloadFromGitHub() {
    if (!GITHUB_CONFIG.token && (!state.github || !state.github.token)) {
        showNotification('âš ï¸ Configura prima il token GitHub', 'error');
        return false;
    }
    
    const token = GITHUB_CONFIG.token || state.github.token;
    
    try {
        showNotification('â¬‡ï¸ Download da GitHub in corso...', 'info', 3000);
        
        // Lista tutti i file nel repository
        const listUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.projectsPath}?ref=${GITHUB_CONFIG.branch}`;
        
        console.log('ğŸ“‚ Listing files from:', listUrl);
        
        const listResponse = await fetch(listUrl, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!listResponse.ok) {
            throw new Error(`GitHub API error: ${listResponse.status}`);
        }
        
        const files = await listResponse.json();
        console.log('ğŸ“„ Files found:', files.length);
        
        // Filtra solo file JSON dei progetti
        const projectFiles = files.filter(f => f.name.endsWith('.json') && f.type === 'file');
        
        if (projectFiles.length === 0) {
            showNotification('â„¹ï¸ Nessun progetto trovato su GitHub', 'info');
            return false;
        }
        
        console.log('ğŸ“¦ Project files:', projectFiles.map(f => f.name));
        
        // Calcola statistiche
        let newCount = 0;
        let updatedCount = 0;
        const messages = [];
        
        // v5.89: FIX - existingIds deve essere dichiarato prima del loop
        const existingIds = new Set(state.projects.map(p => p.id));
        
        for (const file of projectFiles) {
            try {
                console.log('â¬‡ï¸ Downloading:', file.name);
                
                // Usa l'API GitHub per ottenere il contenuto
                const contentResponse = await fetch(file.url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!contentResponse.ok) continue;
                
                const contentData = await contentResponse.json();
                
                // Decodifica da base64
                const content = atob(contentData.content.replace(/\s/g, ''));
                const projectData = JSON.parse(content);
                
                console.log('âœ… Downloaded project:', projectData.name || projectData.id || 'unnamed');
                console.log('ğŸ“¦ Project structure:', Object.keys(projectData));
                
                // Gestisci diverse strutture possibili
                let projectsToImport = [];
                
                if (Array.isArray(projectData)) {
                    // Array di progetti
                    projectsToImport = projectData;
                } else if (projectData.projects && Array.isArray(projectData.projects)) {
                    // Oggetto con array projects
                    projectsToImport = projectData.projects;
                } else if (projectData.id && projectData.name) {
                    // Singolo progetto
                    projectsToImport = [projectData];
                } else {
                    console.warn('âš ï¸ Unknown structure:', projectData);
                    continue;
                }
                
                // Importa progetti
                for (const proj of projectsToImport) {
                    if (!proj.id || !proj.name) {
                        console.warn('âš ï¸ Invalid project (missing id or name):', proj);
                        continue;
                    }
                    
                    // âœ… NORMALIZZA positions
                    if (!proj.positions || !Array.isArray(proj.positions)) {
                        proj.positions = [];
                    }
                    
                    if (!existingIds.has(proj.id)) {
                        // NUOVO PROGETTO: Importa
                        state.projects.push(proj);
                        existingIds.add(proj.id);
                        newCount++;
                        console.log('âœ… Imported NEW:', proj.name);
                    } else {
                        // PROGETTO ESISTENTE: Confronta versioni
                        const existingIndex = state.projects.findIndex(p => p.id === proj.id);
                        const existing = state.projects[existingIndex];
                        
                        const localVersion = existing.metadata?.version || 0;
                        const githubVersion = proj.metadata?.version || 0;
                        
                        console.log(`ğŸ”„ Project "${proj.name}": Local v${localVersion} vs GitHub v${githubVersion}`);
                        
                        if (githubVersion > localVersion) {
                            // GitHub piÃ¹ recente â†’ SOVRASCRIVI
                            state.projects[existingIndex] = proj;
                            updatedCount++;
                            console.log(`âœ… UPDATED (GitHub v${githubVersion} > Local v${localVersion}):`, proj.name);
                        } else if (githubVersion === localVersion) {
                            // Stesso numero versione â†’ Confronta timestamp
                            const localTime = new Date(existing.metadata?.updated || 0).getTime();
                            const githubTime = new Date(proj.metadata?.updated || 0).getTime();
                            
                            if (githubTime > localTime) {
                                state.projects[existingIndex] = proj;
                                updatedCount++;
                                console.log(`âœ… UPDATED (same version but newer timestamp):`, proj.name);
                            } else {
                                // ğŸ”§ v5.91: Merge stato anche se skip
                                if (proj.stato) existing.stato = proj.stato;
                                console.log('â­ï¸ Skipped (local is same or newer):', proj.name);
                            }
                        } else {
                            // Locale piÃ¹ recente â†’ CONFLITTO
                            // ğŸ”§ v5.91: Merge stato da GitHub comunque
                            if (proj.stato && proj.stato !== 'preventivo') {
                                existing.stato = proj.stato;
                                console.log(`   ğŸ”„ Mergiato stato: ${proj.stato}`);
                            }
                            console.warn(`âš ï¸ CONFLICT: Local v${localVersion} > GitHub v${githubVersion} for "${proj.name}"`);
                            console.warn('   â†’ Keeping local version. Upload to sync.');
                        }
                    }
                }
                
            } catch (error) {
                console.error('âŒ Error downloading', file.name, error);
            }
        }
        
        // Messaggi finali
        if (newCount > 0) messages.push(`${newCount} nuovi`);
        if (updatedCount > 0) messages.push(`${updatedCount} aggiornati`);
        
        if (newCount > 0 || updatedCount > 0) {
            saveState();
            render();
            showNotification(`âœ… Download completato: ${messages.join(', ')}!`, 'success');
        } else {
            showNotification('â„¹ï¸ Tutti i progetti sono giÃ  aggiornati', 'info');
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ Error in manualDownloadFromGitHub:', error);
        showNotification('âŒ Errore download: ' + error.message, 'error');
        return false;
    }
}

// ğŸ“¦ FASE 027K: Upload progetti su GitHub
async function uploadToGitHub(projectId = null) {
    // ğŸ”§ Controllo token PRIMA di tutto
    if (!GITHUB_CONFIG.token || GITHUB_CONFIG.token.trim() === '') {
        console.error('âŒ GITHUB_CONFIG.token non configurato:', {
            hasToken: !!GITHUB_CONFIG.token,
            tokenLength: GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0,
            stateGithub: state.github
        });
        showNotification('âš ï¸ Token GitHub mancante - Configura in Impostazioni â†’ GitHub', 'error', 5000);
        return false;
    }
    
    console.log('âœ… Token GitHub presente:', {
        tokenLength: GITHUB_CONFIG.token.length,
        owner: GITHUB_CONFIG.owner,
        repo: GITHUB_CONFIG.repo
    });
    
    // ğŸ”§ FIX: Assicura che state.github esista
    if (!state.github) {
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
    }
    
    try {
        // v5.89: anti-rientro - impedisce upload concorrenti
        if (window._isUploading) {
            console.log('â³ Upload giÃ  in corso, skip');
            return false;
        }
        window._isUploading = true;
        
        state.github.syncStatus = 'syncing';
        updateSyncStatusDisplay('syncing');
        
        // Determina quali progetti caricare
        let projectsToUpload = [];
        
        if (projectId) {
            // Upload singolo progetto
            const project = state.projects.find(p => p.id === projectId);
            if (!project) {
                throw new Error('Progetto non trovato');
            }
            projectsToUpload = [project];
        } else if (state.currentProject) {
            // Upload progetto corrente
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) {
                throw new Error('Progetto corrente non trovato');
            }
            projectsToUpload = [project];
        } else {
            // Upload TUTTI i progetti (se chiamato da lista)
            projectsToUpload = state.projects;
        }
        
        if (projectsToUpload.length === 0) {
            showNotification('â„¹ï¸ Nessun progetto da sincronizzare', 'info');
            return false;
        }
        
        // Upload progetti
        let successCount = 0;
        let failedProjects = [];
        for (const project of projectsToUpload) {
            const uploaded = await uploadSingleProjectToGitHub(project);
            if (uploaded) {
                successCount++;
            } else {
                failedProjects.push(project.name || project.id);
            }
        }
        
        state.github.lastSyncTime = Date.now();
        state.github.syncStatus = successCount > 0 ? 'synced' : 'error';
        updateSyncStatusDisplay(successCount > 0 ? 'synced' : 'error');
        
        // Notifica successo o errore
        if (state.github.syncNotifications && !isUserTyping()) {
            if (!window.lastSyncNotification || (Date.now() - window.lastSyncNotification) > 5000) {
                window.lastSyncNotification = Date.now();
                
                if (successCount === 0) {
                    // âœ… NESSUN progetto salvato - ERRORE
                    const msg = projectsToUpload.length === 1
                        ? 'âŒ Impossibile salvare progetto su GitHub'
                        : `âŒ Impossibile salvare ${projectsToUpload.length} progetti su GitHub`;
                    showNotification(msg, 'error', 4000);
                } else if (successCount === projectsToUpload.length) {
                    // âœ… TUTTI i progetti salvati - SUCCESSO
                    const msg = projectsToUpload.length === 1 
                        ? 'âœ… Progetto salvato su GitHub'
                        : `âœ… ${successCount} progetti salvati su GitHub`;
                    showNotification(msg, 'success', 2000);
                } else {
                    // âš ï¸ ALCUNI progetti salvati - PARZIALE
                    const msg = `âš ï¸ ${successCount}/${projectsToUpload.length} progetti salvati su GitHub`;
                    showNotification(msg, 'warning', 3000);
                }
            }
        }
        
        GITHUB_CONFIG.lastSync = new Date().toISOString();
        console.log(`âœ… Upload completato: ${successCount}/${projectsToUpload.length} progetti`);
        
        window._isUploading = false;
        return true;
        
    } catch (error) {
        console.error('âŒ Errore upload GitHub:', error);
        state.github.syncStatus = 'error';
        updateSyncStatusDisplay('error');
        showNotification('âŒ Errore GitHub: ' + error.message, 'error');
        window._isUploading = false;
        return false;
    }
}

// ğŸ“¦ FASE NUOVA: Download progetti da GitHub
async function downloadFromGitHub() {
    if (!GITHUB_CONFIG.token) {
        showNotification('âš ï¸ Configura GitHub prima', 'error');
        return false;
    }
    
    try {
        showNotification('ğŸ“¥ Sincronizzazione con GitHub...', 'info');
        
        // ğŸ†• v4.61: SYNC BIDIREZIONALE - Lista tutti i file nella cartella progetti
        const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.projectsPath}`, {
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                showNotification('ğŸ“ Cartella progetti non trovata su GitHub', 'warning');
                return false;
            }
            throw new Error(`Errore GitHub: ${response.status}`);
        }
        
        const files = await response.json();
        
        // Filtra solo file JSON
        const projectFiles = files.filter(f => f.name.endsWith('.json'));
        
        if (projectFiles.length === 0) {
            showNotification('ğŸ“­ Nessun progetto trovato su GitHub', 'info');
            
            // ğŸ†• v4.61: Se GitHub vuoto ma ci sono progetti locali, chiedi cosa fare
            if (state.projects.length > 0) {
                const localProjects = state.projects.length;
                const shouldUpload = confirm(
                    `âš ï¸ ATTENZIONE:\n\n` +
                    `GitHub: 0 progetti\n` +
                    `Locale: ${localProjects} progetti\n\n` +
                    `Vuoi caricare i tuoi progetti locali su GitHub?\n\n` +
                    `OK = Carica su GitHub\n` +
                    `Annulla = Mantieni solo locali`
                );
                
                if (shouldUpload) {
                    console.log('ğŸ“¤ Caricamento progetti locali su GitHub...');
                    await syncToGitHub();
                }
            }
            
            return false;
        }
        
        console.log(`ğŸ“¥ Trovati ${projectFiles.length} progetti su GitHub`);
        
        // ğŸ†• v4.61: Estrai ID progetti da GitHub
        const githubProjectIds = new Set(
            projectFiles
                .map(f => f.name.match(/progetto-(.+)\.json/))
                .filter(m => m)
                .map(m => m[1])
        );
        
        console.log('ğŸ“‹ Progetti su GitHub:', Array.from(githubProjectIds));
        
        // ğŸ†• v4.61: Identifica progetti SOLO locali (cancellati da GitHub)
        const localOnlyProjects = state.projects.filter(p => !githubProjectIds.has(p.id));
        
        if (localOnlyProjects.length > 0) {
            console.warn(`âš ï¸ Trovati ${localOnlyProjects.length} progetti solo locali (cancellati da GitHub):`);
            localOnlyProjects.forEach(p => {
                console.warn(`   - ${p.id}: ${p.name || p.client}`);
            });
            
            // Chiedi all'utente cosa fare
            const message = 
                `âš ï¸ PROGETTI CANCELLATI DA GITHUB:\n\n` +
                `Trovati ${localOnlyProjects.length} progetti sul tuo dispositivo\n` +
                `che sono stati cancellati da GitHub:\n\n` +
                localOnlyProjects.map(p => `â€¢ ${p.name || p.client} (${p.id})`).join('\n') +
                `\n\nCosa vuoi fare?\n\n` +
                `OK = Ricaricare su GitHub\n` +
                `Annulla = Eliminare localmente`;
            
            const shouldReUpload = confirm(message);
            
            if (shouldReUpload) {
                // Ricarica progetti locali su GitHub
                console.log('ğŸ“¤ Ricaricamento progetti locali su GitHub...');
                for (const project of localOnlyProjects) {
                    await uploadSingleProjectToGitHub(project);
                }
                showNotification(`âœ… ${localOnlyProjects.length} progetti ricaricati su GitHub`, 'success', 3000);
            } else {
                // Elimina progetti locali
                console.log('ğŸ—‘ï¸ Eliminazione progetti locali...');
                state.projects = state.projects.filter(p => githubProjectIds.has(p.id));
                saveState();
                showNotification(`ğŸ—‘ï¸ ${localOnlyProjects.length} progetti rimossi localmente`, 'info', 3000);
            }
        }
        
        // Scarica ogni progetto da GitHub
        let downloadedCount = 0;
        let updatedCount = 0;
        let newCount = 0;
        let skippedCount = 0;
        
        for (const file of projectFiles) {
            try {
                // Scarica contenuto del file
                const contentResponse = await fetch(file.url, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!contentResponse.ok) continue;
                
                const contentData = await contentResponse.json();
                const content = atob(contentData.content.replace(/\n/g, ''));
                const projectData = JSON.parse(content);
                
                // Gestisci diversi formati di file
                let project = null;
                
                if (projectData.id) {
                    // Formato singolo progetto
                    project = projectData;
                } else if (projectData.projects && Array.isArray(projectData.projects)) {
                    // Formato con array di progetti
                    project = projectData.projects[0];
                } else if (Array.isArray(projectData)) {
                    // Formato array diretto
                    project = projectData[0];
                }
                
                if (project && project.id) {
                    // âœ… NORMALIZZA: Garantisci che positions sia sempre un array
                    if (!project.positions || !Array.isArray(project.positions)) {
                        project.positions = [];
                    }
                    
                    // Migra dati se necessario
                    project = migrateProjectRilievi(project);
                    
                    // ğŸ”§ v4.92: Migra sostEsistente â†’ sostTipo
                    migrateSingleProjectSostituzione(project);
                    
                    if (typeof migrateOldData === 'function') {
                        migrateOldData();
                    }
                    
                    // Verifica se il progetto esiste giÃ 
                    const existingIndex = state.projects.findIndex(p => p.id === project.id);
                    
                    if (existingIndex >= 0) {
                        // ğŸ†• v4.61: Confronto INTELLIGENTE basato su metadata.version
                        const existing = state.projects[existingIndex];
                        
                        const remoteVersion = project.metadata?.version || 1;
                        const localVersion = existing.metadata?.version || 1;
                        
                        console.log(`ğŸ” Confronto ${project.id}:`, {
                            remote: remoteVersion,
                            local: localVersion,
                            remoteName: project.name,
                            localName: existing.name
                        });
                        
                        if (remoteVersion > localVersion) {
                            // GitHub piÃ¹ recente â†’ Usa GitHub
                            console.log(`ğŸ“¥ GitHub piÃ¹ recente (v${remoteVersion} > v${localVersion})`);
                            state.projects[existingIndex] = project;
                            updatedCount++;
                        } else if (localVersion > remoteVersion) {
                            // Locale piÃ¹ recente â†’ Ignora GitHub, carica locale su GitHub dopo
                            console.log(`ğŸ“¤ Locale piÃ¹ recente (v${localVersion} > v${remoteVersion}) - da ricaricare`);
                            // ğŸ”§ v5.91: Merge stato da GitHub (potrebbe essere cambiato da Dashboard)
                            if (project.stato && project.stato !== 'preventivo') {
                                existing.stato = project.stato;
                                console.log(`   ğŸ”„ Mergiato stato: ${project.stato}`);
                            }
                            skippedCount++;
                            // VerrÃ  ricaricato da auto-sync
                        } else {
                            // Stessa versione â†’ Controlla timestamp come fallback
                            const remoteDate = new Date(project.metadata?.updated || project.updated || 0);
                            const localDate = new Date(existing.metadata?.updated || existing.updated || 0);
                            
                            if (remoteDate > localDate) {
                                console.log(`ğŸ“¥ Stesso version ma GitHub piÃ¹ recente (timestamp)`);
                                state.projects[existingIndex] = project;
                                updatedCount++;
                            } else {
                                console.log(`âœ… Progetti identici (v${localVersion})`);
                                // ğŸ”§ v5.91: Merge stato da GitHub anche se identici
                                if (project.stato) {
                                    existing.stato = project.stato;
                                }
                                skippedCount++;
                            }
                        }
                    } else {
                        // Aggiungi nuovo progetto da GitHub
                        state.projects.push(project);
                        newCount++;
                        console.log(`â• Nuovo da GitHub: ${project.name} (v${project.metadata?.version || 1})`);
                    }
                    
                    downloadedCount++;
                }
                
            } catch (err) {
                console.error(`Errore scaricando ${file.name}:`, err);
            }
        }
        
        // âš¡ DEBUG: Verifica stato progetti dopo download
        console.log('ğŸ“Š DEBUG sync bidirezionale:');
        console.log(`   - Progetti finali in state: ${state.projects.length}`);
        console.log(`   - Progetti scaricati: ${downloadedCount}/${projectFiles.length}`);
        console.log(`   - Nuovi: ${newCount}`);
        console.log(`   - Aggiornati: ${updatedCount}`);
        console.log(`   - Skipped (locale piÃ¹ recente): ${skippedCount}`);
        state.projects.forEach((p, i) => {
            console.log(`   ${i+1}. ${p.name || p.client || 'NO NAME'} [ID: ${p.id}] v${p.metadata?.version || '?'}`);
        });
        
        // Salva stato aggiornato
        saveState();
        
        // ğŸ”§ v4.92: Migra sostEsistente â†’ sostTipo per dati da GitHub
        migrateSostituzioneComponenti();
        
        // Aggiorna timestamp sync
        if (state.github) {
            state.github.lastSyncTime = Date.now();
            state.github.syncStatus = 'synced';
        }
        
        // ğŸ†• v4.61: Se ci sono progetti locali piÃ¹ recenti, caricali su GitHub
        if (skippedCount > 0) {
            console.log(`ğŸ“¤ Caricamento ${skippedCount} progetti locali piÃ¹ recenti su GitHub...`);
            const localNewerProjects = state.projects.filter(local => {
                const githubVersion = projectFiles
                    .find(f => f.name === `progetto-${local.id}.json`)
                    ?.metadata?.version || 0;
                return (local.metadata?.version || 1) > githubVersion;
            });
            
            for (const project of localNewerProjects) {
                await uploadSingleProjectToGitHub(project);
            }
        }
        
        // Mostra risultato completo
        const parts = [];
        if (newCount > 0) parts.push(`â• ${newCount} nuovi`);
        if (updatedCount > 0) parts.push(`ğŸ”„ ${updatedCount} aggiornati`);
        if (skippedCount > 0) parts.push(`ğŸ“¤ ${skippedCount} ricaricati`);
        
        const message = parts.length > 0
            ? `âœ… Sincronizzazione completata!\n${parts.join(' â€¢ ')}`
            : `âœ… Tutti i progetti sono giÃ  sincronizzati`;
        
        showNotification(message, 'success', 5000);
        
        // Re-render SEMPRE dopo download
        render();
        console.log('ğŸ”„ Render forzato dopo sync bidirezionale');
        
        return true;
        
    } catch (error) {
        console.error('âŒ Errore download GitHub:', error);
        showNotification('âŒ Errore download: ' + error.message, 'error');
        return false;
    }
}

// ğŸ“¦ FASE 027M: Normalizza positions â†’ formato nuovo misure
function normalizePositionsToMisure(positions) {
    return positions.map(pos => {
        const normalized = {
            id: pos.id,
            name: pos.name,
            piano: pos.piano,
            ambiente: pos.ambiente,
            // ğŸ†• v5.82: RIMOSSO quantita - usa solo prodotto.qta
            misure: pos.misure || {},
            rilievo: pos.rilievo || {},
            note: pos.note || '',
            foto: pos.foto || []
        };
        
        // Normalizza infisso
        if (pos.infisso && parseInt(pos.infisso.qta) > 0) {
            normalized.infisso = {
                id: pos.infisso.id,
                quantita: parseInt(pos.infisso.qta) || 0,
                azienda: pos.infisso.azienda || 'Non specificata',
                brm: {
                    L: pos.infisso.BRM_L || 0,
                    H: pos.infisso.BRM_H || 0
                },
                finitura_int: pos.infisso.finituraInt,
                finitura_est: pos.infisso.finituraEst,
                colore_int: pos.infisso.coloreInt,
                colore_est: pos.infisso.coloreEst,
                tipo_anta: pos.infisso.tipoAnta,
                telaio: pos.infisso.telaio,
                allarme: pos.infisso.allarme,
                vetro: pos.infisso.vetro,
                tipo: pos.infisso.tipo,
                apertura: pos.infisso.apertura,
                note: pos.infisso.note || '',
                foto: pos.infisso.foto || []
            };
        }
        
        // Normalizza persiana
        if (pos.persiana && parseInt(pos.persiana.qta) > 0) {
            normalized.persiana = {
                id: pos.persiana.id,
                quantita: parseInt(pos.persiana.qta) || 0,
                azienda: pos.persiana.azienda || 'Non specificata',
                brm: {
                    L: pos.persiana.BRM_L || 0,
                    H: pos.persiana.BRM_H || 0
                },
                modello: pos.persiana.modello,
                fissaggio: pos.persiana.fissaggio,
                battuta: pos.persiana.battuta,
                colore: pos.persiana.colorePersiana || pos.persiana.colore,
                materiale: pos.persiana.materiale,
                tipo: pos.persiana.tipo,
                apertura: pos.persiana.apertura,
                note: pos.persiana.note || '',
                foto: pos.persiana.foto || []
            };
        }
        
        // Normalizza zanzariera
        if (pos.zanzariera && parseInt(pos.zanzariera.qta) > 0) {
            normalized.zanzariera = {
                id: pos.zanzariera.id,
                quantita: parseInt(pos.zanzariera.qta) || 0,
                azienda: pos.zanzariera.azienda || 'Non specificata',
                brm: {
                    L: pos.zanzariera.BRM_L || 0,
                    H: pos.zanzariera.BRM_H || 0
                },
                azienda: pos.zanzariera.azienda,
                tipo: pos.zanzariera.tipo,
                colore: pos.zanzariera.coloreTelaio,
                tipo_rete: pos.zanzariera.tipoRete,
                note: pos.zanzariera.note || '',
                foto: pos.zanzariera.foto || []
            };
        }
        
        // Normalizza tapparella
        if (pos.tapparella && parseInt(pos.tapparella.qta) > 0) {
            normalized.tapparella = {
                id: pos.tapparella.id,
                quantita: parseInt(pos.tapparella.qta) || 0,
                azienda: pos.tapparella.azienda || 'Non specificata',
                brm: {
                    L: pos.tapparella.BRM_L || 0,
                    H: pos.tapparella.BRM_H || 0
                },
                modello: pos.tapparella.modello || '',
                tipologia: pos.tapparella.tipologia || '',
                guida: pos.tapparella.guida || '',
                tipo: pos.tapparella.tipo,
                materiale: pos.tapparella.materiale,
                colore: pos.tapparella.colore,
                motorizzazione: pos.tapparella.motorizzazione,
                note: pos.tapparella.note || '',
                foto: pos.tapparella.foto || []
            };
        }
        
        // Normalizza cassonetto
        if (pos.cassonetto && parseInt(pos.cassonetto.qta) > 0) {
            normalized.cassonetto = {
                id: pos.cassonetto.id,
                quantita: parseInt(pos.cassonetto.qta) || 0,
                azienda: pos.cassonetto.azienda || 'Non specificata',
                brm: {
                    L: pos.cassonetto.BRM_L || 0,
                    H: pos.cassonetto.BRM_H || 0,
                    C: pos.cassonetto.BRM_C || 0,
                    B: pos.cassonetto.BRM_B || 0
                },
                tipo: pos.cassonetto.tipo,
                materiale: pos.cassonetto.materiale,
                isolamento: pos.cassonetto.isolamento,
                // Campi Finstral
                cassonettoCheck: pos.cassonetto.cassonettoCheck,
                cassonettoText: pos.cassonetto.cassonettoText || '',
                posaCheck: pos.cassonetto.posaCheck,
                posaText: pos.cassonetto.posaText || '',
                colore: pos.cassonetto.colore || '',
                isolamentoPosaclima: pos.cassonetto.isolamentoPosaclima || false,
                aSoffitto: pos.cassonetto.aSoffitto || false,
                // v5.36: Campi calcolo prezzi
                materialeCass: pos.cassonetto.materialeCass || '',
                codiceCass: pos.cassonetto.codiceCass || '',
                gruppoColoreCass: pos.cassonetto.gruppoColoreCass || '',
                coloreCass: pos.cassonetto.coloreCass || '', // v5.54
                coloreDaInfisso: pos.cassonetto.coloreDaInfisso !== false, // v5.54 default true
                codiceIsolamento: pos.cassonetto.codiceIsolamento || '',
                // Misure
                LS: pos.cassonetto.LS || '0',
                HCASS: pos.cassonetto.HCASS || '0',
                B: pos.cassonetto.B || '0',
                C: pos.cassonetto.C || '0',
                note: pos.cassonetto.note || '',
                foto: pos.cassonetto.foto || []
            };
        }
        
        return normalized;
    });
}

// ğŸ“¦ FASE 027K: Upload singolo progetto (helper function)
async function uploadSingleProjectToGitHub(project) {
    try {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸš€ INIZIO UPLOAD PROGETTO:', project.id);
        console.log('ğŸ“‹ Nome:', project.name);
        console.log('ğŸ‘¤ Cliente:', project.client);
        console.log('ğŸ¢ ClienteData:', project.clientData);
        console.log('ğŸ“ Posizioni:', project.positions?.length || 0);
        console.log('ğŸ”‘ Token presente:', !!GITHUB_CONFIG.token);
        console.log('ğŸ”‘ Token lunghezza:', GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        
        // âš ï¸ CONTROLLO TOKEN
        if (!GITHUB_CONFIG.token || GITHUB_CONFIG.token.trim() === '') {
            const errorMsg = 'âŒ Token GitHub mancante';
            console.error(errorMsg);
            showNotification('âš ï¸ Connetti GitHub prima di salvare - Vai in "Connetti GitHub"', 'error', 5000);
            return false;
        }
        
        // âœ… VALIDAZIONE MINIMA: Richiede solo nome/cliente (progetti vuoti OK per schede pre-cantiere)
        const hasValidName = (project.name && project.name.trim()) || 
                             (project.client && project.client.trim()) || 
                             (project.clientData?.nome && project.clientData.nome.trim());

        if (!hasValidName) {
            const errorMsg = `âš ï¸ Progetto ${project.id}: Nome mancante`;
            console.log(errorMsg, {
                id: project.id,
                name: project.name,
                client: project.client,
                clientNome: project.clientData?.nome
            });
            showNotification(errorMsg + ' - Compila nome progetto o cliente', 'warning', 4000);
            return false;
        }

        const numPositions = (project.positions && project.positions.length) || 0;
        console.log(`âœ… Upload valido: ${project.name || project.id} (${numPositions} posizioni)`);
        
        // v5.89: rimosso saveState() ridondante - updateProjectTimestamp giÃ  lo chiama
        
        // ğŸ†• v4.61: Tracking modifiche prima dell'upload
        updateProjectTimestamp(
            project.id, 
            'uploaded_to_github', 
            `Progetto caricato su GitHub (${numPositions} posizioni)`,
            { positions: numPositions }
        );
        
        // ğŸš¨ RILEGGI progetto dopo updateProjectTimestamp per avere versione aggiornata
        const updatedProject = state.projects.find(p => p.id === project.id);
        if (!updatedProject) {
            throw new Error('Progetto non trovato dopo update timestamp');
        }
        
        // Prepara dati progetto COMPLETI
        const projectData = {
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DATI PROGETTO COMPLETI (v4.0)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            id: updatedProject.id,
            name: updatedProject.name || '',
            client: updatedProject.client || '',
            
            // DATI CLIENTE COMPLETI
            clientData: {
                nome: updatedProject.clientData?.nome || '',
                cognome: updatedProject.clientData?.cognome || '',
                telefono: updatedProject.clientData?.telefono || '',
                email: updatedProject.clientData?.email || '',
                indirizzo: updatedProject.clientData?.indirizzo || '',
                citta: updatedProject.clientData?.citta || '',
                cap: updatedProject.clientData?.cap || '',
                piano: updatedProject.clientData?.piano || '',
                note: updatedProject.clientData?.note || ''
            },
            
            // ğŸ“ v5.27: LINK SCHIZZO NOTABILITY
            linkSchizzo: updatedProject.linkSchizzo || '',
            
            // PRODOTTI ABILITATI
            prodotti: {
                infissi: updatedProject.prodotti?.infissi || false,
                persiane: updatedProject.prodotti?.persiane || false,
                tapparelle: updatedProject.prodotti?.tapparelle || false,
                zanzariere: updatedProject.prodotti?.zanzariere || false,
                cassonetti: updatedProject.prodotti?.cassonetti || false,
                blindate: updatedProject.prodotti?.blindate || false,
                portoncini: updatedProject.prodotti?.portoncini || false,
                porteInterne: updatedProject.prodotti?.porteInterne || false,
                clickZip: updatedProject.prodotti?.clickZip || false,  // ğŸªŸ v5.64 GIBUS
                tendeBracci: updatedProject.prodotti?.tendeBracci || false,  // â˜€ï¸ v5.64 GIBUS
                grate: updatedProject.prodotti?.grate || false  // ğŸ”’ v5.85 ERRECI
            },
            
            // CARATTERISTICHE MURO
            caratteristicheMuro: {
                profMuroInt: updatedProject.caratteristicheMuro?.profMuroInt || '',
                profPianaSopra: updatedProject.caratteristicheMuro?.profPianaSopra || '',
                profPianaSotto: updatedProject.caratteristicheMuro?.profPianaSotto || '',
                telaioProfondita: updatedProject.caratteristicheMuro?.telaioProfondita || '',
                telaioLarghezza: updatedProject.caratteristicheMuro?.telaioLarghezza || '',
                guidaEsistente: updatedProject.caratteristicheMuro?.guidaEsistente || '',
                profGuida: updatedProject.caratteristicheMuro?.profGuida || '',
                larghezzaGuida: updatedProject.caratteristicheMuro?.larghezzaGuida || '',
                profMuroEst: updatedProject.caratteristicheMuro?.profMuroEst || '',
                battutaSuperioreTapparella: updatedProject.caratteristicheMuro?.battutaSuperioreTapparella || '',
                falsoEsistente: updatedProject.caratteristicheMuro?.falsoEsistente || '',
                spessoreFalso: updatedProject.caratteristicheMuro?.spessoreFalso || '',
                distanzaFalsoInfisso: updatedProject.caratteristicheMuro?.distanzaFalsoInfisso || ''
            },
            
            // CONFIG INFISSI
            configInfissi: {
                azienda: updatedProject.configInfissi?.azienda || '',
                telaio: updatedProject.configInfissi?.telaio || '',
                finituraInt: updatedProject.configInfissi?.finituraInt || '',
                finituraEst: updatedProject.configInfissi?.finituraEst || '',
                coloreInt: updatedProject.configInfissi?.coloreInt || '',
                coloreEst: updatedProject.configInfissi?.coloreEst || '',
                tipoAnta: updatedProject.configInfissi?.tipoAnta || '',
                vetro: updatedProject.configInfissi?.vetro || '',
                // ğŸ†• v4.84: Campi mancanti aggiunti
                allarme: updatedProject.configInfissi?.allarme || '',
                cerniere: updatedProject.configInfissi?.cerniere || '',
                maniglia: updatedProject.configInfissi?.maniglia || '',
                coloreManiglia: updatedProject.configInfissi?.coloreManiglia || '',
                tagliTelaio: updatedProject.configInfissi?.tagliTelaio || '',
                // ğŸ†• v4.81: codTagli rimosso, generato da tagliTelaio
                codTagliValues: updatedProject.configInfissi?.codTagliValues || [],
                // ğŸ†• v5.67: Bancale Interno
                bancaleTipo: updatedProject.configInfissi?.bancaleTipo || '',
                bancaleBordo: updatedProject.configInfissi?.bancaleBordo || '0',
                bancaleProfondita: updatedProject.configInfissi?.bancaleProfondita || '',
                // ğŸ†• v5.68: Anta Twin (Veneziana/Plissettata)
                antaTwinTipo: updatedProject.configInfissi?.antaTwinTipo || '',
                antaTwinModello: updatedProject.configInfissi?.antaTwinModello || '',
                antaTwinColore: updatedProject.configInfissi?.antaTwinColore || '',
                antaTwinComando: updatedProject.configInfissi?.antaTwinComando || '27'
            },
            
            // BRM INFISSI
            brmConfigInfissi: {
                misuraBaseL: updatedProject.brmConfigInfissi?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigInfissi?.operazioneL || '',
                valoreL: updatedProject.brmConfigInfissi?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigInfissi?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigInfissi?.operazioneH || '',
                valoreH: updatedProject.brmConfigInfissi?.valoreH || '',
                // ğŸ†• v5.561: Campi BRM per PORTAFINESTRA
                misuraBaseL_PF: updatedProject.brmConfigInfissi?.misuraBaseL_PF || '',
                operazioneL_PF: updatedProject.brmConfigInfissi?.operazioneL_PF || '',
                valoreL_PF: updatedProject.brmConfigInfissi?.valoreL_PF || '',
                misuraBaseH_PF: updatedProject.brmConfigInfissi?.misuraBaseH_PF || '',
                operazioneH_PF: updatedProject.brmConfigInfissi?.operazioneH_PF || '',
                valoreH_PF: updatedProject.brmConfigInfissi?.valoreH_PF || '',
                note: updatedProject.brmConfigInfissi?.note || ''
            },
            
            // RILIEVO INFISSI - ğŸ”„ v5.743: Sistema 3 stati (si/no/null) + note coprifili
            rilievoInfissi: {
                materiale: updatedProject.rilievoInfissi?.materiale || '',
                togliere: updatedProject.rilievoInfissi?.togliere ?? null,
                smaltimento: updatedProject.rilievoInfissi?.smaltimento ?? null,
                coprifiliInt: updatedProject.rilievoInfissi?.coprifiliInt ?? null,
                coprifiliIntNote: updatedProject.rilievoInfissi?.coprifiliIntNote || '',
                coprifiliEst: updatedProject.rilievoInfissi?.coprifiliEst ?? null,
                coprifiliEstNote: updatedProject.rilievoInfissi?.coprifiliEstNote || '',
                note: updatedProject.rilievoInfissi?.note || ''
            },
            
            // CONFIG PERSIANE - ğŸ”§ v5.04: Nomi campi corretti
            configPersiane: {
                azienda: updatedProject.configPersiane?.azienda || '',
                modello: updatedProject.configPersiane?.modello || '',
                fissaggio: updatedProject.configPersiane?.fissaggio || '',
                colorePersiana: updatedProject.configPersiane?.colorePersiana || '',
                // ğŸ”§ v5.04: coloreTelaio SOLO se fissaggio = telaio
                coloreTelaio: (updatedProject.configPersiane?.fissaggio === 'telaio') 
                              ? (updatedProject.configPersiane?.coloreTelaio || '') 
                              : '',
                battuta: updatedProject.configPersiane?.battuta || '',
                tipoStecca: updatedProject.configPersiane?.tipoStecca || '',
                asolato: updatedProject.configPersiane?.asolato || '',
                tipo: updatedProject.configPersiane?.tipo || '',
                apertura: updatedProject.configPersiane?.apertura || ''
            },
            
            // BRM PERSIANE
            brmConfigPersiane: {
                misuraBaseL: updatedProject.brmConfigPersiane?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigPersiane?.operazioneL || '',
                valoreL: updatedProject.brmConfigPersiane?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigPersiane?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigPersiane?.operazioneH || '',
                valoreH: updatedProject.brmConfigPersiane?.valoreH || '',
                note: updatedProject.brmConfigPersiane?.note || ''
            },
            
            // RILIEVO PERSIANE - ğŸ”„ v5.743: Sistema 3 stati
            rilievoPersiane: {
                materiale: updatedProject.rilievoPersiane?.materiale || '',
                togliere: updatedProject.rilievoPersiane?.togliere ?? null,
                smaltimento: updatedProject.rilievoPersiane?.smaltimento ?? null,
                note: updatedProject.rilievoPersiane?.note || ''
            },
            
            // CONFIG TAPPARELLE
            configTapparelle: {
                // Checkbox cosa serve (default)
                serveTapparella: updatedProject.configTapparelle?.serveTapparella !== false,
                serveMotore: updatedProject.configTapparelle?.serveMotore || false,
                serveAccessori: updatedProject.configTapparelle?.serveAccessori || false,
                // Dati tapparella
                azienda: updatedProject.configTapparelle?.azienda || '',
                modello: updatedProject.configTapparelle?.modello || '',
                tipo: updatedProject.configTapparelle?.tipo || '',
                colore: updatedProject.configTapparelle?.colore || '',
                // Sostituzione componenti
                sostTipo: updatedProject.configTapparelle?.sostTipo || 'tutto',
                accessoriDaSostituire: updatedProject.configTapparelle?.accessoriDaSostituire || {},
                guida: updatedProject.configTapparelle?.guida || '',
                coloreGuida: updatedProject.configTapparelle?.coloreGuida || '',
                // Tipo tapparella
                nuovaAutomazione: updatedProject.configTapparelle?.nuovaAutomazione || 'Manuale',
                forniMotore: updatedProject.configTapparelle?.forniMotore || false,
                modelloMotore: updatedProject.configTapparelle?.modelloMotore || '',
                motoreAzienda: updatedProject.configTapparelle?.motoreAzienda || 'Somfy',
                // v5.40: Config motore default per "+ Aggiungi Motore"
                motoreModelloDefault: updatedProject.configTapparelle?.motoreModelloDefault || '',
                comandoDefault: updatedProject.configTapparelle?.comandoDefault || '',
                accessoriMotoreDefault: updatedProject.configTapparelle?.accessoriMotoreDefault || {},
                // Legacy
                motorizzazione: updatedProject.configTapparelle?.motorizzazione || '',
                comando: updatedProject.configTapparelle?.comando || ''
            },
            
            // BRM TAPPARELLE
            brmConfigTapparelle: {
                misuraBaseL: updatedProject.brmConfigTapparelle?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigTapparelle?.operazioneL || '',
                valoreL: updatedProject.brmConfigTapparelle?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigTapparelle?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigTapparelle?.operazioneH || '',
                valoreH: updatedProject.brmConfigTapparelle?.valoreH || '',
                note: updatedProject.brmConfigTapparelle?.note || ''
            },
            
            // RILIEVO TAPPARELLE - ğŸ”„ v5.743: Sistema 3 stati
            rilievoTapparelle: {
                materiale: updatedProject.rilievoTapparelle?.materiale || '',
                togliere: updatedProject.rilievoTapparelle?.togliere ?? null,
                smaltimento: updatedProject.rilievoTapparelle?.smaltimento ?? null,
                note: updatedProject.rilievoTapparelle?.note || ''
            },
            
            // CONFIG ZANZARIERE
            configZanzariere: {
                azienda: updatedProject.configZanzariere?.azienda || '',
                modelloF: updatedProject.configZanzariere?.modelloF || '',
                modelloPF: updatedProject.configZanzariere?.modelloPF || '',
                colore: updatedProject.configZanzariere?.colore || ''
            },
            
            // BRM ZANZARIERE
            brmConfigZanzariere: {
                misuraBaseL: updatedProject.brmConfigZanzariere?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigZanzariere?.operazioneL || '',
                valoreL: updatedProject.brmConfigZanzariere?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigZanzariere?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigZanzariere?.operazioneH || '',
                valoreH: updatedProject.brmConfigZanzariere?.valoreH || '',
                note: updatedProject.brmConfigZanzariere?.note || ''
            },
            
            // RILIEVO ZANZARIERE - ğŸ”„ v5.743: Sistema 3 stati
            rilievoZanzariere: {
                materiale: updatedProject.rilievoZanzariere?.materiale || '',
                togliere: updatedProject.rilievoZanzariere?.togliere ?? null,
                smaltimento: updatedProject.rilievoZanzariere?.smaltimento ?? null,
                note: updatedProject.rilievoZanzariere?.note || ''
            },
            
            // CONFIG CASSONETTI
            configCassonetti: {
                tipo: updatedProject.configCassonetti?.tipo || '',
                azienda: updatedProject.configCassonetti?.azienda || '',
                materiale: updatedProject.configCassonetti?.materiale || '',
                finitura: updatedProject.configCassonetti?.finitura || '',
                coibentazione: updatedProject.configCassonetti?.coibentazione || '',
                aSoffitto: updatedProject.configCassonetti?.aSoffitto || '',
                // Campi Finstral esistenti
                cassonettoCheck: updatedProject.configCassonetti?.cassonettoCheck,
                cassonettoText: updatedProject.configCassonetti?.cassonettoText || '',
                posaCheck: updatedProject.configCassonetti?.posaCheck,
                posaText: updatedProject.configCassonetti?.posaText || '',
                posa: updatedProject.configCassonetti?.posa || '',
                colore: updatedProject.configCassonetti?.colore || '',
                isolamentoPosaclima: updatedProject.configCassonetti?.isolamentoPosaclima || false,
                // v5.35: Nuovi campi per calcolo prezzi Finstral
                materialeCass: updatedProject.configCassonetti?.materialeCass || '',
                codiceCass: updatedProject.configCassonetti?.codiceCass || '',
                gruppoColoreCass: updatedProject.configCassonetti?.gruppoColoreCass || '',
                coloreCass: updatedProject.configCassonetti?.coloreCass || '', // v5.54
                coloreDaInfisso: updatedProject.configCassonetti?.coloreDaInfisso !== false, // v5.54 default true
                codiceIsolamento: updatedProject.configCassonetti?.codiceIsolamento || ''
            },
            
            // BRM CASSONETTI
            brmConfigCassonetti: {
                misuraBaseL: updatedProject.brmConfigCassonetti?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigCassonetti?.operazioneL || '',
                valoreL: updatedProject.brmConfigCassonetti?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigCassonetti?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigCassonetti?.operazioneH || '',
                valoreH: updatedProject.brmConfigCassonetti?.valoreH || '',
                misuraBaseC: updatedProject.brmConfigCassonetti?.misuraBaseC || '',
                operazioneC: updatedProject.brmConfigCassonetti?.operazioneC || '',
                valoreC: updatedProject.brmConfigCassonetti?.valoreC || '',
                misuraBaseB: updatedProject.brmConfigCassonetti?.misuraBaseB || '',
                operazioneB: updatedProject.brmConfigCassonetti?.operazioneB || '',
                valoreB: updatedProject.brmConfigCassonetti?.valoreB || '',
                SRSX: updatedProject.brmConfigCassonetti?.SRSX || '',
                SRDX: updatedProject.brmConfigCassonetti?.SRDX || '',
                ZSX: updatedProject.brmConfigCassonetti?.ZSX || '',
                ZDX: updatedProject.brmConfigCassonetti?.ZDX || '',
                note: updatedProject.brmConfigCassonetti?.note || ''
            },
            
            // ğŸ”’ v5.85: CONFIG GRATE ERRECI
            configGrate: {
                azienda: updatedProject.configGrate?.azienda || 'Erreci',
                linea: updatedProject.configGrate?.linea || '',
                modello: updatedProject.configGrate?.modello || '',
                tipoApertura: updatedProject.configGrate?.tipoApertura || '',
                colore: updatedProject.configGrate?.colore || '',
                tipoTelaio: updatedProject.configGrate?.tipoTelaio || 'A',
                snodo: updatedProject.configGrate?.snodo || '400',
                altezzaCilindro: updatedProject.configGrate?.altezzaCilindro || '600',
                accessori: updatedProject.configGrate?.accessori || []
            },
            brmConfigGrate: {
                misuraBaseL: updatedProject.brmConfigGrate?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigGrate?.operazioneL || '',
                valoreL: updatedProject.brmConfigGrate?.valoreL || '',
                misuraBaseH: updatedProject.brmConfigGrate?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigGrate?.operazioneH || '',
                valoreH: updatedProject.brmConfigGrate?.valoreH || '',
                note: updatedProject.brmConfigGrate?.note || ''
            },
            
            // RILIEVO CASSONETTI - ğŸ”„ v5.743: Sistema 3 stati
            rilievoCassonetti: {
                materiale: updatedProject.rilievoCassonetti?.materiale || '',
                togliere: updatedProject.rilievoCassonetti?.togliere ?? null,
                smaltimento: updatedProject.rilievoCassonetti?.smaltimento ?? null,
                note: updatedProject.rilievoCassonetti?.note || ''
            },
            
            // ğŸªŸ v5.64: CONFIG CLICK ZIP GIBUS
            configClickZip: {
                modello: updatedProject.configClickZip?.modello || '',
                tessuto: updatedProject.configClickZip?.tessuto || '',
                coloreStruttura: updatedProject.configClickZip?.coloreStruttura || ''
            },
            
            // ğŸªŸ v5.64: BRM CLICK ZIP
            brmConfigClickZip: {
                misuraBaseL: updatedProject.brmConfigClickZip?.misuraBaseL || '',
                operazioneL: updatedProject.brmConfigClickZip?.operazioneL || '-',
                valoreL: updatedProject.brmConfigClickZip?.valoreL || '0',
                misuraBaseH: updatedProject.brmConfigClickZip?.misuraBaseH || '',
                operazioneH: updatedProject.brmConfigClickZip?.operazioneH || '-',
                valoreH: updatedProject.brmConfigClickZip?.valoreH || '0',
                misuraBaseLPF: updatedProject.brmConfigClickZip?.misuraBaseLPF || '',
                operazioneLPF: updatedProject.brmConfigClickZip?.operazioneLPF || '-',
                valoreLPF: updatedProject.brmConfigClickZip?.valoreLPF || '0',
                misuraBaseHPF: updatedProject.brmConfigClickZip?.misuraBaseHPF || '',
                operazioneHPF: updatedProject.brmConfigClickZip?.operazioneHPF || '-',
                valoreHPF: updatedProject.brmConfigClickZip?.valoreHPF || '0',
                note: updatedProject.brmConfigClickZip?.note || ''
            },
            
            // ğŸšª v5.61: CONFIG PORTE INTERNE (default progetto)
            configPorteInterne: updatedProject.configPorteInterne ? {
                azienda: updatedProject.configPorteInterne.azienda || '',
                linea: updatedProject.configPorteInterne.linea || '',
                collezione: updatedProject.configPorteInterne.collezione || '',
                finitura: updatedProject.configPorteInterne.finitura || '',
                telaio: updatedProject.configPorteInterne.telaio || '',
                spessoreMuro: updatedProject.configPorteInterne.spessoreMuro || '',
                manigliaAzienda: updatedProject.configPorteInterne.manigliaAzienda || '',
                manigliaModello: updatedProject.configPorteInterne.manigliaModello || '',
                manigliaFinitura: updatedProject.configPorteInterne.manigliaFinitura || ''
            } : null,
            
            // ğŸšª v5.10: configBlindate e configPortoncini RIMOSSI
            // Ora si configurano direttamente nella posizione (pos.ingresso)
            
            // POSIZIONI (con caratteristiche muro per posizione)
            // ğŸ”§ v5.88: EXPORT CENTRALIZZATO - usa export-utils.js (shared-database)
            // Tutti i prodotti vengono esportati automaticamente
            positions: typeof exportPositions !== 'undefined' 
                ? exportPositions(updatedProject.positions)
                : (updatedProject.positions || []).map(pos => JSON.parse(JSON.stringify(pos))),
            
            // ğŸ¨ FASE DISEGNI: Disegni progetto
            drawings: updatedProject.drawings || {
                general: [],
                stats: {
                    total: 0,
                    totalSize: 0,
                    lastUpdate: new Date().toISOString()
                }
            },
            
            // DATE
            created: updatedProject.created || new Date().toISOString(),
            updated: new Date().toISOString(),
            
            // ğŸ”§ v5.91: Stato progetto (preventivo/ordine/annullato)
            stato: updatedProject.stato || 'preventivo',
            
            // ğŸ†• v4.61: METADATA COMPLETO con versioning e history
            metadata: updatedProject.metadata || {
                version: 1,
                created: updatedProject.created || new Date().toISOString(),
                updated: new Date().toISOString(),
                device: {
                    id: localStorage.getItem('deviceId'),
                    name: localStorage.getItem('deviceName')
                },
                syncStatus: 'synced',
                changes: []
            }
        };
        
        // Genera nome file
        const fileName = `progetto-${updatedProject.id}.json`;
        const filePath = `progetti/${fileName}`;
        
        // Converti in JSON + Base64 (compatibile Safari iOS)
        const content = JSON.stringify(projectData, null, 2);
        
        // âœ… FIX iOS: Usa TextEncoder invece di btoa+unescape (piÃ¹ sicuro)
        let base64Content;
        try {
            // Metodo moderno (preferito)
            const encoder = new TextEncoder();
            const uint8Array = encoder.encode(content);
            base64Content = btoa(String.fromCharCode.apply(null, uint8Array));
        } catch (e) {
            // Fallback per browser vecchi
            base64Content = btoa(unescape(encodeURIComponent(content)));
        }
        
        // Verifica se file esiste giÃ  (per ottenere SHA)
        const checkUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
        
        console.log('ğŸ” Controllo esistenza file su GitHub...');
        console.log('ğŸ“ URL:', checkUrl);
        console.log('ğŸ”‘ Token (primi 10 char):', GITHUB_CONFIG.token.substring(0, 10) + '...');
        
        const checkResponse = await fetch(checkUrl, {
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        let sha = null;
        if (checkResponse.ok) {
            const existing = await checkResponse.json();
            sha = existing.sha;
            console.log('ğŸ“ File esiste giÃ  - Aggiornamento (SHA:', sha.substring(0, 10) + '...)');
        } else {
            console.log('ğŸ“„ File non esiste - Creazione nuovo (Status:', checkResponse.status, ')');
            if (checkResponse.status !== 404) {
                console.warn('âš ï¸ Status inaspettato:', checkResponse.status, checkResponse.statusText);
            }
        }
        
        // Upload file su GitHub
        const uploadUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
        
        console.log('ğŸ“¤ Inizio upload su GitHub...');
        console.log('ğŸ“ URL:', uploadUrl);
        console.log('ğŸ“¦ Dimensione contenuto:', content.length, 'caratteri');
        console.log('ğŸ“¦ Dimensione base64:', base64Content.length, 'caratteri');
        console.log('ğŸ”„ Tipo operazione:', sha ? 'UPDATE (con SHA)' : 'CREATE');
        
        const uploadResponse = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${GITHUB_CONFIG.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `${sha ? 'Update' : 'Create'} ${fileName}`,
                content: base64Content,
                branch: GITHUB_CONFIG.branch,
                ...(sha && { sha })
            })
        });
        
        console.log('ğŸ“¥ Risposta GitHub:', {
            ok: uploadResponse.ok,
            status: uploadResponse.status,
            statusText: uploadResponse.statusText
        });
        
        // ğŸ”„ v5.89: Retry migliorato per errore 409 Conflict (3 tentativi, delay progressivo)
        if (uploadResponse.status === 409) {
            console.warn('âš ï¸ Conflitto SHA - Avvio retry migliorato...');
            
            let retrySuccess = false;
            for (let attempt = 1; attempt <= 3; attempt++) {
                const delay = attempt * 500; // 500ms, 1000ms, 1500ms
                console.log(`ğŸ”„ Retry ${attempt}/3 dopo ${delay}ms...`);
                await new Promise(r => setTimeout(r, delay));
                
                try {
                    const retryCheckResponse = await fetch(checkUrl, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!retryCheckResponse.ok) continue;
                    
                    const currentFile = await retryCheckResponse.json();
                    const newSha = currentFile.sha;
                    console.log(`ğŸ”„ Attempt ${attempt}: nuovo SHA:`, newSha.substring(0, 10) + '...');
                    
                    const retryUploadResponse = await fetch(uploadUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update ${fileName} (retry ${attempt} after conflict)`,
                            content: base64Content,
                            branch: GITHUB_CONFIG.branch,
                            sha: newSha
                        })
                    });
                    
                    if (retryUploadResponse.ok) {
                        console.log(`âœ… Progetto salvato (retry ${attempt}): ${fileName}`);
                        retrySuccess = true;
                        break;
                    }
                } catch (retryErr) {
                    console.warn(`âš ï¸ Retry ${attempt} errore:`, retryErr.message);
                }
            }
            
            if (retrySuccess) return true;
            throw new Error('Retry 409 esaurito dopo 3 tentativi');
        }
        
        if (!uploadResponse.ok) {
            let errorMsg = 'Upload fallito';
            let errorDetails = null;
            try {
                const error = await uploadResponse.json();
                errorMsg = error.message || errorMsg;
                errorDetails = error;
                console.error('âŒ Dettagli errore GitHub:', error);
            } catch (e) {
                errorMsg = `HTTP ${uploadResponse.status}: ${uploadResponse.statusText}`;
                console.error('âŒ Impossibile parsare risposta errore');
            }
            console.error(`âŒ Upload fallito per ${project.id}:`, {
                status: uploadResponse.status,
                statusText: uploadResponse.statusText,
                error: errorMsg,
                errorDetails: errorDetails
            });
            throw new Error(errorMsg);
        }
        
        console.log(`âœ… Progetto salvato con successo: ${fileName}`);
        return true;
        
    } catch (error) {
        const projectName = project.name || project.client || project.id;
        console.error(`âŒ ERRORE upload progetto ${projectName}:`, {
            error: error.message,
            stack: error.stack,
            projectId: project.id,
            hasToken: !!GITHUB_CONFIG.token,
            tokenLength: GITHUB_CONFIG.token ? GITHUB_CONFIG.token.length : 0
        });
        
        // Notifica specifica all'utente
        let userMsg = `âŒ Upload fallito: ${projectName}`;
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
            userMsg = 'âš ï¸ Token GitHub non valido - Riconnetti';
        } else if (error.message.includes('404')) {
            userMsg = 'âš ï¸ Repository GitHub non trovato - Verifica configurazione';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            userMsg = 'âš ï¸ Errore connessione - Controlla rete';
        } else {
            userMsg = `âŒ ${error.message}`;
        }
        showNotification(userMsg, 'error', 5000);
        
        return false;
    }
}

async function downloadFromOneDrive() {
    console.log('ğŸ”½ downloadFromOneDrive: INIZIO');
    
    // Check 1: Token valido?
    console.log('ğŸ”½ Check token...');
    if (!await ensureValidToken()) {
        console.error('ğŸ”½ ERRORE: Token non valido');
        showNotification('âš ï¸ Riconnetti OneDrive', 'error');
        return false;
    }
    console.log('ğŸ”½ Token OK');
    
    try {
        state.onedrive.syncStatus = 'syncing';
        render();
        
        // Check 2: Percorso file
        const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
        const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}:/content`;
        console.log('ğŸ”½ Percorso file:', filePath);
        console.log('ğŸ”½ URL completo:', url);
        
        // Check 3: Notifica utente
        showNotification('ğŸ“¥ Download da OneDrive in corso...', 'info', 3000);
        
        // Check 4: Fetch
        console.log('ğŸ”½ Avvio fetch...');
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${state.onedrive.accessToken}`
            }
        });
        console.log('ğŸ”½ Fetch completato. Status:', response.status);
        
        if (!response.ok) {
            if (response.status === 404) {
                console.log('ğŸ”½ File non trovato (404). Primo upload?');
                showNotification('ğŸ“¤ File non trovato su OneDrive. Primo upload...', 'info');
                return await uploadToOneDrive();
            }
            console.error('ğŸ”½ ERRORE HTTP:', response.status, response.statusText);
            throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }
        
        // Check 5: Parse JSON
        console.log('ğŸ”½ Download OK. Parsing JSON...');
        const cloudData = await response.json();
        console.log('ğŸ”½ JSON parsed. Progetti trovati:', cloudData.projects?.length || 0);
        
        // Check 6: Validazione dati
        if (!cloudData.projects || !Array.isArray(cloudData.projects)) {
            console.error('ğŸ”½ ERRORE: Dati non validi. projects non Ã¨ array');
            throw new Error('Dati OneDrive non validi');
        }
        
        // Check 7: Backup locale
        console.log('ğŸ”½ Creazione backup locale...');
        if (state.onedrive.autoBackupEnabled) {
            createBackup('Pre-sync OneDrive');
        }
        
        // Check 8: Merge dati
        console.log('ğŸ”½ Merge dati preservando token...');
        const currentTokens = {
            accessToken: state.onedrive.accessToken,
            refreshToken: state.onedrive.refreshToken,
            tokenExpiry: state.onedrive.tokenExpiry
        };
        
        state = {
            ...cloudData,
            onedrive: {
                ...cloudData.onedrive,
                ...currentTokens,
                connected: true
            }
        };
        
        state.onedrive.lastSyncTime = Date.now();
        state.onedrive.syncStatus = 'synced';
        
        // Check 9: Salvataggio
        console.log('ğŸ”½ Salvataggio state...');
        saveState();
        
        // Check 10: Render
        console.log('ğŸ”½ Render UI...');
        render();
        
        // Check 11: Notifica successo
        console.log('ğŸ”½ DOWNLOAD COMPLETATO! Progetti:', state.projects.length);
        showNotification(`âœ… ${state.projects.length} progetti scaricati da OneDrive!`, 'success', 3000);
        
        return true;
        
    } catch (error) {
        console.error('ğŸ”½ ERRORE DOWNLOAD:', error);
        console.error('ğŸ”½ Error message:', error.message);
        console.error('ğŸ”½ Error stack:', error.stack);
        
        state.onedrive.syncStatus = 'error';
        render();
        
        // Notifica con dettaglio errore
        showNotification(`âŒ Errore download: ${error.message}`, 'error', 5000);
        return false;
    }
}

// Variabile globale per tracciare l'ultimo sync
let lastSyncAttempt = 0;
const MIN_SYNC_INTERVAL = 10000; // Minimo 10 secondi tra sync

async function performSync() {
    // Previeni sync troppo frequenti
    const now = Date.now();
    if (now - lastSyncAttempt < MIN_SYNC_INTERVAL) {
        console.log('Sync skipped - troppo frequente');
        return false;
    }
    lastSyncAttempt = now;
    
    if (!state.onedrive.connected) {
        showNotification('âš ï¸ Configura GitHub prima', 'info');
        // openSyncSettings(); // FASE 027K: Funzione OneDrive deprecata
        return;
    }
    
    try {
        // Controlla quale versione Ã¨ piÃ¹ recente
        const cloudMeta = await getCloudFileMetadata();
        
        if (!cloudMeta) {
            // File non esiste, upload
            return await uploadToOneDrive();
        }
        
        const localModified = state.metadata?.lastModified || 0;
        const cloudModified = new Date(cloudMeta.lastModifiedDateTime).getTime();
        
        if (cloudModified > localModified + 60000) { // Cloud piÃ¹ recente di 1 minuto
            // Scarica da cloud
            return await downloadFromOneDrive();
        } else if (localModified > cloudModified) {
            // Carica su cloud
            return await uploadToOneDrive();
        } else {
            // Sincronizzati
            state.onedrive.syncStatus = 'synced';
            state.onedrive.lastSyncTime = Date.now();
            // saveState(); // RIMOSSO - non necessario qui
            // Non mostrare notifica se giÃ  sincronizzato
            return true;
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        state.onedrive.syncStatus = 'error';
        showNotification('âŒ Errore sincronizzazione', 'error');
        return false;
    }
}

async function getCloudFileMetadata() {
    try {
        if (!await ensureValidToken()) {
            return null;
        }
        
        const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
        const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
        
        const response = await fetch(url, {
            headers: {
                'Authorization': `Bearer ${state.onedrive.accessToken}`
            }
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                return null; // File non esiste
            }
            throw new Error(`Metadata fetch failed: ${response.status}`);
        }
        
        return await response.json();
        
    } catch (error) {
        console.error('Metadata fetch error:', error);
        return null;
    }
}

// â”€â”€â”€ AUTO SYNC â”€â”€â”€

function startAutoSync() {
    if (!state.onedrive.connected || !state.onedrive.autoSyncEnabled) {
        return;
    }
    
    stopAutoSync(); // Pulisci timer esistente
    
    // USA INTERVALLO SICURO DI 5 MINUTI INVECE DI CONFIG
    const SAFE_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minuti fissi
    
    syncInterval = setInterval(async () => {
        if (state.onedrive.connected && state.onedrive.autoSyncEnabled) {
            console.log('Auto-sync triggered at', new Date().toLocaleTimeString());
            await performSync();
        }
    }, SAFE_SYNC_INTERVAL);
    
    console.log('Auto-sync attivata (ogni 5 min effettivi)');
}

function stopAutoSync() {
    if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
        console.log('Auto-sync disattivata');
    }
}

// â”€â”€â”€ UI FUNCTIONS â”€â”€â”€

async function testOneDriveConnection() {
    console.log('ğŸ§ª TEST CONNESSIONE ONEDRIVE');
    showNotification('ğŸ§ª Test connessione in corso...', 'info');
    
    try {
        // Test 1: Token valido?
        if (!state.onedrive.connected) {
            throw new Error('OneDrive non connesso');
        }
        
        if (!state.onedrive.accessToken) {
            throw new Error('Access token mancante');
        }
        
        console.log('âœ… Token presente');
        
        // Test 2: Verifica scadenza token
        if (state.onedrive.tokenExpiry && Date.now() >= state.onedrive.tokenExpiry) {
            console.log('âš ï¸ Token scaduto, refresh...');
            await refreshAccessToken();
        }
        
        // Test 3: Test API Microsoft Graph
        console.log('ğŸ§ª Test API Microsoft Graph...');
        const testUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive`;
        const testResponse = await fetch(testUrl, {
            headers: {
                'Authorization': `Bearer ${state.onedrive.accessToken}`
            }
        });
        
        if (!testResponse.ok) {
            throw new Error(`API test failed: ${testResponse.status}`);
        }
        
        console.log('âœ… API Microsoft Graph OK');
        
        // Test 4: Controlla se cartella OpenPorte esiste
        console.log('ğŸ§ª Controllo cartella OpenPorte...');
        const folderUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${ONEDRIVE_CONFIG.folderPath}`;
        const folderResponse = await fetch(folderUrl, {
            headers: {
                'Authorization': `Bearer ${state.onedrive.accessToken}`
            }
        });
        
        if (folderResponse.ok) {
            console.log('âœ… Cartella OpenPorte trovata');
        } else if (folderResponse.status === 404) {
            console.log('âš ï¸ Cartella OpenPorte non esiste');
        }
        
        // Test 5: Controlla se file data.json esiste
        console.log('ğŸ§ª Controllo file data.json...');
        const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
        const fileUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
        const fileResponse = await fetch(fileUrl, {
            headers: {
                'Authorization': `Bearer ${state.onedrive.accessToken}`
            }
        });
        
        if (fileResponse.ok) {
            const fileInfo = await fileResponse.json();
            console.log('âœ… File data.json trovato');
            console.log('ğŸ“„ Size:', fileInfo.size, 'bytes');
            console.log('ğŸ“… Modified:', fileInfo.lastModifiedDateTime);
            showNotification(`âœ… Test OK! File trovato (${Math.round(fileInfo.size/1024)}KB)`, 'success', 3000);
        } else if (fileResponse.status === 404) {
            console.log('âš ï¸ File data.json non esiste su OneDrive');
            showNotification('âš ï¸ File non trovato su OneDrive. Carica prima dal PC!', 'error', 5000);
        } else {
            throw new Error(`File check failed: ${fileResponse.status}`);
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ TEST FALLITO:', error);
        showNotification(`âŒ Test fallito: ${error.message}`, 'error', 5000);
        return false;
    }
}

// ğŸ“¦ FASE 027K: Mostra impostazioni GitHub
function openGitHubSettings() {
    // Assicura che github structure esista
    if (!state.github) {
        state.github = {
            connected: false,
            token: null,
            lastSyncTime: null,
            syncStatus: 'disconnected',
            autoSyncEnabled: true,
            autoBackupEnabled: true,
            syncNotifications: true
        };
    }
    
    const modal = document.createElement('div');
    modal.className = 'sync-settings-modal';
    modal.innerHTML = `
        <div class="sync-settings-dialog">
            <div class="sync-settings-header">
                <h3>ğŸ“¦ Impostazioni GitHub</h3>
                <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">âœ•</button>
            </div>
            
            <div class="sync-account">
                ${state.github.connected ? `
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            ğŸŸ¢ ${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            ${state.github.lastSyncTime ? 
                                'Ultima sync: ' + getTimeSince(state.github.lastSyncTime) : 
                                'Mai sincronizzato'}
                        </div>
                    </div>
                    <button onclick="disconnectGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-secondary">
                        Disconnetti
                    </button>
                ` : `
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            âšª Non configurato
                        </div>
                        <div style="font-size: 12px; color: #64748b;">
                            Inserisci token per sincronizzazione
                        </div>
                    </div>
                    <button onclick="showGitHubTokenInput(); this.closest('.sync-settings-modal').remove();" class="btn-primary">
                        ğŸ”‘ Configura
                    </button>
                `}
            </div>
            
            ${state.github.connected ? `
                <div class="sync-options">
                    <label>
                        <input type="checkbox" ${state.github.autoSyncEnabled ? 'checked' : ''} 
                               onchange="state.github.autoSyncEnabled = this.checked; saveState();">
                        <span>Sincronizzazione automatica</span>
                    </label>
                    
                    <label>
                        <input type="checkbox" ${state.github.autoBackupEnabled ? 'checked' : ''} 
                               onchange="state.github.autoBackupEnabled = this.checked; saveState();">
                        <span>Backup automatico su modifica</span>
                    </label>
                    
                    <label>
                        <input type="checkbox" ${state.github.syncNotifications ? 'checked' : ''} 
                               onchange="state.github.syncNotifications = this.checked; saveState();">
                        <span>Notifiche sincronizzazione</span>
                    </label>
                </div>
                
                <div class="sync-actions">
                    <button onclick="manualDownloadFromGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-sync" style="background: #3b82f6;">
                        â¬‡ï¸ Scarica da GitHub
                    </button>
                    <button onclick="uploadToGitHub(); this.closest('.sync-settings-modal').remove();" class="btn-sync">
                        â¬†ï¸ Carica su GitHub
                    </button>
                </div>
            ` : ''}
            
            <div class="sync-info">
                <p><strong>â„¹ï¸ Come funziona:</strong></p>
                <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                    <li>Backup automatico su GitHub ad ogni modifica</li>
                    <li>Sincronizzazione con dashboard web</li>
                    <li>I dati locali sono sempre disponibili offline</li>
                    <li>Versioning automatico (cronologia modifiche)</li>
                </ul>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Chiudi con click fuori
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function showOneDriveSetupInstructions() {
    const modal = document.createElement('div');
    modal.className = 'sync-settings-modal';
    modal.innerHTML = `
        <div class="sync-settings-dialog" style="max-width: 600px;">
            <div class="sync-settings-header">
                <h3>âš™ï¸ Setup OneDrive</h3>
                <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">âœ•</button>
            </div>
            
            <div style="padding: 20px; line-height: 1.6;">
                <p><strong>Per abilitare OneDrive sync:</strong></p>
                
                <ol style="margin: 16px 0; padding-left: 20px;">
                    <li style="margin: 12px 0;">
                        Vai su <a href="https://portal.azure.com" target="_blank" style="color: #2563eb;">
                            Azure Portal
                        </a>
                    </li>
                    <li style="margin: 12px 0;">
                        Vai su "App registrations" â†’ "New registration"
                    </li>
                    <li style="margin: 12px 0;">
                        Nome app: <strong>Open Porte</strong>
                    </li>
                    <li style="margin: 12px 0;">
                        Supported account types: <strong>Accounts in any organizational directory and personal Microsoft accounts</strong>
                    </li>
                    <li style="margin: 12px 0;">
                        Redirect URI: <strong>${window.location.origin}</strong>
                    </li>
                    <li style="margin: 12px 0;">
                        Copia il <strong>Client ID</strong> generato
                    </li>
                    <li style="margin: 12px 0;">
                        Modifica il file HTML sostituendo <code>YOUR_CLIENT_ID_HERE</code> con il tuo Client ID
                    </li>
                </ol>
                
                <p style="margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 13px;">
                    <strong>âš ï¸ Nota:</strong> Questo setup Ã¨ necessario solo una volta. Il Client ID puÃ² essere condiviso tra dispositivi.
                </p>
            </div>
            
            <div style="text-align: center; padding: 20px;">
                <button onclick="this.closest('.sync-settings-modal').remove()" class="btn-primary">
                    Ho capito
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function getDeviceId() {
    let deviceId = localStorage.getItem('deviceId');
    if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
    }
    return deviceId;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ FASE DISEGNI: GESTIONE DISEGNI NOTABILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DRAWING_LIMITS = {
    maxFileSize: 5 * 1024 * 1024,      // 5 MB
    maxProjectSize: 20 * 1024 * 1024,  // 20 MB
    maxDrawingsPerProject: 50,
    maxDrawingsPerPosition: 10,
    thumbnailSize: 200,
    thumbnailQuality: 0.7
};

// Genera ID univoco per disegno
function generateDrawingId() {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 8);
    return `drw-${timestamp}-${random}`;
}

// Conta disegni totali progetto
function getDrawingsCount(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return 0;
    
    let count = 0;
    
    // Disegni generali
    if (project.drawings?.general) {
        count += project.drawings.general.length;
    }
    
    // Disegni posizioni
    if (project.positions) {
        project.positions.forEach(pos => {
            if (pos.drawings) {
                count += pos.drawings.length;
            }
        });
    }
    
    return count;
}

// Calcola dimensione totale disegni
function calculateTotalDrawingsSize(project) {
    let total = 0;
    
    if (project.drawings?.general) {
        total += project.drawings.general.reduce((sum, d) => sum + (d.size || 0), 0);
    }
    
    if (project.positions) {
        project.positions.forEach(pos => {
            if (pos.drawings) {
                total += pos.drawings.reduce((sum, d) => sum + (d.size || 0), 0);
            }
        });
    }
    
    return total;
}

// Formatta dimensione file
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// Converti file in base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Genera thumbnail da immagine
function generateThumbnail(file, maxSize = 200) {
    return new Promise((resolve, reject) => {
        if (!file.type.startsWith('image/')) {
            resolve(null);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const scale = Math.min(maxSize / img.width, maxSize / img.height);
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                resolve(canvas.toDataURL('image/jpeg', DRAWING_LIMITS.thumbnailQuality));
            };
            img.onerror = () => resolve(null);
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Valida file disegno
function validateDrawingFile(file, project) {
    const errors = [];
    
    // Tipo file
    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
        errors.push('Formato non supportato. Usa PNG, JPG o PDF.');
    }
    
    // Dimensione singolo file
    if (file.size > DRAWING_LIMITS.maxFileSize) {
        errors.push(`File troppo grande. Max ${formatFileSize(DRAWING_LIMITS.maxFileSize)}`);
    }
    
    // Dimensione totale progetto
    const currentSize = calculateTotalDrawingsSize(project);
    if (currentSize + file.size > DRAWING_LIMITS.maxProjectSize) {
        const available = DRAWING_LIMITS.maxProjectSize - currentSize;
        errors.push(`Spazio insufficiente. Disponibili ${formatFileSize(available)}`);
    }
    
    // Numero disegni
    const currentCount = getDrawingsCount(project.id);
    if (currentCount >= DRAWING_LIMITS.maxDrawingsPerProject) {
        errors.push(`Limite disegni raggiunto (${DRAWING_LIMITS.maxDrawingsPerProject})`);
    }
    
    return {
        valid: errors.length === 0,
        errors
    };
}

// Migra progetti esistenti
function migrateProjectDrawings(project) {
    if (!project.drawings) {
        project.drawings = {
            general: [],
            stats: {
                total: 0,
                totalSize: 0,
                lastUpdate: new Date().toISOString()
            }
        };
    }
    
    if (project.positions) {
        project.positions.forEach(pos => {
            if (!pos.drawings) {
                pos.drawings = [];
            }
        });
    }
    
    return project;
}

// Aggiorna statistiche disegni
function updateDrawingsStats(project) {
    const total = getDrawingsCount(project.id);
    const totalSize = calculateTotalDrawingsSize(project);
    
    if (!project.drawings) {
        project.drawings = { general: [] };
    }
    
    project.drawings.stats = {
        total,
        totalSize,
        lastUpdate: new Date().toISOString()
    };
}

// Naviga a pagina disegni
function navigateToDrawings() {
    state.screen = 'drawings';
    render();
}

// Ottieni dimensioni immagine
function getImageDimensions(dataUrl) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve({ width: img.width, height: img.height });
        img.onerror = () => resolve(null);
        img.src = dataUrl;
    });
}

// Aggiungi disegno al progetto
async function addDrawingToProject(file, description = '', linkedPositions = []) {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) {
        showNotification('âŒ Progetto non trovato', 'error');
        return false;
    }
    
    // Migra struttura se necessario
    migrateProjectDrawings(project);
    
    // Valida file
    const validation = validateDrawingFile(file, project);
    if (!validation.valid) {
        showNotification('âŒ ' + validation.errors[0], 'error');
        return false;
    }
    
    try {
        showNotification('ğŸ“¤ Caricamento in corso...', 'info');
        
        // Converti in base64
        const data = await fileToBase64(file);
        
        // Genera thumbnail per immagini
        const thumbnail = await generateThumbnail(file);
        
        // Crea oggetto disegno
        const drawing = {
            id: generateDrawingId(),
            name: file.name.replace(/\.[^/.]+$/, ''), // Rimuovi estensione
            description,
            type: file.type,
            size: file.size,
            data,
            thumbnail,
            uploadDate: new Date().toISOString(),
            linkedPositions,
            metadata: {
                originalName: file.name,
                source: 'Upload',
                dimensions: file.type.startsWith('image/') ? await getImageDimensions(data) : null
            }
        };
        
        // Aggiungi a progetto
        project.drawings.general.push(drawing);
        
        // Aggiorna statistiche
        updateDrawingsStats(project);
        
        // Salva
        saveToLocalStorage();
        
        showNotification('âœ… Disegno aggiunto', 'success');
        render();
        
        return true;
        
    } catch (error) {
        console.error('Errore aggiunta disegno:', error);
        showNotification('âŒ Errore caricamento: ' + error.message, 'error');
        return false;
    }
}

// Elimina disegno
function deleteDrawing(drawingId, positionId = null) {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) return false;
    
    if (positionId) {
        // Disegno di posizione
        const position = project.positions?.find(p => p.id === positionId);
        if (position?.drawings) {
            position.drawings = position.drawings.filter(d => d.id !== drawingId);
        }
    } else {
        // Disegno generale
        if (project.drawings?.general) {
            project.drawings.general = project.drawings.general.filter(d => d.id !== drawingId);
        }
    }
    
    updateDrawingsStats(project);
    saveToLocalStorage();
    showNotification('âœ… Disegno eliminato', 'success');
    render();
    
    return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ FASE 021: MENU LATERALE HAMBURGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Genera HTML menu laterale con header compatto
function renderProjectMenu() {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) return '';
    
    // Determina quali prodotti sono selezionati
    const hasInfissi = project.prodotti?.infissi || false;
    const hasPersiane = project.prodotti?.persiane || false;
    const hasTapparelle = project.prodotti?.tapparelle || false;
    const hasZanzariere = project.prodotti?.zanzariere || false;
    const hasCassonetti = project.prodotti?.cassonetti || false;
    const hasBlindate = project.prodotti?.blindate || false;
    
    // Verifica prerequisiti per navigazione
    const canGoToPositions = hasInfissi || hasPersiane || hasTapparelle || 
                             hasZanzariere || hasCassonetti || hasBlindate;
    
    // Determina se sezione Ã¨ attiva
    const isStep1Active = state.setupStep === 1;
    const isStep2Active = state.setupStep === 2;
    const isStep3Active = state.setupStep === 3 && hasInfissi;
    const isStep4Active = state.setupStep === 4 && hasPersiane;
    const isStep5Active = state.setupStep === 5 && hasTapparelle;
    const isStep6Active = state.setupStep === 6 && hasZanzariere;
    const isStep7Active = state.setupStep === 7 && hasCassonetti;
    const isStep8Active = state.setupStep === 8 && hasBlindate;
    const isStep9Active = state.setupStep === 9;
    
    // Calcola completamento per ogni sezione
    const completamentoCliente = calcolaCompletamentoCliente(project);
    const completamentoSetup = calcolaCompletamentoSetup(project);
    const completamentoConfig = calcolaCompletamentoConfig(project);
    const completamentoPosizioni = calcolaCompletamentoPosizioni(project);
    
    // Stato menu Config (espanso o collassato)
    const configExpanded = state.configMenuExpanded || false;
    
    return `
        <!-- Header compatto fisso -->
        <header class="app-header">
            <button class="menu-toggle" onclick="toggleProjectMenu()">â˜°</button>
            <h1 class="app-title">
                ${project.clientName || 'Nuovo Progetto'}
                ${project.ambiente ? ` - ${project.ambiente}` : ''}
                <span style="margin-left: 1rem; padding: 0.25rem 0.75rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 0.75rem; font-weight: 600; vertical-align: middle;">v${APP_VERSION}</span>
            </h1>
            <div class="header-actions">
                <!-- ğŸ†• v5.742: Link Schizzo con pulsante modifica separato per iPad -->
                <div class="schizzo-container">
                    <button class="btn-schizzo ${project.linkSchizzo ? 'has-schizzo' : 'no-schizzo'}" 
                            onclick="${project.linkSchizzo ? `openSchizzo('${project.id}')` : `editLinkSchizzo('${project.id}')`}"
                            title="${project.linkSchizzo ? 'ğŸ“ Apri schizzo' : 'ğŸ“ Aggiungi schizzo'}">
                        ğŸ“ ${project.linkSchizzo ? 'SCHIZZO' : 'Schizzo'}
                    </button>
                    <button class="btn-schizzo-edit" 
                            onclick="editLinkSchizzo('${project.id}')"
                            title="Modifica link schizzo">
                        âœï¸
                    </button>
                </div>
                <button class="btn-icon" onclick="uploadToGitHub()" title="Sync GitHub">â˜ï¸</button>
                <button class="btn-icon" onclick="exportCurrentProjectJSON()" title="Export JSON">ğŸ’¾</button>
                <button class="btn-icon" onclick="printCurrentProjectPDF()" title="Export PDF">ğŸ–¨ï¸</button>
            </div>
        </header>
        
        <!-- Menu laterale progetto -->
        <aside class="side-menu-project ${state.projectMenuOpen ? 'open' : ''}" id="projectSideMenu">
            <!-- Header menu -->
            <div class="project-menu-header">
                <button class="project-menu-close" onclick="toggleProjectMenu()">âœ•</button>
                <span>MENU PROGETTO</span>
            </div>
            
            <!-- Info Progetto -->
            <div class="project-info-box">
                <div class="project-name">${project.clientName || 'Nuovo Progetto'}</div>
                ${project.ambiente ? `<div class="project-ambiente">${project.ambiente}</div>` : ''}
            </div>
            
            <!-- Navigazione Principale -->
            <div class="nav-section">
                <div class="nav-title">Navigazione</div>
                
                <!-- Cliente -->
                <div class="nav-item ${isStep1Active ? 'active' : ''}" 
                     onclick="navigateToStep(1); closeProjectMenu();">
                    <div class="nav-label">
                        <span class="nav-icon">ğŸ‘¤</span>
                        <span>Cliente</span>
                    </div>
                    ${renderCompletionBadge(completamentoCliente)}
                </div>
                
                <!-- Setup -->
                <div class="nav-item ${isStep2Active ? 'active' : ''}" 
                     onclick="navigateToStep(2); closeProjectMenu();">
                    <div class="nav-label">
                        <span class="nav-icon">ğŸ› ï¸</span>
                        <span>Setup</span>
                    </div>
                    ${renderCompletionBadge(completamentoSetup)}
                </div>
                
                <!-- Config (con submenu) -->
                <div class="nav-item ${(isStep3Active || isStep4Active || isStep5Active || isStep6Active || isStep7Active) ? 'active' : ''}" 
                     onclick="toggleConfigMenu(event)">
                    <div class="nav-label">
                        <span class="nav-icon">âš™ï¸</span>
                        <span>Config</span>
                        <span style="margin-left: auto; font-size: 12px;">${configExpanded ? 'â–¼' : 'â–¶'}</span>
                    </div>
                    ${renderCompletionBadge(completamentoConfig)}
                </div>
                
                <!-- Submenu Config -->
                <div class="nav-submenu ${configExpanded ? 'open' : ''}" id="configSubmenu">
                    ${hasInfissi ? `
                        <div class="nav-submenu-item ${isStep3Active ? 'active' : ''}" 
                             onclick="navigateToStep(3); closeProjectMenu();">
                            <span>ğŸªŸ Infissi</span>
                            ${renderCompletionBadge(calcolaCompletamentoInfissi(project), true)}
                        </div>
                    ` : ''}
                    
                    ${hasPersiane ? `
                        <div class="nav-submenu-item ${isStep4Active ? 'active' : ''}" 
                             onclick="navigateToStep(4); closeProjectMenu();">
                            <span>ğŸšª Persiane</span>
                            ${renderCompletionBadge(calcolaCompletamentoPersiane(project), true)}
                        </div>
                    ` : ''}
                    
                    ${hasTapparelle ? `
                        <div class="nav-submenu-item ${isStep5Active ? 'active' : ''}" 
                             onclick="navigateToStep(5); closeProjectMenu();">
                            <span>ğŸšï¸ Tapparelle</span>
                            ${renderCompletionBadge(calcolaCompletamentoTapparelle(project), true)}
                        </div>
                    ` : ''}
                    
                    ${hasZanzariere ? `
                        <div class="nav-submenu-item ${isStep6Active ? 'active' : ''}" 
                             onclick="navigateToStep(6); closeProjectMenu();">
                            <span>ğŸ¦Ÿ Zanzariere</span>
                            ${renderCompletionBadge(calcolaCompletamentoZanzariere(project), true)}
                        </div>
                    ` : ''}
                    
                    ${hasCassonetti ? `
                        <div class="nav-submenu-item ${isStep7Active ? 'active' : ''}" 
                             onclick="navigateToStep(7); closeProjectMenu();">
                            <span>ğŸ“¦ Cassonetti</span>
                            ${renderCompletionBadge(calcolaCompletamentoCassonetti(project), true)}
                        </div>
                    ` : ''}
                    
                    ${hasBlindate ? `
                        <div class="nav-submenu-item ${isStep8Active ? 'active' : ''}" 
                             onclick="navigateToStep(8); closeProjectMenu();">
                            <span>ğŸ” Blindate</span>
                        </div>
                    ` : ''}
                    
                    ${!hasInfissi && !hasPersiane && !hasTapparelle && !hasZanzariere && !hasCassonetti && !hasBlindate ? `
                        <div style="padding: 12px 20px 12px 52px; color: #64748b; font-size: 14px; font-style: italic;">
                            Nessun prodotto selezionato
                        </div>
                    ` : ''}
                </div>
                
                <!-- Posizioni -->
                <div class="nav-item ${!canGoToPositions ? 'disabled' : ''} ${isStep9Active ? 'active' : ''}" 
                     onclick="${canGoToPositions ? 'navigateToPositions(); closeProjectMenu();' : ''}">
                    <div class="nav-label">
                        <span class="nav-icon">ğŸ“</span>
                        <span>Posizioni</span>
                    </div>
                    ${canGoToPositions ? renderCompletionBadge(completamentoPosizioni) : ''}
                </div>
                
                <!-- ğŸ¨ FASE DISEGNI: Disegni -->
                <div class="nav-item ${state.screen === 'drawings' ? 'active' : ''}" 
                     onclick="navigateToDrawings(); closeProjectMenu();">
                    <div class="nav-label">
                        <span class="nav-icon">ğŸ¨</span>
                        <span>Disegni</span>
                    </div>
                    ${(() => {
                        const count = getDrawingsCount(state.currentProject);
                        return count > 0 ? `<span class="count-badge">${count}</span>` : '';
                    })()}
                </div>
                
                
                <!-- ğŸ“¦ FASE 027K: GitHub Sync -->
                <div style="border-top: 1px solid var(--menu-border); margin: 12px 0;"></div>
                
                <div class="nav-item" onclick="openGitHubSettings(); closeProjectMenu();">
                    <div class="nav-label">
                        <span class="nav-icon">ğŸ“¦</span>
                        <span>GitHub</span>
                    </div>
                    <span class="sync-badge" id="syncBadge">
                        ${renderGitHubBadge()}
                    </span>
                </div>
                
                ${state.github.connected ? `
                    <div style="padding: 8px 20px; font-size: 12px; color: var(--menu-text-sec);">
                        <div>ğŸŸ¢ ${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}</div>
                        ${state.github.lastSyncTime ? `
                            <div style="margin-top: 4px;">
                                ğŸ”„ ${getTimeSince(state.github.lastSyncTime)}
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div style="padding: 8px 20px; font-size: 12px; color: #f59e0b;">
                        âš ï¸ Non configurato
                    </div>
                `}
            </div>
            
            <!-- Azioni Rapide -->
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="exportCurrentProjectExcel(); closeProjectMenu();">
                    ğŸ“Š Excel Completo
                </button>
                <button class="menu-action-btn" onclick="exportCurrentProjectJSON(); closeProjectMenu();">
                    ğŸ’¾ Esporta JSON
                </button>
                <button class="menu-action-btn" onclick="printCurrentProjectPDF(); closeProjectMenu();">
                    ğŸ–¨ï¸ Esporta PDF
                </button>
                <button class="menu-action-btn" onclick="importPosizioniJSON(); closeProjectMenu();">
                    ğŸ“¥ Importa Posizioni
                </button>
                <button class="menu-action-btn" onclick="showNewProjectModal();">
                    â• Nuovo Progetto
                </button>
                <button class="menu-action-btn primary" onclick="tornaAllaLista();">
                    â† Lista Progetti
                </button>
                
                <!-- ğŸ†• v5.739: Sezione Strumenti -->
                <div style="border-top: 2px solid var(--menu-border); margin: 16px 0 12px 0; padding-top: 12px;">
                    <div style="font-size: 11px; color: var(--menu-text-sec); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
                        ğŸ”§ Strumenti
                    </div>
                </div>
                <button class="menu-action-btn update-app-btn" onclick="forceUpdateApp();">
                    ğŸ”„ Aggiorna Versione App
                </button>
                <div style="font-size: 11px; color: var(--menu-text-sec); padding: 4px 0; text-align: center;">
                    Versione attuale: v${APP_VERSION}
                </div>
            </div>
        </aside>
        
        <!-- Overlay -->
        <div class="menu-overlay ${state.projectMenuOpen ? 'active' : ''}" 
             id="projectMenuOverlay" 
             onclick="closeProjectMenu()"></div>
    `;
}

// Funzioni di gestione menu laterale
function toggleProjectMenu() {
    state.projectMenuOpen = !state.projectMenuOpen;
    render();
}

function closeProjectMenu() {
    state.projectMenuOpen = false;
    render();
}
window.closeProjectMenu = closeProjectMenu; // ğŸ”§ v5.626: Esponi subito a window

// ğŸ†• v5.720: Chiude menu senza render (per evitare che modal venga resettato)
function closeProjectMenuNoRender() {
    state.projectMenuOpen = false;
    // Chiudi visivamente il menu e l'overlay senza ricreare il DOM
    const menu = document.getElementById('projectSideMenu');
    const overlay = document.getElementById('projectMenuOverlay');
    if (menu) menu.classList.remove('open');
    if (overlay) overlay.classList.remove('active');
}
window.closeProjectMenuNoRender = closeProjectMenuNoRender;

function toggleConfigMenu(event) {
    if (event) event.stopPropagation();
    state.configMenuExpanded = !state.configMenuExpanded;
    render();
}

// Render badge completamento
function renderCompletionBadge(percentuale, mini = false) {
    if (percentuale === 0) return '';
    
    const dotColor = percentuale === 100 ? 'green' : 
                   percentuale >= 50 ? 'yellow' : 'red';
    
    if (mini) {
        return `<span class="completion-percent">${percentuale}%</span>`;
    }
    
    return `
        <div class="completion-badge">
            <div class="completion-dot ${dotColor}"></div>
            <span class="completion-percent">${percentuale}%</span>
        </div>
    `;
}

// Mantieni compatibilitÃ  nomi vecchi
const renderTopNavbar = renderProjectMenu;

// âœ… FASE 012 - FUNZIONI CALCOLO COMPLETAMENTO

// Calcola completamento sezione Cliente
function calcolaCompletamentoCliente(project) {
    if (!project) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 5; // Nome, Indirizzo, Telefono, Email, Ambiente
    
    if (project.clientName) campiCompilati++;
    if (project.clientAddress) campiCompilati++;
    if (project.clientPhone) campiCompilati++;
    if (project.clientEmail) campiCompilati++;
    if (project.ambiente) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

// Calcola completamento Setup
function calcolaCompletamentoSetup(project) {
    if (!project || !project.prodotti) return 0;
    
    // Almeno un prodotto selezionato = 100%
    const hasAnyProduct = project.prodotti.infissi || project.prodotti.persiane ||
                         project.prodotti.tapparelle || project.prodotti.zanzariere ||
                         project.prodotti.cassonetti;
    
    return hasAnyProduct ? 100 : 0;
}

// Calcola completamento Config generale
function calcolaCompletamentoConfig(project) {
    if (!project || !project.prodotti) return 0;
    
    let totaleCompletamento = 0;
    let prodottiSelezionati = 0;
    
    if (project.prodotti.infissi) {
        totaleCompletamento += calcolaCompletamentoInfissi(project);
        prodottiSelezionati++;
    }
    if (project.prodotti.persiane) {
        totaleCompletamento += calcolaCompletamentoPersiane(project);
        prodottiSelezionati++;
    }
    if (project.prodotti.tapparelle) {
        totaleCompletamento += calcolaCompletamentoTapparelle(project);
        prodottiSelezionati++;
    }
    if (project.prodotti.zanzariere) {
        totaleCompletamento += calcolaCompletamentoZanzariere(project);
        prodottiSelezionati++;
    }
    if (project.prodotti.cassonetti) {
        totaleCompletamento += calcolaCompletamentoCassonetti(project);
        prodottiSelezionati++;
    }
    
    if (prodottiSelezionati === 0) return 0;
    
    return Math.round(totaleCompletamento / prodottiSelezionati);
}

// Calcola completamento Posizioni
function calcolaCompletamentoPosizioni(project) {
    if (!project || !project.positions || project.positions.length === 0) return 0;
    
    let posizioniCompletate = 0;
    
    project.positions.forEach(pos => {
        // Una posizione Ã¨ completa se ha almeno nome e un prodotto con misure
        if (pos.name) {
            let hasMeasures = false;
            
            ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(tipo => {
                if (pos[tipo] && (pos[tipo].larghezza || pos[tipo].altezza)) {
                    hasMeasures = true;
                }
            });
            
            if (hasMeasures) posizioniCompletate++;
        }
    });
    
    return project.positions.length > 0 ? 
           Math.round((posizioniCompletate / project.positions.length) * 100) : 0;
}

// Funzioni specifiche per ogni prodotto
function calcolaCompletamentoInfissi(project) {
    if (!project.brmConfigInfissi) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 4;
    
    if (project.brmConfigInfissi.valoreL) campiCompilati++;
    if (project.brmConfigInfissi.valoreH) campiCompilati++;
    if (project.rilievoInfissi?.materiale) campiCompilati++;
    if (project.rilievoInfissi?.note) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

function calcolaCompletamentoPersiane(project) {
    if (!project.brmConfigPersiane) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 4;
    
    if (project.brmConfigPersiane.valoreL) campiCompilati++;
    if (project.brmConfigPersiane.valoreH) campiCompilati++;
    if (project.rilievoPersiane?.materiale) campiCompilati++;
    if (project.rilievoPersiane?.note) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

function calcolaCompletamentoTapparelle(project) {
    if (!project.brmConfigTapparelle) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 4;
    
    if (project.brmConfigTapparelle.valoreL) campiCompilati++;
    if (project.brmConfigTapparelle.valoreH) campiCompilati++;
    if (project.rilievoTapparelle?.materiale) campiCompilati++;
    if (project.rilievoTapparelle?.note) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

function calcolaCompletamentoZanzariere(project) {
    if (!project.brmConfigZanzariere) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 2;
    
    if (project.brmConfigZanzariere.valoreL) campiCompilati++;
    if (project.brmConfigZanzariere.valoreH) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

function calcolaCompletamentoCassonetti(project) {
    if (!project.brmConfigCassonetti) return 0;
    
    let campiCompilati = 0;
    let campiTotali = 4;
    
    if (project.brmConfigCassonetti.valoreL) campiCompilati++;
    if (project.brmConfigCassonetti.valoreC) campiCompilati++;
    if (project.brmConfigCassonetti.valoreB) campiCompilati++;
    if (project.rilievoCassonetti?.materiale) campiCompilati++;
    
    return Math.round((campiCompilati / campiTotali) * 100);
}

// Funzione per tornare alla lista progetti
function tornaAllaLista() {
    if (confirm('Vuoi tornare alla lista progetti? Le modifiche sono salvate automaticamente.')) {
        state.screen = 'list';
        state.currentProject = null;
        state.setupStep = 1;
        saveState();
        render();
    }
}
window.tornaAllaLista = tornaAllaLista; // ğŸ”§ v5.625: Esponi subito a window

// Toggle riepilogo rilievi

// Naviga a step specifico con validazione prerequisiti
function navigateToStep(stepNumber) {
    // Chiudi dropdown se aperto
    const dropdown = document.getElementById('configDropdown');
    if (dropdown) {
        dropdown.classList.add('hidden');
    }
    
    // Verifica se puÃ² navigare
    if (!canNavigateToStep(stepNumber)) {
        showNotification('âš ï¸ Completa prima i passaggi precedenti', 'warning');
        return;
    }
    
    // Cambia step e renderizza
    state.setupStep = stepNumber;
    saveState();
    render();
}

// Naviga direttamente a Step 9 (Posizioni)
function navigateToPositions() {
    // Chiudi dropdown se aperto
    const dropdown = document.getElementById('configDropdown');
    if (dropdown) {
        dropdown.classList.add('hidden');
    }
    
    const project = state.projects[state.currentProject];
    if (!project) return;
    
    // Verifica che ci sia almeno un prodotto selezionato
    const hasProducts = project.prodotti?.infissi || 
                        project.prodotti?.persiane || 
                        project.prodotti?.tapparelle || 
                        project.prodotti?.zanzariere || 
                        project.prodotti?.cassonetti;
    
    if (!hasProducts) {
        showNotification('âš ï¸ Seleziona almeno un prodotto nello Setup', 'warning');
        return;
    }
    
    // Salta direttamente a step 9
    state.setupStep = 9;
    saveState();
    render();
}

// Verifica se Ã¨ possibile navigare a uno step specifico
function canNavigateToStep(stepNumber) {
    const project = state.projects[state.currentProject];
    if (!project) return false;
    
    // Step 1-2 sempre accessibili
    if (stepNumber <= 2) {
        return true;
    }
    
    // Step 3-7: Config prodotti - verificare se prodotto selezionato
    if (stepNumber === 3) {
        return project.prodotti?.infissi || false;
    }
    if (stepNumber === 4) {
        return project.prodotti?.persiane || false;
    }
    if (stepNumber === 5) {
        return project.prodotti?.tapparelle || false;
    }
    if (stepNumber === 6) {
        return project.prodotti?.zanzariere || false;
    }
    if (stepNumber === 7) {
        return project.prodotti?.cassonetti || false;
    }
    
    // Step 9: Posizioni - almeno un prodotto selezionato
    if (stepNumber === 9) {
        return project.prodotti?.infissi || 
               project.prodotti?.persiane || 
               project.prodotti?.tapparelle || 
               project.prodotti?.zanzariere || 
               project.prodotti?.cassonetti;
    }
    
    return false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸ¯ FASE 28: Navigazione intelligente tra step dinamici
function getValidSteps(project) {
    const steps = [1, 2]; // Sempre presenti: Dati Cliente, Prodotti (include Muro)
    
    // Aggiungi solo gli step dei prodotti selezionati
    if (project.prodotti?.infissi) steps.push(3);
    if (project.prodotti?.persiane) steps.push(4);
    if (project.prodotti?.tapparelle) steps.push(5);
    if (project.prodotti?.zanzariere) steps.push(6);
    if (project.prodotti?.cassonetti) steps.push(7);
    if (project.prodotti?.clickZip) steps.push(8);  // ğŸªŸ v5.64 GIBUS Click Zip
    // ğŸšª v5.08: Blindate e Portoncini non hanno piÃ¹ step globale
    
    // Step finale sempre presente
    steps.push(9);
    
    return steps;
}

function getNextValidStep(currentStep, project) {
    const validSteps = getValidSteps(project);
    const currentIndex = validSteps.indexOf(currentStep);
    if (currentIndex !== -1 && currentIndex < validSteps.length - 1) {
        return validSteps[currentIndex + 1];
    }
    return currentStep; // Se siamo all'ultimo step, rimani lÃ¬
}

function getPrevValidStep(currentStep, project) {
    const validSteps = getValidSteps(project);
    const currentIndex = validSteps.indexOf(currentStep);
    if (currentIndex > 0) {
        return validSteps[currentIndex - 1];
    }
    return currentStep; // Se siamo al primo step, rimani lÃ¬
}

window.goToNextStep = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        // ğŸ”§ v5.87: Flush valori DOM prima di cambiare step
        // Senza questo, se l'utente digita e clicca Avanti senza blur, onchange non scatta
        flushDOMValues(project);
        
        state.setupStep = getNextValidStep(state.setupStep, project);
        saveState();
        render();
    }
};

// ğŸ”§ v5.87: Forza salvataggio valori DOM prima di cambiare step
function flushDOMValues(project) {
    // 1. Forza blur sull'input attivo â†’ scatta onchange sincrono
    const active = document.activeElement;
    if (active && (active.tagName === 'INPUT' || active.tagName === 'SELECT' || active.tagName === 'TEXTAREA')) {
        active.blur();
    }
    
    // 2. Annulla debounce pendente e salva subito
    if (typeof clientDataSaveTimer !== 'undefined') {
        clearTimeout(clientDataSaveTimer);
    }
    
    // 3. Step 1: backup diretto campi cliente dal DOM
    if (state.setupStep === 1) {
        if (!project.cliente) project.cliente = {};
        if (!project.clientData) project.clientData = {};
        
        // Leggi tutti gli input con onchange che chiama updateClienteField
        document.querySelectorAll('input, select, textarea').forEach(el => {
            const onch = el.getAttribute('onchange') || el.getAttribute('oninput') || '';
            if (onch.includes('updateClienteField')) {
                // Estrai field name: updateClienteField('nome', this.value) o simile
                const match = onch.match(/updateClienteField\(['"]([^'"]+)['"]/);
                if (match) {
                    const field = match[1];
                    const value = el.value || '';
                    if (project.cliente[field] !== value && value) {
                        project.cliente[field] = value;
                        project.clientData[field] = value;
                        console.log('ğŸ”§ flush cliente.' + field + ' = ' + value);
                    }
                }
            }
            // Nome progetto
            if (onch.includes("updateProject") && onch.includes("'name'")) {
                if (el.value && project.name !== el.value) {
                    project.name = el.value;
                    console.log('ğŸ”§ flush project.name = ' + el.value);
                }
            }
        });
        
        // Aggiorna project.client composito
        const nome = project.cliente.nome || '';
        const cognome = project.cliente.cognome || '';
        if (nome || cognome) {
            project.client = (nome + ' ' + cognome).trim();
        }
    }
}

window.goToPrevStep = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        state.setupStep = getPrevValidStep(state.setupStep, project);
        render();
    }
};

// ğŸ¯ FASE 25: Gestione Select con "Altro e scrivo"
function handleSelectWithCustom(projectId, field, selectId, inputId, value, options) {
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    
    if (!select || !input) return;
    
    if (value === '__ALTRO__') {
        // Mostra input personalizzato
        input.style.display = 'block';
        input.focus();
        // Non salvare ancora
    } else if (value) {
        // Opzione standard selezionata
        input.style.display = 'none';
        input.value = '';
        updateClientData(projectId, field, value);
    }
}

function handleConfigSelectWithCustom(projectId, configType, field, selectId, inputId, value) {
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    
    if (!select || !input) return;
    
    if (value === '__ALTRO__') {
        // Mostra input personalizzato
        input.style.display = 'block';
        input.focus();
    } else if (value) {
        // Opzione standard selezionata
        input.style.display = 'none';
        input.value = '';
        // Chiama la funzione di update appropriata
        const updateFnMap = {
            'persiane': updateConfigPersiane,
            'tapparelle': updateConfigTapparelle,
            'zanzariere': updateConfigZanzariere,
            'cassonetti': updateConfigCassonetti,
            'grate': updateConfigGrate  // ğŸ”’ v5.85
        };
        const updateFn = updateFnMap[configType];
        if (updateFn) {
            updateFn(projectId, field, value);
        }
    }
}

function handleProductSelectWithCustom(projectId, posId, productType, field, selectId, inputId, value) {
    console.log(`ğŸ¯ handleProductSelectWithCustom: productType=${productType}, field=${field}, value=${value}`);
    
    const select = document.getElementById(selectId);
    const input = document.getElementById(inputId);
    
    if (!select || !input) {
        console.error('âŒ Select o input non trovati:', selectId, inputId);
        return;
    }
    
    // ğŸ†• v4.24: Feedback visivo immediato per campo tipo obbligatorio
    if (field === 'tipo' && (productType === 'infisso' || productType === 'persiana')) {
        if (value === '' || value === '__ALTRO__') {
            // Vuoto o custom â†’ arancione
            select.classList.remove('border', 'bg-white');
            select.classList.add('border-2', 'border-orange-400', 'bg-orange-50');
        } else {
            // Compilato â†’ bianco
            select.classList.remove('border-2', 'border-orange-400', 'bg-orange-50');
            select.classList.add('border', 'bg-white');
        }
    }
    
    if (value === '__ALTRO__') {
        // Mostra input personalizzato
        input.style.display = 'block';
        input.focus();
    } else if (value) {
        // Opzione standard selezionata
        input.style.display = 'none';
        input.value = '';
        
        // ğŸ†• v4.95: Se cambia tipo persiana, ricalcola accessori
        if (productType === 'persiana' && field === 'tipo') {
            console.log(`ğŸ“Œ Chiamo updateTipoPersiana con value=${value}`);
            updateTipoPersiana(projectId, posId, value);
        } else {
            updateProduct(projectId, posId, productType, field, value);
        }
    }
}

// Notification System
function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-100 text-green-800 border-green-300',
        error: 'bg-red-100 text-red-800 border-red-300',
        info: 'bg-blue-100 text-blue-800 border-blue-300'
    };
    
    const notification = document.createElement('div');
    notification.className = `notification ${colors[type]} border-2`;
    notification.innerHTML = `<strong>${message}</strong>`;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 2000);
}
window.showNotification = showNotification; // ğŸ”§ v5.625: Esponi subito a window

// ğŸ¯ FASE 18A - SISTEMA VALIDAZIONE MISURE
function validateMisure(project, pos) {
    const errors = [];
    const warnings = [];
    
    // ğŸ†• v5.79: Tipo Apertura OBBLIGATORIO - usa OPZIONI_MURO
    if (typeof isValidOpzioneMuro !== 'undefined') {
        if (!isValidOpzioneMuro('tipoApertura', pos.tipoApertura)) {
            errors.push({
                field: 'tipoApertura',
                message: 'âš ï¸ Seleziona Tipo Apertura: F (Finestra) o PF (Porta-finestra)'
            });
        }
    } else {
        // Fallback se OPZIONI_MURO non caricato
        if (!pos.tipoApertura || (pos.tipoApertura !== 'F' && pos.tipoApertura !== 'PF')) {
            errors.push({
                field: 'tipoApertura',
                message: 'âš ï¸ Seleziona Tipo Apertura: F (Finestra) o PF (Porta-finestra)'
            });
        }
    }
    
    // ğŸ†• v5.79: Posizione Telaio OBBLIGATORIA - usa OPZIONI_MURO
    if (typeof isValidOpzioneMuro !== 'undefined') {
        if (!isValidOpzioneMuro('posizioneTelaio', pos.posizioneTelaio)) {
            errors.push({
                field: 'posizioneTelaio',
                message: 'âš ï¸ Seleziona Posizione Telaio: Filo Muro Int o Mazzetta'
            });
        }
    } else {
        // Fallback se OPZIONI_MURO non caricato
        if (!pos.posizioneTelaio || (pos.posizioneTelaio !== 'filo_muro' && pos.posizioneTelaio !== 'mazzetta')) {
            errors.push({
                field: 'posizioneTelaio',
                message: 'âš ï¸ Seleziona Posizione Telaio: Filo Muro Int o Mazzetta'
            });
        }
    }
    
    const misure = pos.misure || {};
    
    // Prendi caratteristiche muro (override o globali)
    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
        ? pos.caratteristicheMuroOverride 
        : project.caratteristicheMuro || {};
    
    const LF = parseFloat(misure.LF) || 0;
    const HF = parseFloat(misure.HF) || 0;
    const LVT = parseFloat(misure.LVT) || 0;
    const HVT = parseFloat(misure.HVT) || 0;
    const TMV = parseFloat(misure.TMV) || 0;
    const HMT = parseFloat(misure.HMT) || 0;
    
    const LT = parseFloat(cm.telaioLarghezza) || 0;
    
    // Calcola ARIA
    let ARIA = 0;
    if (cm.falsoEsistente === 'si') {
        ARIA = parseFloat(cm.distanzaFalsoInfisso) || 0;
    } else if (cm.falsoEsistente === 'no') {
        ARIA = parseFloat(cm.distanzaMuroInfisso) || 0;
    }
    
    // Calcola SPESSORE_FALSO
    const SPESSORE_FALSO = cm.falsoEsistente === 'si' ? (parseFloat(cm.spessoreFalso) || 0) : 0;
    
    // 1. LF >= LVT (Luce Foro deve essere >= Luce Vano Telaio)
    if (LF > 0 && LVT > 0) {
        if (LF < LVT) {
            errors.push({
                field: 'LF',
                message: `LF (${LF}) deve essere â‰¥ LVT (${LVT})`
            });
        }
    }
    
    // 2. HF >= HVT (Altezza Foro deve essere >= Altezza Vano Telaio)
    if (HF > 0 && HVT > 0) {
        if (HF < HVT) {
            errors.push({
                field: 'HF',
                message: `HF (${HF}) deve essere â‰¥ HVT (${HVT})`
            });
        }
    }
    
    // 3. HVT + LT <= HMT
    if (HVT > 0 && LT > 0 && HMT > 0) {
        if (HVT + LT > HMT) {
            errors.push({
                field: 'HMT',
                message: `HMT (${HMT}) deve essere â‰¥ HVT (${HVT}) + LT (${LT}) = ${HVT + LT}`
            });
        }
    }
    
    // 4. TMV >= LF (Telaio Montante Verticale deve contenere la Luce Foro)
    if (LF > 0 && TMV > 0) {
        if (TMV < LF) {
            errors.push({
                field: 'TMV',
                message: `TMV (${TMV}) deve essere â‰¥ LF (${LF})`
            });
        }
    }
    
    // 5. HMT >= HF (Altezza Montante Telaio deve contenere l'Altezza Foro)
    if (HF > 0 && HMT > 0) {
        if (HMT < HF) {
            errors.push({
                field: 'HMT',
                message: `HMT (${HMT}) deve essere â‰¥ HF (${HF})`
            });
        }
    }
    
    // 6. LVT + ((LT + ARIA + SPESSORE_FALSO)*2) <= TMV
    if (LVT > 0 && LT > 0 && TMV > 0) {
        const calcolato = LVT + ((LT + ARIA + SPESSORE_FALSO) * 2);
        if (calcolato > TMV) {
            errors.push({
                field: 'TMV',
                message: `TMV (${TMV}) deve essere â‰¥ LVT (${LVT}) + [(LT (${LT}) + ARIA (${ARIA}) + FALSO (${SPESSORE_FALSO})) Ã— 2] = ${calcolato.toFixed(1)}`
            });
        } else if (calcolato > TMV * 0.95) {
            warnings.push({
                field: 'TMV',
                message: `TMV vicino al limite: calcolato ${calcolato.toFixed(1)} / max ${TMV}`
            });
        }
    }
    
    // Warnings per valori sospetti
    if (LF > 0 && LF < 300) {
        warnings.push({
            field: 'LF',
            message: 'LF molto piccolo (< 300mm)'
        });
    }
    if (LF > 3000) {
        warnings.push({
            field: 'LF',
            message: 'LF molto grande (> 3000mm)'
        });
    }
    if (HF > 0 && HF < 300) {
        warnings.push({
            field: 'HF',
            message: 'HF molto piccolo (< 300mm)'
        });
    }
    if (HF > 3000) {
        warnings.push({
            field: 'HF',
            message: 'HF molto grande (> 3000mm)'
        });
    }
    
    // ğŸ›¡ï¸ Filtra gli errori che hanno un override manuale confermato
    const filteredErrors = errors.filter(error => {
        return !(pos.validationOverrides && pos.validationOverrides[error.field]);
    });
    
    return { 
        errors: filteredErrors, 
        warnings, 
        isValid: filteredErrors.length === 0 
    };
}

function getFieldValidationClass(project, pos, fieldName) {
    // ğŸ›¡ï¸ Controlla se c'Ã¨ un override manuale per questo campo
    if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
        return 'input-overridden'; // Verde con badge confermato
    }
    
    const validation = validateMisure(project, pos);
    
    const hasError = validation.errors.some(e => e.field === fieldName);
    const hasWarning = validation.warnings.some(w => w.field === fieldName);
    
    const misure = pos.misure || {};
    const value = parseFloat(misure[fieldName]) || 0;
    
    if (hasError) return 'input-error';
    if (hasWarning) return 'input-warning';
    if (value > 0) return 'input-valid';
    
    return '';
}

function getFieldValidationMessage(project, pos, fieldName) {
    // ğŸ›¡ï¸ Se c'Ã¨ un override manuale, mostra il badge CONFERMATO
    if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
        return `
            <div class="validation-message success">
                âœ… CONFERMATO (manuale)
                <button 
                    class="btn-override-cancel" 
                    onclick="cancelValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                    title="Annulla conferma manuale">
                    âœ• Annulla
                </button>
            </div>
        `;
    }
    
    const validation = validateMisure(project, pos);
    
    const error = validation.errors.find(e => e.field === fieldName);
    if (error) {
        return `
            <div class="validation-message error">
                ğŸ”´ ${error.message}
                <button 
                    class="btn-override-confirm" 
                    onclick="confirmValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                    title="Ho verificato, la misura Ã¨ corretta">
                    âœ“ Conferma OK
                </button>
            </div>
        `;
    }
    
    const warning = validation.warnings.find(w => w.field === fieldName);
    if (warning) {
        return `<div class="validation-message warning">ğŸŸ¡ ${warning.message}</div>`;
    }
    
    const misure = pos.misure || {};
    const value = parseFloat(misure[fieldName]) || 0;
    if (value > 0) {
        return `<div class="validation-message success">âœ… OK</div>`;
    }
    
    return '';
}

// ğŸ›¡ï¸ OVERRIDE VALIDAZIONE MANUALE - Conferma che una misura Ã¨ corretta
function confirmValidationOverride(projectId, posId, fieldName) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.positions) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) return;
    
    // Inizializza l'oggetto validationOverrides se non esiste
    if (!pos.validationOverrides) {
        pos.validationOverrides = {};
    }
    
    // Salva la conferma per questo campo
    pos.validationOverrides[fieldName] = {
        confirmed: true,
        timestamp: new Date().toISOString(),
        value: pos.misure ? pos.misure[fieldName] : null
    };
    
    saveState();
    render();
}

// ğŸ›¡ï¸ OVERRIDE VALIDAZIONE MANUALE - Annulla la conferma manuale
function cancelValidationOverride(projectId, posId, fieldName) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.positions) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) return;
    
    // Rimuovi l'override per questo campo
    if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
        delete pos.validationOverrides[fieldName];
        
        // Se non ci sono piÃ¹ override, rimuovi l'oggetto intero
        if (Object.keys(pos.validationOverrides).length === 0) {
            delete pos.validationOverrides;
        }
    }
    
    saveState();
    render();
}

// ğŸ“‹ RILIEVO PREESISTENTE - Gestione e Validazione
function updateRilievo(projectId, posId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    if (project && project.positions) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            if (!pos.rilievo) {
                pos.rilievo = {
                    togliere: false,
                    smaltimento: false,
                    materiale: '',
                    coprifiliInt: false,
                    coprifiliEst: false,
                    note: ''
                };
            }
            
            // Gestione checkbox (boolean)
            if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                pos.rilievo[field] = value === true || value === 'true';
            } else {
                pos.rilievo[field] = value;
            }
            
            saveState();
            render();
        }
    }
}

// ğŸ†• CALCOLA COMPLETEZZA PER SINGOLO PRODOTTO
// ğŸ”„ v5.743: Aggiornato per sistema 3 stati (null/si/no)
function calculateRilievoCompletenessForProduct(pos, productType) {
    const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const rilievo = pos[rilievoKey];
    
    if (!rilievo) return { percentage: 0, completed: 0, total: productType === 'infissi' ? 5 : 3 };
    
    let completed = 0;
    const hasCoprifili = productType === 'infissi';
    const total = hasCoprifili ? 5 : 3; // infissi: 5 campi | altri: 3 campi
    
    // Conta i campi compilati
    if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
    // ğŸ”„ v5.743: Flag 3 stati - completato solo se 'si' o 'no' (non null)
    if (rilievo.togliere === 'si' || rilievo.togliere === 'no') completed++;
    if (rilievo.smaltimento === 'si' || rilievo.smaltimento === 'no') completed++;
    
    if (hasCoprifili) {
        if (rilievo.coprifiliInt === 'si' || rilievo.coprifiliInt === 'no') completed++;
        if (rilievo.coprifiliEst === 'si' || rilievo.coprifiliEst === 'no') completed++;
    }
    
    const percentage = Math.round((completed / total) * 100);
    return { percentage, completed, total };
}

function getRilievoStatusForProduct(pos, productType) {
    const completeness = calculateRilievoCompletenessForProduct(pos, productType);
    
    if (completeness.percentage === 0) {
        return { icon: 'âšª', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
    } else if (completeness.percentage < 50) {
        return { icon: 'ğŸ”´', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
    } else if (completeness.percentage < 100) {
        return { icon: 'ğŸŸ¡', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
    } else {
        return { icon: 'ğŸŸ¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
    }
}

// ğŸ†• CALCOLA COMPLETEZZA MEDIA DI UNA POSIZIONE (tutti i prodotti)
function calculateRilievoCompleteness(pos) {
    // Questa funzione mantiene il nome originale per retrocompatibilitÃ 
    // Calcola la media di completezza di tutti i prodotti nella posizione
    const project = state.projects.find(p => p.positions?.some(position => position.id === pos.id));
    if (!project) return { percentage: 0, completed: 0, total: 0 };
    
    const prodotti = ['infissi', 'persiane', 'tapparelle', 'zanzariere', 'cassonetti'];
    const prodottiAttivi = prodotti.filter(p => project.prodotti?.[p]);
    
    if (prodottiAttivi.length === 0) return { percentage: 0, completed: 0, total: 0 };
    
    let totalPercentage = 0;
    let totalCompleted = 0;
    let totalFields = 0;
    
    prodottiAttivi.forEach(productType => {
        const comp = calculateRilievoCompletenessForProduct(pos, productType);
        totalPercentage += comp.percentage;
        totalCompleted += comp.completed;
        totalFields += comp.total;
    });
    
    const avgPercentage = Math.round(totalPercentage / prodottiAttivi.length);
    return { percentage: avgPercentage, completed: totalCompleted, total: totalFields };
}

function getRilievoStatus(pos) {
    const completeness = calculateRilievoCompleteness(pos);
    
    if (completeness.percentage === 0) {
        return { icon: 'âšª', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
    } else if (completeness.percentage < 50) {
        return { icon: 'ğŸ”´', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
    } else if (completeness.percentage < 100) {
        return { icon: 'ğŸŸ¡', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
    } else {
        return { icon: 'ğŸŸ¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
    }
}

// ğŸ†• FASE 013 (28 OTT 2025) - Calcolo completamento posizione base
// Controlla: nome, ambiente, prodotti enabled, misure compilate
// âœ… Foto NON necessarie | âœ… Prodotti OBBLIGATORI | âœ… Misure anche "0" valide
// ğŸ†• FASE 014 - Calcolo completamento basato su TUTTI i prodotti del progetto
function calculatePositionCompleteness(pos, project) {
    let score = 0;
    const missing = [];
    
    // ========================================
    // STEP 1: AMBIENTE + TIPO APERTURA (33 punti)
    // ========================================
    let step1Score = 0;
    
    // Nome posizione (8 punti)
    if (pos.name && pos.name.trim() !== '') {
        step1Score += 8;
    } else {
        missing.push('Nome posizione');
    }
    
    // Ambiente (8 punti)
    if (pos.ambiente && pos.ambiente.trim() !== '') {
        step1Score += 8;
    } else {
        missing.push('Ambiente');
    }
    
    // ğŸ†• v5.79: Tipo Apertura F/PF OBBLIGATORIO (8 punti) - usa OPZIONI_MURO
    const tipoAperturaValid = typeof isValidOpzioneMuro !== 'undefined' 
        ? isValidOpzioneMuro('tipoApertura', pos.tipoApertura)
        : (pos.tipoApertura === 'F' || pos.tipoApertura === 'PF');
    
    if (tipoAperturaValid) {
        step1Score += 8;
    } else {
        missing.push('Tipo Apertura (F/PF)');
    }
    
    // ğŸ†• v5.79: Posizione Telaio OBBLIGATORIA (9 punti) - usa OPZIONI_MURO
    const posizioneTelaioValid = typeof isValidOpzioneMuro !== 'undefined'
        ? isValidOpzioneMuro('posizioneTelaio', pos.posizioneTelaio)
        : (pos.posizioneTelaio === 'filo_muro' || pos.posizioneTelaio === 'mazzetta');
    
    if (posizioneTelaioValid) {
        step1Score += 9;
    } else {
        missing.push('Posizione Telaio (Filo Muro/Mazzetta)');
    }
    
    score += Math.round(step1Score);
    
    // ========================================
    // STEP 2: PRODOTTI (33 punti)
    // ========================================
    const mapProdotti = {
        'infissi': 'infisso',
        'persiane': 'persiana', 
        'tapparelle': 'tapparella',
        'zanzariere': 'zanzariera',
        'cassonetti': 'cassonetto',
        'grate': 'grata',  // ğŸ”’ v5.85
        'clickZip': 'clickZip',
        'tendeBracci': 'tendaBracci',
        'blindate': 'blindata',
        'portoncini': 'portoncino',
        'porteInterne': 'portaInterna'
    };
    
    // Ottieni prodotti abilitati nel progetto
    const prodottiProgetto = [];
    if (project?.prodotti) {
        Object.keys(project.prodotti).forEach(tipo => {
            if (project.prodotti[tipo] === true) {
                prodottiProgetto.push(mapProdotti[tipo]);
            }
        });
    }
    
    // Se non ci sono prodotti configurati nel progetto,
    // verifica se la posizione ha almeno UN prodotto presente
    if (prodottiProgetto.length === 0) {
        // Controlla se ci sono prodotti direttamente nella posizione
        const hasPosProducts = 
            (pos.infisso && Object.keys(pos.infisso).length > 0) ||
            (pos.persiana && Object.keys(pos.persiana).length > 0) ||
            (pos.tapparella && Object.keys(pos.tapparella).length > 0) ||
            (pos.zanzariera && Object.keys(pos.zanzariera).length > 0) ||
            (pos.cassonetto && Object.keys(pos.cassonetto).length > 0);
        
        if (hasPosProducts) {
            // Posizione ha prodotti anche senza configurazione progetto
            // Assegna punti prodotti (33 punti)
            score += 33;
        } else {
            // Nessun prodotto nÃ© nel progetto nÃ© nella posizione
            missing.push('Nessun prodotto configurato nel progetto');
            return {
                percentage: score,
                isComplete: false,
                missing: missing,
                enabledProducts: 0
            };
        }
    }
    
    // Verifica TUTTI i prodotti del progetto
    const prodottiPresenti = [];
    const prodottiAssenti = pos.prodottiAssenti || [];
    const prodottiMancanti = [];
    
    prodottiProgetto.forEach(tipo => {
        const hasProdotto = pos[tipo] && typeof pos[tipo] === 'object';
        const qta = hasProdotto ? (parseInt(pos[tipo].qta) || 0) : 0;
        const isDichiaratoAssente = prodottiAssenti.includes(tipo);
        
        if (hasProdotto && qta > 0) {
            // Prodotto presente con quantitÃ  > 0
            prodottiPresenti.push(tipo);
        } else if (isDichiaratoAssente || qta === 0) {
            // OK: dichiarato come non presente in questa posizione
        } else {
            // MANCANTE: nÃ© presente con qta>0 nÃ© dichiarato assente
            prodottiMancanti.push(tipo);
        }
    });
    
    // Calcola punteggio prodotti
    const prodottiOk = prodottiPresenti.length + prodottiAssenti.length;
    const percentualeProdotti = prodottiProgetto.length > 0 ? (prodottiOk / prodottiProgetto.length) : 0;
    score += Math.round(33 * percentualeProdotti);
    
    if (prodottiMancanti.length > 0) {
        missing.push(`Prodotti mancanti (${prodottiOk}/${prodottiProgetto.length}): ${prodottiMancanti.join(', ')}`);
    }
    
    // ========================================
    // STEP 3: MISURE POSIZIONE (34 punti)
    // ========================================
    const misurePosizione = ['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'L4', 'H4'];
    let misureCompilate = 0;
    
    misurePosizione.forEach(field => {
        const val = pos.misure?.[field];
        // Valore valido: NON vuoto E NON zero
        if (val !== undefined && val !== null && val !== '' && parseFloat(val) !== 0) {
            misureCompilate++;
        }
    });
    
    if (misureCompilate >= 4) {
        // 4 o piÃ¹ misure = OK completo
        score += 34;
    } else if (misureCompilate >= 2) {
        // 2-3 misure = parziale
        score += 17;
        missing.push(`Misure posizione parziali (${misureCompilate}/8) - Inserisci almeno 4 misure per completare`);
    } else {
        // Meno di 2 misure = mancanti
        missing.push(`Misure posizione mancanti (${misureCompilate}/8 compilate, minimo 2)`);
    }
    
    return {
        percentage: Math.min(score, 100),
        isComplete: score >= 100,
        missing: missing,
        enabledProducts: prodottiProgetto.length,
        prodottiPresenti: prodottiPresenti.length,
        prodottiAssenti: prodottiAssenti.length,
        misureCompilate: misureCompilate
    };
}

// ğŸ†• FASE 014 - Toggle prodotto assente/presente in posizione
function toggleProdottoAssente(projectId, posId, productType) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (!project || !pos) return;
    
    // Inizializza array se non esiste
    if (!pos.prodottiAssenti) {
        pos.prodottiAssenti = [];
    }
    
    const mapProdotti = {
        'infissi': 'infisso',
        'persiane': 'persiana',
        'tapparelle': 'tapparella',
        'zanzariere': 'zanzariera',
        'cassonetti': 'cassonetto',
        'grate': 'grata',  // ğŸ”’ v5.85
        'clickZip': 'clickZip',
        'tendeBracci': 'tendaBracci',
        'blindate': 'blindata',
        'portoncini': 'portoncino',
        'porteInterne': 'portaInterna'
    };
    
    const prodottoSingolare = mapProdotti[productType];
    if (!prodottoSingolare) {
        console.warn(`âš ï¸ Tipo prodotto non mappato: ${productType}`);
        return;
    }
    const index = pos.prodottiAssenti.indexOf(prodottoSingolare);
    
    if (index > -1) {
        // Era assente, rimuovi (ora deve essere presente)
        pos.prodottiAssenti.splice(index, 1);
    } else {
        // Era presente (o non dichiarato), marca come assente
        pos.prodottiAssenti.push(prodottoSingolare);
        
        // Se c'era il prodotto fisico, rimuovilo
        if (pos[prodottoSingolare]) {
            delete pos[prodottoSingolare];
        }
    }
    
    saveState();
    render();
}

// ğŸ†• Toggle flag misure parziali OK
function toggleMisureParziali(projectId, posId, checked) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (!project || !pos) return;
    
    pos.misureParziali = checked;
    
    saveState();
    render();
}

// ğŸ†• FASE 013 - Helper per status badge completamento posizione
// ğŸ”§ FASE 014 - Aggiunto parametro project
function getPositionCompletenessStatus(pos, project) {
    const comp = calculatePositionCompleteness(pos, project);
    
    if (comp.percentage === 100) {
        return { 
            icon: 'ğŸŸ¢', 
            color: 'green', 
            text: '100% âœ…', 
            badge: 'bg-green-500',
            comp: comp 
        };
    } else if (comp.percentage >= 70) {
        return { 
            icon: 'ğŸŸ¡', 
            color: 'amber', 
            text: `${comp.percentage}% âš ï¸`, 
            badge: 'bg-amber-500',
            comp: comp 
        };
    } else if (comp.percentage > 0) {
        return { 
            icon: 'ğŸŸ ', 
            color: 'orange', 
            text: `${comp.percentage}% âš ï¸`, 
            badge: 'bg-orange-500',
            comp: comp 
        };
    } else {
        return { 
            icon: 'ğŸ”´', 
            color: 'red', 
            text: '0% âŒ', 
            badge: 'bg-red-500',
            comp: comp 
        };
    }
}

// ğŸ†• FASE 13 - Gestione Rilievo Globale per Prodotti
// ğŸ†• FASE 014 - Sincronizzazione Intelligente Globale â†’ Posizioni
function updateRilievoGlobale(projectId, productType, field, value) {
    console.log('ğŸ”µ updateRilievoGlobale CHIAMATA:', {projectId, productType, field, value});
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
        console.log('ğŸ”µ rilievoKey:', rilievoKey);
        console.log('ğŸ”µ project[rilievoKey] ESISTE?:', !!project[rilievoKey], 'VALORE:', project[rilievoKey]);
        
        if (!project[rilievoKey]) {
            // ğŸ”„ v5.743: Inizializza flag a null (non verificato)
            project[rilievoKey] = {
                materiale: '',
                note: '',
                togliere: null,
                smaltimento: null
            };
            
            // Aggiungi coprifili solo per infissi
            if (productType === 'infissi') {
                project[rilievoKey].coprifiliInt = null;
                project[rilievoKey].coprifiliEst = null;
            }
            
            // Aggiungi campo tipo per tapparelle
            if (productType === 'tapparelle') {
                project[rilievoKey].tipo = '';
            }
            
            console.log('ğŸ†• Creato nuovo rilievoKey:', project[rilievoKey]);
        }
        
        // ğŸ” FASE 014 - Salva valore precedente per sync intelligente
        const previousValue = project[rilievoKey][field];
        
        // ğŸ”„ v5.743: Gestione flag 3 stati (null/si/no)
        if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
            // value puÃ² essere 'si', 'no', o null
            project[rilievoKey][field] = value;
        } else {
            project[rilievoKey][field] = value;
        }
        
        console.log(`âœï¸ APPENA ASSEGNATO ${field} = ${value}`);
        console.log(`   project[${rilievoKey}]:`, project[rilievoKey]);
        console.log(`   Tipo:`, Array.isArray(project[rilievoKey]) ? 'ARRAY âŒ' : 'OGGETTO âœ…');
        
        // ğŸ”„ FASE 014 - Sincronizzazione Intelligente alle posizioni
        // Aggiorna SOLO posizioni che hanno ancora il valore precedente del globale
        // (= non sono state personalizzate)
        if (project.positions && project.positions.length > 0) {
            let syncCount = 0;
            let createdCount = 0;
            
            project.positions.forEach(pos => {
                // ğŸ†• FIX: Se la posizione NON ha questo tipo di rilievo, CREALO con valori globali
                if (!pos[rilievoKey]) {
                    // ğŸ”„ v5.743: Inizializza flag a null
                    pos[rilievoKey] = {
                        materiale: project[rilievoKey].materiale || '',
                        note: project[rilievoKey].note || '',
                        togliere: project[rilievoKey].togliere,
                        smaltimento: project[rilievoKey].smaltimento
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = project[rilievoKey].coprifiliInt;
                        pos[rilievoKey].coprifiliEst = project[rilievoKey].coprifiliEst;
                    }
                    
                    // Aggiungi campo tipo per tapparelle
                    if (productType === 'tapparelle') {
                        pos[rilievoKey].tipo = project[rilievoKey].tipo || '';
                    }
                    
                    createdCount++;
                } else {
                    // Se il campo esiste, controlla se sincronizzare
                    const posValue = pos[rilievoKey][field];
                    
                    // Se il valore della posizione corrisponde al vecchio valore globale
                    // significa che NON Ã¨ stato personalizzato â†’ AGGIORNA
                    if (posValue === previousValue) {
                        pos[rilievoKey][field] = project[rilievoKey][field];
                        syncCount++;
                    }
                    // Altrimenti skip: Ã¨ una personalizzazione dell'utente
                }
            });
            
            // Log per debug (opzionale - puÃ² essere rimosso in produzione)
            if (createdCount > 0) {
                console.log(`ğŸ†• INIT: ${createdCount} posizioni inizializzate con valori globali ${productType}`);
            }
            if (syncCount > 0) {
                console.log(`âœ… SYNC: ${syncCount} posizioni aggiornate per ${productType}.${field}`);
            }
        }
        
        console.log('ğŸ’¾ PRIMA DI SALVARE - project[rilievoKey]:', project[rilievoKey]);
        saveState();
        console.log('âœ… saveState() CHIAMATO per updateRilievoGlobale');
        render(); // âœ… Aggiunto render() per aggiornamento immediato interfaccia
    } else {
        console.error('âŒ PROJECT NON TROVATO in updateRilievoGlobale:', projectId);
    }
}

// ğŸ†• v5.743: Funzione per ciclare i flag 3 stati nel rilievo globale
function ciclaFlagRilievoGlobale(projectId, productType, field) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const currentValue = project[rilievoKey]?.[field];
    const newValue = ciclaStatoRilievo(currentValue);
    
    console.log(`ğŸ”˜ Cicla flag globale ${field}: ${currentValue} â†’ ${newValue}`);
    updateRilievoGlobale(projectId, productType, field, newValue);
}

// ğŸ†• v5.743: Funzione per ciclare i flag 3 stati nel rilievo posizione
function ciclaFlagRilievoProdotto(projectId, posId, productType, field) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions?.find(p => p.id === posId);
    if (!pos) return;
    
    const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const currentValue = pos[rilievoKey]?.[field];
    const newValue = ciclaStatoRilievo(currentValue);
    
    console.log(`ğŸ”˜ Cicla flag posizione ${field}: ${currentValue} â†’ ${newValue}`);
    updateRilievoProdotto(projectId, posId, productType, field, newValue);
}

function toggleMaterialeMode(productType, projectId) {
    const selectEl = document.getElementById(`materiale-select-${productType}-${projectId}`);
    const inputEl = document.getElementById(`materiale-input-${productType}-${projectId}`);
    const toggleBtn = document.getElementById(`materiale-toggle-${productType}-${projectId}`);
    
    if (selectEl && inputEl && toggleBtn) {
        if (selectEl.style.display === 'none') {
            // Passa a SELECT
            selectEl.style.display = 'block';
            inputEl.style.display = 'none';
            toggleBtn.innerHTML = 'âœï¸ Scrivi';
            // Sincronizza valore
            const currentValue = inputEl.value;
            // Se il valore esiste nelle opzioni, selezionalo
            const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
            if (optionExists) {
                selectEl.value = currentValue;
            } else {
                selectEl.value = '';
            }
        } else {
            // Passa a INPUT
            selectEl.style.display = 'none';
            inputEl.style.display = 'block';
            toggleBtn.innerHTML = 'ğŸ“‹ Tendina';
            // Sincronizza valore
            inputEl.value = selectEl.value;
        }
    }
}

function toggleMaterialePosMode(posId) {
    const selectEl = document.getElementById(`materiale-pos-select-${posId}`);
    const inputEl = document.getElementById(`materiale-pos-input-${posId}`);
    const toggleBtn = document.getElementById(`materiale-pos-toggle-${posId}`);
    
    if (selectEl && inputEl && toggleBtn) {
        if (selectEl.style.display === 'none') {
            // Passa a SELECT
            selectEl.style.display = 'block';
            inputEl.style.display = 'none';
            toggleBtn.innerHTML = 'âœï¸ Scrivi';
            // Sincronizza valore
            const currentValue = inputEl.value;
            const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
            if (optionExists) {
                selectEl.value = currentValue;
            } else {
                selectEl.value = '';
            }
        } else {
            // Passa a INPUT
            selectEl.style.display = 'none';
            inputEl.style.display = 'block';
            toggleBtn.innerHTML = 'ğŸ“‹ Tendina';
            inputEl.value = selectEl.value;
        }
    }
}

// ğŸ†• CHAT 011 - Toggle Ambiente (Dropdown â†” Free Text)
function toggleAmbienteMode(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (!pos) return;
    
    const selectEl = document.getElementById(`ambiente-select-${posId}`);
    const inputEl = document.getElementById(`ambiente-input-${posId}`);
    const toggleBtn = document.getElementById(`ambiente-toggle-${posId}`);
    
    if (selectEl && inputEl && toggleBtn) {
        if (selectEl.style.display === 'none') {
            // Passa a DROPDOWN
            selectEl.style.display = 'block';
            inputEl.style.display = 'none';
            toggleBtn.innerHTML = 'âœï¸ Scrivi';
            toggleBtn.title = 'Passa a scrittura libera';
            // Sincronizza valore: se il valore attuale esiste nel dropdown, selezionalo
            const currentValue = inputEl.value;
            const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
            if (optionExists && currentValue) {
                selectEl.value = currentValue;
            } else {
                selectEl.value = currentValue || ''; // Mantieni valore anche se non in lista
            }
            
            // ğŸ†• Salva stato nella posizione
            pos.ambienteMode = 'select';
            saveState();
        } else {
            // Passa a FREE TEXT
            selectEl.style.display = 'none';
            inputEl.style.display = 'block';
            toggleBtn.innerHTML = 'ğŸ“‹ Tendina';
            toggleBtn.title = 'Torna alla tendina';
            // Sincronizza valore: trasferisci dal dropdown all'input
            inputEl.value = selectEl.value;
            
            // ğŸ†• Salva stato nella posizione
            pos.ambienteMode = 'input';
            saveState();
        }
    }
}

function copiaRilievoDaGlobale(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (project && pos) {
        // Copia dal rilievo globale infissi (default)
        const rilievoGlobale = getRilievoGlobale(project, 'infissi');
        
        // Inizializza pos.rilievo se non esiste
        if (!pos.rilievo) {
            pos.rilievo = {
                togliere: false,
                smaltimento: false,
                materiale: '',
                coprifiliInt: false,
                coprifiliEst: false,
                note: ''
            };
        }
        
        // Copia i valori
        pos.rilievo.materiale = rilievoGlobale.materiale || '';
        pos.rilievo.note = rilievoGlobale.note || '';
        pos.rilievo.togliere = rilievoGlobale.togliere || false;
        pos.rilievo.smaltimento = rilievoGlobale.smaltimento || false;
        pos.rilievo.coprifiliInt = rilievoGlobale.coprifiliInt || false;
        pos.rilievo.coprifiliEst = rilievoGlobale.coprifiliEst || false;
        
        saveState();
        render();
        
        alert('âœ… Dati copiati dal rilievo globale!');
    }
}

function updateRilievoProdotto(projectId, posId, productType, field, value) {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (project && pos) {
        // FIX: Per infissi il campo Ã¨ 'rilievo', per altri prodotti Ã¨ 'rilievo[Prodotto]'
        const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
        
        // ğŸ†• FASE 014 - Inizializza rilievo con valori globali se non esiste
        if (!pos[rilievoKey]) {
            const rilievoGlobale = getRilievoGlobale(project, productType);
            
            pos[rilievoKey] = {
                materiale: rilievoGlobale.materiale || '',
                note: rilievoGlobale.note || '',
                togliere: rilievoGlobale.togliere || false,
                smaltimento: rilievoGlobale.smaltimento || false
            };
            
            // Aggiungi coprifili solo per infissi
            if (productType === 'infissi') {
                pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
            }
            
            // Aggiungi campo tipo per tapparelle
            if (productType === 'tapparelle') {
                pos[rilievoKey].tipo = rilievoGlobale.tipo || '';
            }
        }
        
        // Gestione checkbox (boolean)
        if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
            pos[rilievoKey][field] = value === true || value === 'true';
        } else {
            pos[rilievoKey][field] = value;
        }
        
        saveState();
        render();
    }
}

function copiaRilievoDaGlobaleProdotto(projectId, posId, productType) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    
    if (project && pos) {
        const rilievoGlobale = getRilievoGlobale(project, productType);
        // FIX: Per infissi il campo Ã¨ 'rilievo', per altri prodotti Ã¨ 'rilievo[Prodotto]'
        const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
        
        // Inizializza pos.rilievo se non esiste
        if (!pos[rilievoKey]) {
            pos[rilievoKey] = {
                materiale: '',
                note: '',
                togliere: false,
                smaltimento: false
            };
            
            if (productType === 'infissi') {
                pos[rilievoKey].coprifiliInt = false;
                pos[rilievoKey].coprifiliEst = false;
            }
            
            if (productType === 'tapparelle') {
                pos[rilievoKey].tipo = '';
            }
        }
        
        // Copia i valori
        pos[rilievoKey].materiale = rilievoGlobale.materiale || '';
        pos[rilievoKey].note = rilievoGlobale.note || '';
        pos[rilievoKey].togliere = rilievoGlobale.togliere || false;
        pos[rilievoKey].smaltimento = rilievoGlobale.smaltimento || false;
        
        if (productType === 'infissi') {
            pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
            pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
        }
        
        if (productType === 'tapparelle') {
            pos[rilievoKey].tipo = rilievoGlobale.tipo || '';
        }
        
        saveState();
        render();
        
        alert('âœ… Dati copiati dal rilievo globale!');
    }
}

function toggleMaterialeProdottoMode(uniqueId) {
    const selectEl = document.getElementById(`materiale-select-${uniqueId}`);
    const inputEl = document.getElementById(`materiale-input-${uniqueId}`);
    const toggleBtn = document.getElementById(`materiale-toggle-${uniqueId}`);
    
    if (selectEl && inputEl && toggleBtn) {
        if (selectEl.style.display === 'none') {
            // Passa a SELECT
            selectEl.style.display = 'block';
            inputEl.style.display = 'none';
            toggleBtn.innerHTML = 'âœï¸ Scrivi';
            const currentValue = inputEl.value;
            const optionExists = Array.from(selectEl.options).some(opt => opt.value === currentValue);
            if (optionExists) {
                selectEl.value = currentValue;
            } else {
                selectEl.value = '';
            }
        } else {
            // Passa a INPUT
            selectEl.style.display = 'none';
            inputEl.style.display = 'block';
            toggleBtn.innerHTML = 'ğŸ“‹ Tendina';
            inputEl.value = selectEl.value;
        }
    }
}

function getRilievoGlobale(project, productType) {
    const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    return project[rilievoKey] || {};
}

function calculateRilievoGlobaleCompleteness(project, productType) {
    const rilievo = getRilievoGlobale(project, productType);
    let completed = 0;
    let total = 3; // materiale, togliere, smaltimento (campo "preesistente" ELIMINATO in FASE 13a)
    
    // Per infissi ci sono anche i coprifili
    if (productType === 'infissi') {
        total = 5; // + coprifiliInt, coprifiliEst
    }
    
    // Conta i campi compilati (campo "preesistente" ELIMINATO in FASE 13a)
    if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
    if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
    if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
    
    if (productType === 'infissi') {
        if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
        if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
    }
    
    const percentage = Math.round((completed / total) * 100);
    return { percentage, completed, total };
}

// BRM Calculator
// ğŸ”§ v5.88: calculateBRM â†’ CENTRALIZZATO in export-utils.js (shared-database)

// Project Management
function createProject(name, client) {
    // ğŸ”§ v4.57: Genera ID e verifica validitÃ 
    let newId = generateId();
    
    // ğŸš¨ VALIDAZIONE CRITICA: ID deve essere valido
    if (!newId || newId === '#UNKNOWN' || newId === 'undefined' || newId.trim() === '') {
        console.error('âŒ ERRORE CRITICO: generateId() ha ritornato ID non valido:', newId);
        // Fallback: genera ID con timestamp
        const fallbackId = `${new Date().getFullYear()}P${Date.now().toString().slice(-3)}`;
        console.warn('âš ï¸ Uso ID fallback:', fallbackId);
        newId = fallbackId;
    }
    
    console.log('âœ… Nuovo progetto creato con ID:', newId);
    
    const project = {
        id: newId,  // ğŸ†• v4.20: USA formato ANNOP001 (2025P001) + v4.57: validato
        name,
        client,
        clientData: {},
        linkSchizzo: '',  // ğŸ“ v5.27: Link schizzo Notability
        prodotti: {},
        caratteristicheMuro: {},
        configInfissi: {},
        configPersiane: {},
        configCassonetti: {
            tipo: '',
            azienda: '',
            materiale: '',
            finitura: '',
            coibentazione: '',
            aSoffitto: '',
            // v5.35: Nuovi campi per calcolo prezzi Finstral
            materialeCass: '',
            codiceCass: '',
            gruppoColoreCass: '',
            coloreCass: '', // v5.54
            codiceIsolamento: ''
        },
        configTapparelle: {},
        configGrate: {},  // ğŸ”’ v5.86
        configZanzariere: {
            azienda: '',
            modelloPF: '',
            modelloF: '',
            colore: ''
        },
        // ğŸ†• FIX: Inizializza esplicitamente TUTTI i rilievi globali come OGGETTI
        rilievoInfissi: {
            materiale: '',
            note: '',
            togliere: false,
            smaltimento: false,
            coprifiliInt: false,
            coprifiliEst: false
        },
        rilievoPersiane: {
            materiale: '',
            note: '',
            togliere: false,
            smaltimento: false
        },
        rilievoTapparelle: {
            materiale: '',
            note: '',
            togliere: false,
            smaltimento: false
        },
        rilievoZanzariere: {
            materiale: '',
            note: '',
            togliere: false,
            smaltimento: false
        },
        rilievoCassonetti: {
            materiale: '',
            note: '',
            togliere: false,
            smaltimento: false
        },
        brmConfigInfissi: { 
            misuraBaseL: '', operazioneL: '-', valoreL: '0',
            misuraBaseH: '', operazioneH: '-', valoreH: '0',
            note: '' 
        },
        brmConfigPersiane: { 
            misuraBaseL: '', operazioneL: '-', valoreL: '0',
            misuraBaseH: '', operazioneH: '-', valoreH: '0',
            note: '' 
        },
        brmConfigTapparelle: { 
            misuraBaseL: '', operazioneL: '-', valoreL: '0',
            misuraBaseH: '', operazioneH: '-', valoreH: '0',
            note: '' 
        },
        brmConfigZanzariere: { 
            misuraBaseL: '', operazioneL: '-', valoreL: '0',
            misuraBaseH: '', operazioneH: '-', valoreH: '0',
            note: '' 
        },
        brmConfigCassonetti: { 
            misuraBaseL: '', operazioneL: '-', valoreL: '0',
            misuraBaseH: '', operazioneH: '-', valoreH: '0',
            misuraBaseC: '', operazioneC: '-', valoreC: '0',
            misuraBaseB: '', operazioneB: '-', valoreB: '0',
            note: '',
            SRSX: '0',
            SRDX: '0',
            ZSX: '0',
            ZDX: '0'
        },
        positions: [],
        createdAt: new Date().toISOString(),
        // âœ… SOLUZIONE C: Metadata per tracking e sincronizzazione
        metadata: initMetadata()
    };
    state.projects.push(project);
    state.currentProject = project.id;
    state.setupStep = 1;
    saveState();
    return project;
}

// v5.90: Cicla stato progetto (delega a modulo condiviso se disponibile)
function cycleProjectStato(projectId) {
    if (typeof ProjectListView !== 'undefined') {
        ProjectListView.cycleStato(projectId);
        return;
    }
    // Fallback standalone
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const cycle = { preventivo: 'ordine', ordine: 'annullato', annullato: 'preventivo' };
    project.stato = cycle[project.stato || 'preventivo'] || 'preventivo';
    showNotification(`${project.name}: ${project.stato}`, 'success', 2000);
    saveState();
    render();
}

async function deleteProject(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    // Chiedi conferma con il nome del progetto
    const confirmMessage = `Sei sicuro di voler eliminare il progetto "${project.name}" (Cliente: ${project.client})?\n\nQuesta azione Ã¨ IRREVERSIBILE e cancellerÃ :\n- Tutte le ${project.positions.length} posizioni\n- Tutti i dati e le configurazioni\n- Tutte le foto associate\n\n${state.github?.connected ? 'âš ï¸ Il progetto verrÃ  eliminato anche da GitHub' : ''}`;
    
    if (!confirm(confirmMessage)) {
        return; // Annullato dall'utente
    }
    
    // ğŸ†• v4.61: CANCELLA DA GITHUB PRIMA di eliminare locale
    let githubDeleted = false;
    if (state.github?.connected && GITHUB_CONFIG.token) {
        try {
            console.log(`ğŸ—‘ï¸ Cancellazione progetto ${projectId} da GitHub...`);
            
            const fileName = `progetto-${projectId}.json`;
            const filePath = `${GITHUB_CONFIG.projectsPath}/${fileName}`;
            
            // Ottieni SHA del file per cancellazione
            const checkUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
            const checkResponse = await fetch(checkUrl, {
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (checkResponse.ok) {
                const fileData = await checkResponse.json();
                const sha = fileData.sha;
                
                // Cancella file da GitHub
                const deleteUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${filePath}`;
                const deleteResponse = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Delete ${fileName}`,
                        sha: sha,
                        branch: GITHUB_CONFIG.branch
                    })
                });
                
                if (deleteResponse.ok) {
                    console.log(`âœ… Progetto ${projectId} cancellato da GitHub`);
                    githubDeleted = true;
                } else {
                    console.error(`âŒ Errore cancellazione GitHub:`, deleteResponse.status);
                }
            } else if (checkResponse.status === 404) {
                console.log(`â„¹ï¸ Progetto ${projectId} non presente su GitHub`);
                githubDeleted = true; // Non esiste, quindi OK
            }
        } catch (error) {
            console.error('âŒ Errore cancellazione GitHub:', error);
            // Continua comunque con cancellazione locale
        }
    }
    
    // Rimuovi il progetto dall'array locale
    const index = state.projects.findIndex(p => p.id === projectId);
    if (index !== -1) {
        state.projects.splice(index, 1);
        
        // Se era il progetto corrente, resetta
        if (state.currentProject === projectId) {
            state.currentProject = null;
            state.screen = 'list';
        }
        
        saveState();
        
        // Notifica risultato
        if (githubDeleted) {
            showNotification('ğŸ—‘ï¸ Progetto eliminato (locale + GitHub)', 'success');
        } else if (state.github?.connected) {
            showNotification('âš ï¸ Progetto eliminato localmente (errore GitHub)', 'warning');
        } else {
            showNotification('ğŸ—‘ï¸ Progetto eliminato localmente', 'success');
        }
        
        render();
    }
}

function addPosition(projectId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        // ğŸ†• FASE 014 - Copia valori globali per nuova posizione
        const rilievoGlobaleInfissi = getRilievoGlobale(project, 'infissi');
        
        // ğŸ”§ FIX: Trova il primo numero libero (senza buchi)
        const usedNumbers = new Set();
        project.positions.forEach(p => {
            const match = p.name.match(/Pos\.\s*(\d+)/);
            if (match) {
                usedNumbers.add(parseInt(match[1]));
            }
        });
        
        // Trova il primo numero libero partendo da 1
        let newNum = 1;
        while (usedNumbers.has(newNum)) {
            newNum++;
        }
        
        const pos = {
            id: generateSequentialPositionId(projectId, project.positions),
            name: `Pos. ${newNum}`,
            piano: project.clientData?.piano || '',
            ambiente: '',
            ambienteMode: 'select',  // ğŸ†• Traccia modalitÃ  input: 'select' o 'input'
            quantita: '1',
            tipoApertura: null,  // ğŸ†• v5.78: OBBLIGATORIO - nessun default, l'utente deve scegliere F o PF
            posizioneTelaio: null,  // ğŸ†• v5.79: OBBLIGATORIO - filo_muro o mazzetta
            misure: {},
            // ğŸ“‹ AUTO-SYNC: Inizializza TUTTI i rilievi con valori globali
            rilievo: {
                togliere: rilievoGlobaleInfissi.togliere || false,
                smaltimento: rilievoGlobaleInfissi.smaltimento || false,
                materiale: rilievoGlobaleInfissi.materiale || '',
                coprifiliInt: rilievoGlobaleInfissi.coprifiliInt || false,
                coprifiliEst: rilievoGlobaleInfissi.coprifiliEst || false,
                note: rilievoGlobaleInfissi.note || ''
            },
            // ğŸ†• AUTO-SYNC: Inizializza anche rilievi altri prodotti
            rilievoPersiane: {
                togliere: project.rilievoPersiane?.togliere || false,
                smaltimento: project.rilievoPersiane?.smaltimento || false,
                materiale: project.rilievoPersiane?.materiale || '',
                note: project.rilievoPersiane?.note || ''
            },
            rilievoTapparelle: {
                togliere: project.rilievoTapparelle?.togliere || false,
                smaltimento: project.rilievoTapparelle?.smaltimento || false,
                materiale: project.rilievoTapparelle?.materiale || '',
                note: project.rilievoTapparelle?.note || ''
            },
            rilievoZanzariere: {
                togliere: project.rilievoZanzariere?.togliere || false,
                smaltimento: project.rilievoZanzariere?.smaltimento || false,
                materiale: project.rilievoZanzariere?.materiale || '',
                note: project.rilievoZanzariere?.note || ''
            },
            rilievoCassonetti: {
                togliere: project.rilievoCassonetti?.togliere || false,
                smaltimento: project.rilievoCassonetti?.smaltimento || false,
                materiale: project.rilievoCassonetti?.materiale || '',
                note: project.rilievoCassonetti?.note || ''
            },
            infissi: [],
            persiane: [],
            cassonetti: [],
            tapparelle: [],
            zanzariere: [],
            foto: [],
            note: '',
            noteVisibilita: []
        };
        project.positions.push(pos);
        
        // âŒ NON CREARE PRODOTTI - L'utente deve fare scelta esplicita
        // I prodotti vengono creati solo quando l'utente:
        // 1. Click "+ Aggiungi [Prodotto]" â†’ chiama add[Prodotto]()
        // 2. Check "Non presente" â†’ aggiunto a pos.prodottiAssenti
        console.log('âœ… NUOVA POSIZIONE CREATA - Prodotti NON inizializzati (scelta utente)');




        
        // âœ… SOLUZIONE C: Track modifica
        updateProjectTimestamp(projectId, 'addPosition', `Aggiunta posizione: ${pos.name}`);
        
        // ğŸ†• v4.19: Imposta stato PRIMA di salvare
        state.currentPosition = pos.id;
        state.screen = 'position'; // ğŸ†• Apri subito la posizione
        
        // Salva dopo aver impostato tutto lo stato
        saveState();
        
        showNotification('Posizione aggiunta', 'success');
        render();
    }
}

// Product Management Functions
function addInfisso(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            // Verifica se la config Ã¨ vuota
            const configVuota = !project.configInfissi || Object.keys(project.configInfissi).length === 0;
            const configHaValori = project.configInfissi && (
                project.configInfissi.azienda ||
                project.configInfissi.telaio ||
                project.configInfissi.coloreInt ||
                // ğŸ†• v4.85: Usa tagliTelaio invece di codTagli (rimosso)
                project.configInfissi.tagliTelaio
            );
            
            if (configVuota || !configHaValori) {
                console.warn('âš ï¸ CONFIG GLOBALE INFISSI VUOTA!');
                console.log('ğŸ’¡ SUGGERIMENTO: Imposta prima la Config Globale, poi aggiungi le posizioni.');
                console.log('   Oppure usa il pulsante SINCRONIZZA TUTTO dopo aver configurato.');
            }
            
            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi);
            // UN SOLO INFISSO per posizione
            pos.infisso = {
                id: generateId(),
                qta: '1',
                azienda: project.configInfissi?.azienda || '',
                finituraInt: project.configInfissi?.finituraInt || '',
                finituraEst: project.configInfissi?.finituraEst || '',
                coloreInt: project.configInfissi?.coloreInt || '',
                coloreEst: project.configInfissi?.coloreEst || '',
                tipoAnta: project.configInfissi?.tipoAnta || '',
                telaio: project.configInfissi?.telaio || '',
                allarme: project.configInfissi?.allarme || '',
                vetro: project.configInfissi?.vetro || '',
                cerniere: project.configInfissi?.cerniere || '',  // ğŸ†• v4.80
                tagliTelaio: project.configInfissi?.tagliTelaio || '',
                // ğŸ†• v4.81: codTagli rimosso - generato al volo da tagliTelaio
                codTagliValues: project.configInfissi?.codTagliValues ? [...project.configInfissi.codTagliValues] : [],
                maniglia: project.configInfissi?.maniglia || '',
                coloreManiglia: project.configInfissi?.coloreManiglia || '',
                // ğŸ†• v5.67: Bancale Interno
                bancaleTipo: project.configInfissi?.bancaleTipo || '',
                bancaleBordo: project.configInfissi?.bancaleBordo || '0',
                bancaleProfondita: project.configInfissi?.bancaleProfondita || '',
                // ğŸ†• v5.68: Anta Twin (Veneziana/Plissettata)
                antaTwinTipo: project.configInfissi?.antaTwinTipo || '',
                antaTwinModello: project.configInfissi?.antaTwinModello || '',
                antaTwinColore: project.configInfissi?.antaTwinColore || '',
                antaTwinComando: project.configInfissi?.antaTwinComando || '27',
                // ğŸ†• v5.68: Esecuzione default basato su finitura interna
                esecuzione1: (() => {
                    const finInt = (project.configInfissi?.finituraInt || 'pvc').toLowerCase();
                    return (finInt === 'alluminio' || finInt === 'legno' || finInt === 'alu') ? '3' : '0';
                })(),
                BRM_L: brm.L,
                BRM_H: brm.H,
                note: '',
                foto: []
            };
            
            // Log per debug DETTAGLIATO
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('â• INFISSO AGGIUNTO - DEBUG COMPLETO');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“Š Config Globale Infissi:', project.configInfissi);
            console.log('ğŸ“ Posizione ID:', pos.id);
            console.log('ğŸªŸ Infisso Creato:', {
                azienda: pos.infisso.azienda || 'âŒ VUOTO',
                telaio: pos.infisso.telaio || 'âŒ VUOTO',
                coloreInt: pos.infisso.coloreInt || 'âŒ VUOTO',
                coloreEst: pos.infisso.coloreEst || 'âŒ VUOTO',
                vetro: pos.infisso.vetro || 'âŒ VUOTO',
                // ğŸ†• v4.85: Corretto - usa codTagliValues invece di codTagli (rimosso in v4.81)
                codTagliValues: pos.infisso.codTagliValues?.length > 0 ? `âœ… ${pos.infisso.codTagliValues.length} valore/i` : 'âŒ VUOTO'
            });
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            saveState();
            render();
        }
    }
}

function addPersiana(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigPersiane);
            
            // UNA SOLA PERSIANA per posizione
            pos.persiana = {
                id: generateId(),
                qta: '1',
                // ğŸ”§ FIX 027H: Copia TUTTI i campi da config globale
                azienda: project.configPersiane?.azienda || '',
                modello: project.configPersiane?.modello || '',
                fissaggio: project.configPersiane?.fissaggio || '',
                // tipoTelaio solo se fissaggio = TELAIO
                tipoTelaio: (project.configPersiane?.fissaggio === 'TELAIO') 
                            ? (project.configPersiane?.tipoTelaio || '') 
                            : '',
                // coloreTelaio solo se fissaggio = TELAIO
                coloreTelaio: (project.configPersiane?.fissaggio === 'TELAIO')
                              ? (project.configPersiane?.coloreTelaio || '')
                              : '',
                battuta: project.configPersiane?.battuta || '',
                // ğŸ”§ FIX: colorePersiana (sempre)
                colorePersiana: project.configPersiane?.colorePersiana || '',
                tipo: project.configPersiane?.tipo || '',
                materiale: project.configPersiane?.materiale || '',
                colore: project.configPersiane?.colore || '',
                apertura: project.configPersiane?.apertura || '',
                BRM_L: brm.L,
                BRM_H: brm.H,
                note: '',
                foto: []
            };
            
            // Log debug DETTAGLIATO PERSIANE
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('â• PERSIANA AGGIUNTA - DEBUG COMPLETO');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“Š Config Globale Persiane:', project.configPersiane);
            console.log('ğŸšª Persiana Creata:', {
                azienda: pos.persiana.azienda || 'âŒ VUOTO',
                modello: pos.persiana.modello || 'âŒ VUOTO',
                fissaggio: pos.persiana.fissaggio || 'âŒ VUOTO',
                colorePersiana: pos.persiana.colorePersiana || 'âŒ VUOTO'
            });
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            saveState();
            render();
        }
    }
}

function addTapparella(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigTapparelle);
            // UNA SOLA TAPPARELLA per posizione
            pos.tapparella = {
                id: generateId(),
                // ğŸ†• v5.30: Checkbox cosa serve - eredita da config globale
                serveTapparella: project.configTapparelle?.serveTapparella !== false,
                serveMotore: project.configTapparelle?.serveMotore || false,
                serveAccessori: project.configTapparelle?.serveAccessori || false,
                // ğŸ†• v5.40: Rilievo tapparella esistente
                tapparellaEsistente: 'manuale',
                // Dati esistenti
                qta: '1',
                azienda: project.configTapparelle?.azienda || '',
                modello: project.configTapparelle?.modello || '',
                tipo: project.configTapparelle?.tipo || '',
                materiale: project.configTapparelle?.materiale || '',
                colore: project.configTapparelle?.colore || '',
                manualeMot: project.configTapparelle?.tipologia || '',
                guida: project.configTapparelle?.guida || '',
                coloreGuida: project.configTapparelle?.coloreGuida || '',
                comando: project.configTapparelle?.comando || '',
                motoreAzienda: project.configTapparelle?.motoreAzienda || 'Somfy',
                motoreModello: project.configTapparelle?.motoreModello || '',
                BRM_L: brm.L,
                BRM_H: brm.H,
                note: '',
                foto: []
            };
            saveState();
            render();
        }
    }
}

function addZanzariera(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            // Determina il tipo in base all'infisso presente nella posizione
            const tipoInfisso = pos.infisso?.tipo || '';
            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, tipoInfisso);
            
            // ğŸ†• v5.717: Determina se F o PF basato sull'infisso
            const isPF = tipoInfisso.includes('PF') || tipoInfisso.includes('Porta');
            const tipoInfissoAssociato = isPF ? 'PF' : 'F';
            
            // ğŸ†• v5.717: Prendi default Palagina basati su F o PF
            const cfg = project.configZanzariere || {};
            const defaultLinea = isPF ? cfg.lineaPF : cfg.lineaF;
            const defaultModello = isPF ? cfg.modelloPF : cfg.modelloF;
            
            // UNA SOLA ZANZARIERA per posizione
            pos.zanzariera = {
                id: generateId(),
                qta: '1',
                tipoInfissoAssociato: tipoInfissoAssociato,
                azienda: cfg.azienda || '',
                // ğŸ†• v5.717: Campi Palagina
                linea: defaultLinea || '',
                modello: defaultModello || '',
                fasciaColore: cfg.fasciaColore || '',
                coloreTelaio: cfg.coloreTelaio || '',
                tipoRete: cfg.tipoRete || '',
                colorePlastica: cfg.colorePlastica || '',
                // Campi generici (non Palagina)
                tipo: cfg.tipo || '',
                BRM_L: brm.L,
                BRM_H: brm.H,
                note: '',
                foto: []
            };
            console.log(`ğŸ¦Ÿ Zanzariera aggiunta: tipo=${tipoInfissoAssociato}, linea=${defaultLinea}, modello=${defaultModello}`);
            saveState();
            render();
        }
    }
}

// ğŸ”’ v5.85: Funzioni Grate di Sicurezza Erreci
function addGrata(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) return;
    if (typeof GRATE_MODULE !== 'undefined') {
        pos.grata = GRATE_MODULE.createFromConfig(project, pos, calculateBRM, generateId);
        console.log('ğŸ”’ Grata aggiunta:', pos.grata);
        saveState();
        render();
    } else {
        console.error('âŒ GRATE_MODULE non caricato');
    }
}

function ricaricaGrataDaGlobali(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.grata) return;
    if (typeof GRATE_MODULE !== 'undefined') {
        const nuova = GRATE_MODULE.createFromConfig(project, pos, calculateBRM, generateId);
        nuova.id = pos.grata.id;
        nuova.qta = pos.grata.qta;
        nuova.note = pos.grata.note;
        nuova.foto = pos.grata.foto;
        pos.grata = nuova;
        saveState();
        render();
    }
}

function toggleAccessorioGrata(projectId, posId, accessorioId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.grata) return;
    if (!pos.grata.accessori) pos.grata.accessori = [];
    const idx = pos.grata.accessori.indexOf(accessorioId);
    if (idx >= 0) pos.grata.accessori.splice(idx, 1);
    else pos.grata.accessori.push(accessorioId);
    saveState();
    render();
}

function addCassonetto(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            // Prendi caratteristiche muro (override o globali)
            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                ? pos.caratteristicheMuroOverride 
                : project.caratteristicheMuro || {};
            
            // ğŸ”§ BSuperiore: Pre-compila con Battuta Superiore con Tapparella
            const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
            
            // UN SOLO CASSONETTO per posizione
            pos.cassonetto = {
                id: generateId(),
                qta: '1',
                azienda: project.configCassonetti?.azienda || '',
                tipo: project.configCassonetti?.tipo || '',
                materiale: project.configCassonetti?.materiale || '',
                finitura: project.configCassonetti?.finitura || '',
                coibentazione: project.configCassonetti?.coibentazione || '',
                // v5.54: Checkbox ereditati
                aSoffitto: project.configCassonetti?.aSoffitto || false,
                isolamentoPosaclima: project.configCassonetti?.isolamentoPosaclima || false,
                // v5.35: Nuovi campi per calcolo prezzi Finstral
                materialeCass: project.configCassonetti?.materialeCass || '',
                codiceCass: project.configCassonetti?.codiceCass || '',
                gruppoColoreCass: project.configCassonetti?.gruppoColoreCass || '',
                coloreCass: project.configCassonetti?.coloreCass || '', // v5.54
                coloreDaInfisso: project.configCassonetti?.coloreDaInfisso !== false, // v5.54 default true
                codiceIsolamento: project.configCassonetti?.codiceIsolamento || '',
                // Inizializza le misure a 0
                LS: '0',
                SRSX: '0',
                ZSX: '0',
                SRDX: '0',
                ZDX: '0',
                HCASS: '0',
                B: '0',
                C: '0',
                BSuperiore: bSuperioreDefault, // âœ… Pre-compilato con battutaSuperioreTapparella
                BRM_L: null,
                BRM_H: null,
                BRM_C: null,
                BRM_B: null,
                note: '',
                foto: []
            };
            
            // Calcola BRM iniziale (sarÃ  0 perchÃ© le misure sono 0)
            const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
            pos.cassonetto.BRM_L = brm.L;
            pos.cassonetto.BRM_H = brm.H;
            pos.cassonetto.BRM_C = brm.C;
            pos.cassonetto.BRM_B = brm.B;
            
            saveState();
            render();
        }
    }
}

function deleteProduct(projectId, posId, productType) {
    if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
        const project = state.projects.find(p => p.id === projectId);
        if (project) {
            const pos = project.positions.find(p => p.id === posId);
            if (pos && pos[productType]) {
                // Elimina il singolo prodotto
                delete pos[productType];
                saveState();
                render();
            }
        }
    }
}

// ğŸ”„ NUOVA FUNZIONE: Ricarica infisso da configurazione globale
function ricaricaInfissoDaGlobali(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.infisso) return;
    
    // Conferma azione
    if (!confirm('Ricaricare la configurazione dalle Impostazioni Globali? I dati attuali verranno sovrascritti (tranne BRM e note).')) {
        return;
    }
    
    // Salva BRM e note (non vanno sovrascritti)
    const savedBRM_L = pos.infisso.BRM_L;
    const savedBRM_H = pos.infisso.BRM_H;
    const savedNote = pos.infisso.note || '';
    const savedFoto = pos.infisso.foto || [];
    const savedQta = pos.infisso.qta || '1';
    const savedId = pos.infisso.id;
    
    // Ricarica TUTTO da config globale
    pos.infisso = {
        id: savedId,
        qta: savedQta,
        azienda: project.configInfissi?.azienda || '',
        finituraInt: project.configInfissi?.finituraInt || '',
        finituraEst: project.configInfissi?.finituraEst || '',
        coloreInt: project.configInfissi?.coloreInt || '',
        coloreEst: project.configInfissi?.coloreEst || '',
        tipoAnta: project.configInfissi?.tipoAnta || '',
        telaio: project.configInfissi?.telaio || '',
        allarme: project.configInfissi?.allarme || '',
        vetro: project.configInfissi?.vetro || '',
        cerniere: project.configInfissi?.cerniere || '',  // ğŸ†• v4.80
        tagliTelaio: project.configInfissi?.tagliTelaio || '',
        // ğŸ†• v4.81: codTagli rimosso - generato al volo da tagliTelaio
        codTagliValues: project.configInfissi?.codTagliValues ? [...project.configInfissi.codTagliValues] : [],
        maniglia: project.configInfissi?.maniglia || '',
        coloreManiglia: project.configInfissi?.coloreManiglia || '',
        BRM_L: savedBRM_L, // Mantieni BRM
        BRM_H: savedBRM_H,
        note: savedNote, // Mantieni note
        foto: savedFoto  // Mantieni foto
    };
    
    console.log('ğŸ”„ INFISSO RICARICATO DA GLOBALI:', {
        posId,
        azienda: pos.infisso.azienda,
        telaio: pos.infisso.telaio,
        coloreInt: pos.infisso.coloreInt
    });
    
    saveState();
    showNotification('âœ… Configurazione ricaricata da Globali', 'success');
    render();
}

// ğŸ”„ NUOVA FUNZIONE: Ricarica persiana da configurazione globale
function ricaricaPersianaDaGlobali(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.persiana) return;
    
    // Conferma azione
    if (!confirm('Ricaricare la configurazione dalle Impostazioni Globali? I dati attuali verranno sovrascritti (tranne BRM e note).')) {
        return;
    }
    
    // Salva BRM e note
    const savedBRM_L = pos.persiana.BRM_L;
    const savedBRM_H = pos.persiana.BRM_H;
    const savedNote = pos.persiana.note || '';
    const savedFoto = pos.persiana.foto || [];
    const savedQta = pos.persiana.qta || '1';
    const savedId = pos.persiana.id;
    
    // Ricarica TUTTO da config globale
    pos.persiana = {
        id: savedId,
        qta: savedQta,
        azienda: project.configPersiane?.azienda || '',
        modello: project.configPersiane?.modello || '',
        fissaggio: project.configPersiane?.fissaggio || '',
        tipoTelaio: (project.configPersiane?.fissaggio === 'TELAIO') 
                    ? (project.configPersiane?.tipoTelaio || '') 
                    : '',
        coloreTelaio: (project.configPersiane?.fissaggio === 'TELAIO')
                      ? (project.configPersiane?.coloreTelaio || '')
                      : '',
        battuta: project.configPersiane?.battuta || '',
        colorePersiana: project.configPersiane?.colorePersiana || '',
        tipo: project.configPersiane?.tipo || '',
        materiale: project.configPersiane?.materiale || '',
        colore: project.configPersiane?.colore || '',
        apertura: project.configPersiane?.apertura || '',
        BRM_L: savedBRM_L,
        BRM_H: savedBRM_H,
        note: savedNote,
        foto: savedFoto
    };
    
    console.log('ğŸ”„ PERSIANA RICARICATA DA GLOBALI:', {
        posId,
        azienda: pos.persiana.azienda,
        modello: pos.persiana.modello,
        fissaggio: pos.persiana.fissaggio
    });
    
    saveState();
    showNotification('âœ… Configurazione ricaricata da Globali', 'success');
    render();
}

function updateProduct(projectId, posId, productType, field, value) {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos[productType]) {
            // ğŸ†• FASE 016: qta=0 Ã¨ VALIDO - prodotto rimane visibile e modificabile
            pos[productType][field] = value;
            
            // ğŸ†• v4.78: Se PVC/PVC, sincronizza coloreInt e coloreEst nella posizione
            if (productType === 'infisso') {
                const inf = pos.infisso;
                const isPvcPvc = inf.finituraInt === 'pvc' && inf.finituraEst === 'pvc';
                
                if (isPvcPvc) {
                    if (field === 'coloreInt') {
                        inf.coloreEst = value;
                        console.log('ğŸ¨ v4.78: PVC/PVC posizione â†’ coloreEst sincronizzato');
                        // ğŸ†• v4.83: Aggiorna UI immediatamente
                        saveState();
                        render();
                        return; // Evita doppio render
                    } else if (field === 'coloreEst') {
                        inf.coloreInt = value;
                        console.log('ğŸ¨ v4.78: PVC/PVC posizione â†’ coloreInt sincronizzato');
                        // ğŸ†• v4.83: Aggiorna UI immediatamente
                        saveState();
                        render();
                        return; // Evita doppio render
                    }
                }
                
                // ğŸ†• v5.68: Reset esecuzione quando cambia finitura interna a ALU/LEGNO
                if (field === 'finituraInt') {
                    const nuovaFinitura = value.toLowerCase();
                    if ((nuovaFinitura === 'alluminio' || nuovaFinitura === 'legno' || nuovaFinitura === 'alu') && inf.esecuzione1 === '0') {
                        inf.esecuzione1 = '3';
                        console.log(`ğŸ”§ v5.68: Esecuzione reset a .3 (${nuovaFinitura} non supporta .0)`);
                    }
                }
            }
            
            // INFISSI: Se cambia tagliTelaio, RESET dei codTagliValues per aggiornamento immediato
            if (productType === 'infisso' && field === 'tagliTelaio') {
                // ğŸ†• v4.81: Usa getPosizioniTagli() invece di salvare codTagli
                const posizioniTagli = getPosizioniTagli(value);
                
                // Sincronizza codTagliValues
                if (project.configInfissi?.codTagliValues?.length === posizioniTagli.length) {
                    pos[productType].codTagliValues = [...project.configInfissi.codTagliValues];
                } else {
                    pos[productType].codTagliValues = new Array(posizioniTagli.length).fill('');
                }
            }
            
            // INFISSI: Se cambia il tipo (F1->PF1 etc), ricalcola BRM di infisso E zanzariera
            if (productType === 'infisso' && field === 'tipo') {
                const inf = pos.infisso;
                // Ricalcola BRM infisso
                if (inf.brmPersonalizzato) {
                    const brm = calculateBRM(project, pos, pos.misure, inf.brmPersonalizzato, value);
                    inf.BRM_L = brm.L;
                    inf.BRM_H = brm.H;
                } else {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi, value);
                    inf.BRM_L = brm.L;
                    inf.BRM_H = brm.H;
                }
                
                // Ricalcola anche BRM zanzariera se presente
                if (pos.zanzariera) {
                    const zan = pos.zanzariera;
                    if (zan.brmPersonalizzato) {
                        const brm = calculateBRM(project, pos, pos.misure, zan.brmPersonalizzato, value);
                        zan.BRM_L = brm.L;
                        zan.BRM_H = brm.H;
                    } else {
                        const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, value);
                        zan.BRM_L = brm.L;
                        zan.BRM_H = brm.H;
                    }
                }
                
                // ğŸ¯ AUTO-SELEZIONE tipoInfissoAssociato per INFISSO
                let autoTipo = null;
                if (value && value.includes('PF')) {
                    // PF1, PF2, PF3 â†’ Porta Finestra
                    autoTipo = 'PF';
                } else if (value && (value.match(/F\d/) || value === 'FISSO' || value === 'HST')) {
                    // F1, F2, F3, FISSO, HST â†’ Finestra
                    autoTipo = 'F';
                }
                if (autoTipo) {
                    inf.tipoInfissoAssociato = autoTipo;
                    console.log(`âœ… Auto-selezionato tipoInfissoAssociato: ${autoTipo} per infisso tipo ${value}`);
                }
            }
            
            // ğŸ†• v5.560: INFISSI - Ricalcola BRM quando cambia tipoInfissoAssociato (F/PF)
            if (productType === 'infisso' && field === 'tipoInfissoAssociato') {
                const inf = pos.infisso;
                const tipoPerBRM = value === 'PF' ? 'PF' : 'F';
                
                // Ricalcola BRM infisso con nuovo tipo
                if (inf.brmPersonalizzato) {
                    const brm = calculateBRM(project, pos, pos.misure, inf.brmPersonalizzato, tipoPerBRM);
                    inf.BRM_L = brm.L;
                    inf.BRM_H = brm.H;
                } else {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi, tipoPerBRM);
                    inf.BRM_L = brm.L;
                    inf.BRM_H = brm.H;
                }
                
                console.log(`ğŸ”„ Ricalcolato BRM infisso per tipoInfissoAssociato=${value}: L=${inf.BRM_L}, H=${inf.BRM_H}`);
                render();
            }
            
            // ğŸ¯ PERSIANE: Auto-selezione tipoInfissoAssociato  
            if (productType === 'persiana' && field === 'tipo') {
                const per = pos.persiana;
                let autoTipo = null;
                if (value && value.includes('PF')) {
                    // PF1, PF2, PF3 â†’ Porta Finestra
                    autoTipo = 'PF';
                } else if (value && value.match(/F[A\d]/)) {
                    // F1, F2, F3 â†’ Finestra
                    autoTipo = 'F';
                }
                if (autoTipo) {
                    per.tipoInfissoAssociato = autoTipo;
                    console.log(`âœ… Auto-selezionato tipoInfissoAssociato: ${autoTipo} per persiana tipo ${value}`);
                }
            }
            
            // CASSONETTI: Se cambiano le misure, ricalcola il BRM
            const misureCassonetto = ['LS', 'SRSX', 'ZSX', 'SRDX', 'ZDX', 'HCASS', 'B', 'C', 'BSuperiore'];
            if (productType === 'cassonetto' && misureCassonetto.includes(field)) {
                const cas = pos.cassonetto;
                if (cas.brmPersonalizzato) {
                    // Usa formula personalizzata
                    const brm = calculateBRM(project, pos, cas, cas.brmPersonalizzato);
                    cas.BRM_L = brm.L;
                    cas.BRM_H = brm.H;
                } else {
                    // Usa formula globale
                    const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                    cas.BRM_L = brm.L;
                    cas.BRM_H = brm.H;
                }
            }
            
            saveState();
            
            // ğŸ”„ Re-render SOLO se cambiato tipo (infisso/persiana) per aggiornare tipoInfissoAssociato radio
            if ((productType === 'infisso' || productType === 'persiana') && field === 'tipo') {
                render();
            }
            
            // ğŸ”§ v4.44: Re-render se cambiato fissaggio persiane per mostrare/nascondere telai
            if (productType === 'persiana' && field === 'fissaggio') {
                render();
            }
            
            // ğŸ”§ v5.47: Re-render se cambiano campi ferramenta per aggiornare preview codice
            if (productType === 'infisso' && (field === 'ferramenta1' || field === 'lato1' || field === 'esecuzione1' || field === 'azienda' || field === 'codiceModello')) {
                render();
            }
            
            // ğŸ”§ v5.710: Re-render se cambia tipoAnta per mostrare/nascondere sezione Anta Twin
            if (productType === 'infisso' && field === 'tipoAnta') {
                console.log('ğŸ”„ v5.710: tipoAnta posizione cambiato, trigger render() per sezione Anta Twin');
                render();
            }
            
            // ğŸ”§ v5.53: AUTO-CALCOLO CERNIERE da ferramenta
            if (productType === 'infisso' && field === 'ferramenta1') {
                const ferr = value || '';
                let cerniere = '';
                // Cerniere A-VISTA: codici 4xx
                if (['411', '409', '430', '453', '425', '475', '473', '471', 'B411'].includes(ferr)) {
                    cerniere = 'a-vista';
                }
                // Cerniere A-SCOMPARSA: codici 2xx
                else if (['211', '209', '230', '232', '225', '275', 'B211'].includes(ferr)) {
                    cerniere = 'a-scomparsa';
                }
                // Scorrevoli 7xx: nessuna cerniera
                // Salva automaticamente
                if (cerniere) {
                    pos.infisso.cerniere = cerniere;
                    console.log(`ğŸ”© v5.53: Cerniere auto-calcolate: ${ferr} â†’ ${cerniere}`);
                }
            }
            
            // ğŸ†• v5.28: Re-render se cambiano i checkbox "cosa serve" tapparella
            if (productType === 'tapparella' && (field === 'serveTapparella' || field === 'serveMotore' || field === 'serveAccessori')) {
                render();
            }
            
            // RIMOSSO: render() per evitare reload pagina dopo ogni modifica
            // I dati sono giÃ  salvati, non serve ricaricare la pagina
            // Solo in casi specifici dove cambia la struttura HTML servirebbe,
            // ma anche lÃ¬ Ã¨ meglio aggiornare solo la parte necessaria
        }
    }
}

// Validazione B-C per cassonetti
function validateCassonettoBC(projectId, posId) {
    // âœ… v4.86: Aggiorna controllo B-C in tempo reale
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.cassonetto) return;
    
    const cas = pos.cassonetto;
    const validationDiv = document.getElementById(`bc-validation-${posId}`);
    if (!validationDiv) return;
    
    // Leggi valori aggiornati dai campi input (non da cas che potrebbe non essere ancora aggiornato)
    const bInput = validationDiv.parentElement.querySelector('input[onchange*="\'B\'"]');
    const cInput = validationDiv.parentElement.querySelector('input[onchange*="\'C\'"]');
    
    const b = bInput ? parseFloat(bInput.value) || 0 : parseFloat(cas.B) || 0;
    const c = cInput ? parseFloat(cInput.value) || 0 : parseFloat(cas.C) || 0;
    const diff = b - c;
    
    // Prendi Prof. Muro Int (override o globale)
    const profMuroInt = pos.caratteristicheMuroOverride?.profMuroInt 
        ? parseFloat(pos.caratteristicheMuroOverride.profMuroInt) 
        : parseFloat(project.caratteristicheMuro?.profMuroInt) || 0;
    
    let html = '';
    
    if (b === 0 || c === 0 || profMuroInt === 0) {
        html = `
            <div class="mt-3 bg-gray-100 border-l-4 border-gray-400 p-3">
                <p class="text-sm text-gray-600">
                    â„¹ï¸ Inserisci B, C e Prof. Muro Int per attivare il controllo
                </p>
            </div>
        `;
    } else {
        const differenza = Math.abs(diff - profMuroInt);
        const isValid = differenza <= 10;
        
        if (isValid) {
            html = `
                <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-3">
                    <p class="text-sm text-green-800">
                        âœ… <strong>Controllo OK:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm âœ“
                    </p>
                </div>
            `;
        } else {
            html = `
                <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-3">
                    <p class="text-sm text-red-800">
                        âš ï¸ <strong>ATTENZIONE:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm (Tolleranza Â±10mm superata!)
                    </p>
                </div>
            `;
        }
    }
    
    validationDiv.innerHTML = html;
}

// âœ… v4.87: Gestione radio button ZSX (Spazio Sinistra)
function updateZSXTipo(projectId, posId, tipo) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.cassonetto) return;
    
    pos.cassonetto.ZSX_tipo = tipo;
    
    // Se muro o libero, ZSX non serve (imposta a 0 o valore speciale)
    if (tipo === 'muro') {
        pos.cassonetto.ZSX = '0';
    } else if (tipo === 'libero') {
        pos.cassonetto.ZSX = '999'; // Valore che indica "spazio illimitato"
    }
    // Se limitato, mantieni il valore esistente o aspetta input
    
    // âœ… v4.87: Ricalcola BRM con nuovo allargamento
    if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
        const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
        pos.cassonetto.BRM_L = brm.L;
        pos.cassonetto.BRM_H = brm.H;
        pos.cassonetto.BRM_C = brm.C;
        pos.cassonetto.BRM_B = brm.B;
    }
    
    saveState();
    render();
}

// âœ… v4.87: Gestione radio button ZDX (Spazio Destra)
function updateZDXTipo(projectId, posId, tipo) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.cassonetto) return;
    
    pos.cassonetto.ZDX_tipo = tipo;
    
    // Se muro o libero, ZDX non serve (imposta a 0 o valore speciale)
    if (tipo === 'muro') {
        pos.cassonetto.ZDX = '0';
    } else if (tipo === 'libero') {
        pos.cassonetto.ZDX = '999'; // Valore che indica "spazio illimitato"
    }
    // Se limitato, mantieni il valore esistente o aspetta input
    
    // âœ… v4.87: Ricalcola BRM con nuovo allargamento
    if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
        const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
        pos.cassonetto.BRM_L = brm.L;
        pos.cassonetto.BRM_H = brm.H;
        pos.cassonetto.BRM_C = brm.C;
        pos.cassonetto.BRM_B = brm.B;
    }
    
    saveState();
    render();
}

// âœ… v4.97: Validazione ZSX - deve essere â‰¤ SRSX
function validateAndUpdateZSX(projectId, posId, value) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.cassonetto) return;
    
    const zsx = parseInt(value) || 0;
    const srsx = parseInt(pos.cassonetto.SRSX) || 0;
    
    // Salva sempre il valore (la validazione Ã¨ visiva)
    pos.cassonetto.ZSX = value;
    
    // Log per debug
    if (zsx > srsx && srsx > 0) {
        console.warn(`âš ï¸ ZSX (${zsx}mm) > SRSX (${srsx}mm) - Errore logico!`);
    }
    
    // Ricalcola BRM
    if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
        const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
        pos.cassonetto.BRM_L = brm.L;
        pos.cassonetto.BRM_H = brm.H;
        pos.cassonetto.BRM_C = brm.C;
        pos.cassonetto.BRM_B = brm.B;
    }
    
    saveState();
    render();
}

// âœ… v4.97: Validazione ZDX - deve essere â‰¤ SRDX
function validateAndUpdateZDX(projectId, posId, value) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.cassonetto) return;
    
    const zdx = parseInt(value) || 0;
    const srdx = parseInt(pos.cassonetto.SRDX) || 0;
    
    // Salva sempre il valore (la validazione Ã¨ visiva)
    pos.cassonetto.ZDX = value;
    
    // Log per debug
    if (zdx > srdx && srdx > 0) {
        console.warn(`âš ï¸ ZDX (${zdx}mm) > SRDX (${srdx}mm) - Errore logico!`);
    }
    
    // Ricalcola BRM
    if (!pos.cassonetto.brmPersonalizzato && project.brmConfigCassonetti) {
        const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
        pos.cassonetto.BRM_L = brm.L;
        pos.cassonetto.BRM_H = brm.H;
        pos.cassonetto.BRM_C = brm.C;
        pos.cassonetto.BRM_B = brm.B;
    }
    
    saveState();
    render();
}

// Validazione in tempo reale per le altezze (mentre scrivi)
function validateAltezzeRealTime(projectId, posId) {
    // Leggi i valori dai campi DOM
    const hsoffEl = document.getElementById(`hsoff-${posId}`);
    const hparapSoffEl = document.getElementById(`hparapsoff-${posId}`);
    const hpavParapEl = document.getElementById(`hpavparap-${posId}`);
    const validationMsgEl = document.getElementById(`validation-msg-${posId}`);
    
    if (!hsoffEl || !hparapSoffEl || !hpavParapEl || !validationMsgEl) return;
    
    const hsoff = parseFloat(hsoffEl.value) || 0;
    const hparapSoff = parseFloat(hparapSoffEl.value) || 0;
    const hpavParap = parseFloat(hpavParapEl.value) || 0;
    
    // Reset a grigio se mancano valori
    if (hsoff === 0 || hparapSoff === 0 || hpavParap === 0) {
        hsoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
        hparapSoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
        hpavParapEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
        validationMsgEl.innerHTML = '';
        return;
    }
    
    // Calcola validazione
    const somma = hpavParap + hparapSoff;
    const diff = Math.abs(somma - hsoff);
    
    if (diff <= 10) {
        // Verde - OK
        const borderClass = 'w-full px-3 py-2 border-2 border-green-500 rounded font-semibold';
        hsoffEl.className = borderClass;
        hparapSoffEl.className = borderClass;
        hpavParapEl.className = borderClass;
        validationMsgEl.innerHTML = `
            <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                <p class="text-xs text-green-800">
                    âœ… <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm âœ“
                </p>
            </div>
        `;
    } else {
        // Rosso - ERRORE
        const borderClass = 'w-full px-3 py-2 border-2 border-red-500 rounded font-semibold';
        hsoffEl.className = borderClass;
        hparapSoffEl.className = borderClass;
        hpavParapEl.className = borderClass;
        validationMsgEl.innerHTML = `
            <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                <p class="text-xs text-red-800">
                    âš ï¸ <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                </p>
            </div>
        `;
    }
}

// Personalizza BRM per questa specifica posizione
window.personalizzaBRM = (projectId, posId, productType) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos[productType]) {
            const product = pos[productType];
            
            const configMap = {
                'infisso': 'brmConfigInfissi',
                'persiana': 'brmConfigPersiane',
                'tapparella': 'brmConfigTapparelle',
                'zanzariera': 'brmConfigZanzariere',
                'cassonetto': 'brmConfigCassonetti'
            };
            const configKey = configMap[productType];
            
            // Crea brmPersonalizzato copiando la config globale come base
            if (configKey && project[configKey]) {
                const globalConfig = project[configKey];
                product.brmPersonalizzato = {
                    misuraBaseL: globalConfig.misuraBaseL || '',
                    operazioneL: globalConfig.operazioneL || '-',
                    valoreL: globalConfig.valoreL || '0',
                    misuraBaseH: globalConfig.misuraBaseH || '',
                    operazioneH: globalConfig.operazioneH || '-',
                    valoreH: globalConfig.valoreH || '0'
                };
                
                // Se Ã¨ un cassonetto, aggiungi anche C e B
                if (productType === 'cassonetto') {
                    product.brmPersonalizzato.misuraBaseC = globalConfig.misuraBaseC || '';
                    product.brmPersonalizzato.operazioneC = globalConfig.operazioneC || '-';
                    product.brmPersonalizzato.valoreC = globalConfig.valoreC || '0';
                    product.brmPersonalizzato.misuraBaseB = globalConfig.misuraBaseB || '';
                    product.brmPersonalizzato.operazioneB = globalConfig.operazioneB || '-';
                    product.brmPersonalizzato.valoreB = globalConfig.valoreB || '0';
                }
                
                // Determina il tipo per infissi e zanzariere
                let tipo = null;
                if (productType === 'infisso') {
                    tipo = product.tipo;
                } else if (productType === 'zanzariera') {
                    tipo = pos.infisso?.tipo || '';
                }
                
                // Ricalcola BRM con la formula personalizzata
                const misure = (productType === 'cassonetto') ? product : pos.misure;
                const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                product.BRM_L = brm.L;
                product.BRM_H = brm.H;
                if (productType === 'cassonetto') {
                    product.BRM_C = brm.C;
                    product.BRM_B = brm.B;
                }
            }
            
            saveState();
            render();
        }
    }
}

// âœ… APPLICA MODIFICHE BRM - Conferma e salva le modifiche al BRM personalizzato
window.applicaBRMPersonalizzato = (projectId, posId, productType) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos[productType] && pos[productType].brmPersonalizzato) {
            const product = pos[productType];
            
            // âœ… FIX: LEGGI I VALORI CORRENTI DAL DOM prima di salvare!
            const misuraBaseLSelect = document.querySelector(`#brm-misuraBaseL-${productType}-${posId}`);
            const operazioneLSelect = document.querySelector(`#brm-operazioneL-${productType}-${posId}`);
            const valoreLInput = document.querySelector(`#brm-valoreL-${productType}-${posId}`);
            const misuraBaseHSelect = document.querySelector(`#brm-misuraBaseH-${productType}-${posId}`);
            const operazioneHSelect = document.querySelector(`#brm-operazioneH-${productType}-${posId}`);
            const valoreHInput = document.querySelector(`#brm-valoreH-${productType}-${posId}`);
            
            // Aggiorna lo state con i valori dal DOM
            if (misuraBaseLSelect) product.brmPersonalizzato.misuraBaseL = misuraBaseLSelect.value;
            if (operazioneLSelect) product.brmPersonalizzato.operazioneL = operazioneLSelect.value;
            // âœ… FIX: Converti il valore in positivo (valore assoluto)
            if (valoreLInput) product.brmPersonalizzato.valoreL = Math.abs(parseFloat(valoreLInput.value) || 0).toString();
            if (misuraBaseHSelect) product.brmPersonalizzato.misuraBaseH = misuraBaseHSelect.value;
            if (operazioneHSelect) product.brmPersonalizzato.operazioneH = operazioneHSelect.value;
            // âœ… FIX: Converti il valore in positivo (valore assoluto)
            if (valoreHInput) product.brmPersonalizzato.valoreH = Math.abs(parseFloat(valoreHInput.value) || 0).toString();
            
            // Se Ã¨ un cassonetto, gestisci anche C e B
            if (productType === 'cassonetto') {
                const misuraBaseCSelect = document.querySelector(`#brm-misuraBaseC-${productType}-${posId}`);
                const operazioneCSelect = document.querySelector(`#brm-operazioneC-${productType}-${posId}`);
                const valoreCInput = document.querySelector(`#brm-valoreC-${productType}-${posId}`);
                const misuraBaseBSelect = document.querySelector(`#brm-misuraBaseB-${productType}-${posId}`);
                const operazioneBSelect = document.querySelector(`#brm-operazioneB-${productType}-${posId}`);
                const valoreBInput = document.querySelector(`#brm-valoreB-${productType}-${posId}`);
                
                if (misuraBaseCSelect) product.brmPersonalizzato.misuraBaseC = misuraBaseCSelect.value;
                if (operazioneCSelect) product.brmPersonalizzato.operazioneC = operazioneCSelect.value;
                // âœ… FIX: Converti il valore in positivo (valore assoluto)
                if (valoreCInput) product.brmPersonalizzato.valoreC = Math.abs(parseFloat(valoreCInput.value) || 0).toString();
                if (misuraBaseBSelect) product.brmPersonalizzato.misuraBaseB = misuraBaseBSelect.value;
                if (operazioneBSelect) product.brmPersonalizzato.operazioneB = operazioneBSelect.value;
                // âœ… FIX: Converti il valore in positivo (valore assoluto)
                if (valoreBInput) product.brmPersonalizzato.valoreB = Math.abs(parseFloat(valoreBInput.value) || 0).toString();
            }
            
            // Determina il tipo per infissi e zanzariere
            let tipo = null;
            if (productType === 'infisso') {
                tipo = product.tipo;
            } else if (productType === 'zanzariera') {
                tipo = pos.infisso?.tipo || '';
            }
            
            // Ricalcola BRM con i nuovi valori
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
            product.BRM_L = brm.L;
            product.BRM_H = brm.H;
            if (productType === 'cassonetto') {
                product.BRM_C = brm.C;
                product.BRM_B = brm.B;
            }
            
            // Salva lo stato
            saveState();
            
            // Fai un render completo per consolidare le modifiche
            render();
            
            // Mostra notifica di successo
            if (productType === 'cassonetto') {
                showNotification(`âœ… BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm, C=${brm.C || '?'}mm, B=${brm.B || '?'}mm`, 'success');
            } else {
                showNotification(`âœ… BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
            }
        }
    }
}

// Ripristina uso formula globale (elimina personalizzazione)
window.ripristinaGlobale = (projectId, posId, productType) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos[productType]) {
            const product = pos[productType];
            
            // Elimina il brmPersonalizzato
            delete product.brmPersonalizzato;
            
            const configMap = {
                'infisso': 'brmConfigInfissi',
                'persiana': 'brmConfigPersiane',
                'tapparella': 'brmConfigTapparelle',
                'zanzariera': 'brmConfigZanzariere',
                'cassonetto': 'brmConfigCassonetti'
            };
            const configKey = configMap[productType];
            
            // Determina il tipo per infissi e zanzariere
            let tipo = null;
            if (productType === 'infisso') {
                tipo = product.tipo;
            } else if (productType === 'zanzariera') {
                tipo = pos.infisso?.tipo || '';
            }
            
            // Ricalcola BRM con la config globale
            if (configKey) {
                const misure = (productType === 'cassonetto') ? product : pos.misure;
                const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                product.BRM_L = brm.L;
                product.BRM_H = brm.H;
                if (productType === 'cassonetto') {
                    product.BRM_C = brm.C;
                    product.BRM_B = brm.B;
                }
            }
            
            saveState();
            render();
        }
    }
}

// Forza ricalcolo BRM per cassonetto (solo quando Usa Globale Ã¨ attivo)
window.ricalcolaBRMCassonetto = (projectId, posId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.cassonetto) {
            const cas = pos.cassonetto;
            
            // Prendi caratteristiche muro (override o globali)
            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                ? pos.caratteristicheMuroOverride 
                : project.caratteristicheMuro || {};
            
            // ğŸ”§ BSuperiore: Pre-compila con Battuta Superiore con Tapparella
            const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
            
            // Assicurati che tutte le misure esistano
            if (!cas.LS) cas.LS = '0';
            if (!cas.SRSX) cas.SRSX = '0';
            if (!cas.ZSX) cas.ZSX = '0';
            if (!cas.SRDX) cas.SRDX = '0';
            if (!cas.ZDX) cas.ZDX = '0';
            if (!cas.HCASS) cas.HCASS = '0';
            if (!cas.B) cas.B = '0';
            if (!cas.C) cas.C = '0';
            // âœ… FASE 015: Inizializza BSuperiore SOLO se mancante
            // NON sovrascrivere '0' esplicito dell'utente!
            if (cas.BSuperiore === undefined || cas.BSuperiore === null || cas.BSuperiore === '') {
                // Pre-compila con battutaSuperioreTapparella se mancante
                cas.BSuperiore = bSuperioreDefault;
            }
            
            // Ricalcola BRM (solo con formula globale, non personalizzata)
            if (!cas.brmPersonalizzato) {
                const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                cas.BRM_L = brm.L;
                cas.BRM_H = brm.H;
                cas.BRM_C = brm.C;
                cas.BRM_B = brm.B;
                
                saveState();
                render();
                showNotification('BRM ricalcolato! L=' + (cas.BRM_L || 'null') + 'mm, H=' + (cas.BRM_H || 'null') + 'mm, C=' + (cas.BRM_C || 'null') + 'mm, B=' + (cas.BRM_B || 'null') + 'mm', 'success');
            } else {
                showNotification('Non puoi ricalcolare BRM con formula personalizzata. Prima ripristina la formula globale.', 'error');
            }
        }
    }
};

// Aggiorna formula BRM personalizzata per un prodotto
function updateBRMPersonalizzato(projectId, posId, productType, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos[productType]) {
            const product = pos[productType];
            if (!product.brmPersonalizzato) {
                product.brmPersonalizzato = {
                    misuraBaseL: '', operazioneL: '+', valoreL: '0',
                    misuraBaseH: '', operazioneH: '+', valoreH: '0'
                };
            }
            
            // âœ… FIX: Converti sempre i valori mm in positivi (valore assoluto)
            if (field.startsWith('valore') && !isNaN(value)) {
                value = Math.abs(parseFloat(value)).toString();
            }
            
            // Salva il valore
            product.brmPersonalizzato[field] = value;
            
            // Per i cassonetti, le misure sono nel cassonetto stesso
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            
            // Determina il tipo per infissi e zanzariere
            let tipo = null;
            if (productType === 'infisso') {
                tipo = product.tipo;
            } else if (productType === 'zanzariera') {
                tipo = pos.infisso?.tipo || '';
            }
            
            // Ricalcola BRM con la nuova formula
            const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
            product.BRM_L = brm.L;
            product.BRM_H = brm.H;
            
            // Salva PRIMA di aggiornare l'interfaccia
            saveState();
            
            // âœ… FIX: Aggiorna SOLO i valori BRM visualizzati, NON ricreare tutto il DOM
            updateBRMDisplay(projectId, posId, productType, product);
            
            // Mostra una notifica con il nuovo valore BRM
            showNotification(`BRM aggiornato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
        }
    }
}

// âœ… NUOVA FUNZIONE: Aggiorna solo i valori BRM visualizzati senza ricreare i dropdown
function updateBRMDisplay(projectId, posId, productType, product) {
    // Aggiorna la formula visualizzata
    const formulaL = document.querySelector(`#formula-brm-l-${productType}-${posId}`);
    const formulaH = document.querySelector(`#formula-brm-h-${productType}-${posId}`);
    
    if (formulaL && product.brmPersonalizzato) {
        formulaL.textContent = `= ${product.brmPersonalizzato.misuraBaseL || '?'} ${product.brmPersonalizzato.operazioneL || '+'} ${product.brmPersonalizzato.valoreL || '0'}mm`;
    }
    
    if (formulaH && product.brmPersonalizzato) {
        formulaH.textContent = `= ${product.brmPersonalizzato.misuraBaseH || '?'} ${product.brmPersonalizzato.operazioneH || '+'} ${product.brmPersonalizzato.valoreH || '0'}mm`;
    }
    
    // Aggiorna i risultati BRM
    const brmLResult = document.querySelector(`#brm-l-result-${productType}-${posId}`);
    const brmHResult = document.querySelector(`#brm-h-result-${productType}-${posId}`);
    
    if (brmLResult) {
        // âœ… FASE 015: Distingui 0 (valido) da mancante
        brmLResult.textContent = (product.BRM_L !== undefined && product.BRM_L !== null && product.BRM_L !== '') 
            ? product.BRM_L 
            : '-';
    }
    
    if (brmHResult) {
        // âœ… FASE 015: Distingui 0 (valido) da mancante
        brmHResult.textContent = (product.BRM_H !== undefined && product.BRM_H !== null && product.BRM_H !== '') 
            ? product.BRM_H 
            : '-';
    }
}

// === FASE 23A: GESTIONE COD.TAGLI ===

// Funzione per aggiornare la config globale degli infissi
window.updateConfigInfissi = (projectId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configInfissi) {
            project.configInfissi = {};
        }
        
        // Log per debug
        console.log('ğŸ”§ Config Globale aggiornata:', field, '=', value);
        
        // Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configInfissi[field];
        console.log('   oldValue:', oldValue);
        
        project.configInfissi[field] = value;
        
        // ğŸ†• v4.78: Se PVC/PVC, sincronizza coloreInt e coloreEst
        const isPvcPvc = project.configInfissi.finituraInt === 'pvc' && 
                         project.configInfissi.finituraEst === 'pvc';
        
        if (isPvcPvc) {
            if (field === 'coloreInt') {
                project.configInfissi.coloreEst = value;
                console.log('ğŸ¨ v4.78: PVC/PVC â†’ coloreEst sincronizzato a:', value);
                // Sincronizza anche coloreEst alle posizioni
                syncConfigToPositions(project, 'infisso', 'coloreEst', value, oldValue);
                // ğŸ†• v4.83: Aggiorna UI immediatamente
                render();
            } else if (field === 'coloreEst') {
                project.configInfissi.coloreInt = value;
                console.log('ğŸ¨ v4.78: PVC/PVC â†’ coloreInt sincronizzato a:', value);
                // Sincronizza anche coloreInt alle posizioni
                syncConfigToPositions(project, 'infisso', 'coloreInt', value, oldValue);
                // ğŸ†• v4.83: Aggiorna UI immediatamente
                render();
            }
        }
        
        // Se cambia tagliTelaio, RESET immediato dei codTagli per forzare aggiornamento
        if (field === 'tagliTelaio') {
            // ğŸ†• v4.81: Usa getPosizioniTagli() invece di salvare codTagli
            const posizioniTagli = getPosizioniTagli(value);
            
            // Inizializza codTagliValues con stringhe vuote (basato su numero posizioni)
            project.configInfissi.codTagliValues = new Array(posizioniTagli.length).fill('');
            
            console.log('   posizioniTagli generate:', posizioniTagli);
            console.log('   codTagliValues inizializzati:', project.configInfissi.codTagliValues);
            
            // ğŸ†• SYNC AUTOMATICO tagliTelaio A TUTTE LE POSIZIONI
            if (project.positions) {
                let posizioniAggiornate = 0;
                project.positions.forEach(pos => {
                    if (pos.infisso) {
                        // Aggiorna tagliTelaio
                        pos.infisso.tagliTelaio = value;
                        // ğŸ†• v4.81: Non salva piÃ¹ codTagli, lo genera al volo
                        // Reset codTagliValues se numero diverso, altrimenti mantieni
                        if (pos.infisso.codTagliValues?.length !== posizioniTagli.length) {
                            pos.infisso.codTagliValues = new Array(posizioniTagli.length).fill('');
                        }
                        posizioniAggiornate++;
                    }
                });
                console.log(`âœ… Aggiornati tagliTelaio in ${posizioniAggiornate} posizioni`);
            }
            
            // Sincronizza codTagliValues con le posizioni
            syncConfigToPositions(project, 'infisso', 'codTagliValues', project.configInfissi.codTagliValues, null);
            
            // ğŸ†• RENDER IMMEDIATO per aggiornare i campi codice
            render();
        }
        
        // AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        console.log('   Chiamo syncConfigToPositions...');
        let posizioniAggiornate = syncConfigToPositions(project, 'infisso', field, value, oldValue);
        console.log(`   âœ… ${posizioniAggiornate} posizioni sincronizzate`);
        
        saveState();
        
        // ğŸ†• v5.710: Re-render se cambia tipoAnta per mostrare/nascondere sezione Anta Twin
        if (field === 'tipoAnta') {
            console.log('ğŸ”„ v5.710: tipoAnta cambiato, trigger render() per sezione Anta Twin');
            render();
        }
        
        // ğŸ†• v5.50: Re-render se cambia azienda per mostrare/nascondere campi Finstral
        if (field === 'azienda') {
            render();
        }
        
        // ğŸ†• v5.54: Se cambia coloreInt, render per aggiornare cassonetti con sync attivo
        if (field === 'coloreInt') {
            render();
        }
        // render(); â† RIMOSSO: Evita reload pagina, mantiene focus
    }
};

// ğŸ†• v5.54: Funzione chiamata quando si attiva checkbox "= colore serramento"
// Non serve fare nulla di speciale, basta render() per mostrare il nuovo valore
window.sincronizzaColoreCassonetto = (projectId) => {
    render();
};

// ğŸ†• v5.54: Funzione chiamata quando si attiva checkbox in posizione
window.sincronizzaColoreCassonettoPos = (projectId, posId) => {
    render();
};

// Funzione per aggiornare i VALORI dei COD.TAGLI (non le etichette)
window.updateCodTagliValue = (projectId, index, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configInfissi.codTagliValues) {
            project.configInfissi.codTagliValues = [];
        }
        
        // Salva il vecchio array PRIMA di aggiornare
        const oldValue = [...(project.configInfissi.codTagliValues || [])];
        
        project.configInfissi.codTagliValues[index] = value;
        
        // AUTO-SYNC: Aggiorna automaticamente le posizioni
        syncConfigToPositions(project, 'infisso', 'codTagliValues', project.configInfissi.codTagliValues, oldValue);
        
        saveState();
    }
};

// FORZA SINCRONIZZAZIONE: Sincronizza TUTTI i campi config â†’ posizioni (anche array vuoti)
window.forzaSincronizzazioneInfissi = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.configInfissi) {
        alert('âŒ Nessuna configurazione infissi trovata!');
        return;
    }
    
    // Verifica se la config ha effettivamente valori
    const configHaValori = (
        project.configInfissi.azienda ||
        project.configInfissi.telaio ||
        project.configInfissi.coloreInt ||
        // ğŸ†• v4.85: Usa tagliTelaio invece di codTagli (rimosso)
        project.configInfissi.tagliTelaio
    );
    
    if (!configHaValori) {
        alert('âš ï¸ CONFIG GLOBALE VUOTA!\n\nImposta prima i valori nella Config Globale, poi sincronizza.');
        return;
    }
    
    if (!confirm('ğŸ”„ SINCRONIZZARE TUTTI GLI INFISSI?\n\nQuesto aggiornerÃ  TUTTE le posizioni con i valori della Config Globale, sovrascrivendo anche i campi vuoti.\n\nLe modifiche manuali nelle singole posizioni NON verranno sovrascritte.')) {
        return;
    }
    
    console.log('ğŸ”„ FORZA SINCRONIZZAZIONE INFISSI');
    console.log('   Config:', project.configInfissi);
    
    let contatore = 0;
    const campiDaSincronizzare = [
        'azienda', 'tipoAnta', 'finituraInt', 'finituraEst', 
        'coloreInt', 'coloreEst', 'telaio', 'allarme', 'vetro', 'cerniere',
        'tagliTelaio', 'codTagliValues', 'maniglia', 'coloreManiglia'  // ğŸ†• v4.81: rimosso codTagli
    ];
    
    project.positions.forEach(pos => {
        if (pos.infisso) {
            console.log(`   Posizione ${pos.id}:`);
            campiDaSincronizzare.forEach(field => {
                const currentValue = pos.infisso[field];
                const configValue = project.configInfissi[field];
                
                // Sincronizza se:
                // 1. Campo vuoto/undefined/null
                // 2. Array vuoto []
                // 3. Stringa vuota ''
                const isEmpty = (
                    currentValue === undefined ||
                    currentValue === null ||
                    currentValue === '' ||
                    (Array.isArray(currentValue) && currentValue.length === 0)
                );
                
                // NON sincronizzare se la config ha array vuoti o valori vuoti
                const configHasValue = configValue !== undefined && 
                                      configValue !== null && 
                                      configValue !== '' &&
                                      (!Array.isArray(configValue) || configValue.length > 0);
                
                console.log(`     ${field}: pos="${currentValue}" config="${configValue}" isEmpty=${isEmpty} configHasValue=${configHasValue}`);
                
                if (isEmpty && configHasValue) {
                    if (Array.isArray(configValue)) {
                        pos.infisso[field] = [...configValue];
                    } else {
                        pos.infisso[field] = configValue;
                    }
                    console.log(`     âœ… Sincronizzato: ${field} = ${configValue}`);
                    contatore++;
                } else if (!isEmpty) {
                    console.log(`     â­ï¸ Skip (giÃ  impostato)`);
                } else if (!configHasValue) {
                    console.log(`     â­ï¸ Skip (config vuota)`);
                }
            });
        }
    });
    
    saveState();
    render();
    
    alert(`âœ… SINCRONIZZAZIONE COMPLETATA!\n\nAggiornati ${contatore} campi nelle posizioni esistenti.`);
    console.log(`âœ… SINCRONIZZAZIONE COMPLETATA: ${contatore} campi aggiornati`);
};

// Funzione per aggiornare un singolo COD.TAGLI in una posizione
window.updateCodTagliPosizione = (projectId, posId, index, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.infisso) {
            // ğŸ†• v4.81: Aggiorna codTagliValues (non piÃ¹ codTagli)
            if (!pos.infisso.codTagliValues) {
                pos.infisso.codTagliValues = [];
            }
            pos.infisso.codTagliValues[index] = value;
            saveState();
            // Non fare render completo per mantenere il focus
        }
    }
};
// MAIN COMPONENTS
function Header() {
    return `
        <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-3">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <!-- Hamburger Menu Button - v5.90: context-aware -->
                        <button onclick="${state.currentProject ? 'toggleProjectMenu()' : 'toggleMainMenu()'}" class="p-2 hover:bg-gray-100 rounded-lg" title="${state.currentProject ? 'Menu progetto' : 'Menu principale'}">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        
                        ${state.screen !== 'list' ? `
                            <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                        ` : ''}
                        <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                            Open Porte v${APP_VERSION}
                        </h1>
                    </div>
                    <div class="flex items-center gap-2">
                        ${state.screen === 'list' ? `
                            <button onclick="importProjectsJSON()" 
                                    class="px-4 py-1.5 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                <span>ğŸ“¥</span>
                                <span>Importa</span>
                            </button>
                            <button onclick="exportAllProjects()" 
                                    class="px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                <span>ğŸ’¾</span>
                                <span>JSON</span>
                            </button>
                            <button onclick="exportAllProjectsExcel()" 
                                    class="px-4 py-1.5 bg-gradient-to-r from-emerald-600 to-green-700 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                <span>ğŸ“Š</span>
                                <span>Excel</span>
                            </button>
                            <button onclick="showNewProjectModal()" 
                                    class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                + Nuovo Progetto
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </header>
    `;
}

// Main Menu laterale dell'applicazione
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¨ PAGINA DISEGNI PROGETTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function DrawingsPage() {
    const project = state.projects.find(p => p.id === state.currentProject);
    
    if (!project) {
        return `<div style="padding: 20px; text-align: center;">
            <p>âŒ Progetto non trovato</p>
        </div>`;
    }
    
    // Migra se necessario
    migrateProjectDrawings(project);
    
    const drawings = project.drawings?.general || [];
    const stats = project.drawings?.stats || { total: 0, totalSize: 0 };
    const totalSize = calculateTotalDrawingsSize(project);
    const usedSpace = (totalSize / DRAWING_LIMITS.maxProjectSize * 100).toFixed(1);
    
    return `
        ${renderProjectMenu()}
        
        <div style="padding: 80px 20px 20px 20px;">
            <!-- Header Pagina -->
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0; font-size: 24px; color: #2d3748;">
                        ğŸ¨ Disegni Progetto
                    </h2>
                    <button onclick="showUploadDialog()" 
                            style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">+</span>
                        Aggiungi
                    </button>
                </div>
                
                <!-- Statistiche -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px; color: #718096;">
                    <div>
                        <strong>${drawings.length}</strong> disegni
                    </div>
                    <div>
                        <strong>${formatFileSize(totalSize)}</strong> occupati
                    </div>
                    <div>
                        <strong>${usedSpace}%</strong> spazio usato
                    </div>
                </div>
                
                <!-- Barra progresso spazio -->
                <div style="margin-top: 10px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;">
                    <div style="width: ${usedSpace}%; height: 100%; background: ${usedSpace > 80 ? '#f56565' : '#4CAF50'}; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Lista Disegni -->
            ${drawings.length === 0 ? `
                <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">ğŸ¨</div>
                    <h3 style="margin: 0 0 10px 0; color: #2d3748;">Nessun disegno</h3>
                    <p style="color: #718096; margin: 0 0 20px 0;">
                        Aggiungi disegni schematici dal rilievo per avere riferimenti visivi
                    </p>
                    <button onclick="showUploadDialog()" 
                            style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        Aggiungi primo disegno
                    </button>
                </div>
            ` : drawings.map(drawing => renderDrawingCard(drawing, project)).join('')}
        </div>
    `;
}

// Render card singolo disegno
function renderDrawingCard(drawing, project) {
    const isImage = drawing.type.startsWith('image/');
    const isPDF = drawing.type === 'application/pdf';
    const linkedPos = drawing.linkedPositions || [];
    const posNames = linkedPos.map(id => {
        const pos = project.positions.find(p => p.id === id);
        return pos?.name || 'Sconosciuta';
    });
    
    return `
        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- Thumbnail -->
                <div style="flex-shrink: 0;">
                    ${drawing.thumbnail ? `
                        <img src="${drawing.thumbnail}" 
                             alt="${drawing.name}"
                             onclick="viewDrawing('${drawing.id}')"
                             style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e2e8f0;">
                    ` : `
                        <div onclick="viewDrawing('${drawing.id}')"
                             style="width: 120px; height: 120px; background: #f7fafc; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #e2e8f0;">
                            <span style="font-size: 48px;">${isPDF ? 'ğŸ“„' : 'ğŸ–¼ï¸'}</span>
                        </div>
                    `}
                </div>
                
                <!-- Info -->
                <div style="flex: 1; min-width: 200px;">
                    <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #2d3748; overflow: hidden; text-overflow: ellipsis;">
                        ${drawing.name}
                    </h3>
                    
                    ${drawing.description ? `
                        <p style="margin: 0 0 10px 0; color: #718096; font-size: 14px;">
                            ${drawing.description}
                        </p>
                    ` : ''}
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 13px; color: #a0aec0; margin-bottom: 12px;">
                        <span>ğŸ“… ${new Date(drawing.uploadDate).toLocaleDateString('it-IT')}</span>
                        <span>ğŸ’¾ ${formatFileSize(drawing.size)}</span>
                        ${isPDF && drawing.metadata?.pageCount ? `
                            <span>ğŸ“„ ${drawing.metadata.pageCount} pag.</span>
                        ` : ''}
                        ${drawing.metadata?.dimensions ? `
                            <span>ğŸ“ ${drawing.metadata.dimensions.width}Ã—${drawing.metadata.dimensions.height}px</span>
                        ` : ''}
                    </div>
                    
                    ${linkedPos.length > 0 ? `
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #a0aec0; margin-bottom: 4px;">Collegato a:</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${posNames.map(name => `
                                    <span style="background: #edf2f7; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #4a5568;">
                                        ğŸ“ ${name}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Azioni -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="viewDrawing('${drawing.id}')"
                                style="padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            ğŸ‘ï¸ Visualizza
                        </button>
                        <button onclick="downloadDrawing('${drawing.id}')"
                                style="padding: 8px 16px; background: #48bb78; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            ğŸ’¾ Scarica
                        </button>
                        <button onclick="confirmDeleteDrawing('${drawing.id}')"
                                style="padding: 8px 16px; background: #f56565; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Dialog upload
function showUploadDialog() {
    const project = state.projects.find(p => p.id === state.currentProject);
    const availableSpace = DRAWING_LIMITS.maxProjectSize - calculateTotalDrawingsSize(project);
    
    const dialog = document.createElement('div');
    dialog.className = 'modal-overlay';
    dialog.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
    dialog.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%;">
            <h2 style="margin: 0 0 20px 0; font-size: 24px; color: #2d3748;">
                ğŸ“¤ Aggiungi Disegno
            </h2>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                    File (PNG, JPG, PDF)
                </label>
                <input type="file" 
                       id="drawing-file-input"
                       accept="image/png,image/jpeg,image/jpg,application/pdf"
                       style="width: 100%; padding: 10px; border: 2px dashed #cbd5e0; border-radius: 8px; cursor: pointer;">
                <div style="margin-top: 8px; font-size: 12px; color: #a0aec0;">
                    Max ${formatFileSize(DRAWING_LIMITS.maxFileSize)} per file â€¢ Disponibili ${formatFileSize(availableSpace)}
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                    Descrizione (opzionale)
                </label>
                <textarea id="drawing-description"
                          placeholder="Es: Vista generale piano terra"
                          style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; min-height: 80px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="this.closest('.modal-overlay').remove()"
                        style="padding: 10px 20px; background: #e2e8f0; color: #4a5568; border: none; border-radius: 8px; cursor: pointer;">
                    Annulla
                </button>
                <button onclick="uploadDrawingFromDialog()"
                        style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    Carica
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
}

// Upload da dialog
async function uploadDrawingFromDialog() {
    const fileInput = document.getElementById('drawing-file-input');
    const descriptionInput = document.getElementById('drawing-description');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showNotification('âš ï¸ Seleziona un file', 'warning');
        return;
    }
    
    const file = fileInput.files[0];
    const description = descriptionInput.value.trim();
    
    const success = await addDrawingToProject(file, description);
    
    if (success) {
        document.querySelector('.modal-overlay').remove();
    }
}

// Visualizza disegno (lightbox)
function viewDrawing(drawingId) {
    const project = state.projects.find(p => p.id === state.currentProject);
    const drawing = project?.drawings?.general?.find(d => d.id === drawingId);
    
    if (!drawing) return;
    
    const isPDF = drawing.type === 'application/pdf';
    
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox-overlay';
    lightbox.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
    lightbox.onclick = (e) => {
        if (e.target === lightbox) lightbox.remove();
    };
    
    lightbox.innerHTML = `
        <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 12px; overflow: hidden;">
            <div style="padding: 15px; background: #2d3748; color: white; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px;">${drawing.name}</h3>
                <button onclick="this.closest('.lightbox-overlay').remove()"
                        style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px;">
                    Ã—
                </button>
            </div>
            <div style="padding: 20px; max-height: calc(90vh - 100px); overflow: auto;">
                ${isPDF ? `
                    <iframe src="${drawing.data}" 
                            style="width: 80vw; height: 70vh; border: none; border-radius: 8px;"></iframe>
                    <div style="margin-top: 15px; text-align: center;">
                        <a href="${drawing.data}" 
                           download="${drawing.name}.pdf"
                           style="padding: 10px 20px; background: #4299e1; color: white; text-decoration: none; border-radius: 8px; display: inline-block;">
                            ğŸ’¾ Scarica PDF
                        </a>
                    </div>
                ` : `
                    <img src="${drawing.data}" 
                         alt="${drawing.name}"
                         style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin: 0 auto;">
                `}
            </div>
        </div>
    `;
    
    document.body.appendChild(lightbox);
}

// Scarica disegno
function downloadDrawing(drawingId) {
    const project = state.projects.find(p => p.id === state.currentProject);
    const drawing = project?.drawings?.general?.find(d => d.id === drawingId);
    
    if (!drawing) return;
    
    const ext = drawing.type === 'application/pdf' ? 'pdf' : 
                drawing.type === 'image/png' ? 'png' : 'jpg';
    
    const link = document.createElement('a');
    link.href = drawing.data;
    link.download = `${drawing.name}.${ext}`;
    link.click();
    
    showNotification('ğŸ’¾ Download avviato', 'success');
}

// Conferma eliminazione
function confirmDeleteDrawing(drawingId) {
    if (confirm('Eliminare questo disegno? L\'operazione non puÃ² essere annullata.')) {
        deleteDrawing(drawingId);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ MAIN MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MainMenu() {
    // ğŸ†• v5.554: NON mostrare MainMenu se siamo dentro un progetto
    if (state.currentProject) {
        return ''; // Nasconde completamente il menu principale
    }
    
    return `
        <!-- Main Menu Laterale -->
        <aside class="main-menu ${state.mainMenuOpen ? 'open' : ''}" id="mainSideMenu">
            <!-- Header menu -->
            <div class="main-menu-header">
                <button class="main-menu-close" onclick="toggleMainMenu()">âœ•</button>
                <span class="main-menu-title">MENU PRINCIPALE</span>
            </div>
            
            <!-- Search Bar -->
            <div class="main-menu-search">
                <input type="text" id="mainSearch" placeholder="ğŸ” Cerca progetto..." 
                       onkeyup="searchProjects(this.value)" 
                       class="search-input">
            </div>
            
            <!-- Menu Items con Submenu -->
            <div class="main-nav-section">
                <!-- Progetti -->
                <div class="main-nav-item expandable" onclick="toggleMainSubmenu('progetti')">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">ğŸ“</span>
                        <span>Progetti</span>
                        <span class="main-nav-arrow">â–¶</span>
                    </div>
                </div>
                <div id="main-submenu-progetti" class="main-submenu">
                    <div class="main-submenu-item" onclick="showNewProjectModal();">
                        <span>â• Nuovo Progetto</span>
                    </div>
                    <div class="main-submenu-item" onclick="showProjectsList(); closeMainMenu();">
                        <span>ğŸ“‚ Lista Progetti</span>
                    </div>
                    <div class="main-submenu-item" onclick="showRecentProjects(); closeMainMenu();">
                        <span>ğŸ• Recenti</span>
                    </div>
                    <div class="main-submenu-item" onclick="showArchivedProjects(); closeMainMenu();">
                        <span>ğŸ“¦ Archiviati</span>
                    </div>
                </div>
                
                <!-- Strumenti -->
                <div class="main-nav-item expandable" onclick="toggleMainSubmenu('strumenti')">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">ğŸ› ï¸</span>
                        <span>Strumenti</span>
                        <span class="main-nav-arrow">â–¶</span>
                    </div>
                </div>
                <div id="main-submenu-strumenti" class="main-submenu">
                    <div class="main-submenu-item" onclick="openBRMCalculator(); closeMainMenu();">
                        <span>ğŸ§® Calcolatore BRM</span>
                    </div>
                    <div class="main-submenu-item" onclick="openConversions(); closeMainMenu();">
                        <span>ğŸ”„ Conversioni</span>
                    </div>
                    <div class="main-submenu-item" onclick="openNormative(); closeMainMenu();">
                        <span>ğŸ“‹ Normative</span>
                    </div>
                    <!-- ğŸ†• v5.740: Aggiorna App anche nel menu principale -->
                    <div class="main-submenu-item update-app-item" onclick="forceUpdateApp();">
                        <span>ğŸ”„ Aggiorna Versione App</span>
                    </div>
                </div>
                
                <!-- Impostazioni -->
                <div class="main-nav-item expandable" onclick="toggleMainSubmenu('impostazioni')">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">âš™ï¸</span>
                        <span>Impostazioni</span>
                        <span class="main-nav-arrow">â–¶</span>
                    </div>
                </div>
                <div id="main-submenu-impostazioni" class="main-submenu">
                    <div class="main-submenu-item" onclick="openGeneralSettings(); closeMainMenu();">
                        <span>ğŸ¨ Generali</span>
                    </div>
                    <div class="main-submenu-item" onclick="openProductSettings(); closeMainMenu();">
                        <span>ğŸ“¦ Config Prodotti</span>
                    </div>
                    <div class="main-submenu-item" onclick="openExportImport(); closeMainMenu();">
                        <span>ğŸ’¾ Export/Import</span>
                    </div>
                </div>
                
                <!-- Backup & Sync -->
                <div class="main-nav-item" onclick="openBackupSettings(); closeMainMenu();">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">ğŸ”’</span>
                        <span>Backup</span>
                    </div>
                </div>
                
                <!-- GitHub Sync -->
                <div class="main-nav-item" onclick="openGitHubSettings(); closeMainMenu();">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">ğŸ“¦</span>
                        <span>GitHub</span>
                    </div>
                    <span class="sync-badge" id="mainSyncBadge">
                        ${renderGitHubBadge()}
                    </span>
                </div>
                
                <!-- Statistiche -->
                <div class="main-nav-item" onclick="openStatistics(); closeMainMenu();">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">ğŸ“Š</span>
                        <span>Statistiche</span>
                    </div>
                </div>
                
                <!-- Info -->
                <div class="main-nav-item" onclick="openAppInfo(); closeMainMenu();">
                    <div class="main-nav-label">
                        <span class="main-nav-icon">â„¹ï¸</span>
                        <span>Info</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Bottom -->
            <div class="main-menu-bottom">
                <div class="quick-actions-title">Azioni Rapide</div>
                <div class="quick-actions-grid">
                    <button onclick="quickNewProject()" title="Nuovo (Ctrl+N)" class="quick-action-btn">
                        â•
                    </button>
                    <button onclick="quickSave()" title="Salva (Ctrl+S)" class="quick-action-btn">
                        ğŸ’¾
                    </button>
                    <button onclick="quickExport()" title="Export (Ctrl+E)" class="quick-action-btn">
                        ğŸ“„
                    </button>
                    <button onclick="quickSync()" title="Sync (Ctrl+U)" class="quick-action-btn">
                        â˜ï¸
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- Overlay -->
        <div class="main-menu-overlay ${state.mainMenuOpen ? 'active' : ''}" 
             id="mainMenuOverlay" 
             onclick="closeMainMenu()"></div>
    `;
}

// Funzioni gestione menu principale
function toggleMainMenu() {
    state.mainMenuOpen = !state.mainMenuOpen;
    render();
}

function closeMainMenu() {
    state.mainMenuOpen = false;
    render();
}

// ğŸ†• v5.720: Chiude menu senza render (per evitare che modal venga resettato)
function closeMainMenuNoRender() {
    state.mainMenuOpen = false;
    // Chiudi visivamente il menu e l'overlay senza ricreare il DOM
    const menu = document.getElementById('mainSideMenu');
    const overlay = document.querySelector('.main-menu-overlay');
    if (menu) menu.classList.remove('open');
    if (overlay) overlay.classList.remove('active');
}
window.closeMainMenuNoRender = closeMainMenuNoRender;

function toggleMainSubmenu(menuId) {
    const submenu = document.getElementById(`main-submenu-${menuId}`);
    if (submenu) {
        const menuItem = submenu.previousElementSibling;
        const isOpen = submenu.classList.contains('open');
        
        // Chiudi altri submenu
        document.querySelectorAll('.main-submenu.open').forEach(s => {
            s.classList.remove('open');
            const prevItem = s.previousElementSibling;
            if (prevItem) prevItem.classList.remove('expanded');
        });
        
        // Toggle corrente
        if (!isOpen) {
            submenu.classList.add('open');
            menuItem.classList.add('expanded');
        }
    }
}

// Funzioni per le voci del menu
function showProjectsList() {
    state.screen = 'list';
    // ğŸ†• v4.20: Chiudi tutti i menu quando torni alla lista
    state.projectMenuOpen = false;
    state.mainMenuOpen = false;
    render();
}

function showRecentProjects() {
    const recentProjects = state.projects.slice(-5).reverse();
    console.log('Progetti recenti:', recentProjects);
    // TODO: Implementare vista progetti recenti
}

function showArchivedProjects() {
    const archivedProjects = state.projects.filter(p => p.archived === true);
    console.log('Progetti archiviati:', archivedProjects);
    // TODO: Implementare vista progetti archiviati
}

// Quick Actions
function quickNewProject() {
    closeMainMenu();
    showNewProjectModal();
}

function quickSave() {
    closeMainMenu();
    saveState();
    showNotification('ğŸ’¾ Salvato', 'success');
}

function quickExport() {
    closeMainMenu();
    if (state.currentProject) {
        exportCurrentProjectJSON();
    } else {
        exportAllProjects();
    }
}

function quickSync() {
    closeMainMenu();
    if (state.github && state.github.connected) {
        uploadToGitHub();
    } else {
        openGitHubSettings();
    }
}

// Funzioni placeholder per menu items
function openBRMCalculator() {
    showNotification('ğŸ§® Calcolatore BRM in sviluppo', 'info');
}

function openConversions() {
    showNotification('ğŸ”„ Conversioni in sviluppo', 'info');
}

function openNormative() {
    showNotification('ğŸ“‹ Normative in sviluppo', 'info');
}

function openGeneralSettings() {
    showNotification('ğŸ¨ Impostazioni generali in sviluppo', 'info');
}

function openProductSettings() {
    showNotification('ğŸ“¦ Configurazione prodotti in sviluppo', 'info');
}

function openExportImport() {
    // Usa le funzioni esistenti
    if (state.screen === 'list') {
        exportAllProjects();
    } else {
        exportCurrentProjectJSON();
    }
}

function openBackupSettings() {
    showNotification('ğŸ”’ Sistema backup in sviluppo', 'info');
}

function openStatistics() {
    const totalProjects = state.projects.length;
    const totalPositions = state.projects.reduce((sum, p) => sum + ((p.positions || []).length), 0);
    
    // ğŸ†• v5.81: Usa PRODUCT_COUNTER per conteggi accurati
    let totali = { totaleInfissi: 0, totalePersiane: 0, totaleTapparelle: 0, totaleZanzariere: 0, totaleCassonetti: 0 };
    
    if (typeof PRODUCT_COUNTER !== 'undefined') {
        state.projects.forEach(p => {
            const stats = PRODUCT_COUNTER.countProject(p);
            totali.totaleInfissi += stats.totaleInfissi;
            totali.totalePersiane += stats.totalePersiane;
            totali.totaleTapparelle += stats.totaleTapparelle;
            totali.totaleZanzariere += stats.totaleZanzariere;
            totali.totaleCassonetti += stats.totaleCassonetti;
        });
    }
    
    const msg = `ğŸ“Š Statistiche:
${totalProjects} progetti, ${totalPositions} posizioni
ğŸªŸ ${totali.totaleInfissi} infissi | ğŸšª ${totali.totalePersiane} persiane
ğŸšï¸ ${totali.totaleTapparelle} tapparelle | ğŸ¦Ÿ ${totali.totaleZanzariere} zanzariere
ğŸ“¦ ${totali.totaleCassonetti} cassonetti`;
    
    showNotification(msg, 'success', 5000);
}

function openAppInfo() {
    showNotification('â„¹ï¸ Open Porte v3.0 - Fase 023', 'info');
}

// Sistema notifiche migliorato
function showNotification(message, type = 'info', duration = 3000) {
    // Rimuovi notifiche esistenti
    const existingNotifications = document.querySelectorAll('.notification-toast');
    existingNotifications.forEach(n => n.remove());
    
    // Crea nuova notifica
    const notification = document.createElement('div');
    notification.className = `notification-toast notification-${type}`;
    
    const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
    };
    
    notification.innerHTML = `
        <span class="notification-icon">${icons[type]}</span>
        <span class="notification-message">${message}</span>
    `;
    
    // Aggiungi stili inline
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#10b981' : 
                    type === 'error' ? '#ef4444' :
                    type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 10000;
        animation: slideUp 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    document.body.appendChild(notification);
    
    // Rimuovi dopo duration
    if (duration > 0) {
        setTimeout(() => {
            notification.style.animation = 'slideDown 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }
}
window.showNotification = showNotification; // ğŸ”§ v5.626: Esponi versione migliorata

// Funzione ricerca progetti
function searchProjects(query) {
    if (!query || query.length < 2) {
        // Reset vista se query vuota
        return;
    }
    
    const results = [];
    const lowerQuery = query.toLowerCase();
    
    state.projects.forEach(project => {
        // Cerca nel nome progetto
        if (project.name && project.name.toLowerCase().includes(lowerQuery)) {
            results.push({ type: 'project', data: project });
        }
        
        // Cerca nel nome cliente
        if (project.client && project.client.toLowerCase().includes(lowerQuery)) {
            results.push({ type: 'project', data: project });
        }
        
        // Cerca nelle posizioni
        if (project.positions) {
            project.positions.forEach(pos => {
                if (pos.name && pos.name.toLowerCase().includes(lowerQuery)) {
                    results.push({ 
                        type: 'position', 
                        data: pos,
                        projectName: project.name 
                    });
                }
            });
        }
    });
    
    console.log(`Trovati ${results.length} risultati per "${query}"`);
    // TODO: Mostrare risultati in overlay dedicato
}

function ProjectsList() {
    if (state.projects.length === 0) {
        // Verifica se GitHub Ã¨ connesso
        const isGitHubConnected = state.github && state.github.connected;
        
        return `
            ${Header()}
            <div class="min-h-[70vh] flex items-center justify-center p-4">
                <div class="max-w-2xl w-full space-y-4">
                    
                    <!-- Banner GitHub -->
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-6 shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="text-5xl flex-shrink-0">ğŸ“¦</div>
                            <div class="flex-1">
                                ${!isGitHubConnected ? `
                                    <!-- Non connesso: invita a connettere -->
                                    <h3 class="text-xl font-bold text-blue-900 mb-2">
                                        Hai progetti su altri dispositivi?
                                    </h3>
                                    <p class="text-blue-700 mb-4">
                                        Connetti GitHub per sincronizzare i tuoi progetti tra PC, tablet e smartphone. 
                                        I tuoi dati saranno sempre aggiornati e disponibili ovunque.
                                    </p>
                                    <div class="flex flex-wrap gap-3">
                                        <button onclick="showGitHubTokenInput()" 
                                                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg font-semibold hover:shadow-xl transition-all flex items-center gap-2">
                                            <span>ğŸ”—</span>
                                            <span>Connetti GitHub</span>
                                        </button>
                                        <button onclick="openGitHubSettings()" 
                                                class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                            â„¹ï¸ Maggiori Info
                                        </button>
                                    </div>
                                ` : `
                                    <!-- Connesso ma nessun progetto locale -->
                                    <h3 class="text-xl font-bold text-blue-900 mb-2">
                                        ğŸŸ¢ GitHub Connesso
                                    </h3>
                                    <p class="text-blue-700 mb-4">
                                        Inizia creando il tuo primo progetto. I dati verranno sincronizzati automaticamente su GitHub.
                                    </p>
                                    <div class="flex flex-wrap gap-3">
                                        <button onclick="openGitHubSettings()" 
                                                class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                            âš™ï¸ Impostazioni GitHub
                                        </button>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Benvenuto -->
                    <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                        <div class="text-6xl mb-4">ğŸ“‹</div>
                        <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                        <p class="text-gray-600 mb-6">
                            ${!isGitHubConnected ? 
                                'Inizia creando il tuo primo progetto oppure connetti GitHub per sincronizzare' : 
                                'Inizia creando il tuo primo progetto'}
                        </p>
                        <button onclick="showNewProjectModal()" 
                                class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                            + Crea Primo Progetto
                        </button>
                    </div>
                    
                </div>
            </div>
        `;
    }

    // v5.90: Usa modulo condiviso ProjectListView
    if (typeof ProjectListView !== 'undefined') {
        const normalized = ProjectListView.normalizeAll(state.projects || [], 'app');
        return `
            ${Header()}
            ${ProjectListView.generateHTML(normalized, {
                onOpenFn: 'openProject',
                onDeleteFn: 'deleteProject',
                showCompletamento: false,
                showAmbiente: false,
                stickyTabs: true,
                stickyTop: '60px'
            })}
        `;
    }
    
    // Fallback se modulo non caricato
    return `
        ${Header()}
        <div style="padding:20px;text-align:center;color:#ef4444;">
            âš ï¸ Modulo project-list-view.js non caricato
        </div>
    `;
}


function ProjectSetup() {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) return '';

    return `
        ${renderTopNavbar()}
        
        <div class="max-w-7xl mx-auto p-4">
            
            <!-- HEADER COMPLETAMENTO PROGETTO -->
            <div class="project-completion-header mb-4">
                <div style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: 600; color: #374151;">Completamento Progetto</span>
                        <span style="font-weight: 700; color: #1f2937;">${CompletionSystem.getOverallCompletion(project)}%</span>
                    </div>
                    ${CompletionSystem.getProgressBar(CompletionSystem.getOverallCompletion(project))}
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow overflow-x-auto">
                ${(() => {
                    // ğŸ¯ Genera dinamicamente gli step in base ai prodotti selezionati
                    const steps = [
                        {num: 1, label: 'Dati Cliente'},
                        {num: 2, label: 'Prodotti + Muro'}
                    ];
                    
                    // Aggiungi solo gli step dei prodotti selezionati
                    if (project.prodotti?.infissi) steps.push({num: 3, label: 'Config. Infissi'});
                    if (project.prodotti?.persiane) steps.push({num: 4, label: 'Config. Persiane'});
                    if (project.prodotti?.tapparelle) steps.push({num: 5, label: 'Config. Tapparelle'});
                    if (project.prodotti?.zanzariere) steps.push({num: 6, label: 'Config. Zanzariere'});
                    if (project.prodotti?.cassonetti) steps.push({num: 7, label: 'Config. Cassonetti'});
                    if (project.prodotti?.grate) steps.push({num: 7.5, label: 'Config. Grate'});  // ğŸ”’ v5.85
                    if (project.prodotti?.clickZip) steps.push({num: 8, label: 'Config. Click Zip'});  // ğŸªŸ v5.64
                    // ğŸšª v5.08: Blindate e Portoncini NON hanno piÃ¹ config globale
                    // Si configurano direttamente nella posizione
                    
                    // Step finale sempre presente
                    steps.push({num: 9, label: 'Posizioni'});
                    
                    return steps.map((step, idx) => `
                        <div class="flex flex-col items-center cursor-pointer flex-shrink-0" onclick="changeSetupStep(${step.num})">
                            <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                ${state.setupStep > step.num ? 'âœ“' : (idx + 1)}
                            </div>
                            <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''} whitespace-nowrap">${step.label}</span>
                        </div>
                    `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4 mx-2"></div>');
                })()}
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                ${state.setupStep === 1 ? renderStep1ClientData(project) :
                  state.setupStep === 2 ? renderStep2Products(project) :
                  state.setupStep === 3 ? renderStep3ConfigInfissi(project) :
                  state.setupStep === 4 ? renderStep4ConfigPersiane(project) :
                  state.setupStep === 5 ? renderStep5ConfigTapparelle(project) :
                  state.setupStep === 6 ? renderStep6ConfigZanzariere(project) :
                  state.setupStep === 7 ? renderStep7ConfigCassonetti(project) :
                  state.setupStep === 7.5 ? renderStepConfigGrate(project) :
                  state.setupStep === 8 ? renderStep8ConfigClickZip(project) :
                  renderStep9Positions(project)}
                
                <div class="flex justify-between mt-6 pt-4 border-t">
                    <button onclick="goToPrevStep('${project.id}')" 
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                        â† Indietro
                    </button>
                    ${state.setupStep < 8 ? `
                        <button onclick="goToNextStep('${project.id}')" 
                                class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                            Avanti â†’
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function renderStep1ClientData(project) {
    // ğŸ†• v5.81: Usa UI_FORMS centralizzato
    if (typeof UI_FORMS !== 'undefined') {
        // Prepara dati cliente (compatibilitÃ  vecchio/nuovo formato)
        const cliente = project.cliente || project.clientData || {};
        // Separa nome/cognome se c'Ã¨ solo "client"
        if (!cliente.nome && !cliente.cognome && project.client) {
            const parts = project.client.split(' ');
            cliente.nome = parts[0] || '';
            cliente.cognome = parts.slice(1).join(' ') || '';
        }
        
        const immobile = project.immobile || {};
        
        return `
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ‘¤</span> Dati Cliente e Progetto
                </h2>
                
                <!-- Nome Progetto -->
                <div class="bg-white rounded-xl shadow-md p-4 mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ğŸ“‹ Nome Progetto</label>
                    <input type="text" value="${project.name || ''}" 
                           onchange="updateProject('${project.id}', 'name', this.value)"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                           placeholder="Es: Appartamento Via Roma">
                </div>
                
                <!-- Form Cliente da UI_FORMS -->
                ${UI_FORMS.renderFormCliente(cliente, immobile, {
                    onChangeCallback: 'updateClienteField',
                    idPrefix: 'rilievo-' + project.id
                })}
            </div>
        `;
    }
    
    // Fallback se UI_FORMS non caricato
    return renderStep1ClientDataLegacy(project);
}

// ğŸ”„ Fallback legacy se UI_FORMS non disponibile
function renderStep1ClientDataLegacy(project) {
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ‘¤</span> Dati Cliente e Progetto
            </h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                    <input type="text" value="${project.name}" 
                           onchange="updateProject('${project.id}', 'name', this.value)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">
                        Cliente <span style="color: #ef4444; font-weight: 700;">*</span>
                    </label>
                    <input type="text" value="${project.client}" 
                           onchange="updateProject('${project.id}', 'client', this.value)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"
                           required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Telefono</label>
                    <input type="tel" placeholder="+39 333 1234567" 
                           value="${project.clientData?.telefono || ''}"
                           oninput="updateClientData('${project.id}', 'telefono', this.value)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" placeholder="cliente@email.com" 
                           value="${project.clientData?.email || ''}"
                           oninput="updateClientData('${project.id}', 'email', this.value)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium mb-1">Indirizzo</label>
                    <input type="text" placeholder="Via Roma, 1 - Milano" 
                           value="${project.clientData?.indirizzo || ''}"
                           oninput="updateClientData('${project.id}', 'indirizzo', this.value)"
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">âš ï¸ Carica <strong>ui-forms.js</strong> per il form completo con tutti i campi</p>
            </div>
        </div>
    `;
}

function renderStep2Products(project) {
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ› ï¸</span> Seleziona i Prodotti da Installare
            </h2>
            <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
            
            <div class="flex flex-wrap gap-4">
                <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.infissi ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸªŸ</span>
                    <div>
                        <div class="font-semibold">Infissi</div>
                        <div class="text-xs opacity-75">Finestre e porte</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.persiane ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸšª</span>
                    <div>
                        <div class="font-semibold">Persiane</div>
                        <div class="text-xs opacity-75">Persiane e scuri</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.tapparelle ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.tapparelle ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'tapparelle', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸšï¸</span>
                    <div>
                        <div class="font-semibold">Tapparelle</div>
                        <div class="text-xs opacity-75">Avvolgibili</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.zanzariere ? 'selected bg-green-50 border-green-500 text-green-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.zanzariere ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'zanzariere', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸ¦Ÿ</span>
                    <div>
                        <div class="font-semibold">Zanzariere</div>
                        <div class="text-xs opacity-75">Protezione insetti</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.cassonetti ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸ“¦</span>
                    <div>
                        <div class="font-semibold">Cassonetti</div>
                        <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.porteInterne ? 'selected bg-rose-50 border-rose-500 text-rose-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.porteInterne ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'porteInterne', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸšª</span>
                    <div>
                        <div class="font-semibold">Porte Interne</div>
                        <div class="text-xs opacity-75">FerreroLegno, Flessya</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.clickZip ? 'selected bg-cyan-50 border-cyan-500 text-cyan-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.clickZip ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'clickZip', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸªŸ</span>
                    <div>
                        <div class="font-semibold">Click Zip</div>
                        <div class="text-xs opacity-75">GIBUS schermature</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.tendeBracci ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.tendeBracci ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'tendeBracci', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">â˜€ï¸</span>
                    <div>
                        <div class="font-semibold">Tende a Bracci</div>
                        <div class="text-xs opacity-75">GIBUS TXT, SEGNO...</div>
                    </div>
                </label>

                <label class="product-pill ${project.prodotti?.grate ? 'selected bg-red-50 border-red-500 text-red-700' : 'border-gray-300'}">
                    <input type="checkbox" 
                           ${project.prodotti?.grate ? 'checked' : ''}
                           onchange="updateProdotti('${project.id}', 'grate', this.checked)"
                           onclick="event.stopPropagation()"
                           class="sr-only">
                    <span class="text-xl">ğŸ”’</span>
                    <div>
                        <div class="font-semibold">Grate Sicurezza</div>
                        <div class="text-xs opacity-75">Erreci RC3</div>
                    </div>
                </label>
            </div>
            
            <!-- ğŸ’¡ INFO: Portoncini e Blindate si configurano direttamente nella posizione -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-blue-700 text-sm">
                    ğŸ’¡ <strong>Portoncini Finstral</strong> e <strong>Porte Blindate Oikos</strong> si configurano direttamente nella singola posizione (tipo "Ingresso")
                </p>
            </div>

            <!-- ğŸšª v5.60: CONFIGURAZIONE PORTE INTERNE (se selezionato) -->
            ${project.prodotti?.porteInterne ? `
            <div class="mt-6 p-4 bg-rose-50 border-2 border-rose-300 rounded-lg">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-rose-700">
                    <span class="text-xl">ğŸšª</span> Configurazione Porte Interne - Default
                </h3>
                <p class="text-sm text-rose-600 mb-4">
                    ğŸ’¡ Imposta i valori predefiniti. Nelle singole posizioni potrai modificarli se necessario.
                </p>
                
                <!-- AZIENDA -->
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-600 block mb-2">Azienda</label>
                    <div class="flex gap-3">
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="aziendaPorteDefault-${project.id}" value="FERREROLEGNO"
                                   ${(project.configPorteInterne?.azienda || '') === 'FERREROLEGNO' ? 'checked' : ''}
                                   onchange="updateConfigPorteInterne('${project.id}', 'azienda', 'FERREROLEGNO')"
                                   class="sr-only">
                            <div class="p-3 rounded-lg border-2 transition-all text-center ${(project.configPorteInterne?.azienda || '') === 'FERREROLEGNO' 
                                ? 'border-rose-500 bg-rose-100 shadow-lg' 
                                : 'border-gray-300 bg-white hover:border-rose-300'}">
                                <span class="text-2xl block mb-1">ğŸšª</span>
                                <div class="font-bold text-sm">FerreroLegno</div>
                                <div class="text-xs text-gray-500">Sconto 50%</div>
                            </div>
                        </label>
                        <label class="flex-1 cursor-pointer">
                            <input type="radio" name="aziendaPorteDefault-${project.id}" value="FLESSYA"
                                   ${(project.configPorteInterne?.azienda || '') === 'FLESSYA' ? 'checked' : ''}
                                   onchange="updateConfigPorteInterne('${project.id}', 'azienda', 'FLESSYA')"
                                   class="sr-only">
                            <div class="p-3 rounded-lg border-2 transition-all text-center ${(project.configPorteInterne?.azienda || '') === 'FLESSYA' 
                                ? 'border-amber-500 bg-amber-100 shadow-lg' 
                                : 'border-gray-300 bg-white hover:border-amber-300'}">
                                <span class="text-2xl block mb-1">ğŸšª</span>
                                <div class="font-bold text-sm">Flessya</div>
                                <div class="text-xs text-gray-500">Sconto 53%</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                ${project.configPorteInterne?.azienda ? `
                <!-- ğŸšª v5.61: LINEA (solo per FerreroLegno) -->
                ${project.configPorteInterne.azienda === 'FERREROLEGNO' ? `
                <div class="mb-4">
                    <label class="text-xs font-medium text-gray-600">Linea</label>
                    <select onchange="updateConfigPorteInterne('${project.id}', 'linea', this.value)"
                            class="w-full p-2 border rounded">
                        <option value="">-- Seleziona Linea --</option>
                        ${getLineePorta(project.configPorteInterne.azienda).map(l => 
                            '<option value="' + l + '"' + ((project.configPorteInterne?.linea || '') === l ? ' selected' : '') + '>' + l + '</option>'
                        ).join('')}
                    </select>
                </div>
                ` : ''}
                
                <!-- COLLEZIONE E FINITURA DEFAULT -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-medium text-gray-600">Collezione Default</label>
                        <select onchange="updateConfigPorteInterne('${project.id}', 'collezione', this.value)"
                                class="w-full p-2 border rounded"
                                ${project.configPorteInterne.azienda === 'FERREROLEGNO' && !project.configPorteInterne?.linea ? 'disabled' : ''}>
                            <option value="">-- Seleziona --</option>
                            ${(project.configPorteInterne.azienda === 'FERREROLEGNO' && project.configPorteInterne?.linea) || project.configPorteInterne.azienda === 'FLESSYA' 
                                ? getCollezioniPorta(project.configPorteInterne.azienda, project.configPorteInterne?.linea || 'Standard').map(c => 
                                    '<option value="' + c + '"' + ((project.configPorteInterne?.collezione || '') === c ? ' selected' : '') + '>' + c + '</option>'
                                ).join('') 
                                : ''}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Finitura Default</label>
                        <select onchange="updateConfigPorteInterne('${project.id}', 'finitura', this.value)"
                                class="w-full p-2 border rounded"
                                ${!project.configPorteInterne?.collezione ? 'disabled' : ''}>
                            <option value="">-- Seleziona --</option>
                            ${project.configPorteInterne?.collezione ? getFiniturePora(project.configPorteInterne.azienda, project.configPorteInterne?.linea || 'Standard', project.configPorteInterne.collezione).map(f => 
                                '<option value="' + f + '"' + ((project.configPorteInterne?.finitura || '') === f ? ' selected' : '') + '>' + f + '</option>'
                            ).join('') : ''}
                        </select>
                    </div>
                </div>
                
                <!-- TELAIO E SPESSORE MURO DEFAULT -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-medium text-gray-600">Telaio Default</label>
                        <select onchange="updateConfigPorteInterne('${project.id}', 'telaio', this.value)"
                                class="w-full p-2 border rounded"
                                ${(project.configPorteInterne.azienda === 'FERREROLEGNO' && !project.configPorteInterne?.linea) ? 'disabled' : ''}>
                            <option value="">-- Seleziona Telaio --</option>
                            ${getTelaiPorta(project.configPorteInterne.azienda, project.configPorteInterne?.linea || 'Standard').map(t => 
                                '<option value="' + t + '"' + ((project.configPorteInterne?.telaio || '') === t ? ' selected' : '') + '>' + t + '</option>'
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-600">Spessore Muro Default (mm)</label>
                        <input type="number" placeholder="es. 100"
                               value="${project.configPorteInterne?.spessoreMuro || ''}"
                               onchange="updateConfigPorteInterne('${project.id}', 'spessoreMuro', this.value)"
                               class="w-full p-2 border rounded">
                    </div>
                </div>
                
                <!-- MANIGLIA DEFAULT -->
                <div class="p-3 bg-white rounded border">
                    <label class="text-xs font-medium text-gray-600 block mb-2">ğŸ”§ Maniglia Default</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <select onchange="updateConfigPorteInterne('${project.id}', 'manigliaAzienda', this.value)"
                                    class="w-full p-2 border rounded text-sm">
                                <option value="">Azienda</option>
                                <option value="OLIVARI" ${(project.configPorteInterne?.manigliaAzienda || '') === 'OLIVARI' ? 'selected' : ''}>Olivari</option>
                                <option value="COLOMBO" ${(project.configPorteInterne?.manigliaAzienda || '') === 'COLOMBO' ? 'selected' : ''}>Colombo</option>
                            </select>
                        </div>
                        <div>
                            <input type="text" placeholder="Modello"
                                   value="${project.configPorteInterne?.manigliaModello || ''}"
                                   onchange="updateConfigPorteInterne('${project.id}', 'manigliaModello', this.value)"
                                   class="w-full p-2 border rounded text-sm">
                        </div>
                        <div>
                            <input type="text" placeholder="Finitura"
                                   value="${project.configPorteInterne?.manigliaFinitura || ''}"
                                   onchange="updateConfigPorteInterne('${project.id}', 'manigliaFinitura', this.value)"
                                   class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>
                </div>
                
                <!-- LINK CATALOGHI -->
                <div class="mt-4 flex gap-4">
                    <a href="https://openporte2025.github.io/catalogo-porte-v1_01.html" target="_blank" 
                       class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                        ğŸ“‹ Catalogo Porte â†’
                    </a>
                    <a href="https://openporte2025.github.io/catalogo-maniglie-v2.html" target="_blank" 
                       class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                        ğŸ”§ Catalogo Maniglie â†’
                    </a>
                </div>
                ` : `
                <div class="text-center py-4 bg-yellow-50 border border-yellow-300 rounded">
                    <p class="text-yellow-700">âš ï¸ Seleziona un'azienda per configurare i default</p>
                </div>
                `}
            </div>
            ` : ''}

            ${Object.values(project.prodotti || {}).some(v => v) ? `
                <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                    <p class="text-green-700 font-medium">
                        âœ… Hai selezionato: ${Object.entries(project.prodotti || {})
                            .filter(([k,v]) => v)
                            .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                            .join(', ')}
                    </p>
                </div>
            ` : `
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                    <p class="text-yellow-700">âš ï¸ Seleziona almeno un prodotto per continuare</p>
                </div>
            `}
            
            <!-- ğŸ—¿ SEZIONE MURO INTEGRATA -->
            <div class="mt-8 pt-8 border-t-2 border-gray-200">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ—¿</span> Caratteristiche Muro (Misure in mm)
                </h2>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <div>
                            <label class="text-xs font-medium">Prof. Muro Int</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Prof. Piana Sopra</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Prof. Piana Sotto</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Telaio Prof</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                        <div>
                            <label class="text-xs font-medium">Telaio Largh</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                   class="w-full compact-input border rounded">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                        <select id="guida-select-${project.id}" 
                                onchange="updateGuidaEsistente('${project.id}', this.value)"
                                class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                            <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                    
                    <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                        <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                            <div>
                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profGuida || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                       class="w-full px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                        <select id="falso-select-${project.id}"
                                onchange="updateFalsoEsistente('${project.id}', this.value)"
                                class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                            <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                    
                    <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                        <div class="bg-orange-50 p-3 rounded space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                    
                    <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                        <div class="bg-purple-50 p-3 rounded">
                            <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                    
                    <!-- âœ… NUOVO: Dislivello Piana DEFAULT FINESTRE (F) -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mt-4">
                        <h3 class="text-sm font-bold text-blue-800 mb-3">ğŸ“ Dislivello Piana - FINESTRE (F) - Default</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium mb-2">C'Ã¨ dislivello?</label>
                                <div class="flex gap-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloFinestre-${project.id}" value="no"
                                               ${!project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'checked' : ''}
                                               onchange="updateDislivelloDefault('${project.id}', 'finestre', 'presente', false)"
                                               class="mr-2">
                                        <span class="text-sm">Nessun dislivello</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloFinestre-${project.id}" value="si"
                                               ${project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'checked' : ''}
                                               onchange="updateDislivelloDefault('${project.id}', 'finestre', 'presente', true)"
                                               class="mr-2">
                                        <span class="text-sm">Dislivello presente</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="dislivelloFinestreFields-${project.id}" 
                                 style="display: ${project.caratteristicheMuro?.dislivelloPianaFinestre?.presente ? 'block' : 'none'}">
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Piana piÃ¹ alta:</label>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAltaFinestre-${project.id}" value="interna"
                                                       ${project.caratteristicheMuro?.dislivelloPianaFinestre?.pianaAlta === 'interna' ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'finestre', 'pianaAlta', 'interna')"
                                                       class="mr-2">
                                                <span class="text-sm">ğŸ  Interna</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAltaFinestre-${project.id}" value="esterna"
                                                       ${project.caratteristicheMuro?.dislivelloPianaFinestre?.pianaAlta === 'esterna' ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'finestre', 'pianaAlta', 'esterna')"
                                                       class="mr-2">
                                                <span class="text-sm">ğŸŒ Esterna</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Dislivello (mm):</label>
                                        <input type="number" placeholder="0" min="0"
                                               value="${project.caratteristicheMuro?.dislivelloPianaFinestre?.valore || ''}"
                                               onchange="updateDislivelloDefault('${project.id}', 'finestre', 'valore', this.value)"
                                               class="w-32 px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- âœ… NUOVO: Dislivello Piana DEFAULT PORTE-FINESTRE (PF) -->
                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mt-4">
                        <h3 class="text-sm font-bold text-amber-800 mb-3">ğŸ“ Dislivello Piana - PORTE-FINESTRE (PF) - Default</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium mb-2">C'Ã¨ dislivello?</label>
                                <div class="flex gap-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloPF-${project.id}" value="no"
                                               ${!project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'checked' : ''}
                                               onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'presente', false)"
                                               class="mr-2">
                                        <span class="text-sm">Nessun dislivello</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloPF-${project.id}" value="si"
                                               ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'checked' : ''}
                                               onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'presente', true)"
                                               class="mr-2">
                                        <span class="text-sm">Dislivello presente</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="dislivelloPFFields-${project.id}" 
                                 style="display: ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.presente ? 'block' : 'none'}">
                                <div class="space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Piana piÃ¹ alta:</label>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAltaPF-${project.id}" value="interna"
                                                       ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.pianaAlta === 'interna' ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'pianaAlta', 'interna')"
                                                       class="mr-2">
                                                <span class="text-sm">ğŸ  Interna</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAltaPF-${project.id}" value="esterna"
                                                       ${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.pianaAlta === 'esterna' ? 'checked' : ''}
                                                       onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'pianaAlta', 'esterna')"
                                                       class="mr-2">
                                                <span class="text-sm">ğŸŒ Esterna</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Dislivello (mm):</label>
                                        <input type="number" placeholder="0" min="0"
                                               value="${project.caratteristicheMuro?.dislivelloPianaPorteFinestre?.valore || ''}"
                                               onchange="updateDislivelloDefault('${project.id}', 'porteFinestre', 'valore', this.value)"
                                               class="w-32 px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ğŸ†• FASE 13 - Render Rilievo Globale per Prodotto
function renderRilievoGlobale(project, productType, productLabel, icon) {
    const rilievo = getRilievoGlobale(project, productType);
    console.log(`ğŸ¨ renderRilievoGlobale - ${productType}:`, rilievo);
    const completeness = calculateRilievoGlobaleCompleteness(project, productType);
    const hasInfissi = productType === 'infissi';
    
    return `
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-lg p-4 shadow-md mt-4">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        ${icon} ğŸ“‹ RILIEVO PREESISTENTE - ${productLabel}
                    </h3>
                    <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2">
                        <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="bg-purple-500 h-full transition-all duration-500" 
                                 style="width: ${completeness.percentage}%"></div>
                        </div>
                        <span class="text-sm font-bold">${completeness.percentage}%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${completeness.completed}/${completeness.total} campi</p>
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
                <!-- 1. MATERIALE -->
                <div>
                    <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                        ğŸ”§ Materiale
                        ${!rilievo.materiale || rilievo.materiale.trim() === '' ? '<span class="text-red-600">â—</span>' : '<span class="text-green-600">âœ“</span>'}
                    </label>
                    
                    ${(() => {
                        const options = ['Legno', 'PVC', 'Alluminio', 'Ferro', 'Acciaio'];
                        const isCustom = rilievo.materiale && !options.includes(rilievo.materiale);
                        const isEmpty = !rilievo.materiale || rilievo.materiale.trim() === '';
                        
                        return `
                            <!-- Select principale -->
                            <select 
                                class="w-full px-3 py-2 border-2 rounded-lg ${isEmpty ? 'border-red-300 bg-red-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500" 
                                onchange="handleSelectCustomChange('materiale', this, '${project.id}', '', '${productType}')">
                                <option value="">â–¼ Seleziona...</option>
                                ${options.map(opt => `
                                    <option value="${opt}" ${rilievo.materiale === opt ? 'selected' : ''}>${opt}</option>
                                `).join('')}
                                <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">ğŸ–Šï¸ Scrivi manualmente</option>
                            </select>
                            
                            <!-- Input custom -->
                            <input type="text" 
                                   class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg mt-2 bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                                   id="materiale_custom_${project.id}_config_${productType}"
                                   placeholder="âœï¸ Scrivi valore personalizzato..."
                                   value="${isCustom ? rilievo.materiale : ''}"
                                   style="display: ${isCustom ? 'block' : 'none'};"
                                   oninput="updateRilievoGlobale('${project.id}', '${productType}', 'materiale', this.value)">
                        `;
                    })()}
                </div>
                
                <!-- 2. NOTE AGGIUNTIVE -->
                <div>
                    <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                        ğŸ“ Note
                    </label>
                    <input type="text" 
                           value="${rilievo.note || ''}"
                           onchange="updateRilievoGlobale('${project.id}', '${productType}', 'note', this.value)"
                           placeholder="Note aggiuntive..."
                           class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
            </div>
            
            <div class="grid ${hasInfissi ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                <!-- ğŸ”„ v5.743: PULSANTI 3 STATI -->
                
                <!-- DA TOGLIERE -->
                <button type="button"
                        onclick="ciclaFlagRilievoGlobale('${project.id}', '${productType}', 'togliere')"
                        class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                               ${rilievo.togliere === 'si' ? 'bg-green-100 border-green-400' : 
                                 rilievo.togliere === 'no' ? 'bg-red-100 border-red-400' : 
                                 'bg-gray-100 border-gray-300'}
                               hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                    <span class="text-sm font-semibold flex items-center gap-2">
                        ğŸ”¨ Da togliere?
                    </span>
                    <span class="text-xl font-bold min-w-[28px] text-center
                                 ${rilievo.togliere === 'si' ? 'text-green-700' : 
                                   rilievo.togliere === 'no' ? 'text-red-700' : 
                                   'text-gray-500'}">
                        ${rilievo.togliere === 'si' ? 'âœ“' : rilievo.togliere === 'no' ? 'âœ—' : 'â—‹'}
                    </span>
                </button>
                
                <!-- DA SMALTIRE -->
                <button type="button"
                        onclick="ciclaFlagRilievoGlobale('${project.id}', '${productType}', 'smaltimento')"
                        class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                               ${rilievo.smaltimento === 'si' ? 'bg-green-100 border-green-400' : 
                                 rilievo.smaltimento === 'no' ? 'bg-red-100 border-red-400' : 
                                 'bg-gray-100 border-gray-300'}
                               hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                    <span class="text-sm font-semibold flex items-center gap-2">
                        ğŸ—‘ï¸ Da smaltire?
                    </span>
                    <span class="text-xl font-bold min-w-[28px] text-center
                                 ${rilievo.smaltimento === 'si' ? 'text-green-700' : 
                                   rilievo.smaltimento === 'no' ? 'text-red-700' : 
                                   'text-gray-500'}">
                        ${rilievo.smaltimento === 'si' ? 'âœ“' : rilievo.smaltimento === 'no' ? 'âœ—' : 'â—‹'}
                    </span>
                </button>
                
                ${hasInfissi ? `
                    <!-- COPRIFILI INT -->
                    <div class="flex flex-col gap-2">
                        <button type="button"
                                onclick="ciclaFlagRilievoGlobale('${project.id}', '${productType}', 'coprifiliInt')"
                                class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                       ${rilievo.coprifiliInt === 'si' ? 'bg-green-100 border-green-400' : 
                                         rilievo.coprifiliInt === 'no' ? 'bg-red-100 border-red-400' : 
                                         'bg-gray-100 border-gray-300'}
                                       hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                            <span class="text-sm font-semibold flex items-center gap-2">
                                ğŸ“ Coprifili INT?
                            </span>
                            <span class="text-xl font-bold min-w-[28px] text-center
                                         ${rilievo.coprifiliInt === 'si' ? 'text-green-700' : 
                                           rilievo.coprifiliInt === 'no' ? 'text-red-700' : 
                                           'text-gray-500'}">
                                ${rilievo.coprifiliInt === 'si' ? 'âœ“' : rilievo.coprifiliInt === 'no' ? 'âœ—' : 'â—‹'}
                            </span>
                        </button>
                        ${rilievo.coprifiliInt === 'si' ? `
                            <input type="text" 
                                   value="${rilievo.coprifiliIntNote || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliIntNote', this.value)"
                                   placeholder="Descrizione coprifili INT..."
                                   class="w-full px-2 py-1 text-sm border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-green-50">
                        ` : ''}
                    </div>
                    
                    <!-- COPRIFILI EST -->
                    <div class="flex flex-col gap-2">
                        <button type="button"
                                onclick="ciclaFlagRilievoGlobale('${project.id}', '${productType}', 'coprifiliEst')"
                                class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                       ${rilievo.coprifiliEst === 'si' ? 'bg-green-100 border-green-400' : 
                                         rilievo.coprifiliEst === 'no' ? 'bg-red-100 border-red-400' : 
                                         'bg-gray-100 border-gray-300'}
                                       hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                            <span class="text-sm font-semibold flex items-center gap-2">
                                ğŸ“ Coprifili EST?
                            </span>
                            <span class="text-xl font-bold min-w-[28px] text-center
                                         ${rilievo.coprifiliEst === 'si' ? 'text-green-700' : 
                                           rilievo.coprifiliEst === 'no' ? 'text-red-700' : 
                                           'text-gray-500'}">
                                ${rilievo.coprifiliEst === 'si' ? 'âœ“' : rilievo.coprifiliEst === 'no' ? 'âœ—' : 'â—‹'}
                            </span>
                        </button>
                        ${rilievo.coprifiliEst === 'si' ? `
                            <input type="text" 
                                   value="${rilievo.coprifiliEstNote || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliEstNote', this.value)"
                                   placeholder="Descrizione coprifili EST..."
                                   class="w-full px-2 py-1 text-sm border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-green-50">
                        ` : ''}
                    </div>
                ` : ''}
            </div>
            
            ${completeness.percentage < 100 ? `
                <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                    âš ï¸ <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                </div>
            ` : `
                <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                    âœ… <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                </div>
            `}
        </div>
    `;
}

function renderBRMConfig(project, productType, productLabel, icon) {
    const configKey = `brmConfig${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const config = project[configKey] || { 
        misuraBaseL: '', operazioneL: '-', valoreL: '0',
        misuraBaseH: '', operazioneH: '-', valoreH: '0',
        misuraBaseB: '', operazioneB: '-', valoreB: '0',
        misuraBaseC: '', operazioneC: '-', valoreC: '0',
        note: '' 
    };
    
    // Misure di larghezza specifiche per cassonetti o generiche
    let misureLarghezza = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
    let misureAltezza = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
    let misureLarghezzaPF = ['LPF', 'LVT', 'LVAR', 'TMV', 'LS'];
    let misureAltezzaPF = ['HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
    
    // Misure B e C (solo per cassonetti)
    let misureB = ['Prof. Muro Int â†’ MI', 'B'];
    let misureC = ['Prof. Muro Int â†’ MI', 'C'];
    
    if (productType === 'cassonetti') {
        // âœ… MISURE SPECIFICHE PER CASSONETTI (secondo schema)
        misureLarghezza = ['(LS+SRSX+SRDX)', 'LVT', 'LF', 'TMV', 'BRM_L_INFISSO'];
        misureAltezza = ['HCASS', 'H Soffitto', 'H Parapetto/Soffitto', 'BRM_H_INFISSO'];
    }
    
    // Decide se mostrare campi aggiuntivi per portafinestra
    const showPortafinestra = (productType === 'infissi' || productType === 'zanzariere');
    
    return `
        <div class="brm-calculator mt-6 p-4">
            <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                <span class="text-xl">${icon}</span>
                ğŸ“ Calcolo BRM per ${productLabel}
                ${productType === 'cassonetti' ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">âœ… Misure Specifiche Cassonetti</span>' : ''}
                ${showPortafinestra ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">ğŸªŸ Finestra / Portafinestra</span>' : ''}
            </h3>
            
            <!-- BRM FINESTRA -->
            <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 mb-4">
                <h4 class="font-bold text-green-800 mb-3">ğŸªŸ BRM FINESTRA ${showPortafinestra && productType === 'zanzariere' ? '(F1, F2, F3, FISSO)' : productType === 'infissi' ? '(F1, F2, F3, FISSO)' : ''}</h4>
                <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-2'} gap-4">
                    ${productType === 'zanzariere' ? `
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h5 class="font-semibold text-amber-800 mb-2 text-sm">ğŸ“ BRM Larghezza Finestra</h5>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureLarghezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreL || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result text-xs">
                                ${config.misuraBaseL ? `ğŸ“ BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <h5 class="font-semibold text-amber-800 mb-2">ğŸ“ BRM Larghezza</h5>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureLarghezza.map(m => `
                                            <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                            class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreL || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                           class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result">
                                ${config.misuraBaseL ? `ğŸ“ BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    `}
                    
                    <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                        <h5 class="font-semibold text-amber-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">ğŸ“ BRM Altezza ${showPortafinestra ? 'Finestra' : ''}</h5>
                        <div class="grid grid-cols-3 gap-2 mb-2">
                            <div>
                                <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH', this.value)"
                                        class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                    <option value="">-</option>
                                    ${misureAltezza.map(m => `
                                        <option value="${m}" ${config.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH', this.value)"
                                        class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                    <option value="+" ${config.operazioneH === '+' ? 'selected' : ''}>+</option>
                                    <option value="-" ${config.operazioneH === '-' ? 'selected' : ''}>-</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                <input type="number" value="${config.valoreH || '0'}"
                                       onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH', this.value)"
                                       class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                            </div>
                        </div>
                        <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                            ${config.misuraBaseH ? `ğŸ“ BRM H = ${config.misuraBaseH} ${config.operazioneH} ${config.valoreH}mm` : 'Seleziona misura'}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- BRM PORTAFINESTRA (solo per infissi e zanzariere) -->
            ${showPortafinestra ? `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 mb-4">
                    <h4 class="font-bold text-blue-800 mb-3">ğŸšª BRM PORTAFINESTRA (PF1, PF2, PF3)</h4>
                    <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-4">
                        ${productType === 'zanzariere' ? `
                            <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                                <h5 class="font-semibold text-blue-800 mb-2 text-sm">ğŸ“ BRM Larghezza Portafinestra</h5>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div>
                                        <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL_PF', this.value)"
                                                class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                            <option value="">-</option>
                                            ${misureLarghezzaPF.map(m => `
                                                <option value="${m}" ${config.misuraBaseL_PF === m ? 'selected' : ''}>${m}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL_PF', this.value)"
                                                class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                            <option value="+" ${config.operazioneL_PF === '+' ? 'selected' : ''}>+</option>
                                            <option value="-" ${(config.operazioneL_PF === '-' || !config.operazioneL_PF) ? 'selected' : ''}>-</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                        <input type="number" value="${config.valoreL_PF || '0'}"
                                               onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL_PF', this.value)"
                                               class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                    </div>
                                </div>
                                <div class="brm-result text-xs">
                                    ${config.misuraBaseL_PF ? `ğŸ“ BRM L PF = ${config.misuraBaseL_PF} ${config.operazioneL_PF || '-'} ${config.valoreL_PF || '0'}mm` : 'Seleziona misura'}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                            <h5 class="font-semibold text-blue-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">ğŸ“ BRM Altezza Portafinestra</h5>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH_PF', this.value)"
                                            class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureAltezzaPF.map(m => `
                                            <option value="${m}" ${config.misuraBaseH_PF === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH_PF', this.value)"
                                            class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneH_PF === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${(config.operazioneH_PF === '-' || !config.operazioneH_PF) ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreH_PF || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH_PF', this.value)"
                                           class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                                ${config.misuraBaseH_PF ? `ğŸ“ BRM H PF = ${config.misuraBaseH_PF} ${config.operazioneH_PF || '-'} ${config.valoreH_PF || '0'}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <!-- BRM B e C (solo per cassonetti) -->
            ${productType === 'cassonetti' ? `
                <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 mb-4">
                    <h4 class="font-bold text-purple-800 mb-3">ğŸ“¦ BRM PROFONDITÃ€ CASSONETTO</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- BRM B -->
                        <div class="bg-white p-3 rounded-lg border-2 border-purple-400">
                            <h5 class="font-semibold text-purple-800 mb-2">ğŸ“ BRM B (ProfonditÃ  1)</h5>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseB', this.value)"
                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureB.map(m => `
                                            <option value="${m}" ${config.misuraBaseB === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneB', this.value)"
                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneB === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${(config.operazioneB === '-' || !config.operazioneB) ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreB || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreB', this.value)"
                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result">
                                ${config.misuraBaseB ? `ğŸ“ BRM B = ${config.misuraBaseB} ${config.operazioneB || '-'} ${config.valoreB || '0'}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                        
                        <!-- BRM C -->
                        <div class="bg-white p-3 rounded-lg border-2 border-purple-400">
                            <h5 class="font-semibold text-purple-800 mb-2">ğŸ“ BRM C (ProfonditÃ  2)</h5>
                            <div class="grid grid-cols-3 gap-2 mb-2">
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">Misura</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseC', this.value)"
                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                        <option value="">-</option>
                                        ${misureC.map(m => `
                                            <option value="${m}" ${config.misuraBaseC === m ? 'selected' : ''}>${m}</option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">Op.</label>
                                    <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneC', this.value)"
                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                        <option value="+" ${config.operazioneC === '+' ? 'selected' : ''}>+</option>
                                        <option value="-" ${(config.operazioneC === '-' || !config.operazioneC) ? 'selected' : ''}>-</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-medium text-purple-800 block mb-1">mm</label>
                                    <input type="number" value="${config.valoreC || '0'}"
                                           onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreC', this.value)"
                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                </div>
                            </div>
                            <div class="brm-result">
                                ${config.misuraBaseC ? `ğŸ“ BRM C = ${config.misuraBaseC} ${config.operazioneC || '-'} ${config.valoreC || '0'}mm` : 'Seleziona misura'}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
            
            <div>
                <label class="block text-xs font-medium text-amber-800 mb-1">ğŸ“ Note Formula</label>
                <textarea onchange="updateBRMConfig('${project.id}', '${configKey}', 'note', this.value)"
                          placeholder="Es: Tolleranza standard, considerazioni particolari..."
                          class="w-full px-2 py-1 border border-amber-500 rounded text-sm"
                          rows="2">${config.note || ''}</textarea>
            </div>
        </div>
    `;
}

// ğŸ†• v5.96: Funzione generica BRM posizione (usata da renderer centralizzato)
function renderBRMPosizione(project, pos, productType, productData) {
    const brmKeyMap = {
        'infisso': 'brmConfigInfissi',
        'persiana': 'brmConfigPersiane',
        'tapparella': 'brmConfigTapparelle',
        'zanzariera': 'brmConfigZanzariere',
        'cassonetto': 'brmConfigCassonetti'
    };
    const brmConfig = project[brmKeyMap[productType]] || {};
    const prod = productData;
    
    const misureL = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
    const misureH = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
    
    return `
        <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
            <div class="flex justify-between items-center mb-3">
                <h5 class="font-bold text-amber-800 flex items-center gap-2">ğŸ“ BRM - Misura per Ordine</h5>
                ${!prod.brmPersonalizzato ? `
                    <button onclick="personalizzaBRM('${project.id}', '${pos.id}', '${productType}')"
                            class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                        ğŸ¨ Personalizza BRM
                    </button>
                ` : `
                    <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', '${productType}')"
                            class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                        â†©ï¸ Usa Globale
                    </button>
                `}
            </div>
            
            ${!prod.brmPersonalizzato ? `
                <div class="bg-white p-3 rounded border-2 border-amber-400">
                    <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="font-semibold">BRM L =</span> ${brmConfig.misuraBaseL || '?'} ${brmConfig.operazioneL || '-'} ${brmConfig.valoreL || '0'}mm</div>
                        <div><span class="font-semibold">BRM H =</span> ${brmConfig.misuraBaseH || '?'} ${brmConfig.operazioneH || '-'} ${brmConfig.valoreH || '0'}mm</div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-3 mt-3">
                    <div class="bg-white p-2 rounded border">
                        <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Larghezza</label>
                        <input type="number" value="${prod.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                    </div>
                    <div class="bg-white p-2 rounded border">
                        <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Altezza</label>
                        <input type="number" value="${prod.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                    </div>
                </div>
            ` : `
                <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                    <p class="text-sm font-semibold text-purple-800 mb-2">âš™ï¸ Formula Personalizzata:</p>
                    <div class="mb-3">
                        <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Larghezza</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'misuraBaseL', this.value)"
                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                <option value="">-</option>
                                ${misureL.map(m => `<option value="${m}" ${prod.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'operazioneL', this.value)"
                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                <option value="+" ${prod.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                <option value="-" ${prod.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                            </select>
                            <input type="number" value="${prod.brmPersonalizzato?.valoreL || '0'}"
                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'valoreL', this.value)"
                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Altezza</label>
                        <div class="grid grid-cols-3 gap-2">
                            <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'misuraBaseH', this.value)"
                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                <option value="">-</option>
                                ${misureH.map(m => `<option value="${m}" ${prod.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>`).join('')}
                            </select>
                            <select onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'operazioneH', this.value)"
                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                <option value="+" ${prod.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                <option value="-" ${prod.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                            </select>
                            <input type="number" value="${prod.brmPersonalizzato?.valoreH || '0'}"
                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}', 'valoreH', this.value)"
                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                        </div>
                    </div>
                </div>
                <div class="mt-3 flex justify-center">
                    <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', '${productType}')"
                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                        ğŸ’¾ Salva
                    </button>
                </div>
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="bg-white p-2 rounded border-2 border-green-500">
                        <label class="text-xs font-semibold text-green-800 block">âœ… BRM Larghezza</label>
                        <input type="number" value="${prod.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                    </div>
                    <div class="bg-white p-2 rounded border-2 border-green-500">
                        <label class="text-xs font-semibold text-green-800 block">âœ… BRM Altezza</label>
                        <input type="number" value="${prod.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderStep3ConfigInfissi(project) {
    if (!project.prodotti?.infissi) {
        return `
            <div class="text-center py-8">
                <p class="text-gray-500">Gli infissi non sono stati selezionati. Salta questo step.</p>
            </div>
        `;
    }

    return `
        <div>
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">ğŸªŸ</span> Configurazione Infissi Default
                </h2>
                <button onclick="forzaSincronizzazioneInfissi('${project.id}')"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-medium transition flex items-center gap-2 shadow-lg">
                    ğŸ”„ SINCRONIZZA TUTTO
                </button>
            </div>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutti gli infissi:</p>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-sm text-blue-800">
                ğŸ’¡ <strong>Sincronizzazione automatica:</strong> Quando modifichi un valore qui, tutte le posizioni si aggiornano automaticamente (tranne quelle modificate manualmente). 
                Se hai dati vecchi, clicca <strong>"SINCRONIZZA TUTTO"</strong> per forzare l'aggiornamento.
            </div>
            
            ${renderRilievoGlobale(project, 'infissi', 'Infissi', 'ğŸªŸ')}
            
            <div class="space-y-2 mt-4">
                <div class="grid md:grid-cols-2 gap-2">
                    <!-- 1. AZIENDA -->
                    ${renderSelectWithCustom(
                        'azienda',
                        project.configInfissi?.azienda || '',
                        OPZIONI_PRODOTTI.infissi.aziende,
                        project.id,
                        null,
                        'infisso',
                        '1. Azienda'
                    )}
                    
                    <!-- â•â•â• MESSAGGIO PER ALTRI FORNITORI (Config Globale) â•â•â• -->
                    ${(project.configInfissi?.azienda && project.configInfissi?.azienda?.toLowerCase() !== 'finstral') ? `
                    <div class="col-span-2 bg-amber-50 border-2 border-amber-300 rounded-lg p-4 my-2">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âš ï¸</span>
                            <div>
                                <p class="font-bold text-amber-800">Valori per ${project.configInfissi?.azienda?.toUpperCase()} in arrivo</p>
                                <p class="text-sm text-amber-700 mt-1">I campi specifici per questo fornitore saranno disponibili prossimamente.</p>
                                <p class="text-xs text-amber-600 mt-2">ğŸ’¡ Per urgenze, usa "Scrivi manualmente" nel campo Azienda</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- â•â•â• CAMPI 2-14 SOLO PER FINSTRAL â•â•â• -->
                    ${(project.configInfissi?.azienda?.toLowerCase() === 'finstral') ? `

                    <!-- 2. TIPO ANTA -->
                    ${renderSelectWithCustom(
                        'tipoAnta',
                        project.configInfissi?.tipoAnta || '',
                        OPZIONI_PRODOTTI.infissi.tipiAnta,
                        project.id,
                        null,
                        'infisso',
                        '2. Tipo Anta'
                    )}

                    <!-- 3. FINITURA INTERNA -->
                    ${renderSelectWithCustom(
                        'finituraInt',
                        project.configInfissi?.finituraInt || '',
                        OPZIONI_PRODOTTI.infissi.finiture,
                        project.id,
                        null,
                        'infisso',
                        '3. Finitura Interna'
                    )}

                    <!-- 4. FINITURA ESTERNA -->
                    ${renderSelectWithCustom(
                        'finituraEst',
                        project.configInfissi?.finituraEst || '',
                        OPZIONI_PRODOTTI.infissi.finiture,
                        project.id,
                        null,
                        'infisso',
                        '4. Finitura Esterna'
                    )}

                    <!-- 5. COLORE INTERNO -->
                    ${renderSelectColoreStandard(
                        'coloreInt',
                        project.configInfissi?.coloreInt || '',
                        project.configInfissi?.finituraInt || 'pvc',
                        project.id,
                        null,
                        'infisso',
                        '5. Colore Interno'
                    )}

                    <!-- 6. COLORE ESTERNO -->
                    ${renderSelectColoreStandard(
                        'coloreEst',
                        project.configInfissi?.coloreEst || '',
                        project.configInfissi?.finituraEst || 'pvc',
                        project.id,
                        null,
                        'infisso',
                        '6. Colore Esterno'
                    )}

                    <!-- 7. TELAIO -->
                    <!-- ğŸ”„ v5.743: Telai filtrati per finitura (PVC/PVC-ALU/ALU/LEGNO) -->
                    ${renderSelectWithCustom(
                        'telaio',
                        project.configInfissi?.telaio || '',
                        getTelaiPerProgetto(project),
                        project.id,
                        null,
                        'infisso',
                        '7. Telaio'
                    )}

                    <!-- 8. ALLARME -->
                    ${renderSelectWithCustom(
                        'allarme',
                        project.configInfissi?.allarme || '',
                        OPZIONI_PRODOTTI.infissi.allarme,
                        project.id,
                        null,
                        'infisso',
                        '8. Allarme'
                    )}

                    <!-- 9. VETRO - ğŸ†• v5.77: Da FINSTRAL_OPZIONI centralizzato -->
                    ${renderSelectWithCustom(
                        'vetro',
                        project.configInfissi?.vetro || '',
                        OPZIONI_PRODOTTI.infissi.vetri,
                        project.id,
                        null,
                        'infisso',
                        '9. Vetro'
                    )}

                    <!-- 10. MANIGLIA - SEMPLIFICATO v4.39 -->
                    ${renderSelectWithCustom(
                        'maniglia',
                        project.configInfissi?.maniglia || '',
                        OPZIONI_PRODOTTI.infissi.maniglie,
                        project.id,
                        null,
                        'infisso',
                        '10. Maniglia'
                    )}

                    <!-- 12. COLORE MANIGLIA - AGGIORNATO v4.39 -->
                    ${renderSelectWithCustom(
                        'coloreManiglia',
                        project.configInfissi?.coloreManiglia || '',
                        OPZIONI_PRODOTTI.infissi.coloriManiglia,
                        project.id,
                        null,
                        'infisso',
                        '11. Colore Maniglia'
                    )}

                    <!-- 13. TAGLI TELAIO -->
                    ${renderSelectWithCustom(
                        'tagliTelaio',
                        project.configInfissi?.tagliTelaio || '',
                        OPZIONI_PRODOTTI.infissi.tagliTelaio,
                        project.id,
                        null,
                        'infisso',
                        '12. Tagli Telaio'
                    )}

                    <!-- 13. COD.TAGLI (Editabili con etichette chiare) -->
                    <div>
                        <label class="block text-base font-bold mb-1 text-gray-800">13. COD.TAGLI</label>
                        ${(() => {
                            const tagliTelaio = project.configInfissi?.tagliTelaio || '';
                            // ğŸ†• v4.81: Genera posizioni tagli da tagliTelaio (non piÃ¹ salvato)
                            const codTagli = getPosizioniTagli(tagliTelaio);
                            
                            // Se non ha selezionato nulla, non mostrare niente
                            if (!tagliTelaio || tagliTelaio === '' || tagliTelaio === 'nessuno' || codTagli.length === 0) {
                                return '';
                            }
                            
                            // Mappa posizioni con etichette italiane
                            const labelMap = {
                                'SOPRA': 'â†‘ SOPRA',
                                'SOTTO': 'â†“ SOTTO',
                                'SX': 'â† SX',
                                'DX': 'â†’ DX'
                            };
                            
                            // ğŸ†• v4.79: Ottieni codici disponibili per il telaio selezionato
                            const telaioSelezionato = project.configInfissi?.telaio || '';
                            const codiciDisponibili = getCodiciTaglioPerTelaio(telaioSelezionato);
                            const hasCodici = codiciDisponibili.length > 0;
                            
                            return `
                                <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(110px, 110px));">
                                    ${codTagli.map((etichetta, idx) => {
                                        const codice = project.configInfissi?.codTagliValues?.[idx] || '';
                                        const isEmpty = !codice || codice.trim() === '';
                                        
                                        return `
                                            <div class="flex flex-col">
                                                <label class="text-xs font-bold mb-1 text-gray-700">${labelMap[etichetta] || etichetta}</label>
                                                ${hasCodici ? `
                                                    <select onchange="updateCodTagliValue('${project.id}', ${idx}, this.value)"
                                                            class="w-full px-2 py-2 border-2 rounded-lg font-mono text-center font-bold text-sm focus:ring-2 focus:ring-purple-500 ${
                                                                isEmpty ? 'border-orange-400 bg-orange-50' : 'border-purple-400 bg-purple-50'
                                                            }">
                                                        <option value="">-- Sel. --</option>
                                                        ${codiciDisponibili.map(c => `<option value="${c}" ${codice === c ? 'selected' : ''}>${c}</option>`).join('')}
                                                    </select>
                                                ` : `
                                                    <input type="text" 
                                                           value="${codice}"
                                                           onchange="updateCodTagliValue('${project.id}', ${idx}, this.value)"
                                                           placeholder="Codice"
                                                           class="w-full px-2 py-2 border-2 rounded-lg font-mono text-center font-bold text-sm focus:ring-2 focus:ring-purple-500 ${
                                                               isEmpty ? 'border-orange-400 bg-orange-50' : 'border-purple-400 bg-purple-50'
                                                           }">
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <p class="text-sm text-gray-600 mt-2 font-medium">ğŸ’¡ ${hasCodici ? `Codici disponibili per telaio ${telaioSelezionato}` : 'Seleziona prima un telaio per vedere i codici disponibili'}</p>
                            `;
                        })()}
                    </div>

                    <!-- ğŸ†• v5.67: BANCALI INTERNI -->
                    <div class="mt-6 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg">
                        <h3 class="text-lg font-bold text-amber-800 mb-3 flex items-center gap-2">
                            <span>ğŸªŸ</span> 14. Bancale Interno (opzionale)
                        </h3>
                        <div class="grid md:grid-cols-2 gap-3">
                            <!-- Tipo Bancale -->
                            <div>
                                <label class="block text-sm font-bold mb-1 text-gray-700">Tipo Bancale</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'bancaleTipo', this.value); render();"
                                        class="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white font-medium">
                                    <option value="" ${!project.configInfissi?.bancaleTipo ? 'selected' : ''}>-- Nessun bancale --</option>
                                    <option value="PVC" ${project.configInfissi?.bancaleTipo === 'PVC' ? 'selected' : ''}>PVC (cod.25000) - MDF pellicolato 25mm</option>
                                    <option value="LEGNO_95000" ${project.configInfissi?.bancaleTipo === 'LEGNO_95000' ? 'selected' : ''}>Legno 95000 - Profilo 39mm</option>
                                    <option value="LEGNO_96000" ${project.configInfissi?.bancaleTipo === 'LEGNO_96000' ? 'selected' : ''}>Legno 96000 - Profilo 69mm</option>
                                </select>
                            </div>
                            <!-- Bordo -->
                            <div>
                                <label class="block text-sm font-bold mb-1 text-gray-700">Bordi</label>
                                <select onchange="updateConfigInfissi('${project.id}', 'bancaleBordo', this.value)"
                                        class="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white font-medium"
                                        ${!project.configInfissi?.bancaleTipo ? 'disabled' : ''}>
                                    <option value="0" ${project.configInfissi?.bancaleBordo === '0' ? 'selected' : ''}>0 - Arrotondati sui lati</option>
                                    <option value="1" ${project.configInfissi?.bancaleBordo === '1' ? 'selected' : ''}>1 - Squadrati sui lati</option>
                                </select>
                            </div>
                        </div>
                        ${project.configInfissi?.bancaleTipo ? `
                            <div class="grid md:grid-cols-2 gap-3 mt-3">
                                <!-- ProfonditÃ  -->
                                <div>
                                    <label class="block text-sm font-bold mb-1 text-gray-700">ProfonditÃ  (mm)</label>
                                    <select onchange="updateConfigInfissi('${project.id}', 'bancaleProfondita', this.value)"
                                            class="w-full px-3 py-2 border-2 border-amber-300 rounded-lg bg-white font-medium">
                                        ${[120, 150, 180, 200, 240, 280, 320, 360, 400].map(p => 
                                            `<option value="${p}" ${project.configInfissi?.bancaleProfondita == p ? 'selected' : ''}>${p} mm</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <!-- Info -->
                                <div class="flex items-end">
                                    <p class="text-sm text-amber-700">
                                        ğŸ“ La lunghezza verrÃ  calcolata automaticamente in base alla larghezza BRM dell'infisso
                                    </p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                ğŸ’¡ ${FINSTRAL_BANCALI_INTERNI[project.configInfissi?.bancaleTipo]?.note || ''}
                            </p>
                        ` : ''}
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- ğŸ†• v5.68: SEZIONE 15 - ANTA TWIN (Veneziana/Plissettata) - SOLO SE TIPO ANTA = TWIN -->
            ${project.configInfissi?.azienda?.toLowerCase().includes('finstral') && 
              project.configInfissi?.tipoAnta?.toLowerCase().includes('twin') ? `
            <div class="space-y-2 mt-4">
                <div class="bg-gradient-to-r from-cyan-50 to-blue-50 p-4 rounded-lg border-2 border-cyan-300">
                    <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                        <span>ğŸªŸ</span> 15. Anta Twin - Oscurante Integrato (opzionale)
                    </h3>
                    <p class="text-xs text-gray-600 mb-3">Veneziana o Tenda plissettata integrata nell'anta</p>
                    
                    <div class="grid md:grid-cols-2 gap-3">
                        <!-- Tipo Oscurante -->
                        <div>
                            <label class="block text-sm font-bold mb-1 text-gray-700">Tipo Oscurante</label>
                            <select onchange="updateConfigInfissi('${project.id}', 'antaTwinTipo', this.value); render();"
                                    class="w-full px-3 py-2 border-2 border-cyan-300 rounded-lg bg-white font-medium">
                                <option value="" ${!project.configInfissi?.antaTwinTipo ? 'selected' : ''}>-- Nessuno --</option>
                                <option value="veneziana" ${project.configInfissi?.antaTwinTipo === 'veneziana' ? 'selected' : ''}>ğŸªŸ Veneziana (lamelle 25mm)</option>
                                <option value="plissettata" ${project.configInfissi?.antaTwinTipo === 'plissettata' ? 'selected' : ''}>ğŸšï¸ Tenda Plissettata</option>
                            </select>
                        </div>
                        
                        <!-- Tipo Anta Twin -->
                        <div>
                            <label class="block text-sm font-bold mb-1 text-gray-700">Tipo Anta</label>
                            <select onchange="updateConfigInfissi('${project.id}', 'antaTwinModello', this.value)"
                                    class="w-full px-3 py-2 border-2 border-cyan-300 rounded-lg bg-white font-medium"
                                    ${!project.configInfissi?.antaTwinTipo ? 'disabled' : ''}>
                                <option value="">Seleziona...</option>
                                ${Object.entries(FINSTRAL_ANTA_TWIN.tipiAnta).map(([key, val]) => 
                                    `<option value="${key}" ${project.configInfissi?.antaTwinModello === key ? 'selected' : ''}>${val.cod} - ${val.desc}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    ${project.configInfissi?.antaTwinTipo ? `
                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                        <!-- Colore -->
                        <div>
                            <label class="block text-sm font-bold mb-1 text-gray-700">Colore ${project.configInfissi?.antaTwinTipo === 'veneziana' ? 'Veneziana' : 'Plissettata'}</label>
                            <select onchange="updateConfigInfissi('${project.id}', 'antaTwinColore', this.value)"
                                    class="w-full px-3 py-2 border-2 border-cyan-300 rounded-lg bg-white font-medium">
                                <option value="">Seleziona colore...</option>
                                ${project.configInfissi?.antaTwinTipo === 'veneziana' ? 
                                    Object.entries(FINSTRAL_ANTA_TWIN.coloriVeneziana).map(([cod, info]) => 
                                        `<option value="${cod}" ${project.configInfissi?.antaTwinColore === cod ? 'selected' : ''}>${cod} - ${info.nome} (gtot ${info.gtot})</option>`
                                    ).join('') :
                                    Object.entries(FINSTRAL_ANTA_TWIN.coloriPlissettata).map(([cod, info]) => 
                                        `<option value="${cod}" ${project.configInfissi?.antaTwinColore === cod ? 'selected' : ''}>${cod} - ${info.nome}</option>`
                                    ).join('')
                                }
                            </select>
                        </div>
                        
                        <!-- Comando -->
                        <div>
                            <label class="block text-sm font-bold mb-1 text-gray-700">Comando</label>
                            <select onchange="updateConfigInfissi('${project.id}', 'antaTwinComando', this.value)"
                                    class="w-full px-3 py-2 border-2 border-cyan-300 rounded-lg bg-white font-medium">
                                ${Object.entries(FINSTRAL_ANTA_TWIN.comandi).map(([cod, info]) => 
                                    `<option value="${cod}" ${project.configInfissi?.antaTwinComando === cod ? 'selected' : ''}>${info.desc}${info.supplemento > 0 ? ' (+â‚¬' + info.supplemento + ')' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Info colore selezionato -->
                    ${project.configInfissi?.antaTwinColore ? `
                    <div class="mt-3 p-2 bg-cyan-100 rounded border border-cyan-300">
                        <p class="text-xs text-cyan-800">
                            ${(() => {
                                const colori = project.configInfissi?.antaTwinTipo === 'veneziana' ? 
                                    FINSTRAL_ANTA_TWIN.coloriVeneziana : FINSTRAL_ANTA_TWIN.coloriPlissettata;
                                const colore = colori[project.configInfissi?.antaTwinColore];
                                if (!colore) return '';
                                return `<strong>${colore.nome}</strong> - Classe ${colore.classe} | gtot: ${colore.gtot} | Riflessione: ${colore.riflessione}% | Trasmissione: ${colore.trasmissione}% | Assorbimento: ${colore.assorbimento}%`;
                            })()}
                        </p>
                    </div>
                    ` : ''}
                    
                    <p class="text-xs text-gray-500 mt-2">
                        ğŸ’¡ Disponibile solo per ante Twin: Slim-line Twin, Nova-line Twin, ecc. Prezzi calcolati in base a dimensioni.
                    </p>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            ${renderBRMConfig(project, 'infissi', 'Infissi', 'ğŸªŸ')}
        </div>
    `;
}

function renderStep4ConfigPersiane(project) {
    if (!project.prodotti?.persiane) {
        return `<div class="text-center py-8"><p class="text-gray-500">Le persiane non sono state selezionate. Salta questo step.</p></div>`;
    }
    
    // ğŸ†• v5.93: Usa renderConfigGlobaleFromCampi da CAMPI_PRODOTTI
    if (typeof renderConfigGlobaleFromCampi === 'function' && typeof CAMPI_PRODOTTI !== 'undefined') {
        return `
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸšª</span> Configurazione Persiane Default
                </h2>
                <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
                
                ${renderRilievoGlobale(project, 'persiane', 'Persiane', 'ğŸšª')}
                
                <div class="space-y-2 mt-4">
                    ${renderConfigGlobaleFromCampi(project, 'persiana')}
                </div>
                
                ${renderBRMConfig(project, 'persiane', 'Persiane', 'ğŸšª')}
            </div>
        `;
    }
    
    // Fallback: codice originale se render-config-campi.js non caricato
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸšª</span> Configurazione Persiane Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
            
            ${renderRilievoGlobale(project, 'persiane', 'Persiane', 'ğŸšª')}
            
            <div class="space-y-2 mt-4">
                <div class="grid md:grid-cols-2 gap-2">
                    ${renderSelectWithCustom('azienda', project.configPersiane?.azienda || '', OPZIONI_PRODOTTI.persiane.aziende, project.id, null, 'persiana', '1. Azienda')}
                    ${renderSelectWithCustom('modello', project.configPersiane?.modello || '', OPZIONI_PRODOTTI.persiane.modelli, project.id, null, 'persiana', '2. Modello')}
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    ${renderSelectWithCustom('fissaggio', project.configPersiane?.fissaggio || '', OPZIONI_PRODOTTI.persiane.fissaggi, project.id, null, 'persiana', '3. Fissaggio')}
                    <div id="tipo-telaio-persiane-container-${project.id}" style="display: ${project.configPersiane?.fissaggio === 'telaio' ? 'block' : 'none'}">
                        ${renderSelectWithCustom('tipoTelaio', project.configPersiane?.tipoTelaio || '', OPZIONI_PRODOTTI.persiane.tipiTelaio, project.id, null, 'persiana', '4. Tipo Telaio')}
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    ${renderSelectWithCustom('colorePersiana', project.configPersiane?.colorePersiana || '', COLORI_PERSIANE, project.id, null, 'persiana', '5. Colore Persiana')}
                    <div id="colore-telaio-persiane-container-${project.id}" style="display: ${project.configPersiane?.fissaggio === 'telaio' ? 'block' : 'none'}">
                        ${renderSelectWithCustom('coloreTelaio', project.configPersiane?.coloreTelaio || '', COLORI_PERSIANE, project.id, null, 'persiana', '6. Colore Telaio')}
                    </div>
                </div>
                <div>
                    ${renderSelectWithCustom('battuta', project.configPersiane?.battuta || '', OPZIONI_PRODOTTI.persiane.battute, project.id, null, 'persiana', '7. Battuta')}
                </div>
            </div>
            
            ${renderBRMConfig(project, 'persiane', 'Persiane', 'ğŸšª')}
        </div>
    `;
}

function renderStep5ConfigTapparelle(project) {
    if (!project.prodotti?.tapparelle) {
        return `<div class="text-center py-8"><p class="text-gray-500">Le tapparelle non sono state selezionate. Salta questo step.</p></div>`;
    }
    
    // ğŸ†• v5.96: Usa renderConfigGlobaleAdvanced da CAMPI_PRODOTTI
    if (typeof renderConfigGlobaleAdvanced === 'function' && typeof CAMPI_PRODOTTI !== 'undefined') {
        return `
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸšï¸</span> Configurazione Tapparelle Default
                </h2>
                <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
                
                ${renderConfigGlobaleAdvanced(project, 'tapparella')}
                
                ${renderRilievoGlobale(project, 'tapparelle', 'Tapparelle', 'ğŸšï¸')}
                
                ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', 'ğŸšï¸')}
            </div>
        `;
    }
    
    // Fallback: codice originale se render-config-campi.js non caricato
    const serveTapparella = project.configTapparelle?.serveTapparella !== false;
    const serveMotore = project.configTapparelle?.serveMotore || false;
    const serveAccessori = project.configTapparelle?.serveAccessori || false;
    
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸšï¸</span> Configurazione Tapparelle Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
            
            <!-- ğŸ†• v5.30: CHECKBOX COSA SERVE DEFAULT -->
            <div class="bg-gradient-to-r from-amber-100 to-orange-100 border-2 border-amber-400 rounded-lg p-4 mb-4">
                <h5 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                    ğŸ¯ Cosa serve di default nelle nuove posizioni?
                </h5>
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${serveTapparella ? 'border-amber-500 bg-amber-50' : 'border-gray-300'} hover:border-amber-400 transition-all">
                        <input type="checkbox" 
                               ${serveTapparella ? 'checked' : ''}
                               onchange="updateConfigTapparelle('${project.id}', 'serveTapparella', this.checked); render();"
                               class="w-5 h-5 accent-amber-600">
                        <span class="font-semibold text-gray-800">ğŸšï¸ Tapparella nuova</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${serveMotore ? 'border-blue-500 bg-blue-50' : 'border-gray-300'} hover:border-blue-400 transition-all">
                        <input type="checkbox" 
                               ${serveMotore ? 'checked' : ''}
                               onchange="updateConfigTapparelle('${project.id}', 'serveMotore', this.checked); render();"
                               class="w-5 h-5 accent-blue-600">
                        <span class="font-semibold text-gray-800">ğŸ”Œ Motore</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${serveAccessori ? 'border-purple-500 bg-purple-50' : 'border-gray-300'} hover:border-purple-400 transition-all">
                        <input type="checkbox" 
                               ${serveAccessori ? 'checked' : ''}
                               onchange="updateConfigTapparelle('${project.id}', 'serveAccessori', this.checked); render();"
                               class="w-5 h-5 accent-purple-600">
                        <span class="font-semibold text-gray-800">ğŸ”§ Accessori</span>
                    </label>
                </div>
                <p class="text-xs text-amber-700 mt-2">ğŸ’¡ Questi valori saranno pre-impostati quando aggiungi una nuova posizione</p>
            </div>
            
            ${renderRilievoGlobale(project, 'tapparelle', 'Tapparelle', 'ğŸšï¸')}
            
            <!-- Mostra config tapparella solo se serveTapparella -->
            ${serveTapparella ? `
            <div class="space-y-2 mt-4">
                <div class="grid md:grid-cols-2 gap-2">
                    <!-- 1. AZIENDA -->
                    ${renderSelectWithCustom(
                        'azienda',
                        project.configTapparelle?.azienda || '',
                        OPZIONI_PRODOTTI.tapparelle.aziende,
                        project.id,
                        null,
                        'tapparella',
                        '1. Azienda'
                    )}
                    
                    <!-- 2. MODELLO -->
                    <div>
                        <label class="block text-sm font-medium mb-1">2. Modello</label>
                        <select id="config-tap-modello-${project.id}"
                                onchange="updateConfigTapparelle('${project.id}', 'modello', this.value); updateColoriTapparellaDatalistConfig('${project.id}', this.value);"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona modello...</option>
                            ${getModelliTapparellaOptions(project.configTapparelle?.azienda, project.configTapparelle?.modello)}
                        </select>
                    </div>
                    
                    <!-- 3. COLORE TELO -->
                    <div>
                        <label class="block text-sm font-medium mb-1">3. Colore Telo</label>
                        <input type="text" placeholder="Seleziona colore"
                               id="config-tap-colore-${project.id}"
                               value="${project.configTapparelle?.colore || ''}"
                               list="config-colore-tap-list-${project.id}"
                               onchange="updateConfigTapparelle('${project.id}', 'colore', this.value)"
                               class="w-full px-3 py-2 border rounded-lg">
                        <datalist id="config-colore-tap-list-${project.id}">
                            ${(() => {
                                const colori = getColoriTapparella(project.configTapparelle?.modello);
                                return colori.map(c => `<option value="${c}">`).join('\n');
                            })()}
                        </datalist>
                    </div>
                    
                    <!-- 4. SOSTITUZIONE COMPONENTI -->
                    ${renderSostituzioneComponentiConfig(project.id, project.configTapparelle)}
                </div>
            </div>
            ` : `
            <!-- Messaggio quando solo motore/accessori -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mt-4 mb-4">
                <p class="text-blue-800">
                    <strong>â„¹ï¸ Configurazione ridotta:</strong> Hai selezionato solo Motore e/o Accessori (senza tapparella nuova).
                    <br>Le opzioni di configurazione telo non sono necessarie.
                </p>
            </div>
            `}
            
            <!-- ğŸ”Œ v5.40: CONFIG MOTORE DEFAULT - visibile se serveMotore -->
            ${serveMotore ? `
            <div class="bg-indigo-50 border-2 border-indigo-300 rounded-lg p-4 mt-4 mb-4">
                <h5 class="font-bold text-indigo-800 mb-3 flex items-center gap-2">
                    ğŸ”Œ Configurazione Motore Default
                </h5>
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Modello Motore -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Modello Motore</label>
                        <select class="w-full px-3 py-2 border border-indigo-300 rounded-lg bg-white"
                                onchange="updateConfigTapparelle('${project.id}', 'motoreModelloDefault', this.value)">
                            <option value="">Seleziona modello...</option>
                            ${MOTORI_SOMFY.map(m => `
                                <option value="${m.id}" ${project.configTapparelle?.motoreModelloDefault === m.id ? 'selected' : ''}>
                                    ${m.modello} - â‚¬${m.prezzo.toFixed(2)}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <!-- Comando -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Comando / Telecomando</label>
                        <select class="w-full px-3 py-2 border border-indigo-300 rounded-lg bg-white"
                                onchange="updateConfigTapparelle('${project.id}', 'comandoDefault', this.value)">
                            <option value="">Nessuno / Da definire</option>
                            ${COMANDI_SOMFY.map(c => `
                                <option value="${c.id}" ${project.configTapparelle?.comandoDefault === c.id ? 'selected' : ''}>
                                    ${c.nome} - â‚¬${c.prezzo.toFixed(2)}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                
                <!-- Accessori Motore -->
                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Accessori Motore</label>
                    <div class="grid grid-cols-2 gap-2">
                        ${ACCESSORI_MOTORE_SOMFY.map(acc => {
                            const checked = project.configTapparelle?.accessoriMotoreDefault?.[acc.id] || false;
                            return `
                                <label class="flex items-center gap-2 px-3 py-2 rounded-lg border ${checked ? 'bg-indigo-100 border-indigo-400' : 'bg-white border-gray-300'} cursor-pointer hover:bg-indigo-50">
                                    <input type="checkbox" 
                                           ${checked ? 'checked' : ''}
                                           onchange="updateConfigTapparelleAccessorioMotore('${project.id}', '${acc.id}', this.checked)"
                                           class="w-4 h-4 accent-indigo-600">
                                    <span class="text-sm">${acc.nome} <span class="text-indigo-600 font-semibold">â‚¬${acc.prezzo.toFixed(2)}</span></span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
                <p class="text-xs text-indigo-600 mt-2">ğŸ’¡ Questi valori saranno pre-impostati quando clicchi "+ Aggiungi Motore"</p>
            </div>
            ` : ''}
            
            ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', 'ğŸšï¸')}
        </div>
    `;
}

function renderStep6ConfigZanzariere(project) {
    if (!project.prodotti?.zanzariere) {
        return `<div class="text-center py-8"><p class="text-gray-500">Le zanzariere non sono state selezionate. Salta questo step.</p></div>`;
    }
    
    // ğŸ†• v5.96: Usa renderConfigGlobaleFromCampi da CAMPI_PRODOTTI
    if (typeof renderConfigGlobaleFromCampi === 'function' && typeof CAMPI_PRODOTTI !== 'undefined') {
        return `
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ¦Ÿ</span> Configurazione Zanzariere Default
                </h2>
                <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
                
                <div class="space-y-3">
                    ${renderConfigGlobaleFromCampi(project, 'zanzariera')}
                </div>
                
                ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', 'ğŸ¦Ÿ')}
            </div>
        `;
    }
    
    // Fallback: codice originale se render-config-campi.js non caricato
    const azienda = project.configZanzariere?.azienda || '';
    const isPalagina = azienda === 'Palagina';
    
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ¦Ÿ</span> Configurazione Zanzariere Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
            
            <div class="space-y-3">
                <!-- RIGA 1: AZIENDA -->
                <div class="grid md:grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">1. Azienda</label>
                        ${(() => {
                            const options = OPZIONI_PRODOTTI.zanzariere.aziende;
                            const current = project.configZanzariere?.azienda || '';
                            const isCustom = current && !options.includes(current);
                            const selectId = `zanz-azienda-${project.id}`;
                            const inputId = `zanz-azienda-input-${project.id}`;
                            
                            return `
                                <select id="${selectId}" 
                                        onchange="handleZanzariereAziendaChange('${project.id}', this.value, '${selectId}', '${inputId}')"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona azienda...</option>
                                    ${options.map(opt => `
                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                    `).join('')}
                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>âœï¸ Altra azienda...</option>
                                </select>
                                <input type="text" 
                                       id="${inputId}"
                                       value="${isCustom ? current : ''}"
                                       onchange="updateConfigZanzariere('${project.id}', 'azienda', this.value); render();"
                                       placeholder="Inserisci azienda personalizzata..."
                                       style="display: ${isCustom ? 'block' : 'none'};"
                                       class="w-full px-3 py-2 border rounded-lg mt-2">
                            `;
                        })()}
                    </div>
                    
                    ${isPalagina ? `
                    <!-- ğŸ†• v5.717: LINEA FINESTRE (F) -->
                    <div>
                        <label class="block text-sm font-medium mb-1">2. Linea Finestre</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'lineaF', this.value); render();"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona linea F...</option>
                            ${Object.entries(PALAGINA_ZANZARIERE.linee).map(([id, l]) => `
                                <option value="${id}" ${project.configZanzariere?.lineaF === id ? 'selected' : ''}>${l.nome}</option>
                            `).join('')}
                        </select>
                    </div>
                    ` : `
                    <!-- TIPO GENERICO -->
                    <div>
                        <label class="block text-sm font-medium mb-1">2. Tipo Zanzariera</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'tipo', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona tipo...</option>
                            <option value="Avvolgibile" ${project.configZanzariere?.tipo === 'Avvolgibile' ? 'selected' : ''}>Avvolgibile</option>
                            <option value="PlissÃ©" ${project.configZanzariere?.tipo === 'PlissÃ©' ? 'selected' : ''}>PlissÃ©</option>
                            <option value="Battente" ${project.configZanzariere?.tipo === 'Battente' ? 'selected' : ''}>Battente</option>
                            <option value="Scorrevole" ${project.configZanzariere?.tipo === 'Scorrevole' ? 'selected' : ''}>Scorrevole</option>
                            <option value="Fissa" ${project.configZanzariere?.tipo === 'Fissa' ? 'selected' : ''}>Fissa</option>
                        </select>
                    </div>
                    `}
                </div>
                
                ${isPalagina && project.configZanzariere?.lineaF ? `
                <!-- MODELLO FINESTRE filtrato per lineaF -->
                <div class="grid md:grid-cols-1 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">3. Modello Finestre</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'modelloF', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona modello F...</option>
                            ${(PALAGINA_ZANZARIERE.modelli[project.configZanzariere.lineaF] || []).map(m => `
                                <option value="${m.id}" ${project.configZanzariere?.modelloF === m.id ? 'selected' : ''}>
                                    ${m.nome} ${m.cassonetti !== '-' ? '(cass. '+m.cassonetti+')' : ''}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                ` : ''}
                
                ${isPalagina ? `
                <!-- LINEA PORTE-FINESTRE (PF) -->
                <div class="grid md:grid-cols-1 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">4. Linea Porte-Finestre</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'lineaPF', this.value); render();"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona linea PF...</option>
                            ${Object.entries(PALAGINA_ZANZARIERE.linee).map(([id, l]) => `
                                <option value="${id}" ${project.configZanzariere?.lineaPF === id ? 'selected' : ''}>${l.nome}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                ` : ''}
                
                ${isPalagina && project.configZanzariere?.lineaPF ? `
                <!-- MODELLO PORTE-FINESTRE filtrato per lineaPF -->
                <div class="grid md:grid-cols-1 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">5. Modello Porte-Finestre</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'modelloPF', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona modello PF...</option>
                            ${(PALAGINA_ZANZARIERE.modelli[project.configZanzariere.lineaPF] || []).map(m => `
                                <option value="${m.id}" ${project.configZanzariere?.modelloPF === m.id ? 'selected' : ''}>
                                    ${m.nome} ${m.cassonetti !== '-' ? '(cass. '+m.cassonetti+')' : ''}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                ` : ''}
                
                ${isPalagina ? `
                <!-- FASCIA + COLORE -->
                <div class="grid md:grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">6. Fascia Colore</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'fasciaColore', this.value); render();"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona fascia...</option>
                            <option value="F1" ${project.configZanzariere?.fasciaColore === 'F1' ? 'selected' : ''}>Fascia 1 (Base)</option>
                            <option value="F2" ${project.configZanzariere?.fasciaColore === 'F2' ? 'selected' : ''}>Fascia 2 (Intermedia)</option>
                            <option value="F3" ${project.configZanzariere?.fasciaColore === 'F3' ? 'selected' : ''}>Fascia 3 (Premium)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">7. Colore Telaio</label>
                        ${project.configZanzariere?.fasciaColore ? `
                        <select onchange="updateConfigZanzariere('${project.id}', 'coloreTelaio', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona colore...</option>
                            ${(PALAGINA_ZANZARIERE.colori[project.configZanzariere.fasciaColore] || []).map(c => `
                                <option value="${c.nome}" ${project.configZanzariere?.coloreTelaio === c.nome ? 'selected' : ''}>${c.nome}</option>
                            `).join('')}
                        </select>
                        ` : `
                        <input type="text" value=""
                               placeholder="Prima seleziona la fascia..."
                               disabled
                               class="w-full px-3 py-2 border rounded-lg bg-gray-100">
                        `}
                    </div>
                </div>
                
                <!-- TIPO RETE + COLORE PLASTICA -->
                <div class="grid md:grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">8. Tipo Rete</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'tipoRete', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona rete...</option>
                            ${PALAGINA_ZANZARIERE.reti.map(r => `
                                <option value="${r.id}" ${project.configZanzariere?.tipoRete === r.id ? 'selected' : ''}>${r.nome}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">9. Colore Plastica</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'colorePlastica', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona colore plastica...</option>
                            ${PALAGINA_ZANZARIERE.coloriPlastica.map(c => `
                                <option value="${c}" ${project.configZanzariere?.colorePlastica === c ? 'selected' : ''}>${c}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                ` : `
                <!-- CAMPI GENERICI (non Palagina) -->
                <div class="grid md:grid-cols-2 gap-2">
                    <div>
                        <label class="block text-sm font-medium mb-1">3. Colore Telaio</label>
                        <input type="text" value="${project.configZanzariere?.coloreTelaio || ''}"
                               onchange="updateConfigZanzariere('${project.id}', 'coloreTelaio', this.value)"
                               placeholder="Es: Bianco, Marrone, RAL 9010"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">4. Tipo Rete</label>
                        <select onchange="updateConfigZanzariere('${project.id}', 'tipoRete', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="Standard" ${project.configZanzariere?.tipoRete === 'Standard' ? 'selected' : ''}>Standard</option>
                            <option value="Anti-polline" ${project.configZanzariere?.tipoRete === 'Anti-polline' ? 'selected' : ''}>Anti-polline</option>
                            <option value="Pet-resistant" ${project.configZanzariere?.tipoRete === 'Pet-resistant' ? 'selected' : ''}>Pet-resistant</option>
                            <option value="Micro-forata" ${project.configZanzariere?.tipoRete === 'Micro-forata' ? 'selected' : ''}>Micro-forata</option>
                        </select>
                    </div>
                </div>
                `}
            </div>
            
            ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', 'ğŸ¦Ÿ')}
        </div>
    `;
}

// Handler per cambio azienda zanzariere (reset campi Palagina)
function handleZanzariereAziendaChange(projectId, value, selectId, inputId) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (value === '__ALTRO__') {
        document.getElementById(inputId).style.display = 'block';
        return;
    }
    
    document.getElementById(inputId).style.display = 'none';
    
    if (!project.configZanzariere) project.configZanzariere = {};
    
    // Se cambio azienda, resetto i campi specifici Palagina
    if (value !== 'Palagina') {
        delete project.configZanzariere.lineaF;
        delete project.configZanzariere.lineaPF;
        delete project.configZanzariere.modelloF;
        delete project.configZanzariere.modelloPF;
        delete project.configZanzariere.fasciaColore;
        delete project.configZanzariere.colorePlastica;
    }
    
    project.configZanzariere.azienda = value;
    saveState();
    render();
}

// ğŸ†• v5.717: Handler per cambio Fâ†”PF nella posizione zanzariera
// Quando cambia tipo, resetta linea/modello ai nuovi default dalla config globale
function handleZanzarieraTipoChange(projectId, posId, tipoInfissoAssociato) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions.find(p => p.id === posId);
    if (!pos || !pos.zanzariera) return;
    
    const zan = pos.zanzariera;
    const cfg = project.configZanzariere || {};
    
    // Aggiorna tipo
    zan.tipoInfissoAssociato = tipoInfissoAssociato;
    
    // Resetta ai nuovi default basati su F o PF
    if (tipoInfissoAssociato === 'PF') {
        zan.linea = cfg.lineaPF || '';
        zan.modello = cfg.modelloPF || '';
    } else {
        zan.linea = cfg.lineaF || '';
        zan.modello = cfg.modelloF || '';
    }
    
    // Mantieni altri valori default se non giÃ  impostati
    if (!zan.fasciaColore) zan.fasciaColore = cfg.fasciaColore || '';
    if (!zan.coloreTelaio) zan.coloreTelaio = cfg.coloreTelaio || '';
    if (!zan.tipoRete) zan.tipoRete = cfg.tipoRete || '';
    if (!zan.colorePlastica) zan.colorePlastica = cfg.colorePlastica || '';
    
    console.log(`ğŸ¦Ÿ Zanzariera cambio tipo: ${tipoInfissoAssociato} â†’ Linea: ${zan.linea}, Modello: ${zan.modello}`);
    
    saveState();
    render();
}

function renderStep7ConfigCassonetti(project) {
    if (!project.prodotti?.cassonetti) {
        return `<div class="text-center py-8"><p class="text-gray-500">I cassonetti non sono stati selezionati. Salta questo step.</p></div>`;
    }
    
    // ğŸ†• v5.96: Usa renderConfigGlobaleFromCampi da CAMPI_PRODOTTI
    if (typeof renderConfigGlobaleFromCampi === 'function' && typeof CAMPI_PRODOTTI !== 'undefined') {
        const azienda = project.configCassonetti?.azienda || '';
        const noAzienda = !azienda;
        
        return `
            <div>
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“¦</span> Configurazione Cassonetti Default
                </h2>
                <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
                
                ${renderRilievoGlobale(project, 'cassonetti', 'Cassonetti', 'ğŸ“¦')}
                
                <div class="space-y-2 mt-4">
                    ${renderConfigGlobaleFromCampi(project, 'cassonetto')}
                    ${noAzienda ? `
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 text-center">
                            âš ï¸ Seleziona un'azienda per visualizzare i campi specifici
                        </p>
                    </div>
                    ` : ''}
                </div>
                
                ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', 'ğŸ“¦')}
            </div>
        `;
    }
    
    // Fallback: codice originale se render-config-campi.js non caricato
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ“¦</span> Configurazione Cassonetti Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
            
            ${renderRilievoGlobale(project, 'cassonetti', 'Cassonetti', 'ğŸ“¦')}
            
            <div class="space-y-2 mt-4">
                <div class="grid md:grid-cols-2 gap-2">
                    <!-- 1. AZIENDA -->
                    <div>
                        <label class="block text-sm font-medium mb-1">1. Azienda</label>
                        ${(() => {
                            const options = OPZIONI_PRODOTTI.cassonetti.aziende;
                            const current = project.configCassonetti?.azienda || '';
                            const isCustom = current && !options.includes(current);
                            const selectId = `cass-azienda-${project.id}`;
                            const inputId = `cass-azienda-input-${project.id}`;
                            
                            return `
                                <select id="${selectId}" 
                                        onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'azienda', '${selectId}', '${inputId}', this.value); render();"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona azienda...</option>
                                    ${options.map(opt => `
                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                    `).join('')}
                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>âœï¸ Altra azienda...</option>
                                </select>
                                <input type="text" 
                                       id="${inputId}"
                                       value="${isCustom ? current : ''}"
                                       onchange="updateConfigCassonetti('${project.id}', 'azienda', this.value); render();"
                                       placeholder="Inserisci azienda personalizzata..."
                                       style="display: ${isCustom ? 'block' : 'none'};"
                                       class="w-full px-3 py-2 border rounded-lg mt-2">
                            `;
                        })()}
                    </div>
                    
                    ${(() => {
                        const azienda = project.configCassonetti?.azienda || '';
                        
                        // ====== FINSTRAL ======
                        if (azienda === 'Finstral') {
                            return `
                                <!-- 2. A SOFFITTO (checkbox) -->
                                <div>
                                    <label class="block text-sm font-medium mb-2 flex items-center gap-2">
                                        <input type="checkbox" 
                                               ${project.configCassonetti?.aSoffitto ? 'checked' : ''}
                                               onchange="updateConfigCassonetti('${project.id}', 'aSoffitto', this.checked)"
                                               class="w-4 h-4">
                                        2. A Soffitto
                                    </label>
                                </div>
                                
                                <!-- ===== CAMPI CALCOLO PREZZI v5.54 ===== -->
                                <div class="col-span-2 border-t-2 border-orange-300 pt-3 mt-2">
                                    <p class="text-sm font-bold text-orange-700 mb-2">ğŸ“Š Dati per Calcolo Prezzo:</p>
                                </div>
                                
                                <!-- 3. MATERIALE CASSONETTO -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">3. Materiale</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'materialeCass', this.value); render();"
                                            class="w-full px-3 py-2 border rounded-lg">
                                        <option value="">Seleziona materiale...</option>
                                        <option value="PVC" ${project.configCassonetti?.materialeCass === 'PVC' ? 'selected' : ''}>PVC</option>
                                        <option value="Legno" ${project.configCassonetti?.materialeCass === 'Legno' ? 'selected' : ''}>Legno</option>
                                    </select>
                                </div>
                                
                                <!-- 4. CODICE CASSONETTO (dipende da materiale) -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">4. Codice Cassonetto</label>
                                    ${renderSelectCodiceCassonetto(project)}
                                </div>
                                
                                <!-- 5. GRUPPO COLORE (dipende da materiale) -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">5. Gruppo Colore</label>
                                    ${renderSelectGruppoColoreCass(project)}
                                </div>
                                
                                <!-- 6. COLORE SPECIFICO (dipende da gruppo) -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">6. Colore</label>
                                    ${renderSelectColoreCassGlobal(project)}
                                    <!-- Checkbox sync colore -->
                                    <label class="text-xs text-gray-500 flex items-center gap-1 mt-1 cursor-pointer">
                                        <input type="checkbox" 
                                               ${project.configCassonetti?.coloreDaInfisso !== false ? 'checked' : ''}
                                               onchange="updateConfigCassonetti('${project.id}', 'coloreDaInfisso', this.checked); if(this.checked) sincronizzaColoreCassonetto('${project.id}');"
                                               class="w-3 h-3">
                                        = colore serramento
                                    </label>
                                </div>
                                
                                <!-- 7. ISOLAMENTO (sempre visibile) -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">7. Isolamento</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'codiceIsolamento', this.value)"
                                            class="w-full px-3 py-2 border rounded-lg bg-yellow-50">
                                        <option value="" ${!project.configCassonetti?.codiceIsolamento ? 'selected' : ''}>--</option>
                                        <option value="posaclima" ${project.configCassonetti?.codiceIsolamento === 'posaclima' ? 'selected' : ''}>Isolamento Posaclima</option>
                                        <option value="40830" ${project.configCassonetti?.codiceIsolamento === '40830' ? 'selected' : ''}>40830 (25mm)</option>
                                        <option value="40831" ${project.configCassonetti?.codiceIsolamento === '40831' ? 'selected' : ''}>40831 (13mm)</option>
                                    </select>
                                </div>
                            `;
                        }
                        
                        // ====== MAGÃ’ E ALPAC ======
                        if (azienda === 'MagÃ²' || azienda === 'Alpac') {
                            return `
                                <!-- 2. TIPO -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">2. Tipo</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                            class="w-full px-3 py-2 border rounded-lg">
                                        <option value="">Seleziona...</option>
                                        <option value="Cassonetto" ${project.configCassonetti?.tipo === 'Cassonetto' ? 'selected' : ''}>Cassonetto</option>
                                        <option value="Monoblocco" ${project.configCassonetti?.tipo === 'Monoblocco' ? 'selected' : ''}>Monoblocco</option>
                                    </select>
                                </div>
                                
                                <!-- 3. POSA -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">3. Posa</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'posa', this.value)"
                                            class="w-full px-3 py-2 border rounded-lg">
                                        <option value="">Seleziona...</option>
                                        <option value="Frontale" ${project.configCassonetti?.posa === 'Frontale' ? 'selected' : ''}>Frontale</option>
                                        <option value="Rasomuro" ${project.configCassonetti?.posa === 'Rasomuro' ? 'selected' : ''}>Rasomuro</option>
                                        <option value="Esterna dal sotto" ${project.configCassonetti?.posa === 'Esterna dal sotto' ? 'selected' : ''}>Esterna dal sotto</option>
                                        <option value="Interna dal sotto" ${project.configCassonetti?.posa === 'Interna dal sotto' ? 'selected' : ''}>Interna dal sotto</option>
                                    </select>
                                </div>
                                
                                <!-- 4. FINITURA -->
                                <div>
                                    <label class="block text-sm font-medium mb-1">4. Finitura</label>
                                    <select onchange="updateConfigCassonetti('${project.id}', 'finitura', this.value)"
                                            class="w-full px-3 py-2 border rounded-lg">
                                        <option value="">Seleziona...</option>
                                        <option value="Grezzo da rasare" ${project.configCassonetti?.finitura === 'Grezzo da rasare' ? 'selected' : ''}>Grezzo da rasare</option>
                                        <option value="Mano di fondo" ${project.configCassonetti?.finitura === 'Mano di fondo' ? 'selected' : ''}>Mano di fondo</option>
                                    </select>
                                </div>
                                
                                <!-- 5 e 6 NASCOSTI -->
                            `;
                        }
                        
                        // Nessuna azienda selezionata
                        return `
                            <div class="col-span-2 bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 text-center">
                                    âš ï¸ Seleziona un'azienda per visualizzare i campi specifici
                                </p>
                            </div>
                        `;
                    })()}
                </div>
            </div>
            
            ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', 'ğŸ“¦')}
        </div>
    `;
}

function renderStep8WallFeatures(project) {
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ—¿</span> Caratteristiche Muro (Misure in mm)
            </h2>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">Prof. Muro Int</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.profMuroInt || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                               class="w-full compact-input border rounded">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Prof. Piana Sopra</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                               class="w-full compact-input border rounded">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Prof. Piana Sotto</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                               class="w-full compact-input border rounded">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Telaio Prof</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                               class="w-full compact-input border rounded">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Telaio Largh</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                               class="w-full compact-input border rounded">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                    <select id="guida-select-${project.id}" 
                            onchange="updateGuidaEsistente('${project.id}', this.value)"
                            class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                        <option value="">Seleziona...</option>
                        <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                        <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                
                <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                    <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.profGuida || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.profMuroEst || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                    <select id="falso-select-${project.id}"
                            onchange="updateFalsoEsistente('${project.id}', this.value)"
                            class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                        <option value="">Seleziona...</option>
                        <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                        <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                
                <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                    <div class="bg-orange-50 p-3 rounded space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                            <input type="number" placeholder="0"
                                   value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                   onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                
                <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                    <div class="bg-purple-50 p-3 rounded">
                        <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                        <input type="number" placeholder="0"
                               value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                               onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ğŸ—¿ NUOVA FUNZIONE: Render caratteristiche muro OVERRIDE per posizione specifica
function renderCaratteristicheMuroOverride(project, pos) {
    const cm = pos.caratteristicheMuroOverride || {};
    const posIdUnique = `pos-${pos.id}`;
    
    return `
        <div class="bg-gradient-to-br from-yellow-50 to-purple-50 border-3 border-yellow-500 rounded-lg p-4 mt-4 shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                    <span class="text-2xl">ğŸ—¿</span> Caratteristiche Muro PERSONALIZZATE (Misure in mm)
                </h3>
                <button onclick="disableOverride('${project.id}', '${pos.id}')"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                    â†©ï¸ Ripristina Globali
                </button>
            </div>
            
            <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 mb-4">
                <p class="text-sm font-semibold text-yellow-900">
                    âš ï¸ <strong>Attenzione:</strong> Stai modificando le caratteristiche del muro solo per questa posizione.
                    Le modifiche qui NON influenzano le altre posizioni nÃ© la configurazione globale.
                </p>
            </div>
            
            <div class="space-y-4 bg-white p-4 rounded-lg">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium text-purple-700">Prof. Muro Int</label>
                        <input type="number" placeholder="0"
                               value="${cm.profMuroInt || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroInt', this.value)"
                               class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-purple-700">Prof. Piana Sopra</label>
                        <input type="number" placeholder="0"
                               value="${cm.profPianaSopra || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSopra', this.value)"
                               class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-purple-700">Prof. Piana Sotto</label>
                        <input type="number" placeholder="0"
                               value="${cm.profPianaSotto || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSotto', this.value)"
                               class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-purple-700">Telaio Prof</label>
                        <input type="number" placeholder="0"
                               value="${cm.telaioProfondita || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioProfondita', this.value)"
                               class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-purple-700">Telaio Largh</label>
                        <input type="number" placeholder="0"
                               value="${cm.telaioLarghezza || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioLarghezza', this.value)"
                               class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-purple-700 mb-1">Guida Esistente?</label>
                    <select onchange="updateGuidaEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                            class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                        <option value="">Seleziona...</option>
                        <option value="si" ${cm.guidaEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                        <option value="no" ${cm.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                
                ${cm.guidaEsistente === 'si' ? `
                    <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded border-2 border-green-300">
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                            <input type="number" placeholder="0"
                                   value="${cm.profDistanziale || ''}"
                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profDistanziale', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                            <input type="number" placeholder="0"
                                   value="${cm.profGuida || ''}"
                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profGuida', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                            <input type="number" placeholder="0"
                                   value="${cm.larghezzaGuida || ''}"
                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'larghezzaGuida', this.value)"
                                   class="w-full px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                ` : ''}
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">Prof. Muro Est.</label>
                        <input type="number" placeholder="0"
                               value="${cm.profMuroEst || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroEst', this.value)"
                               class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-purple-700 mb-1">Battuta Superiore con Tapparella</label>
                        <input type="number" placeholder="0"
                               value="${cm.battutaSuperioreTapparella || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'battutaSuperioreTapparella', this.value)"
                               class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-purple-700 mb-1">Falso Esistente?</label>
                    <select onchange="updateFalsoEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                            class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                        <option value="">Seleziona...</option>
                        <option value="si" ${cm.falsoEsistente === 'si' ? 'selected' : ''}>SÃ¬</option>
                        <option value="no" ${cm.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                    </select>
                </div>
                
                ${cm.falsoEsistente === 'si' ? `
                    <div class="bg-orange-50 p-3 rounded space-y-3 border-2 border-orange-300">
                        <div>
                            <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                            <input type="number" placeholder="0"
                                   value="${cm.spessoreFalso || ''}"
                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'spessoreFalso', this.value)"
                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                            <input type="number" placeholder="0"
                                   value="${cm.distanzaFalsoInfisso || ''}"
                                   onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaFalsoInfisso', this.value)"
                                   class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                ` : ''}
                
                ${cm.falsoEsistente === 'no' ? `
                    <div class="bg-purple-50 p-3 rounded border-2 border-purple-300">
                        <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                        <input type="number" placeholder="0"
                               value="${cm.distanzaMuroInfisso || ''}"
                               onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaMuroInfisso', this.value)"
                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ğŸ”’ v5.85: Step 7.5 - Configurazione Grate Sicurezza Erreci
function renderStepConfigGrate(project) {
    if (!project.prodotti?.grate) {
        return `<div class="text-center py-8"><p class="text-gray-500">Grate non selezionate. Salta questo step.</p></div>`;
    }
    return typeof GRATE_MODULE !== 'undefined' ? GRATE_MODULE.renderConfigGlobale(project) : '<p class="p-4 text-red-600">âš ï¸ Modulo grate non caricato</p>';
}

// ğŸªŸ v5.64: Step 8 - Configurazione Click Zip GIBUS
function renderStep8ConfigClickZip(project) {
    if (!project.prodotti?.clickZip) {
        return `<div class="text-center py-8"><p class="text-gray-500">Click Zip non selezionato. Salta questo step.</p></div>`;
    }
    
    const config = project.configClickZip || {};
    
    // Lista modelli Click Zip
    const modelliClickZip = Object.entries(GIBUS_DATABASE.clickZip).map(([key, val]) => ({
        id: key,
        nome: val.nome,
        cassonetto: val.cassonetto
    }));
    
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸªŸ</span> Configurazione Click Zip GIBUS - Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default. Sconto rivenditore: <strong class="text-green-600">48%</strong></p>
            
            <!-- BRM CONFIG -->
            ${renderBRMConfig(project, 'clickZip', 'Click Zip', 'ğŸªŸ')}
            
            <div class="space-y-4 mt-6">
                <!-- MODELLO DEFAULT -->
                <div class="bg-white border-2 border-cyan-300 rounded-lg p-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“‹ Modello Default</label>
                    <select onchange="updateConfigClickZip('${project.id}', 'modello', this.value)"
                            class="w-full border-2 border-gray-300 rounded-lg p-3 font-semibold focus:border-cyan-500">
                        <option value="">-- Seleziona modello --</option>
                        ${modelliClickZip.map(m => `
                            <option value="${m.id}" ${config.modello === m.id ? 'selected' : ''}>
                                ${m.nome} (${m.cassonetto})
                            </option>
                        `).join('')}
                    </select>
                </div>
                
                <!-- TESSUTO E COLORE DEFAULT -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white border-2 border-cyan-300 rounded-lg p-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ¨ Tessuto Default</label>
                        <select onchange="updateConfigClickZip('${project.id}', 'tessuto', this.value)"
                                class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-cyan-500">
                            <option value="">-- Seleziona --</option>
                            ${GIBUS_DATABASE.tessuti.map(t => `
                                <option value="${t}" ${config.tessuto === t ? 'selected' : ''}>${t}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="bg-white border-2 border-cyan-300 rounded-lg p-4">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ¨ Colore Struttura Default</label>
                        <select onchange="updateConfigClickZip('${project.id}', 'coloreStruttura', this.value)"
                                class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-cyan-500">
                            <option value="">-- Seleziona --</option>
                            ${GIBUS_DATABASE.coloriStruttura.map(c => `
                                <option value="${c}" ${config.coloreStruttura === c ? 'selected' : ''}>${c}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
                
                <!-- INFO -->
                <div class="bg-cyan-50 border border-cyan-300 rounded-lg p-3 text-sm text-cyan-800">
                    <strong>ğŸ’¡ Come funziona:</strong> Questi valori verranno copiati automaticamente in ogni posizione.
                    Le dimensioni saranno calcolate in base al BRM configurato sopra.
                    Il prezzo va inserito da MyGibus Maker in ogni singola posizione.
                </div>
            </div>
        </div>
    `;
}

// ğŸªŸ v5.64: Funzione per aggiornare config Click Zip
window.updateConfigClickZip = function(projectId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (!project.configClickZip) project.configClickZip = {};
    project.configClickZip[field] = value;
    
    console.log('ğŸªŸ Config Click Zip: ' + field + ' = ' + value);
    saveState();
    render();
};

// ============================================
// ğŸ” v5.745: RIEPILOGO VELOCE COLLASSABILE
// ============================================
const MISURE_DA_CONTROLLARE = ['LF', 'HF', 'LVT', 'HVT', 'TMV', 'HMT'];

function getStatoMisura(pos, campo) {
    const valore = pos.misure?.[campo];
    const nonServe = pos.misureNonServe?.[campo] === true;
    
    if (valore && valore !== '' && valore !== '0') return 'compilato'; // âœ“
    if (nonServe) return 'nonServe'; // âœ—
    return 'dimenticato'; // âš ï¸
}

function getStatoProdotto(pos, prodottoKey, project) {
    // Controlla se il prodotto Ã¨ attivo nel progetto
    const mapProdotti = {
        'infissi': 'infisso',
        'persiane': 'persiana', 
        'tapparelle': 'tapparella',
        'zanzariere': 'zanzariera',
        'cassonetti': 'cassonetto',
        'grate': 'grata'  // ğŸ”’ v5.85
    };
    const singolare = mapProdotti[prodottoKey];
    if (!singolare) return null;
    
    // Se il prodotto non Ã¨ attivo nel progetto, non mostrare
    if (!project.prodotti?.[prodottoKey]) return null;
    
    // Controlla se dichiarato assente
    const isDichiaratoAssente = (pos.prodottiAssenti || []).includes(singolare);
    if (isDichiaratoAssente) return 'nonServe'; // âœ—
    
    // Controlla se ha dati
    const prod = pos[singolare];
    if (prod && typeof prod === 'object') {
        const qta = parseInt(prod.qta || 0);
        if (qta > 0) return 'compilato'; // âœ“
        if (qta === 0) return 'nonServe'; // âœ— (qta esplicitamente 0)
    }
    
    return 'dimenticato'; // âš ï¸ non ancora deciso
}

function contaProblemiPosizione(pos, project) {
    let problemi = 0;
    
    // Controlla prodotti
    const prodotti = ['infissi', 'persiane', 'tapparelle', 'zanzariere', 'cassonetti'];
    prodotti.forEach(p => {
        const stato = getStatoProdotto(pos, p, project);
        if (stato === 'dimenticato') problemi++;
    });
    
    // Controlla misure (solo se almeno un prodotto richiede misure)
    const haProdottiAttivi = prodotti.some(p => {
        const stato = getStatoProdotto(pos, p, project);
        return stato === 'compilato';
    });
    
    if (haProdottiAttivi) {
        MISURE_DA_CONTROLLARE.forEach(m => {
            if (getStatoMisura(pos, m) === 'dimenticato') problemi++;
        });
    }
    
    return problemi;
}

function renderRiepilogoVeloce(project) {
    if (!project.positions || project.positions.length === 0) return '';
    
    // Conta problemi totali
    let totaleProblemi = 0;
    project.positions.forEach(pos => {
        totaleProblemi += contaProblemiPosizione(pos, project);
    });
    
    const prodottiAttivi = [];
    if (project.prodotti?.infissi) prodottiAttivi.push({ key: 'infissi', icon: 'ğŸªŸ', label: 'Inf' });
    if (project.prodotti?.persiane) prodottiAttivi.push({ key: 'persiane', icon: 'ğŸšª', label: 'Per' });
    if (project.prodotti?.tapparelle) prodottiAttivi.push({ key: 'tapparelle', icon: 'ğŸšï¸', label: 'Tap' });
    if (project.prodotti?.zanzariere) prodottiAttivi.push({ key: 'zanzariere', icon: 'ğŸ¦Ÿ', label: 'Zan' });
    if (project.prodotti?.cassonetti) prodottiAttivi.push({ key: 'cassonetti', icon: 'ğŸ“¦', label: 'Cas' });
    if (project.prodotti?.grate) prodottiAttivi.push({ key: 'grate', icon: 'ğŸ”’', label: 'Grate' });  // ğŸ”’ v5.85
    
    return `
        <div class="mb-4">
            <div class="bg-gradient-to-r ${totaleProblemi > 0 ? 'from-orange-50 to-red-50 border-orange-400' : 'from-green-50 to-emerald-50 border-green-400'} border-2 rounded-lg overflow-hidden">
                <!-- Header collassabile -->
                <button onclick="toggleRiepilogoVeloce('${project.id}')" 
                        class="w-full px-4 py-3 flex justify-between items-center hover:bg-white hover:bg-opacity-50 transition">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">âš¡</span>
                        <span class="font-bold text-gray-800">RIEPILOGO VELOCE</span>
                        ${totaleProblemi > 0 ? `
                            <span class="px-3 py-1 bg-orange-500 text-white text-sm font-bold rounded-full animate-pulse">
                                âš ï¸ ${totaleProblemi} PROBLEMI
                            </span>
                        ` : `
                            <span class="px-3 py-1 bg-green-500 text-white text-sm font-bold rounded-full">
                                âœ… TUTTO OK
                            </span>
                        `}
                    </div>
                    <span id="riepilogo-arrow-${project.id}" class="text-xl transition-transform">â–¼</span>
                </button>
                
                <!-- Contenuto collassabile -->
                <div id="riepilogo-content-${project.id}" style="display: none;" class="px-4 pb-4">
                    <!-- Legenda -->
                    <div class="mb-3 p-2 bg-white bg-opacity-70 rounded-lg text-xs flex flex-wrap gap-4">
                        <span><span class="text-green-600 font-bold">âœ“</span> Compilato/Presente</span>
                        <span><span class="text-red-600 font-bold">âœ—</span> Non serve</span>
                        <span><span class="text-orange-500 font-bold">âš ï¸</span> DIMENTICATO!</span>
                    </div>
                    
                    <!-- Lista posizioni -->
                    <div class="space-y-2">
                        ${project.positions.map((pos, idx) => {
                            const problemiPos = contaProblemiPosizione(pos, project);
                            
                            // Stato prodotti
                            const statiProdotti = prodottiAttivi.map(p => {
                                const stato = getStatoProdotto(pos, p.key, project);
                                let icona = '';
                                let colore = '';
                                if (stato === 'compilato') { icona = 'âœ“'; colore = 'text-green-600'; }
                                else if (stato === 'nonServe') { icona = 'âœ—'; colore = 'text-red-500'; }
                                else { icona = 'âš ï¸'; colore = 'text-orange-500'; }
                                return `<span class="${colore}" title="${p.label}: ${stato}">${p.icon}${icona}</span>`;
                            }).join(' ');
                            
                            // Stato misure - solo se ha prodotti attivi
                            const haProdottiCompilati = prodottiAttivi.some(p => getStatoProdotto(pos, p.key, project) === 'compilato');
                            
                            let misureMancanti = [];
                            if (haProdottiCompilati) {
                                MISURE_DA_CONTROLLARE.forEach(m => {
                                    if (getStatoMisura(pos, m) === 'dimenticato') {
                                        misureMancanti.push(m);
                                    }
                                });
                            }
                            
                            return `
                                <div class="bg-white rounded-lg p-3 border ${problemiPos > 0 ? 'border-orange-300' : 'border-green-300'}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-bold text-sm">${pos.name || 'POS ' + (idx + 1)}</div>
                                            <div class="text-xs text-gray-600">${pos.piano || ''} ${pos.ambiente || ''}</div>
                                        </div>
                                        <div class="text-right">
                                            ${problemiPos > 0 ? `
                                                <span class="text-orange-500 font-bold text-sm">âš ï¸ ${problemiPos}</span>
                                            ` : `
                                                <span class="text-green-500 font-bold text-sm">âœ“ OK</span>
                                            `}
                                        </div>
                                    </div>
                                    <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-sm">
                                        <div>
                                            <span class="text-xs text-gray-500">Prodotti:</span> 
                                            ${statiProdotti}
                                        </div>
                                        ${haProdottiCompilati ? `
                                            <div>
                                                <span class="text-xs text-gray-500">Misure:</span>
                                                ${misureMancanti.length > 0 ? `
                                                    <span class="text-orange-500 font-semibold">âš ï¸ ${misureMancanti.join(', ')}</span>
                                                ` : `
                                                    <span class="text-green-500">âœ“ OK</span>
                                                `}
                                            </div>
                                        ` : `
                                            <div class="text-xs text-gray-400 italic">Nessun prodotto â†’ no misure</div>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function toggleRiepilogoVeloce(projectId) {
    const content = document.getElementById('riepilogo-content-' + projectId);
    const arrow = document.getElementById('riepilogo-arrow-' + projectId);
    if (content && arrow) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            arrow.style.transform = 'rotate(180deg)';
        } else {
            content.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
        }
    }
}

// Funzione per marcare misura come "non serve"
function toggleMisuraNonServe(projectId, posId, campo) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions?.find(p => p.id === posId);
    if (!pos) return;
    
    if (!pos.misureNonServe) pos.misureNonServe = {};
    
    // Toggle
    pos.misureNonServe[campo] = !pos.misureNonServe[campo];
    
    // Se marcata come "non serve", svuota il valore
    if (pos.misureNonServe[campo]) {
        if (!pos.misure) pos.misure = {};
        pos.misure[campo] = '';
    }
    
    saveState();
    render();
}

/**
 * ğŸ†• v5.77: Aggiorna tipo apertura F/PF per posizione
 * Propaga automaticamente ai prodotti della posizione
 */
function updateTipoApertura(projectId, posId, tipoApertura) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions?.find(p => p.id === posId);
    if (!pos) return;
    
    // Salva direttamente
    pos.tipoApertura = tipoApertura;
    console.log(`ğŸªŸ Tipo apertura aggiornato: ${tipoApertura} per posizione ${pos.nome || posId}`);
    
    // Propaga ai prodotti esistenti
    ['infisso', 'persiana', 'zanzariera', 'tapparella', 'cassonetto'].forEach(prod => {
        if (pos[prod]) pos[prod].tipoInfissoAssociato = tipoApertura;
    });
    
    saveState();
    render();
}

/**
 * ğŸ†• v5.79: Aggiorna posizione telaio (filo_muro/mazzetta)
 */
function updatePosizioneTelaio(projectId, posId, posizioneTelaio) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    const pos = project.positions?.find(p => p.id === posId);
    if (!pos) return;
    
    // Salva direttamente su ENTRAMBI i campi
    pos.posizioneTelaio = posizioneTelaio;
    pos.installazione = posizioneTelaio;
    console.log(`ğŸ§± Posizione telaio aggiornata: ${posizioneTelaio} per posizione ${pos.nome || posId}`);
    
    saveState();
    render();
}

// ğŸ†• v5.81: Esponi funzioni su window per onclick HTML
window.updateTipoApertura = updateTipoApertura;
window.updatePosizioneTelaio = updatePosizioneTelaio;

/**
 * ğŸ†• v5.79: Render selettore da OPZIONI_MURO centralizzato
 * Genera bottoni dinamicamente leggendo da OPZIONI_MURO
 * @param {string} tipoOpzione - es. 'tipoApertura', 'posizioneTelaio'
 * @param {string} valoreCorrente - valore attualmente selezionato
 * @param {string} projectId - ID progetto
 * @param {string} posId - ID posizione
 * @param {string} label - Etichetta da mostrare
 * @param {string} updateFunction - Nome funzione da chiamare onclick
 */
function renderSelettoreMuro(tipoOpzione, valoreCorrente, projectId, posId, label, updateFunction) {
    // ğŸ†• v5.81: Prima prova UI_FORMS (preferito)
    if (typeof UI_FORMS !== 'undefined') {
        // Mappa nomi campi: posizioneTelaio â†’ installazione
        const mappaOpzioni = {
            'posizioneTelaio': 'installazione'
        };
        const tipoMappato = mappaOpzioni[tipoOpzione] || tipoOpzione;
        
        const opzioni = UI_FORMS._getOpzioni(tipoMappato);
        if (opzioni) {
            return UI_FORMS._renderSelettoreToggle(tipoMappato, valoreCorrente, updateFunction, projectId, posId, label);
        }
    }
    
    // Fallback: prova JSON_MANAGER.CONFIG.OPZIONI
    let opzioni = null;
    const mappaOpzioni = { 'posizioneTelaio': 'installazione' };
    const tipoMappato = mappaOpzioni[tipoOpzione] || tipoOpzione;
    
    if (typeof JSON_MANAGER !== 'undefined' && JSON_MANAGER.CONFIG?.OPZIONI?.[tipoMappato]) {
        opzioni = JSON_MANAGER.CONFIG.OPZIONI[tipoMappato];
    } else if (typeof OPZIONI_MURO !== 'undefined' && OPZIONI_MURO[tipoOpzione]) {
        // Fallback vecchio OPZIONI_MURO
        opzioni = OPZIONI_MURO[tipoOpzione];
    }
    
    if (!opzioni) {
        console.warn(`âš ï¸ Opzioni ${tipoOpzione} non disponibili`);
        return `<div class="text-red-500 text-sm p-2">âš ï¸ Opzioni ${label} non caricate</div>`;
    }
    
    const isSelected = opzioni.some(opt => opt.codice === valoreCorrente);
    const borderClass = isSelected ? 'border-green-400' : 'border-orange-400';
    const bgClass = isSelected ? 'bg-green-50' : 'bg-orange-50';
    
    // Colori per i bottoni
    const colori = {
        tipoApertura: { 0: 'blue', 1: 'green' },
        installazione: { 0: 'indigo', 1: 'amber' },
        posizioneTelaio: { 0: 'indigo', 1: 'amber' }
    };
    
    const bottoniHTML = opzioni.map((opt, idx) => {
        const colore = colori[tipoOpzione]?.[idx] || colori[tipoMappato]?.[idx] || 'gray';
        const isAttivo = opt.codice === valoreCorrente;
        const classeAttivo = isAttivo 
            ? `bg-${colore}-600 text-white border-${colore}-600 shadow-lg` 
            : `bg-white text-gray-600 border-gray-300 hover:border-${colore}-400 hover:bg-${colore}-50`;
        
        return `
            <button type="button" 
                    onclick="${updateFunction}('${projectId}', '${posId}', '${opt.codice}')"
                    class="px-4 py-2 text-sm font-bold rounded-lg transition-all border-2 ${classeAttivo}">
                ${opt.nome}
            </button>
        `;
    }).join('');
    
    return `
        <div class="mb-4 p-3 border-2 rounded-lg ${borderClass} ${bgClass}">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div class="flex items-center gap-2">
                    <label class="text-sm font-bold text-gray-700">${label}:</label>
                    ${!isSelected ? '<span class="text-orange-600 text-sm font-bold">âš ï¸ Obbligatorio</span>' : '<span class="text-green-600 text-sm">âœ“</span>'}
                </div>
                <div class="flex gap-2 flex-wrap">
                    ${bottoniHTML}
                </div>
            </div>
            ${!isSelected ? `<p class="text-xs text-orange-700 mt-2">ğŸ‘† Seleziona ${label}</p>` : ''}
        </div>
    `;
}

function renderStep9Positions(project) {
    
    return `
        <div>
            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">ğŸ“</span> Posizioni (${project.positions.length})
                </h2>
                <div class="flex gap-2">
                    <button onclick="exportCurrentProjectExcel()"
                            class="px-4 py-2 bg-gradient-to-r from-emerald-600 to-green-700 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                        <span>ğŸ“Š</span>
                        <span>Excel Progetto</span>
                    </button>
                    <button onclick="addPosition('${project.id}')"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                        + Aggiungi Posizione
                    </button>
                </div>
            </div>
            
            <!-- ğŸ” v5.745: RIEPILOGO VELOCE -->
            ${renderRiepilogoVeloce(project)}

            ${project.positions.length === 0 ? `
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                    <button onclick="addPosition('${project.id}')"
                            class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                        Aggiungi Prima Posizione
                    </button>
                </div>
            ` : `
                <div class="space-y-3">
                    ${project.positions.map((pos, idx) => {
                        const validation = validateMisure(project, pos);
                        const statusIcon = validation.errors.length > 0 ? 'ğŸ”´' : validation.warnings.length > 0 ? 'ğŸŸ¡' : 'âœ…';
                        const statusText = validation.errors.length > 0 ? 'ERRORI' : validation.warnings.length > 0 ? 'WARNING' : 'OK';
                        
                        // Stato rilievo
                        const rilievoStatus = getRilievoStatus(pos);
                        const rilievoCompleteness = calculateRilievoCompleteness(pos);
                        
                        // ğŸ†• FASE 013 - Completamento posizione base (nome, ambiente, prodotti, misure)
                        // ğŸ”§ FASE 014 - Passa anche project
                        const posStatus = getPositionCompletenessStatus(pos, project);
                        
                        return `
                        <div class="section-card cursor-pointer hover:shadow-lg ${validation.errors.length > 0 ? 'pulse-error' : ''}" onclick="openPosition('${pos.id}')">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">ğŸ“</span>
                                    <div>
                                        <h3 class="font-semibold">${pos.name}</h3>
                                        <p class="text-sm text-gray-600">
                                            ${pos.piano || 'Piano'} â€¢ ${pos.ambiente || 'Ambiente'}
                                            ${pos.infisso ? ` â€¢ ğŸªŸ` : ''}
                                            ${pos.persiana ? ` â€¢ ğŸšª` : ''}
                                            ${pos.tapparella ? ` â€¢ ğŸšï¸` : ''}
                                            ${pos.zanzariera ? ` â€¢ ğŸ¦Ÿ` : ''}
                                            ${pos.cassonetto ? ` â€¢ ğŸ“¦` : ''}
                                        </p>
                                        <div class="flex items-center gap-3 mt-1">
                                            <p class="text-xs font-semibold ${validation.errors.length > 0 ? 'text-red-600' : validation.warnings.length > 0 ? 'text-amber-600' : 'text-green-600'}">
                                                ${statusIcon} Misure: ${statusText}
                                            </p>
                                            <p class="text-xs font-semibold text-${rilievoStatus.color}-600 flex items-center gap-1">
                                                ${rilievoStatus.icon} Rilievo: ${rilievoCompleteness.percentage}%
                                            </p>
                                            <p class="text-xs font-semibold text-${posStatus.color}-600 flex items-center gap-1" title="${posStatus.comp.missing.length > 0 ? 'Mancanti: ' + posStatus.comp.missing.join(', ') : 'Posizione completa'}">
                                                ${posStatus.icon} Completo: ${posStatus.text}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <span class="text-purple-600">â†’</span>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `}
        </div>
    `;
}

// ========================
// ğŸšª STEP 9: CONFIG PORTONCINI FINSTRAL
// ========================
function renderStep9ConfigPortoncini(project) {
    if (!project.prodotti?.portoncini) {
        return `<div class="text-center py-8"><p class="text-gray-500">I portoncini non sono stati selezionati. Salta questo step.</p></div>`;
    }
    
    // Inizializza configPortoncini se non esiste
    if (!project.configPortoncini) {
        project.configPortoncini = {
            azienda: 'Finstral',
            // Telaio
            tipoTelaio: '',
            soglia: '',
            montante: '',
            traversa: '',
            // Anta
            modelloAnta: '',
            pannello: '',
            materialeInt: '',
            materialeEst: '',
            coloreInt: '',
            coloreEst: '',
            // Vetro
            tipoVetro: '',
            vetroOrnamentale: '',
            fermavetro: '',
            // Ferramenta
            codiceFerramenta: '',
            cerniere: '',
            cilindro: '',
            quantitaChiavi: 3,
            // Maniglie
            manigliaInt: '',
            manigliaEst: '',
            // Accessori
            motorApertura: false,
            telecomando: '',
            lettoreImpronte: '',
            chiudiporta: '',
            // Note
            note: ''
        };
        saveState();
    }
    
    const cfg = project.configPortoncini;
    
    return `
        <div>
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸšª</span> Configurazione Portoncini Finstral Default
            </h2>
            <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i portoncini (Listino FIN-Door):</p>
            
            <!-- âš™ï¸ TELAIO -->
            <div class="bg-teal-50 border-2 border-teal-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                    <span>ğŸ—ï¸</span> Telaio
                </h3>
                <div class="grid md:grid-cols-4 gap-3">
                    <!-- AZIENDA -->
                    <div>
                        <label class="block text-sm font-medium mb-1">1. Azienda</label>
                        <select class="w-full px-3 py-2 border rounded-lg bg-gray-100" disabled>
                            <option value="Finstral" selected>Finstral</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Al momento solo Finstral</p>
                    </div>
                    
                    <!-- TIPO TELAIO -->
                    <div>
                        <label class="block text-sm font-medium mb-1">2. Tipo Telaio</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'tipoTelaio', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="L" ${cfg.tipoTelaio === 'L' ? 'selected' : ''}>L - Standard</option>
                            <option value="Z" ${cfg.tipoTelaio === 'Z' ? 'selected' : ''}>Z - Ribassato</option>
                            <option value="T" ${cfg.tipoTelaio === 'T' ? 'selected' : ''}>T - Termico</option>
                        </select>
                    </div>
                    
                    <!-- SOGLIA -->
                    <div>
                        <label class="block text-sm font-medium mb-1">3. Soglia</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'soglia', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="standard" ${cfg.soglia === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="ribassata" ${cfg.soglia === 'ribassata' ? 'selected' : ''}>Ribassata</option>
                            <option value="filo-pavimento" ${cfg.soglia === 'filo-pavimento' ? 'selected' : ''}>Filo Pavimento</option>
                        </select>
                    </div>
                    
                    <!-- MONTANTE -->
                    <div>
                        <label class="block text-sm font-medium mb-1">4. Montante (mm)</label>
                        <input type="text" 
                               value="${cfg.montante || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'montante', this.value)"
                               placeholder="Es: 110"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- ğŸšª ANTA E PANNELLO -->
            <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                    <span>ğŸšª</span> Anta e Pannello
                </h3>
                <div class="grid md:grid-cols-3 gap-3">
                    <!-- MODELLO ANTA -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">5. Modello Anta</label>
                        ${renderPortoncinoModelButton(cfg.modelloAnta, 'PVC-PVC', 
                            `openPortoncinoModelPicker('${project.id}','','global','${cfg.modelloAnta || ''}','PVC-PVC')`)}
                    </div>
                    
                    <!-- PANNELLO -->
                    <div>
                        <label class="block text-sm font-medium mb-1">6. Pannello</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'pannello', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="liscio" ${cfg.pannello === 'liscio' ? 'selected' : ''}>Liscio</option>
                            <option value="bugna" ${cfg.pannello === 'bugna' ? 'selected' : ''}>Bugna</option>
                            <option value="design" ${cfg.pannello === 'design' ? 'selected' : ''}>Design</option>
                            <option value="personalizzato" ${cfg.pannello === 'personalizzato' ? 'selected' : ''}>Personalizzato</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ¨ MATERIALI E COLORI -->
            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                    <span>ğŸ¨</span> Materiali e Colori
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- INTERNO -->
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <h4 class="font-semibold text-yellow-900 mb-2">Interno</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium mb-1">7. Materiale Int</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'materialeInt', this.value)"
                                        class="w-full px-2 py-1 text-sm border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="pvc" ${cfg.materialeInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                    <option value="alluminio" ${cfg.materialeInt === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                    <option value="legno" ${cfg.materialeInt === 'legno' ? 'selected' : ''}>Legno</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">8. Colore Int</label>
                                <input type="text" 
                                       value="${cfg.coloreInt || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'coloreInt', this.value)"
                                       placeholder="Es: RAL9016"
                                       class="w-full px-2 py-1 text-sm border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ESTERNO -->
                    <div class="bg-yellow-100 p-3 rounded-lg">
                        <h4 class="font-semibold text-yellow-900 mb-2">Esterno</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium mb-1">9. Materiale Est</label>
                                <select onchange="updateConfigPortoncini('${project.id}', 'materialeEst', this.value)"
                                        class="w-full px-2 py-1 text-sm border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="pvc" ${cfg.materialeEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                    <option value="alluminio" ${cfg.materialeEst === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                    <option value="legno" ${cfg.materialeEst === 'legno' ? 'selected' : ''}>Legno</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">10. Colore Est</label>
                                <input type="text" 
                                       value="${cfg.coloreEst || ''}"
                                       onchange="updateConfigPortoncini('${project.id}', 'coloreEst', this.value)"
                                       placeholder="Es: RAL7016"
                                       class="w-full px-2 py-1 text-sm border rounded-lg">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸªŸ VETRO -->
            <div class="bg-cyan-50 border-2 border-cyan-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-cyan-800 mb-3 flex items-center gap-2">
                    <span>ğŸªŸ</span> Vetro
                </h3>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">11. Tipo Vetro</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'tipoVetro', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Nessuno/Seleziona...</option>
                            <option value="chiaro" ${cfg.tipoVetro === 'chiaro' ? 'selected' : ''}>Chiaro</option>
                            <option value="satinato" ${cfg.tipoVetro === 'satinato' ? 'selected' : ''}>Satinato</option>
                            <option value="ornamentale" ${cfg.tipoVetro === 'ornamentale' ? 'selected' : ''}>Ornamentale</option>
                            <option value="sicurezza" ${cfg.tipoVetro === 'sicurezza' ? 'selected' : ''}>Sicurezza</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">12. Vetro Ornamentale</label>
                        <input type="text" 
                               value="${cfg.vetroOrnamentale || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'vetroOrnamentale', this.value)"
                               placeholder="Es: Delta, ChinchillÃ "
                               class="w-full px-3 py-2 border rounded-lg"
                               ${cfg.tipoVetro !== 'ornamentale' ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">13. Fermavetro</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'fermavetro', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="interno" ${cfg.fermavetro === 'interno' ? 'selected' : ''}>Interno</option>
                            <option value="esterno" ${cfg.fermavetro === 'esterno' ? 'selected' : ''}>Esterno</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ”© FERRAMENTA -->
            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <span>ğŸ”©</span> Ferramenta
                </h3>
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">14. Codice Ferramenta</label>
                        <input type="text" 
                               value="${cfg.codiceFerramenta || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'codiceFerramenta', this.value)"
                               placeholder="Es: FD-3000"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">15. Cerniere</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'cerniere', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="standard" ${cfg.cerniere === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="3d" ${cfg.cerniere === '3d' ? 'selected' : ''}>3D Regolabili</option>
                            <option value="nascoste" ${cfg.cerniere === 'nascoste' ? 'selected' : ''}>Nascoste</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">16. Cilindro</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'cilindro', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Seleziona...</option>
                            <option value="standard" ${cfg.cilindro === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="europeo" ${cfg.cilindro === 'europeo' ? 'selected' : ''}>Europeo</option>
                            <option value="alta-sicurezza" ${cfg.cilindro === 'alta-sicurezza' ? 'selected' : ''}>Alta Sicurezza</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">17. QtÃ  Chiavi</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'quantitaChiavi', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="3" ${cfg.quantitaChiavi == '3' ? 'selected' : ''}>3</option>
                            <option value="4" ${cfg.quantitaChiavi == '4' ? 'selected' : ''}>4</option>
                            <option value="5" ${cfg.quantitaChiavi == '5' ? 'selected' : ''}>5</option>
                            <option value="6" ${cfg.quantitaChiavi == '6' ? 'selected' : ''}>6</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ–ï¸ MANIGLIE -->
            <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                    <span>ğŸ–ï¸</span> Maniglie
                </h3>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">18. Maniglia Interna</label>
                        <input type="text" 
                               value="${cfg.manigliaInt || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'manigliaInt', this.value)"
                               placeholder="Es: 7040 - Maniglione"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">19. Maniglia Esterna</label>
                        <input type="text" 
                               value="${cfg.manigliaEst || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'manigliaEst', this.value)"
                               placeholder="Es: Pomolo fisso / Maniglione"
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- âš¡ ACCESSORI -->
            <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                    <span>âš¡</span> Accessori
                </h3>
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">20. Motor Apertura</label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" 
                                   ${cfg.motorApertura ? 'checked' : ''}
                                   onchange="updateConfigPortoncini('${project.id}', 'motorApertura', this.checked)"
                                   class="w-5 h-5 rounded">
                            <span>Motorizzata</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">21. Telecomando</label>
                        <input type="text" 
                               value="${cfg.telecomando || ''}"
                               onchange="updateConfigPortoncini('${project.id}', 'telecomando', this.value)"
                               placeholder="Es: 2 telecomandi"
                               class="w-full px-3 py-2 border rounded-lg"
                               ${!cfg.motorApertura ? 'disabled' : ''}>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">22. Lettore Impronte</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'lettoreImpronte', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Nessuno</option>
                            <option value="base" ${cfg.lettoreImpronte === 'base' ? 'selected' : ''}>Base</option>
                            <option value="smart" ${cfg.lettoreImpronte === 'smart' ? 'selected' : ''}>Smart (con App)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">23. Chiudiporta</label>
                        <select onchange="updateConfigPortoncini('${project.id}', 'chiudiporta', this.value)"
                                class="w-full px-3 py-2 border rounded-lg">
                            <option value="">Nessuno</option>
                            <option value="standard" ${cfg.chiudiporta === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="incasso" ${cfg.chiudiporta === 'incasso' ? 'selected' : ''}>Ad incasso</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“ NOTE -->
            <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                    <span>ğŸ“</span> Note Generali
                </h3>
                <textarea 
                    onchange="updateConfigPortoncini('${project.id}', 'note', this.value)"
                    placeholder="Note aggiuntive per la configurazione portoncini..."
                    class="w-full px-3 py-2 border rounded-lg h-24">${cfg.note || ''}</textarea>
            </div>
            
            <!-- RIEPILOGO -->
            <div class="mt-4 p-4 bg-teal-100 border-2 border-teal-400 rounded-lg">
                <h3 class="font-semibold text-teal-900 mb-2">ğŸ“‹ Riepilogo Configurazione</h3>
                <div class="grid md:grid-cols-3 gap-2 text-sm">
                    <div><strong>Azienda:</strong> ${cfg.azienda || '-'}</div>
                    <div><strong>Telaio:</strong> ${cfg.tipoTelaio || '-'}</div>
                    <div><strong>Modello:</strong> ${cfg.modelloAnta || '-'}</div>
                    <div><strong>Materiale Int:</strong> ${cfg.materialeInt || '-'}</div>
                    <div><strong>Materiale Est:</strong> ${cfg.materialeEst || '-'}</div>
                    <div><strong>Vetro:</strong> ${cfg.tipoVetro || 'Nessuno'}</div>
                    <div><strong>Cilindro:</strong> ${cfg.cilindro || '-'}</div>
                    <div><strong>Motorizzata:</strong> ${cfg.motorApertura ? 'SÃ¬' : 'No'}</div>
                    <div><strong>Lettore Impronte:</strong> ${cfg.lettoreImpronte || 'No'}</div>
                </div>
            </div>
        </div>
    `;
}

// Funzione per aggiornare configPortoncini
window.updateConfigPortoncini = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (!project.configPortoncini) {
        project.configPortoncini = { azienda: 'Finstral' };
    }
    
    project.configPortoncini[field] = value;
    console.log(`ğŸšª configPortoncini.${field} = ${value}`);
    
    saveState();
    render();
};


function PositionDetail() {
    const project = state.projects.find(p => p.id === state.currentProject);
    const pos = project?.positions.find(p => p.id === state.currentPosition);
    if (!pos) return '';

    return `
        ${renderTopNavbar()}
        
        <div class="max-w-7xl mx-auto p-4">
            <!-- ğŸ†• v4.20: HEADER POSIZIONI A 2 RIGHE RESPONSIVE -->
            <div class="bg-white rounded-lg shadow mb-4">
                
                <!-- RIGA 1: Navigazione principale -->
                <div class="flex items-center justify-between p-3 border-b border-gray-200">
                    <div class="flex items-center gap-3 flex-1">
                        <input type="text" value="${pos.name}"
                               onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                               class="text-lg font-bold border-b-2 border-transparent focus:border-purple-500 outline-none max-w-xs"
                               placeholder="Nome posizione">
                        <button onclick="state.screen = 'project-detail'; state.setupStep = 1; render();"
                                class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700 transition flex items-center gap-1"
                                title="Torna alle configurazioni">
                            ğŸ”§ Setup
                        </button>
                    </div>
                </div>
                
                <!-- RIGA 2: Dropdown posizione + azioni -->
                <div class="p-3">
                    <div class="flex flex-wrap items-center gap-2">
                        
                        <!-- DROPDOWN POSIZIONI AVANZATO -->
                        <select onchange="switchPosition(this.value)"
                                class="flex-1 min-w-[200px] px-4 py-2 border-2 border-purple-300 rounded-lg text-base font-medium bg-white hover:border-purple-500 focus:border-purple-600 focus:ring-2 focus:ring-purple-200 transition-all"
                                style="font-size: 16px;">
                            ${project.positions.map(p => {
                                // Calcola completamento posizione
                                const completion = (() => {
                                    let total = 0, completed = 0;
                                    if (p.name) { total += 20; completed += 20; }
                                    if (p.ambiente) { total += 20; completed += 20; }
                                    
                                    const prodottiAbilitati = Object.keys(project.prodotti || {}).filter(k => project.prodotti[k]);
                                    if (prodottiAbilitati.length > 0) {
                                        total += 30;
                                        const prodottiPresenti = prodottiAbilitati.filter(prod => {
                                            const hasProdotto = p[prod] && Object.keys(p[prod]).length > 0;
                                            const isAssente = p.prodottiAssenti?.includes(prod);
                                            return hasProdotto || isAssente;
                                        }).length;
                                        completed += Math.round((prodottiPresenti / prodottiAbilitati.length) * 30);
                                    }
                                    
                                    if (p.misure && (p.misure.LF || p.misure.HF)) {
                                        total += 30;
                                        const campiMisure = ['LF', 'HF', 'LP', 'HP', 'LPF', 'HPF'];
                                        const misureCompilate = campiMisure.filter(k => p.misure[k] && p.misure[k] !== '').length;
                                        completed += Math.round((misureCompilate / campiMisure.length) * 30);
                                    }
                                    
                                    return total > 0 ? Math.round((completed / total) * 100) : 0;
                                })();
                                
                                // Icona stato basata su completamento
                                const icon = completion === 100 ? 'âœ…' : 
                                             completion >= 50 ? 'âš ï¸' : 
                                             completion > 0 ? 'âŒ' : 'â­•';
                                
                                // Indicatore posizione corrente
                                const current = p.id === pos.id ? 'â–¶ï¸ ' : '';
                                
                                // Testo con ambiente se presente
                                const displayText = p.ambiente 
                                    ? `${p.name} - ${p.ambiente}` 
                                    : p.name;
                                
                                return `
                                    <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>
                                        ${current}${icon} ${displayText} (${completion}%)
                                    </option>
                                `;
                            }).join('')}
                        </select>
                        
                        <!-- PULSANTE CONFIG (solo se tab attivo ha config) -->
                        ${(() => {
                            const tab = pos.activeTab || 'misure';
                            const configMap = {
                                'infissi': { step: 3, label: 'âš™ï¸ Config Infissi', btnClass: 'bg-purple-600 hover:bg-purple-700' },
                                'persiane': { step: 4, label: 'âš™ï¸ Config Persiane', btnClass: 'bg-blue-600 hover:bg-blue-700' },
                                'tapparelle': { step: 5, label: 'âš™ï¸ Config Tapparelle', btnClass: 'bg-indigo-600 hover:bg-indigo-700' },
                                'zanzariere': { step: 6, label: 'âš™ï¸ Config Zanzariere', btnClass: 'bg-green-600 hover:bg-green-700' },
                                'cassonetti': { step: 7, label: 'âš™ï¸ Config Cassonetti', btnClass: 'bg-orange-600 hover:bg-orange-700' },
                                'grate': { step: 7.5, label: 'âš™ï¸ Config Grate', btnClass: 'bg-red-600 hover:bg-red-700' }
                            };
                            const config = configMap[tab];
                            if (config && project.prodotti?.[tab]) {
                                return `
                                    <button onclick="state.screen = 'project-detail'; state.setupStep = ${config.step}; render();"
                                            class="px-3 py-2 ${config.btnClass} text-white rounded-lg font-medium text-sm transition whitespace-nowrap">
                                        ${config.label}
                                    </button>
                                `;
                            }
                            return '';
                        })()}
                        
                        <!-- AZIONI POSIZIONE -->
                        <div class="flex gap-2">
                            <button onclick="addPosition('${project.id}')"
                                    class="px-3 py-2 bg-green-600 text-white rounded-lg font-medium text-sm hover:bg-green-700 transition whitespace-nowrap">
                                + Nuova
                            </button>
                            ${project.positions.length > 1 ? `
                            <button onclick="deletePosition('${project.id}', '${pos.id}')"
                                    class="px-3 py-2 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700 transition">
                                ğŸ—‘ï¸
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div class="section-card">
                    <label class="text-xs font-medium">Piano</label>
                    <input type="text" value="${pos.piano || ''}"
                           onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                           placeholder="${project.clientData?.piano || 'Piano'}"
                           class="w-full compact-input border rounded mt-1">
                </div>
                <div class="section-card">
                    <label class="text-xs font-medium">
                        Ambiente <span class="text-red-600 font-bold">*</span>
                    </label>
                    <div class="flex items-center gap-2 mt-1">
                        <!-- DROPDOWN -->
                        <select id="ambiente-select-${pos.id}"
                                onchange="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                                class="flex-1 compact-input border rounded ${!pos.ambiente ? 'border-red-500 bg-red-50' : ''}"
                                style="display: ${(pos.ambienteMode || 'select') === 'select' ? 'block' : 'none'};">
                            <option value="">âš ï¸ Seleziona ambiente...</option>
                            ${(window.OPZIONI?.AMBIENTI || ['Sala','Soggiorno','Cucina','Camera','Bagno','Studio']).map(amb => `
                                <option value="${amb}" ${pos.ambiente === amb ? 'selected' : ''}>${amb}</option>
                            `).join('')}
                        </select>
                        
                        <!-- FREE TEXT INPUT -->
                        <input type="text" 
                               id="ambiente-input-${pos.id}"
                               value="${pos.ambiente || ''}"
                               oninput="updatePosition('${project.id}', '${pos.id}', 'ambiente', this.value)"
                               placeholder="Scrivi ambiente..."
                               class="flex-1 compact-input border rounded ${!pos.ambiente ? 'border-red-500 bg-red-50' : ''}"
                               style="display: ${(pos.ambienteMode || 'select') === 'input' ? 'block' : 'none'};">
                        
                        <!-- BOTTONE TOGGLE -->
                        <button type="button"
                                id="ambiente-toggle-${pos.id}"
                                onclick="toggleAmbienteMode('${project.id}', '${pos.id}')"
                                title="${(pos.ambienteMode || 'select') === 'select' ? 'Passa a scrittura libera' : 'Torna alla tendina'}"
                                class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 whitespace-nowrap">
                            ${(pos.ambienteMode || 'select') === 'select' ? 'âœï¸ Scrivi' : 'ğŸ“‹ Tendina'}
                        </button>
                    </div>
                    ${!pos.ambiente ? `
                        <p class="text-xs text-red-600 mt-1">âš ï¸ Campo obbligatorio</p>
                    ` : ''}
                </div>
                <!-- ğŸ†• v5.82: RIMOSSO input pos.quantita - usa solo prodotto.qta -->
            </div>
            
            <!-- ğŸšª v5.09: TIPO POSIZIONE (Finestra o Ingresso) -->
            <div class="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg">
                <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ  Tipo Posizione</label>
                <div class="flex gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipopos-${pos.id}" value="finestra"
                               ${(pos.tipoposizione || 'finestra') === 'finestra' ? 'checked' : ''}
                               onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'finestra')"
                               class="sr-only">
                        <div class="p-3 rounded-lg border-2 transition-all ${(pos.tipoposizione || 'finestra') === 'finestra' 
                            ? 'border-blue-500 bg-blue-100 shadow-md' 
                            : 'border-gray-300 bg-white hover:border-blue-300'}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸªŸ</span>
                                <div>
                                    <div class="font-semibold ${(pos.tipoposizione || 'finestra') === 'finestra' ? 'text-blue-700' : 'text-gray-700'}">Finestra</div>
                                    <div class="text-xs text-gray-500">Infissi, persiane, tapparelle...</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipopos-${pos.id}" value="ingresso"
                               ${pos.tipoposizione === 'ingresso' ? 'checked' : ''}
                               onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'ingresso')"
                               class="sr-only">
                        <div class="p-3 rounded-lg border-2 transition-all ${pos.tipoposizione === 'ingresso' 
                            ? 'border-teal-500 bg-teal-100 shadow-md' 
                            : 'border-gray-300 bg-white hover:border-teal-300'}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸšª</span>
                                <div>
                                    <div class="font-semibold ${pos.tipoposizione === 'ingresso' ? 'text-teal-700' : 'text-gray-700'}">Ingresso</div>
                                    <div class="text-xs text-gray-500">Portoncino o Blindata</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    ${project.prodotti?.porteInterne ? `
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipopos-${pos.id}" value="porta_interna"
                               ${pos.tipoposizione === 'porta_interna' ? 'checked' : ''}
                               onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'porta_interna')"
                               class="sr-only">
                        <div class="p-3 rounded-lg border-2 transition-all ${pos.tipoposizione === 'porta_interna' 
                            ? 'border-rose-500 bg-rose-100 shadow-md' 
                            : 'border-gray-300 bg-white hover:border-rose-300'}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸšª</span>
                                <div>
                                    <div class="font-semibold ${pos.tipoposizione === 'porta_interna' ? 'text-rose-700' : 'text-gray-700'}">Porta Interna</div>
                                    <div class="text-xs text-gray-500">FerreroLegno, Flessya</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    ` : ''}
                    ${project.prodotti?.tendeBracci ? `
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipopos-${pos.id}" value="tenda_bracci"
                               ${pos.tipoposizione === 'tenda_bracci' ? 'checked' : ''}
                               onchange="updateTipoPosizione('${project.id}', '${pos.id}', 'tenda_bracci')"
                               class="sr-only">
                        <div class="p-3 rounded-lg border-2 transition-all ${pos.tipoposizione === 'tenda_bracci' 
                            ? 'border-amber-500 bg-amber-100 shadow-md' 
                            : 'border-gray-300 bg-white hover:border-amber-300'}">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">â˜€ï¸</span>
                                <div>
                                    <div class="font-semibold ${pos.tipoposizione === 'tenda_bracci' ? 'text-amber-700' : 'text-gray-700'}">Tenda a Bracci</div>
                                    <div class="text-xs text-gray-500">GIBUS TXT, SEGNO...</div>
                                </div>
                            </div>
                        </div>
                    </label>
                    ` : ''}
                </div>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4 mb-4">
                <div class="section-card">
                    <label class="text-xs font-medium">Foto</label>
                    <div class="flex items-center gap-2 mt-1">
                        <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                               onchange="addFoto('${project.id}', '${pos.id}', this)">
                        <button onclick="document.getElementById('foto-${pos.id}').click()"
                                class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                            ğŸ“· Carica
                        </button>
                        <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow">
                <div class="flex border-b overflow-x-auto">
                    <!-- TAB DINAMICI in base a tipoposizione -->
                    ${(pos.tipoposizione || 'finestra') === 'finestra' ? `
                        <!-- TIPO FINESTRA: mostra tutti i prodotti standard -->
                        <button onclick="setPositionTab('${pos.id}', 'misure')"
                                class="tab-btn ${(pos.activeTab || 'misure') === 'misure' ? 'active' : ''}">
                            ğŸ“ Misure
                        </button>
                        ${project.prodotti?.infissi ? `
                            <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                    class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                ğŸªŸ Infissi
                            </button>
                        ` : ''}
                        ${project.prodotti?.persiane ? `
                            <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                    class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                ğŸšª Persiane
                            </button>
                        ` : ''}
                        ${project.prodotti?.tapparelle ? (() => {
                            // v5.38: Tab label dinamica - "Motore" se serveTapparella=false + serveMotore=true
                            const serveTap = project.configTapparelle?.serveTapparella !== false;
                            const serveMot = project.configTapparelle?.serveMotore === true;
                            const tabLabel = !serveTap && serveMot ? 'âš¡ Motore' : 'ğŸšï¸ Tapparelle';
                            return `
                            <button onclick="setPositionTab('${pos.id}', 'tapparelle')"
                                    class="tab-btn ${pos.activeTab === 'tapparelle' ? 'active' : ''}">
                                ${tabLabel}
                            </button>
                        `;})() : ''}
                        ${project.prodotti?.zanzariere ? `
                            <button onclick="setPositionTab('${pos.id}', 'zanzariere')"
                                    class="tab-btn ${pos.activeTab === 'zanzariere' ? 'active' : ''}">
                                ğŸ¦Ÿ Zanzariere
                            </button>
                        ` : ''}
                        ${project.prodotti?.cassonetti ? `
                            <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                    class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                ğŸ“¦ Cassonetti
                            </button>
                        ` : ''}
                        ${project.prodotti?.grate ? `
                            <button onclick="setPositionTab('${pos.id}', 'grate')"
                                    class="tab-btn ${pos.activeTab === 'grate' ? 'active' : ''}">
                                ğŸ”’ Grate
                            </button>
                        ` : ''}
                        ${project.prodotti?.clickZip ? `
                            <button onclick="setPositionTab('${pos.id}', 'clickzip')"
                                    class="tab-btn ${pos.activeTab === 'clickzip' ? 'active' : ''}">
                                ğŸªŸ Click Zip
                            </button>
                        ` : ''}
                    ` : pos.tipoposizione === 'porta_interna' ? `
                        <!-- TIPO PORTA INTERNA: mostra tab dedicato -->
                        <button onclick="setPositionTab('${pos.id}', 'porta_interna')"
                                class="tab-btn ${(pos.activeTab || 'porta_interna') === 'porta_interna' ? 'active' : ''}">
                            ğŸšª Porta Interna
                        </button>
                    ` : pos.tipoposizione === 'tenda_bracci' ? `
                        <!-- â˜€ï¸ TIPO TENDA A BRACCI: mostra tab dedicato -->
                        <button onclick="setPositionTab('${pos.id}', 'tenda_bracci')"
                                class="tab-btn ${(pos.activeTab || 'tenda_bracci') === 'tenda_bracci' ? 'active' : ''}">
                            â˜€ï¸ Tenda a Bracci
                        </button>
                    ` : `
                        <!-- TIPO INGRESSO: mostra solo tab ingresso -->
                        <button onclick="setPositionTab('${pos.id}', 'ingresso')"
                                class="tab-btn ${(pos.activeTab || 'ingresso') === 'ingresso' ? 'active' : ''}">
                            ğŸšª Ingresso
                        </button>
                    `}
                    <button onclick="setPositionTab('${pos.id}', 'foto')"
                            class="tab-btn ${pos.activeTab === 'foto' ? 'active' : ''}">
                        ğŸ“¸ Foto (${pos.foto?.length || 0})
                    </button>
                </div>

                <div class="p-4">
                    ${renderPositionTabContent(project, pos)}
                </div>
            </div>
        </div>
    `;
}

function renderPositionTabContent(project, pos) {
    // ğŸšª v5.09: Se tipo ingresso, forza tab ingresso come default
    // ğŸšª v5.57: Se tipo porta_interna, forza tab porta_interna come default
    // â˜€ï¸ v5.64: Se tipo tenda_bracci, forza tab tenda_bracci come default
    let tab = pos.activeTab || 'misure';
    if (pos.tipoposizione === 'ingresso' && tab !== 'foto' && tab !== 'ingresso') {
        tab = 'ingresso';
    }
    if (pos.tipoposizione === 'porta_interna' && tab !== 'foto' && tab !== 'porta_interna') {
        tab = 'porta_interna';
    }
    if (pos.tipoposizione === 'tenda_bracci' && tab !== 'foto' && tab !== 'tenda_bracci') {
        tab = 'tenda_bracci';
    }

    if (tab === 'misure') return renderMisureTab(project, pos);
    if (tab === 'infissi') return renderInfissiTab(project, pos);
    if (tab === 'persiane') return renderPersianeTab(project, pos);
    if (tab === 'tapparelle') return renderTapparelleTab(project, pos);
    if (tab === 'zanzariere') return renderZanzariereTab(project, pos);
    if (tab === 'cassonetti') return renderCassonettiTab(project, pos);
    if (tab === 'grate') return typeof GRATE_MODULE !== 'undefined' ? GRATE_MODULE.renderTab(project, pos) : '<p class="p-4 text-red-600">âš ï¸ Modulo grate non caricato (erreci-grate.js)</p>';  // ğŸ”’ v5.85
    if (tab === 'clickzip') return renderClickZipTab(project, pos);  // ğŸªŸ v5.64
    if (tab === 'ingresso') return renderIngressoTab(project, pos);  // ğŸšª v5.09
    if (tab === 'porta_interna') return renderPortaInternaTab(project, pos);  // ğŸšª v5.57
    if (tab === 'tenda_bracci') return renderTendaBracciTab(project, pos);  // â˜€ï¸ v5.64
    if (tab === 'foto') return renderFotoTab(project, pos);

    return '';
}

// ğŸšª v5.09: Funzione per aggiornare tipo posizione
// â˜€ï¸ v5.64: Aggiunto tenda_bracci
window.updateTipoPosizione = function(projectId, positionId, tipo) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos) return;
    
    pos.tipoposizione = tipo;
    
    // Reset tab attivo in base al nuovo tipo
    if (tipo === 'ingresso') {
        pos.activeTab = 'ingresso';
    } else if (tipo === 'porta_interna') {
        pos.activeTab = 'porta_interna';
    } else if (tipo === 'tenda_bracci') {
        pos.activeTab = 'tenda_bracci';
    } else {
        pos.activeTab = 'misure';
    }
    
    console.log(`ğŸ  Tipo posizione cambiato: ${tipo}`);
    saveState();
    render();
};

// ğŸšª v5.09: Tab INGRESSO (Portoncino o Blindata)
function renderIngressoTab(project, pos) {
    const ing = pos.ingresso || {};
    
    return `
        <div class="space-y-4">
            <!-- SCELTA TIPO INGRESSO -->
            <div class="bg-gradient-to-r from-teal-50 to-red-50 border-2 border-gray-300 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-3">ğŸšª Scegli il tipo di porta d'ingresso</h3>
                <div class="flex gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipoingresso-${pos.id}" value="portoncino"
                               ${ing.tipo === 'portoncino' ? 'checked' : ''}
                               onchange="updateIngresso('${project.id}', '${pos.id}', 'tipo', 'portoncino')"
                               class="sr-only">
                        <div class="p-4 rounded-lg border-2 transition-all text-center ${ing.tipo === 'portoncino' 
                            ? 'border-teal-500 bg-teal-100 shadow-lg' 
                            : 'border-gray-300 bg-white hover:border-teal-300'}">
                            <span class="text-3xl block mb-2">ğŸšª</span>
                            <div class="font-bold ${ing.tipo === 'portoncino' ? 'text-teal-700' : 'text-gray-700'}">Portoncino</div>
                            <div class="text-xs text-gray-500">Finstral FIN-Door</div>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="tipoingresso-${pos.id}" value="blindata"
                               ${ing.tipo === 'blindata' ? 'checked' : ''}
                               onchange="updateIngresso('${project.id}', '${pos.id}', 'tipo', 'blindata')"
                               class="sr-only">
                        <div class="p-4 rounded-lg border-2 transition-all text-center ${ing.tipo === 'blindata' 
                            ? 'border-red-500 bg-red-100 shadow-lg' 
                            : 'border-gray-300 bg-white hover:border-red-300'}">
                            <span class="text-3xl block mb-2">ğŸ”</span>
                            <div class="font-bold ${ing.tipo === 'blindata' ? 'text-red-700' : 'text-gray-700'}">Blindata</div>
                            <div class="text-xs text-gray-500">Oikos</div>
                        </div>
                    </label>
                </div>
            </div>
            
            ${!ing.tipo ? `
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-yellow-700 font-medium">âš ï¸ Seleziona il tipo di porta per continuare la configurazione</p>
                </div>
            ` : ing.tipo === 'portoncino' ? renderPortoncinoConfig(project, pos, ing) : renderBlindataConfig(project, pos, ing)}
        </div>
    `;
}

// ğŸšª Configurazione PORTONCINO Finstral FIN-Door v5.25

// v5.25: Helper per info tipo apertura
// getTipoAperturaInfo() â†’ CENTRALIZZATO in findoor-portoncini.js (window.getTipoAperturaInfo)

// ğŸšª v5.60: Tab PORTA INTERNA - Eredita default dal progetto
function renderPortaInternaTab(project, pos) {
    const pi = pos.portaInterna || {};
    const defaults = project.configPorteInterne || {};
    
    // Valori effettivi: posizione sovrascrive default progetto
    const azienda = pi.azienda || defaults.azienda || '';
    const collezione = pi.collezione || defaults.collezione || '';
    const finitura = pi.finitura || defaults.finitura || '';
    const telaio = pi.telaio || defaults.telaio || '';
    const spessoreMuro = pi.spessoreMuro || defaults.spessoreMuro || '';
    const manigliaAzienda = pi.manigliaAzienda || defaults.manigliaAzienda || '';
    const manigliaModello = pi.manigliaModello || defaults.manigliaModello || '';
    const manigliaFinitura = pi.manigliaFinitura || defaults.manigliaFinitura || '';
    
    // Indicatori se ereditato
    const isInheritedAzienda = !pi.azienda && defaults.azienda;
    const isInheritedCollezione = !pi.collezione && defaults.collezione;
    const isInheritedFinitura = !pi.finitura && defaults.finitura;
    const isInheritedTelaio = !pi.telaio && defaults.telaio;
    const isInheritedSpessore = !pi.spessoreMuro && defaults.spessoreMuro;
    const isInheritedManiglia = !pi.manigliaAzienda && defaults.manigliaAzienda;
    
    return `
        <div class="space-y-4">
            ${defaults.azienda ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-sm text-blue-700">
                ğŸ’¡ Default dal progetto: <strong>${defaults.azienda}</strong> ${defaults.collezione ? 'â†’ ' + defaults.collezione : ''} ${defaults.finitura ? 'â†’ ' + defaults.finitura : ''}
                <span class="text-xs">(puoi modificare qui sotto)</span>
            </div>
            ` : ''}
            
            <!-- SCELTA AZIENDA -->
            <div class="bg-gradient-to-r from-rose-50 to-amber-50 border-2 border-rose-200 rounded-lg p-4">
                <h3 class="font-bold text-gray-800 mb-3">ğŸšª Produttore ${isInheritedAzienda ? '<span class="text-xs font-normal text-blue-600">(da default)</span>' : ''}</h3>
                <div class="flex gap-4">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="aziendaPI-${pos.id}" value="FERREROLEGNO"
                               ${azienda === 'FERREROLEGNO' ? 'checked' : ''}
                               onchange="updatePortaInterna('${project.id}', '${pos.id}', 'azienda', 'FERREROLEGNO')"
                               class="sr-only">
                        <div class="p-4 rounded-lg border-2 transition-all text-center ${azienda === 'FERREROLEGNO' 
                            ? 'border-rose-500 bg-rose-100 shadow-lg' 
                            : 'border-gray-300 bg-white hover:border-rose-300'}">
                            <span class="text-3xl block mb-2">ğŸšª</span>
                            <div class="font-bold ${azienda === 'FERREROLEGNO' ? 'text-rose-700' : 'text-gray-700'}">FerreroLegno</div>
                            <div class="text-xs text-gray-500">Sconto 50%</div>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="aziendaPI-${pos.id}" value="FLESSYA"
                               ${azienda === 'FLESSYA' ? 'checked' : ''}
                               onchange="updatePortaInterna('${project.id}', '${pos.id}', 'azienda', 'FLESSYA')"
                               class="sr-only">
                        <div class="p-4 rounded-lg border-2 transition-all text-center ${azienda === 'FLESSYA' 
                            ? 'border-amber-500 bg-amber-100 shadow-lg' 
                            : 'border-gray-300 bg-white hover:border-amber-300'}">
                            <span class="text-3xl block mb-2">ğŸšª</span>
                            <div class="font-bold ${azienda === 'FLESSYA' ? 'text-amber-700' : 'text-gray-700'}">Flessya</div>
                            <div class="text-xs text-gray-500">Sconto 53%</div>
                        </div>
                    </label>
                </div>
            </div>
            
            ${!azienda ? `
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-yellow-700 font-medium">âš ï¸ Seleziona il produttore per continuare</p>
                </div>
            ` : renderPortaInternaConfig(project, pos, pi, {azienda, collezione, finitura, telaio, spessoreMuro, manigliaAzienda, manigliaModello, manigliaFinitura, isInheritedCollezione, isInheritedFinitura, isInheritedTelaio, isInheritedSpessore, isInheritedManiglia})}
        </div>
    `;
}

// ğŸšª v5.59: DATABASE COLLEZIONI E FINITURE PORTE INTERNE
// ğŸšª v5.61: DATABASE PORTE ORGANIZZATO PER LINEA (spostato all'inizio del file)

// Funzione per aggiornare dropdown finitura
window.updateFinituraDropdown = function(projectId, positionId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.portaInterna) return;
    
    const azienda = pos.portaInterna.azienda;
    const collezione = pos.portaInterna.collezione;
    const finiture = getFiniturePora(azienda, collezione);
    const select = document.getElementById('finitura-' + positionId);
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Seleziona finitura --</option>' +
        finiture.map(f => '<option value="' + f + '"' + (pos.portaInterna.finitura === f ? ' selected' : '') + '>' + f + '</option>').join('');
};

// ğŸšª v5.57: Configurazione porta interna (FUORI da updatePortaInterna per scope corretto)
function renderPortaInternaConfig(project, pos, pi, eff) {
    // eff contiene i valori effettivi (posizione o ereditati da default)
    return `
        <!-- QUANTITÃ€ E MISURE -->
        <div class="grid grid-cols-3 gap-4">
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">QuantitÃ </label>
                <input type="number" min="1" value="${pi.quantita || 1}"
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'quantita', this.value)"
                       class="w-full p-2 border rounded text-center text-lg font-bold">
            </div>
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">Larghezza Vano (mm)</label>
                <input type="number" min="500" max="1200" step="10" value="${pi.larghezzaVano || ''}"
                       placeholder="es. 900"
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'larghezzaVano', this.value)"
                       class="w-full p-2 border rounded">
            </div>
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">Altezza Vano (mm)</label>
                <input type="number" min="1800" max="2400" step="10" value="${pi.altezzaVano || ''}"
                       placeholder="es. 2100"
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'altezzaVano', this.value)"
                       class="w-full p-2 border rounded">
            </div>
        </div>
        
        <!-- APERTURA E TIPOLOGIA -->
        <div class="grid grid-cols-2 gap-4">
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">Apertura</label>
                <select onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'apertura', this.value)"
                        class="w-full p-2 border rounded">
                    <option value="">-- Seleziona --</option>
                    <option value="DX" ${pi.apertura === 'DX' ? 'selected' : ''}>ğŸ”„ Destra (DX)</option>
                    <option value="SX" ${pi.apertura === 'SX' ? 'selected' : ''}>ğŸ”„ Sinistra (SX)</option>
                    <option value="SCORREVOLE_INT" ${pi.apertura === 'SCORREVOLE_INT' ? 'selected' : ''}>â¡ï¸ Scorrevole Interno</option>
                    <option value="SCORREVOLE_EST" ${pi.apertura === 'SCORREVOLE_EST' ? 'selected' : ''}>â¬…ï¸ Scorrevole Esterno</option>
                    <option value="LIBRO" ${pi.apertura === 'LIBRO' ? 'selected' : ''}>ğŸ“– A Libro</option>
                </select>
            </div>
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">Tipologia Anta</label>
                <select onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'tipologia', this.value)"
                        class="w-full p-2 border rounded">
                    <option value="">-- Seleziona --</option>
                    <option value="cieca" ${pi.tipologia === 'cieca' ? 'selected' : ''}>ğŸšª Cieca</option>
                    <option value="vetro" ${pi.tipologia === 'vetro' ? 'selected' : ''}>ğŸ”² Con Vetro</option>
                    <option value="vetro_large" ${pi.tipologia === 'vetro_large' ? 'selected' : ''}>ğŸ”³ Vetro Grande</option>
                </select>
            </div>
        </div>
        
        <!-- COLLEZIONE E FINITURA (v5.60 - eredita default) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">
                    Collezione ${eff.isInheritedCollezione ? '<span class="text-blue-500 text-xs">(default)</span>' : ''}
                </label>
                <select id="collezione-${pos.id}"
                        onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'collezione', this.value)"
                        class="w-full p-2 border rounded ${eff.isInheritedCollezione ? 'bg-blue-50' : ''}">
                    <option value="">-- Seleziona collezione --</option>
                    ${eff.azienda ? getCollezioniPorta(eff.azienda).map(c => 
                        '<option value="' + c + '"' + (eff.collezione === c ? ' selected' : '') + '>' + c + '</option>'
                    ).join('') : ''}
                </select>
                <a href="https://openporte2025.github.io/catalogo-porte-v1_01.html" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 mt-1 inline-block">ğŸ“‹ Apri catalogo porte â†’</a>
            </div>
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">
                    Finitura ${eff.isInheritedFinitura ? '<span class="text-blue-500 text-xs">(default)</span>' : ''}
                </label>
                <select id="finitura-${pos.id}"
                        onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'finitura', this.value)"
                        class="w-full p-2 border rounded ${eff.isInheritedFinitura ? 'bg-blue-50' : ''}">
                    <option value="">-- Seleziona finitura --</option>
                    ${eff.azienda && eff.collezione ? getFiniturePora(eff.azienda, eff.collezione).map(f => 
                        '<option value="' + f + '"' + (eff.finitura === f ? ' selected' : '') + '>' + f + '</option>'
                    ).join('') : ''}
                </select>
            </div>
        </div>
        
        <!-- TELAIO + SPESSORE MURO -->
        <div class="grid grid-cols-2 gap-4">
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">
                    Telaio ${eff.isInheritedTelaio ? '<span class="text-blue-500 text-xs">(default)</span>' : ''}
                </label>
                <input type="text" value="${eff.telaio}"
                       placeholder="es. GENIUS ELEVA, FLAT, A FILO..."
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'telaio', this.value)"
                       class="w-full p-2 border rounded ${eff.isInheritedTelaio ? 'bg-blue-50' : ''}">
            </div>
            <div class="section-card">
                <label class="text-xs font-medium text-gray-600">
                    ğŸ“ Spessore Muro (mm) ${eff.isInheritedSpessore ? '<span class="text-blue-500 text-xs">(default)</span>' : ''}
                </label>
                <input type="number" value="${eff.spessoreMuro}"
                       placeholder="es. 100, 120, 150..."
                       min="50" max="400" step="10"
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'spessoreMuro', this.value)"
                       class="w-full p-2 border rounded ${eff.isInheritedSpessore ? 'bg-blue-50' : ''}">
            </div>
        </div>
        
        <!-- BATTISCOPA -->
        <div class="section-card">
            <div class="flex items-center gap-3 mb-3">
                <input type="checkbox" id="battiscopa-${pos.id}" 
                       ${pi.battiscopa ? 'checked' : ''}
                       onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'battiscopa', this.checked)"
                       class="w-5 h-5 rounded">
                <label for="battiscopa-${pos.id}" class="font-bold text-gray-700">ğŸªµ Battiscopa</label>
            </div>
            ${pi.battiscopa ? `
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <p class="text-xs text-gray-600 mb-3">Inserisci misure pareti (cm) - il totale sarÃ  calcolato in metri</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        ${(() => {
                            const pareti = pi.paretiCm || [0, 0, 0, 0];
                            return pareti.map((val, idx) => `
                                <div>
                                    <label class="text-xs text-gray-500">Parete ${idx + 1}</label>
                                    <div class="flex items-center gap-1">
                                        <input type="number" value="${val || ''}"
                                               placeholder="0"
                                               min="0" max="2000" step="1"
                                               onchange="updatePareteBattiscopa('${pos.projectId || project.id}', '${pos.id}', ${idx}, this.value)"
                                               class="w-full p-2 border rounded text-center">
                                        <span class="text-xs text-gray-400">cm</span>
                                    </div>
                                </div>
                            `).join('');
                        })()}
                    </div>
                    <div class="flex items-center justify-between">
                        <button onclick="aggiungiPareteBattiscopa('${pos.projectId || project.id}', '${pos.id}')"
                                class="text-xs text-blue-600 hover:text-blue-800">+ Aggiungi parete</button>
                        <div class="text-right">
                            <span class="text-xs text-gray-500">TOTALE:</span>
                            <span class="font-bold text-lg text-amber-700 ml-2">
                                ${(() => {
                                    const pareti = pi.paretiCm || [0, 0, 0, 0];
                                    const totCm = pareti.reduce((sum, v) => sum + (parseInt(v) || 0), 0);
                                    return (totCm / 100).toFixed(2);
                                })()} mt
                            </span>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
        
        <!-- MANIGLIA -->
        <div class="bg-gray-50 border rounded-lg p-4">
            <h4 class="font-bold text-gray-700 mb-3">
                ğŸ”§ Maniglia ${eff.isInheritedManiglia ? '<span class="text-blue-500 text-xs font-normal">(default)</span>' : ''}
            </h4>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="text-xs font-medium text-gray-600">Azienda</label>
                    <select onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'manigliaAzienda', this.value)"
                            class="w-full p-2 border rounded ${eff.isInheritedManiglia ? 'bg-blue-50' : ''}">
                        <option value="">-- Seleziona --</option>
                        <option value="OLIVARI" ${eff.manigliaAzienda === 'OLIVARI' ? 'selected' : ''}>OLIVARI (43%)</option>
                        <option value="COLOMBO" ${eff.manigliaAzienda === 'COLOMBO' ? 'selected' : ''}>COLOMBO DESIGN (40%)</option>
                        <option value="INCLUSA" ${eff.manigliaAzienda === 'INCLUSA' ? 'selected' : ''}>Inclusa nella porta</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-600">Modello</label>
                    <input type="text" value="${eff.manigliaModello}"
                           placeholder="es. AGATA, PLANET..."
                           onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'manigliaModello', this.value)"
                           class="w-full p-2 border rounded ${eff.isInheritedManiglia ? 'bg-blue-50' : ''}">
                </div>
                <div>
                    <label class="text-xs font-medium text-gray-600">Finitura</label>
                    <input type="text" value="${eff.manigliaFinitura}"
                           placeholder="es. Cromo, Satinato..."
                           onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'manigliaFinitura', this.value)"
                           class="w-full p-2 border rounded ${eff.isInheritedManiglia ? 'bg-blue-50' : ''}">
                </div>
            </div>
            <a href="https://openporte2025.github.io/catalogo-maniglie-v2.html" target="_blank" class="text-xs text-blue-500 hover:text-blue-700 mt-2 inline-block">ğŸ“‹ Apri catalogo maniglie â†’</a>
        </div>
        
        <!-- NOTE -->
        <div class="section-card">
            <label class="text-xs font-medium text-gray-600">Note</label>
            <textarea rows="2" 
                      placeholder="Note aggiuntive..."
                      onchange="updatePortaInterna('${pos.projectId || project.id}', '${pos.id}', 'note', this.value)"
                      class="w-full p-2 border rounded">${pi.note || ''}</textarea>
        </div>
    `;
}

// ğŸšª v5.57: Funzione aggiornamento porta interna
window.updatePortaInterna = function(projectId, positionId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos) return;
    
    if (!pos.portaInterna) pos.portaInterna = {};
    pos.portaInterna[field] = value;
    
    // ğŸšª v5.59: Cascata - se cambia azienda, resetta collezione e finitura
    if (field === 'azienda') {
        pos.portaInterna.collezione = '';
        pos.portaInterna.finitura = '';
        console.log('ğŸšª Cambiata azienda â†’ reset collezione e finitura');
    }
    
    // ğŸšª v5.59: Cascata - se cambia collezione, resetta finitura
    if (field === 'collezione') {
        pos.portaInterna.finitura = '';
        console.log('ğŸšª Cambiata collezione â†’ reset finitura');
    }
    
    // Se attivo battiscopa, inizializza pareti
    if (field === 'battiscopa' && value === true) {
        if (!pos.portaInterna.paretiCm || pos.portaInterna.paretiCm.length === 0) {
            pos.portaInterna.paretiCm = [0, 0, 0, 0];
        }
    }
    
    console.log('ğŸšª Porta Interna aggiornata: ' + field + ' = ' + value);
    saveState();
    render();
};

// ğŸªµ Funzione aggiornamento singola parete battiscopa
window.updatePareteBattiscopa = function(projectId, positionId, index, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.portaInterna) return;
    
    if (!pos.portaInterna.paretiCm) pos.portaInterna.paretiCm = [0, 0, 0, 0];
    pos.portaInterna.paretiCm[index] = parseInt(value) || 0;
    
    // Calcola totale
    const totCm = pos.portaInterna.paretiCm.reduce((sum, v) => sum + (parseInt(v) || 0), 0);
    pos.portaInterna.battiscopaMt = (totCm / 100).toFixed(2);
    
    console.log('ğŸªµ Battiscopa parete ' + (index + 1) + ': ' + value + ' cm - Totale: ' + pos.portaInterna.battiscopaMt + ' mt');
    saveState();
    render();
};

// ğŸªµ Funzione aggiungi parete battiscopa
window.aggiungiPareteBattiscopa = function(projectId, positionId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.portaInterna) return;
    
    if (!pos.portaInterna.paretiCm) pos.portaInterna.paretiCm = [0, 0, 0, 0];
    pos.portaInterna.paretiCm.push(0);
    
    console.log('ğŸªµ Aggiunta parete battiscopa - Totale pareti: ' + pos.portaInterna.paretiCm.length);
    saveState();
    render();
};

// ğŸ“‹ v5.582: Auto-incolla da catalogo (localStorage)
window.addEventListener('focus', function() {
    checkCatalogoData();
});

// Controlla anche al caricamento pagina
setTimeout(checkCatalogoData, 1000);

function checkCatalogoData() {
    const now = Date.now();
    const maxAge = 5 * 60 * 1000; // 5 minuti
    
    // Controlla dati porta
    const portaTimestamp = localStorage.getItem('catalogoPorta_timestamp');
    const portaCollezione = localStorage.getItem('catalogoPorta_collezione');
    
    if (portaCollezione && portaTimestamp && (now - parseInt(portaTimestamp)) < maxAge) {
        // Trova la posizione attiva con porta interna
        const project = state.currentProject ? state.projects.find(p => p.id === state.currentProject) : null;
        if (project && project.positions) {
            const posPorta = project.positions.find(p => p.tipoposizione === 'porta_interna');
            if (posPorta) {
                if (!posPorta.portaInterna) posPorta.portaInterna = {};
                posPorta.portaInterna.collezione = portaCollezione;
                
                // Pulisci localStorage
                localStorage.removeItem('catalogoPorta_collezione');
                localStorage.removeItem('catalogoPorta_timestamp');
                
                console.log('ğŸ“‹ Auto-incollato collezione porta: ' + portaCollezione);
                showNotification('ğŸ“‹ Collezione "' + portaCollezione + '" inserita automaticamente!', 'success', 3000);
                saveState();
                render();
            }
        }
    }
    
    // Controlla dati maniglia
    const manigliaTimestamp = localStorage.getItem('catalogoManiglia_timestamp');
    const manigliaModello = localStorage.getItem('catalogoManiglia_modello');
    const manigliaAzienda = localStorage.getItem('catalogoManiglia_azienda');
    
    if (manigliaModello && manigliaTimestamp && (now - parseInt(manigliaTimestamp)) < maxAge) {
        // Trova la posizione attiva con porta interna
        const project = state.currentProject ? state.projects.find(p => p.id === state.currentProject) : null;
        if (project && project.positions) {
            const posPorta = project.positions.find(p => p.tipoposizione === 'porta_interna');
            if (posPorta) {
                if (!posPorta.portaInterna) posPorta.portaInterna = {};
                posPorta.portaInterna.manigliaModello = manigliaModello;
                if (manigliaAzienda) {
                    posPorta.portaInterna.manigliaAzienda = manigliaAzienda;
                }
                
                // Pulisci localStorage
                localStorage.removeItem('catalogoManiglia_modello');
                localStorage.removeItem('catalogoManiglia_azienda');
                localStorage.removeItem('catalogoManiglia_timestamp');
                
                console.log('ğŸ“‹ Auto-incollato maniglia: ' + manigliaModello + ' (' + manigliaAzienda + ')');
                showNotification('ğŸ“‹ Maniglia "' + manigliaModello + '" inserita automaticamente!', 'success', 3000);
                saveState();
                render();
            }
        }
    }
}

function renderPortoncinoConfig(project, pos, ing) {
    const ptc = ing.portoncino || {};
    
    // DEBUG v5.23
    console.log('ğŸšª renderPortoncinoConfig - ptc:', JSON.stringify(ptc));
    console.log('ğŸšª ptc.materialeInt:', ptc.materialeInt);
    console.log('ğŸšª ptc.materialeEst:', ptc.materialeEst);
    
    // v5.25: Helper con nuova struttura combinazioni + LEGNO + catalogo
    const comb = getCombinazioneMat(ptc);
    const formaTelaio = ptc.formaTelaio || '';
    const codTelaio = ptc.codTelaio || '';
    
    // Ottieni telaio selezionato dalla nuova struttura
    const telaiComb = FINDOOR_TELAI_PER_COMB[comb] || {};
    const telaiForma = telaiComb[formaTelaio] || {};
    const telaioSel = telaiForma[codTelaio] || {};
    
    // Helper: genera options tagli per telaio
    const tagli = FINDOOR_TAGLI_PER_TELAIO[codTelaio] || [];
    
    // Calcolo prezzo stimato
    const L = parseInt(ptc.BRM_L) || 1000;
    const H = parseInt(ptc.BRM_H) || 2100;
    const tipoAnta = ptc.tipoAnta || '';
    const anteDisp = getAntePerComb(comb);
    const antaSel = anteDisp.find(a => a.cod === tipoAnta);
    const tipoTab = antaSel?.tab || 'PVC';
    const isGrande = (L > 1115 || H > 2355);
    
    const prezzoBase = calcolaPrezzoBasePortoncino(L, H, tipoTab);
    const supplAnta = calcolaSupplModelloAnta(ptc.modelloAnta || '01', tipoAnta, isGrande);
    const maniglia = FINDOOR_MANIGLIE.set[ptc.codManiglia] || FINDOOR_MANIGLIE.maniglioni[ptc.codManiglia] || {};
    const prezzoManiglia = maniglia.prezzo || 0;
    const prezzoTotale = prezzoBase + supplAnta + prezzoManiglia;
    
    return `
        <div class="product-card border-teal-300">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                    <h4 class="font-semibold text-teal-700 text-lg">ğŸšª Portoncino Finstral FIN-Door</h4>
                    <button onclick="window.open('https://openporte2025.github.io/test-catalogo/catalogo-findoor-completo.html', '_blank')" 
                            class="text-xs bg-teal-100 hover:bg-teal-200 text-teal-700 px-3 py-1 rounded-full transition-colors flex items-center gap-1">
                        ğŸ“– Catalogo Modelli
                    </button>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">Prezzo stimato</div>
                    <div class="text-xl font-bold text-teal-600">â‚¬ ${prezzoTotale.toLocaleString('it-IT')}</div>
                </div>
            </div>
            
            <!-- ğŸ“ TIPO APERTURA (STEP 0) - v5.25 -->
            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-purple-800 mb-3">ğŸ“ 0. Tipo Apertura (Configurazione vano)</h5>
                <div class="grid md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="text-xs font-medium text-purple-700">Tipo configurazione</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'tipoApertura', this.value)"
                                class="w-full compact-input border-2 border-purple-300 rounded mt-1 bg-white font-medium">
                            <optgroup label="â”€â”€â”€ Porta Singola â”€â”€â”€">
                                <option value="720" ${(ptc.tipoApertura || '720') === '720' ? 'selected' : ''}>720 - Porta singola</option>
                                <option value="625" ${ptc.tipoApertura === '625' ? 'selected' : ''}>625 - Porta singola (variante)</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ Porta + Laterale â”€â”€â”€">
                                <option value="621" ${ptc.tipoApertura === '621' ? 'selected' : ''}>621 - Porta + laterale sx</option>
                                <option value="622" ${ptc.tipoApertura === '622' ? 'selected' : ''}>622 - Porta + laterale dx</option>
                                <option value="621C" ${ptc.tipoApertura === '621C' ? 'selected' : ''}>621C - Accoppiata + lat. sx</option>
                                <option value="622C" ${ptc.tipoApertura === '622C' ? 'selected' : ''}>622C - Accoppiata + lat. dx</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ Porta + 2 Laterali â”€â”€â”€">
                                <option value="633" ${ptc.tipoApertura === '633' ? 'selected' : ''}>633 - Porta + 2 laterali</option>
                                <option value="633C" ${ptc.tipoApertura === '633C' ? 'selected' : ''}>633C - Accoppiata + 2 lat.</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ Porta + Sopraluce â”€â”€â”€">
                                <option value="624" ${ptc.tipoApertura === '624' ? 'selected' : ''}>624 - Porta + sopraluce</option>
                                <option value="623" ${ptc.tipoApertura === '623' ? 'selected' : ''}>623 - Porta + anta sup. (ribalta)</option>
                                <option value="624C" ${ptc.tipoApertura === '624C' ? 'selected' : ''}>624C - Accoppiata + sopraluce</option>
                                <option value="623C" ${ptc.tipoApertura === '623C' ? 'selected' : ''}>623C - Accoppiata + anta sup.</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ Doppia Porta â”€â”€â”€">
                                <option value="636" ${ptc.tipoApertura === '636' ? 'selected' : ''}>636 - Doppia porta</option>
                                <option value="626" ${ptc.tipoApertura === '626' ? 'selected' : ''}>626 - Doppia + laterale sx</option>
                                <option value="627" ${ptc.tipoApertura === '627' ? 'selected' : ''}>627 - Doppia + laterale dx</option>
                                <option value="649" ${ptc.tipoApertura === '649' ? 'selected' : ''}>649 - Doppia + 2 laterali</option>
                                <option value="628" ${ptc.tipoApertura === '628' ? 'selected' : ''}>628 - Doppia + sopraluce</option>
                                <option value="629" ${ptc.tipoApertura === '629' ? 'selected' : ''}>629 - Doppia + anta sup.</option>
                            </optgroup>
                            <optgroup label="â”€â”€â”€ Config. Complesse â”€â”€â”€">
                                <option value="634" ${ptc.tipoApertura === '634' ? 'selected' : ''}>634 - Porta + lat. + sopraluce</option>
                                <option value="638" ${ptc.tipoApertura === '638' ? 'selected' : ''}>638 - Porta + lat. + 2 sopraluce</option>
                                <option value="644" ${ptc.tipoApertura === '644' ? 'selected' : ''}>644 - Porta + lat. + anta sup.</option>
                                <option value="640" ${ptc.tipoApertura === '640' ? 'selected' : ''}>640 - Porta + 2 lat. + sopraluce</option>
                                <option value="663" ${ptc.tipoApertura === '663' ? 'selected' : ''}>663 - Porta + 2 lat. + 3 sopraluce</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <div class="bg-purple-100 p-3 rounded-lg text-sm text-purple-800">
                            <div class="font-bold mb-1">â„¹ï¸ Info tipo selezionato:</div>
                            <div id="tipoAperturaInfo-${pos.id}">${getTipoAperturaInfo(ptc.tipoApertura || '720')}</div>
                        </div>
                    </div>
                </div>
                
                <!-- APERTURA: Verso (Tirare/Spingere) + Senso (Sx/Dx) -->
                <div class="grid md:grid-cols-2 gap-4 pt-3 border-t border-purple-200">
                    <div>
                        <label class="text-xs font-medium text-purple-700 block mb-2">Verso Apertura</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="versoApertura-${pos.id}" value="tirare" 
                                       ${(ptc.versoApertura || 'tirare') === 'tirare' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'versoApertura', 'tirare')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-600 border-purple-300 bg-white hover:bg-purple-50">
                                    <div class="font-bold text-sm">â¬…ï¸ Tirare</div>
                                    <div class="text-xs opacity-75">verso interno</div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="versoApertura-${pos.id}" value="spingere" 
                                       ${ptc.versoApertura === 'spingere' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'versoApertura', 'spingere')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-600 border-purple-300 bg-white hover:bg-purple-50">
                                    <div class="font-bold text-sm">â¡ï¸ Spingere</div>
                                    <div class="text-xs opacity-75">verso esterno</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-purple-700 block mb-2">Senso Apertura (visto da interno)</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="sensoApertura-${pos.id}" value="SX" 
                                       ${(ptc.sensoApertura || 'SX') === 'SX' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'sensoApertura', 'SX')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-600 border-purple-300 bg-white hover:bg-purple-50">
                                    <div class="font-bold text-sm">â—€ï¸ Sinistra</div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="sensoApertura-${pos.id}" value="DX" 
                                       ${ptc.sensoApertura === 'DX' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'sensoApertura', 'DX')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-600 border-purple-300 bg-white hover:bg-purple-50">
                                    <div class="font-bold text-sm">â–¶ï¸ Destra</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“ DIMENSIONI BRM -->
            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-teal-800 mb-3">ğŸ“ Dimensioni BRM (misura telaio)</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">BRM Larghezza (mm)</label>
                        <input type="number" value="${ptc.BRM_L || ''}" placeholder="es. 1000"
                               onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'BRM_L', this.value)"
                               class="w-full compact-input border rounded mt-1 font-bold text-lg">
                    </div>
                    <div>
                        <label class="text-xs font-medium">BRM Altezza (mm)</label>
                        <input type="number" value="${ptc.BRM_H || ''}" placeholder="es. 2200"
                               onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'BRM_H', this.value)"
                               class="w-full compact-input border rounded mt-1 font-bold text-lg">
                    </div>
                    <div class="flex items-end">
                        <div class="bg-teal-100 p-2 rounded text-sm w-full text-center">
                            ${isGrande ? 'ğŸ“ Misura GRANDE (>1115Ã—2355)' : 'ğŸ“ Misura standard'}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ§± MATERIALI INT/EST (STEP 1) -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-amber-800 mb-3">ğŸ§± 1. Materiali (Interno - Esterno)</h5>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-amber-100 p-3 rounded-lg">
                        <label class="text-sm font-bold text-amber-900 block mb-2">ğŸ  Materiale INTERNO</label>
                        <div class="flex gap-2">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="matInt-${pos.id}" value="PVC" 
                                       ${(ptc.materialeInt || 'PVC') === 'PVC' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'materialeInt', 'PVC'); checkCombinazioneAndUpdate('${project.id}', '${pos.id}')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-600 border-amber-300 bg-white hover:bg-amber-50">
                                    <div class="font-bold text-sm">PVC</div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="matInt-${pos.id}" value="ALU"
                                       ${ptc.materialeInt === 'ALU' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'materialeInt', 'ALU'); checkCombinazioneAndUpdate('${project.id}', '${pos.id}')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-600 border-amber-300 bg-white hover:bg-amber-50">
                                    <div class="font-bold text-sm">Alluminio</div>
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="matInt-${pos.id}" value="LEGNO"
                                       ${ptc.materialeInt === 'LEGNO' ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'materialeInt', 'LEGNO'); checkCombinazioneAndUpdate('${project.id}', '${pos.id}')"
                                       class="sr-only peer">
                                <div class="p-2 rounded-lg border-2 text-center transition-all peer-checked:bg-amber-700 peer-checked:text-white peer-checked:border-amber-800 border-amber-300 bg-white hover:bg-amber-50">
                                    <div class="font-bold text-sm">ğŸªµ Legno</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-lg">
                        <label class="text-sm font-bold text-orange-900 block mb-2">ğŸŒ³ Materiale ESTERNO</label>
                        ${(ptc.materialeInt === 'ALU' || ptc.materialeInt === 'LEGNO') ? `
                            <!-- ALU o LEGNO interno â†’ SOLO ALU esterno -->
                            <div class="p-3 rounded-lg border-2 bg-orange-500 text-white border-orange-600 text-center">
                                <div class="font-bold">Alluminio</div>
                                <div class="text-xs opacity-75">Obbligatorio con ${ptc.materialeInt === 'LEGNO' ? 'Legno' : 'ALU'} interno</div>
                            </div>
                        ` : `
                            <!-- PVC interno â†’ PVC o ALU esterno -->
                            <div class="flex gap-2">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="matEst-${pos.id}" value="PVC"
                                           ${(ptc.materialeEst || 'PVC') === 'PVC' ? 'checked' : ''}
                                           onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'materialeEst', 'PVC'); checkCombinazioneAndUpdate('${project.id}', '${pos.id}')"
                                           class="sr-only peer">
                                    <div class="p-3 rounded-lg border-2 text-center transition-all peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-600 border-orange-300 bg-white hover:bg-orange-50">
                                        <div class="font-bold">PVC</div>
                                    </div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="matEst-${pos.id}" value="ALU"
                                           ${ptc.materialeEst === 'ALU' ? 'checked' : ''}
                                           onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'materialeEst', 'ALU'); checkCombinazioneAndUpdate('${project.id}', '${pos.id}')"
                                           class="sr-only peer">
                                    <div class="p-3 rounded-lg border-2 text-center transition-all peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-600 border-orange-300 bg-white hover:bg-orange-50">
                                        <div class="font-bold">Alluminio</div>
                                    </div>
                                </label>
                            </div>
                        `}
                    </div>
                </div>
                <div class="mt-3 p-2 rounded bg-white border border-amber-200 text-center">
                    <span class="text-sm font-bold">ğŸ“‹ Combinazione: </span>
                    <span class="text-lg font-bold text-amber-700">${comb}</span>
                </div>
            </div>
            
            <!-- ğŸ—ï¸ TELAIO (filtrato per combinazione) -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-blue-800 mb-3">ğŸ—ï¸ 2. Telaio</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">Forma Telaio</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'formaTelaio', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona forma...</option>
                            ${getFormeTelaioPerComb(comb).map(f => 
                                `<option value="${f.cod}" ${formaTelaio === f.cod ? 'selected' : ''}>${f.desc}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Codice Telaio</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'codTelaio', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona...</option>
                            ${getTelaiPerCombForma(comb, formaTelaio).map(t => 
                                `<option value="${t.cod}" ${codTelaio === t.cod ? 'selected' : ''}>${t.cod} - ${t.desc}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex items-end">
                        ${telaioSel.note ? `<div class="bg-blue-100 p-2 rounded text-xs w-full">â„¹ï¸ ${telaioSel.note}</div>` : ''}
                    </div>
                </div>
            </div>
            
            <!-- ğŸšª TIPO ANTA (filtrato per combinazione) -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-purple-800 mb-3">ğŸšª 3. Tipo Anta (Interno - Esterno)</h5>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium">Combinazione Int-Est</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'tipoAnta', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona tipo anta...</option>
                            ${getAntePerComb(comb).map(t => 
                                `<option value="${t.cod}" ${tipoAnta === t.cod ? 'selected' : ''}>${t.desc}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-100 p-2 rounded text-sm flex-1 text-center">
                            Materiale: <strong>${comb}</strong>
                        </div>
                        <div class="bg-purple-200 p-2 rounded text-sm">
                            Base: <strong>â‚¬${prezzoBase.toLocaleString('it-IT')}</strong>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ¨ MODELLO ANTA -->
            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-orange-800 mb-3">ğŸ¨ 4. Modello Anta</h5>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        ${renderPortoncinoModelButton(ptc.modelloAnta, comb,
                            `openPortoncinoModelPicker('${project.id}','${pos.id}','pos','${ptc.modelloAnta || ''}','${comb}')`)}
                    </div>
                    <div class="flex items-center gap-2">
                        ${supplAnta > 0 ? `
                            <div class="bg-orange-200 p-2 rounded text-sm flex-1 text-center">
                                Suppl. modello: <strong>+â‚¬${supplAnta.toLocaleString('it-IT')}</strong>
                            </div>
                        ` : `
                            <div class="bg-gray-100 p-2 rounded text-sm flex-1 text-center text-gray-500">
                                Tocca per scegliere modello
                            </div>
                        `}
                        <label class="flex items-center gap-1 text-sm">
                            <input type="checkbox" ${ptc.fonoassorbente ? 'checked' : ''}
                                   onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'fonoassorbente', this.checked)">
                            Fonoass.
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- âœ‚ï¸ TAGLI TELAIO -->
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-red-800 mb-3">âœ‚ï¸ 5. Tagli Telaio</h5>
                <div class="grid md:grid-cols-4 gap-2">
                    ${['SOPRA', 'SOTTO', 'SX', 'DX'].map(pos => `
                        <div>
                            <label class="text-xs font-medium">${pos}</label>
                            <select onchange="updateIngressoTaglio('${project.id}', '${pos.id}', '${pos}', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Nessuno</option>
                                ${tagli.map(t => 
                                    `<option value="${t}" ${(ptc.tagli?.[pos] || '') === t ? 'selected' : ''}>${t} (â‚¬${FINDOOR_TAGLI_PREZZI[t]}/ml)</option>`
                                ).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
                ${codTelaio === '' ? '<p class="text-xs text-red-500 mt-2">âš ï¸ Seleziona prima un telaio per vedere i tagli disponibili</p>' : ''}
            </div>
            
            <!-- ğŸ” MANIGLIE -->
            <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-gray-800 mb-3">ğŸ” 6. Maniglie</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">Tipo</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'tipoManiglia', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="set" ${(ptc.tipoManiglia || 'set') === 'set' ? 'selected' : ''}>Set maniglie (coppia)</option>
                            <option value="maniglione" ${ptc.tipoManiglia === 'maniglione' ? 'selected' : ''}>Maniglione</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Modello</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'codManiglia', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona...</option>
                            ${(ptc.tipoManiglia === 'maniglione' 
                                ? Object.entries(FINDOOR_MANIGLIE.maniglioni)
                                : Object.entries(FINDOOR_MANIGLIE.set)
                            ).map(([cod, m]) => 
                                `<option value="${cod}" ${ptc.codManiglia === cod ? 'selected' : ''}>${cod} - ${m.desc} (â‚¬${m.prezzo})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex items-center">
                        ${prezzoManiglia > 0 ? `
                            <div class="bg-gray-200 p-2 rounded text-sm w-full text-center">
                                Maniglia: <strong>+â‚¬${prezzoManiglia}</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- ğŸ¨ COLORI INT/EST (basati su materiali scelti in sezione 1) -->
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-yellow-800 mb-3">ğŸ¨ 7. Colori (Interno/Esterno)</h5>
                
                <!-- Display combinazione corrente -->
                <div class="bg-white border border-yellow-300 rounded p-2 mb-3 text-center text-sm">
                    ğŸ“‹ Materiali: <strong class="text-amber-700">${ptc.materialeInt || 'PVC'}</strong> (int) - 
                    <strong class="text-orange-700">${(ptc.materialeInt === 'ALU' || ptc.materialeInt === 'LEGNO') ? 'ALU' : (ptc.materialeEst || 'PVC')}</strong> (est)
                    â†’ <span class="font-bold">${comb}</span>
                </div>
                
                <!-- RIGA 1: Colore INTERNO -->
                <div class="bg-amber-100 border border-amber-300 rounded-lg p-3 mb-3">
                    <label class="text-xs font-bold text-amber-800 block mb-2">ğŸ  COLORE INTERNO (${ptc.materialeInt || 'PVC'})</label>
                    ${(ptc.materialeInt || 'PVC') === 'PVC' ? `
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs">Gruppo PVC</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColoreInt', this.value); renderPositionDetails(projects.find(p=>p.id==='${project.id}'), '${pos.id}')"
                                        class="w-full compact-input border rounded mt-1">
                                    ${Object.entries(FINDOOR_COLORI_PVC).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColoreInt || 'gruppoA') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Colore PVC</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'coloreInt', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_PVC[ptc.gruppoColoreInt || 'gruppoA']?.colori || []).map(c => 
                                        `<option value="${c.cod}" ${ptc.coloreInt === c.cod ? 'selected' : ''}>${c.cod} - ${c.nome}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    ` : ptc.materialeInt === 'LEGNO' ? `
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs">ğŸªµ Gruppo Legno</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColoreInt', this.value); renderPositionDetails(projects.find(p=>p.id==='${project.id}'), '${pos.id}')"
                                        class="w-full compact-input border rounded mt-1 bg-amber-50">
                                    ${Object.entries(FINDOOR_COLORI_LEGNO).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColoreInt || 'gruppo0') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Essenza Legno</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'coloreInt', this.value)"
                                        class="w-full compact-input border rounded mt-1 bg-amber-50">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_LEGNO[ptc.gruppoColoreInt || 'gruppo0']?.colori || []).map(c => 
                                        `<option value="${c}" ${ptc.coloreInt === c ? 'selected' : ''}>${c}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    ` : `
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs">Gruppo Alluminio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColoreInt', this.value); renderPositionDetails(projects.find(p=>p.id==='${project.id}'), '${pos.id}')"
                                        class="w-full compact-input border rounded mt-1">
                                    ${Object.entries(FINDOOR_COLORI_ALU).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColoreInt || 'gruppo1') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Colore Alluminio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'coloreInt', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_ALU[ptc.gruppoColoreInt || 'gruppo1']?.colori || []).map(c => 
                                        `<option value="${c}" ${ptc.coloreInt === c ? 'selected' : ''}>${c}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- RIGA 3: Colore ESTERNO -->
                <div class="bg-orange-100 border border-orange-300 rounded-lg p-3">
                    <label class="text-xs font-bold text-orange-800 block mb-2">ğŸŒ³ COLORE ESTERNO (${ptc.materialeEst || 'PVC'})</label>
                    ${(ptc.materialeEst || 'PVC') === 'PVC' ? `
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs">Gruppo PVC</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColoreEst', this.value); renderPositionDetails(projects.find(p=>p.id==='${project.id}'), '${pos.id}')"
                                        class="w-full compact-input border rounded mt-1">
                                    ${Object.entries(FINDOOR_COLORI_PVC).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColoreEst || 'gruppoA') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Colore PVC</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'coloreEst', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_PVC[ptc.gruppoColoreEst || 'gruppoA']?.colori || []).map(c => 
                                        `<option value="${c.cod}" ${ptc.coloreEst === c.cod ? 'selected' : ''}>${c.cod} - ${c.nome}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    ` : `
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs">Gruppo Alluminio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'gruppoColoreEst', this.value); renderPositionDetails(projects.find(p=>p.id==='${project.id}'), '${pos.id}')"
                                        class="w-full compact-input border rounded mt-1">
                                    ${Object.entries(FINDOOR_COLORI_ALU).map(([cod, g]) => 
                                        `<option value="${cod}" ${(ptc.gruppoColoreEst || 'gruppo1') === cod ? 'selected' : ''}>${g.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs">Colore Alluminio</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'coloreEst', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    ${(FINDOOR_COLORI_ALU[ptc.gruppoColoreEst || 'gruppo1']?.colori || []).map(c => 
                                        `<option value="${c}" ${ptc.coloreEst === c ? 'selected' : ''}>${c}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- Info combinazione -->
                <div class="mt-2 text-xs text-gray-600 bg-white p-2 rounded border">
                    ğŸ“‹ <strong>Combinazione:</strong> ${ptc.materialeInt || 'PVC'}-${ptc.materialeEst || 'PVC'} | 
                    <strong>Int:</strong> ${ptc.coloreInt || 'da definire'} | 
                    <strong>Est:</strong> ${ptc.coloreEst || 'da definire'}
                </div>
            </div>
            
            <!-- ğŸ”’ CILINDRO E CERNIERE -->
            <div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-indigo-800 mb-3">ğŸ”’ 8. Cilindro e Cerniere</h5>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium">Cilindro</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'cilindro', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="standard" ${(ptc.cilindro || 'standard') === 'standard' ? 'selected' : ''}>Standard (3 chiavi) - incluso</option>
                            <option value="1P" ${ptc.cilindro === '1P' ? 'selected' : ''}>Sicurezza 1P</option>
                            <option value="2P" ${ptc.cilindro === '2P' ? 'selected' : ''}>Sicurezza 2P</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Cerniere</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'cerniere', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="vista" ${(ptc.cerniere || 'vista') === 'vista' ? 'selected' : ''}>A vista con rostri</option>
                            <option value="scomparsa" ${ptc.cerniere === 'scomparsa' ? 'selected' : ''}>A scomparsa (cod. 220)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“ NOTE E RIEPILOGO -->
            <div class="grid md:grid-cols-2 gap-3">
                <div>
                    <label class="text-xs font-medium">ğŸ“ Note</label>
                    <textarea onchange="updateIngressoData('${project.id}', '${pos.id}', 'portoncino', 'note', this.value)"
                              placeholder="Note aggiuntive..." class="w-full compact-input border rounded mt-1 h-20">${ptc.note || ''}</textarea>
                </div>
                <div class="bg-teal-100 border-2 border-teal-300 rounded-lg p-3">
                    <h6 class="font-bold text-teal-800 mb-2">ğŸ’° Riepilogo Prezzi</h6>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between"><span>Base porta:</span><span>â‚¬${prezzoBase.toLocaleString('it-IT')}</span></div>
                        <div class="flex justify-between"><span>Suppl. modello:</span><span>+â‚¬${supplAnta.toLocaleString('it-IT')}</span></div>
                        <div class="flex justify-between"><span>Maniglia:</span><span>+â‚¬${prezzoManiglia.toLocaleString('it-IT')}</span></div>
                        <hr class="border-teal-400">
                        <div class="flex justify-between font-bold text-lg"><span>TOTALE:</span><span>â‚¬${prezzoTotale.toLocaleString('it-IT')}</span></div>
                    </div>
                    <p class="text-xs text-teal-600 mt-2">* Esclusi: tagli, colori gruppo 2/3, optional</p>
                </div>
            </div>
        </div>
    `;
}

// Helper: aggiorna taglio specifico portoncino
function updateIngressoTaglio(projectId, posId, posizione, valore) {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    const pos = project.positions.find(p => p.id === posId);
    if (!pos) return;
    
    if (!pos.ingresso) pos.ingresso = {};
    if (!pos.ingresso.portoncino) pos.ingresso.portoncino = {};
    if (!pos.ingresso.portoncino.tagli) pos.ingresso.portoncino.tagli = {};
    
    if (valore) {
        pos.ingresso.portoncino.tagli[posizione] = valore;
    } else {
        delete pos.ingresso.portoncino.tagli[posizione];
    }
    
    saveState();
    render();
}

// ğŸ†• v5.90: UI wrapper per aggiornamento combinazione materiali portoncino
// Usa findoorAdjustCombinazione() dal modulo findoor-portoncini.js
function checkCombinazioneAndUpdate(projectId, posId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === posId);
    if (!pos?.ingresso?.portoncino) return;
    
    if (typeof window.findoorAdjustCombinazione === 'function') {
        window.findoorAdjustCombinazione(pos.ingresso.portoncino);
    }
    saveState();
    render();
}

// ğŸ” Configurazione BLINDATA Oikos
// v5.12: UI COMPLETA Blindata con tutti i campi
function renderBlindataConfig(project, pos, ing) {
    const bld = ing.blindata || {};
    return `
        <div class="product-card border-red-300">
            <div class="flex justify-between items-start mb-3">
                <h4 class="font-semibold text-red-700 text-lg">ğŸ” Porta Blindata Oikos</h4>
            </div>
            
            <!-- ğŸ“ DIMENSIONI -->
            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-red-800 mb-3">ğŸ“ Dimensioni Luce Netta Passaggio</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">Larghezza (mm)</label>
                        <input type="number" value="${bld.LNP_L || ''}" placeholder="es. 900"
                               onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'LNP_L', this.value)"
                               class="w-full compact-input border rounded mt-1 font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Altezza (mm)</label>
                        <input type="number" value="${bld.LNP_H || ''}" placeholder="es. 2100"
                               onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'LNP_H', this.value)"
                               class="w-full compact-input border rounded mt-1 font-bold">
                    </div>
                    <div>
                        <label class="text-xs font-medium">Luce Calcolata</label>
                        <div class="w-full px-3 py-2 bg-gray-100 border rounded mt-1 font-bold text-center">
                            ${bld.luceCalcolata ? bld.luceCalcolata.toUpperCase() : '-'}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- âš™ï¸ CONFIGURAZIONE BASE -->
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-yellow-800 mb-3">âš™ï¸ Configurazione Base</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">Versione</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'versione', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona...</option>
                            <option value="E3" ${bld.versione === 'E3' ? 'selected' : ''}>E3 - Evolution 3</option>
                            <option value="E4" ${bld.versione === 'E4' ? 'selected' : ''}>E4 - Evolution 4</option>
                            <option value="E3D" ${bld.versione === 'E3D' ? 'selected' : ''}>E3D - Doppia Anta</option>
                            <option value="E3EI30" ${bld.versione === 'E3EI30' ? 'selected' : ''}>E3 EI 30 - Fuoco 30min</option>
                            <option value="E3EI45" ${bld.versione === 'E3EI45' ? 'selected' : ''}>E3 EI 45 - Fuoco 45min</option>
                            <option value="E3EI60" ${bld.versione === 'E3EI60' ? 'selected' : ''}>E3 EI 60 - Fuoco 60min</option>
                            <option value="E3TT086" ${bld.versione === 'E3TT086' ? 'selected' : ''}>E3 TT U=0.86 - Taglio Termico</option>
                            <option value="E3TT1" ${bld.versione === 'E3TT1' ? 'selected' : ''}>E3 TT U=1.0 - Taglio Termico</option>
                            <option value="P3" ${bld.versione === 'P3' ? 'selected' : ''}>P3 - Project Rasomuro</option>
                            <option value="T3" ${bld.versione === 'T3' ? 'selected' : ''}>T3 - Tekno</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Tipo Anta</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'tipoAnta', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="singola" ${bld.tipoAnta === 'singola' ? 'selected' : ''}>Singola</option>
                            <option value="doppia" ${bld.tipoAnta === 'doppia' ? 'selected' : ''}>Doppia</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Senso Apertura</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'sensoApertura', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona...</option>
                            <option value="SX" ${bld.sensoApertura === 'SX' ? 'selected' : ''}>Sinistra (SX)</option>
                            <option value="DX" ${bld.sensoApertura === 'DX' ? 'selected' : ''}>Destra (DX)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Verso Apertura</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'versoApertura', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="">Seleziona...</option>
                            <option value="spingere" ${bld.versoApertura === 'spingere' ? 'selected' : ''}>Spingere</option>
                            <option value="tirare" ${bld.versoApertura === 'tirare' ? 'selected' : ''}>Tirare</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Controtelaio</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'controtelaio', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="si" ${bld.controtelaio === 'si' ? 'selected' : ''}>SÃ¬, con porta</option>
                            <option value="fornito" ${bld.controtelaio === 'fornito' ? 'selected' : ''}>GiÃ  fornito</option>
                            <option value="no" ${bld.controtelaio === 'no' ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ”§ PRESTAZIONI -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-blue-800 mb-3">ğŸ”§ Prestazioni</h5>
                <div class="grid md:grid-cols-4 gap-3">
                    <div>
                        <label class="text-xs font-medium">Cilindro</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'cilindro', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="BASIC" ${bld.cilindro === 'BASIC' ? 'selected' : ''}>Basic (â‚¬123)</option>
                            <option value="SEKUR" ${bld.cilindro === 'SEKUR' ? 'selected' : ''}>Sekur (â‚¬238)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Tipo Cilindro</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'tipoCilindro', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="pomolo-chiave" ${bld.tipoCilindro === 'pomolo-chiave' ? 'selected' : ''}>Pomolo + Chiave (std)</option>
                            <option value="chiave-chiave" ${bld.tipoCilindro === 'chiave-chiave' ? 'selected' : ''}>Chiave + Chiave</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">NÂ° Chiavi</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'numChiavi', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="3" ${bld.numChiavi === '3' || !bld.numChiavi ? 'selected' : ''}>3 (standard)</option>
                            <option value="4" ${bld.numChiavi === '4' ? 'selected' : ''}>4</option>
                            <option value="5" ${bld.numChiavi === '5' ? 'selected' : ''}>5</option>
                            <option value="6" ${bld.numChiavi === '6' ? 'selected' : ''}>6</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Colore Telaio</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'coloreTelaio', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="RAL8022" ${bld.coloreTelaio === 'RAL8022' ? 'selected' : ''}>RAL 8022 (base)</option>
                            <option value="OIKOS_Polveri" ${bld.coloreTelaio === 'OIKOS_Polveri' ? 'selected' : ''}>OIKOS Polveri (+â‚¬246)</option>
                            <option value="OIKOS_Evergreen" ${bld.coloreTelaio === 'OIKOS_Evergreen' ? 'selected' : ''}>OIKOS Evergreen (+â‚¬320)</option>
                            <option value="OIKOS_Future" ${bld.coloreTelaio === 'OIKOS_Future' ? 'selected' : ''}>OIKOS Future (+â‚¬384)</option>
                            <option value="OIKOS_Liquido" ${bld.coloreTelaio === 'OIKOS_Liquido' ? 'selected' : ''}>OIKOS Liquido (+â‚¬492)</option>
                        </select>
                    </div>
                </div>
                
                <!-- ğŸšª MANIGLIE INT/EST -->
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <h6 class="text-xs font-semibold text-blue-700 mb-2">ğŸšª Maniglie e Pomoli</h6>
                    <div class="grid md:grid-cols-4 gap-3">
                        <!-- Maniglia Interna -->
                        <div>
                            <label class="text-xs font-medium">Maniglia INT</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'manigliaInt', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="MO-05" ${bld.manigliaInt === 'MO-05' || !bld.manigliaInt ? 'selected' : ''}>MO-05 Standard</option>
                                <option value="MO-07Q" ${bld.manigliaInt === 'MO-07Q' ? 'selected' : ''}>MO-07Q Quadra</option>
                                <option value="MO-07T" ${bld.manigliaInt === 'MO-07T' ? 'selected' : ''}>MO-07T Tonda</option>
                                <option value="MO-08Q" ${bld.manigliaInt === 'MO-08Q' ? 'selected' : ''}>MO-08Q Quadra</option>
                                <option value="MO-08T" ${bld.manigliaInt === 'MO-08T' ? 'selected' : ''}>MO-08T Tonda</option>
                                <option value="MO-13Q" ${bld.manigliaInt === 'MO-13Q' ? 'selected' : ''}>MO-13Q Quadra</option>
                                <option value="MO-13T" ${bld.manigliaInt === 'MO-13T' ? 'selected' : ''}>MO-13T Tonda</option>
                                <option value="MO-03T" ${bld.manigliaInt === 'MO-03T' ? 'selected' : ''}>MO-03T</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Finitura INT</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'finituraInt', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="OL" ${bld.finituraInt === 'OL' || !bld.finituraInt ? 'selected' : ''}>OL - Ottone Lucido (std)</option>
                                <option value="OL_TZ" ${bld.finituraInt === 'OL_TZ' ? 'selected' : ''}>OL TZ - PVD Superior</option>
                                <option value="CS" ${bld.finituraInt === 'CS' ? 'selected' : ''}>CS - Cromo Satinato</option>
                                <option value="CL" ${bld.finituraInt === 'CL' ? 'selected' : ''}>CL - Cromo Lucido</option>
                                <option value="VP" ${bld.finituraInt === 'VP' ? 'selected' : ''}>VP - Verniciato Polvere</option>
                                <option value="VL" ${bld.finituraInt === 'VL' ? 'selected' : ''}>VL - Verniciato Liquido</option>
                                <option value="VS" ${bld.finituraInt === 'VS' ? 'selected' : ''}>VS - Verniciato Skydoors</option>
                            </select>
                        </div>
                        <!-- Maniglia/Pomolo Esterno -->
                        <div>
                            <label class="text-xs font-medium">Esterno</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'manigliaEst', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="PO-05" ${bld.manigliaEst === 'PO-05' || !bld.manigliaEst ? 'selected' : ''}>PO-05 Pomolo (std)</option>
                                <option value="PO-02" ${bld.manigliaEst === 'PO-02' ? 'selected' : ''}>PO-02 Pomolo TZ</option>
                                <option value="PO-INOX" ${bld.manigliaEst === 'PO-INOX' ? 'selected' : ''}>Pomolo INOX (+â‚¬76)</option>
                                <option value="MO-05" ${bld.manigliaEst === 'MO-05' ? 'selected' : ''}>MO-05 Maniglia</option>
                                <option value="JUMBO-300" ${bld.manigliaEst === 'JUMBO-300' ? 'selected' : ''}>JUMBO 300 Maniglione</option>
                                <option value="JUMBO-600" ${bld.manigliaEst === 'JUMBO-600' ? 'selected' : ''}>JUMBO 600 Maniglione</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Finitura EST</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'finituraEst', this.value)"
                                    class="w-full compact-input border rounded mt-1">
                                <option value="OL" ${bld.finituraEst === 'OL' || !bld.finituraEst ? 'selected' : ''}>OL - Ottone Lucido (std)</option>
                                <option value="OL_TZ" ${bld.finituraEst === 'OL_TZ' ? 'selected' : ''}>OL TZ - PVD Superior</option>
                                <option value="CS" ${bld.finituraEst === 'CS' ? 'selected' : ''}>CS - Cromo Satinato</option>
                                <option value="CL" ${bld.finituraEst === 'CL' ? 'selected' : ''}>CL - Cromo Lucido</option>
                                <option value="VP" ${bld.finituraEst === 'VP' ? 'selected' : ''}>VP - Verniciato Polvere</option>
                                <option value="VL" ${bld.finituraEst === 'VL' ? 'selected' : ''}>VL - Verniciato Liquido</option>
                                <option value="VS" ${bld.finituraEst === 'VS' ? 'selected' : ''}>VS - Verniciato Skydoors</option>
                                <option value="OB" ${bld.finituraEst === 'OB' ? 'selected' : ''}>OB - Ottone Brunito</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Acustica e Termica -->
                <div class="mt-3 pt-3 border-t border-blue-200 grid md:grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-medium">Acustica</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'acustica', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="serie" ${bld.acustica === 'serie' ? 'selected' : ''}>Di serie (40dB)</option>
                            <option value="maggiorata" ${bld.acustica === 'maggiorata' ? 'selected' : ''}>Maggiorata 45dB (+â‚¬120)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium">Termica (U)</label>
                        <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'termica', this.value)"
                                class="w-full compact-input border rounded mt-1">
                            <option value="serie" ${bld.termica === 'serie' ? 'selected' : ''}>Di serie (U=1.9)</option>
                            <option value="1.2" ${bld.termica === '1.2' ? 'selected' : ''}>U=1.2</option>
                            <option value="1.0" ${bld.termica === '1.0' ? 'selected' : ''}>U=1.0</option>
                        </select>
                    </div>
                </div>
                <!-- KIT AAV -->
                <div class="mt-3 pt-3 border-t border-blue-200">
                    <label class="text-xs font-medium">ğŸ’¨ Kit Aria-Acqua-Vento (A4-5A-C5)</label>
                    <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'kitAAV', this.value)"
                            class="w-full compact-input border rounded mt-1">
                        <option value="" ${!bld.kitAAV ? 'selected' : ''}>Nessuno (di serie A0-0-C4)</option>
                        <option value="MOSE" ${bld.kitAAV === 'MOSE' ? 'selected' : ''}>Kit MOSE 4/5A/C5 (+â‚¬405-499)</option>
                        <option value="DAM" ${bld.kitAAV === 'DAM' ? 'selected' : ''}>Kit DAM 4/5A/C5 (+â‚¬459-514)</option>
                    </select>
                </div>
            </div>
            
            <!-- ğŸªŸ OPTIONAL -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-purple-800 mb-3">ğŸªŸ Optional</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <!-- VETRO -->
                    <div class="bg-purple-100 rounded p-2">
                        <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                            <input type="checkbox" 
                                   ${bld.vetro?.attivo ? 'checked' : ''}
                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'attivo', this.checked)"
                                   class="w-4 h-4">
                            <span class="font-medium">ğŸªŸ Vetro</span>
                        </label>
                        ${bld.vetro?.attivo ? `
                            <div class="space-y-1 pl-6">
                                <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'tipo', this.value)"
                                        class="w-full px-2 py-1 border rounded text-xs">
                                    <option value="">Tipo...</option>
                                    <option value="V1" ${bld.vetro?.tipo === 'V1' ? 'selected' : ''}>V1 Isola</option>
                                    <option value="V2" ${bld.vetro?.tipo === 'V2' ? 'selected' : ''}>V2 800 Veneto</option>
                                    <option value="V3" ${bld.vetro?.tipo === 'V3' ? 'selected' : ''}>V3 Classica</option>
                                    <option value="V4" ${bld.vetro?.tipo === 'V4' ? 'selected' : ''}>V4 Musa</option>
                                    <option value="V5" ${bld.vetro?.tipo === 'V5' ? 'selected' : ''}>V5 Rialto</option>
                                </select>
                                <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'finitura', this.value)"
                                        class="w-full px-2 py-1 border rounded text-xs">
                                    <option value="trasparente" ${bld.vetro?.finitura === 'trasparente' ? 'selected' : ''}>Trasparente</option>
                                    <option value="sabbiato" ${bld.vetro?.finitura === 'sabbiato' ? 'selected' : ''}>Sabbiato (+â‚¬216)</option>
                                </select>
                                <label class="flex items-center gap-1 text-xs">
                                    <input type="checkbox" 
                                           ${bld.vetro?.termico ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'vetro', 'termico', this.checked)"
                                           class="w-3 h-3">
                                    <span>Termico (+â‚¬300~â‚¬400)</span>
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- SOPRALUCE -->
                    <div class="bg-purple-100 rounded p-2">
                        <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                            <input type="checkbox" 
                                   ${bld.sopraluce?.attivo ? 'checked' : ''}
                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'attivo', this.checked)"
                                   class="w-4 h-4">
                            <span class="font-medium">ğŸ” Sopraluce</span>
                        </label>
                        ${bld.sopraluce?.attivo ? `
                            <div class="space-y-1 pl-6">
                                <select onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'altezza', this.value)"
                                        class="w-full px-2 py-1 border rounded text-xs">
                                    <option value="">Altezza...</option>
                                    <option value="H500" ${bld.sopraluce?.altezza === 'H500' ? 'selected' : ''}>H â‰¤ 500</option>
                                    <option value="H800" ${bld.sopraluce?.altezza === 'H800' ? 'selected' : ''}>H â‰¤ 800</option>
                                </select>
                                <label class="flex items-center gap-1 text-xs">
                                    <input type="checkbox" 
                                           ${bld.sopraluce?.sabbiato ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'sopraluce', 'sabbiato', this.checked)"
                                           class="w-3 h-3">
                                    <span>Sabbiato (+â‚¬78-200)</span>
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- FIANCOLUCE -->
                    <div class="bg-purple-100 rounded p-2">
                        <label class="flex items-center gap-2 cursor-pointer text-sm mb-1">
                            <input type="checkbox" 
                                   ${bld.fiancoluce?.attivo ? 'checked' : ''}
                                   onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'attivo', this.checked)"
                                   class="w-4 h-4">
                            <span class="font-medium">ğŸ“ Fiancoluce</span>
                        </label>
                        ${bld.fiancoluce?.attivo ? `
                            <div class="space-y-1 pl-6">
                                <label class="flex items-center gap-1 text-xs">
                                    <input type="checkbox" 
                                           ${bld.fiancoluce?.conVetro ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'conVetro', this.checked)"
                                           class="w-3 h-3">
                                    <span>Con vetro (+â‚¬1000~â‚¬3000)</span>
                                </label>
                                <label class="flex items-center gap-1 text-xs">
                                    <input type="checkbox" 
                                           ${bld.fiancoluce?.sabbiato ? 'checked' : ''}
                                           onchange="updateIngressoBlindataOpt('${project.id}', '${pos.id}', 'fiancoluce', 'sabbiato', this.checked)"
                                           class="w-3 h-3">
                                    <span>Sabbiato (+â‚¬170-432)</span>
                                </label>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- ğŸ¨ RIVESTIMENTI -->
            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-orange-800 mb-3">ğŸ¨ Rivestimenti</h5>
                
                <!-- RIVESTIMENTO INTERNO -->
                <div class="bg-orange-100 rounded-lg p-3 mb-3">
                    <h6 class="font-medium text-orange-900 mb-2">ğŸ“‹ Interno</h6>
                    <div class="grid md:grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs font-medium">Linea</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'linea', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                <option value="Piano" ${bld.rivestimentoInt?.linea === 'Piano' ? 'selected' : ''}>Piano</option>
                                <option value="Fugato" ${bld.rivestimentoInt?.linea === 'Fugato' ? 'selected' : ''}>Fugato</option>
                                <option value="Pantografato" ${bld.rivestimentoInt?.linea === 'Pantografato' ? 'selected' : ''}>Pantografato</option>
                                <option value="Tekno" ${bld.rivestimentoInt?.linea === 'Tekno' ? 'selected' : ''}>Tekno</option>
                                <option value="LegnoVivo" ${bld.rivestimentoInt?.linea === 'LegnoVivo' ? 'selected' : ''}>Legno Vivo</option>
                                <option value="Massello" ${bld.rivestimentoInt?.linea === 'Massello' ? 'selected' : ''}>Massello</option>
                                <option value="Alluminio" ${bld.rivestimentoInt?.linea === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Modello</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'modello', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                ${getModelliRivestimento(bld.rivestimentoInt?.linea).map(m => 
                                    `<option value="${m}" ${bld.rivestimentoInt?.modello === m ? 'selected' : ''}>${m}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Essenza</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'essenza', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                ${getEssenzeRivestimento(bld.rivestimentoInt?.linea, bld.rivestimentoInt?.modello).map(e => 
                                    `<option value="${e}" ${bld.rivestimentoInt?.essenza === e ? 'selected' : ''}>${e}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Tinta</label>
                            <input type="text" 
                                   value="${bld.rivestimentoInt?.tinta || ''}"
                                   onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Int', 'tinta', this.value)"
                                   placeholder="es. Naturale, RAL..."
                                   class="w-full compact-input border rounded mt-1 text-sm">
                        </div>
                    </div>
                </div>
                
                <!-- RIVESTIMENTO ESTERNO -->
                <div class="bg-yellow-100 rounded-lg p-3">
                    <h6 class="font-medium text-yellow-900 mb-2">ğŸ“‹ Esterno</h6>
                    <div class="grid md:grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs font-medium">Linea</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'linea', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                <option value="Piano" ${bld.rivestimentoEst?.linea === 'Piano' ? 'selected' : ''}>Piano</option>
                                <option value="Fugato" ${bld.rivestimentoEst?.linea === 'Fugato' ? 'selected' : ''}>Fugato</option>
                                <option value="Pantografato" ${bld.rivestimentoEst?.linea === 'Pantografato' ? 'selected' : ''}>Pantografato</option>
                                <option value="Tekno" ${bld.rivestimentoEst?.linea === 'Tekno' ? 'selected' : ''}>Tekno</option>
                                <option value="LegnoVivo" ${bld.rivestimentoEst?.linea === 'LegnoVivo' ? 'selected' : ''}>Legno Vivo</option>
                                <option value="Massello" ${bld.rivestimentoEst?.linea === 'Massello' ? 'selected' : ''}>Massello</option>
                                <option value="Alluminio" ${bld.rivestimentoEst?.linea === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Modello</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'modello', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                ${getModelliRivestimento(bld.rivestimentoEst?.linea).map(m => 
                                    `<option value="${m}" ${bld.rivestimentoEst?.modello === m ? 'selected' : ''}>${m}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Essenza</label>
                            <select onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'essenza', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="">Seleziona...</option>
                                ${getEssenzeRivestimento(bld.rivestimentoEst?.linea, bld.rivestimentoEst?.modello).map(e => 
                                    `<option value="${e}" ${bld.rivestimentoEst?.essenza === e ? 'selected' : ''}>${e}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-medium">Tinta</label>
                            <input type="text" 
                                   value="${bld.rivestimentoEst?.tinta || ''}"
                                   onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'tinta', this.value)"
                                   placeholder="es. Naturale, RAL..."
                                   class="w-full compact-input border rounded mt-1 text-sm">
                        </div>
                    </div>
                    <!-- VERNICIATURA ESTERNI -->
                    <div class="mt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" 
                                   ${bld.rivestimentoEst?.verniciatura ? 'checked' : ''}
                                   onchange="updateIngressoBlindataRiv('${project.id}', '${pos.id}', 'Est', 'verniciatura', this.checked)"
                                   class="w-4 h-4">
                            <span class="text-sm font-medium">ğŸŒ§ï¸ Verniciatura per esterni (+â‚¬150)</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- ğŸšª CORNICI E IMBOTTI (v5.13) -->
            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                <h5 class="font-semibold text-teal-800 mb-3">ğŸšª Cornici e Imbotti</h5>
                
                <!-- IMBOTTE ESTERNO -->
                <div class="bg-teal-100 rounded-lg p-3 mb-3">
                    <h6 class="font-medium text-teal-900 mb-2">ğŸ“ Imbotte Esterno</h6>
                    <div class="grid md:grid-cols-4 gap-2">
                        <div>
                            <label class="text-xs font-medium">Tipo</label>
                            <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEst', this.value)"
                                    class="w-full compact-input border rounded mt-1 text-sm">
                                <option value="" ${!bld.imbotteEst ? 'selected' : ''}>Nessuno</option>
                                <option value="imbotte_cornici" ${bld.imbotteEst === 'imbotte_cornici' ? 'selected' : ''}>Imbotte con Cornici</option>
                                <option value="solo_cornici" ${bld.imbotteEst === 'solo_cornici' ? 'selected' : ''}>Solo Cornici</option>
                            </select>
                        </div>
                        ${bld.imbotteEst === 'imbotte_cornici' ? `
                            <div>
                                <label class="text-xs font-medium">Altezza</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstAltezza', this.value)"
                                        class="w-full compact-input border rounded mt-1 text-sm">
                                    <option value="">Seleziona...</option>
                                    <option value="H1" ${bld.imbotteEstAltezza === 'H1' ? 'selected' : ''}>H1 (230+230+115 cm)</option>
                                    <option value="H2" ${bld.imbotteEstAltezza === 'H2' ? 'selected' : ''}>H2 (300+300+150 cm)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Larghezza</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstLargh', this.value)"
                                        class="w-full compact-input border rounded mt-1 text-sm">
                                    <option value="">Seleziona...</option>
                                    <option value="L20" ${bld.imbotteEstLargh === 'L20' ? 'selected' : ''}>20 cm</option>
                                    <option value="L30" ${bld.imbotteEstLargh === 'L30' ? 'selected' : ''}>30 cm</option>
                                    <option value="custom" ${bld.imbotteEstLargh === 'custom' ? 'selected' : ''}>Personalizzata</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Essenza</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'imbotteEstEssenza', this.value)"
                                        class="w-full compact-input border rounded mt-1 text-sm">
                                    <option value="">Seleziona...</option>
                                    <option value="tangMog" ${bld.imbotteEstEssenza === 'tangMog' ? 'selected' : ''}>Mogano/Tanganica</option>
                                    <option value="rovNoce" ${bld.imbotteEstEssenza === 'rovNoce' ? 'selected' : ''}>Rovere/Noce Naz.</option>
                                    <option value="laccato" ${bld.imbotteEstEssenza === 'laccato' ? 'selected' : ''}>Laccato Bianco/RAL</option>
                                    <option value="okoume" ${bld.imbotteEstEssenza === 'okoume' ? 'selected' : ''}>OkoumÃ¨</option>
                                    <option value="okoumeRAL" ${bld.imbotteEstEssenza === 'okoumeRAL' ? 'selected' : ''}>OkoumÃ¨ Laccato RAL</option>
                                </select>
                            </div>
                        ` : ''}
                        ${bld.imbotteEst === 'solo_cornici' ? `
                            <div>
                                <label class="text-xs font-medium">Tipo Cornice</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniceEstTipo', this.value)"
                                        class="w-full compact-input border rounded mt-1 text-sm">
                                    <option value="">Seleziona...</option>
                                    <option value="CF1" ${bld.corniceEstTipo === 'CF1' ? 'selected' : ''}>CF1 70x10mm</option>
                                    <option value="CF2" ${bld.corniceEstTipo === 'CF2' ? 'selected' : ''}>CF2 90x10mm</option>
                                    <option value="CT1" ${bld.corniceEstTipo === 'CT1' ? 'selected' : ''}>CT1 Copritelaio</option>
                                    <option value="CC2" ${bld.corniceEstTipo === 'CC2' ? 'selected' : ''}>CC2 Copritubolari 120x10</option>
                                    <option value="CC3" ${bld.corniceEstTipo === 'CC3' ? 'selected' : ''}>CC3 Copritubolari 180x10</option>
                                    <option value="KIT_ALU_70" ${bld.corniceEstTipo === 'KIT_ALU_70' ? 'selected' : ''}>Kit Alluminio 70x10</option>
                                    <option value="KIT_ALU_90" ${bld.corniceEstTipo === 'KIT_ALU_90' ? 'selected' : ''}>Kit Alluminio 90x10</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Essenza/Finitura</label>
                                <select onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniceEstEssenza', this.value)"
                                        class="w-full compact-input border rounded mt-1 text-sm">
                                    <option value="">Seleziona...</option>
                                    ${bld.corniceEstTipo?.startsWith('KIT_ALU') ? `
                                        <option value="polveri" ${bld.corniceEstEssenza === 'polveri' ? 'selected' : ''}>Colori OIKOS Polveri</option>
                                        <option value="evergreen" ${bld.corniceEstEssenza === 'evergreen' ? 'selected' : ''}>OIKOS Evergreen</option>
                                        <option value="future" ${bld.corniceEstEssenza === 'future' ? 'selected' : ''}>OIKOS Future</option>
                                        <option value="liquido" ${bld.corniceEstEssenza === 'liquido' ? 'selected' : ''}>OIKOS Liquido</option>
                                        <option value="spazzolato" ${bld.corniceEstEssenza === 'spazzolato' ? 'selected' : ''}>Alluminio Spazzolato</option>
                                    ` : `
                                        <option value="tangMog" ${bld.corniceEstEssenza === 'tangMog' ? 'selected' : ''}>Tanganica/Mogano</option>
                                        <option value="rovNoce" ${bld.corniceEstEssenza === 'rovNoce' ? 'selected' : ''}>Rovere/Noce</option>
                                        <option value="okoume" ${bld.corniceEstEssenza === 'okoume' ? 'selected' : ''}>OkoumÃ¨</option>
                                        <option value="laccRAL" ${bld.corniceEstEssenza === 'laccRAL' ? 'selected' : ''}>Laccato RAL</option>
                                    `}
                                </select>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- CORNICI INTERNE FERMA PANNELLO -->
                <div class="bg-cyan-100 rounded-lg p-3">
                    <h6 class="font-medium text-cyan-900 mb-2">ğŸ“ Cornici in Legno Ferma Pannello (interno)</h6>
                    <div class="grid md:grid-cols-2 gap-2">
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" 
                                       ${bld.corniciFermaPannello ? 'checked' : ''}
                                       onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'corniciFermaPannello', this.checked)"
                                       class="w-4 h-4">
                                <span class="text-sm font-medium">Aggiungi cornici ferma pannello</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">
                                ${bld.tipoAnta === 'doppia' ? 'â‚¬228 (doppia anta)' : 'â‚¬114 (anta singola)'} - Luce 0-4
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“ NOTE -->
            <div>
                <label class="text-xs font-medium">ğŸ“ Note</label>
                <textarea onchange="updateIngressoData('${project.id}', '${pos.id}', 'blindata', 'note', this.value)"
                          placeholder="Note aggiuntive..." class="w-full compact-input border rounded mt-1 h-16">${bld.note || ''}</textarea>
            </div>
        </div>
    `;
}

// ğŸšª Funzioni update per ingresso
window.updateIngresso = function(projectId, positionId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos) return;
    
    if (!pos.ingresso) pos.ingresso = {};
    pos.ingresso[field] = value;
    
    // v5.12: Quando si cambia tipo, PULISCI l'altro tipo per evitare confusione export
    if (field === 'tipo') {
        if (value === 'portoncino') {
            // Passa a portoncino â†’ elimina blindata
            delete pos.ingresso.blindata;
            if (!pos.ingresso.portoncino) {
                pos.ingresso.portoncino = { azienda: 'Finstral' };
            }
            console.log('ğŸšª Tipo cambiato a PORTONCINO - rimossa config blindata');
        }
        if (value === 'blindata') {
            // Passa a blindata â†’ elimina portoncino
            delete pos.ingresso.portoncino;
            if (!pos.ingresso.blindata) {
                pos.ingresso.blindata = { 
                    azienda: 'Oikos', 
                    tipoAnta: 'singola', 
                    cilindro: 'BASIC',
                    tipoCilindro: 'pomolo-chiave',
                    numChiavi: '3',
                    coloreTelaio: 'RAL8022',
                    manigliaInt: 'MO-05',
                    finituraInt: 'OL',
                    manigliaEst: 'PO-05',
                    finituraEst: 'OL',
                    acustica: 'serie',
                    termica: 'serie',
                    kitAAV: '',
                    vetro: { attivo: false, tipo: '', finitura: 'trasparente', termico: false },
                    sopraluce: { attivo: false, altezza: '', sabbiato: false },
                    fiancoluce: { attivo: false, conVetro: false, sabbiato: false, colore: 'RAL8022' },
                    rivestimentoInt: { linea: '', modello: '', essenza: '', tinta: '' },
                    rivestimentoEst: { linea: '', modello: '', essenza: '', tinta: '', verniciatura: false }
                };
            }
            console.log('ğŸ” Tipo cambiato a BLINDATA - rimossa config portoncino');
        }
        if (value === '') {
            // Nessun tipo selezionato â†’ pulisci tutto
            delete pos.ingresso.portoncino;
            delete pos.ingresso.blindata;
            console.log('ğŸšª Tipo rimosso - pulite tutte le config');
        }
    }
    
    console.log(`ğŸšª ingresso.${field} = ${value}`);
    saveState();
    render();
};

window.updateIngressoData = function(projectId, positionId, prodotto, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.ingresso) return;
    
    if (!pos.ingresso[prodotto]) pos.ingresso[prodotto] = {};
    pos.ingresso[prodotto][field] = value;
    
    // Calcola luce per blindata
    if (prodotto === 'blindata' && (field === 'LNP_L' || field === 'LNP_H')) {
        const L = parseFloat(pos.ingresso.blindata.LNP_L) || 0;
        const H = parseFloat(pos.ingresso.blindata.LNP_H) || 0;
        if (typeof calcolaLuceOikos === 'function') {
            pos.ingresso.blindata.luceCalcolata = calcolaLuceOikos(L, H);
        }
    }
    
    console.log(`ğŸšª ingresso.${prodotto}.${field} = ${value}`);
    saveState();
    render();
};

// v5.12: Update Optional per blindata in ingresso
window.updateIngressoBlindataOpt = function(projectId, positionId, optional, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.ingresso || !pos.ingresso.blindata) return;
    
    if (!pos.ingresso.blindata[optional]) {
        pos.ingresso.blindata[optional] = {};
    }
    
    pos.ingresso.blindata[optional][field] = value;
    console.log(`ğŸ” ingresso.blindata.${optional}.${field} = ${value}`);
    saveState();
    render();
};

// v5.12: Update Rivestimenti per blindata in ingresso
window.updateIngressoBlindataRiv = function(projectId, positionId, tipo, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.ingresso || !pos.ingresso.blindata) return;
    
    const rivKey = `rivestimento${tipo}`;
    if (!pos.ingresso.blindata[rivKey]) {
        pos.ingresso.blindata[rivKey] = {};
    }
    
    pos.ingresso.blindata[rivKey][field] = value;
    
    // Pulisci campi dipendenti quando cambia linea
    if (field === 'linea') {
        pos.ingresso.blindata[rivKey].modello = '';
        pos.ingresso.blindata[rivKey].essenza = '';
        pos.ingresso.blindata[rivKey].tinta = '';
    }
    // Pulisci essenza quando cambia modello
    if (field === 'modello') {
        pos.ingresso.blindata[rivKey].essenza = '';
        pos.ingresso.blindata[rivKey].tinta = '';
    }
    
    console.log(`ğŸ¨ ingresso.blindata.${rivKey}.${field} = ${value}`);
    saveState();
    render();
};

// ğŸ†• FASE 014 - Helper per verificare se rilievo posizione Ã¨ diverso da globale
function isRilievoPersonalizzato(project, pos, productType) {
    // FIX: Per infissi il campo Ã¨ 'rilievo', per altri prodotti Ã¨ 'rilievo[Prodotto]'
    const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const rilievoPos = pos[rilievoKey];
    const rilievoGlobale = getRilievoGlobale(project, productType);
    
    // Se non esiste il rilievo posizione, non Ã¨ personalizzato
    if (!rilievoPos) return false;
    
    // Confronta tutti i campi
    const campiDiversi = [];
    
    if (rilievoPos.materiale !== rilievoGlobale.materiale) {
        campiDiversi.push('Materiale');
    }
    if (rilievoPos.note !== rilievoGlobale.note) {
        campiDiversi.push('Note');
    }
    if (rilievoPos.togliere !== rilievoGlobale.togliere) {
        campiDiversi.push('Togliere');
    }
    if (rilievoPos.smaltimento !== rilievoGlobale.smaltimento) {
        campiDiversi.push('Smaltimento');
    }
    if (productType === 'infissi') {
        if (rilievoPos.coprifiliInt !== rilievoGlobale.coprifiliInt) {
            campiDiversi.push('Coprifili INT');
        }
        if (rilievoPos.coprifiliEst !== rilievoGlobale.coprifiliEst) {
            campiDiversi.push('Coprifili EST');
        }
    }
    
    return {
        isPersonalizzato: campiDiversi.length > 0,
        campiDiversi: campiDiversi
    };
}

function renderRilievoPerProdotto(project, pos, productType, productLabel, hasCoprifili) {
    // FIX: Per infissi il campo Ã¨ 'rilievo', per altri prodotti Ã¨ 'rilievo[Prodotto]'
    const rilievoKey = productType === 'infissi' ? 'rilievo' : `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
    const r = pos[rilievoKey] || {};
    
    // ğŸ†• FASE 014 - Controlla se rilievo Ã¨ personalizzato
    const personalizz = isRilievoPersonalizzato(project, pos, productType);
    
    // Calcola completezza specifica per questo prodotto
    let completed = 0;
    let total = 3; // materiale, togliere, smaltimento
    if (hasCoprifili) total = 5; // + coprifiliInt, coprifiliEst
    
    if (r.materiale && r.materiale.trim() !== '') completed++;
    if (r.togliere !== undefined && r.togliere !== null) completed++;
    if (r.smaltimento !== undefined && r.smaltimento !== null) completed++;
    if (hasCoprifili) {
        if (r.coprifiliInt !== undefined && r.coprifiliInt !== null) completed++;
        if (r.coprifiliEst !== undefined && r.coprifiliEst !== null) completed++;
    }
    
    const percentage = Math.round((completed / total) * 100);
    
    // Determina status
    let icon, color, statusText, badge;
    if (percentage === 0) {
        icon = 'âšª'; color = 'gray'; statusText = 'NON INIZIATO'; badge = 'bg-gray-500';
    } else if (percentage < 50) {
        icon = 'ğŸ”´'; color = 'red'; statusText = 'INCOMPLETO'; badge = 'bg-red-500';
    } else if (percentage < 100) {
        icon = 'ğŸŸ¡'; color = 'amber'; statusText = 'PARZIALE'; badge = 'bg-amber-500';
    } else {
        icon = 'ğŸŸ¢'; color = 'green'; statusText = 'COMPLETO'; badge = 'bg-green-500';
    }
    
    const uniqueId = `${pos.id}-${productType}`;
    const collapseId = `rilievo-collapse-${uniqueId}`;
    
    return `
        <!-- ğŸ†• FASE 014: Pulsante per mostrare/nascondere rilievo -->
        <div class="mb-4">
            <button onclick="document.getElementById('${collapseId}').style.display = document.getElementById('${collapseId}').style.display === 'none' ? 'block' : 'none'; this.innerHTML = document.getElementById('${collapseId}').style.display === 'none' ? 'RILIEVO PREESISTENTE - ${productLabel}' : 'âœ– Nascondi Rilievo';"
                    class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 border-2 ${personalizz.isPersonalizzato ? 'border-orange-400' : 'border-gray-300'} rounded-lg font-semibold text-sm transition flex items-center justify-between">
                <span>RILIEVO PREESISTENTE - ${productLabel}</span>
                ${personalizz.isPersonalizzato ? `
                    <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">
                        âš ï¸ PERSONALIZZATO
                    </span>
                ` : ''}
            </button>
        </div>
        
        <!-- ğŸ†• FASE 014: Sezione rilievo COLLASSATA per default -->
        <div id="${collapseId}" style="display: none;">
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 ${color === 'green' ? 'border-green-400' : color === 'amber' ? 'border-amber-400' : color === 'red' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4 shadow-md mb-4">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            ğŸ“‹ RILIEVO PREESISTENTE - ${productLabel}
                        </h3>
                        <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                        ${personalizz.isPersonalizzato ? `
                            <p class="text-xs text-orange-700 font-semibold mt-1">
                                âš ï¸ Diverso dal globale: ${personalizz.campiDiversi.join(', ')}
                            </p>
                        ` : ''}
                    </div>
                    <div class="flex flex-col items-end gap-2">
                        <button onclick="copiaRilievoDaGlobaleProdotto('${project.id}', '${pos.id}', '${productType}')"
                                class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-semibold transition"
                                title="Copia solo dati Rilievo Preesistente (togliere, materiale, ecc.)">
                            ğŸ“¥ Copia Rilievo
                        </button>
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-2xl">${icon}</span>
                                <span class="text-sm font-bold text-${color}-700">${statusText}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="${badge} h-full transition-all duration-500" 
                                         style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold">${percentage}%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${completed}/${total} campi</p>
                        </div>
                    </div>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- 1. MATERIALE -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-semibold flex items-center gap-2">
                                ğŸ”§ Materiale
                                ${!r.materiale || r.materiale.trim() === '' ? '<span class="text-red-600">â—</span>' : '<span class="text-green-600">âœ“</span>'}
                            </label>
                            <button onclick="toggleMaterialeProdottoMode('${uniqueId}')" 
                                    id="materiale-toggle-${uniqueId}"
                                    class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                                âœï¸ Scrivi
                            </button>
                        </div>
                        
                        <!-- SELECT MODE (default) -->
                        <select id="materiale-select-${uniqueId}"
                                onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                                class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Seleziona...</option>
                            <option value="Legno" ${r.materiale === 'Legno' ? 'selected' : ''}>Legno</option>
                            <option value="PVC" ${r.materiale === 'PVC' ? 'selected' : ''}>PVC</option>
                            <option value="Alluminio" ${r.materiale === 'Alluminio' ? 'selected' : ''}>Alluminio</option>
                            <option value="Ferro" ${r.materiale === 'Ferro' ? 'selected' : ''}>Ferro</option>
                        </select>
                        
                        <!-- INPUT MODE (hidden by default) -->
                        <input type="text" 
                               id="materiale-input-${uniqueId}"
                               value="${r.materiale || ''}"
                               oninput="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', this.value)"
                               placeholder="Inserisci materiale..."
                               style="display: none;"
                               class="w-full px-3 py-2 border-2 ${!r.materiale || r.materiale.trim() === '' ? 'border-red-300 bg-red-50' : 'border-green-300 bg-white'} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    ${productType === 'tapparella' ? `
                    <!-- 2. TIPO AUTOMAZIONE (solo per Tapparelle) -->
                    <div>
                        <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                            âš™ï¸ Tipo Automazione
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button"
                                    onclick="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'tipo', 'Manuale')"
                                    class="px-4 py-3 rounded-lg border-2 font-semibold transition ${r.tipo === 'Manuale' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}">
                                ğŸ–ï¸ Manuale
                            </button>
                            <button type="button"
                                    onclick="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'tipo', 'Motorizzata')"
                                    class="px-4 py-3 rounded-lg border-2 font-semibold transition ${r.tipo === 'Motorizzata' ? 'bg-blue-500 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400'}">
                                âš¡ Motorizzata
                            </button>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- 3. NOTE AGGIUNTIVE -->
                    <div>
                        <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                            ğŸ“ Note
                        </label>
                        <input type="text" 
                               value="${r.note || ''}"
                               onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'note', this.value)"
                               placeholder="Note aggiuntive..."
                               class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div class="grid ${hasCoprifili ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                    <!-- ğŸ”„ v5.743: PULSANTI 3 STATI -->
                    
                    <!-- DA TOGLIERE -->
                    <button type="button"
                            onclick="ciclaFlagRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'togliere')"
                            class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                   ${r.togliere === 'si' ? 'bg-green-100 border-green-400' : 
                                     r.togliere === 'no' ? 'bg-red-100 border-red-400' : 
                                     'bg-gray-100 border-gray-300'}
                                   hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                        <span class="text-sm font-semibold flex items-center gap-2">
                            ğŸ”¨ Da togliere?
                        </span>
                        <span class="text-xl font-bold min-w-[28px] text-center
                                     ${r.togliere === 'si' ? 'text-green-700' : 
                                       r.togliere === 'no' ? 'text-red-700' : 
                                       'text-gray-500'}">
                            ${r.togliere === 'si' ? 'âœ“' : r.togliere === 'no' ? 'âœ—' : 'â—‹'}
                        </span>
                    </button>
                    
                    <!-- DA SMALTIRE -->
                    <button type="button"
                            onclick="ciclaFlagRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'smaltimento')"
                            class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                   ${r.smaltimento === 'si' ? 'bg-green-100 border-green-400' : 
                                     r.smaltimento === 'no' ? 'bg-red-100 border-red-400' : 
                                     'bg-gray-100 border-gray-300'}
                                   hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                        <span class="text-sm font-semibold flex items-center gap-2">
                            ğŸ—‘ï¸ Da smaltire?
                        </span>
                        <span class="text-xl font-bold min-w-[28px] text-center
                                     ${r.smaltimento === 'si' ? 'text-green-700' : 
                                       r.smaltimento === 'no' ? 'text-red-700' : 
                                       'text-gray-500'}">
                            ${r.smaltimento === 'si' ? 'âœ“' : r.smaltimento === 'no' ? 'âœ—' : 'â—‹'}
                        </span>
                    </button>
                    
                    ${hasCoprifili ? `
                        <!-- COPRIFILI INT -->
                        <div class="flex flex-col gap-2">
                            <button type="button"
                                    onclick="ciclaFlagRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliInt')"
                                    class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                           ${r.coprifiliInt === 'si' ? 'bg-green-100 border-green-400' : 
                                             r.coprifiliInt === 'no' ? 'bg-red-100 border-red-400' : 
                                             'bg-gray-100 border-gray-300'}
                                           hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                                <span class="text-sm font-semibold flex items-center gap-2">
                                    ğŸ“ Coprifili INT?
                                </span>
                                <span class="text-xl font-bold min-w-[28px] text-center
                                             ${r.coprifiliInt === 'si' ? 'text-green-700' : 
                                               r.coprifiliInt === 'no' ? 'text-red-700' : 
                                               'text-gray-500'}">
                                    ${r.coprifiliInt === 'si' ? 'âœ“' : r.coprifiliInt === 'no' ? 'âœ—' : 'â—‹'}
                                </span>
                            </button>
                            ${r.coprifiliInt === 'si' ? `
                                <input type="text" 
                                       value="${r.coprifiliIntNote || ''}"
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliIntNote', this.value)"
                                       placeholder="Descrizione coprifili INT..."
                                       class="w-full px-2 py-1 text-sm border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-green-50">
                            ` : ''}
                        </div>
                        
                        <!-- COPRIFILI EST -->
                        <div class="flex flex-col gap-2">
                            <button type="button"
                                    onclick="ciclaFlagRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliEst')"
                                    class="flex items-center justify-between gap-2 p-3 rounded-lg border-2 
                                           ${r.coprifiliEst === 'si' ? 'bg-green-100 border-green-400' : 
                                             r.coprifiliEst === 'no' ? 'bg-red-100 border-red-400' : 
                                             'bg-gray-100 border-gray-300'}
                                           hover:shadow-md transition-all duration-200 w-full text-left cursor-pointer">
                                <span class="text-sm font-semibold flex items-center gap-2">
                                    ğŸ“ Coprifili EST?
                                </span>
                                <span class="text-xl font-bold min-w-[28px] text-center
                                             ${r.coprifiliEst === 'si' ? 'text-green-700' : 
                                               r.coprifiliEst === 'no' ? 'text-red-700' : 
                                               'text-gray-500'}">
                                    ${r.coprifiliEst === 'si' ? 'âœ“' : r.coprifiliEst === 'no' ? 'âœ—' : 'â—‹'}
                                </span>
                            </button>
                            ${r.coprifiliEst === 'si' ? `
                                <input type="text" 
                                       value="${r.coprifiliEstNote || ''}"
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliEstNote', this.value)"
                                       placeholder="Descrizione coprifili EST..."
                                       class="w-full px-2 py-1 text-sm border-2 border-green-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-green-50">
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
                
                ${percentage < 100 ? `
                    <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                        âš ï¸ <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                    </div>
                ` : `
                    <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                        âœ… <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                    </div>
                `}
            </div>
        </div>
    `;
}

// ============================================
// ğŸ” DATABASE RIVESTIMENTI OIKOS (v5.00)
// ============================================
const OIKOS_RIVESTIMENTI = {
    // LINEA PIANO
    Piano: {
        modelli: ['Di Serie', 'Non di serie', 'Materici', 'Orizzontale', 'Verticale', 'Gres', 'Riflessi Vetro'],
        essenze: {
            'Di Serie': ['Tanganica 1-2', 'Mogano 2-3', 'Laccato Bianco Oikos', 'Rovere 1', 'Noce Nazionale 2', 'MDF da Laccare', 'Supporto Cliente'],
            // ğŸ” v5.15: Non di serie - Impiallacciati verticale tranciato legno
            'Non di serie': ['Rovere Naturale 2-3', 'Rovere Miele', 'Rovere WengÃ¨', 'Rovere Sbiancato', 'Tanganica 3', 'Castagno 2-3', 'Douglas 2', 'Pino 2', 'Noce Canaletto', 'Teak', 'Laccato RAL', 'Altre Essenze'],
            'Materici': ['Bianco Talco', 'Grigio Talco', 'Bianco SablÃ¨', 'Grigio SablÃ¨', 'Bianco Rovere SablÃ¨', 'Grigio Rovere SablÃ¨'],
            'Orizzontale': ['Rovere Naturale', 'Rovere Miele', 'Rovere WengÃ¨', 'Rovere Sbiancato', 'Tanganica', 'Noce Canaletto', 'Teak', 'Laccato RAL'],
            'Verticale': ['Laccato Tendenza Poro Aperto', 'Spazzolato Rovere', 'Laccato Metallizzato', 'Rovere Raw'],
            'Gres': ['Neve', 'Nero Assoluto', 'Calce Bianco', 'Calce Grigio', 'Calce Tortora', 'Cor-Ten Ruggine', 'Cemento Liscio', 'Ardesia', 'Pietra Piasentina'],
            'Riflessi Vetro': ['Bianco Panna', 'Bianco', 'Bianco Gesso', 'Grigio', 'Bronzo', 'Tabacco', 'Moka', 'Nero', 'Platino', 'Oro']
        },
        tinte: {
            'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'WengÃ¨', 'Sbiancato'],
            'Laccato': ['Bianco', 'RAL a richiesta'],
            'Spazzolato': ['Bianco Gesso', 'Madreperla', 'Grigio Agata', 'Tabacco', 'Quercia Antica', 'Grigio Piombo']
        },
        prezziBase: {
            'Di Serie': { luce0: 192, luce1: 192, luce2: 235, luce3: 346, luce4: 414 },
            // ğŸ” v5.15: Non di serie - Prezzi ANTA UNICA (pag. 99 listino EVO 2025)
            // Luce 5/6 = Doppia Anta Tekno, Luce 3/4 = Doppia Anta Evolution
            'Non di serie': { 
                luce0: 405, luce1: 405, luce2: 483, // Rovere/Tanganica/Castagno/Douglas/Pino/Laccato RAL
                luce5: 526, luce6: 585, luce3: 626, luce4: 811, luce7: 1104, luce8: 1333 
            },
            'Non di serie Noce Canaletto': { 
                luce0: 458, luce1: 458, luce2: 545, 
                luce5: 594, luce6: 660, luce3: 700, luce4: 889, luce7: 1101, luce8: 1317 
            },
            'Non di serie Teak': { 
                luce0: 520, luce1: 520, luce2: 620, 
                luce5: 675, luce6: 750, luce3: 782, luce4: 1005, luce7: 1243, luce8: 1488 
            },
            'Non di serie Altre Essenze': { 
                luce0: 486, luce1: 486, luce2: 579, 
                luce5: 631, luce6: 702, luce3: 751, luce4: 973, luce7: 1324, luce8: 1599 
            },
            'Materici': { luce0: 170, luce1: 170, luce2: 170 },
            'Orizzontale': { luce0: 543, luce1: 543, luce2: 647 },
            'Verticale': { luce0: 459, luce1: 459, luce2: 547 },
            'Gres': { luce0: 1304, luce1: 1347, luce2: 1436 },
            'Riflessi Vetro': { luce0: 1197, luce1: 1322, luce2: 1534 }
        }
    },
    // LINEA FUGATO
    Fugato: {
        modelli: ['Verticale', 'HTF', 'HTA', 'Scala'],
        essenze: {
            'Verticale': ['Mogano 2-3', 'Tanganica 2', 'Pino Nodo 2', 'Douglas 2', 'Rovere 1-2-3', 'Laccato RAL'],
            'HTF': ['Tanganica 1', 'Mogano 2', 'Rovere 1-2-3', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
            'HTA': ['Tanganica 1', 'Mogano 2', 'Rovere 1-2-3', 'Laccato RAL', 'Spazzolato Rovere', 'Rovere Raw'],
            'Scala': ['Mogano 2-3', 'Tanganica 2', 'Pino Nodo 2', 'Douglas 2', 'Rovere 1-2-3', 'Laccato RAL']
        },
        tinte: {
            'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'WengÃ¨', 'Sbiancato'],
            'Laccato': ['RAL a richiesta']
        },
        prezziBase: {
            'Verticale': { luce0: 592, luce1: 592, luce2: 706, luce3: 894, luce4: 1156 },
            'HTF': { luce0: 636, luce1: 636, luce2: 758, luce3: 1092, luce4: 1317 },
            'HTA': { luce0: 786, luce1: 786, luce2: 908, luce3: 1242, luce4: 1467 },
            'Scala': { luce0: 821, luce1: 821, luce2: 979, luce3: 1222, luce4: 1579 }
        }
    },
    // LINEA PANTOGRAFATO
    Pantografato: {
        modelli: ['NP Country', 'SR Country', 'MDF Laccato'],
        essenze: {
            'NP Country': ['OkoumÃ¨ Tinta 6-7-8', 'OkoumÃ¨ Mogano', 'OkoumÃ¨ Laccato RAL'],
            'SR Country': ['OkoumÃ¨ Tinta 6-7-8', 'OkoumÃ¨ Mogano', 'OkoumÃ¨ Laccato RAL'],
            'MDF Laccato': ['MDF Laccato RAL']
        },
        disegni: ['Toscana', 'Milano', 'Gardenia', 'Impero', 'Genova', 'Isola', '800 Veneto', 'Classica', 'Victoria', 'Geranio', 'Glicine', 'Ciclamino', 'Giglio', 'Iris', 'Narciso'],
        prezziBase: {
            'NP Country': { luce0: 791, luce1: 791, luce2: 968, luce3: 1235, luce4: 1477 },
            'SR Country': { luce0: 908, luce1: 908, luce2: 1104, luce3: 1399, luce4: 1688 },
            'MDF Laccato': { luce0: 622, luce1: 622, luce2: 728, luce3: 903, luce4: 1166 }
        }
    },
    // LINEA TEKNO
    Tekno: {
        modelli: ['HTA', 'HTO', 'HT1'],
        essenze: {
            'HTA': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
            'HTO': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere', 'Rovere Raw'],
            'HT1': ['Rovere Naturale', 'Rovere 1-2-3', 'Mogano 2', 'Tanganica 1', 'Laccato RAL', 'Laccato Tendenza', 'Spazzolato Rovere']
        },
        tinte: {
            'Rovere': ['Naturale', '1', '2', '3', 'Miele', 'WengÃ¨', 'Sbiancato'],
            'Laccato Tendenza': ['Bianco Seta', 'Bianco', 'Bianco Gesso', 'Grigio Ghiaia', 'Grigio Muschio', 'Moka', 'Grigio Piombo', 'Tabacco', 'Bronzo', 'Platino', 'Fumo', 'Oro', 'Rame'],
            'Spazzolato': ['Bianco Gesso', 'Madreperla', 'Grigio Agata', 'Tabacco', 'Quercia Antica', 'Grigio Piombo']
        },
        prezziBase: {
            'HTA': { luce0: 909, luce1: 1000, luce2: 1192 },
            'HTO': { luce0: 833, luce1: 915, luce2: 1091 },
            'HT1': { luce0: 909, luce1: 1000, luce2: 1192 }
        }
    },
    // LINEA LEGNO VIVO
    LegnoVivo: {
        modelli: ['Musa', 'Rialto', '800 Veneto', 'Classica', 'Toscana', 'Laguna'],
        essenze: {
            'standard': ['Bianco Gesso', 'Madreperla', 'Tabacco', 'Grigio Agata', 'Grigio Piombo', 'Quercia Antica', 'Rovere Naturale', 'Rovere 1', 'Rovere 2', 'Rovere 3', 'Rovere Miele', 'Laccato RAL']
        },
        note: 'Rovere Spazzolato - Verniciatura esterni compresa',
        prezziBase: {
            'Musa': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
            'Rialto': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
            '800 Veneto': { luce0: 1183, luce1: 1183, luce2: 1411, luce3: 1788, luce4: 2304 },
            'Classica': { luce0: 1281, luce1: 1281, luce2: 1527, luce3: 1928, luce4: 2484 },
            'Toscana': { luce0: 1281, luce1: 1281, luce2: 1527, luce3: 1928, luce4: 2484 },
            'Laguna': { luce0: 1561, luce1: 1561, luce2: 1860, luce3: 2327, luce4: 2999 }
        }
    },
    // LINEA MASSELLO
    Massello: {
        modelli: ['Massello Standard'],
        essenze: {
            'Massello Standard': ['Rovere', 'Noce', 'Castagno', 'Frassino']
        },
        note: 'Prezzi su richiesta'
    },
    // ALLUMINIO
    Alluminio: {
        modelli: ['Satinato', 'Spazzolato', 'Verniciato RAL'],
        colori: {
            'Satinato': ['Argento', 'Bronzo', 'Champagne'],
            'Spazzolato': ['Argento', 'Bronzo', 'Champagne', 'Nero'],
            'Verniciato RAL': ['RAL a richiesta']
        },
        note: 'Prezzi su richiesta'
    }
};

// ============================================
// ğŸ” DATABASE PANNELLI LINEA PIANO (v5.13)
// ============================================
// Mod. DI SERIE: truciolare/MDF 9mm impiallacciato + pelabile
// Mod. NON DI SERIE (falegnameria): senza pelabile, tinte mazzetta Oikos
const OIKOS_PANNELLI_PIANO = {
    // Essenze con prezzi per luce e tipo anta
    essenze: [
        { cod: 'ROV_NAT', nome: 'Rovere Naturale 2-3 / Miele / WengÃ¨ / Sbiancato', gruppo: 1 },
        { cod: 'TANG', nome: 'Tanganica 3', gruppo: 1 },
        { cod: 'CAST', nome: 'Castagno 2-3 / Douglas 2 / Pino 2', gruppo: 1 },
        { cod: 'NOCE', nome: 'Noce Canaletto', gruppo: 2 },
        { cod: 'TEAK', nome: 'Teak', gruppo: 3 },
        { cod: 'LACC_RAL', nome: 'Laccato RAL / Laccati di Tendenza', gruppo: 1 },
        { cod: 'ALTRE', nome: 'Altre Essenze a Conferma', gruppo: 4 },
        { cod: 'MDF_LACC', nome: 'MDF da Laccare (per porta Evolution EI)', gruppo: 5 },
        { cod: 'MDF_RAL', nome: 'MDF Laccato RAL (per porta Evolution EI)', gruppo: 6 }
    ],
    // Prezzi NON DI SERIE per gruppo
    prezzi: {
        // gruppo 1: Rovere, Tanganica, Castagno, Laccato RAL
        1: { 
            antaUnica: { luce01: 405, luce2: 483 },
            antaUnicaTekno: { luce5: 526, luce6: 585 },
            doppiaAntaEvolution: { luce3: 626, luce4: 811 },
            doppiaAntaTekno: { luce7: 1104, luce8: 1333 }
        },
        // gruppo 2: Noce Canaletto
        2: {
            antaUnica: { luce01: 458, luce2: 545 },
            antaUnicaTekno: { luce5: 594, luce6: 660 },
            doppiaAntaEvolution: { luce3: 700, luce4: 889 },
            doppiaAntaTekno: { luce7: 1101, luce8: 1317 }
        },
        // gruppo 3: Teak
        3: {
            antaUnica: { luce01: 520, luce2: 620 },
            antaUnicaTekno: { luce5: 675, luce6: 750 },
            doppiaAntaEvolution: { luce3: 782, luce4: 1005 },
            doppiaAntaTekno: { luce7: 1243, luce8: 1488 }
        },
        // gruppo 4: Altre Essenze a Conferma
        4: {
            antaUnica: { luce01: 486, luce2: 579 },
            antaUnicaTekno: { luce5: 631, luce6: 702 },
            doppiaAntaEvolution: { luce3: 751, luce4: 973 },
            doppiaAntaTekno: { luce7: 1324, luce8: 1599 }
        },
        // gruppo 5: MDF da Laccare (solo Luce 0-1)
        5: {
            antaUnica: { luce01: 171 }
        },
        // gruppo 6: MDF Laccato RAL (solo Luce 0-1)
        6: {
            antaUnica: { luce01: 475 }
        }
    },
    // Prezzi DI SERIE (base, giÃ  inclusi nel prezzo porta)
    diSerie: {
        essenze: ['Tanganica 1-2', 'Mogano 2-3', 'Laccato Bianco Oikos', 'Rovere 1', 'Noce Nazionale 2', 'MDF da Laccare', 'Supporto Cliente'],
        prezzi: {
            luce0: 192, luce1: 192, luce2: 235, luce3: 346, luce4: 414
        }
    }
};

// ============================================
// ğŸ” DATABASE CORNICI E IMBOTTI OIKOS (v5.13)
// ============================================
const OIKOS_CORNICI_IMBOTTI = {
    // CORNICI LINEARI IN ASTE (h = 2600mm)
    corniciAste: {
        tipi: [
            { cod: 'CF1', nome: 'CF1 70x10 impiallacciato', dim: '70x10mm' },
            { cod: 'CF2', nome: 'CF2 90x10 impiallacciato', dim: '90x10mm' },
            { cod: 'CT1', nome: 'CT1 copritelaio', dim: 'copritelaio' },
            { cod: 'CC2', nome: 'CC2 copritubolari 120x10', dim: '120x10mm' },
            { cod: 'CC3', nome: 'CC3 copritubolari 180x10', dim: '180x10mm' }
        ],
        prezzi: {
            // Prezzo per asta h=2600mm
            'CF1': { tangMog: 39, rovNoce: 47, okoume: 102, laccRAL: 142 },
            'CF2': { tangMog: 48, rovNoce: 52, okoume: 110, laccRAL: 162 },
            'CT1': { tangMog: 102, rovNoce: null, okoume: 114, laccRAL: 155 },
            'CC2': { tangMog: 140, rovNoce: 162, okoume: 167, laccRAL: 191 },
            'CC3': { tangMog: 196, rovNoce: 220, okoume: 227, laccRAL: 252 }
        },
        maggiorazioneH3000: 0.30 // +30% per aste h=3000mm
    },
    // KIT CORNICI IN ALLUMINIO (n.2 h=2600mm + n.1 h=1300mm)
    corniciAlluminio: {
        tipi: [
            { cod: 'KIT_ALU_70', nome: 'Kit Cornici Alluminio 70x10', dim: '70x10mm' },
            { cod: 'KIT_ALU_90', nome: 'Kit Cornici Alluminio 90x10', dim: '90x10mm' }
        ],
        prezzi: {
            'KIT_ALU_70': { polveri: 501, evergreen: 557, future: 694, liquido: 766, spazzolato: 501 },
            'KIT_ALU_90': { polveri: 552, evergreen: 609, future: 745, liquido: 814, spazzolato: 552 }
        }
    },
    // IMBOTTI CON CORNICI (in listellare impiallacciato + cornici 70x10mm)
    imbotti: {
        altezze: [
            { cod: 'H1', nome: 'Altezza 1 (230+230+115 cm)', desc: 'porte standard' },
            { cod: 'H2', nome: 'Altezza 2 (300+300+150 cm)', desc: 'porte alte' }
        ],
        larghezze: [
            { cod: 'L20', nome: '20 cm', valore: 20 },
            { cod: 'L30', nome: '30 cm', valore: 30 }
        ],
        prezzi: {
            // Mogano 2-3 / Tanganica 1-2
            'tangMog': { H1_L20: 600, H1_L30: 780, H2_L20: 706, H2_L30: 914 },
            // Rovere Naturale-1-2-3-Miele / Noce Nazionale 2
            'rovNoce': { H1_L20: 759, H1_L30: 925, H2_L20: 895, H2_L30: 1085 },
            // Laccato Bianco / Laccato RAL
            'laccato': { H1_L20: 600, H1_L30: 780, H2_L20: 706, H2_L30: 914 },
            // OkoumÃ¨ 6-7-8-Mogano
            'okoume': { H1_L20: 665, H1_L30: 870, H2_L20: 803, H2_L30: 1040 },
            // OkoumÃ¨ Laccato RAL
            'okoumeRAL': { H1_L20: 696, H1_L30: 917, H2_L20: 839, H2_L30: 1094 }
        },
        prezzoExtraCm: { H1: 18, H2: 20 } // â‚¬/cm in piÃ¹ di larghezza
    },
    // CORNICI FERMA PANNELLO INTERNO (su richiesta)
    corniciFermaPannello: {
        nota: 'Prezzo su richiesta - da aggiungere se richieste'
    }
};

// Helper per ottenere modelli per linea
function getModelliRivestimento(linea) {
    return OIKOS_RIVESTIMENTI[linea]?.modelli || [];
}

// Helper per ottenere essenze per linea/modello
function getEssenzeRivestimento(linea, modello) {
    const dati = OIKOS_RIVESTIMENTI[linea];
    if (!dati) return [];
    if (dati.essenze[modello]) return dati.essenze[modello];
    if (dati.essenze['standard']) return dati.essenze['standard'];
    return Object.values(dati.essenze)[0] || [];
}

// Helper per ottenere tinte per linea/essenza
function getTinteRivestimento(linea, essenza) {
    const dati = OIKOS_RIVESTIMENTI[linea];
    if (!dati || !dati.tinte) return [];
    // Cerca la categoria dell'essenza
    for (const [cat, tinte] of Object.entries(dati.tinte)) {
        if (essenza.toLowerCase().includes(cat.toLowerCase())) {
            return tinte;
        }
    }
    return [];
}

// ğŸ” v5.15: Calcola prezzo rivestimento per linea/modello/luce/essenza
function calcolaPrezzoRivestimento(linea, modello, luce, essenza = null) {
    if (!linea || !modello) return 0;
    const dati = OIKOS_RIVESTIMENTI[linea];
    if (!dati || !dati.prezziBase) return 0;
    
    // ğŸ” v5.15: Gestione speciale per "Non di serie" con prezzi diversi per essenza
    if (modello === 'Non di serie' && essenza) {
        let keyPrezzo = 'Non di serie'; // Default
        if (essenza.includes('Noce Canaletto')) {
            keyPrezzo = 'Non di serie Noce Canaletto';
        } else if (essenza.includes('Teak')) {
            keyPrezzo = 'Non di serie Teak';
        } else if (essenza.includes('Altre Essenze')) {
            keyPrezzo = 'Non di serie Altre Essenze';
        }
        const prezziModello = dati.prezziBase[keyPrezzo];
        if (prezziModello) {
            return prezziModello[luce] || prezziModello['luce0'] || 0;
        }
    }
    
    const prezziModello = dati.prezziBase[modello];
    if (!prezziModello) return 0;
    return prezziModello[luce] || prezziModello['luce0'] || 0;
}

// ============================================
// ğŸ” DATABASE OPTIONAL OIKOS (v5.03)
// ============================================
const OIKOS_OPTIONAL = {
    // VETRO BLINDATO (BR2 + P6B)
    vetroBlindato: {
        'V1': { trasparente: 2311, sabbiato: 2485 },
        'V2': { trasparente: 1757, sabbiato: 1871 },
        'V3': { trasparente: 1537, sabbiato: 1631 },
        'V4': { trasparente: 1537, sabbiato: 1631 },
        'V5': { trasparente: 1456, sabbiato: 1516 },
        'V50': { trasparente: 1537, sabbiato: 1631 }
    },
    // VETRO TERMICO SICUREZZA
    vetroTermico: {
        'V1': { trasparente: 2683, sabbiato: 2857 },
        'V2': { trasparente: 2030, sabbiato: 2144 },
        'V3': { trasparente: 1816, sabbiato: 1910 },
        'V4': { trasparente: 1816, sabbiato: 1910 },
        'V5': { trasparente: 1684, sabbiato: 1774 },
        'V50': { trasparente: 1816, sabbiato: 1910 }
    },
    // SOPRALUCE
    sopraluce: {
        'H500': { 'luce0': 931, 'luce1': 931, 'luce2': 977, 'luce3': 1208, 'luce4': 1413 },
        'H800': { 'luce0': 1330, 'luce1': 1330, 'luce2': 1454, 'luce3': 1754, 'luce4': 2053 },
        'controtelaio': { 'luce0': 350, 'luce1': 350, 'luce2': 374, 'luce3': 391, 'luce4': 404 },
        'sabbiato_H500': { 'luce0': 78, 'luce1': 78, 'luce2': 82, 'luce3': 105, 'luce4': 125 },
        'sabbiato_H800': { 'luce0': 120, 'luce1': 120, 'luce2': 132, 'luce3': 168, 'luce4': 200 }
    },
    // FIANCOLUCE
    fiancoluce: {
        senzaVetro: { 'luce1': 1166, 'luce2': 1308, 'luce3': 1388, 'luce4': 1540 },
        conVetro: { 'luce1': 2209, 'luce2': 2935, 'luce3': 3526, 'luce4': 4374 },
        sabbiato: { 'luce1': 170, 'luce2': 255, 'luce3': 312, 'luce4': 432 },
        colori: {
            'RAL8022': { 'luce1': 0, 'luce2': 0, 'luce3': 0, 'luce4': 0 },
            'OIKOS_Polveri': { 'luce1': 256, 'luce2': 290, 'luce3': 298, 'luce4': 336 },
            'OIKOS_Evergreen': { 'luce1': 336, 'luce2': 382, 'luce3': 392, 'luce4': 441 },
            'OIKOS_Future': { 'luce1': 404, 'luce2': 460, 'luce3': 472, 'luce4': 532 },
            'OIKOS_Liquido': { 'luce1': 512, 'luce2': 580, 'luce3': 596, 'luce4': 672 }
        }
    }
};


function renderMisureTab(project, pos) {
    const validation = validateMisure(project, pos);
    // ğŸ†• FASE 014 - Indicatore completamento real-time
    // ğŸ”§ FASE 014 - Passa project alle funzioni
    const comp = calculatePositionCompleteness(pos, project);
    const status = getPositionCompletenessStatus(pos, project);
    
    return `
        <div class="space-y-4">
            <!-- ğŸ†• FASE 014: Badge Completamento Real-time -->
            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 ${
                comp.percentage === 100 ? 'border-green-500' : 
                comp.percentage >= 70 ? 'border-amber-500' : 
                'border-orange-500'
            } rounded-lg p-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 mb-1">ğŸ“Š Completamento Posizione</h3>
                        <p class="text-xs text-gray-600">Controlla i dati mentre inserisci le misure</p>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-3xl">${status.icon}</span>
                            <span class="text-lg font-bold ${
                                comp.percentage === 100 ? 'text-green-700' : 
                                comp.percentage >= 70 ? 'text-amber-700' : 
                                'text-orange-700'
                            }">${comp.percentage}%</span>
                        </div>
                        <div class="w-40 h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="${status.badge} h-full transition-all duration-500" 
                                 style="width: ${comp.percentage}%"></div>
                        </div>
                    </div>
                </div>
                ${comp.missing.length > 0 ? `
                    <div class="mt-3 pt-3 border-t border-gray-300">
                        <p class="text-xs font-semibold text-gray-700 mb-1">âš ï¸ Da completare:</p>
                        <ul class="text-xs text-gray-600 space-y-1">
                            ${comp.missing.map(m => `<li>â€¢ ${m}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
            
            <!-- ğŸ†• FASE 014: Selezione Prodotti Presenti/Assenti -->
            ${(() => {
                const mapProdotti = {
                    'infissi': { singolare: 'infisso', label: 'ğŸªŸ Infisso', icon: 'ğŸªŸ' },
                    'persiane': { singolare: 'persiana', label: 'ğŸšª Persiana', icon: 'ğŸšª' },
                    'tapparelle': { singolare: 'tapparella', label: 'ğŸšï¸ Tapparella', icon: 'ğŸšï¸' },
                    'zanzariere': { singolare: 'zanzariera', label: 'ğŸ¦Ÿ Zanzariera', icon: 'ğŸ¦Ÿ' },
                    'cassonetti': { singolare: 'cassonetto', label: 'ğŸ“¦ Cassonetto', icon: 'ğŸ“¦' },
                    'blindate': { singolare: 'blindata', label: 'ğŸ” Blindata', icon: 'ğŸ”' },
                    'portoncini': { singolare: 'portoncino', label: 'ğŸšª Portoncino', icon: 'ğŸšª' },
                    'porteInterne': { singolare: 'portaInterna', label: 'ğŸšª Porta Interna', icon: 'ğŸšª' },
                    'clickZip': { singolare: 'clickZip', label: 'ğŸªŸ Click Zip', icon: 'ğŸªŸ' },
                    'tendeBracci': { singolare: 'tendaBracci', label: 'â˜€ï¸ Tenda Bracci', icon: 'â˜€ï¸' },
                    'grate': { singolare: 'grata', label: 'ğŸ”’ Grata', icon: 'ğŸ”’' }
                };
                
                const prodottiProgetto = [];
                if (project?.prodotti) {
                    Object.keys(project.prodotti).forEach(tipo => {
                        if (project.prodotti[tipo] === true && mapProdotti[tipo]) {
                            prodottiProgetto.push({
                                tipo: tipo,
                                ...mapProdotti[tipo]
                            });
                        }
                    });
                }
                
                if (prodottiProgetto.length === 0) return '';
                
                const prodottiAssenti = pos.prodottiAssenti || [];
                
                return `
                    <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">ğŸ¯ Prodotti in questa posizione</h3>
                        <p class="text-xs text-gray-600 mb-3">Seleziona i prodotti PRESENTI. Deseleziona quelli NON presenti (es. niente tapparella, niente zanzariera)</p>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                            ${prodottiProgetto.map(prod => {
                                const hasProdotto = pos[prod.singolare] && typeof pos[prod.singolare] === 'object';
                                const isDichiaratoAssente = prodottiAssenti.includes(prod.singolare);
                                const isPresente = hasProdotto;
                                const status = isPresente ? 'presente' : isDichiaratoAssente ? 'assente' : 'mancante';
                                
                                return `
                                    <label class="relative flex flex-col items-center p-3 border-2 rounded-lg cursor-pointer transition ${
                                        status === 'presente' ? 'border-green-500 bg-green-50' :
                                        status === 'assente' ? 'border-gray-400 bg-gray-50 opacity-60' :
                                        'border-red-400 bg-red-50'
                                    }">
                                        <input type="checkbox" 
                                               ${isPresente || !isDichiaratoAssente ? 'checked' : ''}
                                               onchange="toggleProdottoAssente('${project.id}', '${pos.id}', '${prod.tipo}')"
                                               class="sr-only">
                                        <span class="text-2xl mb-1">${prod.icon}</span>
                                        <span class="text-xs font-semibold text-center ${
                                            status === 'presente' ? 'text-green-700' :
                                            status === 'assente' ? 'text-gray-600' :
                                            'text-red-700'
                                        }">${(prod.label || prod.tipo || '').replace(/^[^\s]+\s/, '')}</span>
                                        ${status === 'presente' ? '<span class="text-xs text-green-600 mt-1">âœ“ Presente</span>' : ''}
                                        ${status === 'assente' ? '<span class="text-xs text-gray-600 mt-1">Non presente</span>' : ''}
                                        ${status === 'mancante' ? '<span class="text-xs text-red-600 mt-1">âš ï¸ Mancante</span>' : ''}
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                            <strong>ğŸ’¡ Come funziona:</strong> Spunta = Prodotto presente (devi compilare misure). Non spuntato = Prodotto assente in questa posizione (OK, nessuna misura necessaria).
                        </div>
                    </div>
                `;
            })()}
            
            ${validation.errors.length > 0 || validation.warnings.length > 0 ? `
                <div class="validation-summary">
                    ${validation.errors.length > 0 ? `
                        <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-3">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                                ğŸ”´ ERRORI DI VALIDAZIONE (${validation.errors.length})
                            </h3>
                            <ul class="space-y-1">
                                ${validation.errors.map(e => `
                                    <li class="text-sm text-red-700">â€¢ ${e.message}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${validation.warnings.length > 0 ? `
                        <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-3">
                            <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                ğŸŸ¡ ATTENZIONE (${validation.warnings.length})
                            </h3>
                            <ul class="space-y-1">
                                ${validation.warnings.map(w => `
                                    <li class="text-sm text-amber-700">â€¢ ${w.message}</li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            ` : `
                <div class="bg-green-50 border-2 border-green-500 rounded-lg p-3 mb-3">
                    <p class="font-bold text-green-800 flex items-center gap-2">
                        âœ… Tutte le misure sono corrette!
                    </p>
                </div>
            `}
            
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm font-bold text-gray-700 mb-2">Misure Principali (mm)</p>
                
                <!-- ğŸ†• v5.79: Tipo Apertura - Legge da OPZIONI_MURO centralizzato -->
                ${renderSelettoreMuro('tipoApertura', pos.tipoApertura, project.id, pos.id, 'Tipo Apertura', 'updateTipoApertura')}
                
                <!-- ğŸ†• v5.79: Posizione Telaio - Legge da OPZIONI_MURO centralizzato -->
                ${renderSelettoreMuro('posizioneTelaio', pos.posizioneTelaio, project.id, pos.id, 'Posizione Telaio', 'updatePosizioneTelaio')}
                
                <p class="text-xs text-gray-500 mb-3">ğŸ’¡ Clicca <span class="text-red-500 font-bold">âœ—</span> se una misura non ti serve per questa posizione</p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="misure-grid-${pos.id}">
                    ${['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'L4', 'H4'].map((field, index) => {
                        const isControlled = ['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT'].includes(field);
                        const nonServe = pos.misureNonServe?.[field] === true;
                        const hasValue = pos.misure?.[field] && pos.misure[field] !== '' && pos.misure[field] !== '0';
                        
                        // Stato: compilato (verde), nonServe (rosso barrato), dimenticato (arancio)
                        let statoClasse = '';
                        let statoIcon = '';
                        if (hasValue) {
                            statoClasse = 'border-green-400 bg-green-50';
                            statoIcon = '<span class="text-green-600 text-xs">âœ“</span>';
                        } else if (nonServe) {
                            statoClasse = 'border-red-300 bg-red-50 opacity-60';
                            statoIcon = '<span class="text-red-500 text-xs">âœ—</span>';
                        } else if (isControlled) {
                            statoClasse = 'border-orange-400 bg-orange-50';
                            statoIcon = '<span class="text-orange-500 text-xs">âš ï¸</span>';
                        }
                        
                        return `
                        <div class="relative">
                            <div class="flex items-center justify-between mb-1">
                                <label class="text-xs font-semibold flex items-center gap-1">
                                    ${field} ${statoIcon}
                                </label>
                                ${isControlled ? `
                                    <button type="button"
                                            onclick="event.stopPropagation(); toggleMisuraNonServe('${project.id}', '${pos.id}', '${field}')"
                                            class="text-xs px-2 py-0.5 rounded ${nonServe ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-600 hover:bg-red-100 hover:text-red-600'}"
                                            title="${nonServe ? 'Riattiva misura' : 'Marca come NON SERVE'}">
                                        ${nonServe ? 'â†©ï¸' : 'âœ—'}
                                    </button>
                                ` : ''}
                            </div>
                            <input type="number" placeholder="${nonServe ? 'N/S' : '-'}"
                                   value="${pos.misure?.[field] || ''}"
                                   onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', '${field}', this.value)"
                                   tabindex="${100 + index}"
                                   data-field-index="${index}"
                                   ${nonServe ? 'disabled' : ''}
                                   class="w-full compact-input border-2 rounded font-semibold ${nonServe ? statoClasse : (hasValue ? statoClasse : (isControlled ? statoClasse : 'border-gray-300'))} ${nonServe ? 'cursor-not-allowed' : ''}">
                            ${getFieldValidationMessage(project, pos, field)}
                        </div>
                    `}).join('')}
                </div>
            </div>

            <!-- âœ… NUOVO: Dislivello Piana Int ed Est -->
            <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-lg p-4 border-2 border-amber-300">
                <p class="text-sm font-bold text-amber-800 mb-3">ğŸ“ Dislivello Piana Int ed Est</p>
                ${(() => {
                    // Cerca dislivello in finestra o portaFinestra
                    const dislivello = pos.finestra?.dislivelloPiana || pos.portaFinestra?.dislivelloPiana || {};
                    const presente = dislivello.presente || false;
                    const pianaAlta = dislivello.pianaAlta || '';
                    const valore = dislivello.valore || '';
                    const note = dislivello.note || '';
                    
                    return `
                        <div class="space-y-3">
                            <div>
                                <div class="flex gap-4">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloPresente-${pos.id}" value="no"
                                               ${!presente ? 'checked' : ''}
                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'presente', false)"
                                               class="mr-2">
                                        <span class="text-sm">Nessun dislivello (piane allineate)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="dislivelloPresente-${pos.id}" value="si"
                                               ${presente ? 'checked' : ''}
                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'presente', true)"
                                               class="mr-2">
                                        <span class="text-sm">Dislivello presente</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="dislivelloFields-${pos.id}" style="display: ${presente ? 'block' : 'none'}">
                                <div class="space-y-3 bg-white bg-opacity-60 p-3 rounded">
                                    <div>
                                        <label class="block text-xs font-semibold mb-2 text-amber-900">Piana piÃ¹ alta:</label>
                                        <div class="flex gap-4">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAlta-${pos.id}" value="interna"
                                                       ${pianaAlta === 'interna' ? 'checked' : ''}
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'pianaAlta', 'interna')"
                                                       class="mr-2">
                                                <span class="text-sm font-medium">ğŸ  Interna</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="pianaAlta-${pos.id}" value="esterna"
                                                       ${pianaAlta === 'esterna' ? 'checked' : ''}
                                                       onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'pianaAlta', 'esterna')"
                                                       class="mr-2">
                                                <span class="text-sm font-medium">ğŸŒ Esterna</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 text-amber-900">Dislivello (mm):</label>
                                        <input type="number" placeholder="0" min="0" value="${valore}"
                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'valore', this.value)"
                                               class="w-32 px-3 py-2 border rounded-lg font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1 text-amber-900">Note (opzionale):</label>
                                        <input type="text" placeholder="es. Gradino interno..." value="${note}"
                                               onchange="updateDislivelloPosizione('${project.id}', '${pos.id}', 'note', this.value)"
                                               class="w-full px-3 py-2 border rounded-lg text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })()}
            </div>

            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm font-bold text-gray-700 mb-3">Altezze (mm)</p>
                ${(() => {
                    // Validazione iniziale per il colore di caricamento
                    const hsoff = parseFloat(pos.misure?.HSoffitto) || 0;
                    const hparapSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                    const hpavParap = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                    
                    let borderColor = 'border-gray-300';
                    let validationMsg = '';
                    
                    if (hsoff > 0 && hparapSoff > 0 && hpavParap > 0) {
                        const somma = hpavParap + hparapSoff;
                        const diff = Math.abs(somma - hsoff);
                        
                        if (diff <= 10) {
                            borderColor = 'border-green-500';
                            validationMsg = `
                                <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                                    <p class="text-xs text-green-800">
                                        âœ… <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm âœ“
                                    </p>
                                </div>
                            `;
                        } else {
                            borderColor = 'border-red-500';
                            validationMsg = `
                                <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                                    <p class="text-xs text-red-800">
                                        âš ï¸ <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                                    </p>
                                </div>
                            `;
                        }
                    }
                    
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Soffitto</label>
                                <input type="number" 
                                       id="hsoff-${pos.id}"
                                       placeholder="0" 
                                       value="${pos.misure?.HSoffitto || ''}"
                                       oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                       onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HSoffitto', this.value)"
                                       tabindex="108"
                                       class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Parapetto/Soffitto</label>
                                <input type="number" 
                                       id="hparapsoff-${pos.id}"
                                       placeholder="0" 
                                       value="${pos.misure?.HParapettoSoffitto || ''}"
                                       oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                       onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HParapettoSoffitto', this.value)"
                                       tabindex="109"
                                       class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">H Pavimento/Parapetto</label>
                                <input type="number" 
                                       id="hpavparap-${pos.id}"
                                       placeholder="0" 
                                       value="${pos.misure?.HPavimentoParapetto || ''}"
                                       oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                       onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HPavimentoParapetto', this.value)"
                                       tabindex="110"
                                       class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                            </div>
                        </div>
                        <div id="validation-msg-${pos.id}">${validationMsg}</div>
                    `;
                })()}
            </div>
            
            <!-- ğŸ“‹ SEZIONI RILIEVO PREESISTENTE PER OGNI PRODOTTO -->
            ${project.prodotti?.infissi ? renderRilievoPerProdotto(project, pos, 'infissi', 'ğŸªŸ Infissi', true) : ''}
            ${project.prodotti?.persiane ? renderRilievoPerProdotto(project, pos, 'persiane', 'ğŸšª Persiane', false) : ''}
            ${project.prodotti?.tapparelle ? renderRilievoPerProdotto(project, pos, 'tapparelle', 'ğŸšï¸ Tapparelle', false) : ''}
            ${project.prodotti?.cassonetti ? renderRilievoPerProdotto(project, pos, 'cassonetti', 'ğŸ“¦ Cassonetti', false) : ''}
            
            <!-- ğŸ—¿ CARATTERISTICHE MURO PERSONALIZZATE -->
            ${pos.overrideCaratteristiche ? renderCaratteristicheMuroOverride(project, pos) : `
                <button onclick="enableOverride('${project.id}', '${pos.id}')"
                        class="w-full text-sm bg-yellow-600 text-white px-4 py-3 rounded-lg hover:bg-yellow-700 font-semibold transition flex items-center justify-center gap-2">
                    âœï¸ Personalizza caratteristiche muro per questa posizione
                </button>
            `}
        </div>
    `;
}

function renderInfissiTab(project, pos) {
    const inf = pos.infisso;
    
    return `
        <div class="space-y-4">
            ${!inf ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessun infisso configurato</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('infisso') ? `
                            <button onclick="addInfisso('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Infisso
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('infisso') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'infissi')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : (parseInt(inf.qta) === 0 || inf.qta === '0' || inf.qta === 0) ? `
                <!-- ğŸ†• FASE 016: Visualizzazione minimale quando qta=0 -->
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-blue-700 text-lg">ğŸªŸ Infisso</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">
                            ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione. 
                            <br>Aumenta la quantitÃ  per configurare il prodotto.
                        </p>
                        <div class="max-w-xs">
                            <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                    class="w-full compact-input border rounded font-semibold">
                                ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                    <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-blue-700 text-lg">ğŸªŸ Infisso</h4>
                        <div class="flex gap-2 items-center">
                            <!-- ğŸ†• v5.82: Select quantitÃ  sempre visibile -->
                            <div class="flex items-center gap-1 bg-blue-50 px-2 py-1 rounded">
                                <span class="text-xs font-medium text-blue-700">Qta:</span>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                        class="compact-input border rounded font-bold text-blue-700 w-14">
                                    ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <button onclick="ricaricaInfissoDaGlobali('${project.id}', '${pos.id}')"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700"
                                    title="Ricarica configurazione da Config Globali">
                                ğŸ”„ Ricarica
                            </button>
                            <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                    class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                ğŸ—‘ï¸ Elimina
                            </button>
                    </div>
                    </div>

                    <!-- ğŸ”§ TIPO INFISSO ASSOCIATO -->
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                            ğŸ”§ Tipo Infisso Associato
                        </h5>
                        <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                        <div class="flex gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" 
                                       name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                       value="F"
                                       ${(() => {
                                           // Auto-selezione: se tipo contiene PF â†’ PF, altrimenti F
                                           if (inf.tipoInfissoAssociato) {
                                               return inf.tipoInfissoAssociato === 'F' ? 'checked' : '';
                                           } else {
                                               // Default: se tipo non contiene PF â†’ seleziona F
                                               return (inf.tipo && !inf.tipo.includes('PF')) ? 'checked' : '';
                                           }
                                       })()}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'F')"
                                       class="w-4 h-4">
                                <span class="font-medium">F (Finestra)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" 
                                       name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                       value="PF"
                                       ${(() => {
                                           // Auto-selezione: se tipo contiene PF â†’ PF
                                           if (inf.tipoInfissoAssociato) {
                                               return inf.tipoInfissoAssociato === 'PF' ? 'checked' : '';
                                           } else {
                                               // Default: se tipo contiene PF â†’ seleziona PF
                                               return (inf.tipo && inf.tipo.includes('PF')) ? 'checked' : '';
                                           }
                                       })()}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'PF')"
                                       class="w-4 h-4">
                                <span class="font-medium">PF (Porta Finestra)</span>
                            </label>
                        </div>
                        ${!inf.tipoInfissoAssociato && !inf.tipo ? `
                            <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                <p class="text-sm text-amber-800">âš ï¸ Seleziona prima se F o PF</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- âš™ï¸ CONFIGURAZIONE -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                            âš™ï¸ Configurazione
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                inf.azienda || '',
                                OPZIONI_PRODOTTI.infissi.aziende,
                                project.id,
                                pos.id,
                                'infisso',
                                'Azienda'
                            )}
                            
                            <!-- â•â•â• CAMPI SPECIFICI FINSTRAL (col-span-3) â•â•â• -->
                            ${(inf.azienda?.toLowerCase() === 'finstral') ? `
                            <div class="col-span-3 bg-blue-100 border-2 border-blue-300 rounded-lg p-3 my-2">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-xs bg-blue-600 text-white px-2 py-0.5 rounded font-bold">FINSTRAL</span>
                                    <span class="text-xs text-blue-700">Codici specifici</span>
                                </div>
                                <div class="grid md:grid-cols-4 gap-3">
                                    <!-- CODICE MODELLO -->
                                    <div>
                                        <label class="text-xs font-medium">Cod. Modello</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'codiceModello', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-xs ${!inf.codiceModello ? 'border-orange-400 bg-orange-50' : ''}">
                                            <option value="">--</option>
                                            <optgroup label="ğŸ“¦ 1 Campo">
                                                <option value="101" ${inf.codiceModello === '101' ? 'selected' : ''}>101 - anta</option>
                                                <option value="102" ${inf.codiceModello === '102' ? 'selected' : ''}>102 - fisso</option>
                                            </optgroup>
                                            <optgroup label="ğŸ“¦ğŸ“¦ 2 Campi Orizz.">
                                                <option value="201" ${inf.codiceModello === '201' ? 'selected' : ''}>201 - 2 ante</option>
                                                <option value="202" ${inf.codiceModello === '202' ? 'selected' : ''}>202 - anta+fisso</option>
                                                <option value="203" ${inf.codiceModello === '203' ? 'selected' : ''}>203 - fisso+anta</option>
                                                <option value="204" ${inf.codiceModello === '204' ? 'selected' : ''}>204 - 2 fissi</option>
                                            </optgroup>
                                            <optgroup label="ğŸ“¦ğŸ“¦ 2 Campi Vert.">
                                                <option value="205" ${inf.codiceModello === '205' ? 'selected' : ''}>205 - 2 ante vert.</option>
                                                <option value="206" ${inf.codiceModello === '206' ? 'selected' : ''}>206 - anta+fisso vert.</option>
                                                <option value="207" ${inf.codiceModello === '207' ? 'selected' : ''}>207 - fisso+anta vert.</option>
                                                <option value="208" ${inf.codiceModello === '208' ? 'selected' : ''}>208 - 2 fissi vert.</option>
                                            </optgroup>
                                            <optgroup label="ğŸ“¦ğŸ“¦ğŸ“¦ 3 Campi">
                                                <option value="301" ${inf.codiceModello === '301' ? 'selected' : ''}>301 - 3 ante</option>
                                                <option value="302" ${inf.codiceModello === '302' ? 'selected' : ''}>302 - a+f+a</option>
                                                <option value="303" ${inf.codiceModello === '303' ? 'selected' : ''}>303 - f+a+f</option>
                                                <option value="304" ${inf.codiceModello === '304' ? 'selected' : ''}>304 - 3 fissi</option>
                                                <option value="305" ${inf.codiceModello === '305' ? 'selected' : ''}>305 - f+a+f vert.</option>
                                                <option value="306" ${inf.codiceModello === '306' ? 'selected' : ''}>306 - f+a+a vert.</option>
                                                <option value="307" ${inf.codiceModello === '307' ? 'selected' : ''}>307 - 3 fissi vert.</option>
                                                <option value="308" ${inf.codiceModello === '308' ? 'selected' : ''}>308 - f+2a alto</option>
                                                <option value="309" ${inf.codiceModello === '309' ? 'selected' : ''}>309 - 2a basso+f</option>
                                                <option value="310" ${inf.codiceModello === '310' ? 'selected' : ''}>310 - 2a basso+a</option>
                                                <option value="321" ${inf.codiceModello === '321' ? 'selected' : ''}>321 - f+a+a</option>
                                                <option value="322" ${inf.codiceModello === '322' ? 'selected' : ''}>322 - a+a+f</option>
                                                <option value="324" ${inf.codiceModello === '324' ? 'selected' : ''}>324 - a+f+a</option>
                                                <option value="340" ${inf.codiceModello === '340' ? 'selected' : ''}>340 - a+2a alto</option>
                                            </optgroup>
                                            <optgroup label="ğŸ“¦ğŸ“¦ğŸ“¦ğŸ“¦ 4 Campi">
                                                <option value="311" ${inf.codiceModello === '311' ? 'selected' : ''}>311 - 2f basso+2a alto</option>
                                                <option value="314" ${inf.codiceModello === '314' ? 'selected' : ''}>314 - 2a basso+2f alto</option>
                                                <option value="316" ${inf.codiceModello === '316' ? 'selected' : ''}>316 - 4 ante</option>
                                                <option value="317" ${inf.codiceModello === '317' ? 'selected' : ''}>317 - 4 fissi</option>
                                            </optgroup>
                                            <optgroup label="ğŸ”— Montante Mobile">
                                                <option value="401" ${inf.codiceModello === '401' ? 'selected' : ''}>401 - 2 ante montante</option>
                                                <option value="402" ${inf.codiceModello === '402' ? 'selected' : ''}>402 - f+2a mont. alto</option>
                                                <option value="403" ${inf.codiceModello === '403' ? 'selected' : ''}>403 - 2a mont.+f alto</option>
                                                <option value="404" ${inf.codiceModello === '404' ? 'selected' : ''}>404 - 2f mont.+a alto</option>
                                                <option value="405" ${inf.codiceModello === '405' ? 'selected' : ''}>405 - a+2a mont. alto</option>
                                                <option value="414" ${inf.codiceModello === '414' ? 'selected' : ''}>414 - f+a mont. DX</option>
                                                <option value="415" ${inf.codiceModello === '415' ? 'selected' : ''}>415 - a mont. SX+f</option>
                                                <option value="420" ${inf.codiceModello === '420' ? 'selected' : ''}>420 - a+a mont. DX</option>
                                                <option value="421" ${inf.codiceModello === '421' ? 'selected' : ''}>421 - a mont. SX+a</option>
                                                <option value="424" ${inf.codiceModello === '424' ? 'selected' : ''}>424 - 3 ante mont.</option>
                                            </optgroup>
                                            <optgroup label="â†”ï¸ Bilico">
                                                <option value="450" ${inf.codiceModello === '450' ? 'selected' : ''}>450 - bilico</option>
                                                <option value="451" ${inf.codiceModello === '451' ? 'selected' : ''}>451 - bilico+f DX</option>
                                                <option value="452" ${inf.codiceModello === '452' ? 'selected' : ''}>452 - f SX+bilico</option>
                                                <option value="453" ${inf.codiceModello === '453' ? 'selected' : ''}>453 - f+bilico+f</option>
                                                <option value="456" ${inf.codiceModello === '456' ? 'selected' : ''}>456 - bilico+f alto</option>
                                                <option value="457" ${inf.codiceModello === '457' ? 'selected' : ''}>457 - f basso+bilico</option>
                                            </optgroup>
                                            <optgroup label="ğŸšª Scorrevoli">
                                                <option value="500" ${inf.codiceModello === '500' ? 'selected' : ''}>500 - scorr. parallela</option>
                                                <option value="501" ${inf.codiceModello === '501' ? 'selected' : ''}>501 - scorr. SX</option>
                                                <option value="503" ${inf.codiceModello === '503' ? 'selected' : ''}>503 - scorr. SX+a DX</option>
                                                <option value="504" ${inf.codiceModello === '504' ? 'selected' : ''}>504 - a SX+scorr. DX</option>
                                                <option value="510" ${inf.codiceModello === '510' ? 'selected' : ''}>510 - 2 scorr.</option>
                                                <option value="511" ${inf.codiceModello === '511' ? 'selected' : ''}>511 - scorr. DX</option>
                                            </optgroup>
                                            <optgroup label="ğŸ  FIN-Slide HST">
                                                <option value="FS600" ${inf.codiceModello === 'FS600' ? 'selected' : ''}>FS600 - solo fisso</option>
                                                <option value="FS601" ${inf.codiceModello === 'FS601' ? 'selected' : ''}>FS601 - anta+fisso</option>
                                                <option value="FS602" ${inf.codiceModello === 'FS602' ? 'selected' : ''}>FS602 - fisso+anta</option>
                                                <option value="FS610" ${inf.codiceModello === 'FS610' ? 'selected' : ''}>FS610 - a+f+a</option>
                                                <option value="FS611" ${inf.codiceModello === 'FS611' ? 'selected' : ''}>FS611 - a+2f+a</option>
                                                <option value="FS614" ${inf.codiceModello === 'FS614' ? 'selected' : ''}>FS614 - 2a+fisso</option>
                                                <option value="FS615" ${inf.codiceModello === 'FS615' ? 'selected' : ''}>FS615 - 2a coll.+fisso</option>
                                                <option value="FS616" ${inf.codiceModello === 'FS616' ? 'selected' : ''}>FS616 - fisso+2a</option>
                                                <option value="FS617" ${inf.codiceModello === 'FS617' ? 'selected' : ''}>FS617 - a+f+2a</option>
                                                <option value="FS621" ${inf.codiceModello === 'FS621' ? 'selected' : ''}>FS621 - 2 fissi</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <!-- FERRAMENTA -->
                                    <div>
                                        <label class="text-xs font-medium">Ferramenta</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'ferramenta1', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-xs">
                                            <option value="">--</option>
                                            <optgroup label="Anta/Ribalta">
                                                <option value="411" ${inf.ferramenta1 === '411' ? 'selected' : ''}>411 - A/R vista</option>
                                                <option value="211" ${inf.ferramenta1 === '211' ? 'selected' : ''}>211 - A/R scomp.</option>
                                            </optgroup>
                                            <optgroup label="Solo Anta">
                                                <option value="430" ${inf.ferramenta1 === '430' ? 'selected' : ''}>430 - Anta int.</option>
                                                <option value="230" ${inf.ferramenta1 === '230' ? 'selected' : ''}>230 - Anta scomp.</option>
                                            </optgroup>
                                            <optgroup label="Con Montante">
                                                <option value="425" ${inf.ferramenta1 === '425' ? 'selected' : ''}>425 - +leva vista</option>
                                                <option value="225" ${inf.ferramenta1 === '225' ? 'selected' : ''}>225 - +leva scomp.</option>
                                            </optgroup>
                                            <optgroup label="Porta-Finestra">
                                                <option value="475" ${inf.ferramenta1 === '475' ? 'selected' : ''}>475 - A/R+serr.</option>
                                                <option value="473" ${inf.ferramenta1 === '473' ? 'selected' : ''}>473 - Anta+serr.</option>
                                            </optgroup>
                                            <optgroup label="Scorrevoli">
                                                <option value="710" ${inf.ferramenta1 === '710' ? 'selected' : ''}>710 - Scorr. ribalta</option>
                                                <option value="720" ${inf.ferramenta1 === '720' ? 'selected' : ''}>720 - Scorr. par.</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    <!-- LATO -->
                                    <div>
                                        <label class="text-xs font-medium">Lato</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'lato1', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-xs">
                                            <option value="">--</option>
                                            <option value="-1" ${inf.lato1 === '-1' ? 'selected' : ''}>SX (-1)</option>
                                            <option value="-2" ${inf.lato1 === '-2' ? 'selected' : ''}>DX (-2)</option>
                                        </select>
                                    </div>
                                    <!-- ESECUZIONE -->
                                    <div>
                                        <label class="text-xs font-medium">Esec.</label>
                                        ${(() => {
                                            // ğŸ†• v5.68: Esecuzione .0 solo per PVC interno
                                            const finituraInt = (inf.finituraInt || project.configInfissi?.finituraInt || 'pvc').toLowerCase();
                                            const isPvcInterno = finituraInt === 'pvc' || finituraInt === '';
                                            const esecuzioneCorrente = inf.esecuzione1 || '0';
                                            // Se non Ã¨ PVC e ha esecuzione 0, forza a 3
                                            const esecuzioneValida = !isPvcInterno && esecuzioneCorrente === '0' ? '3' : esecuzioneCorrente;
                                            
                                            return `
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'esecuzione1', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-xs ${!isPvcInterno ? 'border-amber-400 bg-amber-50' : ''}">
                                            ${isPvcInterno ? `<option value="0" ${esecuzioneValida === '0' ? 'selected' : ''}>0 - Std</option>` : ''}
                                            <option value="3" ${esecuzioneValida === '3' ? 'selected' : ''}>3 - Perim+ang</option>
                                            <option value="4" ${esecuzioneValida === '4' ? 'selected' : ''}>4 - Perim</option>
                                        </select>
                                        ${!isPvcInterno ? '<p class="text-xs text-amber-600 mt-1">âš ï¸ ALU/Legno: no .0</p>' : ''}
                                            `;
                                        })()}
                                    </div>
                                </div>
                                
                                <!-- ğŸ†• v5.734: SEZIONE FIN-SLIDE HST -->
                                ${inf.codiceModello?.startsWith('FS') ? `
                                <div class="mt-3 p-3 bg-teal-50 border-2 border-teal-300 rounded-lg">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-lg">ğŸ </span>
                                        <span class="font-bold text-teal-800 text-sm">Configurazione FIN-Slide HST</span>
                                    </div>
                                    <div class="grid grid-cols-4 gap-2">
                                        <!-- TELAIO FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Telaio</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideTelaio', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <!-- ğŸ†• v5.737: Codici telaio corretti da configuratore Finstral -->
                                                <option value="90M" ${(inf.finslideTelaio || '90M') === '90M' ? 'selected' : ''}>90M - ALU-PVC 168mm</option>
                                                <option value="90N" ${inf.finslideTelaio === '90N' ? 'selected' : ''}>90N - ALU-PVC 168mm</option>
                                                <option value="090A0" ${inf.finslideTelaio === '090A0' ? 'selected' : ''}>090A0 - Hide ALU-PVC 160mm</option>
                                                <option value="38B" ${inf.finslideTelaio === '38B' ? 'selected' : ''}>38B - ALU-PVC 157mm</option>
                                                <option value="38C" ${inf.finslideTelaio === '38C' ? 'selected' : ''}>38C - ALU-PVC 157mm</option>
                                            </select>
                                        </div>
                                        <!-- ANTA FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Profilo Anta</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideAnta', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <option value="Step-line Door" ${(inf.finslideAnta || 'Step-line Door') === 'Step-line Door' ? 'selected' : ''}>Step-line Door</option>
                                                <option value="Step-line" ${inf.finslideAnta === 'Step-line' ? 'selected' : ''}>Step-line</option>
                                                <option value="Slim-line" ${inf.finslideAnta === 'Slim-line' ? 'selected' : ''}>Slim-line</option>
                                                <option value="Slim-line Cristal" ${inf.finslideAnta === 'Slim-line Cristal' ? 'selected' : ''}>Slim-line Cristal</option>
                                                <option value="Nova-line Plus" ${inf.finslideAnta === 'Nova-line Plus' ? 'selected' : ''}>Nova-line Plus</option>
                                            </select>
                                        </div>
                                        <!-- FERRAMENTA FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Ferramenta</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideFerramenta', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <option value="83" ${(inf.finslideFerramenta || '83') === '83' ? 'selected' : ''}>83 - Std â‰¤250kg</option>
                                                <option value="83F" ${inf.finslideFerramenta === '83F' ? 'selected' : ''}>83F - +stopper</option>
                                                <option value="83.3" ${inf.finslideFerramenta === '83.3' ? 'selected' : ''}>83.3 - Sicurezza</option>
                                                <option value="183" ${inf.finslideFerramenta === '183' ? 'selected' : ''}>183 - Pesante >250kg</option>
                                                <option value="183.3" ${inf.finslideFerramenta === '183.3' ? 'selected' : ''}>183.3 - Pes.+sicur.</option>
                                            </select>
                                        </div>
                                        <!-- MANIGLIA FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Maniglia</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideManiglia', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <option value="serie2" ${(inf.finslideManiglia || 'serie2') === 'serie2' ? 'selected' : ''}>Serie 2 - Alluminio â‚¬166</option>
                                                <option value="serie3" ${inf.finslideManiglia === 'serie3' ? 'selected' : ''}>Serie 3 - Inox â‚¬167</option>
                                                <option value="serie11" ${inf.finslideManiglia === 'serie11' ? 'selected' : ''}>Serie 11 â‚¬128+</option>
                                                <option value="serie12" ${inf.finslideManiglia === 'serie12' ? 'selected' : ''}>Serie 12 â‚¬594+</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- ğŸ†• v5.736: Seconda riga per colore maniglia e vetro -->
                                    <div class="grid grid-cols-2 gap-2 mt-2">
                                        <!-- COLORE MANIGLIA FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Colore Maniglia</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideColoreManiglia', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <option value="M01" ${(inf.finslideColoreManiglia || 'M01') === 'M01' ? 'selected' : ''}>M01 - Bianco opaco</option>
                                                <option value="07" ${inf.finslideColoreManiglia === '07' ? 'selected' : ''}>07 - Bianco perla</option>
                                                <option value="56" ${inf.finslideColoreManiglia === '56' ? 'selected' : ''}>56 - Neutro anodizzato</option>
                                                <option value="74" ${inf.finslideColoreManiglia === '74' ? 'selected' : ''}>74 - Bronzo</option>
                                                <option value="79" ${inf.finslideColoreManiglia === '79' ? 'selected' : ''}>79 - Titanio</option>
                                                <option value="M03" ${inf.finslideColoreManiglia === 'M03' ? 'selected' : ''}>M03 - Nero opaco</option>
                                            </select>
                                        </div>
                                        <!-- VETRO FIN-Slide -->
                                        <div>
                                            <label class="text-xs font-medium text-teal-700">Vetro</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'finslideVetro', this.value)"
                                                    class="w-full compact-input border border-teal-300 rounded mt-1 text-xs bg-white">
                                                <option value="Max-Valor3_46" ${(inf.finslideVetro || 'Max-Valor3_46') === 'Max-Valor3_46' ? 'selected' : ''}>Max-Valor 3 triplo 46mm</option>
                                                <option value="Max-Valor3_40" ${inf.finslideVetro === 'Max-Valor3_40' ? 'selected' : ''}>Max-Valor 3 triplo 40mm</option>
                                                <option value="Plus-Valor2" ${inf.finslideVetro === 'Plus-Valor2' ? 'selected' : ''}>Plus-Valor 2 (doppio)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                <div class="mt-2 text-xs text-blue-700 font-mono">
                                    â†’ Codice: <strong>${inf.codiceModello || '???'}</strong> | Ferr: <strong>${inf.ferramenta1 || '???'}${inf.lato1 || ''}</strong> (esec.${inf.esecuzione1 || '0'})
                                </div>
                            </div>
                            ` : `
                            <!-- MESSAGGIO PER ALTRI FORNITORI (Posizioni) -->
                            <div class="col-span-3 bg-amber-50 border-2 border-amber-300 rounded-lg p-3 my-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xl">âš ï¸</span>
                                    <div>
                                        <p class="font-bold text-amber-800 text-sm">Valori per ${inf.azienda?.toUpperCase() || 'questo fornitore'} in arrivo</p>
                                        <p class="text-xs text-amber-600">I campi specifici saranno disponibili prossimamente</p>
                                    </div>
                                </div>
                            </div>
                            `}
                            
                            <!-- â•â•â• CAMPI SOLO PER FINSTRAL (Posizioni) â•â•â• -->
                            ${(inf.azienda?.toLowerCase() === 'finstral') ? `

                            <!-- TIPO ANTA -->
                            <!-- ğŸ†• v5.736: Nascosto per FIN-Slide (usa Profilo Anta nel box specifico) -->
                            ${!inf.codiceModello?.startsWith('FS') ? renderSelectWithCustom(
                                'tipoAnta',
                                inf.tipoAnta || '',
                                OPZIONI_PRODOTTI.infissi.tipiAnta,
                                project.id,
                                pos.id,
                                'infisso',
                                'Tipo Anta'
                            ) : ''}

                            <!-- FINITURA INTERNA -->
                            ${renderSelectWithCustom(
                                'finituraInt',
                                inf.finituraInt || '',
                                OPZIONI_PRODOTTI.infissi.finiture,
                                project.id,
                                pos.id,
                                'infisso',
                                'Finitura Int'
                            )}

                            <!-- FINITURA ESTERNA -->
                            ${renderSelectWithCustom(
                                'finituraEst',
                                inf.finituraEst || '',
                                OPZIONI_PRODOTTI.infissi.finiture,
                                project.id,
                                pos.id,
                                'infisso',
                                'Finitura Est'
                            )}

                            <!-- COLORE INTERNO -->
                            ${renderSelectColoreStandard(
                                'coloreInt',
                                inf.coloreInt || '',
                                inf.finituraInt || 'pvc',
                                project.id,
                                pos.id,
                                'infisso',
                                'Colore Interno'
                            )}

                            <!-- COLORE ESTERNO -->
                            ${renderSelectColoreStandard(
                                'coloreEst',
                                inf.coloreEst || '',
                                inf.finituraEst || 'pvc',
                                project.id,
                                pos.id,
                                'infisso',
                                'Colore Esterno'
                            )}

                            <!-- TELAIO -->
                            <!-- ğŸ”„ v5.743: Telai filtrati per finitura posizione -->
                            <!-- Nascosto per FIN-Slide (usa Telaio nel box specifico) -->
                            ${!inf.codiceModello?.startsWith('FS') ? renderSelectWithCustom(
                                'telaio',
                                inf.telaio || '',
                                FINWINDOW_TELAI_PER_MATERIALE[getTipoTelaioDaFinitura(inf.finituraInt || project.configInfissi?.finituraInt, inf.finituraEst || project.configInfissi?.finituraEst)] || FINWINDOW_TELAI_OPTIONS,
                                project.id,
                                pos.id,
                                'infisso',
                                'Telaio'
                            ) : ''}

                            <!-- ALLARME -->
                            ${renderSelectWithCustom(
                                'allarme',
                                inf.allarme || '',
                                OPZIONI_PRODOTTI.infissi.allarme,
                                project.id,
                                pos.id,
                                'infisso',
                                'Allarme'
                            )}

                            <!-- VETRO -->
                            <!-- ğŸ†• v5.736: Nascosto per FIN-Slide (usa Vetro nel box specifico) -->
                            <!-- ğŸ”§ v5.84: Centralizzato in OPZIONI_PRODOTTI -->
                            ${!inf.codiceModello?.startsWith('FS') ? renderSelectWithCustom(
                                'vetro',
                                inf.vetro || '',
                                OPZIONI_PRODOTTI.infissi.vetri,
                                project.id,
                                pos.id,
                                'infisso',
                                'Vetro'
                            ) : ''}

                            <!-- MANIGLIA - SEMPLIFICATO v4.39 -->
                            <!-- ğŸ†• v5.734: Nascosto per FIN-Slide (usa maniglia HST dedicata) -->
                            ${!inf.codiceModello?.startsWith('FS') ? renderSelectWithCustom(
                                'maniglia',
                                inf.maniglia || '',
                                OPZIONI_PRODOTTI.infissi.maniglie,
                                project.id,
                                pos.id,
                                'infisso',
                                'Maniglia'
                            ) : ''}

                            <!-- COLORE MANIGLIA - AGGIORNATO v4.39 -->
                            <!-- ğŸ†• v5.734: Nascosto per FIN-Slide -->
                            ${!inf.codiceModello?.startsWith('FS') ? renderSelectWithCustom(
                                'coloreManiglia',
                                inf.coloreManiglia || '',
                                OPZIONI_PRODOTTI.infissi.coloriManiglia,
                                project.id,
                                pos.id,
                                'infisso',
                                'Colore Maniglia'
                            ) : ''}

                            <!-- TAGLI TELAIO -->
                            ${renderSelectWithCustom(
                                'tagliTelaio',
                                inf.tagliTelaio || '',
                                OPZIONI_PRODOTTI.infissi.tagliTelaio,
                                project.id,
                                pos.id,
                                'infisso',
                                'Tagli Telaio'
                            )}
                        </div>
                        
                        <!-- COD.TAGLI MULTIPLI (editabili, sincronizzati con config globale) -->
                        <div class="mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-xs font-medium">COD.TAGLI</label>
                                <button onclick="state.screen = 'project-detail'; state.setupStep = 3; render();"
                                        class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded font-medium transition">
                                    âš™ï¸ Config Globale
                                </button>
                            </div>
                            <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));">
                                ${(() => {
                                    // ğŸ†• v4.81: Genera posizioni da tagliTelaio (fallback a codTagli per retrocompatibilitÃ )
                                    const tagliTelaio = inf.tagliTelaio || '';
                                    const codTagli = getPosizioniTagli(tagliTelaio);
                                    const codTagliValues = inf.codTagliValues || [];
                                    
                                    if (codTagli.length === 0 || tagliTelaio === 'nessuno') {
                                        return '<input type="text" readonly placeholder="Seleziona Tagli Telaio" class="w-full px-2 py-1 border rounded bg-gray-50 text-gray-700 text-xs">';
                                    }
                                    
                                    // ğŸ†• v4.79: Ottieni codici disponibili per il telaio della posizione
                                    const telaioPos = inf.telaio || '';
                                    const codiciDisponibili = getCodiciTaglioPerTelaio(telaioPos);
                                    const hasCodici = codiciDisponibili.length > 0;
                                    
                                    return codTagli.map((taglio, idx) => {
                                        const valore = codTagliValues[idx] || '';
                                        const isEmpty = !valore || valore.trim() === '';
                                        return `
                                        <div class="flex flex-col">
                                            <label class="text-xs font-bold text-gray-600 mb-1">${taglio}</label>
                                            ${hasCodici ? `
                                                <select onchange="updateCodTagliPosizione('${project.id}', '${pos.id}', ${idx}, this.value)"
                                                        class="w-full px-1 py-1 border-2 rounded text-gray-700 text-xs text-center font-bold focus:ring-2 focus:ring-blue-500 ${
                                                            isEmpty ? 'border-orange-300 bg-orange-50' : 'border-blue-300 bg-blue-50'
                                                        }">
                                                    <option value="">--</option>
                                                    ${codiciDisponibili.map(c => `<option value="${c}" ${valore === c ? 'selected' : ''}>${c}</option>`).join('')}
                                                </select>
                                            ` : `
                                                <input type="text" 
                                                       value="${valore}"
                                                       onchange="updateCodTagliPosizione('${project.id}', '${pos.id}', ${idx}, this.value)"
                                                       placeholder="Codice"
                                                       class="w-full px-2 py-1 border-2 border-blue-300 rounded text-gray-700 text-xs text-center font-bold focus:ring-2 focus:ring-blue-500">
                                            `}
                                        </div>
                                    `}).join('');
                                })()}
                            </div>
                            <p class="text-xs text-gray-400 mt-1">ğŸ’¡ Valori copiati da Config Globale (modificabili qui)</p>
                        </div>
                    </div>
                    ` : ''}

                    <!-- ğŸ†• v5.708: BANCALE INTERNO (posizione) -->
                    <div class="bg-cyan-50 border-2 border-cyan-300 rounded-lg p-4 mb-3">
                        <h5 class="font-bold text-cyan-800 mb-3 flex items-center gap-2">
                            ğŸªŸ 14. Bancale Interno (opzionale)
                        </h5>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Tipo Bancale</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'bancaleTipo', this.value); render();"
                                        class="w-full px-2 py-1 border-2 border-cyan-300 rounded text-sm">
                                    <option value="" ${!inf.bancaleTipo ? 'selected' : ''}>-- Nessun bancale --</option>
                                    <option value="PVC" ${inf.bancaleTipo === 'PVC' ? 'selected' : ''}>PVC (cod.25000)</option>
                                    <option value="LEGNO_95000" ${inf.bancaleTipo === 'LEGNO_95000' ? 'selected' : ''}>Legno 95000</option>
                                    <option value="LEGNO_96000" ${inf.bancaleTipo === 'LEGNO_96000' ? 'selected' : ''}>Legno 96000</option>
                                </select>
                            </div>
                            ${inf.bancaleTipo ? `
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Bordo</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'bancaleBordo', this.value)"
                                        class="w-full px-2 py-1 border-2 border-cyan-300 rounded text-sm">
                                    <option value="0" ${inf.bancaleBordo === '0' || !inf.bancaleBordo ? 'selected' : ''}>0 - Dritto</option>
                                    <option value="1" ${inf.bancaleBordo === '1' ? 'selected' : ''}>1 - Toro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">ProfonditÃ  (mm)</label>
                                <input type="number" 
                                       value="${inf.bancaleProfondita || ''}"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'bancaleProfondita', this.value)"
                                       placeholder="es. 200"
                                       class="w-full px-2 py-1 border-2 border-cyan-300 rounded text-sm">
                            </div>
                            ` : ''}
                        </div>
                        ${inf.bancaleTipo ? `
                        <div class="mt-2 text-xs text-cyan-700 bg-cyan-100 p-2 rounded">
                            ğŸ’¡ ${inf.bancaleTipo === 'PVC' ? 'MDF pellicolato 25mm' : inf.bancaleTipo === 'LEGNO_95000' ? 'Profilo 39mm' : 'Profilo 69mm'}
                            ${inf.bancaleProfondita ? ` - ProfonditÃ : ${inf.bancaleProfondita}mm` : ''}
                        </div>
                        ` : ''}
                    </div>

                    <!-- ğŸ†• v5.709: ANTA TWIN (posizione) - SOLO SE TIPO ANTA = TWIN -->
                    ${inf.tipoAnta?.toLowerCase().includes('twin') ? `
                    <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4 mb-3">
                        <h5 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
                            ğŸšï¸ 15. Anta Twin - Veneziana/Plissettata
                        </h5>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Tipo</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'antaTwinTipo', this.value); render();"
                                        class="w-full px-2 py-1 border-2 border-purple-300 rounded text-sm">
                                    <option value="" ${!inf.antaTwinTipo ? 'selected' : ''}>-- Nessuno --</option>
                                    <option value="veneziana" ${inf.antaTwinTipo === 'veneziana' ? 'selected' : ''}>ğŸªŸ Veneziana</option>
                                    <option value="plissettata" ${inf.antaTwinTipo === 'plissettata' ? 'selected' : ''}>ğŸšï¸ Plissettata</option>
                                </select>
                            </div>
                            ${inf.antaTwinTipo ? `
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Modello</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'antaTwinModello', this.value)"
                                        class="w-full px-2 py-1 border-2 border-purple-300 rounded text-sm">
                                    <option value="">-- Seleziona --</option>
                                    ${Object.entries(typeof FINSTRAL_ANTA_TWIN !== 'undefined' && FINSTRAL_ANTA_TWIN.tipiAnta ? FINSTRAL_ANTA_TWIN.tipiAnta : {}).map(([key, val]) =>
                                        `<option value="${key}" ${inf.antaTwinModello === key ? 'selected' : ''}>${val.cod} - ${val.desc}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        ${inf.antaTwinTipo ? `
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Colore ${inf.antaTwinTipo === 'veneziana' ? 'Veneziana' : 'Plissettata'}</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'antaTwinColore', this.value)"
                                        class="w-full px-2 py-1 border-2 border-purple-300 rounded text-sm">
                                    <option value="">-- Seleziona --</option>
                                    ${inf.antaTwinTipo === 'veneziana' ? 
                                        Object.entries(typeof FINSTRAL_ANTA_TWIN !== 'undefined' && FINSTRAL_ANTA_TWIN.coloriVeneziana ? FINSTRAL_ANTA_TWIN.coloriVeneziana : {}).map(([cod, info]) =>
                                            `<option value="${cod}" ${inf.antaTwinColore === cod ? 'selected' : ''}>${cod} - ${info.nome}</option>`
                                        ).join('')
                                        :
                                        Object.entries(typeof FINSTRAL_ANTA_TWIN !== 'undefined' && FINSTRAL_ANTA_TWIN.coloriPlissettata ? FINSTRAL_ANTA_TWIN.coloriPlissettata : {}).map(([cod, info]) =>
                                            `<option value="${cod}" ${inf.antaTwinColore === cod ? 'selected' : ''}>${cod} - ${info.nome}</option>`
                                        ).join('')
                                    }
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold mb-1 text-gray-600">Comando</label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'antaTwinComando', this.value)"
                                        class="w-full px-2 py-1 border-2 border-purple-300 rounded text-sm">
                                    ${Object.entries(typeof FINSTRAL_ANTA_TWIN !== 'undefined' && FINSTRAL_ANTA_TWIN.comandi ? FINSTRAL_ANTA_TWIN.comandi : {}).map(([cod, info]) =>
                                        `<option value="${cod}" ${inf.antaTwinComando === cod ? 'selected' : ''}>${info.desc}${info.supplemento > 0 ? ' (+â‚¬' + info.supplemento + ')' : ''}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-purple-700 bg-purple-100 p-2 rounded">
                            ğŸ’¡ ${inf.antaTwinModello || ''} ${inf.antaTwinColore || ''} - ${inf.antaTwinTipo === 'veneziana' ? 'Lamelle 25mm' : 'Tenda Plissettata'}
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}

                    <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                ğŸ“ BRM - Misura per Ordine
                            </h5>
                            ${!inf.brmPersonalizzato ? `
                                <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                    ğŸ¨ Personalizza BRM
                                </button>
                            ` : `
                                <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                    â†©ï¸ Usa Globale
                                </button>
                            `}
                        </div>
                        
                        ${!inf.brmPersonalizzato ? `
                            <div class="bg-white p-3 rounded border-2 border-amber-400">
                                <p class="text-sm text-amber-800 mb-2">
                                    <strong>Formula Globale Attiva:</strong>
                                </p>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <span class="font-semibold">BRM L =</span>
                                        ${project.brmConfigInfissi?.misuraBaseL || '?'} 
                                        ${project.brmConfigInfissi?.operazioneL || '-'} 
                                        ${project.brmConfigInfissi?.valoreL || '0'}mm
                                    </div>
                                    <div>
                                        <span class="font-semibold">BRM H =</span>
                                        ${project.brmConfigInfissi?.misuraBaseH || '?'} 
                                        ${project.brmConfigInfissi?.operazioneH || '-'} 
                                        ${project.brmConfigInfissi?.valoreH || '0'}mm
                                    </div>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-3 mt-3">
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Larghezza</label>
                                    <input type="number" value="${inf.BRM_L || ''}" readonly
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Altezza</label>
                                    <input type="number" value="${inf.BRM_H || ''}" readonly
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        ` : `
                            <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                <p class="text-sm font-semibold text-purple-800 mb-2">âš™ï¸ Formula Personalizzata:</p>
                                
                                <!-- BRM Larghezza -->
                                <div class="mb-3">
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Larghezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                    <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${inf.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${inf.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreL-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreL || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-infisso-${pos.id}">
                                        = ${inf.brmPersonalizzato?.misuraBaseL || '?'} ${inf.brmPersonalizzato?.operazioneL || '+'} ${inf.brmPersonalizzato?.valoreL || '0'}mm
                                    </div>
                                </div>
                                
                                <!-- BRM Altezza -->
                                <div>
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Altezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['HF', 'HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                    <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${inf.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${inf.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreH-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreH || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreH', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-infisso-${pos.id}">
                                        = ${inf.brmPersonalizzato?.misuraBaseH || '?'} ${inf.brmPersonalizzato?.operazioneH || '+'} ${inf.brmPersonalizzato?.valoreH || '0'}mm
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ’¾ PULSANTE APPLICA MODIFICHE BRM -->
                            <div class="mt-3 flex justify-center">
                                <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                    ğŸ’¾ Salva
                                </button>
                            </div>
                            
                            <!-- Risultati BRM Calcolati -->
                            <div class="grid md:grid-cols-2 gap-3">
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Larghezza</label>
                                    <input type="number" value="${inf.BRM_L || ''}" readonly id="brm-l-result-infisso-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Altezza</label>
                                    <input type="number" value="${inf.BRM_H || ''}" readonly id="brm-h-result-infisso-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        `}
                    </div>

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea value="${inf.note || ''}"
                                  onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${inf.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderPersianeTab(project, pos) {
    const per = pos.persiana;
    
    // ğŸ†• v5.96: Usa renderPositionProductFromCampi se disponibile
    if (per && typeof renderPositionProductFromCampi === 'function' && typeof CAMPI_PRODOTTI !== 'undefined') {
        const qta = parseInt(per.qta);
        
        // Stato qta=0
        if (qta === 0) {
            return `
                <div class="space-y-4">
                    <div class="product-card">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="font-semibold text-purple-700 text-lg">ğŸšª Persiana</h4>
                            <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                    class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                ğŸ—‘ï¸ Elimina
                            </button>
                        </div>
                        <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                            <p class="text-sm text-gray-600 mb-3">
                                ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione.
                                <br>Aumenta la quantitÃ  per configurare il prodotto.
                            </p>
                            <div class="max-w-xs">
                                <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                        class="w-full compact-input border rounded font-semibold">
                                    ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Stato attivo: usa renderer centralizzato
        const fields = renderPositionProductFromCampi(project, pos, 'persiana', per);
        
        return `
            <div class="space-y-4">
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-purple-700 text-lg">ğŸšª Persiana</h4>
                        <div class="flex gap-2">
                            <button onclick="ricaricaPersianaDaGlobali('${project.id}', '${pos.id}')"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700"
                                    title="Ricarica configurazione da Config Globali">
                                ğŸ”„ Ricarica
                            </button>
                            <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                    class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                ğŸ—‘ï¸ Elimina
                            </button>
                        </div>
                    </div>
                    
                    <!-- ğŸ“‹ DATI SPECIFICI (da CAMPI_PRODOTTI.posizione) -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">ğŸ“‹ Dati Specifici</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            ${fields ? fields.qtaHtml : ''}
                            ${fields ? fields.posFieldsHtml : ''}
                        </div>
                    </div>

                    <!-- âš™ï¸ CONFIGURAZIONE (da CAMPI_PRODOTTI.configGlobale) -->
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">âš™ï¸ Configurazione</h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            ${fields ? fields.configFieldsHtml : ''}
                        </div>
                    </div>

                    <!-- ğŸ”© ACCESSORI PERSIANA -->
                    ${renderAccessoriPersiana(project.id, pos.id, per)}

                    <!-- ğŸ“· FOTO PERSIANA -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-blue-800 flex items-center gap-2">ğŸ“· Foto Persiana</h5>
                            <button onclick="document.getElementById('foto-persiana-input-${project.id}-${pos.id}').click()"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                ğŸ“· Carica Foto
                            </button>
                            <input type="file" 
                                   id="foto-persiana-input-${project.id}-${pos.id}"
                                   accept="image/*"
                                   style="display: none;"
                                   onchange="addFotoPersiana('${project.id}', '${pos.id}', event)">
                        </div>
                        ${per.foto && per.foto.length > 0 ? `
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${per.foto.map((foto, idx) => `
                                    <div class="relative">
                                        <img src="${foto}" class="w-full h-32 object-cover rounded border-2 border-blue-300">
                                        <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                                class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs hover:bg-red-700">
                                            âœ•
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-sm text-gray-500 italic text-center py-3">1 foto per persiana<br>Nessuna foto caricata</p>
                        `}
                    </div>

                    <!-- ğŸ“ BRM -->
                    ${renderBRMPosizione(project, pos, 'persiana', per)}

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${per.note || ''}</textarea>
                    </div>
                </div>
            </div>
        `;
    }
    
    // === FALLBACK: codice originale ===
    return `
        <div class="space-y-4">
            ${!per ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessuna persiana configurata</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('persiana') ? `
                            <button onclick="addPersiana('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Persiana
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('persiana') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'persiane')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : (parseInt(per.qta) === 0 || per.qta === '0' || per.qta === 0) ? `
                <!-- ğŸ†• FASE 016: Visualizzazione minimale quando qta=0 -->
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-purple-700 text-lg">ğŸšª Persiana</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">
                            ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione. 
                            <br>Aumenta la quantitÃ  per configurare il prodotto.
                        </p>
                        <div class="max-w-xs">
                            <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                    class="w-full compact-input border rounded font-semibold">
                                ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                    <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-purple-700 text-lg">ğŸšª Persiana</h4>
                        <div class="flex gap-2">
                            <button onclick="ricaricaPersianaDaGlobali('${project.id}', '${pos.id}')"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700"
                                    title="Ricarica configurazione da Config Globali">
                                ğŸ”„ Ricarica
                            </button>
                            <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                    class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                ğŸ—‘ï¸ Elimina
                            </button>
                        </div>
                    </div>
                    
                    <!-- ğŸ“‹ DATI SPECIFICI -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                            ğŸ“‹ Dati Specifici
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">QuantitÃ </label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                        class="w-full compact-input border rounded mt-1 font-semibold">
                                    ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Tipo <span class="text-red-600">*</span></label>
                                ${(() => {
                                    const options = OPZIONI_PRODOTTI.persiane.tipi;
                                    const current = per.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `per-tipo-${pos.id}`;
                                    const inputId = `per-tipo-input-${pos.id}`;
                                    // ğŸ†• v4.24: Campo obbligatorio - bordo arancione se vuoto
                                    const isEmpty = !current || current === '';
                                    const borderClass = isEmpty ? 'border-2 border-orange-400 bg-orange-50' : 'border';
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full compact-input ${borderClass} rounded mt-1">
                                            <option value="">-- Seleziona --</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>âœï¸ ALTRO - SCRIVO</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full compact-input border rounded mt-2">
                                    `;
                                })()}
                            </div>
                            <div>
                                <label class="text-xs font-medium">Apertura</label>
                                ${(() => {
                                    const options = OPZIONI_PRODOTTI.persiane.aperture;
                                    const current = per.apertura || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `per-apertura-${pos.id}`;
                                    const inputId = `per-apertura-input-${pos.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>âœï¸ Altro SCRIVO</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'apertura', this.value)"
                                               placeholder="Inserisci apertura personalizzata..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full compact-input border rounded mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>

                    <!-- âš™ï¸ CONFIGURAZIONE -->
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                            âš™ï¸ Configurazione
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                per.azienda || '',
                                OPZIONI_PRODOTTI.persiane.aziende,
                                project.id,
                                pos.id,
                                'persiana',
                                'Azienda'
                            )}

                            <!-- MODELLO -->
                            ${renderSelectWithCustom(
                                'modello',
                                per.modello || '',
                                OPZIONI_PRODOTTI.persiane.modelli,
                                project.id,
                                pos.id,
                                'persiana',
                                'Modello'
                            )}

                            <!-- FISSAGGIO -->
                            ${renderSelectWithCustom(
                                'fissaggio',
                                per.fissaggio || '',
                                OPZIONI_PRODOTTI.persiane.fissaggi,
                                project.id,
                                pos.id,
                                'persiana',
                                'Fissaggio'
                            )}

                            <!-- TIPO TELAIO - Solo se fissaggio = telaio -->
                            ${per.fissaggio === 'telaio' ? renderSelectWithCustom(
                                'tipoTelaio',
                                per.tipoTelaio || '',
                                OPZIONI_PRODOTTI.persiane.tipiTelaio,
                                project.id,
                                pos.id,
                                'persiana',
                                'Tipo Telaio'
                            ) : ''}

                            <!-- COLORE PERSIANA -->
                            ${renderSelectWithCustom(
                                'colorePersiana',
                                per.colorePersiana || '',
                                COLORI_PERSIANE,
                                project.id,
                                pos.id,
                                'persiana',
                                'Colore Persiana'
                            )}

                            <!-- COLORE TELAIO - Solo se fissaggio = telaio -->
                            ${per.fissaggio === 'telaio' ? renderSelectWithCustom(
                                'coloreTelaio',
                                per.coloreTelaio || '',
                                COLORI_PERSIANE,
                                project.id,
                                pos.id,
                                'persiana',
                                'Colore Telaio'
                            ) : ''}

                            <!-- BATTUTA -->
                            ${renderSelectWithCustom(
                                'battuta',
                                per.battuta || '',
                                OPZIONI_PRODOTTI.persiane.battute,
                                project.id,
                                pos.id,
                                'persiana',
                                'Battuta'
                            )}
                        </div>
                    </div>

                    <!-- ğŸ”© ACCESSORI PERSIANA (Cardini + Fermapersiane) -->
                    ${renderAccessoriPersiana(project.id, pos.id, per)}

                    <!-- ğŸ“· FOTO PERSIANA -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                ğŸ“· Foto Persiana
                            </h5>
                            <button onclick="document.getElementById('foto-persiana-input-${project.id}-${pos.id}').click()"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                ğŸ“· Carica Foto
                            </button>
                            <input type="file" 
                                   id="foto-persiana-input-${project.id}-${pos.id}"
                                   accept="image/*"
                                   style="display: none;"
                                   onchange="addFotoPersiana('${project.id}', '${pos.id}', event)">
                        </div>
                        ${per.foto && per.foto.length > 0 ? `
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${per.foto.map((foto, idx) => `
                                    <div class="relative">
                                        <img src="${foto}" class="w-full h-32 object-cover rounded border-2 border-blue-300">
                                        <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                                class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs hover:bg-red-700">
                                            âœ•
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <p class="text-sm text-gray-500 italic text-center py-3">1 foto per persiana<br>Nessuna foto caricata</p>
                        `}
                    </div>

                    <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                ğŸ“ BRM - Misura per Ordine
                            </h5>
                            ${!per.brmPersonalizzato ? `
                                <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                    ğŸ¨ Personalizza BRM
                                </button>
                            ` : `
                                <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                    â†©ï¸ Usa Globale
                                </button>
                            `}
                        </div>
                        
                        ${!per.brmPersonalizzato ? `
                            <div class="bg-white p-3 rounded border-2 border-amber-400">
                                <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="font-semibold">BRM L =</span> ${project.brmConfigPersiane?.misuraBaseL || '?'} ${project.brmConfigPersiane?.operazioneL || '-'} ${project.brmConfigPersiane?.valoreL || '0'}mm</div>
                                    <div><span class="font-semibold">BRM H =</span> ${project.brmConfigPersiane?.misuraBaseH || '?'} ${project.brmConfigPersiane?.operazioneH || '-'} ${project.brmConfigPersiane?.valoreH || '0'}mm</div>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-3 mt-3">
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Larghezza</label>
                                    <input type="number" value="${per.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Altezza</label>
                                    <input type="number" value="${per.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        ` : `
                            <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                <p class="text-sm font-semibold text-purple-800 mb-2">âš™ï¸ Formula Personalizzata:</p>
                                
                                <!-- BRM Larghezza -->
                                <div class="mb-3">
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Larghezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                    <option value="${m}" ${per.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${per.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${per.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreL-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreL || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-persiana-${pos.id}">
                                        = ${per.brmPersonalizzato?.misuraBaseL || '?'} ${per.brmPersonalizzato?.operazioneL || '+'} ${per.brmPersonalizzato?.valoreL || '0'}mm
                                    </div>
                                </div>
                                
                                <!-- BRM Altezza -->
                                <div>
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Altezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                    <option value="${m}" ${per.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${per.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${per.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreH-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreH || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreH', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-persiana-${pos.id}">
                                        = ${per.brmPersonalizzato?.misuraBaseH || '?'} ${per.brmPersonalizzato?.operazioneH || '+'} ${per.brmPersonalizzato?.valoreH || '0'}mm
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ’¾ PULSANTE APPLICA MODIFICHE BRM -->
                            <div class="mt-3 flex justify-center">
                                <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                    ğŸ’¾ Salva
                                </button>
                            </div>
                            
                            <!-- Risultati BRM Calcolati -->
                            <div class="grid md:grid-cols-2 gap-3">
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Larghezza</label>
                                    <input type="number" value="${per.BRM_L || ''}" readonly id="brm-l-result-persiana-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Altezza</label>
                                    <input type="number" value="${per.BRM_H || ''}" readonly id="brm-h-result-persiana-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        `}
                    </div>

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea value="${per.note || ''}"
                                  onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${per.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

        function renderTapparelleTab(project, pos) {
    const tap = pos.tapparella;
    
    return `
        <div class="space-y-4">
            ${!tap ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessun intervento configurato</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('tapparella') ? `
                            <button onclick="addTapparella('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Intervento
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('tapparella') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'tapparelle')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : (parseInt(tap.qta) === 0 || tap.qta === '0' || tap.qta === 0) ? `
                <!-- ğŸ†• FASE 016: Visualizzazione minimale quando qta=0 -->
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-amber-700 text-lg">ğŸšï¸ Tapparella</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">
                            ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione. 
                            <br>Aumenta la quantitÃ  per configurare il prodotto.
                        </p>
                        <div class="max-w-xs">
                            <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                    class="w-full compact-input border rounded font-semibold">
                                ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                    <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-amber-700 text-lg">ğŸšï¸ Intervento Tapparelle</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <!-- ğŸ†• v5.28: CHECKBOX COSA SERVE -->
                    <div class="bg-gradient-to-r from-amber-100 to-orange-100 border-2 border-amber-400 rounded-lg p-4 mb-4">
                        <h5 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                            ğŸ¯ Cosa serve in questa posizione?
                        </h5>
                        <div class="flex flex-wrap gap-4">
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${tap.serveTapparella ? 'border-amber-500 bg-amber-50' : 'border-gray-300'} hover:border-amber-400 transition-all">
                                <input type="checkbox" 
                                       ${tap.serveTapparella ? 'checked' : ''}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'serveTapparella', this.checked)"
                                       class="w-5 h-5 accent-amber-600">
                                <span class="font-semibold text-gray-800">ğŸšï¸ Tapparella nuova</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${tap.serveMotore ? 'border-blue-500 bg-blue-50' : 'border-gray-300'} hover:border-blue-400 transition-all">
                                <input type="checkbox" 
                                       ${tap.serveMotore ? 'checked' : ''}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'serveMotore', this.checked)"
                                       class="w-5 h-5 accent-blue-600">
                                <span class="font-semibold text-gray-800">ğŸ”Œ Motore</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border-2 ${tap.serveAccessori ? 'border-purple-500 bg-purple-50' : 'border-gray-300'} hover:border-purple-400 transition-all">
                                <input type="checkbox" 
                                       ${tap.serveAccessori ? 'checked' : ''}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'serveAccessori', this.checked)"
                                       class="w-5 h-5 accent-purple-600">
                                <span class="font-semibold text-gray-800">ğŸ”§ Accessori</span>
                            </label>
                        </div>
                        ${!tap.serveTapparella && !tap.serveMotore && !tap.serveAccessori ? `
                            <p class="text-sm text-red-600 mt-2 font-medium">âš ï¸ Seleziona almeno un'opzione</p>
                        ` : ''}
                    </div>
                    
                    <!-- ğŸ“‹ v5.40: RILIEVO TAPPARELLA ESISTENTE -->
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            ğŸ“‹ Rilievo: Tapparella esistente
                        </h5>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-lg border-2 ${(tap.tapparellaEsistente || 'manuale') === 'manuale' ? 'border-gray-500 bg-gray-100' : 'border-gray-300 bg-white'} hover:border-gray-400 transition-all">
                                <input type="radio" name="tapEsistente-${pos.id}" value="manuale"
                                       ${(tap.tapparellaEsistente || 'manuale') === 'manuale' ? 'checked' : ''}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tapparellaEsistente', 'manuale')"
                                       class="w-4 h-4 accent-gray-600">
                                <span class="font-medium text-gray-700">ğŸ”„ Manuale</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer px-4 py-2 rounded-lg border-2 ${tap.tapparellaEsistente === 'motorizzata' ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white'} hover:border-blue-400 transition-all">
                                <input type="radio" name="tapEsistente-${pos.id}" value="motorizzata"
                                       ${tap.tapparellaEsistente === 'motorizzata' ? 'checked' : ''}
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tapparellaEsistente', 'motorizzata')"
                                       class="w-4 h-4 accent-blue-600">
                                <span class="font-medium text-gray-700">âš¡ Motorizzata</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- ğŸ“‹ DATI SPECIFICI - sempre visibili -->
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                            ğŸ“‹ Dati Specifici
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">QuantitÃ </label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                        class="w-full compact-input border rounded mt-1 font-semibold">
                                    ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- âš™ï¸ CONFIGURAZIONE TAPPARELLA - solo se serveTapparella -->
                    ${tap.serveTapparella ? `
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                            âš™ï¸ Configurazione
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                tap.azienda || '',
                                OPZIONI_PRODOTTI.tapparelle.aziende,
                                project.id,
                                pos.id,
                                'tapparella',
                                'Azienda'
                            )}

                            <div>
                                <label class="text-xs font-medium">Modello</label>
                                <input type="text" value="${tap.modello || ''}"
                                       placeholder="Mini"
                                       list="modello-tap-list-${pos.id}"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modello', this.value); updateColoriTapparellaDatalist('${pos.id}', this.value);"
                                       class="w-full compact-input border rounded mt-1">
                                <datalist id="modello-tap-list-${pos.id}">
                                    ${(() => {
                                        const modelli = typeof OPZIONI_PRODOTTI !== 'undefined' && OPZIONI_PRODOTTI.getModelliTapparella 
                                            ? OPZIONI_PRODOTTI.getModelliTapparella(tap.azienda)
                                            : [];
                                        return modelli.map(m => `<option value="${typeof m === 'object' ? m.cod + ' - ' + m.nome : m}">`).join('\n');
                                    })()}
                                </datalist>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Colore Telo</label>
                                <input type="text" value="${tap.colore || ''}"
                                       placeholder="Bianco 01"
                                       list="colore-tap-list-${pos.id}"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'colore', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                                <datalist id="colore-tap-list-${pos.id}">
                                    ${(() => {
                                        const colori = getColoriTapparella(tap.modello);
                                        return colori.map(c => `<option value="${c}">`).join('\n');
                                    })()}
                                </datalist>
                            </div>
                            
                            <!-- ğŸ”§ SEZIONE SOSTITUZIONE COMPONENTI -->
                            ${renderSostituzioneComponenti(project.id, pos.id, tap)}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ğŸ”Œ MOTORI - visibile se serveMotore -->
                    ${(() => {
                        // ğŸ†• v5.42: Mostra solo se checkbox serveMotore Ã¨ attivo
                        const mostraMotori = tap.serveMotore;
                        
                        return mostraMotori ? `
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                ğŸ”Œ Motori ${tap.serveMotore && !tap.serveTapparella ? '<span class="text-xs font-normal">(solo motore)</span>' : ''}
                            </h5>
                            <button onclick="addMotoreTapparella('${project.id}', '${pos.id}')"
                                    class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                + Aggiungi Motore
                            </button>
                        </div>
                        ${tap.motori && tap.motori.length > 0 ? `
                            ${tap.motori.map((motore, idx) => `
                                <div class="bg-white p-4 rounded border-2 border-blue-300 mb-3">
                                    <div class="flex justify-between items-center mb-3">
                                        <h6 class="text-sm font-semibold text-blue-700">ğŸ”Œ Motore ${idx + 1}</h6>
                                        <button onclick="removeMotoreTapparella('${project.id}', '${pos.id}', ${idx})"
                                                class="text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 hover:bg-red-50 rounded">
                                            âœ• Rimuovi
                                        </button>
                                    </div>
                                    
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <!-- Modello Motore con prezzo -->
                                        <div>
                                            <label class="text-xs font-medium text-gray-700">ğŸ”Œ Modello Motore</label>
                                            <select class="w-full px-3 py-2 border border-blue-300 rounded text-sm mt-1 bg-white"
                                                    onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'modelloId', this.value)">
                                                <option value="">Seleziona modello...</option>
                                                ${MOTORI_SOMFY.map(m => `
                                                    <option value="${m.id}" ${motore.modelloId === m.id ? 'selected' : ''}>
                                                        ${m.modello} - â‚¬${m.prezzo.toFixed(2)}
                                                    </option>
                                                `).join('')}
                                                <option value="altro" ${motore.modelloId === 'altro' ? 'selected' : ''}>Altro (inserisci manualmente)</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Comando con prezzo -->
                                        <div>
                                            <label class="text-xs font-medium text-gray-700">ğŸ“» Comando / Telecomando</label>
                                            <select class="w-full px-3 py-2 border border-blue-300 rounded text-sm mt-1 bg-white"
                                                    onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'comandoId', this.value)">
                                                <option value="">Nessuno / Non fornito</option>
                                                ${COMANDI_SOMFY.map(c => `
                                                    <option value="${c.id}" ${motore.comandoId === c.id ? 'selected' : ''}>
                                                        ${c.nome} - â‚¬${c.prezzo.toFixed(2)}
                                                    </option>
                                                `).join('')}
                                                <option value="altro" ${motore.comandoId === 'altro' ? 'selected' : ''}>Altro</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Modello manuale (se "Altro" selezionato) -->
                                    ${motore.modelloId === 'altro' ? `
                                        <div class="mt-3">
                                            <label class="text-xs font-medium text-gray-700">ğŸ“ Modello (manuale)</label>
                                            <input type="text" 
                                                   value="${motore.modelloManuale || ''}"
                                                   placeholder="Inserisci marca e modello..."
                                                   onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'modelloManuale', this.value)"
                                                   class="w-full px-3 py-2 border rounded text-sm mt-1">
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Accessori Motore -->
                                    <div class="mt-3">
                                        <label class="text-xs font-medium text-gray-700 block mb-2">ğŸ”§ Accessori Motore</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            ${ACCESSORI_MOTORE_SOMFY.map(acc => {
                                                const checked = motore.accessori?.[acc.id] || false;
                                                return `
                                                    <label class="flex items-center gap-2 px-2 py-1.5 rounded text-xs ${checked ? 'bg-blue-100 border-blue-400' : 'bg-gray-50 border-gray-300'} border cursor-pointer hover:bg-blue-50">
                                                        <input type="checkbox" 
                                                               ${checked ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaAccessorio('${project.id}', '${pos.id}', ${idx}, '${acc.id}', this.checked)"
                                                               class="w-3 h-3 accent-blue-600">
                                                        <span>${acc.nome} <span class="text-blue-600 font-semibold">â‚¬${acc.prezzo.toFixed(2)}</span></span>
                                                    </label>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    <!-- Note motore -->
                                    <div class="mt-3">
                                        <label class="text-xs font-medium text-gray-700">ğŸ“ Note</label>
                                        <input type="text" 
                                               value="${motore.note || ''}"
                                               placeholder="Note aggiuntive..."
                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'note', this.value)"
                                               class="w-full px-3 py-2 border rounded text-sm mt-1">
                                    </div>
                                </div>
                            `).join('')}
                        ` : `
                            <p class="text-sm text-gray-500 italic text-center py-3">Nessun motore aggiunto</p>
                        `}
                    </div>
                    ` : '' })()}

                    <!-- ğŸ”§ COMPONENTI DA FORNIRE - visibile se serveAccessori (senza tapparella) -->
                    ${tap.serveAccessori && !tap.serveTapparella ? `
                    ${renderComponentiDaFornire(project.id, pos.id, tap)}
                    ` : ''}

                    ${typeof renderBRMPosizione === 'function' 
                        ? renderBRMPosizione(project, pos, 'tapparella', tap)
                        : `<div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                ğŸ“ BRM - Misura per Ordine
                            </h5>
                        </div>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div class="bg-white p-2 rounded border">
                                <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Larghezza</label>
                                <input type="number" value="${tap.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                            </div>
                            <div class="bg-white p-2 rounded border">
                                <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Altezza</label>
                                <input type="number" value="${tap.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                            </div>
                        </div>
                    </div>`}

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea value="${tap.note || ''}"
                                  onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${tap.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

        function renderZanzariereTab(project, pos) {
    const zan = pos.zanzariera;
    
    return `
        <div class="space-y-4">
            ${!zan ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessuna zanzariera configurata</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('zanzariera') ? `
                            <button onclick="addZanzariera('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Zanzariera
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('zanzariera') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'zanzariere')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : (parseInt(zan.qta) === 0 || zan.qta === '0' || zan.qta === 0) ? `
                <!-- ğŸ†• FASE 016: Visualizzazione minimale quando qta=0 -->
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-green-700 text-lg">ğŸ¦Ÿ Zanzariera</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">
                            ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione. 
                            <br>Aumenta la quantitÃ  per configurare il prodotto.
                        </p>
                        <div class="max-w-xs">
                            <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                    class="w-full compact-input border rounded font-semibold">
                                ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                    <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-green-700 text-lg">ğŸ¦Ÿ Zanzariera</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <!-- âš™ï¸ TIPO INFISSO ASSOCIATO -->
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                            ğŸ”§ Tipo Infisso Associato
                        </h5>
                        <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                        <div class="flex gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" 
                                       name="tipoInfisso-${project.id}-${pos.id}"
                                       value="F"
                                       ${zan.tipoInfissoAssociato === 'F' ? 'checked' : ''}
                                       onchange="handleZanzarieraTipoChange('${project.id}', '${pos.id}', 'F')"
                                       class="w-4 h-4">
                                <span class="font-medium">F (Finestra)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" 
                                       name="tipoInfisso-${project.id}-${pos.id}"
                                       value="PF"
                                       ${zan.tipoInfissoAssociato === 'PF' ? 'checked' : ''}
                                       onchange="handleZanzarieraTipoChange('${project.id}', '${pos.id}', 'PF')"
                                       class="w-4 h-4">
                                <span class="font-medium">PF (Porta Finestra)</span>
                            </label>
                        </div>
                        ${!zan.tipoInfissoAssociato ? `
                            <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                <p class="text-sm text-amber-800">âš ï¸ Seleziona prima se F o PF</p>
                            </div>
                        ` : ''}
                    </div>

                    <!-- ğŸ“‹ DATI SPECIFICI -->
                    <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                            ğŸ“‹ Dati Specifici
                        </h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">QuantitÃ </label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                        class="w-full compact-input border rounded mt-1 font-semibold">
                                    ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                            <!-- AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                zan.azienda || '',
                                OPZIONI_PRODOTTI.zanzariere.aziende,
                                project.id,
                                pos.id,
                                'zanzariera',
                                'Azienda'
                            )}
                        </div>
                    </div>

                    <!-- âš™ï¸ CONFIGURAZIONE - ğŸ†• v5.717: Logica Palagina con Linea/Modello basati su F/PF -->
                    ${(() => {
                        const isPalagina = zan.azienda === 'Palagina';
                        const tipoSel = zan.tipoInfissoAssociato || 'F';
                        const cfg = project.configZanzariere || {};
                        
                        // Default Linea/Modello basati su F o PF
                        const defaultLinea = tipoSel === 'PF' ? cfg.lineaPF : cfg.lineaF;
                        const defaultModello = tipoSel === 'PF' ? cfg.modelloPF : cfg.modelloF;
                        
                        // Valori attuali (usa default se non specificati)
                        const linea = zan.linea || defaultLinea || '';
                        const modello = zan.modello || defaultModello || '';
                        const fasciaColore = zan.fasciaColore || cfg.fasciaColore || '';
                        const coloreTelaio = zan.coloreTelaio || cfg.coloreTelaio || '';
                        const tipoRete = zan.tipoRete || cfg.tipoRete || '';
                        const colorePlastica = zan.colorePlastica || cfg.colorePlastica || '';
                        
                        if (isPalagina) {
                            return `
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    âš™ï¸ Configurazione Palagina
                                    <span class="text-xs bg-teal-600 text-white px-2 py-0.5 rounded">${tipoSel === 'PF' ? 'Porta-Finestra' : 'Finestra'}</span>
                                </h5>
                                
                                <!-- LINEA + MODELLO -->
                                <div class="grid md:grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="text-xs font-medium">1. Linea</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'linea', this.value); render();"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona linea...</option>
                                            ${Object.entries(PALAGINA_ZANZARIERE.linee).map(([id, l]) => `
                                                <option value="${id}" ${linea === id ? 'selected' : ''}>${l.nome}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">2. Modello</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'modello', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona modello...</option>
                                            ${(PALAGINA_ZANZARIERE.modelli[linea] || []).map(m => `
                                                <option value="${m.id}" ${modello === m.id ? 'selected' : ''}>
                                                    ${m.nome} ${m.cassonetti !== '-' ? '(cass. '+m.cassonetti+')' : ''}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- FASCIA + COLORE -->
                                <div class="grid md:grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="text-xs font-medium">3. Fascia Colore</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'fasciaColore', this.value); render();"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona fascia...</option>
                                            <option value="F1" ${fasciaColore === 'F1' ? 'selected' : ''}>Fascia 1 (Base)</option>
                                            <option value="F2" ${fasciaColore === 'F2' ? 'selected' : ''}>Fascia 2 (Intermedia)</option>
                                            <option value="F3" ${fasciaColore === 'F3' ? 'selected' : ''}>Fascia 3 (Premium)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">4. Colore Telaio</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreTelaio', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona colore...</option>
                                            ${(PALAGINA_ZANZARIERE.colori[fasciaColore] || []).map(c => `
                                                <option value="${c.nome}" ${coloreTelaio === c.nome ? 'selected' : ''}>${c.nome}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- TIPO RETE + COLORE PLASTICA -->
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">5. Tipo Rete</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoRete', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona rete...</option>
                                            ${PALAGINA_ZANZARIERE.reti.map(r => `
                                                <option value="${r.id}" ${tipoRete === r.id ? 'selected' : ''}>${r.nome}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">6. Colore Plastica</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'colorePlastica', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">Seleziona colore plastica...</option>
                                            ${PALAGINA_ZANZARIERE.coloriPlastica.map(c => `
                                                <option value="${c}" ${colorePlastica === c ? 'selected' : ''}>${c}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            `;
                        } else {
                            // Non Palagina - campi generici
                            return `
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    âš™ï¸ Configurazione
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipo', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="Avvolgibile" ${zan.tipo === 'Avvolgibile' ? 'selected' : ''}>Avvolgibile</option>
                                            <option value="PlissÃ©" ${zan.tipo === 'PlissÃ©' ? 'selected' : ''}>PlissÃ©</option>
                                            <option value="Battente" ${zan.tipo === 'Battente' ? 'selected' : ''}>Battente</option>
                                            <option value="Scorrevole" ${zan.tipo === 'Scorrevole' ? 'selected' : ''}>Scorrevole</option>
                                            <option value="Fissa" ${zan.tipo === 'Fissa' ? 'selected' : ''}>Fissa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${zan.coloreTelaio || ''}"
                                               placeholder="Es: Bianco, Marrone"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Rete</label>
                                        <input type="text" value="${zan.tipoRete || ''}"
                                               placeholder="Es: Standard, Anti-polline"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                            </div>
                            `;
                        }
                    })()}

                    ${typeof renderBRMPosizione === 'function' 
                        ? renderBRMPosizione(project, pos, 'zanzariera', zan)
                        : `<div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                        <div class="grid md:grid-cols-2 gap-3">
                            <div class="bg-white p-2 rounded border">
                                <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM L</label>
                                <input type="number" value="${zan.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                            </div>
                            <div class="bg-white p-2 rounded border">
                                <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM H</label>
                                <input type="number" value="${zan.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                            </div>
                        </div>
                    </div>`}

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea value="${zan.note || ''}"
                                  onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${zan.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

        function renderCassonettiTab(project, pos) {
    const cas = pos.cassonetto;
    
    return `
        <div class="space-y-4">
            ${!cas ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessun cassonetto configurato</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('cassonetto') ? `
                            <button onclick="addCassonetto('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Cassonetto
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('cassonetto') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'cassonetti')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : (parseInt(cas.qta) === 0 || cas.qta === '0' || cas.qta === 0) ? `
                <!-- ğŸ†• FASE 016: Visualizzazione minimale quando qta=0 -->
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-orange-700 text-lg">ğŸ“¦ Cassonetto</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">
                            ğŸ’¡ <strong>QuantitÃ  = 0</strong> â†’ Prodotto non presente in questa posizione. 
                            <br>Aumenta la quantitÃ  per configurare il prodotto.
                        </p>
                        <div class="max-w-xs">
                            <label class="text-xs font-medium block mb-1">QuantitÃ </label>
                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                    class="w-full compact-input border rounded font-semibold">
                                ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                    <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-orange-700 text-lg">ğŸ“¦ Cassonetto</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <!-- ğŸ“‹ DATI GENERALI -->
                    <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                            ğŸ“‹ Dati Generali
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <!-- QUANTITÃ€ -->
                            <div>
                                <label class="text-xs font-medium">QuantitÃ </label>
                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                        class="w-full compact-input border rounded mt-1 font-semibold">
                                    ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                        <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                cas.azienda || '',
                                OPZIONI_PRODOTTI.cassonetti.aziende,
                                project.id,
                                pos.id,
                                'cassonetto',
                                'Azienda'
                            )}
                        </div>
                        
                        ${(() => {
                            const azienda = cas.azienda || '';
                            
                            // ====== FINSTRAL ======
                            if (azienda === 'Finstral') {
                                return `
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <!-- 2. A SOFFITTO (checkbox) -->
                                        <div>
                                            <label class="text-xs font-medium flex items-center gap-2">
                                                <input type="checkbox" 
                                                       ${cas.aSoffitto ? 'checked' : ''}
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'aSoffitto', this.checked)"
                                                       class="w-4 h-4">
                                                2. A Soffitto
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- ===== v5.54: CAMPI CALCOLO PREZZI RISTRUTTURATI ===== -->
                                    <div class="border-t-2 border-orange-300 pt-3 mt-3">
                                        <p class="text-xs font-bold text-orange-700 mb-2">ğŸ“Š Dati per Calcolo Prezzo:</p>
                                        <div class="grid md:grid-cols-4 gap-3">
                                            <!-- 3. MATERIALE -->
                                            <div>
                                                <label class="text-xs font-medium">3. Materiale</label>
                                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'materialeCass', this.value); render();"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    <option value="PVC" ${cas.materialeCass === 'PVC' ? 'selected' : ''}>PVC</option>
                                                    <option value="Legno" ${cas.materialeCass === 'Legno' ? 'selected' : ''}>Legno</option>
                                                </select>
                                            </div>
                                            
                                            <!-- 4. CODICE CASSONETTO -->
                                            <div>
                                                <label class="text-xs font-medium">4. Codice</label>
                                                ${renderSelectCodiceCassPos(cas, project.id, pos.id)}
                                            </div>
                                            
                                            <!-- 5. GRUPPO COLORE -->
                                            <div>
                                                <label class="text-xs font-medium">5. Gruppo Colore</label>
                                                ${renderSelectGruppoColoreCassPos(cas, project.id, pos.id)}
                                            </div>
                                            
                                            <!-- 6. COLORE (codice specifico, auto da infisso) -->
                                            <div>
                                                <label class="text-xs font-medium">6. Colore</label>
                                                ${renderSelectColoreCassPos(cas, pos, project.id, pos.id)}
                                                <!-- Checkbox sync colore -->
                                                <label class="text-xs text-gray-500 flex items-center gap-1 mt-1 cursor-pointer">
                                                    <input type="checkbox" 
                                                           ${cas.coloreDaInfisso !== false ? 'checked' : ''}
                                                           onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'coloreDaInfisso', this.checked); if(this.checked) sincronizzaColoreCassonettoPos('${project.id}', '${pos.id}');"
                                                           class="w-3 h-3">
                                                    = colore serramento
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- 7. ISOLAMENTO (sempre visibile) -->
                                        <div class="grid md:grid-cols-4 gap-3 mt-3">
                                            <div>
                                                <label class="text-xs font-medium">7. Isolamento</label>
                                                <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'codiceIsolamento', this.value)"
                                                        class="w-full compact-input border rounded mt-1 bg-yellow-50">
                                                    <option value="" ${!cas.codiceIsolamento ? 'selected' : ''}>--</option>
                                                    <option value="posaclima" ${cas.codiceIsolamento === 'posaclima' ? 'selected' : ''}>Isolamento Posaclima</option>
                                                    <option value="40830" ${cas.codiceIsolamento === '40830' ? 'selected' : ''}>40830 (25mm)</option>
                                                    <option value="40831" ${cas.codiceIsolamento === '40831' ? 'selected' : ''}>40831 (13mm)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // ====== MAGÃ’ E ALPAC ======
                            if (azienda === 'MagÃ²' || azienda === 'Alpac') {
                                return `
                                    <div class="grid md:grid-cols-3 gap-3 mt-3">
                                        <!-- 2. TIPO -->
                                        <div>
                                            <label class="text-xs font-medium">2. Tipo</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'tipo', this.value)"
                                                    class="w-full compact-input border rounded mt-1">
                                                <option value="">--</option>
                                                <option value="Cassonetto" ${cas.tipo === 'Cassonetto' ? 'selected' : ''}>Cassonetto</option>
                                                <option value="Monoblocco" ${cas.tipo === 'Monoblocco' ? 'selected' : ''}>Monoblocco</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 3. POSA -->
                                        <div>
                                            <label class="text-xs font-medium">3. Posa</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'posa', this.value)"
                                                    class="w-full compact-input border rounded mt-1">
                                                <option value="">--</option>
                                                <option value="Frontale" ${cas.posa === 'Frontale' ? 'selected' : ''}>Frontale</option>
                                                <option value="Rasomuro" ${cas.posa === 'Rasomuro' ? 'selected' : ''}>Rasomuro</option>
                                                <option value="Esterna dal sotto" ${cas.posa === 'Esterna dal sotto' ? 'selected' : ''}>Esterna dal sotto</option>
                                                <option value="Interna dal sotto" ${cas.posa === 'Interna dal sotto' ? 'selected' : ''}>Interna dal sotto</option>
                                            </select>
                                        </div>
                                        
                                        <!-- 4. FINITURA -->
                                        <div>
                                            <label class="text-xs font-medium">4. Finitura</label>
                                            <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'finitura', this.value)"
                                                    class="w-full compact-input border rounded mt-1">
                                                <option value="">--</option>
                                                <option value="Grezzo da rasare" ${cas.finitura === 'Grezzo da rasare' ? 'selected' : ''}>Grezzo da rasare</option>
                                                <option value="Mano di fondo" ${cas.finitura === 'Mano di fondo' ? 'selected' : ''}>Mano di fondo</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }
                            
                            // Nessuna azienda o azienda custom
                            if (!azienda || (azienda !== 'Finstral' && azienda !== 'MagÃ²' && azienda !== 'Alpac')) {
                                return `
                                    <div class="mt-3 bg-gray-50 border-2 border-gray-300 rounded-lg p-3">
                                        <p class="text-xs text-gray-600 text-center">
                                            âš ï¸ Seleziona un'azienda (Finstral, MagÃ² o Alpac) per visualizzare i campi specifici
                                        </p>
                                    </div>
                                `;
                            }
                            
                            return '';
                        })()}
                    </div>

                    <!-- ğŸ“ MISURE CASSONETTO (mm) -->
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                            ğŸ“ Misure Cassonetto (mm)
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">LS</label>
                                <input type="number" value="${cas.LS || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'LS', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">SRSX</label>
                                <input type="number" value="${cas.SRSX || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRSX', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <!-- âœ… v4.97: ZSX con radio button + validazione -->
                            <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                <label class="text-xs font-medium text-blue-800">ZSX (Spazio SX)</label>
                                <div class="flex flex-col gap-1 mt-1">
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zsx-tipo-${pos.id}" value="muro"
                                               ${cas.ZSX_tipo === 'muro' ? 'checked' : ''}
                                               onchange="updateZSXTipo('${project.id}', '${pos.id}', 'muro')">
                                        <span>ğŸ§± A muro (=SRSX)</span>
                                    </label>
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zsx-tipo-${pos.id}" value="libero"
                                               ${cas.ZSX_tipo === 'libero' ? 'checked' : ''}
                                               onchange="updateZSXTipo('${project.id}', '${pos.id}', 'libero')">
                                        <span>âœ… Libero (&gt;50mm)</span>
                                    </label>
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zsx-tipo-${pos.id}" value="limitato"
                                               ${cas.ZSX_tipo === 'limitato' ? 'checked' : ''}
                                               onchange="updateZSXTipo('${project.id}', '${pos.id}', 'limitato')">
                                        <span>âš ï¸ Limitato:</span>
                                        <input type="number" 
                                               id="zsx-input-${pos.id}"
                                               value="${cas.ZSX_tipo === 'limitato' ? (cas.ZSX || '') : ''}"
                                               placeholder="mm"
                                               min="1"
                                               ${cas.ZSX_tipo !== 'limitato' ? 'disabled' : ''}
                                               onchange="validateAndUpdateZSX('${project.id}', '${pos.id}', this.value)"
                                               class="w-16 px-1 py-0.5 border rounded text-xs ${cas.ZSX_tipo !== 'limitato' ? 'bg-gray-100' : (cas.ZSX_tipo === 'limitato' && !cas.ZSX ? 'border-red-500 bg-red-50' : '')}">
                                        <span class="text-xs">mm</span>
                                    </label>
                                </div>
                                <!-- Messaggio errore ZSX > SRSX -->
                                ${(() => {
                                    const zsx = parseInt(cas.ZSX) || 0;
                                    const srsx = parseInt(cas.SRSX) || 0;
                                    if (cas.ZSX_tipo === 'limitato' && zsx > 0 && srsx > 0 && zsx > srsx) {
                                        return '<div class="text-xs text-red-600 font-semibold mt-1">âš ï¸ ZSX (' + zsx + 'mm) supera SRSX (' + srsx + 'mm)!</div>';
                                    }
                                    if (cas.ZSX_tipo === 'limitato' && !cas.ZSX) {
                                        return '<div class="text-xs text-orange-600 mt-1">âš ï¸ Inserisci mm disponibili</div>';
                                    }
                                    return '';
                                })()}
                            </div>
                            <div>
                                <label class="text-xs font-medium">SRDX</label>
                                <input type="number" value="${cas.SRDX || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRDX', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <!-- âœ… v4.97: ZDX con radio button + validazione -->
                            <div class="bg-purple-50 p-2 rounded border border-purple-200">
                                <label class="text-xs font-medium text-purple-800">ZDX (Spazio DX)</label>
                                <div class="flex flex-col gap-1 mt-1">
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zdx-tipo-${pos.id}" value="muro"
                                               ${cas.ZDX_tipo === 'muro' ? 'checked' : ''}
                                               onchange="updateZDXTipo('${project.id}', '${pos.id}', 'muro')">
                                        <span>ğŸ§± A muro (=SRDX)</span>
                                    </label>
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zdx-tipo-${pos.id}" value="libero"
                                               ${cas.ZDX_tipo === 'libero' ? 'checked' : ''}
                                               onchange="updateZDXTipo('${project.id}', '${pos.id}', 'libero')">
                                        <span>âœ… Libero (&gt;50mm)</span>
                                    </label>
                                    <label class="flex items-center gap-1 text-xs cursor-pointer">
                                        <input type="radio" name="zdx-tipo-${pos.id}" value="limitato"
                                               ${cas.ZDX_tipo === 'limitato' ? 'checked' : ''}
                                               onchange="updateZDXTipo('${project.id}', '${pos.id}', 'limitato')">
                                        <span>âš ï¸ Limitato:</span>
                                        <input type="number" 
                                               id="zdx-input-${pos.id}"
                                               value="${cas.ZDX_tipo === 'limitato' ? (cas.ZDX || '') : ''}"
                                               placeholder="mm"
                                               min="1"
                                               ${cas.ZDX_tipo !== 'limitato' ? 'disabled' : ''}
                                               onchange="validateAndUpdateZDX('${project.id}', '${pos.id}', this.value)"
                                               class="w-16 px-1 py-0.5 border rounded text-xs ${cas.ZDX_tipo !== 'limitato' ? 'bg-gray-100' : (cas.ZDX_tipo === 'limitato' && !cas.ZDX ? 'border-red-500 bg-red-50' : '')}">
                                        <span class="text-xs">mm</span>
                                    </label>
                                </div>
                                <!-- Messaggio errore ZDX > SRDX -->
                                ${(() => {
                                    const zdx = parseInt(cas.ZDX) || 0;
                                    const srdx = parseInt(cas.SRDX) || 0;
                                    if (cas.ZDX_tipo === 'limitato' && zdx > 0 && srdx > 0 && zdx > srdx) {
                                        return '<div class="text-xs text-red-600 font-semibold mt-1">âš ï¸ ZDX (' + zdx + 'mm) supera SRDX (' + srdx + 'mm)!</div>';
                                    }
                                    if (cas.ZDX_tipo === 'limitato' && !cas.ZDX) {
                                        return '<div class="text-xs text-orange-600 mt-1">âš ï¸ Inserisci mm disponibili</div>';
                                    }
                                    return '';
                                })()}
                            </div>
                            <div>
                                <label class="text-xs font-medium">HCASS</label>
                                <input type="number" value="${cas.HCASS || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'HCASS', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">B</label>
                                <input type="number" value="${cas.B || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'B', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">C</label>
                                <input type="number" value="${cas.C || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'C', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">BSuperiore</label>
                                <input type="number" value="${cas.BSuperiore || ''}"
                                       placeholder="-"
                                       onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'BSuperiore', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                        </div>
                        
                        <!-- âœ… v4.86: Controllo B-C con ID per aggiornamento real-time -->
                        <div id="bc-validation-${pos.id}">
                        ${(() => {
                            // Validazione B - C = Prof. Muro Int Â± 10mm
                            const b = parseFloat(cas.B) || 0;
                            const c = parseFloat(cas.C) || 0;
                            const diff = b - c;
                            
                            // Prendi Prof. Muro Int (override o globale)
                            const profMuroInt = pos.caratteristicheMuroOverride?.profMuroInt 
                                ? parseFloat(pos.caratteristicheMuroOverride.profMuroInt) 
                                : parseFloat(project.caratteristicheMuro?.profMuroInt) || 0;
                            
                            if (b === 0 || c === 0 || profMuroInt === 0) {
                                return `
                                    <div class="mt-3 bg-gray-100 border-l-4 border-gray-400 p-3">
                                        <p class="text-sm text-gray-600">
                                            â„¹ï¸ Inserisci B, C e Prof. Muro Int per attivare il controllo
                                        </p>
                                    </div>
                                `;
                            }
                            
                            const differenza = Math.abs(diff - profMuroInt);
                            const isValid = differenza <= 10;
                            
                            if (isValid) {
                                return `
                                    <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-3">
                                        <p class="text-sm text-green-800">
                                            âœ… <strong>Controllo OK:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm âœ“
                                        </p>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-3">
                                        <p class="text-sm text-red-800">
                                            âš ï¸ <strong>ATTENZIONE:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm (Tolleranza Â±10mm superata!)
                                        </p>
                                    </div>
                                `;
                            }
                        })()}
                        </div>
                        
                        ${(() => {
                            // âš ï¸ CONTROLLI ALTEZZE CON CASSONETTO
                            const hcass = parseFloat(cas.HCASS) || 0;
                            const hmt = parseFloat(pos.misure?.HMT) || 0;
                            const hsoffitto = parseFloat(pos.misure?.HSoffitto) || 0;
                            const hPavParapetto = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                            const hParapettoSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                            
                            // BRM altezze per controllo 4
                            const brmHInfisso = parseFloat(pos.infisso?.BRM_H) || 0;
                            const brmHCassonetto = parseFloat(cas.BRM_H) || 0;
                            
                            // Determina se Ã¨ PF o F dal tipo infisso
                            const tipoInfisso = pos.infisso?.tipo || '';
                            const isPF = tipoInfisso.includes('PF');
                            const isF = tipoInfisso.includes('F') && !isPF;
                            
                            let warnings = [];
                            
                            // âœ… CONTROLLO 1: PF â†’ HSoffitto > HMT + HCASS
                            if (isPF && hmt > 0 && hcass > 0 && hsoffitto > 0) {
                                const somma = hmt + hcass;
                                if (hsoffitto > somma) {
                                    warnings.push({
                                        type: 'success',
                                        msg: `âœ… <strong>PF OK:</strong> HSoffitto (${hsoffitto}mm) > HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) âœ“`
                                    });
                                } else {
                                    warnings.push({
                                        type: 'error',
                                        msg: `âš ï¸ <strong>PF ERRORE:</strong> HSoffitto (${hsoffitto}mm) <= HMT + HCASS (${hmt} + ${hcass} = ${somma}mm)!`
                                    });
                                }
                            }
                            
                            // âœ… CONTROLLO 2: F â†’ HParapettoSoffitto > HMT + HCASS (v4.88 FIX)
                            if (isF && hParapettoSoff > 0 && hmt > 0 && hcass > 0) {
                                const somma = hmt + hcass;
                                if (hParapettoSoff > somma) {
                                    warnings.push({
                                        type: 'success',
                                        msg: `âœ… <strong>F OK:</strong> HParapettoSoffitto (${hParapettoSoff}mm) > HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) âœ“`
                                    });
                                } else {
                                    warnings.push({
                                        type: 'error',
                                        msg: `âš ï¸ <strong>F ERRORE:</strong> HParapettoSoffitto (${hParapettoSoff}mm) <= HMT + HCASS (${hmt} + ${hcass} = ${somma}mm)!`
                                    });
                                }
                            }
                            
                            // âœ… CONTROLLO 3: HPavimentoParapetto + HParapettoSoffitto = HSoffitto Â± 10mm
                            if (hPavParapetto > 0 && hParapettoSoff > 0 && hsoffitto > 0) {
                                const somma = hPavParapetto + hParapettoSoff;
                                const diff = Math.abs(somma - hsoffitto);
                                if (diff <= 10) {
                                    warnings.push({
                                        type: 'success',
                                        msg: `âœ… <strong>ALTEZZE OK:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) = HSoffitto (${hsoffitto}mm) Â± 10mm | Diff: ${diff.toFixed(1)}mm âœ“`
                                    });
                                } else {
                                    warnings.push({
                                        type: 'error',
                                        msg: `âš ï¸ <strong>ALTEZZE ERRORE:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) â‰  HSoffitto (${hsoffitto}mm) | Diff: ${diff.toFixed(1)}mm (Tolleranza Â±10mm superata!)`
                                    });
                                }
                            }
                            
                            // âœ… CONTROLLO 4 (v4.88): BRM_H Infisso + BRM_H Cassonetto <= Spazio disponibile
                            if (brmHInfisso > 0 && brmHCassonetto > 0) {
                                const sommaBRM = brmHInfisso + brmHCassonetto;
                                const spazioDisponibile = isPF ? hsoffitto : hParapettoSoff;
                                const tipoSpazio = isPF ? 'HSoffitto' : 'HParapettoSoffitto';
                                
                                if (spazioDisponibile > 0) {
                                    if (sommaBRM <= spazioDisponibile) {
                                        warnings.push({
                                            type: 'success',
                                            msg: `âœ… <strong>BRM OK:</strong> BRM_H Infisso + BRM_H Cass (${brmHInfisso} + ${brmHCassonetto} = ${sommaBRM}mm) <= ${tipoSpazio} (${spazioDisponibile}mm) âœ“`
                                        });
                                    } else {
                                        warnings.push({
                                            type: 'error',
                                            msg: `âš ï¸ <strong>BRM ERRORE:</strong> BRM_H Infisso + BRM_H Cass (${brmHInfisso} + ${brmHCassonetto} = ${sommaBRM}mm) > ${tipoSpazio} (${spazioDisponibile}mm)!`
                                        });
                                    }
                                }
                            }
                            
                            // Genera HTML per i messaggi
                            if (warnings.length === 0) {
                                return ''; // Nessun controllo applicabile
                            }
                            
                            return warnings.map(w => {
                                const bgColor = w.type === 'success' ? 'bg-green-100' : 'bg-red-100';
                                const borderColor = w.type === 'success' ? 'border-green-500' : 'border-red-500';
                                const textColor = w.type === 'success' ? 'text-green-800' : 'text-red-800';
                                
                                return `
                                    <div class="mt-3 ${bgColor} border-l-4 ${borderColor} p-3">
                                        <p class="text-sm ${textColor}">${w.msg}</p>
                                    </div>
                                `;
                            }).join('');
                        })()}
                        
                        <div class="mt-3 bg-blue-100 border-l-4 border-blue-500 p-3">
                            <p class="text-sm text-blue-800">
                                ğŸ“ <strong>ZSX/ZDX:</strong> A muro = ZSX=SRSX (attaccato) | Libero = spazio &gt;50mm | Limitato = inserisci mm (deve essere â‰¤ SRSX/SRDX)
                            </p>
                        </div>
                    </div>

                    <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                ğŸ“ BRM - Misura per Ordine
                            </h5>
                            <div class="flex gap-2">
                                ${!cas.brmPersonalizzato ? `
                                    <button onclick="ricalcolaBRMCassonetto('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                                        ğŸ”„ Ricalcola BRM
                                    </button>
                                    <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'cassonetto')"
                                            class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                        ğŸ¨ Personalizza BRM
                                    </button>
                                ` : `
                                    <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'cassonetto')"
                                            class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                        â†©ï¸ Usa Globale
                                    </button>
                                `}
                            </div>
                        </div>
                        
                        ${!cas.brmPersonalizzato ? `
                            <div class="bg-white p-3 rounded border-2 border-amber-400">
                                <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><span class="font-semibold">BRM L =</span> ${project.brmConfigCassonetti?.misuraBaseL || '?'} ${project.brmConfigCassonetti?.operazioneL || '-'} ${project.brmConfigCassonetti?.valoreL || '0'}mm</div>
                                    <div><span class="font-semibold">BRM H =</span> ${project.brmConfigCassonetti?.misuraBaseH || '?'} ${project.brmConfigCassonetti?.operazioneH || '-'} ${project.brmConfigCassonetti?.valoreH || '0'}mm</div>
                                    <div><span class="font-semibold">BRM C =</span> ${project.brmConfigCassonetti?.misuraBaseC || '?'} ${project.brmConfigCassonetti?.operazioneC || '-'} ${project.brmConfigCassonetti?.valoreC || '0'}mm</div>
                                    <div><span class="font-semibold">BRM B =</span> ${project.brmConfigCassonetti?.misuraBaseB || '?'} ${project.brmConfigCassonetti?.operazioneB || '-'} ${project.brmConfigCassonetti?.valoreB || '0'}mm</div>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-3 mt-3">
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Larghezza</label>
                                    <input type="number" value="${cas.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                    <!-- âœ… v4.87: Nota allargamento dinamico -->
                                    <div class="text-xs mt-1 ${(cas.ZSX_tipo === 'muro' || cas.ZDX_tipo === 'muro') ? 'text-orange-600' : 'text-gray-500'}">
                                        ğŸ“ Allargamento: ${(() => {
                                            const valoreL = parseFloat(project.brmConfigCassonetti?.valoreL) || 0;
                                            const perLato = valoreL / 2;
                                            const allSX = (cas.ZSX_tipo === 'muro') ? 0 : perLato;
                                            const allDX = (cas.ZDX_tipo === 'muro') ? 0 : perLato;
                                            const tot = allSX + allDX;
                                            return `SX +${allSX}mm (${cas.ZSX_tipo || 'libero'}) | DX +${allDX}mm (${cas.ZDX_tipo || 'libero'}) = +${tot}mm`;
                                        })()}
                                    </div>
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM Altezza</label>
                                    <input type="number" value="${cas.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM C</label>
                                    <input type="number" value="${cas.BRM_C || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border">
                                    <label class="text-xs font-semibold text-amber-800 block">ğŸ“ BRM B</label>
                                    <input type="number" value="${cas.BRM_B || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        ` : `
                            <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                <p class="text-sm font-semibold text-purple-800 mb-2">âš™ï¸ Formula Personalizzata:</p>
                                
                                <!-- BRM Larghezza -->
                                <div class="mb-3">
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Larghezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['(LS+SRSX+SRDX)', 'LVT', 'LF', 'TMV', 'BRM_L_INFISSO'].map(m => `
                                                    <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${cas.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${cas.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreL-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreL || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-cassonetto-${pos.id}">
                                        = ${cas.brmPersonalizzato?.misuraBaseL || '?'} ${cas.brmPersonalizzato?.operazioneL || '+'} ${cas.brmPersonalizzato?.valoreL || '0'}mm
                                    </div>
                                </div>
                                
                                <!-- BRM Altezza -->
                                <div>
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM Altezza</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['HCASS', 'H Soffitto', 'H Parapetto/Soffitto', 'BRM_H_INFISSO'].map(m => `
                                                    <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneH', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${cas.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${cas.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreH-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreH || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreH', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-cassonetto-${pos.id}">
                                        = ${cas.brmPersonalizzato?.misuraBaseH || '?'} ${cas.brmPersonalizzato?.operazioneH || '+'} ${cas.brmPersonalizzato?.valoreH || '0'}mm
                                    </div>
                                </div>
                                
                                <!-- BRM C -->
                                <div class="mb-3">
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM C</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseC', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['Prof. Muro Int â†’ MI', 'C'].map(m => `
                                                    <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseC === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneC', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${cas.brmPersonalizzato?.operazioneC === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${cas.brmPersonalizzato?.operazioneC === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreC-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreC || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreC', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-c-cassonetto-${pos.id}">
                                        = ${cas.brmPersonalizzato?.misuraBaseC || '?'} ${cas.brmPersonalizzato?.operazioneC || '+'} ${cas.brmPersonalizzato?.valoreC || '0'}mm
                                    </div>
                                </div>
                                
                                <!-- BRM B -->
                                <div>
                                    <label class="text-xs font-semibold text-purple-800 block mb-1">ğŸ“ BRM B</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                            <select id="brm-misuraBaseB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseB', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${['Prof. Muro Int â†’ MI', 'B'].map(m => `
                                                    <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseB === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                            <select id="brm-operazioneB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneB', this.value)"
                                                    class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                <option value="+" ${cas.brmPersonalizzato?.operazioneB === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${cas.brmPersonalizzato?.operazioneB === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-600 block mb-1">mm</label>
                                            <input type="number" id="brm-valoreB-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreB || '0'}"
                                                   onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreB', this.value)"
                                                   class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-b-cassonetto-${pos.id}">
                                        = ${cas.brmPersonalizzato?.misuraBaseB || '?'} ${cas.brmPersonalizzato?.operazioneB || '+'} ${cas.brmPersonalizzato?.valoreB || '0'}mm
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ğŸ’¾ PULSANTE APPLICA MODIFICHE BRM -->
                            <div class="mt-3 flex justify-center">
                                <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                    ğŸ’¾ Salva
                                </button>
                            </div>
                            
                            <!-- Risultati BRM Calcolati -->
                            <div class="grid md:grid-cols-2 gap-3">
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Larghezza</label>
                                    <input type="number" value="${cas.BRM_L || ''}" readonly id="brm-l-result-cassonetto-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM Altezza</label>
                                    <input type="number" value="${cas.BRM_H || ''}" readonly id="brm-h-result-cassonetto-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM C</label>
                                    <input type="number" value="${cas.BRM_C || ''}" readonly id="brm-c-result-cassonetto-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                                <div class="bg-white p-2 rounded border-2 border-green-500">
                                    <label class="text-xs font-semibold text-green-800 block">âœ… BRM B</label>
                                    <input type="number" value="${cas.BRM_B || ''}" readonly id="brm-b-result-cassonetto-${pos.id}"
                                           class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                </div>
                            </div>
                        `}
                    </div>

                    <div class="mt-3">
                        <label class="text-xs font-medium">ğŸ“ Note</label>
                        <textarea value="${cas.note || ''}"
                                  onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'note', this.value)"
                                  class="w-full compact-input border rounded mt-1"
                                  rows="2">${cas.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

function renderPortonciniTab(project, pos) {
    const ptc = pos.portoncino;
    
    return `
        <div class="space-y-4">
            ${!ptc ? `
                <!-- ğŸ¯ STATO INIZIALE: Prodotto non ancora creato -->
                <div class="text-center py-8 bg-yellow-50 border-2 border-yellow-300 rounded-lg">
                    <p class="text-gray-700 mb-4 font-medium text-lg">Nessun portoncino configurato</p>
                    <div class="flex flex-col items-center gap-3">
                        ${!pos.prodottiAssenti?.includes('portoncino') ? `
                            <button onclick="addPortoncino('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-teal-600 text-white rounded-lg font-medium hover:bg-teal-700 shadow-sm hover:shadow-md transition-all">
                                + Aggiungi Portoncino Finstral
                            </button>
                        ` : ''}
                        <label class="flex items-center gap-2 cursor-pointer text-sm bg-white px-4 py-2 rounded-lg border-2 border-yellow-400 shadow-sm hover:shadow-md transition-shadow">
                            <input type="checkbox" 
                                   ${pos.prodottiAssenti?.includes('portoncino') ? 'checked' : ''}
                                   onchange="toggleProdottoAssente('${project.id}', '${pos.id}', 'portoncini')"
                                   class="w-4 h-4">
                            <span class="text-gray-700 font-medium">âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            ` : `
                <div class="product-card">
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="font-semibold text-teal-700 text-lg">ğŸšª Portoncino Finstral</h4>
                        <button onclick="deleteProduct('${project.id}', '${pos.id}', 'portoncino')"
                                class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                            ğŸ—‘ï¸ Elimina
                        </button>
                    </div>
                    
                    <!-- ğŸ“ DIMENSIONI BRM -->
                    <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                            ğŸ“ Dimensioni BRM (Battuta Riferimento Misura)
                        </h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">BRM Larghezza (mm)</label>
                                <input type="number" 
                                       value="${ptc.BRM_L || ''}"
                                       placeholder="es. 1000"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'BRM_L', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-medium">BRM Altezza (mm)</label>
                                <input type="number" 
                                       value="${ptc.BRM_H || ''}"
                                       placeholder="es. 2200"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'BRM_H', this.value)"
                                       class="w-full compact-input border rounded mt-1 font-bold">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ—ï¸ TELAIO -->
                    <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                            ğŸ—ï¸ Telaio
                        </h5>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs font-medium">Tipo Telaio</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'tipoTelaio', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="L" ${ptc.tipoTelaio === 'L' ? 'selected' : ''}>L - Standard</option>
                                    <option value="Z" ${ptc.tipoTelaio === 'Z' ? 'selected' : ''}>Z - Ribassato</option>
                                    <option value="T" ${ptc.tipoTelaio === 'T' ? 'selected' : ''}>T - Termico</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Soglia</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'soglia', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="standard" ${ptc.soglia === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="ribassata" ${ptc.soglia === 'ribassata' ? 'selected' : ''}>Ribassata</option>
                                    <option value="filo-pavimento" ${ptc.soglia === 'filo-pavimento' ? 'selected' : ''}>Filo Pavimento</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Montante (mm)</label>
                                <input type="text" 
                                       value="${ptc.montante || ''}"
                                       placeholder="Es: 110"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'montante', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Traversa (mm)</label>
                                <input type="text" 
                                       value="${ptc.traversa || ''}"
                                       placeholder="Es: 110"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'traversa', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸšª ANTA E PANNELLO -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                            ğŸšª Anta e Pannello
                        </h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                ${renderPortoncinoModelButton(ptc.modelloAnta, 'PVC-PVC',
                                    `openPortoncinoModelPicker('${project.id}','${pos.id}','legacy','${ptc.modelloAnta || ''}','PVC-PVC')`)}
                            </div>
                            <div>
                                <label class="text-xs font-medium">Pannello</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'pannello', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Seleziona...</option>
                                    <option value="liscio" ${ptc.pannello === 'liscio' ? 'selected' : ''}>Liscio</option>
                                    <option value="bugna" ${ptc.pannello === 'bugna' ? 'selected' : ''}>Bugna</option>
                                    <option value="design" ${ptc.pannello === 'design' ? 'selected' : ''}>Design</option>
                                    <option value="personalizzato" ${ptc.pannello === 'personalizzato' ? 'selected' : ''}>Personalizzato</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ¨ MATERIALI E COLORI -->
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                            ğŸ¨ Materiali e Colori
                        </h5>
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- INTERNO -->
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <h6 class="font-semibold text-yellow-900 mb-2 text-sm">Interno</h6>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-medium">Materiale</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'materialeInt', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Sel...</option>
                                            <option value="pvc" ${ptc.materialeInt === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${ptc.materialeInt === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                            <option value="legno" ${ptc.materialeInt === 'legno' ? 'selected' : ''}>Legno</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" 
                                               value="${ptc.coloreInt || ''}"
                                               placeholder="RAL..."
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'coloreInt', this.value)"
                                               class="w-full compact-input border rounded mt-1 text-sm">
                                    </div>
                                </div>
                            </div>
                            <!-- ESTERNO -->
                            <div class="bg-yellow-100 p-3 rounded-lg">
                                <h6 class="font-semibold text-yellow-900 mb-2 text-sm">Esterno</h6>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-medium">Materiale</label>
                                        <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'materialeEst', this.value)"
                                                class="w-full compact-input border rounded mt-1 text-sm">
                                            <option value="">Sel...</option>
                                            <option value="pvc" ${ptc.materialeEst === 'pvc' ? 'selected' : ''}>PVC</option>
                                            <option value="alluminio" ${ptc.materialeEst === 'alluminio' ? 'selected' : ''}>Alluminio</option>
                                            <option value="legno" ${ptc.materialeEst === 'legno' ? 'selected' : ''}>Legno</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" 
                                               value="${ptc.coloreEst || ''}"
                                               placeholder="RAL..."
                                               onchange="updatePortoncino('${project.id}', '${pos.id}', 'coloreEst', this.value)"
                                               class="w-full compact-input border rounded mt-1 text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸªŸ VETRO -->
                    <div class="bg-cyan-50 border-2 border-cyan-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-cyan-800 mb-3 flex items-center gap-2">
                            ğŸªŸ Vetro
                        </h5>
                        <div class="grid md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Tipo Vetro</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'tipoVetro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Nessuno</option>
                                    <option value="chiaro" ${ptc.tipoVetro === 'chiaro' ? 'selected' : ''}>Chiaro</option>
                                    <option value="satinato" ${ptc.tipoVetro === 'satinato' ? 'selected' : ''}>Satinato</option>
                                    <option value="ornamentale" ${ptc.tipoVetro === 'ornamentale' ? 'selected' : ''}>Ornamentale</option>
                                    <option value="sicurezza" ${ptc.tipoVetro === 'sicurezza' ? 'selected' : ''}>Sicurezza</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Vetro Ornamentale</label>
                                <input type="text" 
                                       value="${ptc.vetroOrnamentale || ''}"
                                       placeholder="Delta, ChinchillÃ ..."
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'vetroOrnamentale', this.value)"
                                       class="w-full compact-input border rounded mt-1"
                                       ${ptc.tipoVetro !== 'ornamentale' ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Fermavetro</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'fermavetro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Sel...</option>
                                    <option value="interno" ${ptc.fermavetro === 'interno' ? 'selected' : ''}>Interno</option>
                                    <option value="esterno" ${ptc.fermavetro === 'esterno' ? 'selected' : ''}>Esterno</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ”© FERRAMENTA -->
                    <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            ğŸ”© Ferramenta
                        </h5>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs font-medium">Codice Ferramenta</label>
                                <input type="text" 
                                       value="${ptc.codiceFerramenta || ''}"
                                       placeholder="FD-3000"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'codiceFerramenta', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Cerniere</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'cerniere', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Sel...</option>
                                    <option value="standard" ${ptc.cerniere === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="3d" ${ptc.cerniere === '3d' ? 'selected' : ''}>3D Regolabili</option>
                                    <option value="nascoste" ${ptc.cerniere === 'nascoste' ? 'selected' : ''}>Nascoste</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Cilindro</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'cilindro', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Sel...</option>
                                    <option value="standard" ${ptc.cilindro === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="europeo" ${ptc.cilindro === 'europeo' ? 'selected' : ''}>Europeo</option>
                                    <option value="alta-sicurezza" ${ptc.cilindro === 'alta-sicurezza' ? 'selected' : ''}>Alta Sicurezza</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">QtÃ  Chiavi</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'quantitaChiavi', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="3" ${ptc.quantitaChiavi == '3' ? 'selected' : ''}>3</option>
                                    <option value="4" ${ptc.quantitaChiavi == '4' ? 'selected' : ''}>4</option>
                                    <option value="5" ${ptc.quantitaChiavi == '5' ? 'selected' : ''}>5</option>
                                    <option value="6" ${ptc.quantitaChiavi == '6' ? 'selected' : ''}>6</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ–ï¸ MANIGLIE -->
                    <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                            ğŸ–ï¸ Maniglie
                        </h5>
                        <div class="grid md:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium">Maniglia Interna</label>
                                <input type="text" 
                                       value="${ptc.manigliaInt || ''}"
                                       placeholder="7040 - Maniglione"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'manigliaInt', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Maniglia Esterna</label>
                                <input type="text" 
                                       value="${ptc.manigliaEst || ''}"
                                       placeholder="Pomolo fisso"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'manigliaEst', this.value)"
                                       class="w-full compact-input border rounded mt-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- âš¡ ACCESSORI -->
                    <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                            âš¡ Accessori
                        </h5>
                        <div class="grid md:grid-cols-4 gap-3">
                            <div>
                                <label class="text-xs font-medium">Motor Apertura</label>
                                <label class="flex items-center gap-2 mt-1">
                                    <input type="checkbox" 
                                           ${ptc.motorApertura ? 'checked' : ''}
                                           onchange="updatePortoncino('${project.id}', '${pos.id}', 'motorApertura', this.checked)"
                                           class="w-4 h-4 rounded">
                                    <span class="text-sm">Motorizzata</span>
                                </label>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telecomando</label>
                                <input type="text" 
                                       value="${ptc.telecomando || ''}"
                                       placeholder="2 telecomandi"
                                       onchange="updatePortoncino('${project.id}', '${pos.id}', 'telecomando', this.value)"
                                       class="w-full compact-input border rounded mt-1"
                                       ${!ptc.motorApertura ? 'disabled' : ''}>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Lettore Impronte</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'lettoreImpronte', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Nessuno</option>
                                    <option value="base" ${ptc.lettoreImpronte === 'base' ? 'selected' : ''}>Base</option>
                                    <option value="smart" ${ptc.lettoreImpronte === 'smart' ? 'selected' : ''}>Smart (App)</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium">Chiudiporta</label>
                                <select onchange="updatePortoncino('${project.id}', '${pos.id}', 'chiudiporta', this.value)"
                                        class="w-full compact-input border rounded mt-1">
                                    <option value="">Nessuno</option>
                                    <option value="standard" ${ptc.chiudiporta === 'standard' ? 'selected' : ''}>Standard</option>
                                    <option value="incasso" ${ptc.chiudiporta === 'incasso' ? 'selected' : ''}>Ad incasso</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ğŸ“ NOTE -->
                    <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                            ğŸ“ Note
                        </h5>
                        <textarea 
                            onchange="updatePortoncino('${project.id}', '${pos.id}', 'note', this.value)"
                            placeholder="Note aggiuntive..."
                            class="w-full px-3 py-2 border rounded-lg h-20 text-sm">${ptc.note || ''}</textarea>
                    </div>
                </div>
            `}
        </div>
    `;
}

// ğŸšª FUNZIONI HELPER PORTONCINI (v5.07)
window.addPortoncino = function(projectId, positionId) {
    const project = state.projects.find(p => p.id === projectId);
    const position = project.positions.find(p => p.id === positionId);
    
    // Eredita dalla config globale se esiste
    const cfg = project.configPortoncini || {};
    
    position.portoncino = {
        attivo: true,
        azienda: cfg.azienda || 'Finstral',
        // Dimensioni
        BRM_L: '',
        BRM_H: '',
        // Telaio
        tipoTelaio: cfg.tipoTelaio || '',
        soglia: cfg.soglia || '',
        montante: cfg.montante || '',
        traversa: cfg.traversa || '',
        // Anta
        modelloAnta: cfg.modelloAnta || '',
        pannello: cfg.pannello || '',
        materialeInt: cfg.materialeInt || '',
        materialeEst: cfg.materialeEst || '',
        coloreInt: cfg.coloreInt || '',
        coloreEst: cfg.coloreEst || '',
        // Vetro
        tipoVetro: cfg.tipoVetro || '',
        vetroOrnamentale: cfg.vetroOrnamentale || '',
        fermavetro: cfg.fermavetro || '',
        // Ferramenta
        codiceFerramenta: cfg.codiceFerramenta || '',
        cerniere: cfg.cerniere || '',
        cilindro: cfg.cilindro || '',
        quantitaChiavi: cfg.quantitaChiavi || 3,
        // Maniglie
        manigliaInt: cfg.manigliaInt || '',
        manigliaEst: cfg.manigliaEst || '',
        // Accessori
        motorApertura: cfg.motorApertura || false,
        telecomando: cfg.telecomando || '',
        lettoreImpronte: cfg.lettoreImpronte || '',
        chiudiporta: cfg.chiudiporta || '',
        // Note
        note: ''
    };
    
    console.log('ğŸšª Portoncino aggiunto con config globale:', position.portoncino);
    saveState();
    render();
};

window.updatePortoncino = function(projectId, positionId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const position = project.positions.find(p => p.id === positionId);
    
    if (!position.portoncino) return;
    
    position.portoncino[field] = value;
    console.log(`ğŸšª portoncino.${field} = ${value}`);
    
    saveState();
    render();
};


// Calcola luce Oikos da dimensioni
function calcolaLuceOikos(L, H) {
    if (L <= 0 || H <= 0) return '';
    if (L <= 900 && H <= 2100) return 'luce0';
    if (L <= 940 && H <= 2210) return 'luce1';
    if (L <= 1030 && H <= 2400) return 'luce2';
    if (L <= 1350 && H <= 2210) return 'luce3';
    if (L <= 1600 && H <= 2400) return 'luce4';
    if (L <= 1800 && H <= 2210) return 'luce5';
    if (L <= 2000 && H <= 2400) return 'luce6';
    return 'fuoriMisura';
}

// Calcola prezzo stimato blindata
function calcolaPrezzoBlindataStimato(bld) {
    let totale = 0;
    const luce = bld.luceCalcolata || 'luce0';
    
    // Prezzi base per versione e luce
    const prezziBase = {
        'E3': { 'luce0': 1156, 'luce1': 1206, 'luce2': 1441 },
        'E4': { 'luce0': 1436, 'luce1': 1486, 'luce2': 1721 },
        'E3D': { 'luce3': 2217, 'luce4': 2532 },
        'E3EI30': { 'luce0': 1731 },
        'E3EI45': { 'luce0': 1731 },
        'E3EI60': { 'luce0': 1891 },
        'E3TT086': { 'luce0': 2254, 'luce1': 2442, 'luce2': 2766 },
        'E3TT1': { 'luce0': 1958, 'luce1': 2131, 'luce2': 2386 },
        'P3': { 'luce0': 1173, 'luce1': 1293, 'luce2': 1480 }
    };
    
    // Prezzo base anta
    totale += prezziBase[bld.versione]?.[luce] || 0;
    
    // Controtelaio
    if (bld.controtelaio === 'si' || bld.controtelaio === true) {
        const controtelai = {
            'luce0': 177, 'luce1': 202, 'luce2': 240,
            'luce3': 318, 'luce4': 350
        };
        totale += controtelai[luce] || 0;
    }
    
    // Cilindro
    const cilindri = { 'BASIC': 123, 'SEKUR': 238 };
    totale += cilindri[bld.cilindro] || 0;
    
    // Colore telaio
    const colori = {
        'RAL8022': 0,
        'OIKOS_Polveri': 246,
        'OIKOS_Evergreen': 320,
        'OIKOS_Future': 384,
        'OIKOS_Liquido': 492
    };
    totale += colori[bld.coloreTelaio] || 0;
    
    // Acustica maggiorata
    if (bld.acustica === 'maggiorata') {
        totale += 120;
    }
    
    // Termica
    if (bld.termica && bld.termica !== 'serie') {
        const termiche = {
            'singola': {
                '1.2': { 'luce0': 272, 'luce1': 308, 'luce2': 354 },
                '1.0': { 'luce0': 496, 'luce1': 544, 'luce2': 624 }
            }
        };
        totale += termiche['singola'][bld.termica]?.[luce] || 0;
    }
    
    // ğŸ” v5.01: Kit Aria-Acqua-Vento (MOSE/DAM 4-5A-C5)
    if (bld.kitAAV) {
        const kitAAV = {
            'MOSE': { 'luce0': 405, 'luce1': 464, 'luce2': 499, 'luce3': 499, 'luce4': 499, 'luce5': 499, 'luce6': 499 },
            'DAM': { 'luce0': 459, 'luce1': 489, 'luce2': 514, 'luce3': 514, 'luce4': 514, 'luce5': 514, 'luce6': 514 }
        };
        totale += kitAAV[bld.kitAAV]?.[luce] || 0;
    }
    
    // ğŸ” v5.02: Rivestimento INTERNO
    if (bld.rivestimentoInt?.linea && bld.rivestimentoInt?.modello) {
        totale += calcolaPrezzoRivestimento(bld.rivestimentoInt.linea, bld.rivestimentoInt.modello, luce);
    }
    
    // ğŸ” v5.02: Rivestimento ESTERNO
    if (bld.rivestimentoEst?.linea && bld.rivestimentoEst?.modello) {
        totale += calcolaPrezzoRivestimento(bld.rivestimentoEst.linea, bld.rivestimentoEst.modello, luce);
        // Verniciatura esterni (+30% circa, semplificato a â‚¬150)
        if (bld.rivestimentoEst.verniciatura) {
            totale += 150;
        }
    }
    
    // ğŸ” v5.03: VETRO
    if (bld.vetro?.attivo && bld.vetro?.tipo) {
        const tipoVetro = bld.vetro.termico ? OIKOS_OPTIONAL.vetroTermico : OIKOS_OPTIONAL.vetroBlindato;
        const finitura = bld.vetro.finitura || 'trasparente';
        totale += tipoVetro[bld.vetro.tipo]?.[finitura] || 0;
    }
    
    // ğŸ” v5.03: SOPRALUCE
    if (bld.sopraluce?.attivo && bld.sopraluce?.altezza) {
        totale += OIKOS_OPTIONAL.sopraluce[bld.sopraluce.altezza]?.[luce] || 0;
        // Controtelaio sopraluce (se H > 2400)
        totale += OIKOS_OPTIONAL.sopraluce.controtelaio[luce] || 0;
        // Sabbiato
        if (bld.sopraluce.sabbiato) {
            const sabKey = 'sabbiato_' + bld.sopraluce.altezza;
            totale += OIKOS_OPTIONAL.sopraluce[sabKey]?.[luce] || 0;
        }
    }
    
    // ğŸ” v5.03: FIANCOLUCE
    if (bld.fiancoluce?.attivo) {
        const luceFL = luce === 'luce0' ? 'luce1' : luce; // Fiancoluce parte da luce1
        if (bld.fiancoluce.conVetro) {
            totale += OIKOS_OPTIONAL.fiancoluce.conVetro[luceFL] || 0;
        } else {
            totale += OIKOS_OPTIONAL.fiancoluce.senzaVetro[luceFL] || 0;
        }
        if (bld.fiancoluce.sabbiato) {
            totale += OIKOS_OPTIONAL.fiancoluce.sabbiato[luceFL] || 0;
        }
        // Colore fiancoluce
        if (bld.fiancoluce.colore && bld.fiancoluce.colore !== 'RAL8022') {
            totale += OIKOS_OPTIONAL.fiancoluce.colori[bld.fiancoluce.colore]?.[luceFL] || 0;
        }
    }
    
    return totale;
}

// ğŸªŸ v5.64: Tab CLICK ZIP (collegato a infisso, come persiana/tapparella)
// ğŸªŸ v5.746: Aggiunto serveClickZip per ogni posizione
function renderClickZipTab(project, pos) {
    // Usa config generale se non c'Ã¨ config locale
    const config = project.configClickZip || {};
    const cz = pos.clickZip || {};
    
    // ğŸ†• v5.746: Flag serveClickZip (default true se non specificato)
    const serveClickZip = cz.serveClickZip !== false;
    
    // Valori effettivi (locale o da config)
    const modello = cz.modello || config.modello || '';
    const tessuto = cz.tessuto || config.tessuto || '';
    const coloreStruttura = cz.coloreStruttura || config.coloreStruttura || '';
    
    // Lista modelli Click Zip
    const modelliClickZip = Object.entries(GIBUS_DATABASE.clickZip).map(([key, val]) => ({
        id: key,
        nome: val.nome,
        cassonetto: val.cassonetto,
        limiti: val.limiti
    }));
    
    // Info modello selezionato per limiti
    const modelloInfo = getInfoModelloGibus(modello);
    
    // Calcola BRM per Click Zip
    const tipoInfisso = pos.infisso?.tipo || 'F1';
    const brm = calculateBRM(project, pos, pos.misure || {}, project.brmConfigClickZip, tipoInfisso);
    const brmL = brm?.L ? Math.round(brm.L) : null;
    const brmH = brm?.H ? Math.round(brm.H) : null;
    
    // Dimensioni: prioritÃ  override manuale > BRM calcolato
    const larghezza = cz.larghezza || (brmL ? brmL.toString() : '');
    const altezza = cz.altezza || (brmH ? brmH.toString() : '');
    
    // ğŸ†• v5.746: Se non serve Click Zip, mostra solo il checkbox
    if (!serveClickZip) {
        return `
            <div class="space-y-4">
                <!-- HEADER CLICK ZIP -->
                <div class="bg-gradient-to-r from-cyan-100 to-blue-100 border-2 border-cyan-400 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-3xl">ğŸªŸ</span>
                        <div>
                            <h3 class="font-bold text-cyan-800 text-lg">Click Zip GIBUS</h3>
                            <p class="text-sm text-cyan-600">Schermatura collegata all'infisso â€¢ Sconto: <strong>48%</strong></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 text-center">
                    <p class="text-gray-600 mb-3">Nessun Click Zip configurato</p>
                    <button onclick="updateClickZip('${project.id}', '${pos.id}', 'serveClickZip', true)"
                            class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold px-6 py-2 rounded-lg transition-colors">
                        + Aggiungi Click Zip
                    </button>
                    <div class="mt-3 flex items-center justify-center gap-2">
                        <label class="flex items-center gap-2 cursor-pointer text-gray-600 border border-gray-300 rounded px-3 py-1">
                            <input type="checkbox" 
                                   checked
                                   onchange="updateClickZip('${project.id}', '${pos.id}', 'serveClickZip', !this.checked)"
                                   class="w-4 h-4">
                            <span>âš ï¸ Non presente in questa posizione</span>
                        </label>
                    </div>
                </div>
            </div>
        `;
    }
    
    return `
        <div class="space-y-4">
            <!-- HEADER CLICK ZIP -->
            <div class="bg-gradient-to-r from-cyan-100 to-blue-100 border-2 border-cyan-400 rounded-lg p-4">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-3xl">ğŸªŸ</span>
                    <div>
                        <h3 class="font-bold text-cyan-800 text-lg">Click Zip GIBUS</h3>
                        <p class="text-sm text-cyan-600">Schermatura collegata all'infisso â€¢ Sconto: <strong>48%</strong></p>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ†• v5.746: CHECKBOX NON PRESENTE -->
            <div class="flex items-center justify-center">
                <label class="flex items-center gap-2 cursor-pointer text-gray-600 border border-gray-300 rounded px-3 py-1 bg-white">
                    <input type="checkbox" 
                           onchange="updateClickZip('${project.id}', '${pos.id}', 'serveClickZip', !this.checked)"
                           class="w-4 h-4">
                    <span>âš ï¸ Non presente in questa posizione</span>
                </label>
            </div>
            
            <!-- ğŸ†• v5.746: QUANTITÃ€ -->
            <div class="bg-cyan-50 border-2 border-cyan-200 rounded-lg p-4">
                <h5 class="font-semibold text-cyan-800 mb-3 flex items-center gap-2">
                    ğŸ“‹ Dati Specifici
                </h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div>
                        <label class="text-xs font-medium">QuantitÃ </label>
                        <select onchange="updateClickZip('${project.id}', '${pos.id}', 'qta', this.value)"
                                class="w-full compact-input border rounded mt-1 font-semibold">
                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                <option value="${n}" ${(cz.qta || '1') == n ? 'selected' : ''}>${n}</option>
                            `).join('')}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- MODELLO (da config o override) -->
            <div class="bg-white border rounded-lg p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    ğŸ“‹ Modello ${config.modello && !cz.modello ? '<span class="text-xs text-green-600">(da config generale)</span>' : ''}
                </label>
                <select onchange="updateClickZip('${project.id}', '${pos.id}', 'modello', this.value)"
                        class="w-full border-2 ${config.modello && !cz.modello ? 'border-green-300 bg-green-50' : 'border-gray-300'} rounded-lg p-3 font-semibold text-lg focus:border-cyan-500">
                    <option value="">-- Usa default progetto --</option>
                    ${modelliClickZip.map(m => `
                        <option value="${m.id}" ${modello === m.id ? 'selected' : ''}>
                            ${m.nome} (${m.cassonetto})
                        </option>
                    `).join('')}
                </select>
                ${modelloInfo?.limiti ? `
                    <div class="mt-2 p-2 bg-blue-50 rounded text-xs text-blue-700">
                        <strong>Limiti:</strong> L ${modelloInfo.limiti.larghezzaMin}-${modelloInfo.limiti.larghezzaMax} cm | 
                        H ${modelloInfo.limiti.altezzaMin}-${modelloInfo.limiti.altezzaMax} cm
                    </div>
                ` : ''}
            </div>
            
            <!-- DIMENSIONI BRM -->
            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-400 rounded-lg p-4">
                <label class="block text-sm font-bold text-amber-800 mb-2">ğŸ“ Dimensioni (calcolate da BRM)</label>
                ${brmL && brmH ? `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <label class="text-xs text-amber-700 font-semibold">BRM Larghezza</label>
                            <div class="text-2xl font-bold text-amber-800">${larghezza} mm</div>
                            ${cz.larghezza ? '<span class="text-xs text-blue-600">âœï¸ Override manuale</span>' : '<span class="text-xs text-green-600">ğŸ“ Auto da BRM</span>'}
                        </div>
                        <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                            <label class="text-xs text-amber-700 font-semibold">BRM Altezza</label>
                            <div class="text-2xl font-bold text-amber-800">${altezza} mm</div>
                            ${cz.altezza ? '<span class="text-xs text-blue-600">âœï¸ Override manuale</span>' : '<span class="text-xs text-green-600">ğŸ“ Auto da BRM</span>'}
                        </div>
                    </div>
                    <details class="mt-3">
                        <summary class="text-xs text-amber-700 cursor-pointer">âœï¸ Modifica manualmente</summary>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <input type="number" value="${cz.larghezza || ''}" placeholder="Override L (mm)"
                                   onchange="updateClickZip('${project.id}', '${pos.id}', 'larghezza', this.value)"
                                   class="border rounded p-2 text-center">
                            <input type="number" value="${cz.altezza || ''}" placeholder="Override H (mm)"
                                   onchange="updateClickZip('${project.id}', '${pos.id}', 'altezza', this.value)"
                                   class="border rounded p-2 text-center">
                        </div>
                    </details>
                ` : `
                    <div class="text-center py-4 text-amber-700">
                        âš ï¸ Configura BRM in <strong>Step 8 - Config Click Zip</strong> per calcolo automatico
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="text-xs">Larghezza (mm)</label>
                                <input type="number" value="${cz.larghezza || ''}" placeholder="Inserisci L"
                                       onchange="updateClickZip('${project.id}', '${pos.id}', 'larghezza', this.value)"
                                       class="w-full border-2 border-amber-400 rounded-lg p-2 text-center font-bold">
                            </div>
                            <div>
                                <label class="text-xs">Altezza (mm)</label>
                                <input type="number" value="${cz.altezza || ''}" placeholder="Inserisci H"
                                       onchange="updateClickZip('${project.id}', '${pos.id}', 'altezza', this.value)"
                                       class="w-full border-2 border-amber-400 rounded-lg p-2 text-center font-bold">
                            </div>
                        </div>
                    </div>
                `}
            </div>
            
            <!-- TESSUTO E COLORE (da config o override) -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white border rounded-lg p-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        ğŸ¨ Tessuto ${config.tessuto && !cz.tessuto ? '<span class="text-xs text-green-600">(default)</span>' : ''}
                    </label>
                    <select onchange="updateClickZip('${project.id}', '${pos.id}', 'tessuto', this.value)"
                            class="w-full border-2 ${config.tessuto && !cz.tessuto ? 'border-green-300 bg-green-50' : 'border-gray-300'} rounded-lg p-2 focus:border-cyan-500">
                        <option value="">-- Usa default --</option>
                        ${GIBUS_DATABASE.tessuti.map(t => `
                            <option value="${t}" ${tessuto === t ? 'selected' : ''}>${t}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="bg-white border rounded-lg p-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        ğŸ¨ Colore ${config.coloreStruttura && !cz.coloreStruttura ? '<span class="text-xs text-green-600">(default)</span>' : ''}
                    </label>
                    <select onchange="updateClickZip('${project.id}', '${pos.id}', 'coloreStruttura', this.value)"
                            class="w-full border-2 ${config.coloreStruttura && !cz.coloreStruttura ? 'border-green-300 bg-green-50' : 'border-gray-300'} rounded-lg p-2 focus:border-cyan-500">
                        <option value="">-- Usa default --</option>
                        ${GIBUS_DATABASE.coloriStruttura.map(c => `
                            <option value="${c}" ${coloreStruttura === c ? 'selected' : ''}>${c}</option>
                        `).join('')}
                    </select>
                </div>
            </div>
            
            <!-- PREZZO DA MAKER -->
            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-4">
                <label class="block text-sm font-bold text-green-800 mb-2">ğŸ’° Prezzo da MyGibus Maker</label>
                <p class="text-xs text-green-600 mb-3">
                    Inserisci il prezzo LISTINO dal configuratore. Sconto 48% automatico.
                </p>
                <div class="flex items-center gap-3">
                    <span class="text-xl font-bold text-green-700">â‚¬</span>
                    <input type="number" 
                           value="${cz.prezzoListino || ''}"
                           onchange="updateClickZip('${project.id}', '${pos.id}', 'prezzoListino', this.value)"
                           placeholder="Prezzo listino"
                           class="flex-1 border-2 border-green-400 rounded-lg p-3 text-xl font-bold text-center focus:border-green-600">
                </div>
                ${cz.prezzoListino ? `
                    <div class="mt-3 p-3 bg-white rounded-lg border border-green-300">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Listino:</span>
                            <span class="font-semibold">â‚¬ ${parseFloat(cz.prezzoListino).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between items-center text-red-600">
                            <span>Sconto 48%:</span>
                            <span>- â‚¬ ${(parseFloat(cz.prezzoListino) * 0.48).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                        </div>
                        <hr class="my-2">
                        <div class="flex justify-between items-center text-green-700 text-lg font-bold">
                            <span>NETTO:</span>
                            <span>â‚¬ ${(parseFloat(cz.prezzoListino) * 0.52).toLocaleString('it-IT', {minimumFractionDigits: 2})}</span>
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <!-- NOTE -->
            <div class="bg-white border rounded-lg p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“ Note</label>
                <textarea onchange="updateClickZip('${project.id}', '${pos.id}', 'note', this.value)"
                          rows="2"
                          placeholder="Motore, accessori, optional..."
                          class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-cyan-500">${cz.note || ''}</textarea>
            </div>
        </div>
    `;
}

// ğŸªŸ v5.64: Funzione per aggiornare Click Zip
window.updateClickZip = function(projectId, positionId, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos) return;
    
    if (!pos.clickZip) pos.clickZip = {};
    pos.clickZip[field] = value;
    
    console.log('ğŸªŸ Click Zip aggiornata: ' + field + ' = ' + value);
    saveState();
    render();
};

// ğŸªŸ v5.64: Copia dimensioni da infisso
window.copiaFromInfissoClickZip = function(projectId, positionId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.infisso) return;
    
    if (!pos.clickZip) pos.clickZip = {};
    pos.clickZip.larghezza = pos.infisso.larghezza || '';
    pos.clickZip.altezza = pos.infisso.altezza || '';
    
    console.log('ğŸªŸ Click Zip: copiate dimensioni da infisso');
    showNotification('ğŸ“ Dimensioni copiate da infisso!', 'success');
    saveState();
    render();
};

// â˜€ï¸ v5.64: Tab TENDA A BRACCI (standalone, max 2 per posizione)
function renderTendaBracciTab(project, pos) {
    const tb = pos.tendaBracci || { tende: [] };
    const tende = tb.tende || [];
    
    // Lista modelli Tende a Bracci
    const modelliTendeBracci = Object.entries(GIBUS_DATABASE.tendeBracci).map(([key, val]) => ({
        id: key,
        nome: val.nome,
        tipo: val.tipo
    }));
    
    return `
        <div class="space-y-4">
            <!-- HEADER TENDA A BRACCI -->
            <div class="bg-gradient-to-r from-amber-100 to-orange-100 border-2 border-amber-400 rounded-lg p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">â˜€ï¸</span>
                        <div>
                            <h3 class="font-bold text-amber-800 text-lg">Tende a Bracci GIBUS</h3>
                            <p class="text-sm text-amber-600">Max 2 tende per posizione â€¢ Sconto: <strong>48%</strong></p>
                        </div>
                    </div>
                    ${tende.length < 2 ? `
                        <button onclick="addTendaBracci('${project.id}', '${pos.id}')"
                                class="px-4 py-2 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700">
                            + Aggiungi Tenda
                        </button>
                    ` : ''}
                </div>
            </div>
            
            ${tende.length === 0 ? `
                <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                    <span class="text-4xl">â˜€ï¸</span>
                    <p class="text-gray-600 mt-2">Nessuna tenda configurata</p>
                    <button onclick="addTendaBracci('${project.id}', '${pos.id}')"
                            class="mt-3 px-4 py-2 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700">
                        + Aggiungi prima tenda
                    </button>
                </div>
            ` : ''}
            
            ${tende.map((t, idx) => `
                <div class="bg-white border-2 border-amber-300 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-amber-800">â˜€ï¸ Tenda ${idx + 1}</h4>
                        <button onclick="removeTendaBracci('${project.id}', '${pos.id}', ${idx})"
                                class="text-red-600 hover:text-red-800 text-sm">
                            ğŸ—‘ï¸ Rimuovi
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-gray-600">Modello</label>
                            <select onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'modello', this.value)"
                                    class="w-full border rounded-lg p-2">
                                <option value="">-- Seleziona --</option>
                                ${modelliTendeBracci.map(m => `
                                    <option value="${m.id}" ${t.modello === m.id ? 'selected' : ''}>${m.nome}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">Largh. (cm)</label>
                                <input type="number" value="${t.larghezza || ''}"
                                       onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'larghezza', this.value)"
                                       class="w-full border rounded-lg p-2 text-center font-bold">
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Sporg. (cm)</label>
                                <input type="number" value="${t.sporgenza || ''}"
                                       onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'sporgenza', this.value)"
                                       class="w-full border rounded-lg p-2 text-center font-bold">
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="text-xs text-gray-600">Tessuto</label>
                            <select onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'tessuto', this.value)"
                                    class="w-full border rounded-lg p-2 text-sm">
                                <option value="">--</option>
                                ${GIBUS_DATABASE.tessuti.map(ts => `
                                    <option value="${ts}" ${t.tessuto === ts ? 'selected' : ''}>${ts}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Colore</label>
                            <select onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'colore', this.value)"
                                    class="w-full border rounded-lg p-2 text-sm">
                                <option value="">--</option>
                                ${GIBUS_DATABASE.coloriStruttura.map(c => `
                                    <option value="${c}" ${t.colore === c ? 'selected' : ''}>${c}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Prezzo Listino â‚¬</label>
                            <input type="number" value="${t.prezzoListino || ''}"
                                   onchange="updateTendaBracciItem('${project.id}', '${pos.id}', ${idx}, 'prezzoListino', this.value)"
                                   class="w-full border rounded-lg p-2 text-center font-bold">
                        </div>
                    </div>
                    
                    ${t.prezzoListino ? `
                        <div class="p-2 bg-green-50 rounded text-sm">
                            <span class="text-gray-600">Netto (48%):</span>
                            <strong class="text-green-700 ml-2">â‚¬ ${(parseFloat(t.prezzoListino) * 0.52).toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong>
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

// â˜€ï¸ v5.64: Funzioni per gestire Tende a Bracci
window.addTendaBracci = function(projectId, positionId) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos) return;
    
    if (!pos.tendaBracci) pos.tendaBracci = { tende: [] };
    if (pos.tendaBracci.tende.length >= 2) {
        showNotification('âš ï¸ Massimo 2 tende per posizione', 'warning');
        return;
    }
    
    pos.tendaBracci.tende.push({
        modello: '',
        larghezza: '',
        sporgenza: '',
        tessuto: '',
        colore: '',
        prezzoListino: ''
    });
    
    console.log('â˜€ï¸ Tenda a Bracci aggiunta');
    saveState();
    render();
};

window.removeTendaBracci = function(projectId, positionId, index) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.tendaBracci) return;
    
    pos.tendaBracci.tende.splice(index, 1);
    
    console.log('â˜€ï¸ Tenda a Bracci rimossa');
    saveState();
    render();
};

window.updateTendaBracciItem = function(projectId, positionId, index, field, value) {
    const project = state.projects.find(p => p.id === projectId);
    const pos = project?.positions.find(p => p.id === positionId);
    if (!pos || !pos.tendaBracci || !pos.tendaBracci.tende[index]) return;
    
    pos.tendaBracci.tende[index][field] = value;
    
    console.log('â˜€ï¸ Tenda a Bracci ' + (index+1) + ' aggiornata: ' + field);
    saveState();
    render();
};

function renderFotoTab(project, pos) {
    return `
        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
            <h4 class="font-semibold text-blue-700 mb-3">ğŸ“¸ Foto Posizione</h4>
            
            <div class="mb-3">
                <input type="file" 
                       id="foto-input-${pos.id}" 
                       accept="image/*" 
                       onchange="addFoto('${project.id}', '${pos.id}', this)"
                       class="hidden">
                <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                    ğŸ“· Carica Foto
                </button>
                <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
            </div>
            
            ${pos.foto && pos.foto.length > 0 ? `
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${pos.foto.map((foto, idx) => `
                        <div class="relative group">
                            <img src="${foto.data}" 
                                 onclick="showFotoModal('${foto.data}')"
                                 class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                            <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                    class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                âœ•
                            </button>
                            <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
        </div>
    `;
}

function NewProjectModal() {
    // ğŸ†• v5.722: Usa stato per controllare visibilitÃ 
    const isVisible = state.showNewProjectModal === true;
    return `
        <div id="modal" class="${isVisible ? '' : 'hidden'} fixed inset-0 bg-black/50 flex items-center justify-center" style="z-index: 9999;" onclick="hideModal()">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" style="pointer-events: auto;" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                <div class="mb-3">
                    <input type="text" id="projectClient" placeholder="Cliente" 
                           required
                           style="pointer-events: auto;"
                           class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none">
                    <p class="text-xs text-gray-500 mt-1">* Obbligatorio - Identifica il progetto</p>
                </div>
                <div class="mb-4">
                    <input type="text" id="projectName" placeholder="Nome progetto (opzionale)" 
                           style="pointer-events: auto;"
                           class="w-full px-3 py-2 border rounded-lg focus:border-blue-400 focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button onclick="hideModal()" 
                            style="pointer-events: auto;"
                            class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                        Annulla
                    </button>
                    <button onclick="createNewProject()" 
                            style="pointer-events: auto;"
                            class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                        Crea
                    </button>
                </div>
            </div>
        </div>
    `;
}

function FotoModal() {
    return `
        <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
            <div class="relative max-w-4xl max-h-screen p-4">
                <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                    âœ•
                </button>
                <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
            </div>
        </div>
    `;
}

// Window Functions - ğŸ†• v5.728: Fix MenuSistema
window.showNewProjectModal = () => {
    // Chiudi menu
    state.projectMenuOpen = false;
    state.mainMenuOpen = false;
    
    // Prompt nativo per il cliente
    const client = prompt('Nome Cliente (obbligatorio):');
    
    if (!client || client.trim() === '') {
        // Annullato o vuoto
        return;
    }
    
    // Prompt per nome progetto (opzionale)
    const name = prompt('Nome Progetto (opzionale, lascia vuoto per usare nome cliente):');
    
    const projectName = (name && name.trim()) ? name.trim() : client.trim();
    
    createProject(projectName, client.trim());
    state.screen = 'project';
    render();
};

window.hideModal = () => {
    // Non serve piÃ¹
};

// ğŸ†• v5.726: createNewProject non piÃ¹ usato direttamente, ma lo lascio per compatibilitÃ 
window.createNewProject = () => {
    // Questa funzione Ã¨ ora gestita dal dialog in showNewProjectModal
    console.warn('createNewProject() chiamato direttamente - usa showNewProjectModal()');
};

window.goBack = () => {
    if (state.screen === 'position') {
        state.screen = 'project';
    } else {
        state.screen = 'list';
    }
    // ğŸ†• v4.20: Chiudi tutti i menu durante navigazione
    state.projectMenuOpen = false;
    state.mainMenuOpen = false;
    render();
};

window.openProject = (id) => {
    state.currentProject = id;
    state.screen = 'project';
    // ğŸ†• v4.20: Chiudi tutti i menu quando apri progetto
    state.projectMenuOpen = false;
    state.mainMenuOpen = false;
    render();
};

// ============================================
// ğŸ”§ FIX 027H: getCurrentProject helper
// ============================================
// Aggiunto per compatibilitÃ  con menu dinamico
function getCurrentProject() {
    if (state.currentProject) {
        return state.projects.find(p => p.id === state.currentProject);
    }
    return null;
}

window.openPosition = (id) => {
    state.currentPosition = id;
    state.screen = 'position';
    state.showRiepilogoRilievi = false;  // Reset flag riepilogo
    // ğŸ†• v4.20: Chiudi tutti i menu quando apri posizione
    state.projectMenuOpen = false;
    state.mainMenuOpen = false;
    render();
};

// ğŸ†• FASE 014 - Controllo completamento prima cambio posizione
window.switchPosition = (id) => {
    const project = state.projects.find(p => p.positions && p.positions.some(pos => pos.id === state.currentPosition));
    const currentPos = project?.positions?.find(p => p.id === state.currentPosition);
    
    // Se c'Ã¨ una posizione corrente, controlla completamento
    if (currentPos && currentPos.id !== id) {
        const comp = calculatePositionCompleteness(currentPos);
        
        // Se non Ã¨ completa al 100%, mostra warning
        if (comp.percentage < 100) {
            const missingText = comp.missing.length > 0 
                ? `\n\nMancanti:\nâ€¢ ${comp.missing.join('\nâ€¢ ')}` 
                : '';
            
            const proceed = confirm(
                `âš ï¸ ATTENZIONE: La posizione "${currentPos.name}" non Ã¨ completa al 100%!\n` +
                `Completamento attuale: ${comp.percentage}%${missingText}\n\n` +
                `Vuoi comunque cambiare posizione?`
            );
            
            if (!proceed) {
                // Utente ha annullato, rimane sulla posizione corrente
                render(); // Ri-renderizza per resettare il dropdown
                return;
            }
        }
    }
    
    // Cambio posizione
    state.currentPosition = id;
    render();
};

window.printChecklistRilievi = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    // Genera HTML per stampa
    const printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>OpenPorte Rilievo v5.98</title>
            <style>
                @media print {
                    @page { margin: 1cm; }
                    body { margin: 0; }
                }
                body {
                    font-family: Arial, sans-serif;
                    padding: 20px;
                    max-width: 1200px;
                    margin: 0 auto;
                }
                h1 {
                    color: #6B46C1;
                    border-bottom: 3px solid #6B46C1;
                    padding-bottom: 10px;
                }
                h2 {
                    color: #4A5568;
                    margin-top: 30px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                    page-break-inside: avoid;
                }
                th {
                    background: #6B46C1;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-size: 14px;
                }
                td {
                    padding: 10px;
                    border: 1px solid #E2E8F0;
                }
                tr:nth-child(even) {
                    background: #F7FAFC;
                }
                .header-info {
                    background: #EDF2F7;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                .check-box {
                    display: inline-block;
                    width: 18px;
                    height: 18px;
                    border: 2px solid #4A5568;
                    margin: 0 5px;
                    vertical-align: middle;
                }
                .check-filled {
                    background: #48BB78;
                    border-color: #48BB78;
                }
                .missing {
                    color: #E53E3E;
                    font-weight: bold;
                }
                .status {
                    display: inline-block;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                }
                .status-complete { background: #C6F6D5; color: #22543D; }
                .status-partial { background: #FEEBC8; color: #744210; }
                .status-empty { background: #FED7D7; color: #742A2A; }
                .print-btn {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 10px 20px;
                    background: #6B46C1;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                }
                @media print {
                    .print-btn { display: none; }
                }
            </style>
        </head>
        <body>
            <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Stampa</button>
            
            <h1>ğŸ“‹ CHECKLIST RILIEVI - SOPRALLUOGO</h1>
            
            <div class="header-info">
                <h3>Informazioni Progetto</h3>
                <p><strong>Progetto:</strong> ${project.nome || 'N/A'}</p>
                <p><strong>Cliente:</strong> ${project.clientData?.nome || 'N/A'}</p>
                <p><strong>Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/A'}</p>
                <p><strong>Piano:</strong> ${project.clientData?.piano || 'N/A'}</p>
                <p><strong>Data stampa:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
            </div>
            
            <h2>ğŸ“ Posizioni da Rilevare (${project.positions.length})</h2>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%">Posizione</th>
                        <th style="width: 12%">Piano/Amb.</th>
                        <th style="width: 15%">Preesistente</th>
                        <th style="width: 14%">Note</th>
                    </tr>
                </thead>
                <tbody>
                    ${project.positions.map(pos => {
                        const r = pos.rilievo || {};
                        const completeness = calculateRilievoCompleteness(pos);
                        const statusClass = completeness.percentage === 100 ? 'status-complete' : 
                                           completeness.percentage > 0 ? 'status-partial' : 'status-empty';
                        const statusText = completeness.percentage === 100 ? 'COMPLETO' : 
                                          completeness.percentage > 0 ? 'PARZIALE' : 'DA FARE';
                        
                        return `
                            <tr>
                                <td>
                                    <strong>${pos.name}</strong><br>
                                    <span class="status ${statusClass}">${statusText}</span>
                                </td>
                                <td>${pos.piano || '-'}<br>${pos.ambiente || '-'}</td>
                                <td class="${!r.preesistente || r.preesistente.trim() === '' ? 'missing' : ''}">
                                    ${r.preesistente || 'âŒ DA COMPILARE'}
                                </td>
                                <td style="font-size: 12px;">${r.note || '-'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            
            <div style="margin-top: 40px; border-top: 2px solid #E2E8F0; padding-top: 20px;">
                <h3>âœ… Istruzioni per il Sopralluogo</h3>
                <ol style="line-height: 1.8;">
                    <li>Verifica per ogni posizione cosa Ã¨ presente (infisso, persiana, tapparella, etc.)</li>
                    <li>Aggiungi note aggiuntive se necessario</li>
                </ol>
            </div>
            
            <div style="margin-top: 30px; text-align: center; color: #A0AEC0; font-size: 12px;">
                <p>Generato da Open Porte - Sistema di Rilievo Misure</p>
            </div>
        </body>
        </html>
    `;
    
    // Apri in nuova finestra e stampa
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHTML);
    printWindow.document.close();
};

window.setPositionTab = (posId, tab) => {
    const project = state.projects.find(p => p.id === state.currentProject);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            pos.activeTab = tab;
            render();
        }
    }
};

// Update Functions
window.updateProject = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        project[field] = value;
        saveState();
    }
};

// ğŸ†• v4.76: Debounce per auto-save dati cantiere (500ms)
let clientDataSaveTimer = null;
function saveStateDebounced(delay = 500) {
    clearTimeout(clientDataSaveTimer);
    clientDataSaveTimer = setTimeout(() => {
        saveState();
        console.log('ğŸ’¾ Auto-save dati cantiere (debounce 500ms)');
    }, delay);
}

window.updateClientData = (projectId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.clientData) project.clientData = {};
        project.clientData[field] = value;
        
        if (field === 'piano') {
            project.positions.forEach(pos => {
                if (!pos.piano) pos.piano = value;
            });
        }
        // ğŸ†• v4.76: Auto-save con debounce 500ms
        saveStateDebounced();
    }
};

/**
 * ğŸ†• v5.81: Callback per UI_FORMS - Aggiorna campi cliente/immobile
 * @param {string} field - Nome campo
 * @param {string} value - Valore
 * @param {string} sezione - 'cliente' o 'immobile' (default: 'cliente')
 */
window.updateClienteField = (field, value, sezione = 'cliente') => {
    markUserTyping();
    const project = state.projects.find(p => p.id === state.currentProject);
    if (!project) return;
    
    if (sezione === 'immobile') {
        // Aggiorna immobile
        if (!project.immobile) project.immobile = {};
        project.immobile[field] = value;
        console.log(`ğŸ  Immobile.${field} = ${value}`);
    } else {
        // Aggiorna cliente
        if (!project.cliente) project.cliente = {};
        if (!project.clientData) project.clientData = {};
        
        project.cliente[field] = value;
        project.clientData[field] = value; // RetrocompatibilitÃ 
        
        // Se aggiorno nome/cognome, aggiorna anche client
        if (field === 'nome' || field === 'cognome') {
            const nome = project.cliente.nome || '';
            const cognome = project.cliente.cognome || '';
            project.client = `${nome} ${cognome}`.trim();
        }
        
        console.log(`ğŸ‘¤ Cliente.${field} = ${value}`);
    }
    
    saveStateDebounced();
};

window.updateProdotti = (projectId, product, checked) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.prodotti) project.prodotti = {};
        
        // Mappa prodotto -> step number
        const productStepMap = {
            'infissi': 3,
            'persiane': 4,
            'tapparelle': 5,
            'zanzariere': 6,
            'cassonetti': 7
        };
        
        const productStep = productStepMap[product];
        
        // ğŸ†• v4.75: Se DISATTIVO un prodotto, pulisco tutti i dati correlati
        if (!checked) {
            cleanProductData(project, product);
        }
        
        // Se sto deselezionando un prodotto e sono sul suo step di config
        if (!checked && state.setupStep === productStep) {
            // Aggiorna temporaneamente il prodotto per calcolare il prossimo step valido
            project.prodotti[product] = checked;
            // Salta allo step successivo valido
            state.setupStep = getNextValidStep(state.setupStep, project);
        } else {
            project.prodotti[product] = checked;
        }
        
        saveState();
        render();
    }
};

// ğŸ†• v4.75: Funzione per pulire dati prodotto quando disattivato
function cleanProductData(project, product) {
    // Mappa prodotto -> chiavi JSON da pulire
    const productDataMap = {
        'infissi': { config: 'configInfissi', brm: 'brmConfigInfissi', rilievo: 'rilievoInfissi', position: 'infisso' },
        'persiane': { config: 'configPersiane', brm: 'brmConfigPersiane', rilievo: 'rilievoPersiane', position: 'persiana' },
        'tapparelle': { config: 'configTapparelle', brm: 'brmConfigTapparelle', rilievo: 'rilievoTapparelle', position: 'tapparella' },
        'zanzariere': { config: 'configZanzariere', brm: 'brmConfigZanzariere', rilievo: 'rilievoZanzariere', position: 'zanzariera' },
        'cassonetti': { config: 'configCassonetti', brm: 'brmConfigCassonetti', rilievo: 'rilievoCassonetti', position: 'cassonetto' }
    };
    
    const keys = productDataMap[product];
    if (!keys) return;
    
    // Pulisci config globale (svuota oggetto ma mantieni struttura)
    if (project[keys.config]) {
        Object.keys(project[keys.config]).forEach(k => {
            project[keys.config][k] = '';
        });
    }
    
    // Pulisci BRM config
    if (project[keys.brm]) {
        Object.keys(project[keys.brm]).forEach(k => {
            if (k === 'operazioneL' || k === 'operazioneH' || k === 'operazioneC' || k === 'operazioneB') {
                project[keys.brm][k] = '-';
            } else if (k === 'valoreL' || k === 'valoreH' || k === 'valoreC' || k === 'valoreB' || 
                       k === 'SRSX' || k === 'SRDX' || k === 'ZSX' || k === 'ZDX') {
                project[keys.brm][k] = '0';
            } else {
                project[keys.brm][k] = '';
            }
        });
    }
    
    // Pulisci rilievo
    if (project[keys.rilievo]) {
        Object.keys(project[keys.rilievo]).forEach(k => {
            if (typeof project[keys.rilievo][k] === 'boolean') {
                project[keys.rilievo][k] = false;
            } else {
                project[keys.rilievo][k] = '';
            }
        });
    }
    
    // ğŸ”‘ IMPORTANTE: Pulisci tutte le posizioni
    if (project.positions && project.positions.length > 0) {
        project.positions.forEach(pos => {
            pos[keys.position] = null;
        });
    }
    
    console.log(`ğŸ§¹ v4.75: Puliti dati ${product} (config + ${project.positions?.length || 0} posizioni)`);
}

window.updateConfigPersiane = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configPersiane) project.configPersiane = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configPersiane[field];
        
        project.configPersiane[field] = value;
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'persiana', field, value, oldValue);
        
        saveState();
        
        // ğŸ”§ v4.44: Se il campo Ã¨ 'fissaggio', mostra/nascondi campi telaio
        if (field === 'fissaggio') {
            const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
            const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
            
            if (tipoTelaioContainer) {
                tipoTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
            }
            if (coloreTelaioContainer) {
                coloreTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
            }
        }
    }
};

// Nuova funzione per gestire i campi condizionali delle persiane
window.updateConfigPersianeConditional = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configPersiane) project.configPersiane = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configPersiane[field];
        
        project.configPersiane[field] = value;
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'persiana', field, value, oldValue);
        
        saveState();
        
        // Gestione visibilitÃ  campi condizionali
        if (field === 'modello') {
            const modelloAltro = document.getElementById(`modello-altro-${projectId}`);
            if (modelloAltro) {
                modelloAltro.style.display = value === 'altro' ? 'block' : 'none';
            }
        } else if (field === 'tipoTelaio') {
            const tipoTelaioAltro = document.getElementById(`tipo-telaio-altro-${projectId}`);
            if (tipoTelaioAltro) {
                tipoTelaioAltro.style.display = value === 'altro' ? 'block' : 'none';
            }
        }
    }
};

// Nuova funzione per gestire il fissaggio e i campi telaio
window.updateFissaggioPersiane = (projectId, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configPersiane) project.configPersiane = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configPersiane.fissaggio;
        
        project.configPersiane.fissaggio = value;
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'persiana', 'fissaggio', value, oldValue);
        
        saveState();
        
        const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
        const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
        
        if (tipoTelaioContainer) {
            tipoTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
        }
        if (coloreTelaioContainer) {
            coloreTelaioContainer.style.display = value === 'telaio' ? 'block' : 'none';
        }
    }
};

window.updateConfigTapparelle = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configTapparelle) project.configTapparelle = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configTapparelle[field];
        
        project.configTapparelle[field] = value;
        
        // ğŸ†• v5.556: Se cambia azienda, resetta modello e colore
        if (field === 'azienda' && oldValue !== value) {
            project.configTapparelle.modello = '';
            project.configTapparelle.colore = '';
        }
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'tapparella', field, value, oldValue);
        
        saveState();
        
        // ğŸ†• v5.556: Render per aggiornare select modelli se cambia azienda
        if (field === 'azienda') {
            render();
        }
    }
};

// ğŸ”Œ v5.40: Funzione per gestire accessori motore nella config globale
window.updateConfigTapparelleAccessorioMotore = (projectId, accessorioId, checked) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configTapparelle) project.configTapparelle = {};
        if (!project.configTapparelle.accessoriMotoreDefault) project.configTapparelle.accessoriMotoreDefault = {};
        
        project.configTapparelle.accessoriMotoreDefault[accessorioId] = checked;
        saveState();
        render();
    }
};

window.updateConfigZanzariere = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configZanzariere) project.configZanzariere = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configZanzariere[field];
        
        // ğŸ†• v5.96: Se cambio azienda, resetto campi specifici Palagina
        if (field === 'azienda' && value !== 'Palagina') {
            delete project.configZanzariere.lineaF;
            delete project.configZanzariere.lineaPF;
            delete project.configZanzariere.modelloF;
            delete project.configZanzariere.modelloPF;
            delete project.configZanzariere.fasciaColore;
            delete project.configZanzariere.colorePlastica;
        }
        
        project.configZanzariere[field] = value;
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'zanzariera', field, value, oldValue);
        
        saveState();
    }
};

window.updateConfigCassonetti = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configCassonetti) project.configCassonetti = {};
        
        // ğŸ†• Salva il vecchio valore PRIMA di aggiornare
        const oldValue = project.configCassonetti[field];
        
        project.configCassonetti[field] = value;
        
        // ğŸ†• AUTO-SYNC: Aggiorna automaticamente le posizioni dove non Ã¨ stato modificato manualmente
        syncConfigToPositions(project, 'cassonetto', field, value, oldValue);
        
        saveState();
    }
};

// ğŸ”’ v5.85: Config Grate Erreci
window.updateConfigGrate = (projectId, field, value) => {
    console.log('ğŸ”’ updateConfigGrate CHIAMATA:', field, '=', value);
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.configGrate) project.configGrate = {};
        const oldValue = project.configGrate[field];
        project.configGrate[field] = value;
        // Reset modello e apertura se cambia linea
        if (field === 'linea') {
            project.configGrate.modello = '';
            project.configGrate.tipoApertura = '';
        }
        syncConfigToPositions(project, 'grata', field, value, oldValue);
        saveState();
    }
};

// ğŸ†• FUNZIONE AUTO-SYNC: Sincronizza config globale â†’ posizioni
// Aggiorna automaticamente SOLO i campi che non sono stati modificati manualmente
function syncConfigToPositions(project, productType, field, newValue, oldValue) {
    if (!project || !project.positions) return 0;
    
    let contatore = 0;
    console.log(`ğŸ”„ syncConfigToPositions: ${productType}.${field}`);
    console.log(`   newValue:`, newValue);
    console.log(`   oldValue:`, oldValue);
    
    // ğŸ†• v5.718: Per zanzariere, gestione speciale lineaF/lineaPF â†’ linea, modelloF/modelloPF â†’ modello
    if (productType === 'zanzariera') {
        const isLineaF = field === 'lineaF';
        const isLineaPF = field === 'lineaPF';
        const isModelloF = field === 'modelloF';
        const isModelloPF = field === 'modelloPF';
        
        if (isLineaF || isLineaPF || isModelloF || isModelloPF) {
            const targetField = (isLineaF || isLineaPF) ? 'linea' : 'modello';
            const targetTipo = (isLineaF || isModelloF) ? 'F' : 'PF';
            
            console.log(`   ğŸ¦Ÿ Sync speciale zanzariera: ${field} â†’ ${targetField} per tipo ${targetTipo}`);
            
            project.positions.forEach(pos => {
                const zan = pos.zanzariera;
                if (zan && zan.tipoInfissoAssociato === targetTipo) {
                    const currentValue = zan[targetField];
                    
                    // Sync se vuoto o uguale al vecchio valore
                    const shouldSync = (
                        currentValue === undefined || 
                        currentValue === '' || 
                        currentValue === null ||
                        currentValue === oldValue
                    );
                    
                    console.log(`   Pos ${pos.id} (${zan.tipoInfissoAssociato}): ${targetField}=${currentValue}, shouldSync=${shouldSync}`);
                    
                    if (shouldSync) {
                        zan[targetField] = newValue;
                        console.log(`   âœ… SINCRONIZZATO: ${targetField} = ${newValue}`);
                        contatore++;
                    }
                }
            });
            
            console.log(`   ğŸ“Š Totale sincronizzati: ${contatore}`);
            return contatore;
        }
    }
    
    // Per ogni posizione del progetto (logica standard)
    project.positions.forEach(pos => {
        const product = pos[productType];
        
        // Se la posizione ha questo prodotto
        if (product) {
            const currentValue = product[field];
            
            // ğŸ¯ LOGICA AUTO-SYNC:
            // Aggiorna se:
            // 1. Il campo Ã¨ vuoto/undefined/null (mai impostato)
            // 2. Il campo Ã¨ un array vuoto [] (mai popolato)
            // 3. Il campo ha lo stesso valore della vecchia config (non modificato manualmente)
            const shouldSync = (
                currentValue === undefined || 
                currentValue === '' || 
                currentValue === null ||
                (Array.isArray(currentValue) && currentValue.length === 0) || // Array vuoto = mai impostato
                currentValue === oldValue ||
                (Array.isArray(currentValue) && Array.isArray(oldValue) && 
                 JSON.stringify(currentValue) === JSON.stringify(oldValue))
            );
            
            console.log(`   Posizione ${pos.id}: currentValue=`, currentValue, ` shouldSync=${shouldSync}`);
            
            if (shouldSync) {
                // Aggiorna con il nuovo valore globale
                if (Array.isArray(newValue)) {
                    // Per array (es. codTagli), crea una copia
                    product[field] = [...newValue];
                } else {
                    product[field] = newValue;
                }
                console.log(`   âœ… SINCRONIZZATO: ${field} =`, newValue);
                contatore++;
            } else {
                console.log(`   â­ï¸ SKIP (modificato manualmente)`);
            }
            // ALTRIMENTI: L'utente ha modificato manualmente â†’ NON aggiornare
        }
    });
    
    console.log(`   ğŸ“Š Totale sincronizzati: ${contatore}`);
    return contatore;
}

// Verifica sincronizzazione automatica
function verificaSincronizzazioneNecessaria(project) {
    if (!project || !project.configInfissi) return false;
    
    // Verifica se la config ha valori
    const configHaValori = (
        project.configInfissi.azienda ||
        project.configInfissi.telaio ||
        project.configInfissi.coloreInt ||
        // ğŸ†• v4.85: Usa tagliTelaio invece di codTagli (rimosso)
        project.configInfissi.tagliTelaio
    );
    
    if (!configHaValori) return false;
    
    // Conta campi vuoti nelle posizioni
    let campiVuoti = 0;
    project.positions.forEach(pos => {
        if (pos.infisso) {
            ['azienda', 'telaio', 'coloreInt'].forEach(field => {
                const posValue = pos.infisso[field];
                const configValue = project.configInfissi[field];
                
                const posIsEmpty = !posValue || posValue === '';
                const configHasValue = configValue && configValue !== '';
                
                if (posIsEmpty && configHasValue) {
                    campiVuoti++;
                }
            });
            
            // ğŸ†• v4.85: Check tagliTelaio invece di codTagli (rimosso)
            const tagliEmpty = !pos.infisso.tagliTelaio || pos.infisso.tagliTelaio === '';
            const tagliHasValue = project.configInfissi.tagliTelaio && project.configInfissi.tagliTelaio !== '';
            if (tagliEmpty && tagliHasValue) {
                campiVuoti++;
            }
        }
    });
    
    if (campiVuoti > 0) {
        console.warn(`âš ï¸ ATTENZIONE: ${campiVuoti} campi nelle posizioni sono vuoti ma la Config Globale ha valori!`);
        console.log('ğŸ’¡ SUGGERIMENTO: Usa il pulsante SINCRONIZZA TUTTO nella Config Globale.');
        return true;
    }
    
    return false;
}

// âœ… NUOVO: Funzione per ricalcolare tutti i BRM globali quando cambia la configurazione
function ricalcolaTuttiiBRMGlobali(project, configKey) {
    // Mappa tra configKey e productType
    const configToProductMap = {
        'brmConfigInfissi': 'infisso',
        'brmConfigPersiane': 'persiana',
        'brmConfigTapparelle': 'tapparella',
        'brmConfigZanzariere': 'zanzariera',
        'brmConfigCassonetti': 'cassonetto'
    };
    
    const productType = configToProductMap[configKey];
    if (!productType) return;
    
    // Ricalcola BRM per ogni posizione che ha questo prodotto
    project.positions.forEach(pos => {
        const product = pos[productType];
        
        // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
        if (product && !product.brmPersonalizzato) {
            // Determina il tipo per infissi e zanzariere
            let tipo = null;
            if (productType === 'infisso') {
                tipo = product.tipo;
            } else if (productType === 'zanzariera') {
                tipo = pos.infisso?.tipo || '';
            }
            
            // Usa le misure corrette in base al tipo di prodotto
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            
            // Ricalcola BRM con la config globale aggiornata
            const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
            
            // Aggiorna i valori BRM nel prodotto
            product.BRM_L = brm.L;
            product.BRM_H = brm.H;
            
            // Per cassonetti, gestisci anche C e B
            if (productType === 'cassonetto') {
                product.BRM_C = brm.C;
                product.BRM_B = brm.B;
            }
        }
    });
}

// âœ… NUOVO: Funzione per ricalcolare tutti i BRM di una posizione quando cambiano le misure
function ricalcolaBRMPerPosizione(project, pos) {
    const configMap = {
        'infisso': 'brmConfigInfissi',
        'persiana': 'brmConfigPersiane',
        'tapparella': 'brmConfigTapparelle',
        'zanzariera': 'brmConfigZanzariere',
        'cassonetto': 'brmConfigCassonetti'
    };
    
    // Ricalcola per ogni tipo di prodotto nella posizione
    ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
        const product = pos[productType];
        
        // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
        if (product && !product.brmPersonalizzato) {
            const configKey = configMap[productType];
            
            // Determina il tipo per infissi e zanzariere
            let tipo = null;
            if (productType === 'infisso') {
                tipo = product.tipo;
            } else if (productType === 'zanzariera') {
                tipo = pos.infisso?.tipo || '';
            }
            
            // Usa le misure corrette in base al tipo di prodotto
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            
            // Ricalcola BRM con la config globale
            if (project[configKey]) {
                const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                
                // Aggiorna i valori BRM nel prodotto
                product.BRM_L = brm.L;
                product.BRM_H = brm.H;
                
                // Per cassonetti, gestisci anche C e B
                if (productType === 'cassonetto') {
                    product.BRM_C = brm.C;
                    product.BRM_B = brm.B;
                }
            }
        }
    });
}

window.updateBRMConfig = (projectId, configKey, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project[configKey]) project[configKey] = {};
        
        // âœ… FIX: Converti sempre i valori mm in positivi (valore assoluto)
        // Se l'utente inserisce -10, lo convertiamo in 10
        // L'operazione (+ o -) viene gestita separatamente dal campo "operazione"
        if (field.startsWith('valore') && !isNaN(value)) {
            value = Math.abs(parseFloat(value)).toString();
        }
        
        project[configKey][field] = value;
        
        // ğŸ†• v5.563: Auto-imposta operazione a '-' quando si seleziona una misura
        if (field.startsWith('misuraBase') && value) {
            const opField = field.replace('misuraBase', 'operazione');
            if (!project[configKey][opField]) {
                project[configKey][opField] = '-';
                console.log(`ğŸ“ Auto-impostato ${opField} = '-'`);
            }
        }
        
        // âœ… NUOVO: Ricalcola automaticamente tutti i BRM che usano questa config globale
        ricalcolaTuttiiBRMGlobali(project, configKey);
        
        saveState();
        // âš¡ FASE 024B: NO render - approccio cloud
        // I dati sono giÃ  salvati, i BRM ricalcolati
        // L'utente vedrÃ  i cambiamenti al prossimo cambio naturale di vista
    }
};

window.updateBRMPersonalizzato = (projectId, posId, productType, field, value) => {
    updateBRMPersonalizzato(projectId, posId, productType, field, value);
};

window.updateCaratteristicheMuro = (projectId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
        project.caratteristicheMuro[field] = value;
        
        // ğŸ”§ CORREZIONE: Se modifichi "Battuta Superiore con Tapparella", 
        // aggiorna automaticamente BSuperiore nei cassonetti che usano le caratteristiche globali
        if (field === 'battutaSuperioreTapparella') {
            let cassUpdated = 0;
            project.positions.forEach(pos => {
                // Aggiorna solo se la posizione usa caratteristiche globali (non ha override)
                if (pos.cassonetto && !pos.overrideCaratteristiche) {
                    pos.cassonetto.BSuperiore = value || '0';
                    cassUpdated++;
                }
            });
            
            if (cassUpdated > 0) {
                // âš¡ FASE 024B: NO render - dati giÃ  salvati
                // showNotification mostrerÃ  il risultato senza bisogno di render
                showNotification(`âœ… Aggiornati ${cassUpdated} cassonetti con nuovo BSuperiore: ${value}mm`, 'success');
            }
        }
        
        saveState();
    }
};

// ğŸšª v5.60: Funzione per aggiornare config porte interne default
window.updateConfigPorteInterne = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) return;
    
    if (!project.configPorteInterne) project.configPorteInterne = {};
    project.configPorteInterne[field] = value;
    
    // ğŸšª v5.61: Cascata completa Azienda â†’ Linea â†’ Collezione â†’ Finitura + Telaio
    if (field === 'azienda') {
        project.configPorteInterne.linea = '';
        project.configPorteInterne.collezione = '';
        project.configPorteInterne.finitura = '';
        project.configPorteInterne.telaio = '';
        console.log('ğŸšª Config Porte: Cambiata azienda â†’ reset linea/collezione/finitura/telaio');
    }
    
    if (field === 'linea') {
        project.configPorteInterne.collezione = '';
        project.configPorteInterne.finitura = '';
        project.configPorteInterne.telaio = '';
        console.log('ğŸšª Config Porte: Cambiata linea â†’ reset collezione/finitura/telaio');
    }
    
    if (field === 'collezione') {
        project.configPorteInterne.finitura = '';
        console.log('ğŸšª Config Porte: Cambiata collezione â†’ reset finitura');
    }
    
    console.log('ğŸšª Config Porte Interne Default: ' + field + ' = ' + value);
    saveState();
    render();
};

// ğŸ—¿ NUOVA FUNZIONE: Aggiorna caratteristiche muro OVERRIDE per una specifica posizione
window.updateCaratteristicheMuroOverride = (projectId, posId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.overrideCaratteristiche) {
            if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
            pos.caratteristicheMuroOverride[field] = value;
            
            // ğŸ”§ CORREZIONE: Se modifichi "Battuta Superiore con Tapparella" nell'override,
            // aggiorna automaticamente BSuperiore nel cassonetto di questa posizione
            if (field === 'battutaSuperioreTapparella' && pos.cassonetto) {
                pos.cassonetto.BSuperiore = value || '0';
                // âš¡ FASE 024B: Aggiorna DOM diretto invece di render
                const bSupEl = document.getElementById(`bsup-${posId}`);
                if (bSupEl) bSupEl.value = value || '0';
                showNotification(`âœ… Aggiornato BSuperiore cassonetto: ${value}mm`, 'success');
            }
            
            saveState();
        }
    }
};

window.updateGuidaEsistente = (projectId, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
        project.caratteristicheMuro.guidaEsistente = value;
        saveState();
        
        const guidaFields = document.getElementById(`guida-fields-${projectId}`);
        if (guidaFields) {
            guidaFields.style.display = value === 'si' ? 'block' : 'none';
        }
    }
};

// âœ… NUOVO: Aggiorna dislivello default (finestre o porteFinestre)
window.updateDislivelloDefault = (projectId, tipo, field, value) => {
    markUserTyping();
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
        
        // Inizializza struttura dislivello se non esiste
        const key = tipo === 'finestre' ? 'dislivelloPianaFinestre' : 'dislivelloPianaPorteFinestre';
        if (!project.caratteristicheMuro[key]) {
            project.caratteristicheMuro[key] = {
                presente: false,
                pianaAlta: null,
                valore: 0,
                note: ''
            };
        }
        
        // Aggiorna campo
        if (field === 'presente') {
            project.caratteristicheMuro[key].presente = value;
            // Mostra/nascondi campi
            const fieldsId = tipo === 'finestre' ? 
                `dislivelloFinestreFields-${projectId}` : 
                `dislivelloPFFields-${projectId}`;
            const fieldsEl = document.getElementById(fieldsId);
            if (fieldsEl) {
                fieldsEl.style.display = value ? 'block' : 'none';
            }
            // Se disattivato, resetta valori
            if (!value) {
                project.caratteristicheMuro[key].pianaAlta = null;
                project.caratteristicheMuro[key].valore = 0;
            }
        } else if (field === 'valore') {
            project.caratteristicheMuro[key].valore = parseInt(value) || 0;
        } else {
            project.caratteristicheMuro[key][field] = value;
        }
        
        saveState();
    }
};

// âœ… NUOVO: Aggiorna dislivello per posizione specifica
window.updateDislivelloPosizione = (projectId, posId, field, value) => {
    markUserTyping();
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            // Determina se Ã¨ finestra o porta-finestra
            let prodotto = pos.finestra || pos.portaFinestra;
            const tipoKey = pos.finestra ? 'finestra' : 'portaFinestra';
            
            // Se il prodotto non esiste ancora, crealo
            if (!prodotto) {
                prodotto = {};
                pos[tipoKey] = prodotto;
            }
            
            // Inizializza struttura dislivello
            if (!prodotto.dislivelloPiana) {
                prodotto.dislivelloPiana = {
                    presente: false,
                    pianaAlta: null,
                    valore: 0,
                    note: ''
                };
            }
            
            // Aggiorna campo
            if (field === 'presente') {
                prodotto.dislivelloPiana.presente = value;
                // Mostra/nascondi campi
                const fieldsEl = document.getElementById(`dislivelloFields-${posId}`);
                if (fieldsEl) {
                    fieldsEl.style.display = value ? 'block' : 'none';
                }
                // Se disattivato, resetta valori
                if (!value) {
                    prodotto.dislivelloPiana.pianaAlta = null;
                    prodotto.dislivelloPiana.valore = 0;
                    prodotto.dislivelloPiana.note = '';
                }
            } else if (field === 'valore') {
                prodotto.dislivelloPiana.valore = parseInt(value) || 0;
            } else {
                prodotto.dislivelloPiana[field] = value;
            }
            
            saveState();
        }
    }
};

// ğŸ—¿ NUOVA FUNZIONE: Aggiorna guida esistente OVERRIDE per posizione
window.updateGuidaEsistenteOverride = (projectId, posId, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.overrideCaratteristiche) {
            if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
            pos.caratteristicheMuroOverride.guidaEsistente = value;
            saveState();
            
            // âš¡ FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
            const guidaFields = document.querySelector(`[id*="guida-fields-override-${posId}"]`);
            if (guidaFields) {
                guidaFields.style.display = value === 'si' ? 'block' : 'none';
            }
        }
    }
};

window.updateFalsoEsistente = (projectId, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
        project.caratteristicheMuro.falsoEsistente = value;
        saveState();
        
        const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
        const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
        if (falsoSiFields && falsoNoFields) {
            falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
            falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
        }
    }
};

// ğŸ—¿ NUOVA FUNZIONE: Aggiorna falso esistente OVERRIDE per posizione
window.updateFalsoEsistenteOverride = (projectId, posId, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.overrideCaratteristiche) {
            if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
            pos.caratteristicheMuroOverride.falsoEsistente = value;
            saveState();
            
            // âš¡ FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
            const falsoSiFields = document.querySelector(`[id*="falso-si-fields-override-${posId}"]`);
            const falsoNoFields = document.querySelector(`[id*="falso-no-fields-override-${posId}"]`);
            if (falsoSiFields && falsoNoFields) {
                falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
            }
        }
    }
};

// ğŸ†• FASE 15: Update Misure Globali Infissi
window.updateMisureGlobaliInfissi = (projectId, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        if (!project.misureGlobaliInfissi) {
            project.misureGlobaliInfissi = {
                LVT: '', HVT: '', LF: '', HF: '', 
                TMV: '', HMT: '', LVAR: '', HVAR: '',
                DeltaINT: '', DeltaEST: '',
                HSoffitto: '', HParapettoSoffitto: '', HPavimentoParapetto: ''
            };
        }
        project.misureGlobaliInfissi[field] = value;
        saveState();
    }
};

window.updatePosition = (projectId, posId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            pos[field] = value;
            
            // ğŸ”„ v5.622: Sincronizza quantitÃ  prodotti quando cambia quantitÃ  posizione
            if (field === 'quantita') {
                const qta = value || '1';
                // Aggiorna qta di tutti i prodotti associati
                if (pos.infisso) pos.infisso.qta = qta;
                if (pos.tapparella) {
                    pos.tapparella.qta = qta;
                    // Anche il motore se presente
                    if (pos.tapparella.motore) pos.tapparella.motore.qta = qta;
                }
                if (pos.cassonetto) pos.cassonetto.qta = qta;
                if (pos.persiana) pos.persiana.qta = qta;
                if (pos.zanzariera) pos.zanzariera.qta = qta;
                console.log('ğŸ”„ v5.622: QuantitÃ  posizione â†’ sincronizzata a tutti i prodotti:', qta);
            }
            
            // âœ… FIX: Rimuovi bordo rosso quando compili ambiente
            if (field === 'ambiente' && value && value.trim() !== '') {
                const selectEl = document.getElementById(`ambiente-select-${posId}`);
                const inputEl = document.getElementById(`ambiente-input-${posId}`);
                
                if (selectEl) {
                    selectEl.classList.remove('border-red-500', 'bg-red-50');
                    selectEl.classList.add('border-gray-300');
                }
                if (inputEl) {
                    inputEl.classList.remove('border-red-500', 'bg-red-50');
                    inputEl.classList.add('border-gray-300');
                }
            }
            
            saveState();
        }
    }
};

window.updateMisura = (projectId, posId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            if (!pos.misure) pos.misure = {};
            pos.misure[field] = value;
            saveState();
        }
    }
};

// ğŸ†• Gestione navigazione TAB tra campi misure
window.handleMisureTabNavigation = (event, posId, currentIndex, totalFields) => {
    if (event.key === 'Tab') {
        event.preventDefault();
        
        const grid = document.getElementById(`misure-grid-${posId}`);
        if (!grid) return;
        
        const inputs = grid.querySelectorAll('input[type="number"]');
        
        if (event.shiftKey) {
            // SHIFT+TAB: vai indietro
            const prevIndex = currentIndex - 1;
            if (prevIndex >= 0 && inputs[prevIndex]) {
                inputs[prevIndex].focus();
                inputs[prevIndex].select();
            }
        } else {
            // TAB: vai avanti
            const nextIndex = currentIndex + 1;
            if (nextIndex < totalFields && inputs[nextIndex]) {
                inputs[nextIndex].focus();
                inputs[nextIndex].select();
            }
        }
    }
};

window.updateMisuraWithValidation = (projectId, posId, field, value) => {
    markUserTyping(); // âš¡ FASE 024B: Track digitazione per sync silenzioso
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            // ğŸ›¡ï¸ Se l'utente modifica una misura che aveva un override, rimuovi l'override
            // perchÃ© il valore Ã¨ cambiato e deve essere rivalidato
            if (pos.validationOverrides && pos.validationOverrides[field]) {
                delete pos.validationOverrides[field];
                
                // Se non ci sono piÃ¹ override, rimuovi l'oggetto intero
                if (Object.keys(pos.validationOverrides).length === 0) {
                    delete pos.validationOverrides;
                }
            }
        }
    }
    
    updateMisura(projectId, posId, field, value);
    
    // âœ… NUOVO: Ricalcola automaticamente tutti i BRM di questa posizione quando cambiano le misure
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            ricalcolaBRMPerPosizione(project, pos);
        }
    }
    
    render();
};

window.enableOverride = (projectId, posId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            pos.overrideCaratteristiche = true;
            pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
            saveState();
            render();
        }
    }
};

window.disableOverride = (projectId, posId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos) {
            pos.overrideCaratteristiche = false;
            pos.caratteristicheMuroOverride = null;
            
            // ğŸ”§ CORREZIONE: Quando disabiliti l'override, aggiorna BSuperiore con il valore globale
            if (pos.cassonetto) {
                const bSuperioreGlobale = project.caratteristicheMuro?.battutaSuperioreTapparella || '0';
                pos.cassonetto.BSuperiore = bSuperioreGlobale;
                showNotification(`âœ… Cassonetto aggiornato con valore globale BSuperiore: ${bSuperioreGlobale}mm`, 'success');
            }
            
            saveState();
            render();
        }
    }
};

window.deletePosition = (projectId, posId) => {
    if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
        const project = state.projects.find(p => p.id === projectId);
        if (project) {
            project.positions = project.positions.filter(p => p.id !== posId);
            saveState();
            
            if (project.positions.length > 0) {
                state.currentPosition = project.positions[0].id;
                state.screen = 'position';
            } else {
                state.screen = 'project';
            }
            render();
        }
    }
};

// Motor Functions for Tapparelle
window.addMotoreTapparella = (projectId, posId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.tapparella) {
            if (!pos.tapparella.motori) {
                pos.tapparella.motori = [];
            }
            // ğŸ†• v5.40: Eredita valori da Config Motore Default
            const configDefault = project.configTapparelle || {};
            pos.tapparella.motori.push({ 
                modelloId: configDefault.motoreModelloDefault || '',
                comandoId: configDefault.comandoDefault || '',
                accessori: configDefault.accessoriMotoreDefault ? {...configDefault.accessoriMotoreDefault} : {},
                modelloManuale: '',
                note: ''
            });
            saveState();
            render();
        }
    }
};

window.updateMotoreTapparella = (projectId, posId, tappIdx, motoreIdx, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
            pos.tapparelle[tappIdx].motori[motoreIdx].modello = value;
            saveState();
        }
    }
};

// FASE 11a: Nuova funzione per aggiornare singoli campi del motore
window.updateMotoreTapparellaField = (projectId, posId, motoreIdx, field, value) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.tapparella && pos.tapparella.motori && pos.tapparella.motori[motoreIdx]) {
            pos.tapparella.motori[motoreIdx][field] = value;
            saveState();
            // âš¡ v5.34: Re-render se cambia modelloId (per mostrare/nascondere campo manuale)
            if (field === 'modelloId' || field === 'alimentazione') {
                deferredRender();
            }
        }
    }
};

// ğŸ”Œ v5.34: Funzione per gestire accessori motore nelle posizioni
window.updateMotoreTapparellaAccessorio = (projectId, posId, motoreIdx, accessorioId, checked) => {
    const project = state.projects.find(p => p.id === projectId);
    if (project) {
        const pos = project.positions.find(p => p.id === posId);
        if (pos && pos.tapparella && pos.tapparella.motori && pos.tapparella.motori[motoreIdx]) {
            if (!pos.tapparella.motori[motoreIdx].accessori) {
                pos.tapparella.motori[motoreIdx].accessori = {};
            }
            pos.tapparella.motori[motoreIdx].accessori[accessorioId] = checked;
            saveState();
            render();
        }
    }
};

window.removeMotoreTapparella = (projectId, posId, motoreIdx) => {
    if (confirm('Eliminare questo motore?')) {
        const project = state.projects.find(p => p.id === projectId);
        if (project) {
            const pos = project.positions.find(p => p.id === posId);
            if (pos && pos.tapparella && pos.tapparella.motori) {
                pos.tapparella.motori.splice(motoreIdx, 1);
                saveState();
                render();
            }
        }
    }
};

// Foto Functions
window.addFoto = (projectId, posId, input) => {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.foto) pos.foto = [];
                    pos.foto.push({
                        data: e.target.result,
                        timestamp: new Date().toISOString()
                    });
                    saveState();
                    showNotification('Foto aggiunta', 'success');
                    render();
                }
            }
        };
        reader.readAsDataURL(file);
    }
};

window.removeFoto = (projectId, posId, fotoIdx) => {
    if (confirm('Sei sicuro di voler eliminare questa foto?')) {
        const project = state.projects.find(p => p.id === projectId);
        if (project) {
            const pos = project.positions.find(p => p.id === posId);
            if (pos && pos.foto) {
                pos.foto.splice(fotoIdx, 1);
                saveState();
                render();
            }
        }
    }
};

window.addFotoPersiana = (projectId, posId, persianaIdx, input) => {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                    pos.persiane[persianaIdx].foto = {
                        data: e.target.result,
                        timestamp: new Date().toISOString()
                    };
                    saveState();
                    render();
                }
            }
        };
        reader.readAsDataURL(file);
    }
    input.value = '';
};

window.removeFotoPersiana = (projectId, posId, persianaIdx) => {
    if (confirm('Sei sicuro di voler eliminare questa foto?')) {
        const project = state.projects.find(p => p.id === projectId);
        if (project) {
            const pos = project.positions.find(p => p.id === posId);
            if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                pos.persiane[persianaIdx].foto = null;
                saveState();
                render();
            }
        }
    }
};

window.showFotoModal = (fotoData) => {
    const modal = document.getElementById('foto-modal');
    const img = document.getElementById('foto-modal-img');
    if (modal && img) {
        img.src = fotoData;
        modal.classList.remove('hidden');
    }
};

window.hideFotoModal = () => {
    const modal = document.getElementById('foto-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
};

// Export/Import Functions
window.exportAllProjects = () => {
    try {
        const data = {
            projects: state.projects,
            exportDate: new Date().toISOString(),
            version: '3.5-FASE006-JSON-COMPLETO',
            totalProjects: state.projects.length
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `open-porte-progetti-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showNotification(`Export completato! ${data.totalProjects} progetti`, 'success');
        
    } catch (error) {
        console.error('Errore export:', error);
        showNotification(`Errore durante export: ${error.message}`, 'error');
    }
};

// ğŸ“Š EXPORT EXCEL - Formato intuitivo con 3 fogli
window.exportAllProjectsExcel = () => {
    try {
        if (!window.XLSX) {
            showNotification('Errore: Libreria Excel non caricata', 'error');
            return;
        }
        
        // Array per i 3 fogli
        const progetti = [];
        const posizioni = [];
        const prodotti = [];
        
        // Processa ogni progetto
        state.projects.forEach(project => {
            // FOGLIO 1: PROGETTI
            progetti.push({
                'ID Progetto': project.id,
                'Nome Progetto': project.name || '',
                'Cliente': project.client || '',
                'Telefono': project.clientData?.telefono || '',
                'Email': project.clientData?.email || '',
                'Indirizzo': project.clientData?.indirizzo || '',
                'CittÃ ': project.clientData?.citta || '',
                'CAP': project.clientData?.cap || '',
                'Piano': project.clientData?.piano || '',
                'Prodotti Abilitati': Object.keys(project.prodotti || {}).filter(k => project.prodotti[k]).join(', '),
                'Num Posizioni': (project.positions || []).length,
                'Data Creazione': project.created || '',
                'Ultima Modifica': project.updated || ''
            });
            
            // FOGLIO 2: POSIZIONI + FOGLIO 3: PRODOTTI
            (project.positions || []).forEach(pos => {
                posizioni.push({
                    'ID Posizione': pos.id,
                    'ID Progetto': project.id,
                    'Nome Progetto': project.name,
                    'Nome Posizione': pos.name || '',
                    'Ambiente': pos.ambiente || '',
                    'Piano': pos.piano || '',
                    
                    // Misure posizione
                    'LVT (mm)': pos.misure?.LVT || '',
                    'HVT (mm)': pos.misure?.HVT || '',
                    'LF (mm)': pos.misure?.LF || '',
                    'HF (mm)': pos.misure?.HF || '',
                    'TMV (mm)': pos.misure?.TMV || '',
                    'HMT (mm)': pos.misure?.HMT || '',
                    'L4 (mm)': pos.misure?.L4 || '',
                    'H4 (mm)': pos.misure?.H4 || '',
                    'Delta INT (mm)': pos.misure?.DeltaINT || '',
                    'Delta EST (mm)': pos.misure?.DeltaEST || '',
                    
                    // Rilievo - ğŸ”„ v5.743: Sistema 3 stati (si/no/null â†’ SI/NO/?) + note coprifili
                    'Da Togliere': pos.rilievo?.togliere === 'si' ? 'SI' : (pos.rilievo?.togliere === 'no' ? 'NO' : '?'),
                    'Smaltimento': pos.rilievo?.smaltimento === 'si' ? 'SI' : (pos.rilievo?.smaltimento === 'no' ? 'NO' : '?'),
                    'Materiale Esistente': pos.rilievo?.materiale || '',
                    'Coprifili INT': pos.rilievo?.coprifiliInt === 'si' ? 'SI' : (pos.rilievo?.coprifiliInt === 'no' ? 'NO' : '?'),
                    'Coprifili INT Note': pos.rilievo?.coprifiliIntNote || '',
                    'Coprifili EST': pos.rilievo?.coprifiliEst === 'si' ? 'SI' : (pos.rilievo?.coprifiliEst === 'no' ? 'NO' : '?'),
                    'Coprifili EST Note': pos.rilievo?.coprifiliEstNote || '',
                    'Note Rilievo': pos.rilievo?.note || ''
                });
                
                // PRODOTTI nella posizione
                const prodottiTypes = ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'];
                
                prodottiTypes.forEach(tipo => {
                    const prod = pos[tipo];
                    if (prod && typeof prod === 'object' && parseInt(prod.qta || 0) > 0) {
                        prodotti.push({
                            'ID Posizione': pos.id,
                            'ID Progetto': project.id,
                            'Nome Progetto': project.name,
                            'Nome Posizione': pos.name,
                            'Ambiente': pos.ambiente,
                            
                            // Tipo prodotto
                            'Tipo Prodotto': tipo.toUpperCase(),
                            'QuantitÃ ': prod.qta || '',
                            
                            // Dati comuni
                            'Azienda': prod.azienda || '',
                            'Modello/Tipo': prod.tipo || prod.modello || '',
                            'BRM Larghezza (mm)': prod.BRM_L || '',
                            'BRM Altezza (mm)': prod.BRM_H || '',
                            
                            // Colori
                            'Colore Interno': prod.coloreInt || prod.colore || '',
                            'Colore Esterno': prod.coloreEst || '',
                            
                            // Specifici infisso
                            'Apertura': prod.apertura || '',
                            'Tipo Anta': prod.tipoAnta || '',
                            'Telaio': prod.telaio || '',
                            'Vetro': prod.vetro || '',
                            'Cerniere': prod.cerniere || '',  // ğŸ†• v4.80
                            'Tagli Telaio': prod.tagliTelaio || '',
                            'Codici Tagli': (prod.codTagliValues || []).join(','),
                            'Maniglia': prod.maniglia || '',
                            'Colore Maniglia': prod.coloreManiglia || '',
                            'Allarme': prod.allarme || '',
                            
                            // Specifici persiana/tapparella
                            'Fissaggio': prod.fissaggio || '',
                            'Motorizzazione': prod.motorizzazione || '',
                            
                            // Note
                            'Note Prodotto': prod.note || ''
                        });
                    }
                });
            });
        });
        
        // Crea workbook
        const wb = XLSX.utils.book_new();
        
        // Aggiungi i 3 fogli
        const ws1 = XLSX.utils.json_to_sheet(progetti);
        const ws2 = XLSX.utils.json_to_sheet(posizioni);
        const ws3 = XLSX.utils.json_to_sheet(prodotti);
        
        XLSX.utils.book_append_sheet(wb, ws1, "Progetti");
        XLSX.utils.book_append_sheet(wb, ws2, "Posizioni");
        XLSX.utils.book_append_sheet(wb, ws3, "Prodotti");
        
        // Download
        const fileName = `openporte-export-${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showNotification(`âœ… Excel esportato! ${progetti.length} progetti, ${posizioni.length} posizioni, ${prodotti.length} prodotti`, 'success');
        
    } catch (error) {
        console.error('Errore export Excel:', error);
        showNotification(`Errore durante export Excel: ${error.message}`, 'error');
    }
};

// ğŸ“Š EXPORT EXCEL SINGOLO PROGETTO - Tutte le colonne in orizzontale
window.exportCurrentProjectExcel = () => {
    try {
        if (!window.XLSX) {
            showNotification('Errore: Libreria Excel non caricata', 'error');
            return;
        }
        
        const project = state.projects.find(p => p.id === state.currentProject);
        if (!project) {
            showNotification('Nessun progetto selezionato', 'error');
            return;
        }
        
        // ========== FOGLIO 1: DATI PROGETTO ==========
        const progettoData = [{
            'Nome Progetto': project.name || '',
            'Cliente': project.client || '',
            'Piano': project.clientData?.piano || '',
            'CittÃ ': project.clientData?.citta || '',
            'Via/Indirizzo': project.clientData?.indirizzo || '',
            'Telefono': project.clientData?.telefono || '',
            'Email': project.clientData?.email || '',
            'Note Cliente': project.clientData?.note || '',
            
            'Infissi Abilitati': project.prodotti?.infissi ? 'SI' : 'NO',
            'Persiane Abilitate': project.prodotti?.persiane ? 'SI' : 'NO',
            'Tapparelle Abilitate': project.prodotti?.tapparelle ? 'SI' : 'NO',
            'Zanzariere Abilitate': project.prodotti?.zanzariere ? 'SI' : 'NO',
            'Cassonetti Abilitati': project.prodotti?.cassonetti ? 'SI' : 'NO',
            
            // MURO TEMPLATE
            'Prof. Muro Int': project.caratteristicheMuro?.profMuroInt || '',
            'Prof. Piana Sopra': project.caratteristicheMuro?.profPianaSopra || '',
            'Prof. Piana Sotto': project.caratteristicheMuro?.profPianaSotto || '',
            'Telaio Prof': project.caratteristicheMuro?.telaioProfondita || '',
            'Telaio Largh': project.caratteristicheMuro?.telaioLarghezza || '',
            'Guida Esistente?': project.caratteristicheMuro?.guidaEsistente || '',
            'Prof. Guida': project.caratteristicheMuro?.profGuida || '',
            'Larghezza Guida': project.caratteristicheMuro?.larghezzaGuida || '',
            'Prof. Muro Est.': project.caratteristicheMuro?.profMuroEst || '',
            'Battuta Sup. con Tapp.': project.caratteristicheMuro?.battutaSuperioreTapparella || '',
            'Falso Esistente?': project.caratteristicheMuro?.falsoEsistente || '',
            'Spessore Falso': project.caratteristicheMuro?.spessoreFalso || '',
            'Dist. Falso-Infisso': project.caratteristicheMuro?.distanzaFalsoInfisso || '',
            
            // INFISSI CONFIG + BRM
            'Infissi - Azienda': project.configInfissi?.azienda || '',
            'Infissi - Telaio': project.configInfissi?.telaio || '',
            'Infissi - Colore INT': project.configInfissi?.coloreInt || '',
            'Infissi - Colore EST': project.configInfissi?.coloreEst || '',
            'Infissi - Tipo Anta': project.configInfissi?.tipoAnta || '',
            'Infissi - Vetro': project.configInfissi?.vetro || '',
            'Infissi - Tagli Telaio': project.configInfissi?.tagliTelaio || '',
            'Infissi BRM - Base L': project.brmConfigInfissi?.misuraBaseL || '',
            'Infissi BRM - Op. L': project.brmConfigInfissi?.operazioneL || '',
            'Infissi BRM - Valore L': project.brmConfigInfissi?.valoreL || '',
            'Infissi BRM - Base H': project.brmConfigInfissi?.misuraBaseH || '',
            'Infissi BRM - Op. H': project.brmConfigInfissi?.operazioneH || '',
            'Infissi BRM - Valore H': project.brmConfigInfissi?.valoreH || '',
            
            // PERSIANE CONFIG + BRM
            'Persiane - Azienda': project.configPersiane?.azienda || '',
            'Persiane - Modello': project.configPersiane?.modello || '',
            'Persiane - Fissaggio': project.configPersiane?.fissaggio || '',
            'Persiane - Colore': project.configPersiane?.colore || '',
            'Persiane BRM - Base L': project.brmConfigPersiane?.misuraBaseL || '',
            'Persiane BRM - Op. L': project.brmConfigPersiane?.operazioneL || '',
            'Persiane BRM - Valore L': project.brmConfigPersiane?.valoreL || '',
            'Persiane BRM - Base H': project.brmConfigPersiane?.misuraBaseH || '',
            'Persiane BRM - Op. H': project.brmConfigPersiane?.operazioneH || '',
            'Persiane BRM - Valore H': project.brmConfigPersiane?.valoreH || '',
            
            // TAPPARELLE CONFIG + BRM
            'Tapparelle - Azienda': project.configTapparelle?.azienda || '',
            'Tapparelle - Tipo': project.configTapparelle?.tipo || '',
            'Tapparelle - Colore': project.configTapparelle?.colore || '',
            'Tapparelle - Motorizzazione': project.configTapparelle?.motorizzazione || '',
            'Tapparelle BRM - Base L': project.brmConfigTapparelle?.misuraBaseL || '',
            'Tapparelle BRM - Op. L': project.brmConfigTapparelle?.operazioneL || '',
            'Tapparelle BRM - Valore L': project.brmConfigTapparelle?.valoreL || '',
            'Tapparelle BRM - Base H': project.brmConfigTapparelle?.misuraBaseH || '',
            'Tapparelle BRM - Op. H': project.brmConfigTapparelle?.operazioneH || '',
            'Tapparelle BRM - Valore H': project.brmConfigTapparelle?.valoreH || '',
            
            // ZANZARIERE CONFIG + BRM
            'Zanzariere - Azienda': project.configZanzariere?.azienda || '',
            'Zanzariere - Modello F': project.configZanzariere?.modelloF || '',
            'Zanzariere - Modello PF': project.configZanzariere?.modelloPF || '',
            'Zanzariere - Colore': project.configZanzariere?.colore || '',
            'Zanzariere BRM - Base L': project.brmConfigZanzariere?.misuraBaseL || '',
            'Zanzariere BRM - Op. L': project.brmConfigZanzariere?.operazioneL || '',
            'Zanzariere BRM - Valore L': project.brmConfigZanzariere?.valoreL || '',
            'Zanzariere BRM - Base H': project.brmConfigZanzariere?.misuraBaseH || '',
            'Zanzariere BRM - Op. H': project.brmConfigZanzariere?.operazioneH || '',
            'Zanzariere BRM - Valore H': project.brmConfigZanzariere?.valoreH || '',
            
            // CASSONETTI CONFIG + BRM
            'Cassonetti - Tipo': project.configCassonetti?.tipo || '',
            'Cassonetti - Azienda': project.configCassonetti?.azienda || '',
            'Cassonetti - Colore': project.configCassonetti?.colore || '',
            'Cassonetti BRM - Base L': project.brmConfigCassonetti?.misuraBaseL || '',
            'Cassonetti BRM - Base H': project.brmConfigCassonetti?.misuraBaseH || '',
            'Cassonetti BRM - Base C': project.brmConfigCassonetti?.misuraBaseC || '',
            'Cassonetti BRM - Base B': project.brmConfigCassonetti?.misuraBaseB || ''
        }];
        
        // ========== FOGLIO 2: POSIZIONI ==========
        const posizioniRows = [];
        
        (project.positions || []).forEach(pos => {
            // Ottieni caratteristiche muro (override o globali)
            const cm = pos.caratteristicheMuroOverride || project.caratteristicheMuro || {};
            
            const row = {
                // DATI POSIZIONE
                'Nome Posizione': pos.name || '',
                'Ambiente': pos.ambiente || '',
                'Piano': pos.piano || '',
                
                // CARATTERISTICHE MURO (valori reali posizione)
                'Prof. Muro Int': cm.profMuroInt || '',
                'Prof. Piana Sopra': cm.profPianaSopra || '',
                'Prof. Piana Sotto': cm.profPianaSotto || '',
                'Telaio Prof': cm.telaioProfondita || '',
                'Telaio Largh': cm.telaioLarghezza || '',
                'Guida Esistente?': cm.guidaEsistente || '',
                'Prof. Guida': cm.profGuida || '',
                'Larghezza Guida': cm.larghezzaGuida || '',
                'Prof. Muro Est.': cm.profMuroEst || '',
                'Battuta Sup. con Tapp.': cm.battutaSuperioreTapparella || '',
                'Falso Esistente?': cm.falsoEsistente || '',
                'Spessore Falso': cm.spessoreFalso || '',
                'Dist. Falso-Infisso': cm.distanzaFalsoInfisso || '',
                
                // MISURE POSIZIONE
                'LVT': pos.misure?.LVT || '',
                'HVT': pos.misure?.HVT || '',
                'LF': pos.misure?.LF || '',
                'HF': pos.misure?.HF || '',
                'TMV': pos.misure?.TMV || '',
                'HMT': pos.misure?.HMT || '',
                'L4': pos.misure?.L4 || '',
                'H4': pos.misure?.H4 || '',
                'Delta INT': pos.misure?.DeltaINT || '',
                'Delta EST': pos.misure?.DeltaEST || '',
                'H Soffitto': pos.misure?.HSoffitto || '',
                'H Parapetto Soffitto': pos.misure?.HParapettoSoffitto || '',
                'H Pavimento Parapetto': pos.misure?.HPavimentoParapetto || '',
                
                // RILIEVO POSIZIONE - ğŸ”„ v5.743: Sistema 3 stati + note coprifili
                'Da Togliere': pos.rilievo?.togliere === 'si' ? 'SI' : (pos.rilievo?.togliere === 'no' ? 'NO' : '?'),
                'Smaltimento': pos.rilievo?.smaltimento === 'si' ? 'SI' : (pos.rilievo?.smaltimento === 'no' ? 'NO' : '?'),
                'Materiale Esistente': pos.rilievo?.materiale || '',
                'Coprifili INT': pos.rilievo?.coprifiliInt === 'si' ? 'SI' : (pos.rilievo?.coprifiliInt === 'no' ? 'NO' : '?'),
                'Coprifili INT Note': pos.rilievo?.coprifiliIntNote || '',
                'Coprifili EST': pos.rilievo?.coprifiliEst === 'si' ? 'SI' : (pos.rilievo?.coprifiliEst === 'no' ? 'NO' : '?'),
                'Coprifili EST Note': pos.rilievo?.coprifiliEstNote || '',
                'Note Rilievo': pos.rilievo?.note || '',
                
                // INFISSO POSIZIONE
                'Infisso QTA': pos.infisso?.qta || '',
                'Infisso Tipo': pos.infisso?.tipo || '',
                'Infisso Apertura': pos.infisso?.apertura || '',
                'Infisso Azienda': pos.infisso?.azienda || '',
                'Infisso Telaio': pos.infisso?.telaio || '',
                'Infisso Colore INT': pos.infisso?.coloreInt || '',
                'Infisso Colore EST': pos.infisso?.coloreEst || '',
                'Infisso Tipo Anta': pos.infisso?.tipoAnta || '',
                'Infisso Vetro': pos.infisso?.vetro || '',
                'Infisso Tagli Telaio': pos.infisso?.tagliTelaio || '',
                'Infisso Maniglia': pos.infisso?.maniglia || '',
                'Infisso Colore Maniglia': pos.infisso?.coloreManiglia || '',
                // ğŸ†• v5.712: Campi Finstral
                'Infisso Codice Modello': pos.infisso?.codiceModello || '',
                'Infisso Ferramenta': pos.infisso?.ferramenta1 || '',
                // ğŸ†• v5.734: Campi FIN-Slide HST
                'HST Telaio': pos.infisso?.finslideTelaio || '',
                'HST Anta': pos.infisso?.finslideAnta || '',
                'HST Ferramenta': pos.infisso?.finslideFerramenta || '',
                'HST Maniglia': pos.infisso?.finslideManiglia || '',
                'HST Colore Maniglia': pos.infisso?.finslideColoreManiglia || '',
                'HST Vetro': pos.infisso?.finslideVetro || '',
                'Infisso BRM L': pos.infisso?.BRM_L || '',
                'Infisso BRM H': pos.infisso?.BRM_H || '',
                'Infisso Note': pos.infisso?.note || '',
                
                // PERSIANA POSIZIONE
                'Persiana QTA': pos.persiana?.qta || '',
                'Persiana Azienda': pos.persiana?.azienda || '',
                'Persiana Modello': pos.persiana?.modello || '',
                'Persiana Fissaggio': pos.persiana?.fissaggio || '',
                'Persiana Colore': pos.persiana?.colore || '',
                'Persiana BRM L': pos.persiana?.BRM_L || '',
                'Persiana BRM H': pos.persiana?.BRM_H || '',
                'Persiana Note': pos.persiana?.note || '',
                
                // TAPPARELLA POSIZIONE
                'Tapparella QTA': pos.tapparella?.qta || '',
                'Tapparella Azienda': pos.tapparella?.azienda || '',
                'Tapparella Tipo': pos.tapparella?.tipo || '',
                'Tapparella Colore': pos.tapparella?.colore || '',
                'Tapparella Motorizzazione': pos.tapparella?.motorizzazione || '',
                'Tapparella BRM L': pos.tapparella?.BRM_L || '',
                'Tapparella BRM H': pos.tapparella?.BRM_H || '',
                'Tapparella Note': pos.tapparella?.note || '',
                
                // ZANZARIERA POSIZIONE
                'Zanzariera QTA': pos.zanzariera?.qta || '',
                'Zanzariera Azienda': pos.zanzariera?.azienda || '',
                'Zanzariera Modello F': pos.zanzariera?.modelloF || '',
                'Zanzariera Modello PF': pos.zanzariera?.modelloPF || '',
                'Zanzariera Colore': pos.zanzariera?.colore || '',
                'Zanzariera BRM L': pos.zanzariera?.BRM_L || '',
                'Zanzariera BRM H': pos.zanzariera?.BRM_H || '',
                'Zanzariera Note': pos.zanzariera?.note || '',
                
                // CASSONETTO POSIZIONE
                'Cassonetto QTA': pos.cassonetto?.qta || '',
                'Cassonetto Tipo': pos.cassonetto?.tipo || '',
                'Cassonetto Azienda': pos.cassonetto?.azienda || '',
                'Cassonetto Colore': pos.cassonetto?.colore || '',
                'Cassonetto Materiale': pos.cassonetto?.materialeCass || '',
                'Cassonetto Codice': pos.cassonetto?.codiceCass || '',
                'Cassonetto Gruppo Colore': pos.cassonetto?.gruppoColoreCass || '',
                'Cassonetto Cod Isolamento': pos.cassonetto?.codiceIsolamento || '',
                'Cassonetto Isolamento Posaclima': pos.cassonetto?.isolamentoPosaclima ? 'SÃ¬' : '',
                'Cassonetto A Soffitto': pos.cassonetto?.aSoffitto ? 'SÃ¬' : '',
                'Cassonetto BRM L': pos.cassonetto?.BRM_L || '',
                'Cassonetto BRM H': pos.cassonetto?.BRM_H || '',
                'Cassonetto HCASS': pos.cassonetto?.HCASS || '',
                'Cassonetto B': pos.cassonetto?.B || '',
                'Cassonetto C': pos.cassonetto?.C || '',
                'Cassonetto Note': pos.cassonetto?.note || '',
                
                // NOTE
                'Note Posizione': pos.note || '',
                'Num Foto': (pos.foto || []).length
            };
            
            posizioniRows.push(row);
        });
        
        // Crea workbook con 2 fogli
        const wb = XLSX.utils.book_new();
        
        const ws1 = XLSX.utils.json_to_sheet(progettoData);
        const ws2 = XLSX.utils.json_to_sheet(posizioniRows);
        
        XLSX.utils.book_append_sheet(wb, ws1, "Progetto");
        XLSX.utils.book_append_sheet(wb, ws2, "Posizioni");
        
        // Download
        const fileName = `${project.name || 'progetto'}-${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showNotification(`âœ… Excel esportato! Progetto + ${posizioniRows.length} posizioni`, 'success');
        
    } catch (error) {
        console.error('Errore export Excel:', error);
        showNotification(`Errore durante export Excel: ${error.message}`, 'error');
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“ v5.27: LINK SCHIZZO NOTABILITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * Apre il link schizzo nel browser/app
 * - Su PC: apre PDF nel browser
 * - Su iPad: Notability gestisce il deep link automaticamente
 */
window.openSchizzo = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project || !project.linkSchizzo) {
        showNotification('âš ï¸ Nessuno schizzo allegato. Tieni premuto per aggiungere.', 'warning');
        return;
    }
    
    // Apri in nuova tab - Notability.com gestisce automaticamente il deep link su iPad
    window.open(project.linkSchizzo, '_blank');
    console.log('ğŸ“ Aperto schizzo:', project.linkSchizzo);
};

/**
 * Modifica/Aggiungi link schizzo
 */
window.editLinkSchizzo = (projectId) => {
    const project = state.projects.find(p => p.id === projectId);
    if (!project) {
        showNotification('Progetto non trovato', 'error');
        return;
    }
    
    const currentLink = project.linkSchizzo || '';
    const newLink = prompt(
        'ğŸ“ Link Schizzo Notability\n\n' +
        'Incolla qui il link di condivisione da Notability.\n' +
        'Esempio: https://notability.com/n/xxxx...\n\n' +
        'Lascia vuoto per rimuovere.',
        currentLink
    );
    
    // Se l'utente ha premuto Annulla, newLink Ã¨ null
    if (newLink === null) return;
    
    // Salva il link (anche vuoto per rimuovere)
    project.linkSchizzo = newLink.trim();
    saveState();
    render();
    
    if (newLink.trim()) {
        showNotification('âœ… Link schizzo salvato!', 'success');
    } else {
        showNotification('ğŸ—‘ï¸ Link schizzo rimosso', 'info');
    }
    
    console.log('ğŸ“ Link schizzo aggiornato:', project.linkSchizzo);
};

/**
 * ğŸ†• v5.739: Forza aggiornamento app bypassando la cache
 * I dati in localStorage sono preservati
 */
window.forceUpdateApp = () => {
    const currentVersion = APP_VERSION;
    
    // Conferma prima di procedere
    const conferma = confirm(
        'ğŸ”„ AGGIORNA VERSIONE APP\n\n' +
        `Versione attuale: v${currentVersion}\n\n` +
        'âš ï¸ Questo ricaricherÃ  la pagina scaricando\n' +
        'la versione piÃ¹ recente dal server.\n\n' +
        'âœ… I tuoi dati e progetti saranno PRESERVATI.\n\n' +
        'Procedere con l\'aggiornamento?'
    );
    
    if (!conferma) return;
    
    // Salva lo stato corrente per sicurezza
    saveState();
    
    // Mostra notifica
    showNotification('ğŸ”„ Aggiornamento in corso...', 'info');
    
    // Forza refresh bypassando la cache con timestamp
    setTimeout(() => {
        // Metodo 1: Aggiungi timestamp per forzare nuovo download
        const baseUrl = window.location.href.split('?')[0];
        const newUrl = baseUrl + '?refresh=' + Date.now();
        
        // Prova prima con location.reload(true) per hard refresh
        // Se non funziona, usa redirect con timestamp
        try {
            // Hard reload - forza ricaricamento dal server
            window.location.href = newUrl;
        } catch (e) {
            // Fallback
            window.location.reload(true);
        }
    }, 500);
};

window.exportCurrentProjectJSON = () => {
    try {
        const project = state.projects.find(p => p.id === state.currentProject);
        if (!project) {
            showNotification('Nessun progetto selezionato', 'error');
            return;
        }
        
        // ğŸ†• FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
        // ğŸ”§ FASE 014: Passa project alla funzione
        const posizioniIncomplete = project.positions.map(pos => {
            const comp = calculatePositionCompleteness(pos, project);
            return { pos, comp };
        }).filter(item => !item.comp.isComplete);
        
        if (posizioniIncomplete.length > 0) {
            let dettagli = posizioniIncomplete.map(item => {
                const nome = item.pos.name || 'Senza nome';
                const perc = item.comp.percentage;
                const mancanti = item.comp.missing.join(', ');
                return `â€¢ ${nome} (${perc}%): ${mancanti}`;
            }).join('\n');
            
            const conferma = confirm(
                `âš ï¸ ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                `Vuoi procedere comunque con l'export?\n\n` +
                `[OK] = Esporta lo stesso | [Annulla] = Torna a completare`
            );
            
            if (!conferma) {
                showNotification('Export annullato. Completa le posizioni mancanti.', 'info');
                return;
            }
        }
        
        // ğŸ†• VALIDAZIONE: Verifica che tutte le posizioni abbiano Ambiente compilato
        const posizioniSenzaAmbiente = project.positions.filter(pos => !pos.ambiente || pos.ambiente.trim() === '');
        if (posizioniSenzaAmbiente.length > 0) {
            const nomiPosizioni = posizioniSenzaAmbiente.map(pos => pos.name || 'Senza nome').join(', ');
            showNotification(
                `âš ï¸ Ambiente obbligatorio! Le seguenti posizioni non hanno l'ambiente compilato: ${nomiPosizioni}`,
                'error',
                8000
            );
            return;
        }
        
        // ğŸ†• v5.78: Usa JSON_MANAGER unificato
        if (typeof JSON_MANAGER !== 'undefined') {
            const result = JSON_MANAGER.downloadJSON(project, {
                source: 'app-rilievo',
                filename: `RILIEVO-${project.client || 'Cliente'}-${project.name || 'Progetto'}-${new Date().toISOString().split('T')[0]}.json`
            });
            showNotification(`âœ… JSON esportato: ${result.filename}`, 'success');
        } else {
            // Fallback se JSON_MANAGER non caricato
            console.warn('âš ï¸ JSON_MANAGER non disponibile, uso export legacy');
            _exportProjectLegacy(project);
        }
        
    } catch (error) {
        console.error('Errore export JSON:', error);
        showNotification(`Errore durante export: ${error.message}`, 'error');
    }
};

// ğŸ”„ Export legacy (fallback se JSON_MANAGER non disponibile)
function _exportProjectLegacy(project) {
    const data = {
        commessa_id: project.id,
        versione: "1.0-LEGACY",
        data_rilievo: new Date().toISOString(),
        nome_ricerca: `${project.client || ''} ${project.name || ''}`.trim(),
        cliente: {
            nome: project.client || '',
            progetto: project.name || '',
            piano: project.clientData?.piano || '',
            indirizzo: project.clientData?.indirizzo || '',
            telefono: project.clientData?.telefono || ''
        },
        // ğŸ”§ v5.88: EXPORT CENTRALIZZATO
        posizioni: typeof exportPositions !== 'undefined'
            ? exportPositions(project.positions)
            : project.positions.map(pos => JSON.parse(JSON.stringify(pos)))
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `RILIEVO-${project.client || 'Cliente'}-${project.name || 'Progetto'}-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification(`âœ… JSON esportato (legacy)`, 'success');
}

// Funzione per stampare PDF del rilievo
window.printCurrentProjectPDF = () => {
    try {
        const project = state.projects.find(p => p.id === state.currentProject);
        if (!project) {
            showNotification('Nessun progetto selezionato', 'error');
            return;
        }
        
        // ğŸ†• FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
        // ğŸ”§ FASE 014: Passa project alla funzione
        const posizioniIncomplete = project.positions.map(pos => {
            const comp = calculatePositionCompleteness(pos, project);
            return { pos, comp };
        }).filter(item => !item.comp.isComplete);
        
        if (posizioniIncomplete.length > 0) {
            let dettagli = posizioniIncomplete.map(item => {
                const nome = item.pos.name || 'Senza nome';
                const perc = item.comp.percentage;
                const mancanti = item.comp.missing.join(', ');
                return `â€¢ ${nome} (${perc}%): ${mancanti}`;
            }).join('\n');
            
            const conferma = confirm(
                `âš ï¸ ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                `Vuoi procedere comunque con la stampa PDF?\n\n` +
                `[OK] = Stampa lo stesso | [Annulla] = Torna a completare`
            );
            
            if (!conferma) {
                showNotification('Stampa annullata. Completa le posizioni mancanti.', 'info');
                return;
            }
        }
        
        // Genera HTML per stampa - continua nel prossimo file
        const printHTML = generatePrintHTML(project);
        
        // Apri finestra di stampa
        const printWindow = window.open('', '', 'width=900,height=700');
        printWindow.document.write(printHTML);
        printWindow.document.close();
        
        // Aspetta che il contenuto sia caricato prima di stampare
        printWindow.onload = () => {
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        };
        
        showNotification('ğŸ“„ Finestra di stampa aperta!', 'success');
        
    } catch (error) {
        console.error('Errore stampa PDF:', error);
        showNotification(`Errore durante stampa: ${error.message}`, 'error');
    }
};

// Funzione helper per generare HTML di stampa
function generatePrintHTML(project) {
    return `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>OpenPorte Rilievo v5.98</title>
<style>
@media print { @page { margin: 1cm; } body { margin: 0; } .page-break { page-break-after: always; } }
body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
h1 { color: #1e293b; border-bottom: 3px solid #6366f1; padding-bottom: 10px; margin-bottom: 20px; }
h2 { color: #475569; background: #f1f5f9; padding: 10px; margin-top: 30px; border-left: 4px solid #6366f1; }
h3 { color: #334155; margin-top: 20px; background: #e2e8f0; padding: 8px; }
h4 { color: #475569; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
th { background-color: #6366f1; color: white; font-weight: bold; }
tr:nth-child(even) { background-color: #f8fafc; }
.header-info { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
.header-info p { margin: 5px 0; }
.totali { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #fbbf24; }
.nota { background: #dbeafe; padding: 10px; border-left: 4px solid #3b82f6; margin: 10px 0; font-size: 0.9em; }
.logo { text-align: center; margin-bottom: 20px; color: #6366f1; font-size: 1.2em; font-weight: bold; }
</style></head><body>
<div class="logo">OPEN PORTE & FINESTRE SRL</div>
<h1>ğŸ“‹ RILIEVO MISURE</h1>
<div class="header-info">
<p><strong>ğŸ¢ Cliente:</strong> ${project.client || 'N/D'}</p>
<p><strong>ğŸ“ Progetto:</strong> ${project.name || 'N/D'}</p>
<p><strong>ğŸ“ Piano:</strong> ${project.clientData?.piano || 'N/D'}</p>
<p><strong>ğŸ  Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/D'}</p>
<p><strong>ğŸ“ Telefono:</strong> ${project.clientData?.telefono || 'N/D'}</p>
<p><strong>ğŸ“… Data Rilievo:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</p>
${project.clientData?.note ? `<p><strong>ğŸ“ Note:</strong> ${project.clientData.note}</p>` : ''}
</div>
<div class="totali">
<strong>ğŸ“Š RIEPILOGO TOTALI:</strong><br>
â€¢ Posizioni: ${project.positions.length}<br>
â€¢ Infissi: ${project.positions.filter(p => p.infisso).length}<br>
â€¢ Persiane: ${project.positions.filter(p => p.persiana).length}<br>
â€¢ Tapparelle: ${project.positions.filter(p => p.tapparella).length}<br>
â€¢ Zanzariere: ${project.positions.filter(p => p.zanzariera).length}<br>
â€¢ Cassonetti: ${project.positions.filter(p => p.cassonetto).length}
</div>
<h2>ğŸ“ DETTAGLIO POSIZIONI</h2>
${project.positions.map((pos, idx) => generatePositionHTML(pos, idx, project.positions.length, project)).join('')}
<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 0.9em;">
<p>Documento generato automaticamente da Open Porte App</p>
<p>OPEN PORTE & FINESTRE SRL - Capitale Sociale â‚¬20.000</p>
</div>
</body></html>`;
}

// Helper per generare la spiegazione del calcolo BRM
function generateBRMExplanation(pos, product, productType, project) {
    if (!product) return '';
    
    // Determina quale brmConfig usare
    let brmConfig = null;
    let tipo = null;
    
    if (productType === 'infisso') {
        brmConfig = project.brmConfigInfissi;
        tipo = product.tipo;
    } else if (productType === 'persiana') {
        brmConfig = project.brmConfigPersiane;
    } else if (productType === 'tapparella') {
        brmConfig = project.brmConfigTapparelle;
    } else if (productType === 'zanzariera') {
        brmConfig = project.brmConfigZanzariere;
        tipo = pos.infisso?.tipo || '';
    } else if (productType === 'cassonetto') {
        brmConfig = project.brmConfigCassonetti;
    }
    
    if (!brmConfig) return '';
    
    // Determina se Ã¨ portafinestra
    const isPortafinestra = tipo && (tipo.includes('PF') || tipo.toUpperCase().includes('PF'));
    
    // Helper per calcolare e formattare una formula
    const spiegaMisura = (misuraBase, misure) => {
        if (!misuraBase) return null;
        
        misuraBase = misuraBase.replace(/\s+/g, '');
        
        // Se contiene +, Ã¨ una somma
        if (misuraBase.includes('+')) {
            const parti = misuraBase.split('+').map(p => p.trim());
            const valori = [];
            let totale = 0;
            
            for (const parte of parti) {
                const valore = parseFloat(misure[parte]);
                if (!isNaN(valore)) {
                    valori.push(`${parte}(${valore})`);
                    totale += valore;
                }
            }
            
            return {
                formula: valori.join(' + '),
                base: totale
            };
        }
        
        // Singola misura
        const valore = parseFloat(misure[misuraBase]);
        return isNaN(valore) ? null : {
            formula: misuraBase,
            base: valore
        };
    };
    
    // Usa le misure corrette in base al tipo di prodotto
    const misure = (productType === 'cassonetto') ? product : pos.misure;
    
    let result = '<tr><td colspan="2" style="background:#e0f2fe;padding:8px;font-size:0.85em;"><strong>ğŸ“ Calcolo BRM:</strong><br>';
    const explanations = [];
    
    // Calcola L
    const misuraBaseLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'misuraBaseL_PF' : 'misuraBaseL';
    const operazioneLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'operazioneL_PF' : 'operazioneL';
    const valoreLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'valoreL_PF' : 'valoreL';
    
    if (brmConfig[misuraBaseLKey] && product.BRM_L !== undefined && product.BRM_L !== null) {
        const infoL = spiegaMisura(brmConfig[misuraBaseLKey], misure);
        if (infoL) {
            const valoreL = parseFloat(brmConfig[valoreLKey]) || 0;
            const operazioneL = brmConfig[operazioneLKey] || '-';
            const segno = operazioneL === '+' ? '+' : 'âˆ’';
            explanations.push(`<strong>BRM_L</strong> = ${infoL.formula} ${segno} ${Math.abs(valoreL)} = <strong>${product.BRM_L} mm</strong>`);
        }
    }
    
    // Calcola H
    const misuraBaseHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'misuraBaseH_PF' : 'misuraBaseH';
    const operazioneHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'operazioneH_PF' : 'operazioneH';
    const valoreHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'valoreH_PF' : 'valoreH';
    
    if (brmConfig[misuraBaseHKey] && product.BRM_H !== undefined && product.BRM_H !== null) {
        const infoH = spiegaMisura(brmConfig[misuraBaseHKey], misure);
        if (infoH) {
            const valoreH = parseFloat(brmConfig[valoreHKey]) || 0;
            const operazioneH = brmConfig[operazioneHKey] || '-';
            const segno = operazioneH === '+' ? '+' : 'âˆ’';
            explanations.push(`<strong>BRM_H</strong> = ${infoH.formula} ${segno} ${Math.abs(valoreH)} = <strong>${product.BRM_H} mm</strong>`);
        }
    }
    
    // Calcola C (cassonetti)
    if (brmConfig.misuraBaseC && product.BRM_C !== undefined && product.BRM_C !== null) {
        const infoC = spiegaMisura(brmConfig.misuraBaseC, misure);
        if (infoC) {
            const valoreC = parseFloat(brmConfig.valoreC) || 0;
            const operazioneC = brmConfig.operazioneC || '-';
            const segno = operazioneC === '+' ? '+' : 'âˆ’';
            explanations.push(`<strong>BRM_C</strong> = ${infoC.formula} ${segno} ${Math.abs(valoreC)} = <strong>${product.BRM_C} mm</strong>`);
        }
    }
    
    // Calcola B (cassonetti)
    if (brmConfig.misuraBaseB && product.BRM_B !== undefined && product.BRM_B !== null) {
        const infoB = spiegaMisura(brmConfig.misuraBaseB, misure);
        if (infoB) {
            const valoreB = parseFloat(brmConfig.valoreB) || 0;
            const operazioneB = brmConfig.operazioneB || '-';
            const segno = operazioneB === '+' ? '+' : 'âˆ’';
            explanations.push(`<strong>BRM_B</strong> = ${infoB.formula} ${segno} ${Math.abs(valoreB)} = <strong>${product.BRM_B} mm</strong>`);
        }
    }
    
    if (explanations.length === 0) return '';
    
    result += explanations.join('<br>');
    result += '</td></tr>';
    
    return result;
}

// Helper per generare HTML singola posizione
function generatePositionHTML(pos, idx, total, project) {
    return `${idx > 0 ? '<div class="page-break"></div>' : ''}<div class="page-break-avoid">
<h3>Posizione ${idx + 1}: ${pos.nome || pos.id}${pos.piano ? ' - ' + pos.piano : ''}</h3>
${pos.ambiente ? `<p><strong>Ambiente:</strong> ${pos.ambiente}</p>` : ''}
<p><strong>ğŸ“ Misure Vano:</strong></p>
<table><tr><th>LVT</th><th>HVT</th><th>LF</th><th>HF</th><th>TMV</th><th>HMT</th></tr>
<tr><td>${pos.misure?.LVT || '-'}</td><td>${pos.misure?.HVT || '-'}</td><td>${pos.misure?.LF || '-'}</td><td>${pos.misure?.HF || '-'}</td><td>${pos.misure?.TMV || '-'}</td><td>${pos.misure?.HMT || '-'}</td></tr></table>
${pos.infisso ? `<h4>ğŸªŸ INFISSO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>QuantitÃ </td><td>${pos.infisso.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.infisso.tipo || '-'}</td></tr>
<tr><td>Apertura</td><td>${pos.infisso.apertura || '-'}</td></tr>
<tr><td>Azienda</td><td>${pos.infisso.azienda || '-'}</td></tr>
<tr><td>Finitura Int</td><td>${pos.infisso.finituraInt || '-'}</td></tr>
<tr><td>Finitura Est</td><td>${pos.infisso.finituraEst || '-'}</td></tr>
<tr><td>Colore Int</td><td>${pos.infisso.coloreInt || '-'}</td></tr>
<tr><td>Colore Est</td><td>${pos.infisso.coloreEst || '-'}</td></tr>
<tr><td>Vetro</td><td>${pos.infisso.vetro || '-'}</td></tr>
${pos.infisso.BRM_L !== undefined || pos.infisso.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.infisso.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.infisso.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.infisso, 'infisso', project)}` : ''}</table>` : ''}
${pos.persiana ? `<h4>ğŸšª PERSIANA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>QuantitÃ </td><td>${pos.persiana.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.persiana.tipo || '-'}</td></tr>
<tr><td>Colore Persiana</td><td>${pos.persiana.colorePersiana || '-'}</td></tr>
${pos.persiana.BRM_L !== undefined || pos.persiana.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.persiana.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.persiana.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.persiana, 'persiana', project)}` : ''}</table>` : ''}
${pos.tapparella ? `<h4>ğŸšï¸ TAPPARELLA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>QuantitÃ </td><td>${pos.tapparella.quantita || 1}</td></tr>
<tr><td>Azienda</td><td>${pos.tapparella.azienda || '-'}</td></tr>
<tr><td>Modello</td><td>${pos.tapparella.modello || '-'}</td></tr>
${pos.tapparella.BRM_L !== undefined || pos.tapparella.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.tapparella.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.tapparella.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.tapparella, 'tapparella', project)}` : ''}</table>` : ''}
${pos.zanzariera ? `<h4>ğŸ¦Ÿ ZANZARIERA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>QuantitÃ </td><td>${pos.zanzariera.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.zanzariera.tipo || '-'}</td></tr>
${pos.zanzariera.BRM_L !== undefined || pos.zanzariera.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.zanzariera.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.zanzariera.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.zanzariera, 'zanzariera', project)}` : ''}</table>` : ''}
${pos.cassonetto ? `<h4>ğŸ“¦ CASSONETTO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Azienda</td><td>${pos.cassonetto.azienda || '-'}</td></tr>
<tr><td>Tipo</td><td>${pos.cassonetto.tipo || '-'}</td></tr>
<tr><td>Materiale</td><td>${pos.cassonetto.materialeCass || '-'}</td></tr>
<tr><td>Codice</td><td>${pos.cassonetto.codiceCass || '-'}</td></tr>
<tr><td>Gruppo Colore</td><td>${pos.cassonetto.gruppoColoreCass || '-'}</td></tr>
${pos.cassonetto.isolamentoPosaclima ? `<tr><td>Isolamento</td><td>${pos.cassonetto.codiceIsolamento || 'SÃ¬'}</td></tr>` : ''}
${pos.cassonetto.aSoffitto ? `<tr><td>A Soffitto</td><td>SÃ¬</td></tr>` : ''}
<tr><td>LS</td><td>${pos.cassonetto.LS || 0} mm</td></tr>
<tr><td>HCASS</td><td>${pos.cassonetto.HCASS || 0} mm</td></tr>
<tr><td>B</td><td>${pos.cassonetto.B || 0} mm</td></tr>
<tr><td>C</td><td>${pos.cassonetto.C || 0} mm</td></tr>
${pos.cassonetto.BRM_L !== undefined && pos.cassonetto.BRM_L !== null ? `<tr><td><strong>BRM_L</strong></td><td><strong>${pos.cassonetto.BRM_L ?? '-'} mm</strong></td></tr>` : ''}
${pos.cassonetto.BRM_H !== undefined && pos.cassonetto.BRM_H !== null ? `<tr><td><strong>BRM_H</strong></td><td><strong>${pos.cassonetto.BRM_H ?? '-'} mm</strong></td></tr>` : ''}
${pos.cassonetto.BRM_C !== undefined && pos.cassonetto.BRM_C !== null ? `<tr><td><strong>BRM_C</strong></td><td><strong>${pos.cassonetto.BRM_C ?? '-'} mm</strong></td></tr>` : ''}
${pos.cassonetto.BRM_B !== undefined && pos.cassonetto.BRM_B !== null ? `<tr><td><strong>BRM_B</strong></td><td><strong>${pos.cassonetto.BRM_B ?? '-'} mm</strong></td></tr>` : ''}
${generateBRMExplanation(pos, pos.cassonetto, 'cassonetto', project)}</table>` : ''}
</div>`;
}

// âš¡ FASE 024: Render differito con debounce
// Permette all'utente di fare piÃ¹ modifiche consecutive senza interruzioni
// Il render viene eseguito solo dopo 300ms di "silenzio"
function deferredRender() {
    // Cancella il timer precedente se esiste
    if (renderTimeout) {
        clearTimeout(renderTimeout);
    }
    
    // Schedula un nuovo render tra 300ms
    renderTimeout = setTimeout(() => {
        render();
        renderTimeout = null;
    }, RENDER_DEBOUNCE_MS);
}

// Main Render Function
function render() {
    const app = document.getElementById('app');
    app.innerHTML = `
        ${MainMenu()}
        <main class="min-h-screen">
            ${state.screen === 'list' ? ProjectsList() :
              state.screen === 'position' ? PositionDetail() :
              state.screen === 'drawings' ? DrawingsPage() :
              ProjectSetup()}
        </main>
        ${FotoModal()}
    `;
    
    // ğŸ†• v5.554: Nasconde menu-sistema quando in progetto
    const menuSistema = document.querySelector('.menu-sistema');
    const menuToggle = document.querySelector('.menu-toggle:not(.app-header .menu-toggle)');
    const menuOverlay = document.querySelector('.menu-overlay');
    
    if (state.currentProject) {
        // Dentro un progetto: nascondi menu principale
        if (menuSistema) menuSistema.style.display = 'none';
        if (menuToggle) menuToggle.style.display = 'none';
        if (menuOverlay) menuOverlay.style.display = 'none';
    } else {
        // Lista progetti: mostra menu principale
        if (menuSistema) menuSistema.style.display = '';
        if (menuToggle) menuToggle.style.display = '';
        if (menuOverlay) menuOverlay.style.display = '';
    }
    
    // ğŸ†• v5.704: Aggiorna visibilitÃ  FAB Import Posizioni
    updateFabVisibility();
}

// Navigation function for setup steps
window.navigateToStep = (step) => {
    state.setupStep = step;
    render();
};

// Navigation function for screens - AGGIUNTA PER MENU
window.showScreen = (screenName) => {
    state.screen = screenName;
    render();
};

// Error handler per debug
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('Errore JavaScript:', {
        message: msg,
        source: url,
        lineno: lineNo,
        colno: columnNo,
        error: error
    });
    return false;
};

// Initialize App con gestione errori
try {
    console.log('Inizializzazione app...');
    loadState();
    render();
    console.log('App inizializzata correttamente');
    
    // ğŸ†• v4.73: AUTO-SYNC da GitHub all'apertura (1 volta per sessione)
    if (GITHUB_CONFIG.token && !window.autoSyncDone) {
        window.autoSyncDone = true; // Flag per fare solo 1 volta
        
        console.log('ğŸ”„ Auto-sync da GitHub...');
        
        // Download in background (non blocca UI)
        setTimeout(async () => {
            try {
                const result = await manualDownloadFromGitHub();
                if (result) {
                    console.log('âœ… Auto-sync completato');
                } else {
                    console.log('â„¹ï¸ Auto-sync: nessun aggiornamento');
                }
            } catch (error) {
                console.error('âš ï¸ Auto-sync fallito:', error);
                // Non mostra errore all'utente, solo in console
            }
        }, 500); // Aspetta 500ms dopo render
    } else if (!GITHUB_CONFIG.token) {
        console.log('âš ï¸ Auto-sync disabilitato: token GitHub non configurato');
    }
    
    // ğŸ†• v4.74: SYNC PERIODICO ogni 2 minuti (anche con tab aperto)
    if (GITHUB_CONFIG.token && !window.periodicSyncInterval) {
        console.log('â° Sync periodico attivato (ogni 2 minuti)');
        
        window.periodicSyncInterval = setInterval(async () => {
            console.log('â° Sync periodico in esecuzione...');
            try {
                const result = await manualDownloadFromGitHub();
                if (result) {
                    console.log('âœ… Sync periodico: progetti aggiornati');
                } else {
                    console.log('â„¹ï¸ Sync periodico: giÃ  aggiornato');
                }
            } catch (error) {
                console.error('âš ï¸ Sync periodico fallito:', error);
            }
        }, 120000); // 120000ms = 2 minuti
    }
    
    // Verifica se serve sincronizzazione (solo 1 volta per sessione)
    const project = state.projects.find(p => p.id === state.currentProject);
    if (project && !state.sincronizzazioneVerificata) {
        if (verificaSincronizzazioneNecessaria(project)) {
            // Mostra avviso solo 1 volta
            state.sincronizzazioneVerificata = true;
        }
    }
    
} catch (error) {
    console.error('Errore durante inizializzazione:', error);
    alert('Si Ã¨ verificato un errore. Controlla la console per i dettagli.');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ OTTIMIZZAZIONE NAVIGAZIONE TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Esegui dopo ogni render per mantenere la configurazione TAB
const originalRender = window.render;
window.render = function() {
    originalRender();
    // Applica tabindex dopo il render
    setTimeout(() => {
        // Escludi TUTTI i button dalla navigazione TAB
        document.querySelectorAll('button').forEach(btn => {
            btn.setAttribute('tabindex', '-1');
        });
        
        // Escludi anche i link dalla navigazione TAB
        document.querySelectorAll('a').forEach(link => {
            link.setAttribute('tabindex', '-1');
        });
        
        // Mantieni SOLO input, select, textarea navigabili con TAB
        // (Questi elementi hanno giÃ  tabindex=0 di default, non serve modificarli)
    }, 10);
};

console.log('âœ… Navigazione TAB ottimizzata: Ora TAB passa solo tra i campi dati!');
console.log('âœ… FASE 021: Menu laterale hamburger attivato!');

// ============================================
// MENU SISTEMA OPENPORTE - CODICE INTEGRATO
// ============================================

const MenuSistema = {
    // Configurazione menu
    config: {
        menuItems: [],
        styles: '' // Stili giÃ  inseriti nel CSS sopra
    },
    
    // Inizializza il menu
    init() {
        console.log('ğŸš€ Inizializzazione Menu Sistema...');
        
        // Crea struttura HTML
        this.createMenuStructure();
        
        // Attiva event listeners
        this.attachEventListeners();
        
        // Verifica stato iniziale
        this.updateSyncStatus();
        
        console.log('âœ… Menu Sistema inizializzato!');
    },
    
    // Crea struttura HTML del menu
    createMenuStructure() {
        // Rimuovi menu esistente se presente
        const existingMenu = document.querySelector('.menu-sistema');
        if (existingMenu) existingMenu.remove();
        
        const existingToggle = document.querySelector('.menu-toggle');
        if (existingToggle) existingToggle.remove();
        
        const existingOverlay = document.querySelector('.menu-overlay');
        if (existingOverlay) existingOverlay.remove();
        
        // Crea container menu
        const menuContainer = document.createElement('div');
        menuContainer.className = 'menu-sistema';
        
        // Header
        menuContainer.innerHTML = `
            <div class="menu-items">
                ${this.renderMenuItems(this.config.menuItems)}
            </div>
            <div class="menu-footer">
                <div class="sync-status" id="menu-sync-status">
                    <span class="sync-icon">ğŸ”„</span>
                    <span class="sync-text">Non connesso</span>
                </div>
            </div>
        `;
        
        // Toggle button
        const toggleButton = document.createElement('div');
        toggleButton.className = 'menu-toggle';
        toggleButton.innerHTML = '<span class="menu-toggle-icon">â˜°</span>';
        
        // Overlay
        const overlay = document.createElement('div');
        overlay.className = 'menu-overlay';
        
        // Aggiungi al DOM
        document.body.appendChild(menuContainer);
        document.body.appendChild(toggleButton);
        document.body.appendChild(overlay);
    },
    
    // Renderizza items del menu
    renderMenuItems(items) {
        return items.map(item => {
            const hasSubmenu = item.submenu && item.submenu.length > 0;
            
            let html = `
                <div class="menu-item" data-menu-id="${item.id}">
                    <span class="menu-icon">${item.icon}</span>
                    <span class="menu-label">${item.label}</span>
                    ${hasSubmenu ? '<span class="menu-arrow">â–¶</span>' : ''}
                </div>
            `;
            
            if (hasSubmenu) {
                html += `
                    <div class="submenu" data-parent-id="${item.id}">
                        ${item.submenu.map(subitem => `
                            <div class="submenu-item ${subitem.highlight ? 'highlight-item' : ''}" data-menu-id="${subitem.id}">
                                <span class="menu-icon">${subitem.icon}</span>
                                <span class="menu-label">${subitem.label}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            return html;
        }).join('');
    },
    
    // Attacca event listeners
    attachEventListeners() {
        const toggle = document.querySelector('.menu-toggle');
        const overlay = document.querySelector('.menu-overlay');
        const menu = document.querySelector('.menu-sistema');
        
        // Toggle menu
        toggle?.addEventListener('click', () => this.toggleMenu());
        overlay?.addEventListener('click', () => this.closeMenu());
        
        // Menu items - uso event delegation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.menu-item')) {
                this.handleMenuClick(e);
            } else if (e.target.closest('.submenu-item')) {
                this.handleSubmenuClick(e);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && menu?.classList.contains('active')) {
                this.closeMenu();
            }
        });
    },
    
    // Gestisci click su menu item
    handleMenuClick(e) {
        const item = e.target.closest('.menu-item');
        const menuId = item.dataset.menuId;
        const menuConfig = this.config.menuItems.find(m => m.id === menuId);
        
        if (menuConfig?.submenu) {
            // Toggle submenu
            item.classList.toggle('expanded');
            const submenu = document.querySelector(`.submenu[data-parent-id="${menuId}"]`);
            submenu?.classList.toggle('active');
        } else if (menuConfig?.action) {
            // Esegui azione
            menuConfig.action();
            this.closeMenu();
        }
    },
    
    // Gestisci click su submenu item
    handleSubmenuClick(e) {
        e.stopPropagation();
        const item = e.target.closest('.submenu-item');
        const menuId = item.dataset.menuId;
        
        // Trova configurazione submenu
        for (const menuItem of this.config.menuItems) {
            if (menuItem.submenu) {
                const subItem = menuItem.submenu.find(s => s.id === menuId);
                if (subItem?.action) {
                    subItem.action();
                    this.closeMenu();
                    break;
                }
            }
        }
    },
    
    // Toggle menu
    toggleMenu() {
        const menu = document.querySelector('.menu-sistema');
        const toggle = document.querySelector('.menu-toggle');
        const overlay = document.querySelector('.menu-overlay');
        
        menu?.classList.toggle('active');
        toggle?.classList.toggle('active');
        overlay?.classList.toggle('active');
    },
    
    // Chiudi menu
    closeMenu() {
        const menu = document.querySelector('.menu-sistema');
        const toggle = document.querySelector('.menu-toggle');
        const overlay = document.querySelector('.menu-overlay');
        
        menu?.classList.remove('active');
        toggle?.classList.remove('active');
        overlay?.classList.remove('active');
    },
    
    // Apri menu
    openMenu() {
        const menu = document.querySelector('.menu-sistema');
        const toggle = document.querySelector('.menu-toggle');
        const overlay = document.querySelector('.menu-overlay');
        
        menu?.classList.add('active');
        toggle?.classList.add('active');
        overlay?.classList.add('active');
    },
    
    // Aggiorna stato sync
    updateSyncStatus() {
        const syncStatus = document.getElementById('menu-sync-status');
        if (!syncStatus) return;
        
        // Controlla se state.github esiste e Ã¨ connesso
        const isConnected = window.state?.github?.connected || false;
        const lastSync = window.state?.github?.lastSyncTime || null;
        
        if (isConnected) {
            syncStatus.classList.add('connected');
            syncStatus.innerHTML = `
                <span class="sync-icon">âœ…</span>
                <span class="sync-text">GitHub connesso</span>
            `;
            
            if (lastSync) {
                const date = new Date(lastSync);
                const timeStr = date.toLocaleTimeString('it-IT', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                syncStatus.innerHTML += `<br><small>Ultimo sync: ${timeStr}</small>`;
            }
        } else {
            syncStatus.classList.remove('connected');
            syncStatus.innerHTML = `
                <span class="sync-icon">ğŸ”„</span>
                <span class="sync-text">Non connesso</span>
            `;
        }
    },
    
    // Marca menu item come attivo
    setActiveMenuItem(screenId) {
        // Rimuovi classe active da tutti
        document.querySelectorAll('.menu-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Mappa screen a menu id
        const screenToMenu = {
            'list': 'progetti',
            'dashboard': 'dashboard',
            'setup': 'nuovo-progetto',
            'statistics': 'statistiche'
        };
        
        const menuId = screenToMenu[screenId];
        if (menuId) {
            const menuItem = document.querySelector(`.menu-item[data-menu-id="${menuId}"]`);
            menuItem?.classList.add('active');
        }
    }
};

// Rendi globale
window.MenuSistema = MenuSistema;

// ============================================
// INTEGRAZIONE MENU SISTEMA OPENPORTE
// ============================================

// Inizializza il menu dopo che l'app Ã¨ pronta
const initMenuSistemaIntegrato = () => {
    // Verifica che il menu sia disponibile
    if (typeof MenuSistema === 'undefined') {
        console.error('MenuSistema non trovato! Assicurati che menu-sistema-module.js sia caricato');
        return;
    }
    
    // Configura le azioni del menu per integrarsi con l'app esistente
    MenuSistema.config.menuItems = [
        {
            id: 'progetti',
            label: 'Lista Progetti',
            icon: 'ğŸ“',
            action: () => {
                showScreen('list');
                MenuSistema.setActiveMenuItem('list');
            }
        },
        {
            id: 'nuovo-progetto',
            label: 'Nuovo Progetto',
            icon: 'â•',
            action: () => {
                MenuSistema.closeMenu();
                showNewProjectModal();
            }
        },
        {
            id: 'progetto-corrente',
            label: 'Progetto Corrente',
            icon: 'ğŸ—ï¸',
            submenu: state.currentProject ? [
                {
                    id: 'dati-cliente',
                    label: 'Dati Cliente',
                    icon: 'ğŸ‘¤',
                    action: () => {
                        state.setupStep = 1;
                        render();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'posizioni',
                    label: 'Posizioni',
                    icon: 'ğŸ“',
                    action: () => {
                        state.setupStep = 9;
                        render();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'rilievi-globali',
                    label: 'Prodotti e Rilievi',
                    icon: 'ğŸ“',
                    action: () => {
                        state.setupStep = 2;
                        render();
                        MenuSistema.closeMenu();
                    }
                }
            ] : []
        },
        {
            id: 'sincronizzazione',
            label: 'Sincronizzazione',
            icon: 'ğŸ”„',
            submenu: [
                {
                    id: 'github-settings',
                    label: 'Impostazioni GitHub',
                    icon: 'âš™ï¸',
                    action: () => {
                        openGitHubSettings();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'sync-now',
                    label: 'Sincronizza Ora',
                    icon: 'â¬†ï¸',
                    action: () => {
                        if (state.github?.connected) {
                            quickSync();
                            MenuSistema.closeMenu();
                        } else {
                            showNotification('GitHub non connesso', 'error');
                        }
                    }
                },
                {
                    id: 'download-github',
                    label: 'Scarica da GitHub',
                    icon: 'â¬‡ï¸',
                    action: () => {
                        if (state.github?.connected) {
                            downloadFromGitHub();
                            MenuSistema.closeMenu();
                        } else {
                            showNotification('GitHub non connesso', 'error');
                        }
                    }
                }
            ]
        },
        {
            id: 'import-export',
            label: 'Import/Export',
            icon: 'ğŸ’¾',
            submenu: [
                {
                    id: 'export-json',
                    label: 'Esporta Progetti',
                    icon: 'ğŸ“¤',
                    action: () => {
                        exportProjects();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'import-json',
                    label: 'Importa Progetti',
                    icon: 'ğŸ“¥',
                    action: () => {
                        importProjects();
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'backup-locale',
                    label: 'Backup Locale',
                    icon: 'ğŸ’¾',
                    action: () => {
                        const backup = {
                            version: '1.0',
                            date: new Date().toISOString(),
                            state: state
                        };
                        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `backup-openporte-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        showNotification('Backup creato', 'success');
                        MenuSistema.closeMenu();
                    }
                }
            ]
        },
        {
            id: 'statistiche',
            label: 'Statistiche',
            icon: 'ğŸ“Š',
            action: () => {
                openStatistics();
                MenuSistema.closeMenu();
            }
        },
        {
            id: 'strumenti',
            label: 'Strumenti',
            icon: 'ğŸ”§',
            submenu: [
                {
                    id: 'verifica-sync',
                    label: 'Verifica Sincronizzazione',
                    icon: 'ğŸ”',
                    action: () => {
                        if (state.currentProject) {
                            const project = state.projects.find(p => p.id === state.currentProject);
                            if (project) {
                                verificaSincronizzazioneNecessaria(project);
                            }
                        }
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'clear-cache',
                    label: 'Pulisci Cache',
                    icon: 'ğŸ§¹',
                    action: () => {
                        if ('caches' in window) {
                            caches.keys().then(names => {
                                names.forEach(name => caches.delete(name));
                            });
                        }
                        showNotification('Cache pulita', 'success');
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'debug-console',
                    label: 'Console Debug',
                    icon: 'ğŸ›',
                    action: () => {
                        console.log('=== STATO APPLICAZIONE ===');
                        console.log('Progetti:', state.projects.length);
                        console.log('Progetto corrente:', state.currentProject);
                        console.log('GitHub connesso:', state.github?.connected || false);
                        console.log('Ultimo sync:', state.github?.lastSyncTime || 'Mai');
                        console.log('State completo:', state);
                        showNotification('Debug stampato in console', 'info');
                        MenuSistema.closeMenu();
                    }
                },
                {
                    id: 'update-app',
                    label: 'ğŸ”„ AGGIORNA APP',
                    icon: 'ğŸ”„',
                    highlight: true,
                    action: () => {
                        forceUpdateApp();
                    }
                }
            ]
        },
        {
            id: 'info',
            label: 'Informazioni',
            icon: 'â„¹ï¸',
            submenu: [
                {
                    id: 'version',
                    label: 'Versione',
                    icon: 'ğŸ“±',
                    action: () => {
                        alert(`OpenPorte v3.5-ULTIMATE-FIX\nMenu Sistema v1.0\nBuild: 10/11/2025\n\nFix applicati:\nâœ… rilievoPersiane arrayâ†’oggetto\nâœ… state.github undefined\nâœ… project.positions crash\nâœ… Menu sistema integrato`);
                    }
                },
                {
                    id: 'help',
                    label: 'Aiuto',
                    icon: 'â“',
                    action: () => {
                        alert('Per assistenza:\n\nğŸ“§ supporto@openporte.it\nğŸ“± +39 XXX XXX XXXX\nğŸŒ www.openporte.it/help');
                    }
                }
            ]
        }
    ];
    
    // Inizializza il menu
    MenuSistema.init();
    
    // Aggiorna stato sync periodicamente
    setInterval(() => {
        MenuSistema.updateSyncStatus();
    }, 5000);
    
    // Hook per aggiornare menu quando cambia schermata
    // NOTA: showScreen verrÃ  definito dopo, quindi non possiamo wrapparlo qui
    // Il menu si aggiornerÃ  tramite altri eventi
    
    console.log('âœ… Menu Sistema OpenPorte integrato con successo!');
};

// Inizializza quando DOM Ã¨ pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMenuSistemaIntegrato);
} else {
    // DOM giÃ  pronto, inizializza subito
    setTimeout(initMenuSistemaIntegrato, 100);
}

// ğŸ†• v5.25: Listener per messaggi dal catalogo FIN-Door esterno
window.addEventListener('message', function(event) {
    // Verifica origine catalogo OpenPorte
    if (!event.origin.includes('openporte2025.github.io') && !event.origin.includes('localhost')) {
        return;
    }
    
    const data = event.data;
    console.log('ğŸ“¥ Messaggio dal catalogo:', data);
    
    // Gestisce selezione modello anta (accetta entrambi i type per compatibilitÃ )
    if (data && (data.type === 'findoor-modello' || data.type === 'CATALOGO_SELECT_MODELLO')) {
        const modello = data.modello; // es. '05'
        console.log(`ğŸšª Catalogo: Modello ${modello} ricevuto`);
        
        // Trova posizione attiva con portoncino
        const activeProject = state.projects.find(p => 
            p.positions?.some(pos => pos.ingresso?.tipo === 'portoncino')
        );
        
        if (activeProject) {
            const activePos = activeProject.positions.find(pos => 
                pos.ingresso?.tipo === 'portoncino'
            );
            
            if (activePos && activePos.ingresso?.portoncino) {
                activePos.ingresso.portoncino.modelloAnta = modello;
                saveState();
                render();
                showNotification(`âœ… Modello ${modello} applicato!`, 'success');
            }
        }
    }
});

// Listener per storage (fallback se il catalogo usa localStorage)
window.addEventListener('storage', function(event) {
    if (event.key === 'findoor-modello-selezionato') {
        const modello = event.newValue;
        console.log(`ğŸšª Storage: Modello ${modello} ricevuto`);
        
        // Trova posizione attiva con portoncino
        const activeProject = state.projects.find(p => 
            p.positions?.some(pos => pos.ingresso?.tipo === 'portoncino')
        );
        
        if (activeProject) {
            const activePos = activeProject.positions.find(pos => 
                pos.ingresso?.tipo === 'portoncino'
            );
            
            if (activePos && activePos.ingresso?.portoncino) {
                activePos.ingresso.portoncino.modelloAnta = modello;
                saveState();
                render();
                showNotification(`âœ… Modello ${modello} applicato!`, 'success');
                
                // Pulisci storage
                localStorage.removeItem('findoor-modello-selezionato');
            }
        }
    }
});

// ============================================
// ğŸ” MENU SISTEMA - FASE 020 (VECCHIO - DISABILITATO)
// ============================================

window.toggleMenu = function() {
    const menu = document.getElementById('sideMenu');
    const overlay = document.getElementById('menuOverlay');
    
    if (menu && overlay) {
        menu.classList.toggle('open');
        overlay.classList.toggle('active');
    }
};

window.closeMenu = function() {
    const menu = document.getElementById('sideMenu');
    const overlay = document.getElementById('menuOverlay');
    
    if (menu && overlay) {
        menu.classList.remove('open');
        overlay.classList.remove('active');
    }
};

window.navigateTo = function(section) {
    // Chiudi menu su mobile
    if (window.innerWidth < 768) {
        closeMenu();
    }
    
    // Rimuovi active da tutti i link
    document.querySelectorAll('.menu-list a').forEach(link => {
        link.classList.remove('active');
    });
    
    // Aggiungi active al link corrente
    const currentLink = document.querySelector(`.menu-list a[href="#${section}"]`);
    if (currentLink) {
        currentLink.classList.add('active');
    }
    
    // Per ora gestiamo solo la sezione "progetti" che Ã¨ l'app principale
    // Le altre sezioni verranno implementate successivamente
    if (section === 'progetti') {
        // L'app principale Ã¨ giÃ  visibile
        console.log('ğŸ“ Sezione progetti');
    } else if (section === 'config') {
        // TODO: Implementare pagina config globali
        showNotification('âš™ï¸ Config Globali - In sviluppo', 'info');
    } else if (section === 'backup') {
        // TODO: Implementare pagina backup
        showNotification('ğŸ’¾ Backup - In sviluppo', 'info');
    } else if (section === 'sync') {
        // TODO: Implementare pagina sync
        showNotification('ğŸ”„ Sincronizzazione - In sviluppo', 'info');
    } else if (section === 'info') {
        // TODO: Implementare pagina info
        showNotification('â„¹ï¸ Info & Guida - In sviluppo', 'info');
    }
    
    // Salva sezione corrente
    try {
        localStorage.setItem('currentMenuSection', section);
    } catch (e) {
        console.warn('Impossibile salvare sezione corrente:', e);
    }
    
    // Scroll top
    window.scrollTo(0, 0);
};

// Inizializza menu al caricamento
setTimeout(() => {
    let lastSection = 'progetti'; // Default
    
    try {
        lastSection = localStorage.getItem('currentMenuSection') || 'progetti';
    } catch (e) {
        console.warn('Impossibile recuperare ultima sezione:', e);
    }
    
    navigateTo(lastSection);
    console.log('âœ… FASE 020: Menu sistema inizializzato!');
}, 100);

// Chiudi menu con tasto ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMenu();
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + K per ricerca
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        toggleMainMenu();
        setTimeout(() => {
            const searchInput = document.getElementById('mainSearch');
            if (searchInput) searchInput.focus();
        }, 300);
    }
    
    // Ctrl/Cmd + N per nuovo progetto
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        showNewProjectModal();
    }
    
    // Ctrl/Cmd + S per salvare
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveState();
        showNotification('ğŸ’¾ Salvato', 'success');
    }
    
    // Ctrl/Cmd + E per export
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        if (state.currentProject) {
            exportCurrentProjectJSON();
        } else {
            exportAllProjects();
        }
    }
    
    // Esc per chiudere menu/modal
    if (e.key === 'Escape') {
        if (state.mainMenuOpen) {
            closeMainMenu();
        }
        if (state.projectMenuOpen) {
            closeProjectMenu();
        }
        // Chiudi anche eventuali modal
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            }
        });
    }
});

// ğŸš¨ NOTIFICA VISIVA VERSIONE DINAMICA
setTimeout(() => {
    showNotification(`ğŸšª v${APP_VERSION} âœ… ${APP_VERSION_NOTE}`, 'success', 5000);
}, 1000);

// Aggiungi animazioni CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from { transform: translate(-50%, 100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes slideDown {
        from { transform: translate(-50%, 0); opacity: 1; }
        to { transform: translate(-50%, 100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
